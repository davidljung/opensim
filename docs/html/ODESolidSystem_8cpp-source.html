<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>OpenSim: physics/ODESolidSystem.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>physics/ODESolidSystem.cpp</h1><a href="ODESolidSystem_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/****************************************************************************</span>
00002 <span class="comment">  Copyright (C)1996 David Jung &lt;opensim@pobox.com&gt;</span>
00003 <span class="comment"></span>
00004 <span class="comment">  This program/file is free software; you can redistribute it and/or modify</span>
00005 <span class="comment">  it under the terms of the GNU General Public License as published by</span>
00006 <span class="comment">  the Free Software Foundation; either version 2 of the License, or</span>
00007 <span class="comment">  (at your option) any later version.</span>
00008 <span class="comment">  </span>
00009 <span class="comment">  This program is distributed in the hope that it will be useful,</span>
00010 <span class="comment">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00011 <span class="comment">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00012 <span class="comment">  GNU General Public License for more details. (http://www.gnu.org)</span>
00013 <span class="comment">  </span>
00014 <span class="comment">  You should have received a copy of the GNU General Public License</span>
00015 <span class="comment">  along with this program; if not, write to the Free Software</span>
00016 <span class="comment">  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
00017 <span class="comment">  </span>
00018 <span class="comment">  $Id: ODESolidSystem.cpp 1031 2004-02-11 20:46:36Z jungd $</span>
00019 <span class="comment">  $Revision: 1.18 $</span>
00020 <span class="comment">  $Date: 2004-02-11 15:46:36 -0500 (Wed, 11 Feb 2004) $</span>
00021 <span class="comment">  $Author: jungd $</span>
00022 <span class="comment">  </span>
00023 <span class="comment">****************************************************************************/</span>
00024 
00025 <span class="preprocessor">#include &lt;<a class="code" href="CollisionState.html">physics/CollisionState</a>&gt;</span>
00026 
00027 <span class="preprocessor">#include &lt;<a class="code" href="ODESolidSystem.html">physics/ODESolidSystem</a>&gt;</span>
00028 <span class="preprocessor">#include &lt;<a class="code" href="ODECollisionCuller.html">physics/ODECollisionCuller</a>&gt;</span>
00029 <span class="preprocessor">#include &lt;<a class="code" href="ODECollisionDetector.html">physics/ODECollisionDetector</a>&gt;</span>
00030 <span class="preprocessor">#include &lt;<a class="code" href="SolidCollisionResponseHandler.html">physics/SolidCollisionResponseHandler</a>&gt;</span>
00031 <span class="preprocessor">#include &lt;<a class="code" href="NullCollisionResponseHandler.html">physics/NullCollisionResponseHandler</a>&gt;</span>
00032 <span class="preprocessor">#include &lt;<a class="code" href="ODECollidableGroup.html">physics/ODECollidableGroup</a>&gt;</span>
00033 <span class="preprocessor">#include &lt;<a class="code" href="ODESolid.html">physics/ODESolid</a>&gt;</span>
00034 <span class="preprocessor">#include &lt;<a class="code" href="ODESolidConnectedCollidableBody.html">physics/ODESolidConnectedCollidableBody</a>&gt;</span>
00035 
00036 <span class="preprocessor">#include &lt;<a class="code" href="ODEConstraintGroup.html">physics/ODEConstraintGroup</a>&gt;</span>
00037 <span class="preprocessor">#include &lt;<a class="code" href="ODEFixedConstraint.html">physics/ODEFixedConstraint</a>&gt;</span>
00038 <span class="preprocessor">#include &lt;<a class="code" href="ODEContactConstraint.html">physics/ODEContactConstraint</a>&gt;</span>
00039 <span class="preprocessor">#include &lt;<a class="code" href="ODEBallJoint.html">physics/ODEBallJoint</a>&gt;</span>
00040 <span class="preprocessor">#include &lt;<a class="code" href="ODEHingeJoint.html">physics/ODEHingeJoint</a>&gt;</span>
00041 <span class="preprocessor">#include &lt;<a class="code" href="ODEDoubleHingeJoint.html">physics/ODEDoubleHingeJoint</a>&gt;</span>
00042 <span class="preprocessor">#include &lt;<a class="code" href="ODESliderJoint.html">physics/ODESliderJoint</a>&gt;</span>
00043 <span class="preprocessor">#include &lt;<a class="code" href="ODEUniversalJoint.html">physics/ODEUniversalJoint</a>&gt;</span>
00044 
00045 <span class="preprocessor">#include &lt;<a class="code" href="ODEMotor.html">physics/ODEMotor</a>&gt;</span>
00046 
00047 <span class="keyword">using</span> <a class="code" href="classphysics_1_1ODESolidSystem.html">physics::ODESolidSystem</a>;
00048 
00049 
00050 <span class="keyword">using</span> <a class="code" href="classphysics_1_1Collider.html">physics::Collider</a>;
00051 <span class="keyword">using</span> <a class="code" href="classphysics_1_1CollisionCuller.html">physics::CollisionCuller</a>;
00052 <span class="keyword">using</span> <a class="code" href="classphysics_1_1CollisionDetector.html">physics::CollisionDetector</a>;
00053 <span class="keyword">using</span> <a class="code" href="classphysics_1_1ODECollisionDetector.html">physics::ODECollisionDetector</a>;
00054 <span class="keyword">using</span> <a class="code" href="classphysics_1_1Collidable.html">physics::Collidable</a>;
00055 <span class="keyword">using</span> <a class="code" href="classphysics_1_1CollidableGroup.html">physics::CollidableGroup</a>;
00056 <span class="keyword">using</span> <a class="code" href="classphysics_1_1ODECollidableGroup.html">physics::ODECollidableGroup</a>;
00057 <span class="keyword">using</span> <a class="code" href="classphysics_1_1ODECollisionCuller.html">physics::ODECollisionCuller</a>;
00058 <span class="keyword">using</span> <a class="code" href="classphysics_1_1Solid.html">physics::Solid</a>;
00059 <span class="keyword">using</span> <a class="code" href="classphysics_1_1ODESolid.html">physics::ODESolid</a>;
00060 <span class="keyword">using</span> <a class="code" href="classphysics_1_1ODESolidConnectedCollidableBody.html">physics::ODESolidConnectedCollidableBody</a>;
00061 <span class="keyword">using</span> <a class="code" href="classphysics_1_1ConstraintGroup.html">physics::ConstraintGroup</a>;
00062 <span class="keyword">using</span> <a class="code" href="classphysics_1_1ODEConstraintGroup.html">physics::ODEConstraintGroup</a>;
00063 <span class="keyword">using</span> <a class="code" href="classphysics_1_1CollisionResponseHandler.html">physics::CollisionResponseHandler</a>;
00064 <span class="keyword">using</span> <a class="code" href="classphysics_1_1SolidCollisionResponseHandler.html">physics::SolidCollisionResponseHandler</a>;
00065 
00066 <span class="keyword">using</span> <a class="code" href="classphysics_1_1FixedConstraint.html">physics::FixedConstraint</a>;
00067 <span class="keyword">using</span> <a class="code" href="classphysics_1_1ContactConstraint.html">physics::ContactConstraint</a>;
00068 <span class="keyword">using</span> <a class="code" href="classphysics_1_1BallJoint.html">physics::BallJoint</a>;
00069 <span class="keyword">using</span> <a class="code" href="classphysics_1_1HingeJoint.html">physics::HingeJoint</a>;
00070 <span class="keyword">using</span> <a class="code" href="classphysics_1_1DoubleHingeJoint.html">physics::DoubleHingeJoint</a>;
00071 <span class="keyword">using</span> <a class="code" href="classphysics_1_1SliderJoint.html">physics::SliderJoint</a>;
00072 <span class="keyword">using</span> <a class="code" href="classphysics_1_1UniversalJoint.html">physics::UniversalJoint</a>;
00073 <span class="keyword">using</span> <a class="code" href="classphysics_1_1Motor.html">physics::Motor</a>;
00074 
00075 <span class="keyword">using</span> <a class="code" href="classphysics_1_1ODEFixedConstraint.html">physics::ODEFixedConstraint</a>;
00076 <span class="keyword">using</span> <a class="code" href="classphysics_1_1ODEBallJoint.html">physics::ODEBallJoint</a>;
00077 <span class="keyword">using</span> <a class="code" href="classphysics_1_1ODEHingeJoint.html">physics::ODEHingeJoint</a>;
00078 <span class="keyword">using</span> <a class="code" href="classphysics_1_1ODEDoubleHingeJoint.html">physics::ODEDoubleHingeJoint</a>;
00079 <span class="keyword">using</span> <a class="code" href="classphysics_1_1ODESliderJoint.html">physics::ODESliderJoint</a>;
00080 <span class="keyword">using</span> <a class="code" href="classphysics_1_1ODEUniversalJoint.html">physics::ODEUniversalJoint</a>;
00081 <span class="keyword">using</span> <a class="code" href="classphysics_1_1ODEMotor.html">physics::ODEMotor</a>;
00082 
00083 
00084 
00085 ODESolidSystem::ODESolidSystem()
00086   : active(true), preSimulateCalled(false)
00087 {
00088   <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp1">worldID</a> = dWorldCreate();
00089   
00090   <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp7">collisionCuller</a> = ref&lt;CollisionCuller&gt;(<a class="code" href="MemoryTracer.html#a0">NewObj</a> ODECollisionCuller());
00091   <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp8">collisionDetector</a> = ref&lt;CollisionDetector&gt;(<a class="code" href="MemoryTracer.html#a0">NewObj</a> ODECollisionDetector());
00092   <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp9">collisionHandler</a> = ref&lt;CollisionResponseHandler&gt;(<a class="code" href="MemoryTracer.html#a0">NewObj</a> <a class="code" href="classphysics_1_1SolidCollisionResponseHandler.html">SolidCollisionResponseHandler</a>(ref&lt;SolidSystem&gt;(<span class="keyword">this</span>), collisionDetector)); <span class="comment">//!!!cyclic ref!</span>
00093 <span class="comment"></span>  
00094   <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp7">collisionCuller</a>-&gt;addPotentialCollisionListener(collisionDetector);
00095   <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp8">collisionDetector</a>-&gt;addPotentialCollisionListener(ref&lt;ODESolidSystem&gt;(<span class="keyword">this</span>));
00096 
00097 }
00098 
00099 ODESolidSystem::ODESolidSystem(<span class="keyword">const</span> ODESolidSystem&amp; ss)
00100   : SolidSystem(ss), active(ss.active), preSimulateCalled(false)
00101 {
00102   <a class="code" href="debugtools.html#a12">Unimplemented</a>;
00103 }
00104 
00105 
00106 ODESolidSystem::~ODESolidSystem()
00107 {
00108   <span class="comment">// release the ConstraintGroups first</span>
00109   <span class="comment">//  (so that the Constraints may be destroyed before the world)</span>
00110   ConstraintGroups::iterator g = <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp3">constraintGroups</a>.<a class="code" href="classbase_1_1reflist.html#base_1_1reflista0">begin</a>();
00111   ConstraintGroups::iterator end = <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp3">constraintGroups</a>.<a class="code" href="classbase_1_1reflist.html#base_1_1reflista3">end</a>();
00112   <span class="keywordflow">while</span> (g != end) {
00113     (*g)-&gt;clear();
00114     ++g;
00115   }
00116   <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp3">constraintGroups</a>.<a class="code" href="classbase_1_1reflist.html#base_1_1reflista30">clear</a>();
00117 
00118   <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystema14">setGround</a>(ref&lt;Solid&gt;(0),<a class="code" href="namespacebase.html#a26">Point3</a>());
00119 
00120   <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp2">solids</a>.<a class="code" href="classbase_1_1reflist.html#base_1_1reflista30">clear</a>();
00121 
00122   <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp7">collisionCuller</a> = ref&lt;CollisionCuller&gt;(0);
00123   <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp8">collisionDetector</a> = ref&lt;CollisionDetector&gt;(0);
00124   <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp9">collisionHandler</a> = ref&lt;CollisionResponseHandler&gt;(0);
00125 
00126   dWorldDestroy(worldID);
00127 }
00128 
00129 
00130 
00131 
00132 <span class="comment">// factories</span>
00133 
00134 ref&lt;Solid&gt; ODESolidSystem::createSolid(ref&lt;const Shape&gt; shape, ref&lt;const Material&gt; material)  
00135 {
00136   <span class="keywordflow">return</span> ref&lt;Solid&gt;(<a class="code" href="MemoryTracer.html#a1">NewNamedObj</a>(<span class="stringliteral">"ODESolid"</span>) ODESolid(shape, material));
00137 }
00138 
00139 
00140 ref&lt;ConstraintGroup&gt; ODESolidSystem::createConstraintGroup()
00141 {
00142   <span class="keywordflow">return</span> ref&lt;ConstraintGroup&gt;(<a class="code" href="MemoryTracer.html#a1">NewNamedObj</a>(<span class="stringliteral">"ODEConstraintGroup"</span>) <a class="code" href="classphysics_1_1ODEConstraintGroup.html">ODEConstraintGroup</a>(worldID));
00143 }
00144 
00145 
00146 ref&lt;BallJoint&gt; ODESolidSystem::createBallJoint()
00147 {
00148   <span class="keywordflow">return</span> ref&lt;BallJoint&gt;(<a class="code" href="MemoryTracer.html#a1">NewNamedObj</a>(<span class="stringliteral">"ODEBallJoint"</span>) ODEBallJoint());
00149 }
00150 
00151 ref&lt;HingeJoint&gt; ODESolidSystem::createHingeJoint()
00152 {
00153   <span class="keywordflow">return</span> ref&lt;HingeJoint&gt;(<a class="code" href="MemoryTracer.html#a1">NewNamedObj</a>(<span class="stringliteral">"ODEHingeJoint"</span>) ODEHingeJoint());
00154 }
00155 
00156 ref&lt;DoubleHingeJoint&gt; ODESolidSystem::createDoubleHingeJoint()
00157 {
00158   <span class="keywordflow">return</span> ref&lt;DoubleHingeJoint&gt;(<a class="code" href="MemoryTracer.html#a1">NewNamedObj</a>(<span class="stringliteral">"ODEDoubleHingeJoint"</span>) ODEDoubleHingeJoint());
00159 }
00160 
00161 ref&lt;SliderJoint&gt; ODESolidSystem::createSliderJoint()
00162 {
00163   <span class="keywordflow">return</span> ref&lt;SliderJoint&gt;(<a class="code" href="MemoryTracer.html#a1">NewNamedObj</a>(<span class="stringliteral">"ODESliderJoint"</span>) ODESliderJoint());
00164 }
00165 
00166 ref&lt;UniversalJoint&gt; ODESolidSystem::createUniversalJoint()
00167 {
00168   <span class="keywordflow">return</span> ref&lt;UniversalJoint&gt;(<a class="code" href="MemoryTracer.html#a1">NewNamedObj</a>(<span class="stringliteral">"ODEUniversalJoint"</span>) <a class="code" href="classphysics_1_1ODEUniversalJoint.html">ODEUniversalJoint</a>());
00169 }
00170 
00171 
00172 ref&lt;FixedConstraint&gt; ODESolidSystem::createFixedConstraint()
00173 {
00174   <span class="keywordflow">return</span> ref&lt;FixedConstraint&gt;(<a class="code" href="MemoryTracer.html#a1">NewNamedObj</a>(<span class="stringliteral">"ODEFixedConstraint"</span>) ODEFixedConstraint());
00175 }
00176 
00177 ref&lt;ContactConstraint&gt; ODESolidSystem::createContactConstraint()
00178 {
00179   <span class="keywordflow">return</span> ref&lt;ContactConstraint&gt;(<a class="code" href="MemoryTracer.html#a1">NewNamedObj</a>(<span class="stringliteral">"ODEContactConstraint"</span>) ODEContactConstraint());
00180 }
00181 
00182 
00183 ref&lt;Motor&gt; ODESolidSystem::createMotor()
00184 {
00185   <span class="keywordflow">return</span> ref&lt;ODEMotor&gt;(<a class="code" href="MemoryTracer.html#a1">NewNamedObj</a>(<span class="stringliteral">"ODEMotor"</span>) <a class="code" href="classphysics_1_1ODEMotor.html">ODEMotor</a>());
00186 }
00187 
00188 
00189 <span class="keywordtype">void</span> ODESolidSystem::setGround(ref&lt;Solid&gt; ground, <span class="keyword">const</span> Point3&amp; position)
00190 {
00191   <span class="keywordflow">if</span> (this-&gt;ground) {
00192     dJointDestroy(groundJoint);
00193     ref&lt;Solid&gt; cground = this-&gt;ground;
00194     this-&gt;ground = ref&lt;Solid&gt;(0);
00195     <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystema18">removeSolid</a>(cground);
00196   }
00197 
00198   <span class="keywordflow">if</span> (ground) {
00199     <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystema17">addSolid</a>(ground);
00200     this-&gt;ground = ground;
00201     ground-&gt;setPosition(position);
00202     <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp12">groundJoint</a> = dJointCreateFixed(worldID,0);
00203     ref&lt;ODESolid&gt; osolid = narrow_ref&lt;ODESolid&gt;(ground);
00204     dJointAttach(groundJoint, osolid-&gt;bodyID, 0);
00205     dJointSetFixed(groundJoint);
00206   }
00207   
00208 }
00209 
00210 
00211 ref&lt;Solid&gt; ODESolidSystem::getGround()<span class="keyword"> const</span>
00212 <span class="keyword"></span>{
00213   <span class="keywordflow">return</span> <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp11">ground</a>;
00214 }
00215 
00216 
00217 <span class="keywordtype">void</span> ODESolidSystem::setGravity(<span class="keyword">const</span> Vector3&amp; v)
00218 {
00219   dWorldSetGravity(worldID, v.x, v.y, v.z);
00220 }
00221 
00222 
00223 <span class="keywordtype">void</span> ODESolidSystem::addSolid(ref&lt;Solid&gt; solid)
00224 {
00225  <span class="keywordflow">if</span> ((!solid) || (solid &amp;&amp; (solid == <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp11">ground</a>)))
00226    <span class="keywordflow">throw</span> std::invalid_argument(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"solid must be non-null (and cannot be the ground Solid)"</span>));
00227 
00228   ref&lt;ODESolid&gt; osolid = narrow_ref&lt;ODESolid&gt;(solid);
00229   osolid-&gt;create(worldID);
00230   <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp2">solids</a>.<a class="code" href="classbase_1_1reflist.html#base_1_1reflista26">push_back</a>(solid);
00231 
00232   <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemb0">updateVisual</a>();
00233 }
00234 
00235 
00236 <span class="keywordtype">void</span> ODESolidSystem::removeSolid(ref&lt;const Solid&gt; solid)
00237 {
00238  <span class="keywordflow">if</span> ((!solid) || (solid &amp;&amp; (solid == <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp11">ground</a>)))
00239    <span class="keywordflow">throw</span> std::invalid_argument(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"solid must be non-null (and cannot be the ground Solid)"</span>));
00240 
00241   ref&lt;const ODESolid&gt; osolid = narrow_ref&lt;const ODESolid&gt;(solid);
00242   <span class="keywordflow">if</span> (osolid-&gt;worldID != <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp1">worldID</a>)
00243     <span class="keywordflow">throw</span> std::invalid_argument(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"Solid doesn't belong to this SolidSystem"</span>));
00244   osolid-&gt;destroy();
00245   <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp2">solids</a>.<a class="code" href="classbase_1_1reflist.html#base_1_1reflista48">remove</a>(solid);
00246 
00247   <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemb0">updateVisual</a>();
00248 }
00249 
00250 
00251 
00252 <span class="keywordtype">void</span> ODESolidSystem::addConstraintGroup(ref&lt;ConstraintGroup&gt; group)
00253 {
00254   ref&lt;ODEConstraintGroup&gt; ogroup = narrow_ref&lt;ODEConstraintGroup&gt;(group);
00255   <span class="keywordflow">if</span> (ogroup-&gt;getWorldID() != <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp1">worldID</a>)
00256     <span class="keywordflow">throw</span> std::invalid_argument(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"ConstraintGroup doesn't belong to this SolidSystem"</span>));
00257   <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp3">constraintGroups</a>.<a class="code" href="classbase_1_1reflist.html#base_1_1reflista26">push_back</a>(ogroup);
00258 }
00259 
00260 
00261 <span class="keywordtype">void</span> ODESolidSystem::removeConstraintGroup(ref&lt;const ConstraintGroup&gt; group)
00262 {
00263   ref&lt;const ODEConstraintGroup&gt; ogroup = narrow_ref&lt;const ODEConstraintGroup&gt;(group);
00264   <span class="keywordflow">if</span> (ogroup-&gt;getWorldID() != <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp1">worldID</a>)
00265     <span class="keywordflow">throw</span> std::invalid_argument(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"ConstraintGroup doesn't belong to this SolidSystem"</span>));
00266 
00267   <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp3">constraintGroups</a>.ConstraintGroups::remove(ogroup);
00268 }
00269 
00270 
00271 <span class="keywordtype">void</span> ODESolidSystem::setCollisionCuller(ref&lt;CollisionCuller&gt; collisionCuller)
00272 {
00273   <span class="comment">// first disconnect the current culler from the detector</span>
00274   this-&gt;collisionCuller-&gt;removePotentialCollisionListener(collisionDetector);
00275   
00276   <span class="comment">// now connect up the new one  </span>
00277   this-&gt;collisionCuller = collisionCuller;
00278   collisionCuller-&gt;addPotentialCollisionListener(collisionDetector);
00279 }
00280 
00281 
00282 ref&lt;CollisionCuller&gt; ODESolidSystem::getCollisionCuller()<span class="keyword"> const</span>
00283 <span class="keyword"></span>{
00284   <span class="keywordflow">return</span> <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp7">collisionCuller</a>;
00285 }
00286 
00287 
00288 <span class="keywordtype">void</span> ODESolidSystem::setCollisionDetector(ref&lt;CollisionDetector&gt; collisionDetector)
00289 {
00290   <span class="comment">// first disconnect the current detector from the culler &amp; us</span>
00291   <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp7">collisionCuller</a>-&gt;removePotentialCollisionListener(this-&gt;collisionDetector);
00292   this-&gt;collisionDetector-&gt;removePotentialCollisionListener(ref&lt;ODESolidSystem&gt;(<span class="keyword">this</span>));
00293 
00294   <span class="comment">// now connect up the new one  </span>
00295   this-&gt;collisionDetector = collisionDetector;
00296   <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp7">collisionCuller</a>-&gt;addPotentialCollisionListener(collisionDetector);
00297   collisionDetector-&gt;addPotentialCollisionListener(ref&lt;ODESolidSystem&gt;(<span class="keyword">this</span>));
00298 }
00299 
00300 
00301 ref&lt;CollisionDetector&gt; ODESolidSystem::getCollisionDetector()<span class="keyword"> const</span>
00302 <span class="keyword"></span>{
00303   <span class="keywordflow">return</span> collisionDetector;
00304 }
00305 
00306 
00307 <span class="keywordtype">void</span> ODESolidSystem::setCollisionResponseHandler(ref&lt;CollisionResponseHandler&gt; collisionResponseHandler)
00308 {
00309   <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp9">collisionHandler</a> = collisionResponseHandler;
00310 }
00311 
00312 ref&lt;CollisionResponseHandler&gt; ODESolidSystem::getCollisionResponseHandler()<span class="keyword"> const</span>
00313 <span class="keyword"></span>{
00314   <span class="keywordflow">return</span> <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp9">collisionHandler</a>;
00315 }
00316 
00317 
00318 
00319 <span class="keywordtype">void</span> ODESolidSystem::setParameter(<span class="keyword">const</span> String&amp; name, Real value)
00320 {
00321   <span class="keywordflow">if</span> (name == <a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"ERP"</span>))
00322     dWorldSetERP(worldID, value);
00323   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (name == <a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"CFM"</span>))
00324     dWorldSetCFM(worldID, value);
00325   <span class="keywordflow">else</span>
00326     SolidSystem::setParameter(name, value);
00327 }
00328 
00329 
00330 <span class="comment">// PotentialCollisionListener</span>
00331 
00332 <span class="keywordtype">void</span> ODESolidSystem::reset()
00333 {
00334   <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp9">collisionHandler</a>-&gt;reset();
00335 }
00336 
00337 <span class="keywordtype">void</span> ODESolidSystem::potentialCollision(ref&lt;const Collidable&gt; collidable1, ref&lt;const Collidable&gt; collidable2)
00338 {
00339   <span class="keywordflow">if</span> (<a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp4">collisionListenMode</a> == <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemx6physics_1_1ODESolidSystemx4">HandleCollisions</a>) { <span class="comment">// pass collisions on to handler</span>
00340     <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp9">collisionHandler</a>-&gt;potentialCollision(collidable1, collidable2);
00341   }
00342   <span class="keywordflow">else</span> { <span class="comment">// just initialy checking for interpenetrations</span>
00343     
00344     <span class="keywordflow">if</span> (!collidable1-&gt;isInterpenetrationNormal() &amp;&amp; !collidable2-&gt;isInterpenetrationNormal()) 
00345       <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp6">initiallyPenetratingPairs</a>.push_back( std::make_pair&lt;ref&lt;const Collidable&gt;, ref&lt;const Collidable&gt; &gt;(collidable1, collidable2) );
00346   }
00347 }
00348 
00349 
00350 <span class="keywordtype">void</span> ODESolidSystem::preSimulate()
00351 {
00352   <span class="comment">// check that the current configurations for Solids is a valid one</span>
00353   <span class="comment">//  before simulating (i.e. check there are no penetrations)</span>
00354   <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp5">initialPenetrations</a> = <span class="keyword">false</span>;
00355   <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp4">collisionListenMode</a> = <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemx6physics_1_1ODESolidSystemx5">RecordInterpenetrations</a>;
00356   <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp6">initiallyPenetratingPairs</a>.clear();
00357   
00358   <span class="keywordflow">if</span> (<a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp7">collisionCuller</a> != 0) {
00359     <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp7">collisionCuller</a>-&gt;collisionEnable(<span class="keyword">true</span>);
00360     <span class="keywordflow">if</span> (<a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp10">collidable</a> == 0)
00361       <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp10">collidable</a> = <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystema33">createCollidable</a>();
00362     <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp7">collisionCuller</a>-&gt;reset();
00363     <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp7">collisionCuller</a>-&gt;collide(collidable);
00364   }
00365 
00366   <span class="keywordflow">if</span> (<a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp5">initialPenetrations</a>) {
00367     <a class="code" href="base.html#a11">Consoleln</a>(<span class="stringliteral">"The initial configuration of some Solids is one of inter-penetration (see log) - system inactivated."</span>);
00368     <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp0">active</a>=<span class="keyword">false</span>;
00369     <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp7">collisionCuller</a>-&gt;collisionEnable(<span class="keyword">false</span>);
00370   }
00371   
00372   <span class="comment">// permanently disable collisions between all initially penetrating pairs</span>
00373   PenetratingPairs::const_iterator ppair = <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp6">initiallyPenetratingPairs</a>.begin();
00374   PenetratingPairs::const_iterator end = <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp6">initiallyPenetratingPairs</a>.end();
00375   <span class="keywordflow">while</span> (ppair != end) {
00376     <span class="keyword">const</span> <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemx2">CollidablePair</a>&amp; pair(*ppair);
00377     <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp7">collisionCuller</a>-&gt;collisionEnable(<span class="keyword">false</span>, pair.first, pair.second);
00378     
00379     <span class="comment">// log that we're disabling collisions</span>
00380     <a class="code" href="namespacebase.html#a4">String</a> name1(<span class="stringliteral">"unnamed"</span>), name2(<span class="stringliteral">"unnamed"</span>);
00381     <span class="keywordflow">if</span> ( <a class="code" href="base.html#a25">instanceof</a>(*pair.first, <span class="keyword">const</span> <a class="code" href="classphysics_1_1ODESolidConnectedCollidableBody.html">ODESolidConnectedCollidableBody</a>))
00382       name1 = narrow_ref&lt;const ODESolidConnectedCollidableBody&gt;(pair.first)-&gt;getName();
00383     <span class="keywordflow">if</span> ( <a class="code" href="base.html#a25">instanceof</a>(*pair.second, <span class="keyword">const</span> <a class="code" href="classphysics_1_1ODESolidConnectedCollidableBody.html">ODESolidConnectedCollidableBody</a>))
00384       name2 = narrow_ref&lt;const ODESolidConnectedCollidableBody&gt;(pair.second)-&gt;getName();
00385     
00386     <a class="code" href="base.html#a3">Logln</a>(<span class="stringliteral">"Warning: Disabling collisions between CollidableBodies '"</span> &lt;&lt; name1 &lt;&lt; <span class="stringliteral">"' and '"</span> &lt;&lt; name2 &lt;&lt; <span class="stringliteral">"' as they are initiallly penetrating."</span>);
00387     
00388     ++ppair;
00389   }
00390   
00391   
00392   <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp6">initiallyPenetratingPairs</a>.clear();
00393   <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp4">collisionListenMode</a> = <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemx6physics_1_1ODESolidSystemx4">HandleCollisions</a>;
00394   
00395   <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp13">preSimulateCalled</a> = <span class="keyword">true</span>;
00396 }
00397 
00398 
00399 <span class="keywordtype">void</span> ODESolidSystem::simulateForSimTime(<span class="keyword">const</span> <a class="code" href="classbase_1_1Time.html">base::Time</a>&amp; dt)
00400 {
00401   <a class="code" href="base.html#a21">Assertm</a>(preSimulateCalled,<span class="stringliteral">"preSimulate() called before simulateForSimTime()"</span>);
00402 
00403   <span class="comment">// Do Collision detection</span>
00404   <span class="keywordflow">if</span> (<a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp7">collisionCuller</a> != 0) {
00405 
00406     <span class="keywordflow">if</span> (<a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp10">collidable</a> != 0) {
00407       <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp7">collisionCuller</a>-&gt;reset();
00408       <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp7">collisionCuller</a>-&gt;collide(collidable);
00409     }
00410   }
00411 
00412   <span class="keywordflow">if</span> (<a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp0">active</a> &amp;&amp; (dt&gt;0)) 
00413     dWorldStep(worldID, dt.<a class="code" href="classbase_1_1Time.html#base_1_1Timea13">seconds</a>());
00414   
00415   <span class="keywordflow">if</span> (<a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp15">node</a> != 0) { <span class="comment">// is there a Visual?</span>
00416     <span class="comment">// update Visual</span>
00417     Solids::iterator s = <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp2">solids</a>.<a class="code" href="classbase_1_1reflist.html#base_1_1reflista0">begin</a>();
00418     Solids::iterator end = <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp2">solids</a>.<a class="code" href="classbase_1_1reflist.html#base_1_1reflista3">end</a>();
00419     <span class="keywordflow">while</span> (s != end) {
00420       ref&lt;ODESolid&gt; solid = narrow_ref&lt;ODESolid&gt;(*s);
00421       solid-&gt;updateVisual();
00422 
00423       ++s;
00424     }
00425   }
00426 }
00427 
00428 
00429 
00430 
00431 
00432 osg::Node* ODESolidSystem::createOSGVisual(Visual::Attributes visualAttributes)<span class="keyword"> const</span>
00433 <span class="keyword"></span>{
00434   <span class="keywordflow">if</span> ((<a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp15">node</a>!=0) &amp;&amp; (<a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp14">attributes</a>==visualAttributes))
00435     <span class="keywordflow">return</span> &amp;(*node);
00436 
00437   <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp15">node</a> = <span class="keyword">new</span> osg::Group();
00438   <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp15">node</a>-&gt;setName(<span class="stringliteral">"ODESolidSystem"</span>);
00439 
00440   <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp14">attributes</a> = visualAttributes;
00441 
00442   <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemb0">updateVisual</a>();
00443 
00444   <span class="keywordflow">return</span> &amp;(*node);
00445 }
00446 
00447 
00448 <span class="keywordtype">void</span> ODESolidSystem::updateVisual()<span class="keyword"> const</span>
00449 <span class="keyword"></span>{
00450   <span class="keywordflow">if</span> (<a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp15">node</a>==0) <span class="keywordflow">return</span>; <span class="comment">// no Visual to update</span>
00451 
00452  <span class="comment">// remove all Solids from the top-level group and re-add them (to account for</span>
00453  <span class="comment">//  additions and removals)</span>
00454  <span class="keywordflow">while</span> (<a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp15">node</a>-&gt;getNumChildren() &gt; 0)
00455    <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp15">node</a>-&gt;removeChild(<a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp15">node</a>-&gt;getChild(0));
00456 
00457   <span class="comment">// add solids </span>
00458   Solids::const_iterator_const s = <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp2">solids</a>.<a class="code" href="classbase_1_1reflist.html#base_1_1reflista2">const_begin</a>();
00459   Solids::const_iterator_const end = <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp2">solids</a>.<a class="code" href="classbase_1_1reflist.html#base_1_1reflista5">const_end</a>();
00460   <span class="keywordflow">while</span> (s != end) {
00461     ref&lt;const Solid&gt; solid = *s;
00462     <span class="keywordflow">if</span> (solid-&gt;visualTypeSupported(Visual::OSGVisual))
00463       <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp15">node</a>-&gt;addChild(solid-&gt;createOSGVisual(attributes));
00464     ++s;
00465   }<span class="comment"></span>
00466 <span class="comment">//!!! and collider visuals etc.</span>
00467 <span class="comment"></span>  <span class="comment">// add collision detector visual (if any)</span>
00468   <span class="keywordflow">if</span> (collisionDetector)
00469     <span class="keywordflow">if</span> (collisionDetector-&gt;visualTypeSupported(Visual::OSGVisual))
00470       <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp15">node</a>-&gt;addChild(collisionDetector-&gt;createOSGVisual(attributes));
00471  
00472 }
00473 
00474 
00475 ref&lt;Collidable&gt; ODESolidSystem::createCollidable(CollidableFlags flags) 
00476 {
00477   <span class="comment">// just create CollidableBodys for all the Solids and put them in </span>
00478   <span class="comment">//  a single group</span>
00479   ref&lt;ODECollidableGroup&gt; group(NewObj ODECollidableGroup());
00480 
00481   Solids::const_iterator s = <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp2">solids</a>.<a class="code" href="classbase_1_1reflist.html#base_1_1reflista0">begin</a>();
00482   Solids::const_iterator end = <a class="code" href="classphysics_1_1ODESolidSystem.html#physics_1_1ODESolidSystemp2">solids</a>.<a class="code" href="classbase_1_1reflist.html#base_1_1reflista3">end</a>();
00483   <span class="keywordflow">while</span> (s != end) {
00484     ref&lt;Solid&gt; solid = *s;
00485     group-&gt;addCollidable( solid-&gt;createCollidable(flags) ); 
00486     ++s;
00487   }
00488 
00489   <span class="keywordflow">return</span> group;
00490 }
00491 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Jul 29 15:56:27 2004 for OpenSim by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.6 </small></address>
</body>
</html>
