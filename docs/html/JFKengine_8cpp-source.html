<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>OpenSim: robot/JFKengine.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>robot/JFKengine.cpp</h1><a href="JFKengine_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/****************************************************************************</span>
00002 <span class="comment">  Copyright (C)2002 David Jung &lt;opensim@pobox.com&gt;</span>
00003 <span class="comment"></span>
00004 <span class="comment">  This program/file is free software; you can redistribute it and/or modify</span>
00005 <span class="comment">  it under the terms of the GNU General Public License as published by</span>
00006 <span class="comment">  the Free Software Foundation; either version 2 of the License, or</span>
00007 <span class="comment">  (at your option) any later version.</span>
00008 <span class="comment"></span>
00009 <span class="comment">  This program is distributed in the hope that it will be useful,</span>
00010 <span class="comment">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00011 <span class="comment">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00012 <span class="comment">  GNU General Public License for more details. (http://www.gnu.org)</span>
00013 <span class="comment"></span>
00014 <span class="comment">  You should have received a copy of the GNU General Public License</span>
00015 <span class="comment">  along with this program; if not, write to the Free Software</span>
00016 <span class="comment">  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
00017 <span class="comment"></span>
00018 <span class="comment">  $Id: JFKengine.cpp 1039 2004-02-11 20:50:52Z jungd $</span>
00019 <span class="comment">  $Revision: 1.5 $</span>
00020 <span class="comment">  $Date: 2004-02-11 15:50:52 -0500 (Wed, 11 Feb 2004) $</span>
00021 <span class="comment">  $Author: jungd $</span>
00022 <span class="comment"></span>
00023 <span class="comment">****************************************************************************/</span>
00024 
00025 <span class="preprocessor">#include &lt;<a class="code" href="JFKengine.html">robot/JFKengine</a>&gt;</span>
00026 <span class="preprocessor">#include &lt;<a class="code" href="base.html">base/base</a>&gt;</span>
00027 
00028 <span class="preprocessor">#include &lt;<a class="code" href="Time.html">base/Time</a>&gt;</span>
00029 
00030 <span class="keyword">using</span> <a class="code" href="classrobot_1_1JFKengine.html">robot::JFKengine</a>;
00031 <span class="keyword">using</span> <a class="code" href="classrobot_1_1KinematicChain.html">robot::KinematicChain</a>;
00032 
00033 <span class="keyword">using</span> <a class="code" href="classbase_1_1Math.html">base::Math</a>;
00034 <span class="keyword">using</span> <a class="code" href="classbase_1_1Time.html">base::Time</a>;
00035 <span class="keyword">using</span> <a class="code" href="classbase_1_1vector.html">base::Vector</a>;
00036 <span class="keyword">using</span> <a class="code" href="classbase_1_1Vector3.html">base::Vector3</a>;
00037 <span class="keyword">using</span> <a class="code" href="classbase_1_1matrix.html">base::Matrix</a>;
00038 <span class="keyword">using</span> <a class="code" href="classbase_1_1Expression.html">base::Expression</a>;
00039 <span class="keyword">using</span> <a class="code" href="classbase_1_1matrix.html">base::ExpressionMatrix</a>;
00040 
00041 
00042 JFKengine::JFKengine() 
00043   : forwardKinematicsCached(false), A(0), T(0), 
00044     JCached(false), J(1,1)
00045 {
00046 }
00047 
00048 
00049 <a class="code" href="classbase_1_1matrix.html">ExpressionMatrix</a> JFKengine::getForwardKinematics(<span class="keyword">const</span> KinematicChain&amp; chain)<span class="keyword"> const</span>
00050 <span class="keyword"></span>{ 
00051   <span class="keyword">const</span> <a class="code" href="namespacebase.html#a2">Int</a> n = chain.size(); <span class="comment">// no. of links in the chain</span>
00052 
00053   <span class="keyword">const</span> <a class="code" href="namespacebase.html#a5">Real</a> trigEpsilon = 1.0e-5; <span class="comment">// if sin or cos of angles are smaller, set sin=0 or cos=0</span>
00054 
00055   <span class="keywordflow">if</span> (n &lt; 1) { <span class="comment">// no links, return identity</span>
00056     <a class="code" href="classbase_1_1matrix.html">ExpressionMatrix</a> I(4,4);
00057     I(0,0)=I(1,1)=I(2,2)=I(3,3)=1;
00058     <span class="keywordflow">return</span> I;
00059   }
00060 
00061   <span class="keywordflow">if</span> ( <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep1">A</a>.size() != n ) {
00062     <span class="comment">// array resize is non-descructive (except the the elements truncated when resizing smaller)</span>
00063     <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep1">A</a>.resize(n);
00064     <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep2">T</a>.resize(n);
00065     <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep3">chain_AT</a>.resize(n);
00066   }
00067 
00068   <a class="code" href="classbase_1_1Expression.html">Expression</a> zero = 0;
00069   <a class="code" href="classbase_1_1Expression.html">Expression</a> one = 1;
00070 
00071   <span class="comment">// form A[i], the position and orientation matrix of frame for this link, relative to last one</span>
00072   <a class="code" href="namespacebase.html#a2">Int</a> dof = 0;
00073   <span class="keywordflow">for</span> ( <a class="code" href="namespacebase.html#a2">Int</a> l = 0; l &lt; n; l++ ) {
00074     <span class="keyword">const</span> KinematicChain::Link&amp; link( chain[l] );
00075     <span class="comment">//Debugcln(JFKE, "\n=====getForwardKinematics loop, joint " &lt;&lt; (i+1) &lt;&lt; ": " &lt;&lt; joint);</span>
00076 
00077     <span class="comment">// determine if we're already computed and cached the A[l], the transform between</span>
00078     <span class="comment">//  the last link and this one </span>
00079     <span class="keywordflow">if</span> (<a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep0">forwardKinematicsCached</a>) { <span class="comment">// something is cached, see if it is what we want</span>
00080       <span class="keywordflow">if</span> ( <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep3">chain_AT</a>[l] != link ) 
00081         <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep0">forwardKinematicsCached</a> = <span class="keyword">false</span>;  <span class="comment">// must recompute A &amp; T from this link on, since link is different</span>
00082     }
00083 
00084 
00085     <span class="keywordflow">if</span> (!<a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep0">forwardKinematicsCached</a>) {
00086 
00087       <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep1">A</a>[l].resize(4,4); <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep2">T</a>[l].resize(4,4);
00088       <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep3">chain_AT</a>.setLink(l, link);  <span class="comment">// for caching, save parameters used to compute A &amp; T</span>
00089       <span class="comment">//Debugcln(JFKE,"JFKEngine(): FK link " &lt;&lt; l &lt;&lt; "(dof=" &lt;&lt; dof &lt;&lt; "):" &lt;&lt; link);</span>
00090 
00091       <a class="code" href="classbase_1_1Expression.html">Expression</a> theta, d; <span class="comment">// used to set variables for Denavit-Hartenberg notation</span>
00092       <span class="keywordflow">if</span> (link.isDHType()) {    <span class="comment">// D-H type joints (Revolute, Prismatic)</span>
00093 
00094         <span class="comment">// determine what is constant and what is variable to set expressions for theta and d</span>
00095         <span class="keywordflow">if</span> (link.type() == KinematicChain::Link::Revolute) {
00096           <span class="keywordflow">if</span> (link.isActive())
00097             theta = Expression::p[dof];
00098           <span class="keywordflow">else</span>
00099             theta = link.getTheta(); <span class="comment">// inactive joints are considered to be fixed in the home position</span>
00100           d = link.getD();
00101         }
00102         <span class="keywordflow">else</span> { <span class="comment">// Prismatic</span>
00103           theta = link.getTheta();
00104           <span class="keywordflow">if</span> (link.isActive())
00105             d = Expression::p[dof];
00106           <span class="keywordflow">else</span>
00107             d = link.getD();        <span class="comment">// inactive joints are considered to be fixed in the home position</span>
00108         }
00109 
00110         <a class="code" href="namespacebase.html#a5">Real</a> sinAlpha = Math::zeroIfNeighbour( Math::sin(link.getAlpha()), trigEpsilon );
00111         <a class="code" href="namespacebase.html#a5">Real</a> cosAlpha = Math::zeroIfNeighbour( Math::cos(link.getAlpha()), trigEpsilon );
00112         <a class="code" href="classbase_1_1Expression.html">Expression</a> sinTheta = <a class="code" href="namespacebase.html#a64">sin</a>(theta);
00113         <a class="code" href="classbase_1_1Expression.html">Expression</a> cosTheta = <a class="code" href="namespacebase.html#a65">cos</a>(theta);
00114         
00115         <span class="comment">// form A[i], which represents the position and orientation of frame i relative to frame i-1</span>
00116         <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep1">A</a>[l](0,0)=cosTheta; <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep1">A</a>[l](0,1)=-sinTheta*cosAlpha; <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep1">A</a>[l](0,2)=sinTheta*sinAlpha;  <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep1">A</a>[l](0,3)=link.getA()*cosTheta;
00117         <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep1">A</a>[l](1,0)=sinTheta; <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep1">A</a>[l](1,1)=cosTheta*cosAlpha;  <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep1">A</a>[l](1,2)=-cosTheta*sinAlpha; <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep1">A</a>[l](1,3)=link.getA()*sinTheta;
00118         <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep1">A</a>[l](2,0)=zero;     <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep1">A</a>[l](2,1)=sinAlpha;           <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep1">A</a>[l](2,2)=cosAlpha;           <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep1">A</a>[l](2,3)=d;
00119         <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep1">A</a>[l](3,0)=zero;     <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep1">A</a>[l](3,1)=zero;               <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep1">A</a>[l](3,2)=zero;               <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep1">A</a>[l](3,3)=one;
00120 
00121       } 
00122       <span class="keywordflow">else</span> { <span class="comment">// non-D-H type joint</span>
00123 
00124         <span class="keywordflow">if</span> (link.type() == KinematicChain::Link::Translating) {
00125 
00126           <a class="code" href="classbase_1_1Expression.html">Expression</a> t = Expression::p[dof]; <span class="comment">// translation distance variable</span>
00127           <a class="code" href="base.html#a19">Assert</a>(link.getDirection().length() &gt; 0);
00128           Vector3 dir( link.getDirection() ); dir.normalize(); <span class="comment">// make unit length</span>
00129           
00130           <span class="comment">// simple translation by t*dir</span>
00131           <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep1">A</a>[l](0,0)=one;  <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep1">A</a>[l](0,1)=zero; <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep1">A</a>[l](0,2)=zero; <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep1">A</a>[l](0,3)=dir.x*t;
00132           <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep1">A</a>[l](1,0)=zero; <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep1">A</a>[l](1,1)=one;  <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep1">A</a>[l](1,2)=zero; <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep1">A</a>[l](1,3)=dir.y*t;
00133           <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep1">A</a>[l](2,0)=zero; <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep1">A</a>[l](2,1)=zero; <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep1">A</a>[l](2,2)=one;  <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep1">A</a>[l](2,3)=dir.z*t;
00134           <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep1">A</a>[l](3,0)=zero; <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep1">A</a>[l](3,1)=zero; <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep1">A</a>[l](3,2)=zero; <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep1">A</a>[l](3,3)=one;
00135 
00136         } <span class="comment">// end Translating</span>
00137         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (link.type() == KinematicChain::Link::FixedTransform) {
00138 
00139           <span class="comment">// this is a 0-dof transforming link</span>
00140           <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep1">A</a>[l] = <a class="code" href="namespacebase.html#a76">base::toExpressionMatrix</a>(base::fromMatrix4(link.getTransform()));
00141 
00142 
00143         } <span class="comment">// end FixedTransform</span>
00144         <span class="keywordflow">else</span>
00145           <span class="keywordflow">throw</span> std::runtime_error(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"unsupported joint type in chain - can't calculate forward kinematic transform"</span>));
00146 
00147       }
00148 
00149       simplify( A[l] );
00150 
00151       <span class="keywordflow">if</span> ( l &lt; 1 )
00152         <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep2">T</a>[l] = <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep1">A</a>[l];
00153       <span class="keywordflow">else</span> {
00154         <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep2">T</a>[l] = <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep2">T</a>[l-1] * A[l];
00155         simplify( T[l] );
00156       }
00157    
00158       <span class="comment">//Debugcln(JFKE, "\nA[" &lt;&lt; (i+1) &lt;&lt; "] matrix after simplification:\n" &lt;&lt; A[i]);</span>
00159       <span class="comment">//Debugcln(JFKE, "\nT[" &lt;&lt; (i+1) &lt;&lt; "] matrix after simplification:\n" &lt;&lt; T[i]);</span>
00160     }
00161 
00162     dof += link.dof();
00163     <span class="comment">// end single link contribution</span>
00164 
00165   } <span class="comment">// for l</span>
00166 
00167   
00168   <span class="comment">//Debugc( JFKE, "Homogeneous transformation matrix T[" &lt;&lt; n &lt;&lt; "]:");</span>
00169  
00170   <span class="comment">/*</span>
00171 <span class="comment">  for (Int iRow=0; iRow&lt;4; iRow++) {</span>
00172 <span class="comment">    Debugc( JFKE, "\n");</span>
00173 <span class="comment">    for (Int iCol=0; iCol&lt;4; iCol++) {</span>
00174 <span class="comment">      Debugcln( JFKE, "  (" &lt;&lt; iRow &lt;&lt; "," &lt;&lt; iCol &lt;&lt; ")=" &lt;&lt; T[n-1](iRow,iCol));</span>
00175 <span class="comment">    }</span>
00176 <span class="comment">  }</span>
00177 <span class="comment">  */</span>
00178   
00179   <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep0">forwardKinematicsCached</a> = <span class="keyword">true</span>;
00180 
00181   <span class="comment">//Debugcln(KF, "\n" &lt;&lt; chain_AT.size() &lt;&lt; " Cached JointParamters in chain_AT\n" &lt;&lt; chain_AT);</span>
00182   <span class="keywordflow">return</span> <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep2">T</a>[n-1];
00183 }
00184 
00185 
00186 
00187 <a class="code" href="classbase_1_1matrix.html">ExpressionMatrix</a> JFKengine::getJacobian(<span class="keyword">const</span> KinematicChain&amp; chain, <span class="keywordtype">bool</span> includeOrientation)<span class="keyword"> const</span>
00188 <span class="keyword"></span>{
00189   <span class="keyword">const</span> <a class="code" href="namespacebase.html#a2">Int</a> n = chain.size(); 
00190   <span class="keyword">const</span> <a class="code" href="namespacebase.html#a2">Int</a> chain_dof = chain.dof(); <span class="comment">// no. of variables / degrees-of-freedom</span>
00191 
00192   <span class="keywordflow">if</span> (chain.dof() &lt; 1) { <span class="comment">// no joints, return zero/empty matrix</span>
00193     <a class="code" href="classbase_1_1matrix.html">ExpressionMatrix</a> Z(includeOrientation?6:3,0);
00194     <span class="keywordflow">return</span> Z;
00195   }
00196  
00197   <span class="comment">//Debugln(JFKE, "\n");</span>
00198 
00199   <span class="comment">// see if cached J can be used</span>
00200   <span class="keywordflow">if</span> ( <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep5">chain_J</a>.dof() != chain_dof ) {
00201     <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep4">JCached</a> = <span class="keyword">false</span>;  <span class="comment">// must recompute J because not same number of joints as what is cached</span>
00202   }
00203   <span class="keywordflow">else</span> {
00204     <span class="keywordflow">if</span> (<a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep5">chain_J</a>.hashCode() != chain.hashCode())
00205       <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep4">JCached</a> = <span class="keyword">false</span>;  <span class="comment">// must recompute J because joints are not the same as what is cached</span>
00206     <span class="keywordflow">else</span> {
00207       <span class="keywordflow">if</span> (includeOrientation) {
00208         <span class="keywordflow">if</span> (<a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep6">J</a>.<a class="code" href="classbase_1_1matrix.html#base_1_1matrixa8">size1</a>() != 6)
00209           <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep4">JCached</a> = <span class="keyword">false</span>; <span class="comment">// orientation components weren't cached</span>
00210       }
00211       <span class="keywordflow">else</span> {
00212         <span class="comment">// if cached J includes orientation components we don't need, discard them</span>
00213         <a class="code" href="classbase_1_1matrix.html">ExpressionMatrix</a> cachedJ(J); <span class="comment">// make copy</span>
00214         <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep6">J</a>.<a class="code" href="classbase_1_1matrix.html#base_1_1matrixa15">resize</a>(3,cachedJ.<a class="code" href="classbase_1_1matrix.html#base_1_1matrixa9">size2</a>()); <span class="comment">// destructive resize</span>
00215         <span class="comment">// copy position components back</span>
00216         <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> r=0; r&lt;3; r++)
00217           <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> c=0; c&lt;<a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep6">J</a>.<a class="code" href="classbase_1_1matrix.html#base_1_1matrixa9">size2</a>(); c++)
00218             <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep6">J</a>(r,c) = cachedJ(r,c);
00219       }
00220     }
00221   }
00222   
00223 
00224   <span class="keywordflow">if</span> (!<a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep4">JCached</a>) { <span class="comment">// recompute</span>
00225 <span class="preprocessor">    #ifdef DEBUG</span>
00226 <span class="preprocessor"></span>    <a class="code" href="classbase_1_1Time.html">base::Time</a> start( Time::now() );
00227 <span class="preprocessor">    #endif</span>
00228 <span class="preprocessor"></span>
00229     <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep5">chain_J</a> = chain;
00230     <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep6">J</a>.<a class="code" href="classbase_1_1matrix.html#base_1_1matrixa15">resize</a>(includeOrientation?6:3, chain_dof);
00231 
00232     <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginea3">getForwardKinematics</a>( chain );  <span class="comment">// ensure manipulator arm expression T is cached</span>
00233  
00234     <a class="code" href="classbase_1_1Expression.html">Expression</a> zero = 0;
00235     <a class="code" href="classbase_1_1Expression.html">Expression</a> one = 1;
00236 
00237     <span class="keywordflow">for</span> (<a class="code" href="namespacebase.html#a2">Int</a> dof=0, l=0; l &lt; n; l++) { <span class="comment">// for each link</span>
00238       <span class="keyword">const</span> KinematicChain::Link&amp; link( chain[l] );
00239 
00240       <span class="keywordflow">if</span> (link.dof() &gt; 0) { 
00241 
00242         <span class="comment">// Jacobian rows 1,2,3:  differentiate x,y,z: fourth column of T</span>
00243         <span class="keywordflow">for</span> (<a class="code" href="namespacebase.html#a2">Int</a> iVar=0; iVar &lt; 3; iVar++) {
00244           <span class="comment">//Debugcln(KF, "J(" &lt;&lt; iVar &lt;&lt; "," &lt;&lt; iJoint &lt;&lt; ") Before differentiating, expression= " &lt;&lt; T[n-1](iVar,3) );</span>
00245           <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep6">J</a>(iVar,dof) = <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep2">T</a>[n-1](iVar,3).differentiate( Expression::p[dof] );
00246           <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep6">J</a>(iVar,dof).simplify();
00247           <span class="comment">//Debugcln(KF, "J(" &lt;&lt; iVar &lt;&lt; "," &lt;&lt; iJoint &lt;&lt; ") after differentiating =" &lt;&lt; J(iVar,iJoint) );</span>
00248         }
00249         
00250         <span class="keywordflow">if</span> (includeOrientation) {
00251           <span class="comment">// Jacobian rows 4,5,6: </span>
00252           <span class="keyword">const</span>  KinematicChain::Link::LinkType linkType( (chain[l]).type() );
00253           <span class="keywordflow">switch</span> (linkType) {
00254           <span class="keywordflow">case</span> KinematicChain::Link::Revolute:  
00255             <span class="keywordflow">if</span> (dof &lt; 1) {
00256               <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep6">J</a>(3,0) = <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep6">J</a>(4,0) = zero; <span class="comment">// [0,0,1] for first column, by definition</span>
00257               <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep6">J</a>(5,0) = one;
00258             }
00259             <span class="keywordflow">else</span> {
00260               <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep6">J</a>(3,dof) = <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep2">T</a>[l-1](0,2); <span class="comment">// from position in cumulative transformation matrix T</span>
00261               <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep6">J</a>(4,dof) = <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep2">T</a>[l-1](1,2);
00262               <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep6">J</a>(5,dof) = <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep2">T</a>[l-1](2,2);
00263             }
00264             <span class="keywordflow">break</span>;
00265             
00266           <span class="keywordflow">case</span> KinematicChain::Link::Prismatic:
00267           <span class="keywordflow">case</span> KinematicChain::Link::Translating:
00268             <span class="keywordflow">for</span> (<a class="code" href="namespacebase.html#a2">Int</a> i=3; i&lt; 6; i++) {
00269               <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep6">J</a>(i,dof) = zero;  <span class="comment">// no angular velocity contribution for prismatic or translating joints</span>
00270             }
00271             <span class="keywordflow">break</span>;
00272           <span class="keywordflow">default</span>:
00273             <span class="keywordflow">throw</span> std::runtime_error(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"unsupported joint type in chain - can't compute Jacobian"</span>));
00274           }
00275         } <span class="comment">// end if(includeOrientation)</span>
00276 
00277       } <span class="comment">// if link.dof() &gt; 0</span>
00278 
00279       dof += link.dof();
00280 
00281     } <span class="comment">// for each link</span>
00282     
00283     <span class="comment">/*</span>
00284 <span class="comment">    Debugcln( JFKE, "Jacobian matrix: \n");</span>
00285 <span class="comment">    for (Int iJoint = 0; iJoint&lt;n; iJoint++) {</span>
00286 <span class="comment">      Debugcln( JFKE, "J[" &lt;&lt; (iJoint+1) &lt;&lt; "]=");</span>
00287 <span class="comment">      for (Int iRow=0; iRow&lt;(includeOrientation?6:3); iRow++) {</span>
00288 <span class="comment">        Debugcln( JFKE, "\t" &lt;&lt; J(iRow,iJoint) &lt;&lt; "\n");</span>
00289 <span class="comment">      }</span>
00290 <span class="comment">    }</span>
00291 <span class="comment">    */</span>
00292 
00293     <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep4">JCached</a> = <span class="keyword">true</span>;
00294     <span class="comment">//Debugcln(KF, "\n" &lt;&lt; chain_J.size() &lt;&lt; " Cached JointParamters in chain_J\n" &lt;&lt; chain_J);</span>
00295 <span class="preprocessor">    #ifdef DEBUG</span>
00296 <span class="preprocessor"></span>    <a class="code" href="debugtools.html#a7">Debugln</a>( JFKE, <span class="stringliteral">"Symbolic Jacobian computation for "</span> &lt;&lt; chain.size() 
00297                  &lt;&lt; <span class="stringliteral">" link manipulator took "</span> &lt;&lt; (Time::now()-start).seconds() &lt;&lt; <span class="stringliteral">"s"</span>);
00298 <span class="preprocessor">    #endif</span>
00299 <span class="preprocessor"></span>  }  <span class="comment">// end JCached else</span>
00300   <span class="keywordflow">return</span> <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep6">J</a>;
00301 }
00302 
00303 
00304 
00305 <a class="code" href="classbase_1_1matrix.html">Matrix</a> JFKengine::getForwardKinematics(<span class="keyword">const</span> KinematicChain&amp; chain, <span class="keyword">const</span> <a class="code" href="classdemeter_1_1Vector.html">Vector</a>&amp; q)<span class="keyword"> const</span>
00306 <span class="keyword"></span>{
00307   <a class="code" href="classbase_1_1matrix.html">ExpressionMatrix</a> F( <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginea3">getForwardKinematics</a>(chain) );
00308   <span class="keywordflow">return</span> evaluate(F,q);
00309 }
00310 
00311 
00312 <a class="code" href="classbase_1_1matrix.html">Matrix</a> JFKengine::getJacobian(<span class="keyword">const</span> KinematicChain&amp; chain, <span class="keyword">const</span> <a class="code" href="classdemeter_1_1Vector.html">Vector</a>&amp; q, <span class="keywordtype">bool</span> includeOrientation)<span class="keyword"> const</span>
00313 <span class="keyword"></span>{
00314   <a class="code" href="classbase_1_1matrix.html">ExpressionMatrix</a> <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep6">J</a>( <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginea4">getJacobian</a>(chain, includeOrientation) );
00315   <span class="keywordflow">return</span> evaluate(J,q);
00316 }
00317 
00318 
00319 
00320 
00321 array&lt;Vector&gt; JFKengine::getJointOrigins(<span class="keyword">const</span> KinematicChain&amp; chain, <span class="keyword">const</span> <a class="code" href="classdemeter_1_1Vector.html">Vector</a>&amp; q )<span class="keyword"> const</span>
00322 <span class="keyword"></span>{
00323   <span class="keywordflow">if</span> ( chain.dof() &lt; 1 )
00324     <span class="keywordflow">return</span> array&lt;Vector&gt;(0); <span class="comment">// no joints</span>
00325 
00326   <a class="code" href="base.html#a19">Assert</a>(q.size() == chain.dof() );
00327 
00328   <span class="comment">// NB: assumes no joints with dof &gt; 1 !  i.e. 1&lt;-&gt;1  joints&lt;-&gt;dofs</span>
00329   
00330   <span class="keyword">const</span> <a class="code" href="namespacebase.html#a2">Int</a> chain_dof = chain.dof();
00331 
00332   array&lt;Vector&gt; locs(chain_dof); 
00333   <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginea3">getForwardKinematics</a>(chain); <span class="comment">// cache T</span>
00334 
00335   <span class="keywordflow">for</span> (<a class="code" href="namespacebase.html#a2">Int</a> v=0; v &lt; chain_dof; v++ ) {
00336     locs[v].resize(3);
00337     <a class="code" href="namespacebase.html#a2">Int</a> li = chain.linkIndexOfVariable(v);
00338     <span class="keywordflow">for</span> ( <a class="code" href="namespacebase.html#a2">Int</a> iDimension=0; iDimension &lt; 3; iDimension++ ) {
00339       locs[v][iDimension] = <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep2">T</a>[li](iDimension,3).evaluate( q ); 
00340     }
00341   }
00342  
00343   <span class="keywordflow">return</span> locs;
00344 }
00345 
00346 
00347 array&lt;Vector&gt; JFKengine::getLinkOrigins(<span class="keyword">const</span> KinematicChain&amp; chain, <span class="keyword">const</span> <a class="code" href="classdemeter_1_1Vector.html">Vector</a>&amp; q )<span class="keyword"> const</span>
00348 <span class="keyword"></span>{
00349   <span class="keywordflow">if</span> ( chain.size() &lt; 1 )
00350     <span class="keywordflow">return</span> array&lt;Vector&gt;(0); <span class="comment">// no links</span>
00351 
00352   <a class="code" href="base.html#a19">Assert</a>(q.size() == chain.dof() );
00353 
00354   <span class="keyword">const</span> <a class="code" href="namespacebase.html#a2">Int</a> chain_size = chain.size();
00355 
00356   array&lt;Vector&gt; locs(chain_size); 
00357   <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginea3">getForwardKinematics</a>(chain); <span class="comment">// cache T</span>
00358 
00359   <span class="keywordflow">for</span> (<a class="code" href="namespacebase.html#a2">Int</a> li=0; li &lt; chain_size; li++ ) {
00360     locs[li].resize(3);
00361     <span class="keywordflow">for</span> ( <a class="code" href="namespacebase.html#a2">Int</a> iDimension=0; iDimension &lt; 3; iDimension++ ) {
00362       locs[li][iDimension] = <a class="code" href="classrobot_1_1JFKengine.html#robot_1_1JFKenginep2">T</a>[li](iDimension,3).evaluate( q );  
00363     }
00364   }
00365  
00366   <span class="comment">//Debugln(JFKE, "\ngetLinkOrigins :" &lt;&lt; chain );</span>
00367   <span class="comment">//for ( Int i=0; i&lt;chain_size; i++ ) {</span>
00368   <span class="comment">//  Debugcln(JFKE, "link " &lt;&lt; i &lt;&lt; " location relative to first link: [" &lt;&lt; locs[i][0] &lt;&lt; ", " &lt;&lt; locs[i][1] &lt;&lt; ", " &lt;&lt; locs[i][2] &lt;&lt; "]");</span>
00369   <span class="comment">//}</span>
00370 
00371   <span class="keywordflow">return</span> locs;
00372 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Jul 29 15:56:36 2004 for OpenSim by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.6 </small></address>
</body>
</html>
