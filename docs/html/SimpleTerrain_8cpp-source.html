<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>OpenSim: physics/SimpleTerrain.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>physics/SimpleTerrain.cpp</h1><a href="SimpleTerrain_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/****************************************************************************</span>
00002 <span class="comment">  Copyright (C)1996 David Jung &lt;opensim@pobox.com&gt;</span>
00003 <span class="comment"></span>
00004 <span class="comment">  This program/file is free software; you can redistribute it and/or modify</span>
00005 <span class="comment">  it under the terms of the GNU General Public License as published by</span>
00006 <span class="comment">  the Free Software Foundation; either version 2 of the License, or</span>
00007 <span class="comment">  (at your option) any later version.</span>
00008 <span class="comment">  </span>
00009 <span class="comment">  This program is distributed in the hope that it will be useful,</span>
00010 <span class="comment">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00011 <span class="comment">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00012 <span class="comment">  GNU General Public License for more details. (http://www.gnu.org)</span>
00013 <span class="comment">  </span>
00014 <span class="comment">  You should have received a copy of the GNU General Public License</span>
00015 <span class="comment">  along with this program; if not, write to the Free Software</span>
00016 <span class="comment">  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
00017 <span class="comment">  </span>
00018 <span class="comment">  $Id: SimpleTerrain.cpp 1031 2004-02-11 20:46:36Z jungd $</span>
00019 <span class="comment">  $Revision: 1.2 $</span>
00020 <span class="comment">  $Date: 2004-02-11 15:46:36 -0500 (Wed, 11 Feb 2004) $</span>
00021 <span class="comment">  $Author: jungd $</span>
00022 <span class="comment"> </span>
00023 <span class="comment">****************************************************************************/</span>
00024 
00025 <span class="preprocessor">#include &lt;<a class="code" href="SimpleTerrain.html">physics/SimpleTerrain</a>&gt;</span>
00026 <span class="preprocessor">#include &lt;<a class="code" href="Material.html">physics/Material</a>&gt;</span>
00027 <span class="preprocessor">#include &lt;<a class="code" href="OBBCollisionModel.html">physics/OBBCollisionModel</a>&gt;</span>
00028 
00029 <span class="preprocessor">#include &lt;gfx/Tesselation&gt;</span>
00030 <span class="preprocessor">#include &lt;<a class="code" href="Color3.html">gfx/Color3</a>&gt;</span>
00031 <span class="preprocessor">#include &lt;<a class="code" href="Triangle3.html">gfx/Triangle3</a>&gt;</span>
00032 <span class="preprocessor">#include &lt;<a class="code" href="array.html">base/array</a>&gt;</span>
00033 
00034 <span class="keyword">using</span> <a class="code" href="classbase_1_1array.html">base::array</a>;
00035 
00036 <span class="keyword">using</span> <a class="code" href="classgfx_1_1Triangle3.html">gfx::Triangle3</a>;
00037 <span class="keyword">using</span> <a class="code" href="classgfx_1_1Color3.html">gfx::Color3</a>;
00038 <span class="keyword">using</span> gfx::Tesselation;
00039 
00040 <span class="keyword">using</span> <a class="code" href="classphysics_1_1SimpleTerrain.html">physics::SimpleTerrain</a>;
00041 <span class="keyword">using</span> <a class="code" href="classphysics_1_1MassProperties.html">physics::MassProperties</a>;
00042 <span class="keyword">using</span> <a class="code" href="classphysics_1_1BoundingBox.html">physics::BoundingBox</a>;
00043 <span class="keyword">using</span> <a class="code" href="classphysics_1_1BoundingSphere.html">physics::BoundingSphere</a>;
00044 <span class="keyword">using</span> <a class="code" href="classphysics_1_1CollisionModel.html">physics::CollisionModel</a>;
00045 <span class="keyword">using</span> <a class="code" href="classphysics_1_1OBBCollisionModel.html">physics::OBBCollisionModel</a>;
00046 
00047 
00048 SimpleTerrain::SimpleTerrain(HeightField&amp; heightfield) 
00049         : Terrain(heightfield), massPropertiesCached(false), tesselated(false),
00050                 collisionModelCached(false)
00051 {
00052 }
00053 
00054 SimpleTerrain::SimpleTerrain(<span class="keyword">const</span> SimpleTerrain&amp; t)
00055         : Terrain(t), massPropertiesCached(false), tesselated(false),
00056                 collisionModelCached(false)
00057 {
00058 }
00059 
00060 SimpleTerrain::~SimpleTerrain() 
00061 {
00062         <span class="keywordflow">if</span> (tesselated) <span class="keyword">delete</span> tesselation; 
00063         <span class="keywordflow">if</span> (collisionModelCached) <span class="keyword">delete</span> collisionModel;
00064 }
00065 
00066 
00067 <a class="code" href="namespacebase.html#a5">Real</a>&amp; SimpleTerrain::height(Real x, Real y) <span class="keywordflow">throw</span>(std::out_of_range)
00068 {
00069         <span class="keywordflow">return</span> heightfield.height(x,y);
00070 }
00071 
00072 <span class="keyword">const</span> <a class="code" href="namespacebase.html#a5">Real</a>&amp; SimpleTerrain::height(Real x, Real y) <span class="keyword">const</span> <span class="keywordflow">throw</span>(std::out_of_range)
00073 {
00074         <span class="keywordflow">return</span> heightfield.height(x,y);
00075 }
00076 
00077 
00078 
00079 BoundingBox SimpleTerrain::getBoundingBox()<span class="keyword"> const</span>
00080 <span class="keyword"></span>{
00081         <span class="keywordflow">return</span> BoundingBox();<span class="comment">//!!!</span>
00082 <span class="comment"></span>}
00083 
00084 <a class="code" href="classphysics_1_1BoundingSphere.html">BoundingSphere</a> SimpleTerrain::getBoundingSphere()<span class="keyword"> const</span>
00085 <span class="keyword"></span>{
00086         <span class="keywordflow">return</span> <a class="code" href="classphysics_1_1BoundingSphere.html">BoundingSphere</a>(); <span class="comment">//!!!</span>
00087 <span class="comment"></span>}
00088 
00089 
00090 <span class="keyword">const</span> <a class="code" href="classphysics_1_1MassProperties.html">MassProperties</a>&amp; SimpleTerrain::getMassProperties(<span class="keyword">const</span> Material&amp; material)<span class="keyword"> const</span>
00091 <span class="keyword"></span>{
00092   <span class="keywordflow">if</span> (massPropertiesCached &amp;&amp; (massProperties.density == material.density()))
00093     <span class="keywordflow">return</span> massProperties;
00094 <span class="comment"></span>
00095 <span class="comment">  //!!! should we just make a mass properties that is infinite mass?</span>
00096 <span class="comment"></span>  <span class="comment">// the c.o.m. is not at the origin anyway</span>
00097   <span class="comment">// (of cource, c.o.m. at origin and valid mass properties would be best)</span>
00098   
00099   <span class="comment">// ANS: No.  Don't use the terrain as a dynamic object in physics or</span>
00100   <span class="comment">//  it may cause instability.  Specifically make it a fixed object</span>
00101 
00102   <span class="comment">// construct mass property from Tesselatable </span>
00103   massProperties = <a class="code" href="classphysics_1_1MassProperties.html">MassProperties</a>(*<span class="keyword">this</span>, material);
00104   
00105   massPropertiesCached = <span class="keyword">true</span>;
00106   <span class="keywordflow">return</span> massProperties;
00107 }
00108 
00109 
00110 <span class="keyword">const</span> Tesselation&amp; SimpleTerrain::getTesselation(Int properties)<span class="keyword"> const</span>
00111 <span class="keyword"></span>{
00112   <span class="keywordflow">if</span> (tesselated) {
00113     <span class="keywordflow">if</span> (properties == this-&gt;properties)  <span class="comment">// same properties, used cached Tesselation</span>
00114       <span class="keywordflow">return</span> *tesselation; 
00115     <span class="keywordflow">else</span>
00116       <span class="keyword">delete</span> tesselation;  <span class="comment">// different properties, re-tesselate</span>
00117   }
00118   
00119   tesselation = <span class="keyword">new</span> Tesselation();
00120   this-&gt;properties = properties;
00121   
00122   HeightField&amp; hf(heightfield);
00123   <span class="comment"></span>
00124 <span class="comment">  //!!! texture coords. not yet implemented</span>
00125 <span class="comment">  //!!! sides and bottom not yet implemented</span>
00126 <span class="comment"></span>  
00127   <span class="comment">// First, build an array of vertices (one per height field sample)</span>
00128   array&lt;Point3&gt; vertices(hf.nx()*hf.ny());
00129   <a class="code" href="namespacebase.html#a1">SInt</a> vi=0;
00130   <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> yi=0; yi&lt;hf.ny(); yi++)
00131     <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> xi=0; xi&lt;hf.nx(); xi++) {
00132       vertices[vi] = <a class="code" href="namespacebase.html#a26">Point3</a>(xi*hf.dx(), hf.height(xi,yi),hf.ysize()-yi*hf.dy());
00133       vi++;
00134     }
00135   
00136   <span class="comment">// Now calulcate normals</span>
00137   <span class="comment">//  (inefficient! - compute the 8 triangles that share each vertex, and average</span>
00138   <span class="comment">//   their normals)</span>
00139   array&lt;Vector3&gt; normals(hf.nx()*hf.ny());
00140   array&lt;Triangle3&gt; tri(8);
00141 <span class="preprocessor">#define vAt(xxi,yyi) ( (((xxi) &lt; 0) || ((xxi) &gt;= (SInt)hf.nx()) || ((yyi) &lt; 0) || ((yyi) &gt;= (SInt)hf.ny()))?\</span>
00142 <span class="preprocessor">  Point3((xxi)*hf.dx(),0.0,hf.ysize()-(yyi)*hf.dy()):(vertices[(yyi)*hf.nx()+(xxi)]) )</span>
00143 <span class="preprocessor"></span>  
00144   <span class="keywordflow">if</span> (properties &amp; VertexNormals) {
00145     
00146     <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a1">SInt</a> yi=0; yi&lt;(<a class="code" href="namespacebase.html#a1">SInt</a>)hf.ny(); yi++)
00147       <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a1">SInt</a> xi=0; xi&lt;(<a class="code" href="namespacebase.html#a1">SInt</a>)hf.nx(); xi++) {
00148         tri[0].p1 = <a class="code" href="SimpleTerrain_8cpp.html#a0">vAt</a>(xi,yi); tri[0].p2 = <a class="code" href="SimpleTerrain_8cpp.html#a0">vAt</a>(xi+1,yi);   tri[0].p3 = <a class="code" href="SimpleTerrain_8cpp.html#a0">vAt</a>(xi+1,yi+1);
00149         tri[1].p1 = <a class="code" href="SimpleTerrain_8cpp.html#a0">vAt</a>(xi,yi); tri[1].p2 = <a class="code" href="SimpleTerrain_8cpp.html#a0">vAt</a>(xi+1,yi+1); tri[1].p3 = <a class="code" href="SimpleTerrain_8cpp.html#a0">vAt</a>(xi, yi+1);
00150         tri[2].p1 = <a class="code" href="SimpleTerrain_8cpp.html#a0">vAt</a>(xi,yi); tri[2].p2 = <a class="code" href="SimpleTerrain_8cpp.html#a0">vAt</a>(xi, yi+1);  tri[2].p3 = <a class="code" href="SimpleTerrain_8cpp.html#a0">vAt</a>(xi-1, yi+1);
00151         tri[3].p1 = <a class="code" href="SimpleTerrain_8cpp.html#a0">vAt</a>(xi,yi); tri[3].p2 = <a class="code" href="SimpleTerrain_8cpp.html#a0">vAt</a>(xi-1,yi+1); tri[3].p3 = <a class="code" href="SimpleTerrain_8cpp.html#a0">vAt</a>(xi-1,yi);
00152         tri[4].p1 = <a class="code" href="SimpleTerrain_8cpp.html#a0">vAt</a>(xi,yi); tri[4].p2 = <a class="code" href="SimpleTerrain_8cpp.html#a0">vAt</a>(xi-1,yi);   tri[4].p3 = <a class="code" href="SimpleTerrain_8cpp.html#a0">vAt</a>(xi-1,yi-1);
00153         tri[5].p1 = <a class="code" href="SimpleTerrain_8cpp.html#a0">vAt</a>(xi,yi); tri[5].p2 = <a class="code" href="SimpleTerrain_8cpp.html#a0">vAt</a>(xi-1,yi-1); tri[5].p3 = <a class="code" href="SimpleTerrain_8cpp.html#a0">vAt</a>(xi,yi-1);
00154         tri[6].p1 = <a class="code" href="SimpleTerrain_8cpp.html#a0">vAt</a>(xi,yi); tri[6].p2 = <a class="code" href="SimpleTerrain_8cpp.html#a0">vAt</a>(xi,yi-1);   tri[6].p3 = <a class="code" href="SimpleTerrain_8cpp.html#a0">vAt</a>(xi+1,yi-1);
00155         tri[7].p1 = <a class="code" href="SimpleTerrain_8cpp.html#a0">vAt</a>(xi,yi); tri[7].p2 = <a class="code" href="SimpleTerrain_8cpp.html#a0">vAt</a>(xi+1,yi-1); tri[7].p3 = <a class="code" href="SimpleTerrain_8cpp.html#a0">vAt</a>(xi+1,yi);
00156         
00157         <span class="comment">// average normals</span>
00158         Vector3 norm;
00159         <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> t=0; t&lt;8; t++) 
00160           norm += tri[t].normal();
00161         norm /= 8.0;
00162         
00163         normals[yi*hf.nx() + xi] = norm;
00164       }
00165   }
00166   
00167   array&lt;Point3&gt;  vertexArray( (hf.nx()-1)*(hf.ny()-1)*2*3 );
00168   array&lt;Vector3&gt; normalArray( (hf.nx()-1)*(hf.ny()-1)*2*3 );
00169   
00170   <span class="comment">// Build vertex arrays</span>
00171 <span class="preprocessor">#define nAt(xi,yi) normals[(yi)*hf.nx()+(xi)]</span>
00172 <span class="preprocessor"></span>  <a class="code" href="namespacebase.html#a1">SInt</a> index=0;
00173   <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a1">SInt</a> xi=1; xi&lt;(<a class="code" href="namespacebase.html#a1">SInt</a>)hf.nx(); xi++)
00174     <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a1">SInt</a> yi=1; yi&lt;(<a class="code" href="namespacebase.html#a1">SInt</a>)hf.ny(); yi++) {
00175       vertexArray[index+2]   = <a class="code" href="SimpleTerrain_8cpp.html#a0">vAt</a>(xi, yi);
00176       vertexArray[index+1] = <a class="code" href="SimpleTerrain_8cpp.html#a0">vAt</a>(xi-1,yi-1);
00177       vertexArray[index] = <a class="code" href="SimpleTerrain_8cpp.html#a0">vAt</a>(xi-1, yi);
00178       <span class="keywordflow">if</span> (properties &amp; VertexNormals) {
00179         normalArray[index+2]   = <a class="code" href="SimpleTerrain_8cpp.html#a1">nAt</a>(xi,yi);
00180         normalArray[index+1] = <a class="code" href="SimpleTerrain_8cpp.html#a1">nAt</a>(xi-1,yi-1);
00181         normalArray[index] = <a class="code" href="SimpleTerrain_8cpp.html#a1">nAt</a>(xi-1,yi);
00182       }
00183       index+=3;
00184       
00185       vertexArray[index+2]   = <a class="code" href="SimpleTerrain_8cpp.html#a0">vAt</a>(xi-1, yi-1);
00186       vertexArray[index+1] = <a class="code" href="SimpleTerrain_8cpp.html#a0">vAt</a>(xi,yi);
00187       vertexArray[index] = <a class="code" href="SimpleTerrain_8cpp.html#a0">vAt</a>(xi, yi-1);
00188       <span class="keywordflow">if</span> (properties &amp; VertexNormals) {
00189         normalArray[index+2]   = <a class="code" href="SimpleTerrain_8cpp.html#a1">nAt</a>(xi-1,yi-1);
00190         normalArray[index+1] = <a class="code" href="SimpleTerrain_8cpp.html#a1">nAt</a>(xi,yi);
00191         normalArray[index] = <a class="code" href="SimpleTerrain_8cpp.html#a1">nAt</a>(xi,yi-1);
00192       }
00193       index+=3;
00194     }
00195   
00196   TriangleArray&amp; terrainTris = *<span class="keyword">new</span> TriangleArray(&amp;vertexArray,0,
00197                                                   (properties &amp; VertexNormals)?&amp;normalArray:0,
00198                                                   0,0,<span class="keyword">false</span>);
00199   
00200   tesselation-&gt;insert(terrainTris);
00201   tesselated=<span class="keyword">true</span>;
00202 
00203   <span class="keywordflow">return</span> *tesselation;
00204 }
00205 
00206 
00207 osg::GeoSet&amp; SimpleTerrain::getGeoSet(Int properties=VertexNormals)<span class="keyword"> const</span>
00208 <span class="keyword"></span>{
00209   <span class="keywordflow">return</span> *<span class="keyword">new</span> osg::GeoSet(); <span class="comment">// implement!!!</span>
00210 }
00211 
00212 
00213 CollisionModel&amp; SimpleTerrain::getCollisionModel(CollisionModel::CollisionModelType modelType)<span class="keyword"> const</span>
00214 <span class="keyword"></span>{
00215         <span class="keywordflow">if</span> (collisionModelCached &amp;&amp; 
00216                         ((this-&gt;modelType==modelType) || (modelType==CollisionModel::AnyModel)))
00217                 <span class="keywordflow">return</span> *collisionModel;
00218         
00219         <span class="keywordflow">if</span> (   (modelType == CollisionModel::OBBModel) 
00220                         || (modelType == CollisionModel::AnyModel)) {
00221                 <span class="keywordflow">if</span> (collisionModelCached) <span class="keyword">delete</span> collisionModel;
00222                 collisionModel = <span class="keyword">new</span> OBBCollisionModel(*<span class="keyword">this</span>);
00223                 this-&gt;modelType=modelType;
00224                 collisionModelCached=<span class="keyword">true</span>;
00225                 <span class="keywordflow">return</span> *collisionModel;
00226         }
00227         <span class="keywordflow">else</span>
00228                 <span class="keywordflow">throw</span> std::invalid_argument(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"CollisionModelType not supported"</span>));
00229 }
00230 
00231  
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Jul 29 15:56:29 2004 for OpenSim by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.6 </small></address>
</body>
</html>
