<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>OpenSim: gfx/TrackballManipulator.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>gfx/TrackballManipulator.cpp</h1><a href="TrackballManipulator_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="preprocessor">#include &lt;<a class="code" href="TrackballManipulator.html">gfx/TrackballManipulator</a>&gt;</span>
00002 
00003 <span class="preprocessor">#include &lt;osg/Quat&gt;</span>
00004 <span class="preprocessor">#include &lt;osg/Notify&gt;</span>
00005 
00006 <span class="keyword">using</span> <span class="keyword">namespace </span>osg;
00007 <span class="keyword">using</span> <span class="keyword">namespace </span>osgGA;
00008 
00009 <span class="keyword">using</span> <a class="code" href="classgfx_1_1TrackballManipulator.html">gfx::TrackballManipulator</a>;
00010 
00011 
00012 TrackballManipulator::TrackballManipulator()
00013 {
00014     <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp3">_modelScale</a> = 0.01f;
00015     <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp4">_minimumZoomScale</a> = 0.05f;
00016     <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp5">_thrown</a> = <span class="keyword">false</span>;
00017 
00018     <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp8">_distance</a> = 1.0f;
00019 }
00020 
00021 
00022 TrackballManipulator::~TrackballManipulator()
00023 {
00024 }
00025 
00026 
00027 <span class="keywordtype">void</span> TrackballManipulator::setNode(osg::Node* node)
00028 {
00029     <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp2">_node</a> = node;
00030     <span class="keywordflow">if</span> (<a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp2">_node</a>.get())
00031     {
00032         <span class="keyword">const</span> osg::BoundingSphere&amp; boundingSphere=<a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp2">_node</a>-&gt;getBound();
00033         <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp3">_modelScale</a> = boundingSphere._radius;
00034     }
00035 }
00036 
00037 
00038 <span class="keyword">const</span> osg::Node* TrackballManipulator::getNode()<span class="keyword"> const</span>
00039 <span class="keyword"></span>{
00040     <span class="keywordflow">return</span> <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp2">_node</a>.get();
00041 }
00042 
00043 
00044 osg::Node* TrackballManipulator::getNode()
00045 {
00046     <span class="keywordflow">return</span> <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp2">_node</a>.get();
00047 }
00048 
00049 
00050                                  <span class="comment">/*ea*/</span>
00051 <span class="keywordtype">void</span> TrackballManipulator::home(<span class="keyword">const</span> GUIEventAdapter&amp; ,GUIActionAdapter&amp; us)
00052 {
00053     <span class="keywordflow">if</span>(<a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp2">_node</a>.get())
00054     {
00055 
00056         <span class="keyword">const</span> osg::BoundingSphere&amp; boundingSphere=<a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp2">_node</a>-&gt;getBound();
00057 
00058         <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatora16">computePosition</a>(osg::Vec3( 0.0,-3.5f * _modelScale,0.0f),
00059                         osg::Vec3(0,0,0),
00060                         osg::Vec3(0.0f,0.0f,1.0f));
00061 
00062         us.requestRedraw();
00063     }
00064 
00065 }
00066 
00067 
00068 <span class="keywordtype">void</span> TrackballManipulator::init(<span class="keyword">const</span> GUIEventAdapter&amp; ,GUIActionAdapter&amp; )
00069 {
00070     <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorb1">flushMouseEventStack</a>();
00071 }
00072 
00073 
00074 <span class="keywordtype">void</span> TrackballManipulator::getUsage(osg::ApplicationUsage&amp; usage)<span class="keyword"> const</span>
00075 <span class="keyword"></span>{
00076     usage.addKeyboardMouseBinding(<span class="stringliteral">"Trackball: Space"</span>,<span class="stringliteral">"Reset the viewing position to home"</span>);
00077     usage.addKeyboardMouseBinding(<span class="stringliteral">"Trackball: +"</span>,<span class="stringliteral">"When in stereo, increase the fusion distance"</span>);
00078     usage.addKeyboardMouseBinding(<span class="stringliteral">"Trackball: -"</span>,<span class="stringliteral">"When in stereo, reduse the fusion distance"</span>);
00079 }
00080 
00081 <span class="keywordtype">bool</span> TrackballManipulator::handle(<span class="keyword">const</span> GUIEventAdapter&amp; ea,GUIActionAdapter&amp; us)
00082 {
00083     <span class="keywordflow">switch</span>(ea.getEventType())
00084     {
00085         <span class="keywordflow">case</span>(GUIEventAdapter::PUSH):
00086         {
00087             <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorb1">flushMouseEventStack</a>();
00088             <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorb2">addMouseEvent</a>(ea);
00089             <span class="keywordflow">if</span> (<a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorb3">calcMovement</a>()) us.requestRedraw();
00090             us.requestContinuousUpdate(<span class="keyword">false</span>);
00091             <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp5">_thrown</a> = <span class="keyword">false</span>;
00092             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00093         }
00094 
00095         <span class="keywordflow">case</span>(GUIEventAdapter::RELEASE):
00096         {
00097             <span class="keywordflow">if</span> (ea.getButtonMask()==0)
00098             {
00099 
00100                 <span class="keywordflow">if</span> (<a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorb6">isMouseMoving</a>())
00101                 {
00102                     <span class="keywordflow">if</span> (<a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorb3">calcMovement</a>())
00103                     {
00104                         us.requestRedraw();
00105                         us.requestContinuousUpdate(<span class="keyword">true</span>);
00106                         <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp5">_thrown</a> = <span class="keyword">true</span>;
00107                     }
00108                 }
00109                 <span class="keywordflow">else</span>
00110                 {
00111                     <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorb1">flushMouseEventStack</a>();
00112                     <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorb2">addMouseEvent</a>(ea);
00113                     <span class="keywordflow">if</span> (<a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorb3">calcMovement</a>()) us.requestRedraw();
00114                     us.requestContinuousUpdate(<span class="keyword">false</span>);
00115                     <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp5">_thrown</a> = <span class="keyword">false</span>;
00116                 }
00117 
00118             }
00119             <span class="keywordflow">else</span>
00120             {
00121                 <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorb1">flushMouseEventStack</a>();
00122                 <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorb2">addMouseEvent</a>(ea);
00123                 <span class="keywordflow">if</span> (<a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorb3">calcMovement</a>()) us.requestRedraw();
00124                 us.requestContinuousUpdate(<span class="keyword">false</span>);
00125                 <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp5">_thrown</a> = <span class="keyword">false</span>;
00126             }
00127             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00128         }
00129 
00130         <span class="keywordflow">case</span>(GUIEventAdapter::DRAG):
00131         {
00132             <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorb2">addMouseEvent</a>(ea);
00133             <span class="keywordflow">if</span> (<a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorb3">calcMovement</a>()) us.requestRedraw();
00134             us.requestContinuousUpdate(<span class="keyword">false</span>);
00135             <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp5">_thrown</a> = <span class="keyword">false</span>;
00136             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00137         }
00138 
00139         <span class="keywordflow">case</span>(GUIEventAdapter::MOVE):
00140         {
00141             <span class="keywordflow">return</span> <span class="keyword">false</span>;
00142         }
00143 
00144         <span class="keywordflow">case</span>(GUIEventAdapter::KEYDOWN):
00145             <span class="keywordflow">if</span> (ea.getKey()==<span class="charliteral">' '</span>)
00146             {
00147                 <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorb1">flushMouseEventStack</a>();
00148                 <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp5">_thrown</a> = <span class="keyword">false</span>;
00149                 <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatora11">home</a>(ea,us);
00150                 us.requestRedraw();
00151                 us.requestContinuousUpdate(<span class="keyword">false</span>);
00152                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
00153             }
00154             <span class="keywordflow">return</span> <span class="keyword">false</span>;
00155         <span class="keywordflow">case</span>(GUIEventAdapter::FRAME):
00156             <span class="keywordflow">if</span> (<a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp5">_thrown</a>)
00157             {
00158                 <span class="keywordflow">if</span> (<a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorb3">calcMovement</a>()) us.requestRedraw();
00159                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
00160             }
00161             <span class="keywordflow">return</span> <span class="keyword">false</span>;
00162         <span class="keywordflow">default</span>:
00163             <span class="keywordflow">return</span> <span class="keyword">false</span>;
00164     }
00165 }
00166 
00167 
00168 <span class="keywordtype">bool</span> TrackballManipulator::isMouseMoving()
00169 {
00170     <span class="keywordflow">if</span> (<a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp1">_ga_t0</a>.get()==NULL || <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp0">_ga_t1</a>.get()==NULL) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00171 
00172     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">float</span> velocity = 0.1f;
00173 
00174     <span class="keywordtype">float</span> dx = <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp1">_ga_t0</a>-&gt;getXnormalized()-<a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp0">_ga_t1</a>-&gt;getXnormalized();
00175     <span class="keywordtype">float</span> dy = <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp1">_ga_t0</a>-&gt;getYnormalized()-<a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp0">_ga_t1</a>-&gt;getYnormalized();
00176     <span class="keywordtype">float</span> len = sqrtf(dx*dx+dy*dy);
00177     <span class="keywordtype">float</span> dt = <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp1">_ga_t0</a>-&gt;time()-<a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp0">_ga_t1</a>-&gt;time();
00178 
00179     <span class="keywordflow">return</span> (len&gt;dt*velocity);
00180 }
00181 
00182 
00183 <span class="keywordtype">void</span> TrackballManipulator::flushMouseEventStack()
00184 {
00185     <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp0">_ga_t1</a> = NULL;
00186     <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp1">_ga_t0</a> = NULL;
00187 }
00188 
00189 
00190 <span class="keywordtype">void</span> TrackballManipulator::addMouseEvent(<span class="keyword">const</span> GUIEventAdapter&amp; ea)
00191 {
00192     <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp0">_ga_t1</a> = <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp1">_ga_t0</a>;
00193     _ga_t0 = &amp;ea;
00194 }
00195 
00196 <span class="keywordtype">void</span> TrackballManipulator::setByMatrix(<span class="keyword">const</span> osg::Matrixd&amp; matrix)
00197 {
00198     <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp6">_center</a> = osg::Vec3(0.0f,0.0f,-_distance)*<a class="code" href="SVD_8cpp.html#a12">matrix</a>;
00199     <a class="code" href="SVD_8cpp.html#a12">matrix</a>.get(_rotation);
00200 }
00201 
00202 osg::Matrixd TrackballManipulator::getMatrix()<span class="keyword"> const</span>
00203 <span class="keyword"></span>{
00204     <span class="keywordflow">return</span> osg::Matrixd::translate(0.0,0.0,_distance)*<a class="code" href="Matrix3_8cpp.html#a2">osg::Matrixd::rotate</a>(_rotation)*osg::Matrixd::translate(_center);
00205 }
00206 
00207 osg::Matrixd TrackballManipulator::getInverseMatrix()<span class="keyword"> const</span>
00208 <span class="keyword"></span>{
00209     <span class="keywordflow">return</span> osg::Matrixd::translate(-_center)*<a class="code" href="Matrix3_8cpp.html#a2">osg::Matrixd::rotate</a>(<a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp7">_rotation</a>.inverse())*osg::Matrixd::translate(0.0,0.0,-_distance);
00210 }
00211 
00212 <span class="keywordtype">void</span> TrackballManipulator::computePosition(<span class="keyword">const</span> osg::Vec3&amp; eye,<span class="keyword">const</span> osg::Vec3&amp; center,<span class="keyword">const</span> osg::Vec3&amp; up)
00213 { 
00214     osg::Vec3 e(eye);
00215     <span class="keywordflow">if</span> (e.z() &lt; 0) e.z() = 0; <span class="comment">// keep eye above ground</span>
00216   
00217     osg::Vec3 lv(center-e);
00218 
00219     osg::Vec3 <a class="code" href="Makefile_8in.html#a5">f</a>(lv);
00220     <a class="code" href="Makefile_8in.html#a5">f</a>.normalize();
00221     osg::Vec3 s(f^up);
00222     s.normalize();
00223     osg::Vec3 u(s^f);
00224     u.normalize();
00225     
00226     osg::Matrix rotation_matrix(s[0],     u[0],     -f[0],     0.0f,
00227                                 s[1],     u[1],     -f[1],     0.0f,
00228                                 s[2],     u[2],     -f[2],     0.0f,
00229                                 0.0f,     0.0f,     0.0f,      1.0f);
00230                    
00231     <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp6">_center</a> = center;
00232     <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp8">_distance</a> = lv.length();
00233     rotation_matrix.get(_rotation);
00234     <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp7">_rotation</a> = <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp7">_rotation</a>.inverse();
00235 }
00236 
00237 
00238 <span class="keywordtype">bool</span> TrackballManipulator::calcMovement()
00239 {
00240 
00241     <span class="comment">// return if less then two events have been added.</span>
00242     <span class="keywordflow">if</span> (<a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp1">_ga_t0</a>.get()==NULL || <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp0">_ga_t1</a>.get()==NULL) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00243 
00244     <span class="keywordtype">float</span> dx = <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp1">_ga_t0</a>-&gt;getXnormalized()-<a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp0">_ga_t1</a>-&gt;getXnormalized();
00245     <span class="keywordtype">float</span> dy = <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp1">_ga_t0</a>-&gt;getYnormalized()-<a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp0">_ga_t1</a>-&gt;getYnormalized();
00246 
00247 
00248     <span class="comment">// return if there is no movement.</span>
00249     <span class="keywordflow">if</span> (dx==0 &amp;&amp; dy==0) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00250 
00251     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> buttonMask = <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp0">_ga_t1</a>-&gt;getButtonMask();
00252     <span class="keywordflow">if</span> (buttonMask==GUIEventAdapter::LEFT_MOUSE_BUTTON)
00253     {
00254 
00255         <span class="comment">// rotate camera.</span>
00256 
00257         osg::Vec3 axis;
00258         <span class="keywordtype">float</span> angle;
00259 
00260         <span class="keywordtype">float</span> px0 = <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp1">_ga_t0</a>-&gt;getXnormalized();
00261         <span class="keywordtype">float</span> py0 = <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp1">_ga_t0</a>-&gt;getYnormalized();
00262         
00263         <span class="keywordtype">float</span> px1 = <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp0">_ga_t1</a>-&gt;getXnormalized();
00264         <span class="keywordtype">float</span> py1 = <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp0">_ga_t1</a>-&gt;getYnormalized();
00265         
00266 
00267         <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorb4">trackball</a>(axis,angle,px1,py1,px0,py0);
00268 
00269         osg::Quat new_rotate;
00270         new_rotate.makeRotate(angle,axis);
00271         
00272         <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp7">_rotation</a> = <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp7">_rotation</a>*new_rotate;
00273 
00274         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00275 
00276     }
00277     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (buttonMask==GUIEventAdapter::MIDDLE_MOUSE_BUTTON ||
00278         buttonMask==(GUIEventAdapter::LEFT_MOUSE_BUTTON|GUIEventAdapter::RIGHT_MOUSE_BUTTON))
00279     {
00280 
00281         <span class="comment">// pan model.</span>
00282 
00283         <span class="keywordtype">float</span> scale = -0.5f*<a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp8">_distance</a>;
00284 
00285         osg::Matrix rotation_matrix;
00286         rotation_matrix.set(_rotation);
00287 
00288         osg::Vec3 dv(dx*scale,dy*scale,0.0f);
00289 
00290         <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp6">_center</a> += dv*rotation_matrix;
00291         
00292         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00293 
00294     }
00295     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (buttonMask==GUIEventAdapter::RIGHT_MOUSE_BUTTON)
00296     {
00297 
00298         <span class="comment">// zoom model.</span>
00299 
00300         <span class="keywordtype">float</span> fd = <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp8">_distance</a>;
00301         <span class="keywordtype">float</span> scale = 1.0f+dy;
00302         <span class="keywordflow">if</span> (fd*scale&gt;<a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp3">_modelScale</a>*<a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp4">_minimumZoomScale</a>)
00303         {
00304 
00305             _distance *= scale;
00306 
00307         }
00308         <span class="keywordflow">else</span>
00309         {
00310 
00311             <span class="comment">// notify(DEBUG_INFO) &lt;&lt; "Pushing forward"&lt;&lt;std::endl;</span>
00312             <span class="comment">// push the camera forward.</span>
00313             <span class="keywordtype">float</span> scale = -fd;
00314 
00315             osg::Matrix rotation_matrix(_rotation);
00316 
00317             osg::Vec3 dv = (osg::Vec3(0.0f,0.0f,-1.0f)*rotation_matrix)*(dy*scale);
00318 
00319             <a class="code" href="classgfx_1_1TrackballManipulator.html#gfx_1_1TrackballManipulatorp6">_center</a> += dv;
00320 
00321         }
00322 
00323         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00324 
00325     }
00326 
00327     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00328 }
00329 
00330 
00331 <span class="comment">/*</span>
00332 <span class="comment"> * This size should really be based on the distance from the center of</span>
00333 <span class="comment"> * rotation to the point on the object underneath the mouse.  That</span>
00334 <span class="comment"> * point would then track the mouse as closely as possible.  This is a</span>
00335 <span class="comment"> * simple example, though, so that is left as an Exercise for the</span>
00336 <span class="comment"> * Programmer.</span>
00337 <span class="comment"> */</span>
<a name="l00338"></a><a class="code" href="TrackballManipulator_8cpp.html#a0">00338</a> <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="TrackballManipulator_8cpp.html#a0">TRACKBALLSIZE</a> = 0.8f;
00339 
00340 <span class="comment">/*</span>
00341 <span class="comment"> * Ok, simulate a track-ball.  Project the points onto the virtual</span>
00342 <span class="comment"> * trackball, then figure out the axis of rotation, which is the cross</span>
00343 <span class="comment"> * product of P1 P2 and O P1 (O is the center of the ball, 0,0,0)</span>
00344 <span class="comment"> * Note:  This is a deformed trackball-- is a trackball in the center,</span>
00345 <span class="comment"> * but is deformed into a hyperbolic sheet of rotation away from the</span>
00346 <span class="comment"> * center.  This particular function was chosen after trying out</span>
00347 <span class="comment"> * several variations.</span>
00348 <span class="comment"> *</span>
00349 <span class="comment"> * It is assumed that the arguments to this routine are in the range</span>
00350 <span class="comment"> * (-1.0 ... 1.0)</span>
00351 <span class="comment"> */</span>
00352 <span class="keywordtype">void</span> TrackballManipulator::trackball(osg::Vec3&amp; axis,<span class="keywordtype">float</span>&amp; angle, <span class="keywordtype">float</span> p1x, <span class="keywordtype">float</span> p1y, <span class="keywordtype">float</span> p2x, <span class="keywordtype">float</span> p2y)
00353 {
00354     <span class="comment">/*</span>
00355 <span class="comment">     * First, figure out z-coordinates for projection of P1 and P2 to</span>
00356 <span class="comment">     * deformed sphere</span>
00357 <span class="comment">     */</span>
00358 
00359     osg::Matrix rotation_matrix(_rotation);
00360 
00361 
00362     osg::Vec3 uv = osg::Vec3(0.0<a class="code" href="Makefile_8in.html#a5">f</a>,1.0<a class="code" href="Makefile_8in.html#a5">f</a>,0.0<a class="code" href="Makefile_8in.html#a5">f</a>)*rotation_matrix;
00363     osg::Vec3 sv = osg::Vec3(1.0<a class="code" href="Makefile_8in.html#a5">f</a>,0.0<a class="code" href="Makefile_8in.html#a5">f</a>,0.0<a class="code" href="Makefile_8in.html#a5">f</a>)*rotation_matrix;
00364     osg::Vec3 lv = osg::Vec3(0.0<a class="code" href="Makefile_8in.html#a5">f</a>,0.0<a class="code" href="Makefile_8in.html#a5">f</a>,-1.0<a class="code" href="Makefile_8in.html#a5">f</a>)*rotation_matrix;
00365 
00366     osg::Vec3 p1 = sv*p1x+uv*p1y-lv*tb_project_to_sphere(<a class="code" href="TrackballManipulator_8cpp.html#a0">TRACKBALLSIZE</a>,p1x,p1y);
00367     osg::Vec3 p2 = sv*p2x+uv*p2y-lv*tb_project_to_sphere(<a class="code" href="TrackballManipulator_8cpp.html#a0">TRACKBALLSIZE</a>,p2x,p2y);
00368 
00369     <span class="comment">/*</span>
00370 <span class="comment">     *  Now, we want the cross product of P1 and P2</span>
00371 <span class="comment">     */</span>
00372 
00373 <span class="comment">// Robert,</span>
00374 <span class="comment">//</span>
00375 <span class="comment">// This was the quick 'n' dirty  fix to get the trackball doing the right </span>
00376 <span class="comment">// thing after fixing the Quat rotations to be right-handed.  You may want</span>
00377 <span class="comment">// to do something more elegant.</span>
00378 <span class="comment">//   axis = p1^p2;</span>
00379 axis = p2^p1;
00380     axis.normalize();
00381 
00382     <span class="comment">/*</span>
00383 <span class="comment">     *  Figure out how much to rotate around that axis.</span>
00384 <span class="comment">     */</span>
00385     <span class="keywordtype">float</span> t = (p2-p1).length() / (2.0*<a class="code" href="TrackballManipulator_8cpp.html#a0">TRACKBALLSIZE</a>);
00386 
00387     <span class="comment">/*</span>
00388 <span class="comment">     * Avoid problems with out-of-control values...</span>
00389 <span class="comment">     */</span>
00390     <span class="keywordflow">if</span> (t &gt; 1.0) t = 1.0;
00391     <span class="keywordflow">if</span> (t &lt; -1.0) t = -1.0;
00392     angle = inRadians(asin(t));
00393 
00394 }
00395 
00396 
00397 <span class="comment">/*</span>
00398 <span class="comment"> * Project an x,y pair onto a sphere of radius r OR a hyperbolic sheet</span>
00399 <span class="comment"> * if we are away from the center of the sphere.</span>
00400 <span class="comment"> */</span>
00401 <span class="keywordtype">float</span> TrackballManipulator::tb_project_to_sphere(<span class="keywordtype">float</span> r, <span class="keywordtype">float</span> x, <span class="keywordtype">float</span> y)
00402 {
00403     <span class="keywordtype">float</span> d, t, z;
00404 
00405     d = sqrt(x*x + y*y);
00406                                  <span class="comment">/* Inside sphere */</span>
00407     <span class="keywordflow">if</span> (d &lt; r * 0.70710678118654752440)
00408     {
00409         z = sqrt(r*r - d*d);
00410     }                            <span class="comment">/* On hyperbola */</span>
00411     <span class="keywordflow">else</span>
00412     {
00413         t = r / 1.41421356237309504880;
00414         z = t*t / d;
00415     }
00416     <span class="keywordflow">return</span> z;
00417 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Jul 29 15:56:19 2004 for OpenSim by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.6 </small></address>
</body>
</html>
