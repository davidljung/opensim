<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>/home/jungd/unix/dev/OpenSim/opensim/robot/sim/SimulatedSerialManipulator.cpp.bak Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>/home/jungd/unix/dev/OpenSim/opensim/robot/sim/SimulatedSerialManipulator.cpp.bak</h1><a href="SimulatedSerialManipulator_8cpp_8bak.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/****************************************************************************</font>
00002 <font class="comment">  Copyright (C)2002 David Jung &lt;djung@pobox.com&gt;</font>
00003 <font class="comment"></font>
00004 <font class="comment">  This program/file is free software; you can redistribute it and/or modify</font>
00005 <font class="comment">  it under the terms of the GNU General Public License as published by</font>
00006 <font class="comment">  the Free Software Foundation; either version 2 of the License, or</font>
00007 <font class="comment">  (at your option) any later version.</font>
00008 <font class="comment">  </font>
00009 <font class="comment">  This program is distributed in the hope that it will be useful,</font>
00010 <font class="comment">  but WITHOUT ANY WARRANTY; without even the implied warranty of</font>
00011 <font class="comment">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</font>
00012 <font class="comment">  GNU General Public License for more details. (http://www.gnu.org)</font>
00013 <font class="comment">  </font>
00014 <font class="comment">  You should have received a copy of the GNU General Public License</font>
00015 <font class="comment">  along with this program; if not, write to the Free Software</font>
00016 <font class="comment">  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</font>
00017 <font class="comment">  </font>
00018 <font class="comment">  $Id: SimulatedSerialManipulator.cpp,v 1.2 2002/08/08 14:44:56 jungd Exp $</font>
00019 <font class="comment">  $Revision: 1.2 $</font>
00020 <font class="comment">  $Date: 2002/08/08 14:44:56 $</font>
00021 <font class="comment">  $Author: jungd $</font>
00022 <font class="comment"> </font>
00023 <font class="comment">****************************************************************************/</font>
00024 
00025 <font class="preprocessor">#include &lt;<a class="code" href="SimulatedSerialManipulator.html">robot/sim/SimulatedSerialManipulator</a>&gt;</font>
00026 
00027 <font class="preprocessor">#include &lt;<a class="code" href="Vector3.html">base/Vector3</a>&gt;</font>
00028 <font class="preprocessor">#include &lt;<a class="code" href="Color3.html">gfx/Color3</a>&gt;</font>
00029 <font class="preprocessor">#include &lt;<a class="code" href="Transform.html">gfx/Transform</a>&gt;</font>
00030 <font class="preprocessor">#include &lt;<a class="code" href="Material.html">physics/Material</a>&gt;</font>
00031 <font class="preprocessor">#include &lt;<a class="code" href="Box.html">physics/Box</a>&gt;</font>
00032 <font class="preprocessor">#include &lt;<a class="code" href="Solid.html">physics/Solid</a>&gt;</font>
00033 
00035 <font class="preprocessor">#include &lt;<a class="code" href="Sphere.html">physics/Sphere</a>&gt;</font>
00036 <font class="keyword">using</font> <a class="code" href="classphysics_1_1Sphere.html">physics::Sphere</a>;
00037 
00038 <font class="keyword">using</font> <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html">robot::sim::SimulatedSerialManipulator</a>;
00039 
00040 <font class="keyword">using</font> <a class="code" href="classgfx_1_1Transform.html">gfx::Transform</a>;
00041 <font class="keyword">using</font> gfx::operator*;
00042 <font class="keyword">using</font> <a class="code" href="classphysics_1_1Box.html">physics::Box</a>;
00043 <font class="keyword">using</font> <a class="code" href="classphysics_1_1Solid.html">physics::Solid</a>;
00044 
00045 <font class="comment">//extern "C" {</font>
00046 <font class="preprocessor">#include &lt;ode/ode.h&gt;</font>
00047 <font class="preprocessor">#include &lt;ode/rotation.h&gt;</font>
00048 <font class="comment">//}</font>
00049 
00050 
00051 
00052 SimulatedSerialManipulator::SimulatedSerialManipulator(<a class="code" href="namespacebase.html#a4">String</a> name, Parameters p)
00053   : SerialManipulator(name), parameters(p)
00054 {
00055 }
00056 
00057 
00058 <font class="keywordtype">void</font> SimulatedSerialManipulator::construct(ref&lt;physics::SolidSystem&gt; solidSystem, <font class="keyword">const</font> Parameters&amp; params)
00059 {
00060 
00062   
00063   <font class="comment">// First, for each link, construct the homogeneous transform matrix that</font>
00064   <font class="comment">//  transforms a point in the base frame to the link frame</font>
00065 
00066   <font class="comment">// !!! don't really need to keep these - do we?</font>
00067   array&lt;Matrix4&gt; T(params.size()); <font class="comment">// T[i] - transforms from the base frame (0) to link frame i </font>
00068   array&lt;Matrix4&gt; A(params.size()); <font class="comment">// A[i] - transforms from frame i into frame i-1</font>
00069 
00070   Matrix4 Tn; <font class="comment">// accumulate the transformations for each joint </font>
00071   Tn.setIdentity();
00072   <font class="keywordflow">for</font> (<a class="code" href="namespacebase.html#a2">Int</a> j=0; j&lt;params.size(); j++) { <font class="comment">// for each joint</font>
00073     <font class="keyword">const</font> JointParameters&amp; jp(params[j]);
00074 
00075     <font class="comment">// Compute the transformation that transforms the coord. frame of</font>
00076     <font class="comment">//  joint j (link j) into the frame of joint j-1</font>
00077     <font class="comment">// (see a ref on Denavit-Hartenberg parameters - e.g. "Robot Manipulators" by Richard P. Paul.)</font>
00078     Matrix4 Aj; 
00079     <a class="code" href="namespacebase.html#a5">Real</a> sinAlpha = ::sin(jp.alpha);
00080     <a class="code" href="namespacebase.html#a5">Real</a> cosAlpha = ::cos(jp.alpha);
00081     <a class="code" href="namespacebase.html#a5">Real</a> sinTheta = ::sin(jp.theta);
00082     <a class="code" href="namespacebase.html#a5">Real</a> cosTheta = ::cos(jp.theta);
00084     <font class="keywordflow">if</font> (j==0) {
00085       <font class="comment">//sinTheta = ::sin(degToRad(90));</font>
00086       <font class="comment">//cosTheta = ::cos(degToRad(90));</font>
00087       sinTheta = ::sin(theta);
00088       cosTheta = ::cos(theta);
00089     }
00090     <font class="keywordflow">else</font> <font class="keywordflow">if</font> (j==2) {
00091       <font class="comment">//sinTheta = ::sin(degToRad(90));</font>
00092       <font class="comment">//cosTheta = ::cos(degToRad(90));</font>
00093       sinTheta = ::sin(-theta/1.5);
00094       cosTheta = ::cos(-theta/1.5);
00095       <font class="comment">//sinTheta = ::sin(theta);</font>
00096       <font class="comment">//cosTheta = ::cos(theta);</font>
00097     }
00098     Aj(1,1) = cosTheta; Aj(1,2) = -sinTheta*cosAlpha; Aj(1,3) = sinTheta*sinAlpha;  Aj(1,4) = jp.a*cosTheta; 
00099     Aj(2,1) = sinTheta; Aj(2,2) = cosTheta*cosAlpha;  Aj(2,3) = -cosTheta*sinAlpha; Aj(2,4) = jp.a*sinTheta;
00100     Aj(3,1) = 0;        Aj(3,2) = sinAlpha;           Aj(3,3) = cosAlpha;           Aj(3,4) = jp.d;
00101     Aj(4,1) = 0;        Aj(4,2) = 0;                  Aj(4,3) = 0;                  Aj(4,4) = 1;
00102 
00103     A[j] = Aj; 
00104     Tn *= A[j];
00105     T[j] = Tn;
00106   
00107 
00108 
00109     <font class="comment">// Create a Solid for each link, positioned correctly and connect them with joints</font>
00110     <font class="comment">//  This is tricky, because the origin of a Solid is its center of mass, but the origin</font>
00111     <font class="comment">//  of a link i is at the end that connects to link i+1.  In addition, we want to</font>
00112     <font class="comment">//  orient the Solid with respect to the link coord. frame, so that the solids form a</font>
00113     <font class="comment">//  continous chain even in the presence of a non-zero offset DH-parameter d.</font>
00114 
00115 
00116     <font class="comment">// The Solid length is just the translation component of the transform from</font>
00117     <font class="comment">//  link j to link j-1 </font>
00118     <a class="code" href="namespacebase.html#a5">Real</a> l = A[j].column(4).toVector3().length(); <font class="comment">// distance between origins of link j &amp; j-1</font>
00119 
00120 
00121     <font class="comment">// create a 3D Solid box to represent link j</font>
00122     <a class="code" href="namespacebase.html#a5">Real</a> xl=l;
00123     <font class="keywordflow">if</font> (<a class="code" href="namespacebase.html#a65">base::equals</a>(l,0)) xl=0.01; <font class="comment">// some links are zero length so make them very small instead</font>
00124     <a class="code" href="namespacebase.html#a5">Real</a> yz = <a class="code" href="namespacebase.html#a81">base::minimum</a>(0.05,xl*0.1); <font class="comment">// make y&amp;z-dims smaller than length (x-dim)</font>
00125     ref&lt;Box&gt; box(<a class="code" href="MemoryTracer.html#a0">NewObj</a> Box(xl,yz,yz));
00126 
00127     <font class="comment">// Material for Solids</font>
00128     ref&lt;physics::Material&gt; material(<a class="code" href="MemoryTracer.html#a0">NewObj</a> <a class="code" href="classphysics_1_1Material.html">physics::Material</a>());
00129     <font class="keywordflow">switch</font> (j) {
00130     <font class="keywordflow">case</font> 0: material-&gt;baseColor() = <a class="code" href="classgfx_1_1Color3.html">gfx::Color3</a>(1,0,0); <font class="keywordflow">break</font>;
00131     <font class="keywordflow">case</font> 1: material-&gt;baseColor() = <a class="code" href="classgfx_1_1Color3.html">gfx::Color3</a>(0,1,0); <font class="keywordflow">break</font>;
00132     <font class="keywordflow">case</font> 2: material-&gt;baseColor() = <a class="code" href="classgfx_1_1Color3.html">gfx::Color3</a>(0,0,1); <font class="keywordflow">break</font>;
00133     <font class="keywordflow">case</font> 3: material-&gt;baseColor() = <a class="code" href="classgfx_1_1Color3.html">gfx::Color3</a>(1,1,0); <font class="keywordflow">break</font>;
00134     <font class="keywordflow">case</font> 4: material-&gt;baseColor() = <a class="code" href="classgfx_1_1Color3.html">gfx::Color3</a>(1,0,1); <font class="keywordflow">break</font>;
00135     <font class="keywordflow">case</font> 5: material-&gt;baseColor() = <a class="code" href="classgfx_1_1Color3.html">gfx::Color3</a>(0,1,1); <font class="keywordflow">break</font>;
00136     <font class="keywordflow">default</font>:
00137       material-&gt;baseColor() = <a class="code" href="classgfx_1_1Color3.html">gfx::Color3</a>(1,0.4,1);
00138     }
00139     
00140     <font class="comment">// add it so the system</font>
00141     ref&lt;Solid&gt; link = solidSystem-&gt;createSolid(box,material);
00142     solidSystem-&gt;addSolid(link);
00143 
00144     <font class="comment">// The transformation from the current link j to the base (0) is T[j]</font>
00145     <font class="comment">//  To compute the transformation for the Solid, STj, that accounts for</font>
00146     <font class="comment">//  the difference in origins, we first separate the rotational and</font>
00147     <font class="comment">//  translational components of T[j]</font>
00148     Matrix4 TjR(T[j]); TjR.setColumn(4,Vector4(0,0,0,1)); <font class="comment">// zero out translation</font>
00149     Matrix4 TjT; TjT.setIdentity(); TjT.setColumn(4,T[j].column(4)); <font class="comment">// set rot to identity</font>
00150 
00151     <font class="comment">// construct translation transformations that translate back 1/2 the Solid length</font>
00152     <font class="comment">//  along the long axis (x) - tBack</font>
00153     Matrix4 tBack; tBack.setIdentity(); tBack.setColumn(4,Vector4(-l/2,0,0,1));
00154     
00155     <font class="comment">// We also want to rotate the Solid so that the ends meet even if there</font>
00156     <font class="comment">//  is a displacement due to DH-parameter d</font>
00157     <font class="comment">//  (this will be a rotation about the y-axis of link j-1 to make the Solid's x-axis</font>
00158     <font class="comment">//   point to the previous link's origin rather than being parallel with</font>
00159     <font class="comment">//   the link x-axis.  To achieve this we bring link j's y&amp;x-axes parallel to</font>
00160     <font class="comment">//   those of link j-1 by reversing the skew DH-parameter alpha, then rotate about the y-axis,</font>
00161     <font class="comment">//   and then redo the skew)</font>
00162     <a class="code" href="namespacebase.html#a5">Real</a> incline = ::asin(jp.d/l);
00163     Matrix4 rotYj    = Quat4(Vector3(0,1,0),-incline);
00164     Matrix4 rotXj    = Quat4(Vector3(1,0,0), jp.alpha);
00165     Matrix4 rotXjInv = Quat4(Vector3(1,0,0),-jp.alpha);
00166     Matrix4 rotYjm1 = rotXjInv * rotYj * rotXj;
00167 
00168     <font class="comment">// Now the combined rotation component is:</font>
00169     Matrix4 STjR(TjR * rotYjm1 * tBack);
00170     
00171     <font class="comment">// The translation component is the original T[j] translation TjT and</font>
00172     <font class="comment">//  a translation tBack to bring the end of the Solid in coincidence with</font>
00173     <font class="comment">//  the link origin</font>
00174     Matrix4 STj(TjT * STjR);
00175 
00176 
00177     <font class="comment">// Now set the Solid's transform to STj</font>
00178     <font class="comment">//  (via conversion to a translation and Quat orientation)</font>
00179     link-&gt;setPosition( STj.column(4).toVector3() ); <font class="comment">// translation component</font>
00180     Quat4 rot; rot.setRotation(STj);
00181     link-&gt;setOrientation( rot ); <font class="comment">// rotation component</font>
00182 
00184     <font class="comment">/*</font>
00185 <font class="comment">    ref&lt;Box&gt; box2(NewObj Box(l,yz,yz));</font>
00186 <font class="comment">    ref&lt;physics::Material&gt; material2(NewObj physics::Material(*material));</font>
00187 <font class="comment">    material2-&gt;baseColor() *= 0.5;</font>
00188 <font class="comment">    ref&lt;Solid&gt; origin = solidSystem-&gt;createSolid(box2,material2);</font>
00189 <font class="comment">    solidSystem-&gt;addSolid(origin);</font>
00190 <font class="comment">    origin-&gt;setPosition( T[j].column(4).toVector3() );</font>
00191 <font class="comment">    Quat4 rot2; rot2.setRotation( T[j] );</font>
00192 <font class="comment">    origin-&gt;setOrientation( rot2 );</font>
00193 <font class="comment">    */</font>
00194 
00195   }
00196 
00197   <font class="comment">//}//!!!</font>
00198 }
</pre></div><hr><address><small>Generated on Thu Aug 29 16:45:59 2002 for OpenSim by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.14 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2002</small></address>
</body>
</html>
