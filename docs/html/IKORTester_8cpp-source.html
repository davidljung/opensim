<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>OpenSim: robot/sim/IKORTester.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>robot/sim/IKORTester.cpp</h1><a href="IKORTester_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/****************************************************************************</span>
00002 <span class="comment">  Copyright (C)2003 David Jung &lt;opensim@pobox.com&gt;</span>
00003 <span class="comment"></span>
00004 <span class="comment">  This program/file is free software; you can redistribute it and/or modify</span>
00005 <span class="comment">  it under the terms of the GNU General Public License as published by</span>
00006 <span class="comment">  the Free Software Foundation; either version 2 of the License, or</span>
00007 <span class="comment">  (at your option) any later version.</span>
00008 <span class="comment">  </span>
00009 <span class="comment">  This program is distributed in the hope that it will be useful,</span>
00010 <span class="comment">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00011 <span class="comment">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00012 <span class="comment">  GNU General Public License for more details. (http://www.gnu.org)</span>
00013 <span class="comment">  </span>
00014 <span class="comment">  You should have received a copy of the GNU General Public License</span>
00015 <span class="comment">  along with this program; if not, write to the Free Software</span>
00016 <span class="comment">  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
00017 <span class="comment">  </span>
00018 <span class="comment">  $Id: IKORTester.cpp 1033 2004-02-11 20:47:52Z jungd $</span>
00019 <span class="comment">  $Revision: 1.14 $</span>
00020 <span class="comment">  $Date: 2004-02-11 15:47:52 -0500 (Wed, 11 Feb 2004) $</span>
00021 <span class="comment">  $Author: jungd $</span>
00022 <span class="comment"> </span>
00023 <span class="comment">****************************************************************************/</span>
00024 
00025 <span class="preprocessor">#include &lt;<a class="code" href="IKORTester.html">robot/sim/IKORTester</a>&gt;</span>
00026 
00027 <span class="preprocessor">#include &lt;<a class="code" href="Externalizer.html">base/Externalizer</a>&gt;</span>
00028 <span class="preprocessor">#include &lt;<a class="code" href="externalization__error.html">base/externalization_error</a>&gt;</span>
00029 <span class="preprocessor">#include &lt;<a class="code" href="Expression.html">base/Expression</a>&gt;</span>
00030 <span class="preprocessor">#include &lt;<a class="code" href="Matrix.html">base/Matrix</a>&gt;</span>
00031 <span class="preprocessor">#include &lt;<a class="code" href="VDirectory.html">base/VDirectory</a>&gt;</span>
00032 <span class="preprocessor">#include &lt;<a class="code" href="VFile.html">base/VFile</a>&gt;</span>
00033 
00034 <span class="preprocessor">#include &lt;<a class="code" href="AggregateControlInterface.html">robot/AggregateControlInterface</a>&gt;</span>
00035 <span class="preprocessor">#include &lt;<a class="code" href="BasicEnvironment.html">robot/sim/BasicEnvironment</a>&gt;</span>
00036 <span class="preprocessor">#include &lt;<a class="code" href="solution__error.html">robot/control/kinematics/solution_error</a>&gt;</span>
00037 <span class="preprocessor">#include &lt;<a class="code" href="Optimizer.html">robot/control/kinematics/Optimizer</a>&gt;</span>
00038 <span class="preprocessor">#include &lt;<a class="code" href="ReferenceOpVectorFormObjective.html">robot/control/kinematics/ReferenceOpVectorFormObjective</a>&gt;</span>
00039 <span class="preprocessor">#include &lt;<a class="code" href="AnalyticLagrangianFSBetaOptimizer.html">robot/control/kinematics/AnalyticLagrangianFSBetaOptimizer</a>&gt;</span>
00040 <span class="preprocessor">#include &lt;<a class="code" href="MPPseudoInvSolver.html">robot/control/kinematics/MPPseudoInvSolver</a>&gt;</span>
00041 <span class="preprocessor">#include &lt;<a class="code" href="LeastNormIKSolver.html">robot/control/kinematics/LeastNormIKSolver</a>&gt;</span>
00042 <span class="preprocessor">#include &lt;<a class="code" href="FullSpaceSolver.html">robot/control/kinematics/FullSpaceSolver</a>&gt;</span>
00043 <span class="preprocessor">#include &lt;<a class="code" href="IKOR.html">robot/control/kinematics/IKOR</a>&gt;</span>
00044 
00045 
00046 <span class="keyword">using</span> <a class="code" href="classrobot_1_1sim_1_1IKORTester.html">robot::sim::IKORTester</a>;
00047 
00048 <span class="keyword">using</span> <a class="code" href="classbase_1_1vector.html">base::Vector</a>;
00049 <span class="keyword">using</span> <a class="code" href="classbase_1_1Orient.html">base::Orient</a>;
00050 <span class="keyword">using</span> <a class="code" href="classbase_1_1Time.html">base::Time</a>;
00051 <span class="keyword">using</span> <a class="code" href="classbase_1_1PathName.html">base::PathName</a>;
00052 <span class="keyword">using</span> <a class="code" href="classbase_1_1VFile.html">base::VFile</a>;
00053 <span class="keyword">using</span> <a class="code" href="classbase_1_1VDirectory.html">base::VDirectory</a>;
00054 <span class="keyword">using</span> <a class="code" href="classbase_1_1matrix.html">base::ExpressionMatrix</a>;
00055 <span class="keyword">using</span> <a class="code" href="classbase_1_1externalization__error.html">base::externalization_error</a>;
00056 <span class="keyword">using</span> <a class="code" href="classbase_1_1Path.html">base::Path</a>;
00057 <span class="keyword">using</span> <a class="code" href="classbase_1_1Trajectory.html">base::Trajectory</a>;
00058 <span class="keyword">using</span> <a class="code" href="classrobot_1_1AggregateControlInterface.html">robot::AggregateControlInterface</a>;
00059 <span class="keyword">using</span> <a class="code" href="classrobot_1_1sim_1_1BasicEnvironment.html">robot::sim::BasicEnvironment</a>;
00060 <span class="keyword">using</span> <a class="code" href="classrobot_1_1sim_1_1IKORTest.html">robot::sim::IKORTest</a>;
00061 <span class="keyword">using</span> <a class="code" href="classrobot_1_1control_1_1kinematics_1_1FullSpaceSolver.html">robot::control::kinematics::FullSpaceSolver</a>;
00062 <span class="keyword">using</span> <a class="code" href="classrobot_1_1control_1_1kinematics_1_1ReferenceOpVectorFormObjective.html">robot::control::kinematics::ReferenceOpVectorFormObjective</a>;
00063 <span class="keyword">using</span> <a class="code" href="classrobot_1_1control_1_1kinematics_1_1BetaFormConstraints.html">robot::control::kinematics::BetaFormConstraints</a>;
00064 <span class="keyword">using</span> <a class="code" href="classrobot_1_1control_1_1kinematics_1_1AnalyticLagrangianFSBetaOptimizer.html">robot::control::kinematics::AnalyticLagrangianFSBetaOptimizer</a>;
00065 <span class="keyword">using</span> <a class="code" href="classrobot_1_1control_1_1kinematics_1_1InverseKinematicsSolver.html">robot::control::kinematics::InverseKinematicsSolver</a>;
00066 <span class="keyword">using</span> <a class="code" href="classrobot_1_1control_1_1kinematics_1_1MPPseudoInvSolver.html">robot::control::kinematics::MPPseudoInvSolver</a>;
00067 <span class="keyword">using</span> <a class="code" href="classrobot_1_1control_1_1kinematics_1_1LeastNormIKSolver.html">robot::control::kinematics::LeastNormIKSolver</a>;
00068 <span class="keyword">using</span> <a class="code" href="classrobot_1_1control_1_1kinematics_1_1FullSpaceSolver.html">robot::control::kinematics::FullSpaceSolver</a>;
00069 <span class="keyword">using</span> <a class="code" href="classrobot_1_1control_1_1kinematics_1_1IKOR.html">robot::control::kinematics::IKOR</a>;
00070 
00071 
00072 
00073 
00074 
00075 IKORTester::IKORTester(ref&lt;base::VFileSystem&gt; fs, ref&lt;base::Cache&gt; cache)
00076   : filesystem(fs), cache(cache)
00077 {
00078 }
00079 
00080 
00081 <span class="keywordtype">void</span> IKORTester::executeTests(ref&lt;IKORTest&gt; itest, <span class="keywordtype">bool</span> saveResults, <a class="code" href="classbase_1_1PathName.html">base::PathName</a> alternateOutputFileName)
00082 {
00083   ref&lt;SimulatedRobot&gt; <a class="code" href="robot_2Jamfile_8ft.html#a0">robot</a>( narrow_ref&lt;SimulatedRobot&gt;(itest-&gt;getRobot()) );
00084   <a class="code" href="namespacebase.html#a2">Int</a> testManipulatorIndex = itest-&gt;getManipulatorIndex();
00085   <a class="code" href="base.html#a11">Consoleln</a>(<span class="stringliteral">"Testing robot:"</span> &lt;&lt; <a class="code" href="robot_2Jamfile_8ft.html#a0">robot</a>-&gt;getRobotDescription()-&gt;getName() &lt;&lt; <span class="stringliteral">" with manipulator:"</span> 
00086                              &lt;&lt; <a class="code" href="robot_2Jamfile_8ft.html#a0">robot</a>-&gt;getRobotDescription()-&gt;manipulators()[testManipulatorIndex]-&gt;getName());
00087 
00088   <span class="comment">// duplicate the environment, so we can restore the environment to its initial state before saving</span>
00089   ref&lt;SimulatedBasicEnvironment&gt; env( narrow_ref&lt;SimulatedBasicEnvironment&gt;(itest-&gt;getEnvironment()) );
00090   ref&lt;SimulatedBasicEnvironment&gt; initialenv( &amp;base::clone(*env) );
00091   
00092   env-&gt;preSimulate();
00093   Time simTime(0);
00094   <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;itest-&gt;numTests(); i++) {
00095     IKORTest::Test&amp; test( itest-&gt;getTest(i) );
00096     <a class="code" href="base.html#a11">Consoleln</a>(<span class="stringliteral">"Executing test: "</span> &lt;&lt; test.getName());
00097     simTime = <a class="code" href="classrobot_1_1sim_1_1IKORTester.html#robot_1_1sim_1_1IKORTesterb0">executeTest</a>(test, simTime, env, robot, testManipulatorIndex);
00098   }
00099   
00100   <span class="keywordflow">if</span> (saveResults) {
00101     itest-&gt;setEnvironment(initialenv);
00102     itest-&gt;saveResults(<span class="keyword">true</span>,alternateOutputFileName);
00103   }
00104 }
00105 
00106   
00107 
00108 
00109 
00110 
00111 
00112 
00113 <a class="code" href="classbase_1_1Time.html">base::Time</a> IKORTester::executeTest(IKORTest::Test&amp; test, Time simTime, ref&lt;SimulatedBasicEnvironment&gt; env, 
00114                                    ref&lt;SimulatedRobot&gt; robot, Int testManipulatorIndex)
00115 {
00116   <span class="comment">// setup</span>
00117   ref&lt;const RobotDescription&gt; robotDescr(<a class="code" href="robot_2Jamfile_8ft.html#a0">robot</a>-&gt;getRobotDescription());
00118   ref&lt;const ManipulatorDescription&gt; manipDescr(robotDescr-&gt;manipulators()[testManipulatorIndex]); 
00119 
00120   <span class="comment">// get the kinematic chain for the robot and its first manipulator</span>
00121   Matrix4 platformTransform( <a class="code" href="robot_2Jamfile_8ft.html#a0">robot</a>-&gt;getOrientation().getRotationMatrix3() );
00122   platformTransform.setTranslationComponent( <a class="code" href="robot_2Jamfile_8ft.html#a0">robot</a>-&gt;getPosition() );
00123   KinematicChain platformChain( robotDescr-&gt;platform()-&gt;getKinematicChain(3,platformTransform) ); <span class="comment">// could have 0 dof</span>
00124   KinematicChain robotChain(robotDescr-&gt;getKinematicChain(3,platformTransform,testManipulatorIndex,0));
00125   KinematicChain manipChain(manipDescr-&gt;getKinematicChain());
00126   
00127   <span class="comment">// get control interfaces</span>
00128   <a class="code" href="namespacebase.html#a4">String</a> manipIndexStr( base::intToString(testManipulatorIndex+1) );
00129   ref&lt;ControlInterface&gt; platformControl(<a class="code" href="robot_2Jamfile_8ft.html#a0">robot</a>-&gt;getControlInterface(<span class="stringliteral">"platformPosition"</span>));
00130   ref&lt;ControlInterface&gt; manipControl(<a class="code" href="robot_2Jamfile_8ft.html#a0">robot</a>-&gt;getControlInterface(<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"manipulatorPosition"</span>)+manipIndexStr));
00131   ref&lt;ControlInterface&gt; toolControl(<a class="code" href="robot_2Jamfile_8ft.html#a0">robot</a>-&gt;getControlInterface(<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"toolPosition"</span>)+manipIndexStr));
00132   ref&lt;ControlInterface&gt; toolGripControl(<a class="code" href="robot_2Jamfile_8ft.html#a0">robot</a>-&gt;getControlInterface(<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"manipulatorToolGrip"</span>)+manipIndexStr));
00133 
00134   <span class="comment">// put interfaces into an array in kinematic order (for aggregation)</span>
00135   array&lt;ref&lt;ControlInterface&gt; &gt; interfaces;
00136   interfaces.push_back(platformControl);
00137   interfaces.push_back(manipControl);
00138 
00139   KinematicChain manipToolChain(manipChain); <span class="comment">// combined manip &amp; tool chain (==manipChain if no tool)</span>
00140   KinematicChain toolChain;
00141   <span class="keywordflow">if</span> (test.toolAttached) {
00142     <span class="comment">// locate tool</span>
00143     test.toolAttached = <span class="keyword">false</span>;
00144     <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; (i&lt;env-&gt;numTools()) &amp;&amp; !test.toolAttached; i++) {
00145       ref&lt;const ToolDescription&gt; td( env-&gt;getTool(i)-&gt;getToolDescription() );
00146 
00147       <span class="keywordflow">if</span> (td-&gt;getName() == test.toolName) {
00148         test.toolAttached = <span class="keyword">true</span>;
00149         env-&gt;placeToolInProximity( env-&gt;getTool(i), <a class="code" href="robot_2Jamfile_8ft.html#a0">robot</a>, 0);
00150         toolGripControl-&gt;setOutput(0,1); <span class="comment">// tell manipulator to grasp tool</span>
00151         toolChain = td-&gt;getKinematicChain();<span class="comment"></span>
00152 <span class="comment">//!!! hack</span>
00153 <span class="comment"></span>toolControl-&gt;setOutputs( <a class="code" href="namespacebase.html#a201">zeroVector</a>(toolChain.dof()) );
00154 <a class="code" href="base.html#a3">Logln</a>(<span class="stringliteral">"debug: setting tool outputs to 0"</span>);<span class="comment"></span>
00155 <span class="comment">//!!!</span>
00156 <span class="comment"></span>      }
00157     }
00158     <span class="keywordflow">if</span> (!test.toolAttached) 
00159       <span class="keywordflow">throw</span> std::logic_error(<a class="code" href="base.html#a15">Exception</a>(<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"the specified tool '"</span>)+test.toolName+<span class="stringliteral">"' doesn't exist in the environment"</span>));
00160     
00161     manipToolChain += toolChain;
00162   }
00163 
00164 
00165   
00166   KinematicChain chain(robotChain); <span class="comment">// kinematic chain from world frame to tool end-effector</span>
00167   <span class="keywordflow">if</span> (test.toolAttached) {
00168     chain += toolChain;
00169     interfaces.push_back(toolControl);
00170   }
00171 
00172 
00173   <span class="comment">// ControlInterace for all dofs: platform, manipulator &amp; tool</span>
00174   <span class="comment">//  (I/O vector components match dofs of chain)</span>
00175   ref&lt;ControlInterface&gt; <a class="code" href="robot_2Jamfile_8ft.html#a2">control</a>(NewObj AggregateControlInterface(<span class="stringliteral">"robotPosition"</span>,<span class="stringliteral">"RobotPositionControl"</span>, interfaces));
00176   
00177 
00178   <a class="code" href="classdemeter_1_1Vector.html">Vector</a> q( <a class="code" href="namespacebase.html#a201">zeroVector</a>(chain.dof()) );
00179 
00180   <span class="comment">// put manipulator into initial configuration (if needed)</span>
00181   <span class="keywordflow">if</span> (test.initialConfigSpecified) {
00182 
00183     <span class="keywordflow">if</span> (test.initq.size() != chain.dof())
00184       <span class="keywordflow">throw</span> std::logic_error(<a class="code" href="base.html#a15">Exception</a>(<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"the initial configuration specified has "</span>)
00185                                        + base::intToString(test.initq.size())
00186                                        + <span class="stringliteral">" components, but the platform, manipulator &amp; tool (if any) has "</span>
00187                                        + <a class="code" href="namespacebase.html#a50">base::intToString</a>(chain.dof())+<span class="stringliteral">" d.o.f"</span>));
00188 
00189     q = test.initq;
00190 
00191     <span class="comment">// convert components of q corresponding to revolute joints to radians </span>
00192     <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> v=0; v&lt;chain.dof(); v++)
00193       <span class="keywordflow">if</span> (chain.variableUnitType(v) == KinematicChain::Angle)
00194         q[v] = Math::degToRad(q[v]);
00195     
00196     <a class="code" href="base.html#a21">Assertm</a>(chain.dof() == <a class="code" href="robot_2control_2Jamfile_8ft.html#a0">control</a>-&gt;outputSize(),<span class="stringliteral">"KinematicChain dof == aggregated ControlInterface output vector size"</span>);
00197     <a class="code" href="robot_2control_2Jamfile_8ft.html#a0">control</a>-&gt;setOutputs(q);
00198   }
00199   <span class="keywordflow">else</span>  <span class="comment">// get config from robot</span>
00200     q.reset( <a class="code" href="robot_2control_2Jamfile_8ft.html#a0">control</a>-&gt;getInputs() );
00201 
00202 
00203 
00204   <a class="code" href="classbase_1_1Trajectory.html">Trajectory</a> traj(test.traj);
00205 
00206   <span class="comment">// if units were specified for the trajectory, and they are not "meters", then</span>
00207   <span class="comment">//  convert to meters</span>
00208   <span class="keywordflow">if</span> (traj.<a class="code" href="classbase_1_1Path.html#gfx_1_1VisualPatha15">getUnits</a>() != <span class="stringliteral">""</span>) {
00209 
00210     <span class="keywordflow">if</span> (traj.<a class="code" href="classbase_1_1Path.html#gfx_1_1VisualPatha15">getUnits</a>() == <span class="stringliteral">"inches"</span>)
00211       traj.<a class="code" href="classbase_1_1Path.html#gfx_1_1VisualPatha22">scalePosition</a>(consts::metersPerInch);
00212     <span class="keywordflow">else</span>
00213       <span class="keywordflow">if</span> (traj.<a class="code" href="classbase_1_1Path.html#gfx_1_1VisualPatha15">getUnits</a>() != <span class="stringliteral">"meters"</span>) {
00214         <a class="code" href="base.html#a3">Logln</a>(<span class="stringliteral">"Warning: unknown units specified for trajectory: '"</span> &lt;&lt; traj.<a class="code" href="classbase_1_1Path.html#gfx_1_1VisualPatha15">getUnits</a>() &lt;&lt; <span class="stringliteral">"' - no conversion performed."</span>);
00215       }
00216   }
00217 
00218   
00219   <span class="comment">// all test are performed in the WorldFrame, so convert the trajectory to world frame coords.</span>
00220   <span class="keywordflow">if</span> (test.frame != Robot::WorldFrame) {
00221 
00222     <span class="comment">// make this more elegant later!!!</span><span class="comment"></span>
00223 <span class="comment">    //!!! I think this may be broken - overhaul it! !!!</span>
00224 <span class="comment"></span><a class="code" href="base.html#a3">Logln</a>(<span class="stringliteral">"warning: trajectory/path transformation to world frame not well tested"</span>);
00225     <a class="code" href="classdemeter_1_1Vector.html">Vector</a> mtq( manipToolChain.dof() );
00226     mtq = <a class="code" href="namespacebase.html#a205">vectorRange</a>(q, <a class="code" href="namespacebase.html#a30">Range</a>(platformChain.dof(),q.size()) );
00227 
00228     <a class="code" href="classbase_1_1matrix.html">Matrix</a> T(manipToolChain.getForwardKinematics(mtq)); <span class="comment">// manip|tool ee -&gt; manip mount frame transform</span>
00229 
00230     Matrix4 toWorldTransform( <a class="code" href="robot_2Jamfile_8ft.html#a0">robot</a>-&gt;coordFrameTransform(test.frame, Robot::WorldFrame, 0, base::toMatrix4(T),
00231                                                          <a class="code" href="robot_2Jamfile_8ft.html#a0">robot</a>-&gt;getPosition(),
00232                                                          <a class="code" href="robot_2Jamfile_8ft.html#a0">robot</a>-&gt;getOrientation()) );
00233                                                          
00234                                                          
00235     traj.<a class="code" href="classbase_1_1Path.html#gfx_1_1VisualPatha21">transform</a>( toWorldTransform );
00236   }
00237 
00238 
00239 
00240   <span class="comment">// if an overriding time interval was specified, replace the current trajectory time</span>
00241   <span class="comment">//  information with it</span>
00242   <a class="code" href="namespacebase.html#a5">Real</a> stepsize = 0.01; <span class="comment">// default</span>
00243   <span class="keywordflow">if</span> (test.timeIntervalSpecified) {
00244     <span class="comment">// achieved by converting the trajectory to a Path (hence loosing the time information)</span>
00245     <span class="comment">//  and then back to a trajectory with the information specified from the interval</span>
00246 <a class="code" href="base.html#a3">Logln</a>(<span class="stringliteral">"warning: trajectory/path resamping not well tested"</span>);
00247     <a class="code" href="classbase_1_1Path.html">Path</a> path(traj);
00248     <a class="code" href="namespacebase.html#a5">Real</a> start = test.timeInterval[0];
00249     <a class="code" href="namespacebase.html#a5">Real</a> end = test.timeInterval[1];
00250     <a class="code" href="namespacebase.html#a5">Real</a> duration = end-start;
00251 
00252     traj = <a class="code" href="classbase_1_1Trajectory.html">Trajectory</a>(path);
00253     traj.<a class="code" href="classbase_1_1Trajectory.html#base_1_1Trajectorya14">scaleTime</a>(duration);
00254     traj.<a class="code" href="classbase_1_1Trajectory.html#base_1_1Trajectorya13">shiftTime</a>(start);
00255 
00256     <span class="keywordflow">if</span> (test.timeInterval[2] &gt; 0) { <span class="comment">// i.e. stepsize given</span>
00257       stepsize = test.timeInterval[2];
00258       traj.<a class="code" href="classbase_1_1Trajectory.html#base_1_1Trajectorya11">resample</a>( <a class="code" href="namespacebase.html#a2">Int</a>(duration/stepsize) );
00259     }<span class="comment"></span>
00260 <span class="comment">//!!! this may break things too!! !!!</span>
00261 <span class="comment"></span>  }
00262 
00263   
00264   <span class="comment">// if a limit on the maximum distance between any two trajectory points was specified, resample</span>
00265   <span class="comment">//  so that the inter-point distances are smaller than the maxdx specified</span>
00266     <span class="keywordflow">if</span> (test.maxdxSpecified)  <span class="comment">// limit |dx|</span>
00267       traj.<a class="code" href="classbase_1_1Trajectory.html#base_1_1Trajectorya11">resample</a>(test.maxdx);
00268 
00269     
00270 
00271   <span class="comment">//</span>
00272   <span class="comment">// finally, iterate over the trajectory, calculating dxs and using inverse-kinematics</span>
00273   <span class="comment">//  to solve for dqs</span>
00274 
00275   ref&lt;InverseKinematicsSolver&gt;     ikSolver;
00276   <span class="keywordflow">if</span> (test.solutionMethod == IKORTest::Test::PseudoInverse) {
00277     ikSolver = ref&lt;InverseKinematicsSolver&gt;(<a class="code" href="MemoryTracer.html#a0">NewObj</a> <a class="code" href="classrobot_1_1control_1_1kinematics_1_1LeastNormIKSolver.html">LeastNormIKSolver</a>());
00278     <span class="keywordflow">if</span> (test.jointWeightsSpecified) {
00279       <a class="code" href="base.html#a3">Logln</a>(<span class="stringliteral">"Warning: joint parameter weights are ignored for the PseudoInverse solution method"</span>);
00280     }
00281   }
00282   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (test.solutionMethod == IKORTest::Test::FullSpace) {
00283     <span class="keywordtype">bool</span> nonHolonomicPlatformActive = (robotDescr-&gt;platform()-&gt;isMobile() &amp;&amp; !robotDescr-&gt;platform()-&gt;isHolonomic());
00284     
00285     <span class="comment">// get joint weights</span>
00286     <a class="code" href="classdemeter_1_1Vector.html">Vector</a> jointWeights(test.jointWeightsSpecified? test.jointWeights : <a class="code" href="classdemeter_1_1Vector.html">Vector</a>() );
00287     <span class="keywordflow">if</span> (jointWeights.size() == 0) { <span class="comment">// not specified, set to (1,1,..,1)</span>
00288       jointWeights.reset( <a class="code" href="classdemeter_1_1Vector.html">Vector</a>(chain.dof()) );
00289       <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;jointWeights.size(); i++) jointWeights[i] = 1.0;
00290     }
00291     <span class="keywordflow">else</span>
00292       <span class="keywordflow">if</span> (jointWeights.size() != chain.dof())
00293         <span class="keywordflow">throw</span> std::logic_error(<a class="code" href="base.html#a15">Exception</a>(<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"the specified joint weight vector has "</span>)
00294                                        + base::intToString(jointWeights.size())
00295                                        + <span class="stringliteral">" components, but the platform, manipulator &amp; tool (if any) has "</span>
00296                                        + <a class="code" href="namespacebase.html#a50">base::intToString</a>(chain.dof())+<span class="stringliteral">" d.o.f"</span>));
00297       
00298     <a class="code" href="namespacebase.html#a5">Real</a> L = robotDescr-&gt;platform()-&gt;L();
00299     ikSolver = ref&lt;InverseKinematicsSolver&gt;(<a class="code" href="MemoryTracer.html#a0">NewObj</a> IKOR(chain, jointWeights, nonHolonomicPlatformActive, L));
00300   }
00301   <a class="code" href="base.html#a19">Assert</a>(ikSolver);
00302 
00303 
00304   <span class="comment">// check obstacle avoidance is supported, if requested &amp; get manip proximity sensor interface</span>
00305   ref&lt;ControlInterface&gt; proximitySensorInterface;
00306   
00307   <span class="keywordflow">if</span> (test.optConstraints.test(IKOR::ObstacleAvoidance)) {
00308     <span class="keywordflow">if</span> (ikSolver-&gt;isConstraintTypeSupported(IKOR::ObstacleAvoidance, test.optMethod, test.optCriteria))
00309       proximitySensorInterface = <a class="code" href="robot_2Jamfile_8ft.html#a0">robot</a>-&gt;getControlInterface(<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"manipulatorProximity"</span>)+manipIndexStr);
00310     <span class="keywordflow">else</span>
00311       <span class="keywordflow">throw</span> std::logic_error(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"obstacle avoidance constraints were requested, but the IK solver doesn't support them with the specificed optimizatio method and criteria"</span>));
00312   }
00313   
00314 
00315   
00316   <span class="comment">// clear arrays to hold the resulting platform/manipulator/tool trajectory</span>
00317   test.qs.clear();
00318   test.xs.clear();
00319   test.dxs.clear();
00320   test.dqs.clear();
00321   test.times.clear();
00322   test.Js.clear();
00323   
00324   <span class="keywordflow">if</span> (simTime.equals(0)) <span class="comment">// advance initial simTime if necessary</span>
00325     <span class="keywordflow">if</span> (simTime &lt; traj.<a class="code" href="classbase_1_1Trajectory.html#base_1_1Trajectorya10">time</a>(0))
00326       simTime = traj.<a class="code" href="classbase_1_1Trajectory.html#base_1_1Trajectorya10">time</a>(0);
00327 
00328   <span class="keywordflow">if</span> (simTime &gt; traj.<a class="code" href="classbase_1_1Trajectory.html#base_1_1Trajectorya10">time</a>(0))
00329     <span class="keywordflow">throw</span> std::logic_error(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"simulation time at start of trajectory is already greater than the specified start-time of the trajectory"</span>));
00330 
00331 
00332   <span class="comment">// get initial q and calculate x </span>
00333   q = <a class="code" href="robot_2control_2Jamfile_8ft.html#a0">control</a>-&gt;getInputs();
00334   <a class="code" href="classdemeter_1_1Vector.html">Vector</a> x(<a class="code" href="classrobot_1_1sim_1_1IKORTester.html#robot_1_1sim_1_1IKORTesterb1">calcEEVector</a>(test,chain,q));
00335   test.qs.push_back(q);
00336   test.xs.push_back(x);
00337   test.times.push_back(simTime);
00338   test.Js.push_back( chain.getJacobian(q, test.orientationControl) );
00339 
00340   <a class="code" href="base.html#a3">Logln</a>(<span class="stringliteral">"initial q="</span> &lt;&lt; q &lt;&lt; <span class="stringliteral">"  x="</span> &lt;&lt; x);
00341 
00342   
00343   <span class="comment">// if the initial ee position is coincident with the first trajectory point *and* the</span>
00344   <span class="comment">//  initial time is identical to the current simTime, skip the first trajectory point</span>
00345   <span class="comment">// However, if the positions are not coincident, but the times are - it is an error</span>
00346   <span class="comment">//  (cannot move intantaneously).  If the positions are coincident but the times are</span>
00347   <span class="comment">//  not, the initial dx will be 0.</span>
00348 
00349   <span class="keywordtype">bool</span> coincident=<span class="keyword">false</span>; <span class="comment">// position[/orientation] coincident?</span>
00350   <span class="comment">// check if the initial ee is co-incident with the beginning of the trajectory (to within tol)</span>
00351   <span class="keyword">const</span> <a class="code" href="namespacebase.html#a5">Real</a> tol = 0.01;
00352   Vector3 pos( base::toVector3(<a class="code" href="namespacebase.html#a205">vectorRange</a>(x,<a class="code" href="namespacebase.html#a30">Range</a>(0,3))) );
00353   Orient orient;
00354   <span class="keywordflow">if</span> (!test.orientationControl) {
00355     <span class="keywordflow">if</span> (pos.equals( traj.<a class="code" href="classbase_1_1Trajectory.html#base_1_1Trajectorya8">position</a>(traj.<a class="code" href="classbase_1_1Trajectory.html#base_1_1Trajectorya10">time</a>(0)),tol ))
00356       coincident=<span class="keyword">true</span>;
00357   }
00358   <span class="keywordflow">else</span> {
00359     orient = Orient( <a class="code" href="namespacebase.html#a205">vectorRange</a>(x,<a class="code" href="namespacebase.html#a30">Range</a>(3,6)), Orient::EulerRPY );
00360     <span class="keywordflow">if</span> ( pos.equals( traj.<a class="code" href="classbase_1_1Trajectory.html#base_1_1Trajectorya8">position</a>(traj.<a class="code" href="classbase_1_1Trajectory.html#base_1_1Trajectorya10">time</a>(0)),tol ) &amp;&amp; orient.equals( traj.<a class="code" href="classbase_1_1Trajectory.html#base_1_1Trajectorya9">orientation</a>(traj.<a class="code" href="classbase_1_1Trajectory.html#base_1_1Trajectorya10">time</a>(0)),tol ) )
00361       coincident=<span class="keyword">true</span>;
00362   }
00363 
00364   
00365   <span class="keywordflow">if</span> (!coincident) {
00366     <span class="keywordflow">if</span> (traj.<a class="code" href="classbase_1_1Trajectory.html#base_1_1Trajectorya10">time</a>(0) == simTime) {
00367       <a class="code" href="namespacebase.html#a4">String</a> posorient(base::toString(traj.<a class="code" href="classbase_1_1Trajectory.html#base_1_1Trajectorya8">position</a>(0)));
00368       <a class="code" href="namespacebase.html#a4">String</a> eeposorient(base::toString(pos));
00369       <span class="keywordflow">if</span> (test.orientationControl) {
00370         Orient trajo( traj.<a class="code" href="classbase_1_1Trajectory.html#base_1_1Trajectorya9">orientation</a>(0) ); trajo.changeRepresentation(Orient::EulerRPY);
00371         Orient eeo(orient); eeo.changeRepresentation(trajo.representation());
00372         posorient += <a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"/"</span>)+<a class="code" href="namespacebase.html#a54">base::toString</a>( trajo );
00373         eeposorient += <a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"/"</span>)+<a class="code" href="namespacebase.html#a54">base::toString</a>( eeo );
00374       }
00375       <span class="keywordflow">throw</span> std::logic_error(<a class="code" href="base.html#a15">Exception</a>(<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"the initial trajectory time is equal to the initial simulation time, but initial trajectory position[/orientation] "</span>)
00376                 +posorient+
00377                 +<span class="stringliteral">"(WorldFrame) is not coincident with the initial end-effector "</span>
00378                 +eeposorient+
00379                 +<span class="stringliteral">"(WorldFrame) to within tolerance.  Can't move the end-effector instantaneously!"</span>));
00380     }
00381   }
00382     
00383 
00384 
00385   <span class="comment">// loop over traj</span>
00386   <span class="keywordtype">bool</span> abort=<span class="keyword">false</span>;
00387   <a class="code" href="namespacebase.html#a2">Int</a> i=coincident?1:0;
00388   <span class="keywordflow">for</span>(; (i&lt;traj.<a class="code" href="classbase_1_1Path.html#gfx_1_1VisualPatha18">numDistinguishedValues</a>()) &amp;&amp; (!abort); i++) { 
00389 
00390     <a class="code" href="namespacebase.html#a5">Real</a> s = traj.<a class="code" href="classbase_1_1Path.html#gfx_1_1VisualPatha17">distinguishedValue</a>(i);
00391     Time t = traj.<a class="code" href="classbase_1_1Trajectory.html#base_1_1Trajectorya10">time</a>(s);
00392 
00393     <span class="comment">// get trajectory pos/orient at time t and convert to Vector targetx</span>
00394     <a class="code" href="namespacebase.html#a26">Point3</a> targetPos( traj.<a class="code" href="classbase_1_1Trajectory.html#base_1_1Trajectorya8">position</a>(t) );
00395     Orient targetOrient( test.orientationControl?traj.<a class="code" href="classbase_1_1Trajectory.html#base_1_1Trajectorya9">orientation</a>(t):Orient() );
00396     <a class="code" href="classdemeter_1_1Vector.html">Vector</a> targetx(test.orientationControl?6:3);
00397     <a class="code" href="namespacebase.html#a205">vectorRange</a>(targetx, <a class="code" href="namespacebase.html#a30">Range</a>(0,3)) = <a class="code" href="namespacebase.html#a212">base::fromVector3</a>(targetPos);
00398     <span class="keywordflow">if</span> (test.orientationControl) 
00399       <a class="code" href="namespacebase.html#a205">vectorRange</a>(targetx, <a class="code" href="namespacebase.html#a30">Range</a>(3,6)) = targetOrient.getVector(Orient::EulerRPY);
00400     <a class="code" href="classdemeter_1_1Vector.html">Vector</a> dx( targetx - x );
00401 <span class="comment">//Debugln(DJ,"\nx=" &lt;&lt; x &lt;&lt; "\ntargetx=" &lt;&lt; targetx &lt;&lt; "\ndx=" &lt;&lt; dx);</span>
00402     test.dxs.push_back(dx);
00403     
00404     <a class="code" href="classdemeter_1_1Vector.html">Vector</a> dq( chain.dof() );
00405 
00406     
00407     <span class="keywordflow">if</span> (test.optConstraints.test(IKOR::ObstacleAvoidance)) {
00408       <span class="comment">// read proximity sensor data from manipulator and give it to the solver so that</span>
00409       <span class="comment">//  obstacle constraints can be imposed as appropriate</span>
00410       <span class="comment">// (note that the interface provides prox data by link of the manipulator, but the</span>
00411       <span class="comment">//  solver expects prox data by dof variable for the whole chain (platform &amp; manip) )</span>
00412       array&lt;InverseKinematicsSolver::LinkProximityData&gt; proxData( chain.dof() ); <span class="comment">// elements initialize to no-proximity</span>
00413       
00414       <span class="comment">// indices correspond to links (including base), not parameters (some links may have 0-dof)</span>
00415       <a class="code" href="classdemeter_1_1Vector.html">Vector</a> proximityInputs( proximitySensorInterface-&gt;getInputs() );
00416 
00417       <span class="comment">// fill in proxData from proximityInputs</span>
00418       <span class="comment">//  interface only provides prox data for manip[/tool], so skip over platform dofs (if any)</span>
00419       <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> v=0; v &lt; chain.dof(); v++) { <span class="comment">// for each platf/manip[/tool] parameter variable</span>
00420 
00421         <span class="keywordflow">if</span> (v &gt;= platformChain.dof()+1) { <span class="comment">// only handling manip link prox sensors (excluding base)</span>
00422         
00423           <a class="code" href="namespacebase.html#a2">Int</a> l = manipToolChain.linkIndexOfVariable(v - platformChain.dof()); <span class="comment">// manip[/tool] link index</span>
00424           InverseKinematicsSolver::LinkProximityData&amp; pd(proxData[v]);
00425           
00426           pd.distance =    proximityInputs[l*5]; <span class="comment">// see SimulatedRobot for interface input vector description</span>
00427           pd.direction.resize(3);
00428           pd.direction[0] = proximityInputs[l*5+1];
00429           pd.direction[1] = proximityInputs[l*5+2];
00430           pd.direction[2] = proximityInputs[l*5+3];
00431           pd.intercept   = proximityInputs[l*5+4];
00432         }
00433       }
00434       
00435       <a class="code" href="namespacebase.html#a5">Real</a> d = 0.3;
00436       ikSolver-&gt;setProximitySensorData(proxData, d);
00437       
00438     }
00439     
00440 <span class="comment">//Debugln(DJ,"t:" &lt;&lt; simTime.seconds() &lt;&lt; "  q:" &lt;&lt; q &lt;&lt; "  x:" &lt;&lt; x &lt;&lt; "  dx:" &lt;&lt; dx );</span>
00441     <span class="comment">// attempt IK</span>
00442     <a class="code" href="classbase_1_1matrix.html">Matrix</a> J;
00443     <span class="keywordflow">try</span> {
00444       
00445       J = chain.getJacobian(q, test.orientationControl);
00446       dq = ikSolver-&gt;solve(dx, x, q, J, test.optMethod, test.optCriteria, test.optConstraints, Orient::EulerRPY);
00447       <span class="comment"></span>
00448 <span class="comment">//!!! hack for now to limit |dq|</span>
00449 <span class="comment"></span><a class="code" href="debugtools.html#a7">Debugln</a>(DJ,<span class="stringliteral">"|dq|="</span> &lt;&lt; dq.magnitude());
00450 <span class="keywordflow">if</span> (dq.magnitude() &gt; 0.2) {
00451   dq /= ( dq.magnitude()/0.2 );
00452   <a class="code" href="debugtools.html#a11">Debugcln</a>(DJ,<span class="stringliteral">"scaling dq"</span>);
00453 }<span class="comment"></span>
00454 <span class="comment">//!!!      </span>
00455 <span class="comment"></span>      
00456     }
00457     <span class="keywordflow">catch</span> (std::exception&amp; e) {
00458       abort=<span class="keyword">true</span>;
00459       test.failureString = e.what();
00460     }
00461 
00462     <span class="keywordflow">if</span> (!abort) {
00463 <span class="comment">//Debugcln(DJ,"==dq:" &lt;&lt; dq);</span>
00464       test.dqs.push_back(dq);
00465 
00466       <span class="comment">// move the platform/manipulator/tool</span>
00467       <a class="code" href="robot_2control_2Jamfile_8ft.html#a0">control</a>-&gt;setOutputs( q + dq );
00468 
00469       <span class="comment">// 'simulate'</span>
00470       env-&gt;simulateForSimTime( t-simTime );
00471       simTime = t;
00472       
00473       <span class="comment">// update q &amp; x next iteration</span>
00474       q = <a class="code" href="robot_2control_2Jamfile_8ft.html#a0">control</a>-&gt;getInputs();
00475       test.qs.push_back(q); 
00476       test.times.push_back(simTime);
00477       x = <a class="code" href="classrobot_1_1sim_1_1IKORTester.html#robot_1_1sim_1_1IKORTesterb1">calcEEVector</a>(test,chain,q); <span class="comment">// new ee pos/orient</span>
00478       test.xs.push_back(x);
00479       test.Js.push_back(J);
00480     }
00481 
00482   } <span class="comment">// end traj loop</span>
00483 
00484 
00485   test.testCompleted = !abort;
00486   <span class="keywordflow">if</span> (!test.testCompleted) {
00487     <a class="code" href="base.html#a3">Logln</a>(<span class="stringliteral">"IK solution failed after "</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">" trajectory points."</span>);
00488     <a class="code" href="base.html#a3">Logln</a>(<span class="stringliteral">"time:"</span> &lt;&lt; simTime.seconds() &lt;&lt; <span class="stringliteral">" trajectory position:"</span> 
00489           &lt;&lt; traj.<a class="code" href="classbase_1_1Trajectory.html#base_1_1Trajectorya8">position</a>(simTime) &lt;&lt; <span class="stringliteral">" (WorldFrame)."</span>);
00490     <a class="code" href="base.html#a3">Logln</a>(<span class="stringliteral">"failure reason:\n"</span> &lt;&lt; test.failureString);
00491   }
00492   <a class="code" href="base.html#a3">Logln</a>(<span class="stringliteral">"  final q="</span> &lt;&lt; q &lt;&lt; <span class="stringliteral">"  x="</span> &lt;&lt; x &lt;&lt; <span class="stringliteral">" ("</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">" steps)"</span>);
00493   
00494   test.resultsPresent = <span class="keyword">true</span>;
00495   <span class="keywordflow">return</span> simTime;
00496 }
00497 
00498 
00499 
00500 
00501 
00502 <a class="code" href="classbase_1_1vector.html">base::Vector</a> IKORTester::calcEEVector(<span class="keyword">const</span> IKORTest::Test&amp; test, <span class="keyword">const</span> KinematicChain&amp; chain, <span class="keyword">const</span> <a class="code" href="classbase_1_1vector.html">base::Vector</a>&amp; q)<span class="keyword"> const</span>
00503 <span class="keyword"></span>{
00504   <span class="comment">// calculate the EE position using the current joint parameters and the forward kinematics transform (Tn)</span>
00505   <a class="code" href="classbase_1_1matrix.html">Matrix</a> Tn( chain.getForwardKinematics(q) );
00506   
00507   <span class="comment">//  the position is the first 3 elements of column 4 of T</span>
00508   <span class="comment">//  the orientation is the 3x3 submatrix of T - converted into a EulerRPY vector</span>
00509   <a class="code" href="classdemeter_1_1Vector.html">Vector</a> pos(3); pos = <a class="code" href="namespacebase.html#a205">vectorRange</a>(<a class="code" href="classdemeter_1_1Vector.html">Vector</a>(<a class="code" href="namespacebase.html#a84">matrixColumn</a>(Tn,3)), <a class="code" href="namespacebase.html#a30">Range</a>(0,3));
00510   <a class="code" href="classdemeter_1_1Vector.html">Vector</a> x(test.orientationControl?6:3);
00511   <a class="code" href="namespacebase.html#a205">vectorRange</a>(x, <a class="code" href="namespacebase.html#a30">Range</a>(0,3)) = pos;
00512 
00513   <span class="keywordflow">if</span> (test.orientationControl) {
00514     <a class="code" href="classbase_1_1matrix.html">Matrix</a> rot(3,3); rot = <a class="code" href="namespacebase.html#a86">matrixRange</a>(Tn, <a class="code" href="namespacebase.html#a30">Range</a>(0,3), <a class="code" href="namespacebase.html#a30">Range</a>(0,3));
00515     <a class="code" href="classdemeter_1_1Vector.html">Vector</a> orient( Orient(rot).getVector(Orient::EulerRPY) );
00516     <a class="code" href="namespacebase.html#a205">vectorRange</a>(x, <a class="code" href="namespacebase.html#a30">Range</a>(3,x.size())) = orient;
00517   }
00518   <span class="keywordflow">return</span> x; <span class="comment">// WorldFrame</span>
00519 }
00520 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Jul 29 15:56:39 2004 for OpenSim by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.6 </small></address>
</body>
</html>
