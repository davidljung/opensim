<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>OpenSim: physics/LODTerrain.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>physics/LODTerrain.cpp</h1><a href="LODTerrain_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/****************************************************************************</span>
00002 <span class="comment">  Copyright (C)1996 David Jung &lt;opensim@pobox.com&gt;</span>
00003 <span class="comment"></span>
00004 <span class="comment">  This program/file is free software; you can redistribute it and/or modify</span>
00005 <span class="comment">  it under the terms of the GNU General Public License as published by</span>
00006 <span class="comment">  the Free Software Foundation; either version 2 of the License, or</span>
00007 <span class="comment">  (at your option) any later version.</span>
00008 <span class="comment">  </span>
00009 <span class="comment">  This program is distributed in the hope that it will be useful,</span>
00010 <span class="comment">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00011 <span class="comment">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00012 <span class="comment">  GNU General Public License for more details. (http://www.gnu.org)</span>
00013 <span class="comment">  </span>
00014 <span class="comment">  You should have received a copy of the GNU General Public License</span>
00015 <span class="comment">  along with this program; if not, write to the Free Software</span>
00016 <span class="comment">  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
00017 <span class="comment">  </span>
00018 <span class="comment">  $Id: LODTerrain.cpp 1031 2004-02-11 20:46:36Z jungd $</span>
00019 <span class="comment"> </span>
00020 <span class="comment">****************************************************************************/</span>
00021 
00022 <span class="preprocessor">#include &lt;<a class="code" href="LODTerrain.html">physics/LODTerrain</a>&gt;</span>
00023 
00024 <span class="preprocessor">#include &lt;<a class="code" href="Externalizer.html">base/Externalizer</a>&gt;</span>
00025 <span class="preprocessor">#include &lt;<a class="code" href="array.html">base/array</a>&gt;</span>
00026 <span class="preprocessor">#include &lt;<a class="code" href="File.html">base/File</a>&gt;</span>
00027 
00028 <span class="preprocessor">#include &lt;<a class="code" href="VisualTriangles.html">gfx/VisualTriangles</a>&gt;</span>
00029 
00030 <span class="preprocessor">#include &lt;<a class="code" href="Material.html">physics/Material</a>&gt;</span>
00031 <span class="preprocessor">#include &lt;<a class="code" href="OBBCollisionModel.html">physics/OBBCollisionModel</a>&gt;</span>
00032 <span class="preprocessor">#include &lt;<a class="code" href="GJKCollisionModel.html">physics/GJKCollisionModel</a>&gt;</span>
00033 
00034 <span class="preprocessor">#include &lt;osg/Node&gt;</span>
00035 <span class="preprocessor">#include &lt;osg/StateSet&gt;</span>
00036 <span class="preprocessor">#include &lt;osg/Fog&gt;</span>
00037 
00038 
00039 <span class="keyword">using</span> <a class="code" href="classbase_1_1array.html">base::array</a>;
00040 
00041 <span class="keyword">using</span> <a class="code" href="classgfx_1_1Segment3.html">gfx::Segment3</a>;
00042 <span class="keyword">using</span> <a class="code" href="classdemeter_1_1Terrain.html">gfx::CLODTerrainRenderer</a>;
00043 <span class="keyword">using</span> <a class="code" href="classdemeter_1_1DemeterDrawable.html">gfx::CLODTerrainDrawable</a>;
00044 
00045 <span class="keyword">using</span> <a class="code" href="classphysics_1_1LODTerrain.html">physics::LODTerrain</a>;
00046 <span class="keyword">using</span> <a class="code" href="classphysics_1_1MassProperties.html">physics::MassProperties</a>;
00047 <span class="keyword">using</span> <a class="code" href="classphysics_1_1BoundingBox.html">physics::BoundingBox</a>;
00048 <span class="keyword">using</span> <a class="code" href="classphysics_1_1BoundingSphere.html">physics::BoundingSphere</a>;
00049 <span class="keyword">using</span> <a class="code" href="classphysics_1_1CollisionModel.html">physics::CollisionModel</a>;
00050 <span class="keyword">using</span> <a class="code" href="classphysics_1_1OBBCollisionModel.html">physics::OBBCollisionModel</a>;
00051 <span class="keyword">using</span> <a class="code" href="classphysics_1_1GJKCollisionModel.html">physics::GJKCollisionModel</a>;
00052 
00053 
00054 LODTerrain::LODTerrain() 
00055   : massPropertiesCached(false), boundsCached(false)
00056 {
00057   <a class="code" href="classphysics_1_1Shape.html#physics_1_1Torusp0">shapeHasAppearance</a>=<span class="keyword">true</span>;
00058 }
00059 
00060 LODTerrain::LODTerrain(<span class="keyword">const</span> LODTerrain&amp; t)
00061   : Terrain(t), renderer(t.renderer), drawable(t.drawable),
00062     massPropertiesCached(false), boundsCached(false)
00063   
00064 {
00065   <a class="code" href="classphysics_1_1Shape.html#physics_1_1Torusp0">shapeHasAppearance</a>=<span class="keyword">true</span>;
00066 }
00067 
00068 LODTerrain::~LODTerrain() 
00069 {
00070 }
00071 
00072 
00073 <span class="keywordtype">void</span> LODTerrain::loadMap(ref&lt;base::VFile&gt; mapfile) <span class="keywordflow">throw</span>(std::invalid_argument, <a class="code" href="classbase_1_1io__error.html">base::io_error</a>)
00074 {
00075   <span class="keywordflow">if</span> (<a class="code" href="base.html#a25">instanceof</a>(*mapfile,<a class="code" href="classbase_1_1File.html">base::File</a>)) {
00076     renderer = <span class="keyword">new</span> <a class="code" href="classdemeter_1_1Terrain.html">CLODTerrainRenderer</a>( const_cast&lt;char*&gt;(mapfile-&gt;pathName().str().c_str()), 40000); <span class="comment">// fix 40000 !!!!</span>
00077     renderer-&gt;SetDetailThreshold(25.0f);
00078     drawable = <span class="keyword">new</span> <a class="code" href="classdemeter_1_1DemeterDrawable.html">CLODTerrainDrawable</a>();
00079     drawable-&gt;SetTerrain(&amp;(*renderer));
00080     boundsCached=massPropertiesCached=<span class="keyword">false</span>;
00081   }
00082   <span class="keywordflow">else</span>
00083     <span class="keywordflow">throw</span> std::invalid_argument(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"Can only load from standard Unix files.  Sorry"</span>));
00084   
00085 }
00086 
00087 <span class="keywordtype">void</span> LODTerrain::loadHeightField(ref&lt;HeightField&gt; heightfield) <span class="keywordflow">throw</span>(std::invalid_argument, <a class="code" href="classbase_1_1io__error.html">base::io_error</a>)
00088 {
00089   boundsCached=massPropertiesCached=<span class="keyword">false</span>;
00090   <span class="keywordflow">throw</span> <span class="keyword">new</span> std::invalid_argument(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"not implemented"</span>));
00091 }
00092 
00093 
00094 <span class="keywordtype">void</span> LODTerrain::setHeight(Real x, Real y, Real h) <span class="keywordflow">throw</span>(std::out_of_range)
00095 {
00096   <span class="keywordflow">if</span> (renderer==0) <span class="keywordflow">throw</span> <span class="keyword">new</span> std::out_of_range(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"No terrain data loaded"</span>));
00097 
00098   <span class="keywordflow">if</span> ((x &lt; 0) || (x &gt; renderer-&gt;GetWidth()))
00099     <span class="keywordflow">throw</span> <span class="keyword">new</span> std::out_of_range(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"x out of range"</span>));
00100 
00101   <span class="keywordflow">if</span> ((y &lt; 0) || (y &gt; renderer-&gt;GetHeight()))
00102     <span class="keywordflow">throw</span> <span class="keyword">new</span> std::out_of_range(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"y out of range"</span>));
00103 
00104   <span class="comment">// implement !!!! need to add a set method to CLODTerrainRenderer (or a get index from x,y)</span>
00105 }
00106 
00107 <a class="code" href="namespacebase.html#a5">Real</a> LODTerrain::getHeight(Real x, Real y) <span class="keyword">const</span> <span class="keywordflow">throw</span>(std::out_of_range)
00108 {
00109   <span class="keywordflow">if</span> (renderer==0) <span class="keywordflow">throw</span> <span class="keyword">new</span> std::out_of_range(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"No terrain data loaded"</span>));
00110 
00111   <span class="keywordflow">if</span> ((x &lt; 0) || (x &gt; renderer-&gt;GetWidth()))
00112     <span class="keywordflow">throw</span> <span class="keyword">new</span> std::out_of_range(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"x out of range"</span>));
00113 
00114   <span class="keywordflow">if</span> ((y &lt; 0) || (y &gt; renderer-&gt;GetHeight()))
00115     <span class="keywordflow">throw</span> <span class="keyword">new</span> std::out_of_range(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"y out of range"</span>));
00116 
00117   <a class="code" href="classdemeter_1_1Terrain.html">gfx::CLODTerrainRenderer</a>* r = const_cast&lt;gfx::CLODTerrainRenderer*&gt;(&amp;(*renderer));  <span class="comment">// yuk!!!</span>
00118   <span class="keywordflow">return</span> r-&gt;<a class="code" href="classdemeter_1_1Terrain.html#demeter_1_1Terraina14">GetElevation</a>(x,y);
00119 }
00120 
00121 <a class="code" href="classbase_1_1Vector3.html">base::Dimension3</a> LODTerrain::getDimension()<span class="keyword"> const</span>
00122 <span class="keyword"></span>{
00123   <span class="keywordflow">return</span> boundingBox.getDimension();
00124 }
00125 
00126 BoundingBox LODTerrain::getBoundingBox()<span class="keyword"> const</span>
00127 <span class="keyword"></span>{
00128   <span class="keywordflow">if</span> (!boundsCached)
00129     computeBounds();
00130   <span class="keywordflow">return</span> boundingBox;
00131 }
00132 
00133 <a class="code" href="classphysics_1_1BoundingSphere.html">BoundingSphere</a> LODTerrain::getBoundingSphere()<span class="keyword"> const</span>
00134 <span class="keyword"></span>{
00135   <span class="keywordflow">if</span> (!boundsCached)
00136     computeBounds();
00137   <span class="keywordflow">return</span> boundingSphere;
00138 }
00139 
00140 
00141 <span class="keywordtype">void</span> LODTerrain::computeBounds()<span class="keyword"> const</span>
00142 <span class="keyword"></span>{
00143   <span class="keywordflow">if</span> (renderer!=0) {
00144     <a class="code" href="classbase_1_1Vector3.html">base::Dimension3</a> dim(<a class="code" href="classbase_1_1Vector3.html">base::Dimension3</a>(renderer-&gt;GetWidth(),
00145                                           renderer-&gt;GetHeight(),renderer-&gt;GetMaxElevation()));
00146     boundingBox.setCenter(<a class="code" href="classbase_1_1Vector3.html">base::Point3</a>());
00147     boundingBox.setDimension(dim);
00148     
00149     <a class="code" href="namespacebase.html#a5">Real</a> radius = Math::maximum(dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o0">x</a>,dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o1">y</a>,dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o2">z</a>)/2.0;
00150     boundingSphere = <a class="code" href="classphysics_1_1BoundingSphere.html">BoundingSphere</a>(<a class="code" href="classbase_1_1Vector3.html">base::Point3</a>(), radius);
00151     
00152   }
00153   <span class="keywordflow">else</span> {
00154     boundingBox = BoundingBox();
00155     boundingSphere = BoundingSphere();
00156   }
00157 
00158 }
00159 
00160 
00161 <span class="keyword">const</span> <a class="code" href="classphysics_1_1MassProperties.html">MassProperties</a>&amp; LODTerrain::getMassProperties(ref&lt;const Material&gt; material)<span class="keyword"> const</span>
00162 <span class="keyword"></span>{
00163   <span class="keywordflow">if</span> (massPropertiesCached &amp;&amp; (density == material-&gt;density()))
00164     <span class="keywordflow">return</span> massProperties;
00165 <span class="comment"></span>
00166 <span class="comment">  //!!! should we just make a mass properties that is infinite mass?</span>
00167 <span class="comment"></span>  <span class="comment">// the c.o.m. is not at the origin anyway</span>
00168   <span class="comment">// (of cource, c.o.m. at origin and valid mass properties would be best)</span>
00169   
00170   <span class="comment">// ANS: No.  Don't use the terrain as a dynamic object in physics or</span>
00171   <span class="comment">//  it may cause instability.  Specifically make it a fixed object</span>
00172 
00173   density = material-&gt;density();
00174 
00175   <span class="comment">// construct mass property from Tesselatable </span>
00176   massProperties = <a class="code" href="classphysics_1_1MassProperties.html">MassProperties</a>(<a class="code" href="classgfx_1_1VisualTriangles.html">gfx::VisualTriangles</a>(*<span class="keyword">this</span>), material);
00177   
00178   massPropertiesCached = <span class="keyword">true</span>;
00179   <span class="keywordflow">return</span> massProperties;
00180 }
00181 
00182 
00183 Segment3 LODTerrain::shortestSegmentBetween(<span class="keyword">const</span> <a class="code" href="classbase_1_1Transform.html">base::Transform</a>&amp; t, <span class="keyword">const</span> Point3&amp; p)<span class="keyword"> const</span>
00184 <span class="keyword"></span>{
00185   <a class="code" href="debugtools.html#a12">Unimplemented</a>;
00186 }
00187 
00188 
00189 Segment3 LODTerrain::shortestSegmentBetween(<span class="keyword">const</span> <a class="code" href="classbase_1_1Transform.html">base::Transform</a>&amp; t, <span class="keyword">const</span> <a class="code" href="classgfx_1_1Segment3.html">gfx::Segment3</a>&amp; s)<span class="keyword"> const</span>
00190 <span class="keyword"></span>{
00191   <a class="code" href="debugtools.html#a12">Unimplemented</a>;
00192 }
00193 
00194 
00195 Segment3 LODTerrain::shortestSegmentBetween(<span class="keyword">const</span> <a class="code" href="classbase_1_1Transform.html">base::Transform</a>&amp; t, <span class="keyword">const</span> <a class="code" href="classgfx_1_1Triangle3.html">gfx::Triangle3</a>&amp; tri)<span class="keyword"> const</span>
00196 <span class="keyword"></span>{
00197   <a class="code" href="debugtools.html#a12">Unimplemented</a>;
00198 }
00199 
00200 
00201 Segment3 LODTerrain::shortestSegmentBetween(<span class="keyword">const</span> <a class="code" href="classbase_1_1Transform.html">base::Transform</a>&amp; t, <span class="keyword">const</span> <a class="code" href="classgfx_1_1Quad3.html">gfx::Quad3</a>&amp; q)<span class="keyword"> const</span>
00202 <span class="keyword"></span>{
00203   <a class="code" href="debugtools.html#a12">Unimplemented</a>;
00204 }
00205 
00206 
00207 Segment3 LODTerrain::shortestSegmentBetween(<span class="keyword">const</span> <a class="code" href="classbase_1_1Transform.html">base::Transform</a>&amp; t1, ref&lt;const Shape&gt; s, <span class="keyword">const</span> <a class="code" href="classbase_1_1Transform.html">base::Transform</a>&amp; t2)<span class="keyword"> const</span>
00208 <span class="keyword"></span>{
00209   <a class="code" href="debugtools.html#a12">Unimplemented</a>;
00210 }
00211 
00212 
00213 
00214 
00215 osg::Node* LODTerrain::createOSGVisual(Attributes visualAttributes)<span class="keyword"> const</span>
00216 <span class="keyword"></span>{
00217   <span class="keywordflow">if</span> ((node!=0) &amp;&amp; (visualAttributes==attributes))
00218     <span class="keywordflow">return</span> &amp;(*node);
00219 
00220   <span class="keywordflow">if</span> (renderer==0) <span class="keywordflow">return</span> <span class="keyword">new</span> osg::Node; <span class="comment">// no terrain loaded</span>
00221 
00222   <span class="comment">// Create a osg::Geode and add the drawable to it</span>
00223   osg::Geode* geode = <span class="keyword">new</span> osg::Geode();
00224   geode-&gt;setName(<span class="stringliteral">"LODTerrain"</span>);
00225   geode-&gt;addDrawable( const_cast&lt;gfx::CLODTerrainDrawable*&gt;(&amp;(*drawable)) ); <span class="comment">// !!!</span>
00226 
00227   node = geode;
00228 
00229   <span class="keywordflow">return</span> &amp;(*node);
00230 }
00231 
00232 
00233 <span class="comment">// Collidable</span>
00234 <a class="code" href="classbase_1_1ref.html">base::ref&lt;CollisionModel&gt;</a> LODTerrain::getCollisionModel(CollisionModel::CollisionModelType modelType)<span class="keyword"> const</span>
00235 <span class="keyword"></span>{<span class="comment"></span>
00236 <span class="comment">  //!!!  throw std::runtime_error(Exception("not implemented")); </span>
00237 <span class="comment"></span>  <span class="keywordflow">if</span> ((collisionModel!=0) &amp;&amp; 
00238       ((this-&gt;modelType==modelType) || (modelType==CollisionModel::AnyModel)))
00239     <span class="keywordflow">return</span> collisionModel;
00240 
00241   collisionModel = Shape::getCollisionModel(modelType);
00242   this-&gt;modelType=modelType;
00243 
00244   <span class="keywordflow">return</span> collisionModel;
00245 }
00246 
00247 
00248  
00249 <span class="keywordtype">void</span> LODTerrain::serialize(<a class="code" href="classbase_1_1Serializer.html">base::Serializer</a>&amp; s)
00250 {
00251   <span class="keywordflow">throw</span> std::runtime_error(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"unimplemented"</span>));
00252 }
00253 
00254 
00255 
00256 <span class="keywordtype">bool</span> LODTerrain::formatSupported(String format, Real version, ExternalizationType type)<span class="keyword"> const</span>
00257 <span class="keyword"></span>{ 
00258   <span class="keywordflow">return</span> ( (format==<span class="stringliteral">"xml"</span>) &amp;&amp; (version==1.0) ); 
00259 }
00260 
00261 
00262 <span class="keywordtype">void</span> LODTerrain::externalize(<a class="code" href="classbase_1_1Externalizer.html">base::Externalizer</a>&amp; e, String format, Real version)
00263 {
00264   <span class="keywordflow">if</span> (format == <span class="stringliteral">""</span>) format = <span class="stringliteral">"xml"</span>;
00265                                                                                                                                                                                                     
00266   <span class="keywordflow">if</span> (!<a class="code" href="classphysics_1_1LODTerrain.html#physics_1_1LODTerraina22">formatSupported</a>(format,version,e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera6">ioType</a>()))
00267     <span class="keywordflow">throw</span> std::invalid_argument(<a class="code" href="base.html#a15">Exception</a>(<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"format "</span>)+format+<span class="stringliteral">" v"</span>+base::realToString(version)+<span class="stringliteral">" unsupported"</span>));
00268                                                                                                                                                                                                     
00269   <span class="keywordflow">if</span> (e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera4">isOutput</a>()) {
00270     <a class="code" href="debugtools.html#a12">Unimplemented</a>;                                                                                                                                                                                                 
00271   }
00272   <span class="keywordflow">else</span> {
00273     <a class="code" href="debugtools.html#a12">Unimplemented</a>;                                                                                                                                                                                                 
00274   }
00275 }
00276 
00277 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Jul 29 15:56:24 2004 for OpenSim by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.6 </small></address>
</body>
</html>
