<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>opensim/base/MemoryTracer.cpp~ Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.8.1 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>opensim/base/MemoryTracer.cpp~</h1><a href="MemoryTracer_8cpp~.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/****************************************************************************</font>
00002 <font class="comment">  Copyright (C)1996 David Jung &lt;djung@pobox.com&gt;</font>
00003 <font class="comment"></font>
00004 <font class="comment">  This program/file is free software; you can redistribute it and/or modify</font>
00005 <font class="comment">  it under the terms of the GNU General Public License as published by</font>
00006 <font class="comment">  the Free Software Foundation; either version 2 of the License, or</font>
00007 <font class="comment">  (at your option) any later version.</font>
00008 <font class="comment">  </font>
00009 <font class="comment">  This program is distributed in the hope that it will be useful,</font>
00010 <font class="comment">  but WITHOUT ANY WARRANTY; without even the implied warranty of</font>
00011 <font class="comment">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</font>
00012 <font class="comment">  GNU General Public License for more details. (http://www.gnu.org)</font>
00013 <font class="comment">  </font>
00014 <font class="comment">  You should have received a copy of the GNU General Public License</font>
00015 <font class="comment">  along with this program; if not, write to the Free Software</font>
00016 <font class="comment">  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</font>
00017 <font class="comment">  </font>
00018 <font class="comment">  $Id: MemoryTracer.cpp,v 1.1 2002/06/24 23:23:55 jungd Exp $</font>
00019 <font class="comment">  $Revision: 1.1 $</font>
00020 <font class="comment">  $Date: 2002/06/24 23:23:55 $</font>
00021 <font class="comment">  $Author: jungd $</font>
00022 <font class="comment"> </font>
00023 <font class="comment">****************************************************************************/</font>
00024 
00025 <font class="preprocessor">#include &lt;<a class="code" href="MemoryTracer.html">MemoryTracer</a>&gt;</font>
00026 
00027 <font class="preprocessor">#include &lt;string&gt;</font>
00028 <font class="preprocessor">#include &lt;iostream&gt;</font>
00029 
00030 <font class="keyword">using</font> std::string;
00031 
00032 <font class="keyword">using</font> <a class="code" href="classbase_1_1MemoryTracer.html">base::MemoryTracer</a>;
00033 
00034 
00035 
00036 <font class="comment">// if defined, will cause a menu to be displayed when a memory problem is</font>
00037 <font class="comment">//  detected (stopping the program)</font>
<a name="l00038"></a><a class="code" href="MemoryTracer_8cpp~.html#a0">00038</a> <font class="preprocessor">#define _INTERACTIVE_ </font>
00039 <font class="preprocessor"></font>
00040 <font class="comment">// if defined and not _INTERACTIVE_, then a memory problem will throw a</font>
00041 <font class="comment">//  std::bad_alloc exception (possibly from within new or delete)</font>
<a name="l00042"></a><a class="code" href="MemoryTracer_8cpp~.html#a1">00042</a> <font class="preprocessor">#define _THROWEXCEPTION_</font>
00043 <font class="preprocessor"></font>
00044 <font class="comment">// if defined, calls to allocate, validate, release &amp; invalidate will report arguments (on every call)</font>
00045 <font class="comment">//  (even more verbose that using _TRACEOUTPUT_ )</font>
00046 <font class="comment">//#define _MEMORYTRACEDEBUG_</font>
00047 
00048 
00049 
<a name="l00050"></a><a class="code" href="classbase_1_1MemoryTracer.html#q5">00050</a> base::Byte MemoryTracer::prefill[MemoryTracer::Filling]; <font class="comment">// Filler for integrity check</font>
<a name="l00051"></a><a class="code" href="classbase_1_1MemoryTracer.html#q6">00051</a> base::Byte MemoryTracer::initialized = 0;
<a name="l00052"></a><a class="code" href="classbase_1_1MemoryTracer.html#q7">00052</a> <font class="keywordtype">bool</font> MemoryTracer::cleanedUp = <font class="keyword">false</font>;
<a name="l00053"></a><a class="code" href="classbase_1_1MemoryTracer.html#q8">00053</a> Int MemoryTracer::entry = 0;
<a name="l00054"></a><a class="code" href="classbase_1_1MemoryTracer.html#q9">00054</a> Int MemoryTracer::fullCheckCounter = 0;
<a name="l00055"></a><a class="code" href="classbase_1_1MemoryTracer.html#q10">00055</a> base::LInt MemoryTracer::allocCount = 0;
<a name="l00056"></a><a class="code" href="classbase_1_1MemoryTracer.html#q11">00056</a> base::LInt MemoryTracer::deallocCount = 0;
<a name="l00057"></a><a class="code" href="classbase_1_1MemoryTracer.html#q12">00057</a> base::LInt MemoryTracer::checkCount = 0;
<a name="l00058"></a><a class="code" href="classbase_1_1MemoryTracer.html#q13">00058</a> MemoryTracer::AllocList MemoryTracer::mlist; <font class="comment">// the allocated memory list</font>
<a name="l00059"></a><a class="code" href="classbase_1_1MemoryTracer.html#q14">00059</a> MemoryTracer::AllocList MemoryTracer::dlist; <font class="comment">// list of memory allocated and then deallocated (so we can catch double delete's)</font>
<a name="l00060"></a><a class="code" href="classbase_1_1MemoryTracer.html#q15">00060</a> base::Byte MemoryTracer::postfill[Filling]; <font class="comment">// Filler for integrity check</font>
00061 
00062 
00063 <font class="keyword">inline</font> <font class="keywordtype">void</font> MemoryTracer::Logerr(<font class="keywordtype">char</font>* errstr)<font class="keyword"> </font>
00064 <font class="keyword"></font>{
00065   <font class="comment">// can't use base's Logln because that uses iostreams (which need new/delete)</font>
00066   <font class="keywordtype">char</font> str[256];
00067   sprintf(str,<font class="stringliteral">"MemoryTracer Log: %s\n"</font>,errstr);
00068   fprintf(stderr,str);
00069 }
00070 
00071 
00072 <font class="comment">// this is not meant to be an atomic lock, just something to help flag multiple thread entry</font>
00073 <font class="keyword">inline</font> <font class="keywordtype">void</font> MemoryTracer::entrylock()<font class="keyword"> </font>
00074 <font class="keyword"></font>{
00075   <font class="keywordflow">if</font> (entry != 0) {
00076     <a class="code" href="classbase_1_1MemoryTracer.html#e0">Logerr</a>(<font class="stringliteral">"Multiple thread entry detected!  MemoryTracer is not threadsafe - please restrict use to a single thread at a time."</font>);
00077     <a class="code" href="classbase_1_1MemoryTracer.html#d14">handleError</a>();
00078   }
00079   <font class="keywordflow">else</font>
00080     entry++;
00081 }
00082 
00083 <font class="keyword">inline</font> <font class="keywordtype">void</font> MemoryTracer::exitunlock()<font class="keyword"></font>
00084 <font class="keyword"></font>{
00085   entry--;
00086 }
00087 
00088 <font class="comment">//</font>
00089 <font class="comment">// Home grown doubly linked list</font>
00090 <font class="comment">//  (Unfortunately, MemoryTracer can't used STL because it must not call the global</font>
00091 <font class="comment">//   new or delete.  Using STL containers with malloc_alloc as their</font>
00092 <font class="comment">//   allocator should work - but, alas, it doesn't).</font>
00093 
00094 
00095 <font class="keywordtype">void</font> MemoryTracer::AllocList::push_front(AllocEntry* e)<font class="keyword"></font>
00096 <font class="keyword"></font>{
00097   <font class="keywordflow">if</font> (head == 0) {
00098     head = tail = e;
00099     e-&gt;next = e-&gt;prev = 0;
00100   }
00101   <font class="keywordflow">else</font> {
00102     AllocEntry* oldhead = head;
00103     head = e;
00104     head-&gt;next = oldhead;
00105     head-&gt;prev = 0;
00106     oldhead-&gt;prev = head;
00107   }
00108   len++;
00109 }
00110 
00111 
00112 <font class="keywordtype">void</font> MemoryTracer::AllocList::push_back(AllocEntry* e)<font class="keyword"></font>
00113 <font class="keyword"></font>{
00114   <font class="keywordflow">if</font> (head == 0) {
00115     head = tail = e;
00116     e-&gt;next = e-&gt;prev = 0;
00117   }
00118   <font class="keywordflow">else</font> {
00119     AllocEntry* oldtail = tail;
00120     tail = e;
00121     tail-&gt;next = 0;
00122     tail-&gt;prev = oldtail;
00123     oldtail-&gt;next = tail;
00124   }
00125   len++;
00126 }
00127 
00128 MemoryTracer::AllocEntry* MemoryTracer::AllocList::pop_front()<font class="keyword"></font>
00129 <font class="keyword"></font>{
00130   AllocEntry* oldhead = head;
00131   <font class="keywordflow">if</font> (head != 0) {
00132     head = head-&gt;next;
00133     <font class="keywordflow">if</font> (head)
00134       head-&gt;prev = 0;
00135     <font class="keywordflow">else</font>
00136       tail = 0;
00137     len--;
00138   }
00139   <font class="keywordflow">return</font> oldhead;
00140 }
00141 
00142 
00143 MemoryTracer::AllocEntry* MemoryTracer::AllocList::pop_back()<font class="keyword"></font>
00144 <font class="keyword"></font>{
00145   AllocEntry* oldtail = tail;
00146   <font class="keywordflow">if</font> (tail != 0) {
00147     tail = tail-&gt;prev;
00148     <font class="keywordflow">if</font> (tail)
00149       tail-&gt;next = 0;
00150     <font class="keywordflow">else</font>
00151       head = 0;
00152     len--;
00153   }
00154   <font class="keywordflow">return</font> oldtail;
00155 }
00156 
00157 
00158 <font class="keywordtype">void</font> MemoryTracer::AllocList::remove(AllocEntry* e)<font class="keyword"></font>
00159 <font class="keyword"></font>{
00160   <font class="keywordflow">if</font> (e == tail) {
00161     pop_back();
00162   }
00163   <font class="keywordflow">else</font> <font class="keywordflow">if</font> (e == head) {
00164     pop_front();
00165   }
00166   <font class="keywordflow">else</font> {
00167     e-&gt;next-&gt;prev = e-&gt;prev;
00168     e-&gt;prev-&gt;next = e-&gt;next;
00169     len--;
00170   }
00171 }
00172 
00173 
00174 MemoryTracer::AllocEntry* MemoryTracer::AllocList::find(<font class="keywordtype">void</font>* address, AllocEntry* from)<font class="keyword"> const</font>
00175 <font class="keyword"></font>{ 
00176   Byte* addr = (Byte*)address;
00177   AllocEntry* m = (from==0)?head:from;
00178   <font class="keywordflow">while</font> (m) {
00179     <font class="keywordflow">if</font> (!m-&gt;isExternal()) {
00180       <font class="keywordflow">if</font> (addr == m-&gt;address+Filling)
00181         <font class="keywordflow">return</font> m;
00182     }
00183     <font class="keywordflow">else</font>
00184       <font class="keywordflow">if</font> (addr == m-&gt;address)
00185         <font class="keywordflow">return</font> m;
00186     
00187     m = m-&gt;next;
00188   }
00189   <font class="keywordflow">return</font> 0;
00190 }
00191 
00192 
00193 
00194   <font class="keywordtype">void</font> MemoryTracer::menu() <font class="keywordflow">throw</font>(std::bad_alloc)
00195   {
00196     <font class="keywordtype">char</font> ans[32];
00197     <font class="keywordtype">bool</font> quit=<font class="keyword">false</font>;
00198     <font class="keywordflow">while</font> (!quit) {
00199       printf(<font class="stringliteral">"\n"</font>);
00200       printf(<font class="stringliteral">"Choose: (a)llocated memory list        (n)amed allocated memory\n"</font>);
00201       printf(<font class="stringliteral">"        (r)eciently deallocated memory (d)ivide by 0 crash (SIGFPE)\n"</font>);
00202       printf(<font class="stringliteral">"         e(x)it   (t)hrow bad_alloc    (c)continue? "</font>);
00203       scanf(<font class="stringliteral">"%s"</font>,ans);
00204       <font class="keywordflow">switch</font> (tolower(ans[0])) {
00205       <font class="keywordflow">case</font> <font class="charliteral">'a'</font>: dump(); <font class="keywordflow">break</font>;
00206       <font class="keywordflow">case</font> <font class="charliteral">'n'</font>: dumpNamed(); <font class="keywordflow">break</font>;
00207       <font class="keywordflow">case</font> <font class="charliteral">'r'</font>: dumpDeallocated(); <font class="keywordflow">break</font>;
00208       <font class="keywordflow">case</font> <font class="charliteral">'d'</font>: causefault(); <font class="keywordflow">break</font>;
00209       <font class="keywordflow">case</font> <font class="charliteral">'x'</font>: exit(-1); <font class="keywordflow">break</font>;
00210       <font class="keywordflow">case</font> <font class="charliteral">'t'</font>: <font class="keywordflow">throw</font> std::bad_alloc(); <font class="keywordflow">break</font>;
00211       <font class="keywordflow">case</font> <font class="charliteral">'c'</font>: quit=<font class="keyword">true</font>; <font class="keywordflow">break</font>;
00212       <font class="keywordflow">default</font>: ;
00213       }
00214     }
00215   }
00216 
00217 
00218   <font class="keywordtype">void</font> MemoryTracer::handleError() <font class="keywordflow">throw</font>(std::bad_alloc)
00219   {
00220 <font class="preprocessor">#ifdef _INTERACTIVE_</font>
00221 <font class="preprocessor"></font>    menu();
00222 <font class="preprocessor">#else</font>
00223 <font class="preprocessor"></font><font class="preprocessor">#ifdef _THROWEXCEPTION_</font>
00224 <font class="preprocessor"></font>    <font class="keywordflow">throw</font> std::bad_alloc();
00225 <font class="preprocessor">#endif</font>
00226 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
00227 <font class="preprocessor"></font>  }
00228 
00229 
00230   <font class="comment">// Does a dividie by zero - Debugger can catch this to provide a stack trace</font>
00231   <font class="keywordtype">int</font> MemoryTracer::causefault()<font class="keyword"> </font>
00232 <font class="keyword">  </font>{
00233     <font class="keywordtype">int</font> i=5, j=5;
00234     <font class="comment">// try not to let compiler optimise this out of existance </font>
00235     j = i/(j-i); <font class="comment">// Divide by 0 to get debugger's attention</font>
00236     <font class="keywordflow">return</font> j;
00237   }
00238   
00239   
00240   <font class="comment">// Checks all currently allocated memory for overwrites</font>
00241   <font class="keywordtype">bool</font> MemoryTracer::checkAllMemory() <font class="keywordflow">throw</font>(std::bad_alloc)
00242   {
00243     <font class="keywordtype">bool</font> ok = <font class="keyword">true</font>;
00244 <font class="preprocessor">#ifdef _TRACEMEMORY_</font>
00245 <font class="preprocessor"></font>    checkCount++;
00246     AllocEntry* m = mlist.front();
00247     <font class="keywordtype">int</font> size, i,j;
00248     <font class="keywordtype">char</font> errstr[256];
00249     
00250     <font class="keywordflow">while</font> (m) {
00251       <font class="keywordflow">if</font> (!m-&gt;isOK()) {
00252         Logerr(<font class="stringliteral">"Memory allocation record has been corrupted (AllocEntry)."</font>);
00253         <font class="keywordtype">bool</font> prefillOK = <font class="keyword">true</font>;
00254         <font class="keywordflow">for</font>(Int i=0; i&lt;Filling; i++) 
00255           <font class="keywordflow">if</font> (m-&gt;prefill[i] != Filler) prefillOK = <font class="keyword">false</font>;
00256         <font class="keywordtype">bool</font> postfillOK = <font class="keyword">true</font>;
00257         <font class="keywordflow">for</font>(Int i=0; i&lt;Filling; i++) 
00258           <font class="keywordflow">if</font> (m-&gt;postfill[i] != Filler) postfillOK = <font class="keyword">false</font>;
00259         sprintf(errstr,<font class="stringliteral">"Entry: prefill:%s postfill:%s size:%6d isMagic:%s"</font>,
00260                 prefillOK?<font class="stringliteral">"OK"</font>:<font class="stringliteral">"BAD"</font>, postfillOK?<font class="stringliteral">"OK"</font>:<font class="stringliteral">"BAD"</font>,m-&gt;size,m-&gt;isMagic()?<font class="stringliteral">"OK"</font>:<font class="stringliteral">"BAD"</font>);
00261         Logerr(errstr);
00262         m=0;
00263         ok=<font class="keyword">false</font>;
00264       } 
00265       <font class="keywordflow">else</font> {
00266         
00267         <font class="keywordflow">if</font> (!m-&gt;isExternal()) {
00268           Byte* mem = (Byte*)m-&gt;address;
00269           size = m-&gt;size;
00270           <font class="keywordflow">for</font>(i=0; (i&lt;Filling) &amp;&amp; ok; i++) {
00271             <font class="keywordflow">if</font> ( *(mem+i) != Filler ) {
00272               sprintf(errstr,<font class="stringliteral">"Memory before allocation %x (%s) has been overwritten"</font>,(Int)mem+Filling,m-&gt;name);
00273               <font class="keywordflow">for</font>(j=0; j&lt;Filling; j++) {
00274                 sprintf(errstr,<font class="stringliteral">"addr(m-%d) = %d (should be %d)"</font>,Filling-j,(<font class="keywordtype">unsigned</font> <font class="keywordtype">int</font>)*(mem+i),Filler);
00275                 Logerr(errstr);
00276               }
00277               ok=<font class="keyword">false</font>;
00278             }
00279             <font class="keywordflow">if</font> ( *(mem+Filling+size+i) != Filler ) {
00280               sprintf(errstr,<font class="stringliteral">"Memory after allocation %x (%s) has been overwritten"</font>,(Int)mem+Filling,m-&gt;name);
00281               Logerr(errstr);
00282               <font class="keywordflow">for</font>(j=0; j&lt;Filling; j++) {
00283                 sprintf(errstr,<font class="stringliteral">"addr(m+size+%d) = %d (should be %d)"</font>,j,(Int)*(mem+size+Filling+i),Filler);
00284                 Logerr(errstr);
00285               }
00286               ok=<font class="keyword">false</font>;
00287             }
00288             
00289           }
00290         } 
00291         
00292         m = m-&gt;next;
00293       }
00294       
00295     }
00296     
00297     <font class="keywordflow">if</font> (!ok) handleError();
00298 <font class="preprocessor">#endif    </font>
00299 <font class="preprocessor"></font>    <font class="keywordflow">return</font> ok;
00300   }
00301   
00302 
00303   <font class="comment">// allocate memory (returns 0 on error)</font>
00304   <font class="keywordtype">void</font>* MemoryTracer::allocate(<font class="keywordtype">int</font> size, <font class="keyword">const</font> string&amp; name, <font class="keywordtype">bool</font> isArray) <font class="keywordflow">throw</font>(std::bad_alloc)
00305   {
00306     entrylock();
00307     <font class="keywordflow">if</font> (!isOK()) {
00308       Logerr(<font class="stringliteral">"memory allocation records have been corrupted (MemoryTracer)."</font>);
00309       exitunlock();
00310       <font class="keywordflow">return</font> 0;
00311     }
00312 
00313     <font class="keywordtype">int</font> i;
00314     AllocEntry* ne;
00315     <font class="keywordflow">if</font> (size &lt;= 0) {
00316       Logerr(<font class="stringliteral">"passed size &lt;= 0."</font>);
00317       handleError();
00318       <font class="keywordflow">return</font> 0;
00319     }
00320     <font class="keywordtype">void</font>* mem = malloc(size + Filling*2);
00321     <font class="keywordflow">if</font> (mem == 0) <font class="keywordflow">return</font> 0;
00322 
00323 <font class="preprocessor">#if (_FULLCHECKFREQUENTY_ &gt; 0)</font>
00324 <font class="preprocessor"></font>    <font class="keywordflow">if</font> ((++fullCheckCounter % _FULLCHECKFREQUENTY_) == 0) {
00325       fullCheckCounter=0;
00326       checkAllMemory();
00327     }
00328 <font class="preprocessor">#endif</font>
00329 <font class="preprocessor"></font>
00330     ne = (AllocEntry*)malloc(<font class="keyword">sizeof</font>(AllocEntry));
00331     <font class="keywordflow">if</font> (ne == 0) {
00332       free(mem);
00333       Logerr(<font class="stringliteral">"no memory available to allocate (for entry)."</font>);
00334       <font class="keywordflow">return</font> 0;
00335     }
00336     ne-&gt;fill();
00337 
00338     <font class="comment">// fill 'Filling' bytes before and after returned memory area with 'Filler' byte </font>
00339     <font class="keywordflow">for</font>(i=0; i&lt; Filling; i++) {
00340       *(((Byte*)mem)+i) = Filler;
00341       *(((Byte*)mem)+size+Filling+i) = Filler;
00342     }
00343 
00344     ne-&gt;size = size;
00345     ne-&gt;name = 0;
00346     ne-&gt;isArray = isArray;
00347     
00348     <font class="keywordflow">if</font> (name.size() &gt; 0) {
00349       ne-&gt;name = (<font class="keywordtype">char</font>*)malloc(name.size()+1);
00350       <font class="keywordflow">if</font> (ne-&gt;name == 0) {
00351         Logerr(<font class="stringliteral">"no memory available to allocate name."</font>);
00352       }
00353       <font class="keywordflow">else</font>
00354         strcpy(ne-&gt;name, name.c_str());
00355     }
00356 
00357     ne-&gt;setMagic();
00358     ne-&gt;address = (Byte*)mem;
00359 
00360     mlist.push_front(ne);
00361     
00362     allocCount++;
00363     exitunlock();
00364     <font class="keywordtype">void</font>* addr = ((Byte*)mem)+Filling;
00365 <font class="preprocessor">#ifdef _MEMORYTRACEDEBUG_</font>
00366 <font class="preprocessor"></font>    <font class="keywordtype">char</font> logstr[80];
00367     sprintf(logstr, <font class="stringliteral">"allocated(size:%d, name:%s, isArray:%s) = %x"</font>, size, (name.size()&gt;0)?name.c_str():"&lt;unnamed&gt;",isArray?"TRUE":"FALSE",Int(addr));
00368     Logerr(logstr);
00369 <font class="preprocessor">#endif</font>
00370 <font class="preprocessor"></font>    <font class="keywordflow">return</font> addr;
00371   }
00372   
00373 
00374 
00375   <font class="comment">// registers an externally allocated region as valid (for Checks).</font>
00376   <font class="keywordtype">bool</font> MemoryTracer::validate(<font class="keywordtype">void</font>* address, <font class="keywordtype">int</font> size, <font class="keyword">const</font> string&amp; name) <font class="keywordflow">throw</font>(std::bad_alloc)
00377   {
00378     entrylock();
00379     <font class="keywordflow">if</font> (!isOK()) {
00380       Logerr(<font class="stringliteral">"memory allocation records have been corrupted."</font>);
00381       exitunlock();
00382       <font class="keywordflow">return</font> <font class="keyword">false</font>;
00383     }
00384 
00385     AllocEntry* ne;
00386     <font class="keywordtype">char</font> errstr[256];
00387 
00388     <font class="keywordflow">if</font> (size &lt; 0) {
00389       Logerr(<font class="stringliteral">"passed size &lt; 0."</font>);
00390       exitunlock();
00391       handleError();
00392       <font class="keywordflow">return</font> <font class="keyword">false</font>;
00393     }
00394     
00395 <font class="preprocessor">#if (_FULLCHECKFREQUENTY_ &gt; 0)</font>
00396 <font class="preprocessor"></font>    <font class="keywordflow">if</font> ((++fullCheckCounter % _FULLCHECKFREQUENTY_) == 0) {
00397       fullCheckCounter=0;
00398       checkAllMemory();
00399     }
00400 <font class="preprocessor">#endif</font>
00401 <font class="preprocessor"></font>    
00402     <font class="comment">// first look to see if this address is already registered as valid,</font>
00403     <font class="comment">// if so, return - nothing more to do </font>
00404     AllocEntry* m = mlist.find(address);
00405     <font class="keywordflow">if</font> (m) {
00406       <font class="keywordflow">if</font> (!m-&gt;isExternal()) {
00407         <font class="keywordflow">if</font> (address == m-&gt;address + Filling) {
00408           sprintf(errstr,<font class="stringliteral">"memory at address %x (%s) was allocated with allocate(), so cannot be validated with validate()\n"</font>,
00409                   <a class="code" href="namespace__base.html#a2">Int</a>(m-&gt;address+Filling),(m-&gt;name==0)?<font class="stringliteral">"&lt;unnamed&gt;"</font>:m-&gt;name);
00410           Logerr(errstr);
00411           exitunlock();
00412           <font class="keywordflow">return</font> <font class="keyword">false</font>;
00413         }
00414       }
00415       <font class="keywordflow">else</font>
00416         <font class="keywordflow">if</font> (address == m-&gt;address) {
00417           exitunlock();
00418           <font class="keywordflow">return</font> <font class="keyword">true</font>;
00419         }
00420     }
00421     
00422     ne = (AllocEntry*)malloc(<font class="keyword">sizeof</font>(AllocEntry));
00423     <font class="keywordflow">if</font> (ne == 0) {
00424       Logerr(<font class="stringliteral">"no memory available to allocate (for entry)."</font>);
00425       exitunlock();
00426       <font class="keywordflow">return</font> <font class="keyword">false</font>;
00427     }
00428     
00429     ne-&gt;size = size;
00430     ne-&gt;name = 0;
00431 
00432     <font class="keywordflow">if</font> (name.size() &gt; 0) {
00433       ne-&gt;name = (<font class="keywordtype">char</font>*)malloc(name.size()+1);
00434       <font class="keywordflow">if</font> (ne-&gt;name == 0) {
00435         Logerr(<font class="stringliteral">"no memory available to allocate (for name)."</font>);
00436       }
00437       <font class="keywordflow">else</font>
00438         strcpy(ne-&gt;name, name.c_str());
00439       
00440     }
00441     ne-&gt;setMagic();
00442     ne-&gt;setExternal();
00443     ne-&gt;isArray = <font class="keyword">false</font>;
00444     ne-&gt;address = (Byte*)address;
00445     
00446     mlist.push_front(ne);
00447 
00448     exitunlock();
00449 
00450 <font class="preprocessor">#ifdef _MEMORYTRACEDEBUG_</font>
00451 <font class="preprocessor"></font>    <font class="keywordtype">char</font> logstr[80];
00452     sprintf(logstr, <font class="stringliteral">"validated(address:%x, size:%d, name:%s)"</font>, <a class="code" href="namespace__base.html#a2">Int</a>(address), size, (name.size()&gt;0)?name.c_str():"&lt;unnamed&gt;");
00453     Logerr(logstr);
00454 <font class="preprocessor">#endif</font>
00455 <font class="preprocessor"></font>
00456     <font class="keywordflow">return</font> <font class="keyword">true</font>;
00457   }
00458   
00459   
00460 
00461   <font class="comment">// free allocated memory</font>
00462   <font class="keywordtype">bool</font> MemoryTracer::release(<font class="keywordtype">void</font>* address, <font class="keywordtype">bool</font> isArray, <font class="keywordtype">int</font> size) <font class="keywordflow">throw</font>(std::bad_alloc)
00463   {
00464     entrylock();
00465     <font class="keywordflow">if</font> (!isOK()) {
00466       Logerr(<font class="stringliteral">"memory allocation records have been corrupted."</font>);
00467       exitunlock();
00468       <font class="keywordflow">return</font> <font class="keyword">false</font>;
00469     }
00470 
00471     <font class="keywordflow">if</font> (cleanedUp) <font class="keywordflow">return</font> <font class="keyword">true</font>;
00472 
00473     Byte* addr = (Byte*)address;
00474     <font class="keywordtype">char</font> errstr[256];
00475 
00476 <font class="preprocessor">#if (_FULLCHECKFREQUENTY_ &gt; 0)</font>
00477 <font class="preprocessor"></font>    <font class="keywordflow">if</font> ((++fullCheckCounter % _FULLCHECKFREQUENTY_) == 0) {
00478       fullCheckCounter=0;
00479       checkAllMemory();
00480     }
00481 <font class="preprocessor">#endif</font>
00482 <font class="preprocessor"></font>    
00483     AllocEntry* m = mlist.find(address);
00484     <font class="keywordtype">bool</font> found = (m!=0);
00485     <font class="keywordtype">char</font> name[128];
00486     strcpy(name, <font class="stringliteral">"&lt;unknown&gt;"</font>);
00487 
00488     <font class="keywordflow">if</font> (found) {
00489       
00490       <font class="keywordflow">if</font> (addr == m-&gt;address+Filling) {
00491         <font class="keywordflow">if</font> ((size!=-1) &amp;&amp; (size!=m-&gt;size)) {
00492           sprintf(errstr,<font class="stringliteral">"size given (%d) for region at %x doesn't match that allocated (%d)"</font>,
00493                   size,<a class="code" href="namespace__base.html#a2">Int</a>(address),m-&gt;size);
00494           Logerr(errstr);
00495         }
00496         <font class="keywordflow">if</font> (m-&gt;isArray != isArray) {
00497           <font class="keywordflow">if</font> (m-&gt;isArray) {
00498             sprintf(errstr,<font class="stringliteral">"region at %x was allocated as an array but not free'd as one"</font>,
00499                     <a class="code" href="namespace__base.html#a2">Int</a>(address));
00500             Logerr(errstr);
00501             handleError();
00502           }
00503           <font class="keywordflow">else</font> {
00504             sprintf(errstr,<font class="stringliteral">"region at %x was free'd as an array but not allocated as one"</font>,
00505                     <a class="code" href="namespace__base.html#a2">Int</a>(address));
00506             Logerr(errstr);
00507             handleError();
00508           }
00509         }
00510         
00511 <font class="preprocessor">#ifdef _MEMORYTRACEDEBUG_</font>
00512 <font class="preprocessor"></font>        <font class="keywordflow">if</font> (m-&gt;name)
00513           strncpy(name, m-&gt;name, 127);
00514 <font class="preprocessor">#endif</font>
00515 <font class="preprocessor"></font>        
00516         <font class="comment">// remove from list </font>
00517         mlist.remove(m);
00518 
00519         free(m-&gt;address); <font class="comment">// free memory</font>
00520 
00521         dlist.push_front(m); <font class="comment">// add to deallocated list</font>
00522         <font class="keywordflow">if</font> (dlist.size() &gt; DList_Max) {
00523           AllocEntry* dm = dlist.pop_back();
00524           <font class="keywordflow">if</font> (dm-&gt;name!=0) 
00525             free(dm-&gt;name);
00526           free(dm);
00527         }
00528       }
00529       <font class="keywordflow">else</font> {
00530         <font class="keywordflow">if</font> ((addr == m-&gt;address) &amp;&amp; (m-&gt;isExternal())) {
00531           sprintf(errstr,<font class="stringliteral">"memory at address %x was not allocated with allocate(), but was validated with validate(). (will invalidate without freeing)."</font>,(Int)address);
00532           Logerr(errstr);
00533           exitunlock();
00534           invalidate(address,size);
00535           entrylock();
00536         }
00537       }
00538     }
00539     <font class="keywordflow">else</font> { <font class="comment">// not found</font>
00540       sprintf(errstr,<font class="stringliteral">"no memory allocated at address %x."</font>,(Int)address);
00541       Logerr(errstr);
00542 
00543       <font class="comment">// check to see if the memory was previously deallocated</font>
00544       AllocEntry* from = dlist.front();
00545       AllocEntry* dm;
00546       <font class="keywordflow">do</font> {
00547         dm = dlist.find(address,from);
00548         <font class="keywordflow">if</font> (dm) {
00549           Byte* addr = (dm-&gt;isExternal()?dm-&gt;address:dm-&gt;address+Filling);
00550           sprintf(errstr,<font class="stringliteral">"memory was previously allocated at address %x as %s (size %d) - but has since been deallocated."</font>,
00551                   <a class="code" href="namespace__base.html#a2">Int</a>(addr),((dm-&gt;name==0)?<font class="stringliteral">"&lt;unnamed&gt;"</font>:dm-&gt;name),dm-&gt;size);
00552           Logerr(errstr);
00553           from = dm-&gt;next;
00554           <font class="keywordflow">if</font> (from==0) from = dlist.back();
00555         }
00556       } <font class="keywordflow">while</font> (dm);
00557 
00558       <font class="comment">//dump();</font>
00559       checkAllMemory();
00560       exitunlock();
00561       handleError();
00562       <font class="keywordflow">return</font> found;
00563     }
00564 
00565     deallocCount++;
00566     exitunlock();
00567 
00568 <font class="preprocessor">#ifdef _MEMORYTRACEDEBUG_</font>
00569 <font class="preprocessor"></font>    <font class="keywordtype">char</font> logstr[80];
00570     sprintf(logstr, <font class="stringliteral">"released(address:%x, isArray:%s, size:%6d, name:%s)"</font>, <a class="code" href="namespace__base.html#a2">Int</a>(address), isArray?<font class="stringliteral">"TRUE"</font>:<font class="stringliteral">"FALSE"</font>, size, name);
00571     Logerr(logstr);
00572 <font class="preprocessor">#endif</font>
00573 <font class="preprocessor"></font>
00574     <font class="keywordflow">return</font> found;
00575   }
00576   
00577 
00578 
00579   <font class="comment">// invalidate externally allocated region, previously registered</font>
00580   <font class="comment">//   with validate()</font>
00581   <font class="keywordtype">bool</font> MemoryTracer::invalidate(<font class="keywordtype">void</font>* address, <font class="keywordtype">int</font> size) <font class="keywordflow">throw</font>(std::bad_alloc)
00582   {
00583     entrylock();
00584     <font class="keywordflow">if</font> (!isOK()) {
00585       Logerr(<font class="stringliteral">"memory allocation records have been corrupted."</font>);
00586       exitunlock();
00587       <font class="keywordflow">return</font> <font class="keyword">false</font>;
00588     }
00589 
00590     <font class="keywordflow">if</font> (cleanedUp) <font class="keywordflow">return</font> <font class="keyword">true</font>;
00591 
00592     Byte* addr = (Byte*)address;
00593     <font class="keywordtype">char</font> errstr[256];
00594     
00595 <font class="preprocessor">#if (_FULLCHECKFREQUENTY_ &gt; 0)</font>
00596 <font class="preprocessor"></font>    <font class="keywordflow">if</font> ((++fullCheckCounter % _FULLCHECKFREQUENTY_) == 0) {
00597       fullCheckCounter=0;
00598       checkAllMemory();
00599     }
00600 <font class="preprocessor">#endif</font>
00601 <font class="preprocessor"></font>
00602     AllocEntry* m = mlist.find(address);
00603     <font class="keywordtype">bool</font> found = (m!=0);
00604     <font class="keywordtype">char</font> name[128];
00605     strcpy(name, <font class="stringliteral">"&lt;unknown&gt;"</font>);
00606 
00607     <font class="keywordflow">if</font> (found) {
00608       
00609       <font class="keywordflow">if</font> (addr == m-&gt;address) {
00610         <font class="keywordflow">if</font> ((size!=-1) &amp;&amp; (size!=m-&gt;size)) {
00611           sprintf(errstr,<font class="stringliteral">"size given (%d) doesn't match that validated (%d)."</font>,size,m-&gt;size);
00612           Logerr(errstr);
00613         }
00614 
00615         <font class="comment">// remove from list </font>
00616 <font class="preprocessor">#ifdef _MEMORYTRACEDEBUG_</font>
00617 <font class="preprocessor"></font>        <font class="keywordflow">if</font> (m-&gt;name)
00618           strncpy(name, m-&gt;name, 127);
00619 <font class="preprocessor">#endif</font>
00620 <font class="preprocessor"></font>        mlist.remove(m);
00621         <font class="keywordflow">if</font> (m-&gt;name != 0) free(m-&gt;name);
00622         free(m);
00623       }
00624       <font class="keywordflow">else</font> {
00625         <font class="keywordflow">if</font> ((addr == m-&gt;address+Filling) &amp;&amp; (!m-&gt;isExternal())) {
00626           sprintf(errstr,<font class="stringliteral">"memory at address %x was allocated with allocate(), not validated with validate()."</font>,(Int)address);
00627           Logerr(errstr);
00628         }
00629       }
00630       
00631     }
00632     <font class="keywordflow">else</font> { <font class="comment">// !found</font>
00633       sprintf(errstr,<font class="stringliteral">"no memory validated at address %x."</font>,(Int)address);
00634       Logerr(errstr);
00635       exitunlock();
00636       handleError();
00637       <font class="keywordflow">return</font> found;
00638     }
00639 
00640     exitunlock();
00641 
00642 <font class="preprocessor">#ifdef _MEMORYTRACEDEBUG_</font>
00643 <font class="preprocessor"></font>    <font class="keywordtype">char</font> logstr[80];
00644     sprintf(logstr, <font class="stringliteral">"invalidated(address:%x, size:%6d, name:%s)"</font>, <a class="code" href="namespace__base.html#a2">Int</a>(address), size, name);
00645     Logerr(logstr);
00646 <font class="preprocessor">#endif</font>
00647 <font class="preprocessor"></font>
00648     <font class="keywordflow">return</font> found;
00649   }
00650   
00651   
00652   <font class="comment">// Check that addr &amp; addr+typesize-1 are within an </font>
00653   <font class="comment">//    allocated memory area</font>
00654   <font class="keywordtype">void</font>* MemoryTracer::checkAddrRange(<font class="keywordtype">void</font>* address, <font class="keywordtype">long</font> typesize) <font class="keywordflow">throw</font>(std::bad_alloc)
00655   {
00656     checkAddr(address, address, <font class="keyword">true</font>);
00657     <font class="keywordflow">if</font> (typesize&gt;0) checkAddr( ((<font class="keywordtype">char</font>*)address)+typesize-1, address, <font class="keyword">false</font>);
00658     <font class="keywordflow">return</font> address;
00659   }
00660 
00661 
00662   <font class="comment">// Check that addr is within an allocated memory area</font>
00663   <font class="keywordtype">bool</font> MemoryTracer::checkAddr(<font class="keywordtype">void</font>* address, <font class="keywordtype">void</font>* reportAddr, <font class="keywordtype">bool</font> checkAllMemory) <font class="keywordflow">throw</font>(std::bad_alloc)
00664   {
00665     <font class="keywordtype">bool</font> found=<font class="keyword">false</font>;
00666     Byte *addr = (Byte*)address;
00667     <font class="keywordtype">char</font> errstr[256];
00668     AllocEntry* m = mlist.front();
00669     
00670     <font class="keywordflow">if</font> (checkAllMemory) MemoryTracer::checkAllMemory();
00671 
00672     <font class="keywordflow">if</font> (reportAddr == 0) reportAddr = address;
00673     
00674     <font class="keywordflow">while</font> (m &amp;&amp; !found) {
00675       <font class="keywordflow">if</font> (!m-&gt;isExternal()) {
00676         
00677         <font class="keywordflow">if</font> ((m-&gt;address &lt;= addr) &amp;&amp; (addr &lt; m-&gt;address+Filling*2+m-&gt;size)) { <font class="comment">// it's within greater area </font>
00678           
00679           <font class="keywordflow">if</font> ((m-&gt;address+Filling &lt;= addr) &amp;&amp; (addr &lt; m-&gt;address+Filling+m-&gt;size)) <font class="comment">// within valid area? </font>
00680             found=<font class="keyword">true</font>;
00681           <font class="keywordflow">else</font> { <font class="comment">// must be in one of filling areas </font>
00682             <font class="keywordflow">if</font> ((m-&gt;address &lt;= addr) &amp;&amp; (addr &lt; m-&gt;address+Filling)) {
00683               <font class="keywordflow">if</font> (address == reportAddr) {
00684                 sprintf(errstr,<font class="stringliteral">"reference address %x is before memory area at %x (size %d) (%s)."</font>,
00685                         <a class="code" href="namespace__base.html#a2">Int</a>(addr), <a class="code" href="namespace__base.html#a2">Int</a>(m-&gt;address+Filling), m-&gt;size, m-&gt;name);
00686                 Logerr(errstr);
00687               }
00688               <font class="keywordflow">else</font> {
00689                 sprintf(errstr,<font class="stringliteral">"reference to address %x may allow to access address %x which is before memory area at %x (size %d) (%s)."</font>,
00690                         <a class="code" href="namespace__base.html#a2">Int</a>(reportAddr), <a class="code" href="namespace__base.html#a2">Int</a>(addr), <a class="code" href="namespace__base.html#a2">Int</a>(m-&gt;address+Filling), m-&gt;size, m-&gt;name);
00691                 Logerr(errstr);
00692               }
00693             }
00694             <font class="keywordflow">else</font> { <font class="comment">// must be after then </font>
00695               <font class="keywordflow">if</font> (address == reportAddr) {
00696                 sprintf(errstr,<font class="stringliteral">"reference address %x is after memory area at %x (size %d) (%s)."</font>,
00697                         <a class="code" href="namespace__base.html#a2">Int</a>(addr), <a class="code" href="namespace__base.html#a2">Int</a>(m-&gt;address+Filling), m-&gt;size, m-&gt;name);
00698                 Logerr(errstr);
00699               }
00700               <font class="keywordflow">else</font> {
00701                 sprintf(errstr,<font class="stringliteral">"reference to address %x may allow to access address %x which is after memory area at %x (size %d) (%s)\n"</font>,
00702                         <a class="code" href="namespace__base.html#a2">Int</a>(reportAddr), <a class="code" href="namespace__base.html#a2">Int</a>(addr), <a class="code" href="namespace__base.html#a2">Int</a>(m-&gt;address+Filling), m-&gt;size, m-&gt;name);
00703                 Logerr(errstr);
00704               }
00705             }
00706             
00707           }
00708         }
00709       } <font class="keywordflow">else</font> { <font class="comment">// external </font>
00710         <font class="keywordflow">if</font> ((m-&gt;address &lt;= addr) &amp;&amp; (addr &lt; m-&gt;address+m-&gt;size))
00711           found = <font class="keyword">true</font>;
00712       }
00713       
00714       m = m-&gt;next;
00715     }
00716     <font class="keywordflow">if</font> (!found) {
00717       <font class="keywordflow">if</font> (address == reportAddr) {
00718         sprintf(errstr,<font class="stringliteral">"reference to invalid memory address %x detected."</font>,<a class="code" href="namespace__base.html#a2">Int</a>(addr));
00719         Logerr(errstr);
00720       }
00721       <font class="keywordflow">else</font> {
00722         sprintf(errstr,<font class="stringliteral">"detected reference to address %x that may allow access to invalid address %x."</font>,<a class="code" href="namespace__base.html#a2">Int</a>(reportAddr), <a class="code" href="namespace__base.html#a2">Int</a>(addr));
00723         Logerr(errstr);
00724       }
00725       handleError();
00726       <font class="keywordflow">return</font> <font class="keyword">false</font>;
00727   }
00728     
00729     <font class="keywordflow">return</font> <font class="keyword">true</font>;
00730   }
00731   
00732 
00733   <font class="keywordtype">char</font>* MemoryTracer::getName(<font class="keywordtype">void</font>* addr)<font class="keyword"> </font>
00734 <font class="keyword">  </font>{
00735     AllocEntry* m = mlist.<a class="code" href="classbase_1_1MemoryTracer_1_1AllocList.html#a5">front</a>();
00736     <font class="keywordtype">bool</font> found=<font class="keyword">false</font>;
00737     AllocEntry* entry = 0;
00738     <font class="keywordflow">while</font> (m &amp;&amp; !found) {
00739       <font class="keywordflow">if</font> (!m-&gt;isExternal()) {
00740         
00741         <font class="keywordflow">if</font> ((m-&gt;address &lt;= addr) &amp;&amp; (addr &lt; m-&gt;address+Filling*2+m-&gt;size)) { <font class="comment">// it's within greater area </font>
00742           
00743           <font class="keywordflow">if</font> ((m-&gt;address+Filling &lt;= addr) &amp;&amp; (addr &lt; m-&gt;address+Filling+m-&gt;size)) { <font class="comment">// within valid area? </font>
00744             found=<font class="keyword">true</font>;
00745             entry = m;
00746           }
00747         }
00748       } <font class="keywordflow">else</font> { <font class="comment">// external </font>
00749         <font class="keywordflow">if</font> ((m-&gt;address &lt;= addr) &amp;&amp; (addr &lt; m-&gt;address+m-&gt;size)) {
00750           found = <font class="keyword">true</font>;
00751           entry=m;
00752         }
00753       }
00754       
00755       m = m-&gt;next;
00756     }
00757     
00758     <font class="keywordflow">if</font> (found)
00759       <font class="keywordflow">return</font> entry-&gt;name;
00760     <font class="keywordflow">else</font>
00761       <font class="keywordflow">return</font> 0;
00762   }
00763 
00764 
00765   <font class="keywordtype">long</font> MemoryTracer::getOffset(<font class="keywordtype">void</font>* addr)<font class="keyword"> </font>
00766 <font class="keyword">  </font>{
00767     AllocEntry* m = mlist.<a class="code" href="classbase_1_1MemoryTracer_1_1AllocList.html#a5">front</a>();
00768     <font class="keywordtype">bool</font> found=<font class="keyword">false</font>;
00769 
00770     <font class="keywordtype">long</font> offset=-1;
00771     <font class="keywordflow">while</font> (m &amp;&amp; !found) {
00772       <font class="keywordflow">if</font> (!m-&gt;isExternal()) {
00773         
00774         <font class="keywordflow">if</font> ((m-&gt;address &lt;= addr) &amp;&amp; (addr &lt; m-&gt;address+Filling*2+m-&gt;size)) { <font class="comment">// it's within greater area </font>
00775           
00776           <font class="keywordflow">if</font> ((m-&gt;address+Filling &lt;= addr) &amp;&amp; (addr &lt; m-&gt;address+Filling+m-&gt;size)) { <font class="comment">// within valid area? </font>
00777             found=<font class="keyword">true</font>;
00778             offset = (Byte*)addr - (m-&gt;address+Filling);
00779           }
00780         }
00781       } <font class="keywordflow">else</font> { <font class="comment">// external </font>
00782         <font class="keywordflow">if</font> ((m-&gt;address &lt;= addr) &amp;&amp; (addr &lt; m-&gt;address+m-&gt;size)) {
00783           found = <font class="keyword">true</font>;
00784           offset = (Byte*)addr - m-&gt;address;
00785         }
00786       }
00787       
00788       m = m-&gt;next;
00789     }
00790     
00791     <font class="keywordflow">return</font> offset;
00792   }
00793 
00794 
00795   <font class="comment">// free all allocated memory</font>
00796   <font class="keywordtype">bool</font> MemoryTracer::cleanup()<font class="keyword"></font>
00797 <font class="keyword">  </font>{
00798 <font class="preprocessor">#ifdef _TRACEMEMORY_</font>
00799 <font class="preprocessor"></font>    printf(<font class="stringliteral">"(Cleanup: %ld allocations, %ld deallocations, %ld integrity checks performed)\n"</font>,allocCount,deallocCount,checkCount);
00800 
00801     <font class="keywordtype">char</font> errstr[256];
00802     <font class="keywordflow">if</font> (mlist.<a class="code" href="classbase_1_1MemoryTracer_1_1AllocList.html#a7">size</a>() &gt; 0) {
00803       <a class="code" href="classbase_1_1MemoryTracer.html#d11">dump</a>();
00804       sprintf(errstr,<font class="stringliteral">"Freeing %d leaked memory allocations"</font>,mlist.<a class="code" href="classbase_1_1MemoryTracer_1_1AllocList.html#a7">size</a>());
00805       <a class="code" href="classbase_1_1MemoryTracer.html#e0">Logerr</a>(errstr);
00806       <font class="keywordflow">while</font> (mlist.<a class="code" href="classbase_1_1MemoryTracer_1_1AllocList.html#a7">size</a>() &gt; 0) {
00807         AllocEntry* m = mlist.<a class="code" href="classbase_1_1MemoryTracer_1_1AllocList.html#a3">pop_front</a>();
00808         <font class="keywordflow">if</font> (m-&gt;name != 0) free(m-&gt;name);
00809         <font class="keywordflow">if</font> (!m-&gt;isExternal()) free(m-&gt;address);
00810         free(m);
00811       }
00812     }
00813 
00814     <font class="keywordflow">while</font> (dlist.<a class="code" href="classbase_1_1MemoryTracer_1_1AllocList.html#a7">size</a>() &gt; 0) {
00815       AllocEntry* m = dlist.<a class="code" href="classbase_1_1MemoryTracer_1_1AllocList.html#a3">pop_front</a>();
00816       <font class="keywordflow">if</font> (m-&gt;name != 0) free(m-&gt;name);
00817       free(m);
00818     }
00819 <font class="preprocessor">#endif    </font>
00820 <font class="preprocessor"></font>    cleanedUp = <font class="keyword">true</font>;
00821     <font class="keywordflow">return</font> <font class="keyword">true</font>;
00822   }
00823 
00824   <font class="comment">// display allocated memory areas</font>
00825   <font class="keywordtype">void</font> MemoryTracer::dump()<font class="keyword"> </font>
00826 <font class="keyword">  </font>{
00827 <font class="preprocessor">#ifdef _TRACEMEMORY_</font>
00828 <font class="preprocessor"></font>    AllocEntry* m = mlist.<a class="code" href="classbase_1_1MemoryTracer_1_1AllocList.html#a5">front</a>();
00829     
00830     <a class="code" href="classbase_1_1MemoryTracer.html#d6">checkAllMemory</a>();
00831     
00832     printf(<font class="stringliteral">"\nValid memory regions (%d):\n"</font>,mlist.<a class="code" href="classbase_1_1MemoryTracer_1_1AllocList.html#a7">size</a>());
00833     printf(<font class="stringliteral">"(%ld allocations, %ld deallocations, %ld integrity checks performed)\n"</font>,allocCount,deallocCount,checkCount);
00834     printf(<font class="stringliteral">"----------------------------------------------------------------------------------\n"</font>);
00835     
00836     <font class="keywordflow">while</font>(m) {
00837       <font class="keywordflow">if</font> (m-&gt;isOK()) {
00838         printf(<font class="stringliteral">"%52s: %10x (%9d) %s %s\n"</font>, (m-&gt;name==0)?<font class="stringliteral">"&lt;unnamed&gt;"</font>:m-&gt;name, <a class="code" href="namespace__base.html#a2">Int</a>(m-&gt;address+Filling), 
00839                m-&gt;size,(m-&gt;isArray?<font class="stringliteral">"[]"</font>:<font class="stringliteral">"  "</font>),m-&gt;isExternal()?<font class="stringliteral">"EXT"</font>:<font class="stringliteral">""</font>);
00840         m = m-&gt;next;
00841       }
00842       <font class="keywordflow">else</font> {
00843         <a class="code" href="classbase_1_1MemoryTracer.html#e0">Logerr</a>(<font class="stringliteral">"Memory allocation structure corrupted!"</font>);
00844         m=0;
00845       }
00846     }
00847     printf(<font class="stringliteral">"----------------------------------------------------------------------------------\n\n"</font>);
00848 <font class="preprocessor">#endif</font>
00849 <font class="preprocessor"></font>  }
00850 
00851 
00852   <font class="comment">// display allocated memory areas reciently deallocated</font>
00853   <font class="keywordtype">void</font> MemoryTracer::dumpDeallocated()<font class="keyword"> </font>
00854 <font class="keyword">  </font>{
00855 <font class="preprocessor">#ifdef _TRACEMEMORY_</font>
00856 <font class="preprocessor"></font>    AllocEntry* m = dlist.<a class="code" href="classbase_1_1MemoryTracer_1_1AllocList.html#a5">front</a>();
00857     
00858     printf(<font class="stringliteral">"\nReciently deallocated memory regions (%d):\n"</font>,dlist.<a class="code" href="classbase_1_1MemoryTracer_1_1AllocList.html#a7">size</a>());
00859     printf(<font class="stringliteral">"(%ld allocations, %ld deallocations, %ld integrity checks performed)\n"</font>,allocCount,deallocCount,checkCount);
00860     printf(<font class="stringliteral">"----------------------------------------------------------------------------------\n"</font>);
00861     
00862     <font class="keywordflow">while</font>(m) {
00863       <font class="keywordflow">if</font> (m-&gt;isOK()) {
00864         printf(<font class="stringliteral">"%52s: %10x (%9d) %s %s\n"</font>, (m-&gt;name==0)?<font class="stringliteral">"&lt;unnamed&gt;"</font>:m-&gt;name, <a class="code" href="namespace__base.html#a2">Int</a>(m-&gt;address+Filling), 
00865                m-&gt;size,(m-&gt;isArray?<font class="stringliteral">"[]"</font>:<font class="stringliteral">"  "</font>),m-&gt;isExternal()?<font class="stringliteral">"EXT"</font>:<font class="stringliteral">""</font>);
00866         m = m-&gt;next;
00867       }
00868       <font class="keywordflow">else</font> {
00869         <a class="code" href="classbase_1_1MemoryTracer.html#e0">Logerr</a>(<font class="stringliteral">"Memory allocation structure corrupted!"</font>);
00870         m=0;
00871       }
00872     }
00873     printf(<font class="stringliteral">"----------------------------------------------------------------------------------\n\n"</font>);
00874 <font class="preprocessor">#endif</font>
00875 <font class="preprocessor"></font>  }
00876 
00877 
00878   <font class="comment">// display named allocated memory areas only</font>
00879   <font class="keywordtype">void</font> MemoryTracer::dumpNamed()<font class="keyword"> </font>
00880 <font class="keyword">  </font>{
00881 <font class="preprocessor">#ifdef _TRACEMEMORY_</font>
00882 <font class="preprocessor"></font>    AllocEntry* m = mlist.<a class="code" href="classbase_1_1MemoryTracer_1_1AllocList.html#a5">front</a>();
00883     
00884     <a class="code" href="classbase_1_1MemoryTracer.html#d6">checkAllMemory</a>();
00885     
00886     printf(<font class="stringliteral">"\nValid named memory regions (from %d total):\n"</font>,mlist.<a class="code" href="classbase_1_1MemoryTracer_1_1AllocList.html#a7">size</a>());
00887     printf(<font class="stringliteral">"(%ld allocations, %ld deallocations, %ld integrity checks performed)\n"</font>,allocCount,deallocCount,checkCount);
00888     printf(<font class="stringliteral">"----------------------------------------------------------------------------------\n"</font>);
00889     
00890     <font class="keywordtype">int</font> e=0;
00891     <font class="keywordflow">while</font>(m) {
00892       <font class="keywordflow">if</font> (m-&gt;isOK()) {
00893         <font class="keywordflow">if</font> (m-&gt;name!=0)
00894           printf(<font class="stringliteral">"%4d %52s: %10x (%9d) %s %s\n"</font>,e,m-&gt;name, (Int)(m-&gt;address+Filling),
00895                  m-&gt;size,(m-&gt;isArray?<font class="stringliteral">"[]"</font>:<font class="stringliteral">"  "</font>),m-&gt;isExternal()?<font class="stringliteral">"EXT"</font>:<font class="stringliteral">""</font>);
00896         ++e; 
00897         m = m-&gt;next;
00898       }
00899       <font class="keywordflow">else</font> {
00900         <a class="code" href="classbase_1_1MemoryTracer.html#e0">Logerr</a>(<font class="stringliteral">"Memory allocation structure corrupted!"</font>);
00901         m=0;
00902       }
00903     }
00904     printf(<font class="stringliteral">"----------------------------------------------------------------------------------\n\n"</font>);
00905 <font class="preprocessor">#endif    </font>
00906 <font class="preprocessor"></font>  }
00907 
00908 
00909 
00910 
00911 
00912 
00913 
00914 <font class="preprocessor">#include &lt;list&gt;</font>
00915 
00916 <font class="keyword">namespace </font>{
00917 
00918 <font class="keyword">using</font> base::Byte;
00919 <font class="keyword">using</font> base::Int;
00920 
<a name="l00921"></a><a class="code" href="MemoryTracer_8cpp~.html#a2">00921</a> std::list&lt;Byte*&gt; delayedDeletes;
<a name="l00922"></a><a class="code" href="MemoryTracer_8cpp~.html#a3">00922</a> Int count = 0;
<a name="l00923"></a><a class="code" href="MemoryTracer_8cpp~.html#a4">00923</a> Int maxDepth = 0;
00924 <font class="keyword">static</font> <font class="keyword">const</font> Int maxCount = 5000;
00925 
<a name="l00926"></a><a class="code" href="MemoryTracer_8cpp~.html#a6">00926</a> <font class="keywordtype">void</font> <a class="code" href="MemoryTracer_8cpp~.html#a6">stressTestAllocatorRecurse</a>(Int depth)<font class="keyword"></font>
00927 <font class="keyword"></font>{
00928   Int size = (rand() &amp; 0xff)+1;
00929   Byte* mem = <font class="keyword">new</font> Byte[size];
00930   ++count;
00931 
00932   <font class="keywordflow">if</font> (depth &gt; maxDepth) 
00933     maxDepth = depth;
00934 
00935   Int r = (rand() &amp; 0xc0) &gt;&gt; 6; <font class="comment">// 0-2</font>
00936   <font class="keywordflow">if</font> (r &amp;&amp; (count &lt; maxCount))
00937     <a class="code" href="MemoryTracer_8cpp~.html#a6">stressTestAllocatorRecurse</a>(depth+1);
00938 
00939   Int d = (rand() &amp; 0x80) &gt;&gt; 7; <font class="comment">// 0 or 1</font>
00940   <font class="keywordflow">if</font> (d)
00941     <font class="keyword">delete</font>[] mem;
00942   <font class="keywordflow">else</font>
00943     delayedDeletes.push_back(mem);
00944 }
00945 
00946 } <font class="comment">// namespace</font>
00947 
00948 <font class="keyword">using</font> std::list;
00949 
00950 <font class="keywordtype">void</font> <a class="code" href="namespace__base.html#a138">base::stressTestAllocator</a>()<font class="keyword"></font>
00951 <font class="keyword"></font>{
00952   <a class="code" href="base.html#a3">Logln</a>(<font class="stringliteral">"Performing memory allocator test..."</font>);
00953   <font class="keywordflow">while</font> (count &lt; maxCount) {
00954     <a class="code" href="MemoryTracer_8cpp~.html#a6">stressTestAllocatorRecurse</a>(1);
00955     MemoryTracer::checkAllMemory();
00956 
00957     <font class="comment">// delete half of the delayed delete's</font>
00958     base::Int c = delayedDeletes.size()/2;
00959     std::list&lt;Byte*&gt;::iterator s = delayedDeletes.begin();
00960     std::list&lt;Byte*&gt;::iterator end = delayedDeletes.end();
00961     <font class="keywordflow">while</font> (s != end) {
00962       <font class="keywordflow">if</font> (--c &gt; 0) 
00963         <font class="keywordflow">if</font> (*s) <font class="keyword">delete</font>[] (*s);
00964       (*s) = 0;
00965       ++s;
00966     }
00967     MemoryTracer::checkAllMemory();
00968   }
00969   
00970   <font class="comment">// delete remaining delayed delete's</font>
00971   std::list&lt;Byte*&gt;::const_iterator s = delayedDeletes.begin();
00972   std::list&lt;Byte*&gt;::const_iterator end = delayedDeletes.end();
00973   <font class="keywordflow">while</font> (s != end) {
00974     <font class="keywordflow">if</font> (*s) <font class="keyword">delete</font>[] (*s);
00975     ++s;
00976   }
00977   delayedDeletes.clear();
00978   MemoryTracer::checkAllMemory();
00979 
00980   <a class="code" href="base.html#a3">Logln</a>(<font class="stringliteral">"Done. "</font> &lt;&lt; count &lt;&lt; <font class="stringliteral">" allocations ("</font> &lt;&lt; maxDepth &lt;&lt; <font class="stringliteral">" recursion depth)"</font>)
00981 }
00982 
00983 
00984 
00985 
00986 
00987 <font class="comment">// global</font>
00988 
00989 
00990 <font class="preprocessor">#ifdef _TRACEMEMORY_</font>
00991 <font class="preprocessor"></font>
00992 <font class="keywordtype">void</font>* <a class="code" href="MemoryTracer.html#a3">operator new</a>(size_t size) <font class="keywordflow">throw</font> (std::bad_alloc)
00993 {
00994   <font class="keywordtype">void</font>* p = <a class="code" href="classbase_1_1MemoryTracer.html#d0">base::MemoryTracer::allocate</a>(size,<font class="stringliteral">""</font>);
00995 <font class="preprocessor">#ifdef _TRACEOUTPUT_</font>
00996 <font class="preprocessor"></font><font class="preprocessor">#ifndef _NAMEDOUTPUTONLY_</font>
00997 <font class="preprocessor"></font>  fprintf(stderr, <font class="stringliteral">"new(%d) = %x\n"</font>,size,Int(p));
00998 <font class="preprocessor">#endif</font>
00999 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
01000 <font class="preprocessor"></font>  <font class="keywordflow">return</font> p;
01001 }
01002 
01003 <font class="keywordtype">void</font>* <a class="code" href="MemoryTracer.html#a3">operator new</a>(size_t size, <font class="keyword">const</font> string&amp; name) <font class="keywordflow">throw</font> (std::bad_alloc)
01004 {
01005   <font class="keywordtype">void</font>* p = <a class="code" href="classbase_1_1MemoryTracer.html#d0">base::MemoryTracer::allocate</a>(size,name);
01006 <font class="preprocessor">#ifdef _TRACEOUTPUT_</font>
01007 <font class="preprocessor"></font>  fprintf(stderr, <font class="stringliteral">"new(%d,%s) = %x\n"</font>,size,name.c_str(),Int(p));
01008 <font class="preprocessor">#endif</font>
01009 <font class="preprocessor"></font>  <font class="keywordflow">return</font> p;
01010 }
01011 
01012 <font class="keywordtype">void</font> operator delete(<font class="keywordtype">void</font>* p)<font class="keyword"></font>
01013 <font class="keyword"></font>{
01014 <font class="preprocessor">#ifdef _TRACEOUTPUT_</font>
01015 <font class="preprocessor"></font>  <font class="keywordtype">char</font>* name = <a class="code" href="classbase_1_1MemoryTracer.html#d7">base::MemoryTracer::getName</a>(p);
01016   <font class="keywordflow">if</font> (name)
01017     fprintf(stderr, <font class="stringliteral">"delete[](%x,%s)\n"</font>, Int(p),name);
01018 <font class="preprocessor">#ifndef _NAMEDOUTPUTONLY_</font>
01019 <font class="preprocessor"></font>  <font class="keywordflow">else</font>
01020     fprintf(stderr, <font class="stringliteral">"delete[](%x)\n"</font>, Int(p));
01021 <font class="preprocessor">#endif</font>
01022 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
01023 <font class="preprocessor"></font>  <a class="code" href="classbase_1_1MemoryTracer.html#d1">base::MemoryTracer::release</a>(p);
01024 }
01025 
01026 
01027 <font class="keywordtype">void</font>* <a class="code" href="MemoryTracer.html#a4">operator new[]</a>(size_t size) <font class="keywordflow">throw</font> (std::bad_alloc)
01028 {
01029   <font class="keywordtype">void</font>* p = <a class="code" href="classbase_1_1MemoryTracer.html#d0">base::MemoryTracer::allocate</a>(size,<font class="stringliteral">""</font>,<font class="keyword">true</font>);
01030 <font class="preprocessor">#ifdef _TRACEOUTPUT_</font>
01031 <font class="preprocessor"></font><font class="preprocessor">#ifndef _NAMEDOUTPUTONLY_</font>
01032 <font class="preprocessor"></font>  fprintf(stderr, <font class="stringliteral">"new[](%d) = %x\n"</font>,size,Int(p));
01033 <font class="preprocessor">#endif</font>
01034 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
01035 <font class="preprocessor"></font>  <font class="keywordflow">return</font> p;
01036 }
01037 
01038 <font class="keywordtype">void</font>* <a class="code" href="MemoryTracer.html#a4">operator new[]</a>(size_t size, <font class="keyword">const</font> string&amp; name) <font class="keywordflow">throw</font> (std::bad_alloc)
01039 {
01040   <font class="keywordtype">void</font>* p = <a class="code" href="classbase_1_1MemoryTracer.html#d0">base::MemoryTracer::allocate</a>(size,name,<font class="keyword">true</font>);
01041 <font class="preprocessor">#ifdef _TRACEOUTPUT_</font>
01042 <font class="preprocessor"></font>  fprintf(stderr, <font class="stringliteral">"new[](%d,%s) = %x\n"</font>,size,name.c_str(),Int(p));
01043 <font class="preprocessor">#endif</font>
01044 <font class="preprocessor"></font>  <font class="keywordflow">return</font> p;
01045 }
01046 
01047 <font class="keywordtype">void</font> operator delete[](<font class="keywordtype">void</font>* p)<font class="keyword"></font>
01048 <font class="keyword"></font>{
01049 <font class="preprocessor">#ifdef _TRACEOUTPUT_</font>
01050 <font class="preprocessor"></font>  <font class="keywordtype">char</font>* name = <a class="code" href="classbase_1_1MemoryTracer.html#d7">base::MemoryTracer::getName</a>(p);
01051   <font class="keywordflow">if</font> (name)
01052     fprintf(stderr, <font class="stringliteral">"delete[](%x,%s)\n"</font>, Int(p),name);
01053 <font class="preprocessor">#ifndef _NAMEDOUTPUTONLY_</font>
01054 <font class="preprocessor"></font>  <font class="keywordflow">else</font>
01055     fprintf(stderr, <font class="stringliteral">"delete[](%x)\n"</font>, Int(p));
01056 <font class="preprocessor">#endif</font>
01057 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
01058 <font class="preprocessor"></font>  <a class="code" href="classbase_1_1MemoryTracer.html#d1">base::MemoryTracer::release</a>(p,<font class="keyword">true</font>);
01059 }
01060 
01061 <font class="preprocessor">#endif</font>
</font></pre></div><hr><address><small>Generated at Wed Aug 7 10:30:28 2002 for OpenSim by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.8.1 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2001</small></address>
</body>
</html>
