<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>OpenSim: robot/sim/SimulatedTool.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>robot/sim/SimulatedTool.cpp</h1><a href="SimulatedTool_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/****************************************************************************</span>
00002 <span class="comment">  Copyright (C)2002 David Jung &lt;opensim@pobox.com&gt;</span>
00003 <span class="comment"></span>
00004 <span class="comment">  This program/file is free software; you can redistribute it and/or modify</span>
00005 <span class="comment">  it under the terms of the GNU General Public License as published by</span>
00006 <span class="comment">  the Free Software Foundation; either version 2 of the License, or</span>
00007 <span class="comment">  (at your option) any later version.</span>
00008 <span class="comment">  </span>
00009 <span class="comment">  This program is distributed in the hope that it will be useful,</span>
00010 <span class="comment">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00011 <span class="comment">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00012 <span class="comment">  GNU General Public License for more details. (http://www.gnu.org)</span>
00013 <span class="comment">  </span>
00014 <span class="comment">  You should have received a copy of the GNU General Public License</span>
00015 <span class="comment">  along with this program; if not, write to the Free Software</span>
00016 <span class="comment">  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
00017 <span class="comment"></span>
00018 <span class="comment">  $Id: SimulatedTool.cpp 1033 2004-02-11 20:47:52Z jungd $</span>
00019 <span class="comment">  $Revision: 1.12 $</span>
00020 <span class="comment">  $Date: 2004-02-11 15:47:52 -0500 (Wed, 11 Feb 2004) $</span>
00021 <span class="comment">  $Author: jungd $</span>
00022 <span class="comment"> </span>
00023 <span class="comment">****************************************************************************/</span>
00024 
00025 <span class="preprocessor">#include &lt;<a class="code" href="SimulatedTool.html">robot/sim/SimulatedTool</a>&gt;</span>
00026 
00027 <span class="preprocessor">#include &lt;<a class="code" href="Vector3.html">base/Vector3</a>&gt;</span>
00028 <span class="preprocessor">#include &lt;<a class="code" href="Orient.html">base/Orient</a>&gt;</span>
00029 <span class="preprocessor">#include &lt;<a class="code" href="Transform.html">base/Transform</a>&gt;</span>
00030 <span class="preprocessor">#include &lt;<a class="code" href="Externalizer.html">base/Externalizer</a>&gt;</span>
00031 
00032 <span class="preprocessor">#include &lt;<a class="code" href="Color3.html">gfx/Color3</a>&gt;</span>
00033 <span class="preprocessor">#include &lt;<a class="code" href="Line3.html">gfx/Line3</a>&gt;</span>
00034 <span class="preprocessor">#include &lt;<a class="code" href="Segment3.html">gfx/Segment3</a>&gt;</span>
00035 <span class="preprocessor">#include &lt;<a class="code" href="BoundingBox.html">physics/BoundingBox</a>&gt;</span>
00036 <span class="preprocessor">#include &lt;<a class="code" href="Material.html">physics/Material</a>&gt;</span>
00037 <span class="preprocessor">#include &lt;<a class="code" href="Box.html">physics/Box</a>&gt;</span>
00038 <span class="preprocessor">#include &lt;<a class="code" href="Sphere.html">physics/Sphere</a>&gt;</span>
00039 <span class="preprocessor">#include &lt;<a class="code" href="Cylinder.html">physics/Cylinder</a>&gt;</span>
00040 <span class="preprocessor">#include &lt;<a class="code" href="Solid.html">physics/Solid</a>&gt;</span>
00041 <span class="preprocessor">#include &lt;<a class="code" href="ConstraintGroup.html">physics/ConstraintGroup</a>&gt;</span>
00042 <span class="preprocessor">#include &lt;<a class="code" href="FixedConstraint.html">physics/FixedConstraint</a>&gt;</span>
00043 <span class="preprocessor">#include &lt;<a class="code" href="Joint.html">physics/Joint</a>&gt;</span>
00044 <span class="preprocessor">#include &lt;<a class="code" href="HingeJoint.html">physics/HingeJoint</a>&gt;</span>
00045 <span class="preprocessor">#include &lt;<a class="code" href="SliderJoint.html">physics/SliderJoint</a>&gt;</span>
00046 <span class="preprocessor">#include &lt;<a class="code" href="Motor.html">physics/Motor</a>&gt;</span>
00047 <span class="preprocessor">#include &lt;<a class="code" href="CollisionCuller.html">physics/CollisionCuller</a>&gt;</span>
00048 <span class="preprocessor">#include &lt;<a class="code" href="CollisionDetector.html">physics/CollisionDetector</a>&gt;</span>
00049 <span class="preprocessor">#include &lt;<a class="code" href="CollisionState.html">physics/CollisionState</a>&gt;</span>
00050 <span class="preprocessor">#include &lt;<a class="code" href="NullCollisionResponseHandler.html">physics/NullCollisionResponseHandler</a>&gt;</span>
00051 
00052 <span class="preprocessor">#include &lt;<a class="code" href="VisualDebugUtil.html">physics/VisualDebugUtil</a>&gt;</span>
00053 
00054 <span class="preprocessor">#include &lt;<a class="code" href="KinematicChain.html">robot/KinematicChain</a>&gt;</span>
00055 
00056 
00057 <span class="keyword">using</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedTool.html">robot::sim::SimulatedTool</a>;
00058 
00059 <span class="keyword">using</span> <a class="code" href="classbase_1_1Vector3.html">base::Point3</a>;
00060 <span class="keyword">using</span> <a class="code" href="classbase_1_1Orient.html">base::Orient</a>;
00061 <span class="keyword">using</span> <a class="code" href="classbase_1_1Externalizer.html">base::Externalizer</a>;
00062 <span class="keyword">using</span> <a class="code" href="classbase_1_1Vector3.html">base::Dimension3</a>;
00063 <span class="keyword">using</span> <a class="code" href="classbase_1_1Transform.html">base::Transform</a>;
00064 <span class="keyword">using</span> <a class="code" href="classgfx_1_1Line3.html">gfx::Line3</a>;
00065 <span class="keyword">using</span> <a class="code" href="classgfx_1_1Segment3.html">gfx::Segment3</a>;
00066 <span class="keyword">using</span> <a class="code" href="classgfx_1_1Color4.html">gfx::Color4</a>;
00067 <span class="keyword">using</span> <a class="code" href="classphysics_1_1BoundingBox.html">physics::BoundingBox</a>;
00068 <span class="keyword">using</span> <a class="code" href="classphysics_1_1Collidable.html">physics::Collidable</a>;
00069 <span class="keyword">using</span> <a class="code" href="classphysics_1_1CollidableBody.html">physics::CollidableBody</a>;
00070 <span class="keyword">using</span> <a class="code" href="classphysics_1_1CollidableGroup.html">physics::CollidableGroup</a>;
00071 <span class="keyword">using</span> <a class="code" href="classphysics_1_1CollisionState.html">physics::CollisionState</a>;
00072 <span class="keyword">using</span> <a class="code" href="classphysics_1_1CollisionCuller.html">physics::CollisionCuller</a>;
00073 <span class="keyword">using</span> <a class="code" href="classphysics_1_1CollisionDetector.html">physics::CollisionDetector</a>;
00074 <span class="keyword">using</span> <a class="code" href="classphysics_1_1CollisionResponseHandler.html">physics::CollisionResponseHandler</a>;
00075 <span class="keyword">using</span> <a class="code" href="classphysics_1_1NullCollisionResponseHandler.html">physics::NullCollisionResponseHandler</a>;
00076 <span class="keyword">using</span> <a class="code" href="classphysics_1_1Shape.html">physics::Shape</a>;
00077 <span class="keyword">using</span> <a class="code" href="classphysics_1_1Box.html">physics::Box</a>;
00078 <span class="keyword">using</span> <a class="code" href="classphysics_1_1Sphere.html">physics::Sphere</a>;
00079 <span class="keyword">using</span> <a class="code" href="classphysics_1_1Cylinder.html">physics::Cylinder</a>;
00080 <span class="keyword">using</span> <a class="code" href="classphysics_1_1Material.html">physics::Material</a>;
00081 <span class="keyword">using</span> <a class="code" href="classphysics_1_1Solid.html">physics::Solid</a>;
00082 <span class="keyword">using</span> <a class="code" href="classphysics_1_1SpatialGroup.html">physics::SpatialGroup</a>;
00083 <span class="keyword">using</span> <a class="code" href="classphysics_1_1SpatialTransform.html">physics::SpatialTransform</a>;
00084 <span class="keyword">using</span> <a class="code" href="classphysics_1_1ConstraintGroup.html">physics::ConstraintGroup</a>;
00085 <span class="keyword">using</span> <a class="code" href="classphysics_1_1FixedConstraint.html">physics::FixedConstraint</a>;
00086 <span class="keyword">using</span> <a class="code" href="classphysics_1_1Joint.html">physics::Joint</a>;
00087 <span class="keyword">using</span> <a class="code" href="classphysics_1_1HingeJoint.html">physics::HingeJoint</a>;
00088 <span class="keyword">using</span> <a class="code" href="classphysics_1_1SliderJoint.html">physics::SliderJoint</a>;
00089 <span class="keyword">using</span> <a class="code" href="classphysics_1_1Motor.html">physics::Motor</a>;
00090 
00091 <span class="keyword">using</span> <a class="code" href="classphysics_1_1VisualDebugUtil.html">physics::VisualDebugUtil</a>;
00092 
00093 <span class="keyword">using</span> <a class="code" href="classrobot_1_1KinematicChain.html">robot::KinematicChain</a>;
00094 <span class="keyword">using</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html">robot::sim::SimulatedKinematicChain</a>;
00095 <span class="keyword">using</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedTool.html">robot::sim::SimulatedTool</a>;
00096 <span class="comment"></span>
00097 <span class="comment">//!!!</span>
00098 <span class="comment"></span><span class="preprocessor">#include &lt;<a class="code" href="ODESolidConnectedCollidableBody.html">physics/ODESolidConnectedCollidableBody</a>&gt;</span>
00099 <span class="keyword">using</span> <a class="code" href="classphysics_1_1SolidConnectedCollidableBody.html">physics::SolidConnectedCollidableBody</a>;
00100 <span class="keyword">using</span> <a class="code" href="classphysics_1_1ODESolidConnectedCollidableBody.html">physics::ODESolidConnectedCollidableBody</a>;
00101 
00102 
00103 <span class="preprocessor">#include &lt;ode/ode.h&gt;</span>
00104 <span class="preprocessor">#include &lt;ode/rotation.h&gt;</span>
00105 
00106 
00107 <span class="comment">/*</span>
00108 <span class="comment">SimulatedTool::SimulatedTool(ref&lt;base::VFile&gt; toolSpecification,</span>
00109 <span class="comment">                             const base::Point3&amp; initialPosition, const base::Orient&amp; initialOrientation,</span>
00110 <span class="comment">                             ref&lt;physics::SolidSystem&gt; solidSystem, bool dynamic)</span>
00111 <span class="comment">  : SimulatedKinematicChain(solidSystem, dynamic), attached(false)</span>
00112 <span class="comment">{</span>
00113 <span class="comment">  Assert(solidSystem!=0);</span>
00114 <span class="comment"></span>
00115 <span class="comment">  chain = toolDescr.getKinematicChain();</span>
00116 <span class="comment">  q.reset(zeroVector(chain.dof()));</span>
00117 <span class="comment">  spatialGroup = ref&lt;SpatialGroup&gt;(NewObj SpatialGroup()); // a group to put all the Solids in</span>
00118 <span class="comment"></span>
00119 <span class="comment">  // read in supported formats</span>
00120 <span class="comment">  if (toolSpecification-&gt;extension() == "xml") {</span>
00121 <span class="comment"></span>
00122 <span class="comment">    // read in parameters </span>
00123 <span class="comment">    try {</span>
00124 <span class="comment">      Externalizer e(Externalizable::Input, toolSpecification);</span>
00125 <span class="comment">      externalize(e,"xml",1.0);</span>
00126 <span class="comment">    } catch (std::exception&amp;) {</span>
00127 <span class="comment">      throw std::invalid_argument(Exception("not a valid tool .xml file."));</span>
00128 <span class="comment">    }</span>
00129 <span class="comment"></span>
00130 <span class="comment">  }</span>
00131 <span class="comment">  else</span>
00132 <span class="comment">    throw std::invalid_argument(Exception("file format unsupported."));</span>
00133 <span class="comment"></span>
00134 <span class="comment">  construct(initialPosition, initialOrientation);</span>
00135 <span class="comment">}</span>
00136 <span class="comment">*/</span>
00137 
00138 SimulatedTool::SimulatedTool(ref&lt;const robot::ToolDescription&gt; toolDescription,
00139                              <span class="keyword">const</span> <a class="code" href="classbase_1_1Vector3.html">base::Point3</a>&amp; initialPosition, <span class="keyword">const</span> <a class="code" href="classbase_1_1Orient.html">base::Orient</a>&amp; initialOrientation,
00140                              ref&lt;physics::SolidSystem&gt; solidSystem, <span class="keywordtype">bool</span> dynamic)
00141   : SimulatedKinematicChain(solidSystem, dynamic), toolDescr(toolDescription), attached(false)
00142 {
00143   <a class="code" href="base.html#a19">Assert</a>(solidSystem!=0);
00144   
00145   <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a> = <a class="code" href="classrobot_1_1sim_1_1SimulatedTool.html#robot_1_1sim_1_1SimulatedToolp0">toolDescr</a>-&gt;getKinematicChain();
00146   <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp17">q</a>.<a class="code" href="classbase_1_1vector.html#base_1_1vectora14">resize</a>(<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>.dof());
00147   <a class="code" href="classrobot_1_1sim_1_1SimulatedTool.html#robot_1_1sim_1_1SimulatedToolp5">spatialGroup</a> = ref&lt;SpatialGroup&gt;(<a class="code" href="MemoryTracer.html#a0">NewObj</a> <a class="code" href="classphysics_1_1SpatialGroup.html">SpatialGroup</a>()); <span class="comment">// a group to put all the Solids in</span>
00148 
00149   <a class="code" href="classrobot_1_1sim_1_1SimulatedTool.html#robot_1_1sim_1_1SimulatedToolb1">construct</a>(initialPosition, initialOrientation);
00150 }
00151  
00152  
00153  
00154 
00155 <span class="keywordtype">bool</span> SimulatedTool::formatSupported(String format, Real version, ExternalizationType type)<span class="keyword"> const</span>
00156 <span class="keyword"></span>{
00157   <span class="keywordflow">return</span> <span class="keyword">false</span>;
00158 }
00159 
00160 <span class="keywordtype">void</span> SimulatedTool::externalize(<a class="code" href="classbase_1_1Externalizer.html">base::Externalizer</a>&amp; e, String format, Real version)
00161 {
00162   <span class="keywordflow">if</span> (format == <span class="stringliteral">""</span>) format = <span class="stringliteral">"xml"</span>;
00163 
00164   <span class="keywordflow">if</span> (!<a class="code" href="classrobot_1_1sim_1_1SimulatedTool.html#robot_1_1sim_1_1SimulatedToola25">formatSupported</a>(format,version,e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera6">ioType</a>()))
00165     <span class="keywordflow">throw</span> std::invalid_argument(<a class="code" href="base.html#a15">Exception</a>(<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"format "</span>)+format+<span class="stringliteral">" v"</span>+base::realToString(version)+<span class="stringliteral">" unsupported"</span>));
00166 
00167 }
00168 
00169 
00170 
00171 <span class="keywordtype">void</span> SimulatedTool::setJointForce(Int j, Real f)
00172 {
00173   <a class="code" href="base.html#a21">Assertm</a>((j&gt;=1)&amp;&amp;(j&lt;=<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>.dof()), <span class="stringliteral">"joint index in range"</span>);
00174   
00175   <span class="keywordflow">if</span> (!<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp10">dynamic</a>) <span class="keywordflow">return</span>;
00176   
00177   <a class="code" href="namespacebase.html#a2">Int</a> l = <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>.linkIndexOfVariable(j-1);
00178   
00179   ref&lt;Motor&gt; motor(joints[l]-&gt;getMotor(1));
00180   motor-&gt;setTargetVel( (f&gt;0)?10:-10 ); 
00181   motor-&gt;setMaxForce(f);
00182 }
00183 
00184 <span class="keywordtype">void</span> SimulatedTool::setJointVel(Int j, Real v, Real maxForce)
00185 {
00186   <a class="code" href="base.html#a21">Assertm</a>((j&gt;=1)&amp;&amp;(j&lt;=<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>.dof()), <span class="stringliteral">"joint index in range"</span>);
00187 
00188   <span class="keywordflow">if</span> (!<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp10">dynamic</a>) <span class="keywordflow">return</span>;
00189   
00190   <a class="code" href="namespacebase.html#a2">Int</a> l = <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>.linkIndexOfVariable(j-1);
00191   
00192   ref&lt;Motor&gt; motor(joints[l]-&gt;getMotor(1));
00193   motor-&gt;setTargetVel(v); 
00194   motor-&gt;setMaxForce(maxForce);
00195 }
00196 
00197 
00198 <span class="keywordtype">void</span> SimulatedTool::setJointPos(Int j, Real p)
00199 {
00200   <a class="code" href="base.html#a21">Assertm</a>((j&gt;=1)&amp;&amp;(j&lt;=<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>.dof()), <span class="stringliteral">"joint index in range"</span>);
00201 
00202   <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp17">q</a>[j-1] = p;
00203   
00204   <span class="comment">//... actually move the links</span>
00205   <span class="comment">//hack!!! (expensive - only need to update the joint in question)</span>
00206 
00207   Transform mountConfiguration = <a class="code" href="classrobot_1_1sim_1_1SimulatedTool.html#robot_1_1sim_1_1SimulatedToolp4">mountSpatial</a>-&gt;getConfiguration();
00208   
00209   TransformInfo transformInfo( <a class="code" href="classrobot_1_1sim_1_1SimulatedTool.html#robot_1_1sim_1_1SimulatedToolb2">computeLinkTransforms</a>(mountConfiguration, q) );
00210   <a class="code" href="classrobot_1_1sim_1_1SimulatedTool.html#robot_1_1sim_1_1SimulatedToolb4">positionLinks</a>(transformInfo);
00211     
00212   <span class="comment">//hack!!!</span>
00213 }
00214 
00215   
00216 <a class="code" href="namespacebase.html#a5">Real</a> SimulatedTool::getJointPos(Int j)<span class="keyword"> const</span>
00217 <span class="keyword"></span>{
00218   <a class="code" href="base.html#a21">Assertm</a>((j&gt;=1)&amp;&amp;(j&lt;=<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>.dof()), <span class="stringliteral">"joint index in range"</span>);
00219 
00220   <span class="keywordflow">if</span> (<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp10">dynamic</a>) { <span class="comment">// get joint pos from physics::Joint</span>
00221     
00222     <span class="comment">// NB: physics::Joints have their 0 pos at the position/orientation</span>
00223     <span class="comment">//  at which the two bodies were initially attached.  That was</span>
00224     <span class="comment">//  computed from the tool joint parameter home position.</span>
00225     <a class="code" href="namespacebase.html#a2">Int</a> l = <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>.linkIndexOfVariable(j-1);
00226 
00227     <span class="keywordflow">if</span> (<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>[l].type() == KinematicChain::Link::Revolute) {
00228   
00229       ref&lt;HingeJoint&gt; hinge(narrow_ref&lt;HingeJoint&gt;(joints[l]));
00230       
00231       <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp17">q</a>[j-1] = hinge-&gt;getAngle();
00232   
00233     } <span class="keywordflow">else</span> { <span class="comment">// prismatic</span>
00234       ref&lt;SliderJoint&gt; slider(narrow_ref&lt;SliderJoint&gt;(joints[l]));
00235       <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp17">q</a>[j-1] = slider-&gt;getPosition();
00236     }
00237     
00238   } <span class="keywordflow">else</span> { <span class="comment">// static</span>
00239     <span class="comment">/*// !!!fix indices for tool (copied from manip)</span>
00240 <span class="comment">    Transform relConfig = inverse( links[j]-&gt;getConfiguration() )*links[j-1]-&gt;getConfiguration();</span>
00241 <span class="comment">    Real rotAboutZ = Math::normalizeAngle(relConfig.getRotation().getVector(Orient::EulerZYX)[0]);</span>
00242 <span class="comment">    Debugln(Tmp,"rotAboutZ=" &lt;&lt; rotAboutZ);</span>
00243 <span class="comment">    return rotAboutZ;</span>
00244 <span class="comment">    */</span>
00245   }
00246 
00247   <span class="keywordflow">return</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp17">q</a>[j-1];
00248 
00249 }
00250 
00251 
00252 <a class="code" href="namespacebase.html#a5">Real</a> SimulatedTool::getJointVel(Int j)<span class="keyword"> const</span>
00253 <span class="keyword"></span>{
00254   <a class="code" href="base.html#a21">Assertm</a>((j&gt;=1)&amp;&amp;(j&lt;=<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>.dof()), <span class="stringliteral">"joint index in range"</span>);
00255 
00256   <span class="keywordflow">if</span> (!<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp10">dynamic</a>) <span class="keywordflow">return</span> 0;
00257 
00258   <a class="code" href="namespacebase.html#a2">Int</a> l = <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>.linkIndexOfVariable(j-1);
00259   
00260   <span class="keywordflow">if</span> (<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>[l].type() == KinematicChain::Link::Revolute) {
00261 
00262     ref&lt;HingeJoint&gt; hinge(narrow_ref&lt;HingeJoint&gt;(joints[l]));
00263     <span class="keywordflow">return</span> hinge-&gt;getAngleRate();
00264   }
00265   <span class="keywordflow">else</span> { <span class="comment">// prismatic</span>
00266 
00267     ref&lt;SliderJoint&gt; slider(narrow_ref&lt;SliderJoint&gt;(joints[l]));
00268     <span class="keywordflow">return</span> slider-&gt;getPositionRate();
00269   }
00270 
00271 }
00272 
00273 
00274 
00275 
00276 
00277 
00278 
00279 
00280 
00281 
00282 SimulatedTool::TransformInfo SimulatedTool::computeLinkTransforms(<span class="keyword">const</span> Transform&amp; mountTransform, <span class="keyword">const</span> <a class="code" href="classbase_1_1vector.html">base::Vector</a>&amp; q)<span class="keyword"> const</span>
00283 <span class="keyword"></span>{
00284   TransformInfo transformInfo;
00285   transformInfo.mountTransform = mountTransform;
00286   transformInfo.q.reset(q);
00287   
00288   array&lt;Transform&gt;&amp; A(transformInfo.A); <span class="comment">// convenient aliases</span>
00289   array&lt;Transform&gt;&amp; T(transformInfo.T);
00290   array&lt;Transform&gt;&amp; SLT(transformInfo.SLT);
00291   A.resize(<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>.size()+1);  
00292   T.resize(A.size());
00293   SLT.resize(A.size());
00294 
00295   A[0] = transformInfo.mountTransform; <span class="comment">// link 0</span>
00296   T[0] = A[0];
00297   <a class="code" href="namespacebase.html#a2">Int</a> j=0; <span class="comment">// joint variable index</span>
00298 
00299   <span class="comment">// transform from mount point to first link - translate origin to (other) link end</span>
00300   transformInfo.mountToBaseSolid = Transform(Vector3(linkLengths[1],0,0));
00301   
00302   <span class="keywordflow">for</span> (<a class="code" href="namespacebase.html#a2">Int</a> l=1; l&lt;=<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>.size(); l++) { <span class="comment">// for each link</span>
00303     
00304     <span class="keyword">const</span> KinematicChain::Link&amp; link(chain[l-1]);
00305     
00306     <span class="comment">//</span>
00307     <span class="comment">// ask KinematicChain to compute the transform for each link</span>
00308     <a class="code" href="classdemeter_1_1Vector.html">Vector</a> lq(link.dof());
00309     <span class="keywordflow">if</span> (lq.size()&gt;0) <span class="comment">// this currently only handles 0 or 1-dof links (!!!)</span>
00310       lq[0] = transformInfo.q[j]; 
00311     A[l] = <a class="code" href="namespacebase.html#a102">base::toMatrix4</a>(link.kinematicTransform(lq));
00312     
00313     <span class="comment">//</span>
00314     <span class="comment">// accumulate inter-link transforms </span>
00315     T[l] = T[l-1]*A[l]; 
00316     
00317     <span class="comment">//</span>
00318     <span class="comment">// finally compute the relative configuration of each link's Solid from its origin</span>
00319 
00320     <span class="comment">// Rotate the z-axis into the x-axis, as the link coord. frame has the x-axis along</span>
00321     <span class="comment">//  the link length, but the Solid's z-axis is the long one.</span>
00322     <span class="comment">// Also translate back 1/2 the Solid length along the long axis (z)</span>
00323     <span class="comment">//  (as the origin of the Solid is at its center of mass, but the origin of a link</span>
00324     <span class="comment">//   is at its end)</span>
00325     SLT[l] = Quat4(Vector3(0,1,0),consts::Pi/2.0) * Transform(Vector3(0,0,-linkLengths[l]/2.0));
00326       
00327     <span class="keywordflow">if</span> (link.isDHType()) {<span class="comment"></span>
00328 <span class="comment">//!!! fix comment</span>
00329 <span class="comment"></span>      <span class="comment">// We also want to rotate the Solid so that the ends meet even if there</span>
00330       <span class="comment">//  is a displacement due to DH-parameter d</span>
00331       <span class="comment">//  (this will be a rotation about the y-axis of link l-1 to make the Solid's z-axis</span>
00332       <span class="comment">//   point to the previous link's origin rather than being parallel with</span>
00333       <span class="comment">//   the link x-axis.  To achieve this we bring link Solid l's y&amp;z-axes parallel to</span>
00334       <span class="comment">//   those of link l-1 by reversing the skew DH-parameter alpha, then rotate about the x-axis,</span>
00335       <span class="comment">//   and then redo the skew)</span><span class="comment"></span>
00336 <span class="comment">//!!!check use of link.d is OK here (need to use q[0] if Prismatic??)</span>
00337 <span class="comment"></span>      <a class="code" href="namespacebase.html#a5">Real</a> incline = (!Math::equals(link.getD(),0))? Math::asin(link.getD()/<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp14">linkLengths</a>[l]) : 0;
00338       <span class="keywordflow">if</span> (!Math::equals(incline,0)) {
00339         Transform rotYl    = Quat4(Vector3(0,1,0),-incline);
00340         Transform rotXl    = Quat4(Vector3(1,0,0), link.getAlpha());
00341         Transform rotXlInv = Quat4(Vector3(1,0,0),-link.getAlpha());
00342         Transform rotYlm1 = rotXlInv * rotYl * rotXl;
00343         
00344         SLT[l] = rotYlm1 * SLT[l];
00345       }
00346        
00347       
00348     }
00349 
00350     <span class="keywordflow">if</span> (l==<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>.size())
00351       transformInfo.eeToEESolid = <a class="code" href="namespacebase.html#a115">inverse</a>(SLT[l]); <span class="comment">//!!! check</span>
00352 <span class="comment"></span>    
00353     j += link.dof();
00354   } <span class="comment">// for each link</span>
00355 
00356   
00357   <span class="keywordflow">return</span> transformInfo;
00358 }
00359 
00360 
00361 
00362 
00363 
00364 <span class="keywordtype">void</span> SimulatedTool::createLinks(<span class="keyword">const</span> array&lt;base::Dimension3&gt;&amp; linkDims)
00365 {
00366   <span class="comment">// We create a Solid for each link and place it in SolidSystem</span>
00367   <span class="comment">// Unless the geometry is specified, the Shape will be a Box who's dimensions</span>
00368   <span class="comment">// are specified in linkDims[]</span>
00369   <span class="comment">// The links are also chained together using SpatialGroups</span>
00370   <a class="code" href="base.html#a19">Assert</a>(<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>.size() &gt; 0);
00371 
00372   <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp12">links</a>.resize(<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>.size()+1);
00373   <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp11">linkGroups</a>.resize(<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>.size()+1);
00374   
00375   
00376   <span class="keywordflow">for</span> (<a class="code" href="namespacebase.html#a2">Int</a> l=1; l&lt;=<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>.size(); l++) { <span class="comment">// for each link</span>
00377     <span class="keyword">const</span> <a class="code" href="classbase_1_1Vector3.html">Dimension3</a>&amp; dim(linkDims[l]);
00378     ref&lt;Box&gt; box(NewObj Box(dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o0">x</a>,dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o1">y</a>,dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o2">z</a>));
00379     ref&lt;Material&gt; material(NewObj <a class="code" href="classphysics_1_1Material.html">physics::Material</a>());
00380     
00381     <span class="comment">// colour</span>
00382     <span class="keywordflow">switch</span> (l%10) {
00383     <span class="keywordflow">case</span> 0: material-&gt;setBaseColor(<a class="code" href="classgfx_1_1Color3.html">gfx::Color3</a>(0.6,0.6,0.6)); <span class="keywordflow">break</span>;
00384     <span class="keywordflow">case</span> 1: material-&gt;setBaseColor(<a class="code" href="classgfx_1_1Color3.html">gfx::Color3</a>(0,1,0)); <span class="keywordflow">break</span>;
00385     <span class="keywordflow">case</span> 2: material-&gt;setBaseColor(<a class="code" href="classgfx_1_1Color3.html">gfx::Color3</a>(0+0.1,1-0.1,0+0.1)); <span class="keywordflow">break</span>;
00386     <span class="keywordflow">case</span> 3: material-&gt;setBaseColor(<a class="code" href="classgfx_1_1Color3.html">gfx::Color3</a>(0+0.2,1-0.2,0+0.2)); <span class="keywordflow">break</span>;
00387     <span class="keywordflow">case</span> 4: material-&gt;setBaseColor(<a class="code" href="classgfx_1_1Color3.html">gfx::Color3</a>(0+0.3,1-0.3,0+0.3)); <span class="keywordflow">break</span>;
00388     <span class="keywordflow">case</span> 5: material-&gt;setBaseColor(<a class="code" href="classgfx_1_1Color3.html">gfx::Color3</a>(0+0.4,1-0.4,0+0.4)); <span class="keywordflow">break</span>;
00389     <span class="keywordflow">case</span> 6: material-&gt;setBaseColor(<a class="code" href="classgfx_1_1Color3.html">gfx::Color3</a>(0+0.5,1-0.5,0+0.5)); <span class="keywordflow">break</span>;
00390     <span class="keywordflow">case</span> 7: material-&gt;setBaseColor(<a class="code" href="classgfx_1_1Color3.html">gfx::Color3</a>(0+0.6,1-0.6,0+0.6)); <span class="keywordflow">break</span>;
00391     <span class="keywordflow">case</span> 8: material-&gt;setBaseColor(<a class="code" href="classgfx_1_1Color3.html">gfx::Color3</a>(1,1,1)); <span class="keywordflow">break</span>;
00392     <span class="keywordflow">case</span> 9: material-&gt;setBaseColor(<a class="code" href="classgfx_1_1Color3.html">gfx::Color3</a>(1,0,0)); <span class="keywordflow">break</span>;
00393     <span class="keywordflow">default</span>:
00394       material-&gt;setBaseColor(<a class="code" href="classgfx_1_1Color3.html">gfx::Color3</a>(0,0,1));
00395     }
00396     
00397     <span class="comment">// add it to the system</span>
00398     <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp12">links</a>[l] = <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp9">solidSystem</a>-&gt;createSolid(box,material);
00399     <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp12">links</a>[l]-&gt;setName(<a class="code" href="classrobot_1_1sim_1_1SimulatedTool.html#robot_1_1sim_1_1SimulatedToola4">getToolDescription</a>()-&gt;<a class="code" href="classbase_1_1Named.html#base_1_1Worlda14">getName</a>()+<span class="stringliteral">" "</span>
00400                       +<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"link "</span>)+base::intToString(l));
00401     <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp9">solidSystem</a>-&gt;addSolid(links[l]);
00402 
00403     <span class="comment">// create a SpatialGroup which will hold a SpatialTransform warpping this link's Solid</span>
00404     <span class="comment">//  (as the link Solid may be transformed from the link origin), and the next link's</span>
00405     <span class="comment">//  group.</span>
00406     ref&lt;SpatialTransform&gt; linkTransform( NewObj <a class="code" href="classphysics_1_1SpatialTransform.html">SpatialTransform</a>() );
00407     linkTransform-&gt;setChild( links[l] ); <span class="comment">// wrap link in a SpatialTransform</span>
00408     ref&lt;SpatialGroup&gt; linkGroup( NewObj <a class="code" href="classphysics_1_1SpatialGroup.html">SpatialGroup</a>() );
00409     linkGroup-&gt;add(linkTransform); <span class="comment">// add it to the link group</span>
00410     linkGroup-&gt;setImplicitConfiguration(linkTransform); <span class="comment">// the configuration of the link group is synonymous with the linkTransform</span>
00411     <span class="keywordflow">if</span> (l &gt; 1) <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp11">linkGroups</a>[l-1]-&gt;add(linkGroup); <span class="comment">// add the linkGroup to the previous link's linkGroup</span>
00412     <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp11">linkGroups</a>[l] = linkGroup; <span class="comment">// stash it into the link group array</span>
00413     
00414     <span class="keywordflow">if</span> (l == 1)
00415       <a class="code" href="classrobot_1_1sim_1_1SimulatedTool.html#robot_1_1sim_1_1SimulatedToolp1">firstSolid</a> = <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp12">links</a>[l];
00416     <span class="keywordflow">else</span>
00417       <span class="keywordflow">if</span> (l == <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>.size())
00418         <a class="code" href="classrobot_1_1sim_1_1SimulatedTool.html#robot_1_1sim_1_1SimulatedToolp2">endSolid</a> = links[l];
00419   }
00420   
00421 
00422   <span class="comment">// the mount point is a SpatialTransform that wraps the first link such that the mount is at the</span>
00423   <span class="comment">//  appropriate point (opposite end to the end-effector)  </span>
00424   <a class="code" href="classrobot_1_1sim_1_1SimulatedTool.html#robot_1_1sim_1_1SimulatedToolp4">mountSpatial</a> = ref&lt;SpatialTransform&gt;( <a class="code" href="MemoryTracer.html#a0">NewObj</a> <a class="code" href="classphysics_1_1SpatialTransform.html">SpatialTransform</a>() );
00425   <a class="code" href="classrobot_1_1sim_1_1SimulatedTool.html#robot_1_1sim_1_1SimulatedToolp4">mountSpatial</a>-&gt;setChild( linkGroups[1] );
00426   
00427 }
00428 
00429 
00430 
00431 <span class="keywordtype">void</span> SimulatedTool::positionLinks(<span class="keyword">const</span> SimulatedTool::TransformInfo&amp; transformInfo)
00432 {
00433   <a class="code" href="base.html#a19">Assert</a>(<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp12">links</a>.size() == <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>.size()+1); <span class="comment">// links must already have been created</span>
00434 
00435   <span class="comment">// set mount transform</span>
00436   <a class="code" href="classrobot_1_1sim_1_1SimulatedTool.html#robot_1_1sim_1_1SimulatedToolp3">firstLinkSolidToMount</a> = transformInfo.mountToBaseSolid;
00437   <a class="code" href="classrobot_1_1sim_1_1SimulatedTool.html#robot_1_1sim_1_1SimulatedToolp4">mountSpatial</a>-&gt;setTransform(firstLinkSolidToMount);
00438   
00439   <span class="comment">// some convenient aliases</span>
00440   <span class="keyword">const</span> array&lt;Transform&gt;&amp; SLT( transformInfo.SLT );   <span class="comment">// transforms from the link's Solid coord. frame to the link frame</span>
00441   <span class="keyword">const</span> array&lt;Transform&gt;&amp; T( transformInfo.T );
00442 
00443   <span class="keywordflow">for</span> (<a class="code" href="namespacebase.html#a2">Int</a> l=1; l&lt;=<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>.size(); l++) { <span class="comment">// for each link</span>
00444 
00445     ref&lt;SpatialGroup&gt; linkGroup(linkGroups[l]);
00446     SpatialGroup::iterator firstChild = linkGroup-&gt;begin();
00447 
00448     <span class="comment">// set the transform from link origin to Solid origin first,</span>
00449     <span class="comment">// so that the Solid is properly configured when SpatialTransform configuration is set</span>
00450     ref&lt;SpatialTransform&gt; linkSpatialTransform( narrow_ref&lt;SpatialTransform&gt;( *firstChild ) );
00451     linkSpatialTransform-&gt;setTransform( SLT[l] );
00452     
00453     <span class="comment">// set SpatialTransform configuration (hence configuring its Solid child, and implicitly the linkGroup)</span>
00454     linkSpatialTransform-&gt;setConfiguration( T[l] ); 
00455     
00456   } <span class="comment">// for each link</span>
00457   
00458 }
00459 
00460 
00461 
00462 <span class="keywordtype">void</span> SimulatedTool::disableCollisions(<span class="keyword">const</span> array&lt;ref&lt;physics::Collidable&gt; &gt;&amp; collidables, 
00463                                       <span class="keyword">const</span> array&lt;ref&lt;physics::Collidable&gt; &gt;&amp; proximityCollidables)
00464 {
00465   <a class="code" href="base.html#a19">Assert</a>(solidSystem);
00466   <a class="code" href="base.html#a19">Assert</a>(<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp12">links</a>.size() == <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>.size()+1); <span class="comment">// links must already have been created</span>
00467   
00468   ref&lt;CollisionCuller&gt; cc(<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp9">solidSystem</a>-&gt;getCollisionCuller());
00469   
00470   <span class="keywordtype">bool</span> disableNextWithPrev = <span class="keyword">false</span>;   <span class="comment">// if true, disabled collisions between link's l &amp; l-2 (in addition to the</span>
00471                                       <span class="comment">// usual disable between l &amp; l-1.  This occurs when link l-1 has a length of 0 (coincident origins)</span>
00472   
00473   <span class="keywordflow">for</span> (<a class="code" href="namespacebase.html#a2">Int</a> l=2; l&lt;=<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>.size(); l++) { <span class="comment">// for each link</span>
00474     <span class="comment">// disable collision detection between consecutive links</span>
00475     cc-&gt;collisionEnable(<span class="keyword">false</span>,collidables[l-1],collidables[l]);
00476     
00477     <span class="comment">// and between link Solid Collidables &amp; their corresponding proximity sensor Collidable</span>
00478     cc-&gt;collisionEnable(<span class="keyword">false</span>,collidables[l], proximityCollidables[l]);
00479 
00480     cc-&gt;collisionEnable(<span class="keyword">false</span>,collidables[l-1],proximityCollidables[l]);
00481     cc-&gt;collisionEnable(<span class="keyword">false</span>,proximityCollidables[l-1],collidables[l]); 
00482     
00483     
00484     <span class="keywordflow">if</span> (disableNextWithPrev) {
00485       cc-&gt;collisionEnable(<span class="keyword">false</span>,collidables[l-2],collidables[l]);
00486       cc-&gt;collisionEnable(<span class="keyword">false</span>,collidables[l-2],proximityCollidables[l]);
00487       disableNextWithPrev = <span class="keyword">false</span>;
00488     }
00489 
00490     <span class="keywordflow">if</span> (<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp14">linkLengths</a>[l]&lt;=0.05) 
00491        disableNextWithPrev = <span class="keyword">true</span>; <span class="comment">// don't collide link l+1 with l-1 as they will be close on account of this link l being 0 length</span>
00492     
00493   }  
00494   
00495 
00496 }
00497 
00498 
00499 <span class="keywordtype">void</span> SimulatedTool::attachJoints(<span class="keyword">const</span> SimulatedTool::TransformInfo&amp; transformInfo)
00500 {
00501   <span class="keywordflow">if</span> (<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp12">links</a>.size() &lt; 2) <span class="keywordflow">return</span>; <span class="comment">// no joints</span>
00502 
00503   <span class="comment">// alias</span>
00504   <span class="keyword">const</span> array&lt;Transform&gt;&amp; T( transformInfo.T );     <span class="comment">// accumulated transformations for each link (transforms from frame l to base frame)</span>
00505   <span class="keyword">const</span> array&lt;Transform&gt;&amp; SLT( transformInfo.SLT ); 
00506   
00507   ref&lt;ConstraintGroup&gt; cgroup = <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp9">solidSystem</a>-&gt;createConstraintGroup();
00508   <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp9">solidSystem</a>-&gt;addConstraintGroup(cgroup);
00509   ref&lt;Motor&gt; motor;
00510   <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp13">joints</a>.resize(<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp12">links</a>.size()-1); <span class="comment">// should this be link.size()???!!!</span>
00511   
00512   <span class="keywordflow">for</span> (<a class="code" href="namespacebase.html#a2">Int</a> l=2; l&lt;<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp12">links</a>.size(); l++) { <span class="comment">// for each link (except the first)</span>
00513     <span class="comment">// connect it to the previous link in the chain</span>
00514   
00515     <span class="keyword">const</span> KinematicChain::Link&amp; link(chain[l-1]);
00516     ref&lt;Joint&gt; joint;
00517     
00518     <span class="keywordflow">if</span> (link.isDHType()) {    <span class="comment">// Connect using a HingeJoint for revolute joints and a SliderJoint for prismatic joints</span>
00519       
00520       <span class="comment">// All DH type joints have an axis of Z - which is the Solid's X-axis</span>
00521       <span class="comment">//  The axis is the z-axis of the previous link (l-1)</span>
00522       <span class="comment">// (they are specified relative to link l - hence we must transform z-axis</span>
00523       <span class="comment">//  of link l-1 into link l's coord. frame.)  </span>
00524       Vector3 axis( Vector3(1,0,0) ); <span class="comment">// untransformed Solid x-axis (link z-axis)</span>
00525       <span class="keywordflow">if</span> (l&gt;1) {
00526         axis = (T[l-1]*SLT[l-1]).rotate(axis);  <span class="comment">// x-axis of link Solid l-1 </span>
00527         axis = <a class="code" href="namespacebase.html#a115">inverse</a>(T[l]*SLT[l]).rotate(axis);  <span class="comment">// x-axis of link Solid l-1 in frame of link Solid l</span>
00528       } <span class="keywordflow">else</span> { <span class="comment">// connection to base is special case</span>
00529         axis = T[0].rotate(Vector3(0,0,1)); <span class="comment">// z-axis in base frame</span>
00530         axis = <a class="code" href="namespacebase.html#a115">inverse</a>(T[1]*SLT[1]).rotate(axis);  <span class="comment">// z-axis of base frame in frame of link Solid l</span>
00531       }
00532       
00533       
00534       <span class="keywordflow">if</span> (link.type() == KinematicChain::Link::Revolute) {
00535   
00536         ref&lt;HingeJoint&gt; hinge = <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp9">solidSystem</a>-&gt;createHingeJoint();
00537         joint = hinge;
00538         cgroup-&gt;addConstraint(hinge);
00539         <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp13">joints</a>[l-1] = joint;
00540         <a class="code" href="base.html#a19">Assert</a>(links[l-1]);
00541         joint-&gt;attach(links[l], links[l-1]);
00542   
00543         <span class="comment">// the anchor is at the end of the link (toward the base - not the origin end)</span>
00544         hinge-&gt;setAnchor( <a class="code" href="namespacebase.html#a26">Point3</a>(0,0,-linkLengths[l]/2) );
00545         hinge-&gt;setAxis( axis ); 
00546   
00547         <span class="comment">// set limits</span>
00548         <span class="keywordflow">if</span> (! ((link.minLimit() &lt;= -consts::Pi)&amp;&amp;(link.maxLimit() &gt;= consts::Pi)) ) {
00549           hinge-&gt;setLowStop(link.minLimit() - Math::degToRad(1) );
00550           hinge-&gt;setHighStop(link.maxLimit() + Math::degToRad(1) );
00551           hinge-&gt;setStopRestitution(0.2);
00552         }
00553   
00554         <span class="comment">// now attach a Motor to drive the joint</span>
00555         motor = <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp9">solidSystem</a>-&gt;createMotor();
00556         hinge-&gt;attachMotor(1, motor);
00557   
00558       }
00559       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (link.type() == KinematicChain::Link::Prismatic) {
00560   
00561         ref&lt;SliderJoint&gt; slider = <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp9">solidSystem</a>-&gt;createSliderJoint();
00562         joint = slider;
00563         cgroup-&gt;addConstraint(slider);
00564         <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp13">joints</a>[l-1] = joint;
00565         <a class="code" href="base.html#a19">Assert</a>(links[l-1]);
00566         joint-&gt;attach(links[l], links[l-1]);
00567   
00568         slider-&gt;setAxis( axis ); 
00569   
00570         <span class="comment">// set limits</span>
00571         slider-&gt;setLowStop(link.minLimit());
00572         slider-&gt;setHighStop(link.maxLimit());
00573         slider-&gt;setStopRestitution(0.2);
00574   
00575         <span class="comment">// now attach a Motor to drive the joint</span>
00576         motor = <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp9">solidSystem</a>-&gt;createMotor();
00577         slider-&gt;attachMotor(1, motor);
00578   
00579         <a class="code" href="base.html#a3">Logln</a>(<span class="stringliteral">"Warning: Prismatic joints not fully implemented"</span>);
00580       }
00581     }
00582     <span class="keywordflow">else</span>
00583       <span class="keywordflow">throw</span> std::invalid_argument(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"unknown/unsupported joint type: "</span> + link.type()));
00584 
00585     motor-&gt;setTargetVel(0);
00586     motor-&gt;setMaxForce(0.001); <span class="comment">// provide a little damping</span>
00587 
00588   } <span class="comment">// for each link </span>
00589 
00590 }
00591   
00592   
00593   
00594 <span class="keywordtype">void</span> SimulatedTool::construct(<span class="keyword">const</span> <a class="code" href="classbase_1_1Vector3.html">base::Point3</a>&amp; initialPosition, 
00595                               <span class="keyword">const</span> <a class="code" href="classbase_1_1Orient.html">base::Orient</a>&amp; initialOrientation)
00596 {
00597   Transform mountConfiguration = Transform(initialPosition, initialOrientation);
00598   
00599   <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp11">linkGroups</a>.clear();
00600   <a class="code" href="classrobot_1_1sim_1_1SimulatedTool.html#robot_1_1sim_1_1SimulatedToolb3">createLinks</a>(<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolb8">computeLinkDimensions</a>(array&lt;Real&gt;(0))); <span class="comment">//!!! no geom yet</span>
00601 <span class="comment"></span>  
00602   
00603   <span class="comment">// first construct the joint parameter vector q, based on the home positions of </span>
00604   <span class="comment">//  each joint represented in the chain</span>
00605   <a class="code" href="base.html#a19">Assert</a>(<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>.size() &gt; 0);
00606   <a class="code" href="classdemeter_1_1Vector.html">Vector</a> <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp17">q</a>(<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>.dof());
00607   
00608   <span class="comment">// note: this only works for links with 1-dof (!!!)</span>
00609   <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> j=0; j&lt;<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>.dof(); j++) { <span class="comment">// for each joint</span>
00610     <span class="keyword">const</span> KinematicChain::Link&amp; link(<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>.linkOfVariable(j)); <span class="comment">// get link for this joint</span>
00611     q[j] = link.variable();
00612   }
00613 
00614   <span class="comment">// compute the various transform matrices we need</span>
00615   TransformInfo transformInfo( <a class="code" href="classrobot_1_1sim_1_1SimulatedTool.html#robot_1_1sim_1_1SimulatedToolb2">computeLinkTransforms</a>(mountConfiguration, q) );
00616 
00617   <a class="code" href="classrobot_1_1sim_1_1SimulatedTool.html#robot_1_1sim_1_1SimulatedToolb4">positionLinks</a>(transformInfo);
00618   
00619   <span class="keywordflow">if</span> (<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp10">dynamic</a>) 
00620     <a class="code" href="classrobot_1_1sim_1_1SimulatedTool.html#robot_1_1sim_1_1SimulatedToolb6">attachJoints</a>(transformInfo);
00621 
00622   <span class="keywordflow">if</span> (!<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp10">dynamic</a>) {<span class="comment"></span>
00623 <span class="comment">//!!! appropriate place for this?? (note another one in SimulatedSerialManipulator)    </span>
00624 <span class="comment"></span>    <span class="comment">// replace the default CollisionResponseHandler with one that</span>
00625     <span class="comment">// doesn't create contacts</span>
00626     ref&lt;CollisionResponseHandler&gt; nullHandler(NewObj <a class="code" href="classphysics_1_1NullCollisionResponseHandler.html">NullCollisionResponseHandler</a>(<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp9">solidSystem</a>-&gt;getCollisionDetector()));
00627     <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp9">solidSystem</a>-&gt;setCollisionResponseHandler( nullHandler );
00628   }
00629 
00630   <span class="comment">// now create a CollisionResponseHandler to handle collisions between</span>
00631   <span class="comment">//  the proximity CollidableBodies and oher objects and insert it into</span>
00632   <span class="comment">//  the collision chain before the final handler</span>
00633   ref&lt;ProximityCollisionResponseHandler&gt; proximityHandler(NewObj <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedTooln2">ProximityCollisionResponseHandler</a>(ref&lt;SimulatedTool&gt;(<span class="keyword">this</span>),
00634                                                                                                    <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp9">solidSystem</a>-&gt;getCollisionDetector() ));
00635   proximityHandler-&gt;addPotentialCollisionListener( <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp9">solidSystem</a>-&gt;getCollisionResponseHandler() );
00636   <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp9">solidSystem</a>-&gt;setCollisionResponseHandler( proximityHandler );
00637 
00638 }
00639 
00640 
00641 
00642 
00643 <span class="comment">// Spatial</span>
00644 
00645 <span class="keywordtype">void</span> SimulatedTool::setPosition(<span class="keyword">const</span> Point3&amp; pos)       
00646 { 
00647   Transform mountConfiguration = <a class="code" href="classrobot_1_1sim_1_1SimulatedTool.html#robot_1_1sim_1_1SimulatedToolp4">mountSpatial</a>-&gt;getConfiguration();
00648   mountConfiguration.setTranslationComponent(pos);
00649   <a class="code" href="classrobot_1_1sim_1_1SimulatedTool.html#robot_1_1sim_1_1SimulatedToolp4">mountSpatial</a>-&gt;setConfiguration(mountConfiguration); 
00650 }
00651 
00652 <a class="code" href="namespacebase.html#a26">Point3</a> SimulatedTool::getPosition()<span class="keyword"> const                  </span>
00653 <span class="keyword"></span>{
00654   Transform mountConfiguration = <a class="code" href="classrobot_1_1sim_1_1SimulatedTool.html#robot_1_1sim_1_1SimulatedToolp4">mountSpatial</a>-&gt;getConfiguration();
00655   <span class="keywordflow">return</span> mountConfiguration.getTranslation(); 
00656 }
00657 
00658 <span class="keywordtype">void</span> SimulatedTool::setOrientation(<span class="keyword">const</span> Orient&amp; orient) 
00659 { 
00660   Transform mountConfiguration = <a class="code" href="classrobot_1_1sim_1_1SimulatedTool.html#robot_1_1sim_1_1SimulatedToolp4">mountSpatial</a>-&gt;getConfiguration();
00661   mountConfiguration.setRotationComponent(orient);
00662   <a class="code" href="classrobot_1_1sim_1_1SimulatedTool.html#robot_1_1sim_1_1SimulatedToolp4">mountSpatial</a>-&gt;setConfiguration(mountConfiguration); 
00663 }
00664 
00665 Orient SimulatedTool::getOrientation()<span class="keyword"> const               </span>
00666 <span class="keyword"></span>{ 
00667   Transform mountConfiguration = <a class="code" href="classrobot_1_1sim_1_1SimulatedTool.html#robot_1_1sim_1_1SimulatedToolp4">mountSpatial</a>-&gt;getConfiguration();
00668   <span class="keywordflow">return</span> mountConfiguration.getRotation(); 
00669 }
00670 
00671 <span class="keywordtype">void</span> SimulatedTool::setConfiguration(<span class="keyword">const</span> <a class="code" href="classbase_1_1Transform.html">base::Transform</a>&amp; configuration) 
00672 { 
00673   Transform mountConfiguration = configuration;
00674   <a class="code" href="classrobot_1_1sim_1_1SimulatedTool.html#robot_1_1sim_1_1SimulatedToolp4">mountSpatial</a>-&gt;setConfiguration(mountConfiguration); 
00675 }
00676 
00677 <a class="code" href="classbase_1_1Transform.html">base::Transform</a> SimulatedTool::getConfiguration()<span class="keyword"> const    </span>
00678 <span class="keyword"></span>{ 
00679   Transform mountConfiguration = <a class="code" href="classrobot_1_1sim_1_1SimulatedTool.html#robot_1_1sim_1_1SimulatedToolp4">mountSpatial</a>-&gt;getConfiguration();
00680   <span class="keywordflow">return</span> mountConfiguration;
00681 }
00682 
00683 
00684 
00685 
00686 
00687 <span class="keywordtype">void</span> SimulatedTool::attachTo(ref&lt;physics::Solid&gt; manipEESolid)
00688 {
00689   KinematicChain::Link link( chain[0] ); <span class="comment">// first joint params</span>
00690 
00691   <a class="code" href="base.html#a19">Assert</a>(firstSolid);
00692   <a class="code" href="base.html#a19">Assert</a>(manipEESolid);
00693 
00694   <span class="keywordflow">if</span> (<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp10">dynamic</a>) {
00695   
00696     <span class="comment">// attach using a FixedConstraint</span>
00697     <a class="code" href="classrobot_1_1sim_1_1SimulatedTool.html#robot_1_1sim_1_1SimulatedToolp7">mountConstraintGroup</a> = <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp9">solidSystem</a>-&gt;createConstraintGroup();
00698     <a class="code" href="base.html#a19">Assert</a>(!link.isActive());  
00699     ref&lt;FixedConstraint&gt; fixed = <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp9">solidSystem</a>-&gt;createFixedConstraint();
00700     <a class="code" href="classrobot_1_1sim_1_1SimulatedTool.html#robot_1_1sim_1_1SimulatedToolp7">mountConstraintGroup</a>-&gt;addConstraint(fixed);
00701     <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp12">links</a>[0] = manipEESolid;
00702     fixed-&gt;attach(manipEESolid, firstSolid);
00703       
00704   } <span class="comment">// if dynamic</span>
00705   
00706   <a class="code" href="classrobot_1_1sim_1_1SimulatedTool.html#robot_1_1sim_1_1SimulatedToolp6">attached</a> = <span class="keyword">true</span>;
00707 }
00708 
00709 
00710 
00711 <span class="keywordtype">void</span> SimulatedTool::detatch()
00712 {
00713   <span class="keywordflow">if</span> (<a class="code" href="classrobot_1_1sim_1_1SimulatedTool.html#robot_1_1sim_1_1SimulatedToolp6">attached</a>) {
00714     <span class="keyword">const</span> KinematicChain::Link&amp; link(chain[0]);
00715 
00716     <span class="keywordflow">if</span> (<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp10">dynamic</a>) {
00717     
00718       <a class="code" href="base.html#a19">Assert</a>(!link.isActive());
00719   
00720       <a class="code" href="classrobot_1_1sim_1_1SimulatedTool.html#robot_1_1sim_1_1SimulatedToolp7">mountConstraintGroup</a>-&gt;clear();
00721       <a class="code" href="classrobot_1_1sim_1_1SimulatedTool.html#robot_1_1sim_1_1SimulatedToolp7">mountConstraintGroup</a> = ref&lt;ConstraintGroup&gt;(0);
00722       
00723     }
00724       
00725     <a class="code" href="classrobot_1_1sim_1_1SimulatedTool.html#robot_1_1sim_1_1SimulatedToolp6">attached</a>=<span class="keyword">false</span>;
00726   }
00727 
00728 }
00729 
00730 
00731 
00732 
00733 
00734 
00735 
00736 <span class="comment">/*</span>
00737 <span class="comment">base::Point3 SimulatedTool::getEEPosition() const</span>
00738 <span class="comment">{</span>
00739 <span class="comment">  // the end-effector frame is co-incident with the end of the ee solid</span>
00740 <span class="comment"></span>
00741 <span class="comment">  // get the vector offset from ee origin to ee solid origin</span>
00742 <span class="comment">  Vector3 eeToEESolidOffset( eeToEESolid.getTranslation() );</span>
00743 <span class="comment">  // now express it in the world frame</span>
00744 <span class="comment">  Vector3 eeToEESolidOffsetWorld( endSolid-&gt;getOrientation().rotate(eeToEESolidOffset) );</span>
00745 <span class="comment">  // add it to the end solid origin to get the ee origin</span>
00746 <span class="comment"></span>
00747 <span class="comment">  return endSolid-&gt;getPosition() + eeToEESolidOffsetWorld;</span>
00748 <span class="comment">}</span>
00749 <span class="comment"></span>
00750 <span class="comment"></span>
00751 <span class="comment">base::Orient SimulatedTool::getEEOrientation() const</span>
00752 <span class="comment">{</span>
00753 <span class="comment">  Matrix3 eeToEESolidOrient(eeToEESolid.getRotation());</span>
00754 <span class="comment">  return base::Orient(  endSolid-&gt;getOrientation() * Orient(eeToEESolidOrient).getQuat4() );</span>
00755 <span class="comment">}</span>
00756 <span class="comment">*/</span>
00757 
00758 
00759 ref&lt;physics::Collidable&gt; SimulatedTool::createCollidable(CollidableFlags flags)
00760 {
00761   <a class="code" href="base.html#a19">Assert</a>(solidSystem);
00762   ref&lt;CollisionCuller&gt; cc(<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp9">solidSystem</a>-&gt;getCollisionCuller());
00763   ref&lt;CollisionDetector&gt; cd(<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp9">solidSystem</a>-&gt;getCollisionDetector());
00764   <a class="code" href="base.html#a19">Assert</a>(cc); <a class="code" href="base.html#a19">Assert</a>(cd);
00765   
00766   <span class="keyword">const</span> <a class="code" href="namespacebase.html#a5">Real</a> proximityEnvelope = 5.0;
00767   <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp20">linkProximitySurfPosition</a>.resize(<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp12">links</a>.size());
00768   
00769   <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp15">collidables</a>.resize(<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp12">links</a>.size()); <span class="comment">// collidables for each link</span>
00770   <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp16">proximityCollidables</a>.resize(<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp12">links</a>.size());  <span class="comment">// proximity sensor for each link</span>
00771   ref&lt;CollidableGroup&gt; linkCollidableGroup = cc-&gt;createCollidableGroup();
00772   <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp18">proximityCollidableGroup</a> = cc-&gt;createCollidableGroup();
00773 
00774   <span class="comment">// create two Collidables for each link (one that is connected to the Solid</span>
00775   <span class="comment">//  and one for the proximity sensor)</span>
00776   <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> l=1; l&lt;=<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>.size(); l++) {
00777     <span class="comment">// Collidable for link Solid</span>
00778     <a class="code" href="base.html#a19">Assert</a>(links[l]);
00779     <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp15">collidables</a>[l] = <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp12">links</a>[l]-&gt;createCollidable(flags);
00780     linkCollidableGroup-&gt;addCollidable( collidables[l] );
00781     <span class="keywordflow">if</span> (l==1) <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp15">collidables</a>[l]-&gt;setName(<span class="stringliteral">"firstLink"</span>);
00782     
00783     <span class="comment">// cylinder Collidable for proximity around each link</span>
00784     ref&lt;const Shape&gt; linkShape( links[l]-&gt;getShape() );
00785     <a class="code" href="classbase_1_1Vector3.html">Dimension3</a> e = narrow_ref&lt;const Box&gt;(linkShape)-&gt;dimensions()/2.0; <span class="comment">// link Box extent</span>
00786     <a class="code" href="namespacebase.html#a5">Real</a> radius = ( Math::sqrt(e.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o0">x</a>*e.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o0">x</a> + e.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o1">y</a>*e.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o1">y</a>) )*proximityEnvelope;
00787     <a class="code" href="namespacebase.html#a5">Real</a> height = e.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o2">z</a>*2.0;
00788     ref&lt;const Cylinder&gt; collisionShape(NewObj Cylinder(height, radius));
00789     <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp20">linkProximitySurfPosition</a>[l] = radius;
00790 
00791     ref&lt;Collidable&gt; pbody( links[l]-&gt;<a class="code" href="classrobot_1_1sim_1_1SimulatedTool.html#robot_1_1sim_1_1SimulatedToola24">createCollidable</a>(collisionShape, flags) );
00792     pbody-&gt;setInterpenetrationIsNormal(<span class="keyword">true</span>); <span class="comment">// the link solid is normally inside the proximity Collidable</span>
00793     pbody-&gt;setUserClass(SensorCollidableClass); <span class="comment">// cull sensor-sensor collision checks</span>
00794 
00795     <span class="keywordflow">if</span> (l!=1)
00796       pbody-&gt;setName( pbody-&gt;getName()+<span class="stringliteral">" Sensor"</span> );
00797     <span class="keywordflow">else</span>
00798       pbody-&gt;setName(<span class="stringliteral">"firstLink Sensor"</span>);
00799 VisualDebugUtil::addDebugObject(collisionShape, pbody-&gt;getName(), links[l]-&gt;getConfiguration(),<a class="code" href="classgfx_1_1Color4.html">Color4</a>(<span class="stringliteral">"lime green"</span>,0.2));<span class="comment">//!!!</span>
00800 <span class="comment"></span>VisualDebugUtil::addDebugObject(linkShape, links[l]-&gt;<a class="code" href="classbase_1_1Named.html#base_1_1Worlda14">getName</a>(), links[l]-&gt;<a class="code" href="classrobot_1_1sim_1_1SimulatedTool.html#robot_1_1sim_1_1SimulatedToola23">getConfiguration</a>(),<a class="code" href="classgfx_1_1Color4.html">Color4</a>(<span class="stringliteral">"yellow"</span>,0.2));<span class="comment">//!!!</span>
00801 <span class="comment"></span>
00802     <span class="comment">// ref self so we can identify our Collidable quickly in ProximityCollisionResponseHandler</span>
00803     pbody-&gt;setUserData(ref&lt;SimulatedTool&gt;(<span class="keyword">this</span>)); 
00804     <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp16">proximityCollidables</a>[l] = pbody;
00805     <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp18">proximityCollidableGroup</a>-&gt;addCollidable( proximityCollidables[l] );
00806     
00807   }
00808 
00809   <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp18">proximityCollidableGroup</a>-&gt;setChildIntercollisionEnabled(<span class="keyword">false</span>);
00810   <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp18">proximityCollidableGroup</a>-&gt;setUserClass(SensorCollidableClass);
00811   
00812   <a class="code" href="classrobot_1_1sim_1_1SimulatedTool.html#robot_1_1sim_1_1SimulatedToolb5">disableCollisions</a>(collidables, proximityCollidables);
00813   
00814   ref&lt;CollidableGroup&gt; collidableGroup = cc-&gt;createCollidableGroup();
00815   collidableGroup-&gt;addCollidable( linkCollidableGroup );
00816   collidableGroup-&gt;addCollidable( proximityCollidableGroup );
00817   
00818   <span class="keywordflow">return</span> collidableGroup;
00819 }
00820 
00821 
00822 
00823 <a class="code" href="namespacebase.html#a5">Real</a> SimulatedTool::getClosestObjectDistance(Int link)<span class="keyword"> const </span>
00824 <span class="keyword"></span>{ 
00825 <span class="comment">//  Debugln(Tmp,"here lp.size=" &lt;&lt; linkProximity.size());</span>
00826   <span class="keywordflow">if</span> (<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp19">linkProximity</a>.size()&gt;0) {
00827     <a class="code" href="base.html#a19">Assert</a>(link &lt; <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp19">linkProximity</a>.size());
00828     <span class="keywordflow">return</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp19">linkProximity</a>[link].dist; 
00829   }
00830   <span class="keywordflow">else</span> 
00831     <span class="keywordflow">return</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedTools0">maxDist</a>+1.0; 
00832 }
00833 
00834 <a class="code" href="classbase_1_1Vector3.html">base::Vector3</a> SimulatedTool::getClosestObjectDirection(Int link)<span class="keyword"> const </span>
00835 <span class="keyword"></span>{
00836   <span class="keywordflow">if</span> (<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp19">linkProximity</a>.size()&gt;0) {
00837     <a class="code" href="base.html#a19">Assert</a>(link &lt; <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp19">linkProximity</a>.size());
00838     <span class="keywordflow">return</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp19">linkProximity</a>[link].dir;
00839   }
00840   <span class="keywordflow">else</span>
00841     <span class="keywordflow">return</span> Vector3();
00842 }
00843 
00844 <a class="code" href="namespacebase.html#a5">Real</a> SimulatedTool::getClosestObjectSensorPosition(Int link)<span class="keyword"> const </span>
00845 <span class="keyword"></span>{ 
00846   <span class="keywordflow">if</span> (<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp19">linkProximity</a>.size()&gt;0) {
00847     <a class="code" href="base.html#a19">Assert</a>(link &lt; <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp19">linkProximity</a>.size());
00848     <span class="keywordflow">return</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp19">linkProximity</a>[link].intersect;
00849   } 
00850   <span class="keywordflow">else</span> 
00851     <span class="keywordflow">return</span> 0;
00852 }
00853 
00854 
00855 
00856 
00857 <span class="keywordtype">void</span> SimulatedTool::handleCollision(ref&lt;physics::CollisionState&gt; collisionState) 
00858 {
00859   <span class="keyword">typedef</span> SimulatedTool::ProximityData ProximityData;
00860 
00861   <span class="comment">// figure out proximity info for ControlInterface</span>
00862 
00863   <span class="keywordtype">bool</span> firstIsSensor = (collisionState-&gt;collidable1-&gt;getUserData() == ref&lt;SimulatedTool&gt;(<span class="keyword">this</span>));
00864   
00865   <span class="comment">// find the corresponding link</span>
00866   <a class="code" href="namespacebase.html#a2">Int</a> l=1;
00867   <span class="keywordtype">bool</span> found = <span class="keyword">false</span>;
00868   CollidableGroup::const_iterator sc( <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp18">proximityCollidableGroup</a>-&gt;begin() );
00869   CollidableGroup::const_iterator send( <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp18">proximityCollidableGroup</a>-&gt;end() );
00870   <span class="keywordflow">while</span> ((sc != send) &amp;&amp; !found) {
00871     <span class="keywordflow">if</span> (*sc == (firstIsSensor?collisionState-&gt;collidable1:collisionState-&gt;collidable2) )
00872       found = <span class="keyword">true</span>;
00873     <span class="keywordflow">else</span> {
00874       ++sc; ++l;
00875     }
00876   }
00877   
00878   ref&lt;const CollidableBody&gt; body1( narrow_ref&lt;const CollidableBody&gt;(collisionState-&gt;collidable1) );
00879   ref&lt;const CollidableBody&gt; body2( narrow_ref&lt;const CollidableBody&gt;(collisionState-&gt;collidable2) );<span class="comment"></span>
00880 <span class="comment">//!!!Debugln(DJ,"collision: " &lt;&lt; body1-&gt;getName() &lt;&lt; " and " &lt;&lt; body2-&gt;getName());  </span>
00881 <span class="comment"></span>  
00882 
00883   <span class="comment">// now we compute the distance from the axis of the Solid (actually a segment</span>
00884   <span class="comment">//  running along the axis) and the obstacle</span>
00885   ref&lt;const Solid&gt; linkSolid( narrow_ref&lt;const Solid&gt;( links[l] ) );
00886   Transform T( linkSolid-&gt;getConfiguration() );
00887   <a class="code" href="namespacebase.html#a5">Real</a> length( linkLengths[l] );
00888   <a class="code" href="classgfx_1_1Segment3.html">Segment3</a> linkSeg( T*<a class="code" href="namespacebase.html#a26">Point3</a>(0,0,-length/2.0), T*<a class="code" href="namespacebase.html#a26">Point3</a>(0,0,length/2.0) );
00889   
00890   <span class="comment">//  now determine distance between the obstacle and the link segment</span>
00891   ref&lt;const Shape&gt; obstacleShape( (firstIsSensor?body2:body1)-&gt;getShape() );
00892   Transform obstacleT( (firstIsSensor?body2:body1)-&gt;<a class="code" href="classrobot_1_1sim_1_1SimulatedTool.html#robot_1_1sim_1_1SimulatedToola23">getConfiguration</a>() );
00893   <span class="comment">// shortest degment between them</span>
00894   <a class="code" href="classgfx_1_1Segment3.html">Segment3</a> seg( obstacleShape-&gt;shortestSegmentBetween(obstacleT, linkSeg) );
00895 
00896   <a class="code" href="namespacebase.html#a5">Real</a> dist = seg.<a class="code" href="classgfx_1_1Segment3.html#gfx_1_1Segment3a14">length</a>();
00897   Vector3 direction( seg.<a class="code" href="classgfx_1_1Segment3.html#gfx_1_1Segment3o1">e</a> - seg.<a class="code" href="classgfx_1_1Segment3.html#gfx_1_1Segment3o0">s</a> ); <span class="keywordflow">if</span> (dist &gt; 0) direction.normalize();
00898   <a class="code" href="namespacebase.html#a5">Real</a> intersect = (seg.<a class="code" href="classgfx_1_1Segment3.html#gfx_1_1Segment3o1">e</a> - linkSeg.<a class="code" href="classgfx_1_1Segment3.html#gfx_1_1Segment3o0">s</a>).length();
00899   ProximityData proxData(dist, intersect,  direction); 
00900   <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp19">linkProximity</a>[l] = proxData;
00901 
00902 
00903   <span class="keywordflow">if</span> (!firstIsSensor) <a class="code" href="namespacebase.html#a46">base::swap</a>(body1, body2);
00904   <span class="comment"></span>
00905 <span class="comment">//!!! debug  </span>
00906 <span class="comment"></span>  VisualDebugUtil::setColor(body1-&gt;getName(), <a class="code" href="classgfx_1_1Color4.html">Color4</a>(<span class="stringliteral">"red"</span>,0.4)); 
00907 
00908 }
00909 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Jul 29 15:56:43 2004 for OpenSim by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.6 </small></address>
</body>
</html>
