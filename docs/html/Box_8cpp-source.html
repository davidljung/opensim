<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>OpenSim: physics/Box.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>physics/Box.cpp</h1><a href="Box_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/****************************************************************************</span>
00002 <span class="comment">  Copyright (C)1996 David Jung &lt;opensim@pobox.com&gt;</span>
00003 <span class="comment"></span>
00004 <span class="comment">  This program/file is free software; you can redistribute it and/or modify</span>
00005 <span class="comment">  it under the terms of the GNU General Public License as published by</span>
00006 <span class="comment">  the Free Software Foundation; either version 2 of the License, or</span>
00007 <span class="comment">  (at your option) any later version.</span>
00008 <span class="comment">  </span>
00009 <span class="comment">  This program is distributed in the hope that it will be useful,</span>
00010 <span class="comment">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00011 <span class="comment">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00012 <span class="comment">  GNU General Public License for more details. (http://www.gnu.org)</span>
00013 <span class="comment">  </span>
00014 <span class="comment">  You should have received a copy of the GNU General Public License</span>
00015 <span class="comment">  along with this program; if not, write to the Free Software</span>
00016 <span class="comment">  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
00017 <span class="comment">  </span>
00018 <span class="comment">  $Id: Box.cpp 1031 2004-02-11 20:46:36Z jungd $</span>
00019 <span class="comment"> </span>
00020 <span class="comment">****************************************************************************/</span>
00021 
00022 <span class="preprocessor">#include &lt;<a class="code" href="Box.html">physics/Box</a>&gt;</span>
00023 
00024 <span class="preprocessor">#include &lt;<a class="code" href="Externalizer.html">base/Externalizer</a>&gt;</span>
00025 <span class="preprocessor">#include &lt;<a class="code" href="VisualTriangles.html">gfx/VisualTriangles</a>&gt;</span>
00026 <span class="preprocessor">#include &lt;<a class="code" href="Material.html">physics/Material</a>&gt;</span>
00027 <span class="preprocessor">#include &lt;<a class="code" href="Sphere.html">physics/Sphere</a>&gt;</span>
00028 
00029 <span class="preprocessor">#include &lt;osg/Group&gt;</span>
00030 <span class="preprocessor">#include &lt;osg/Geode&gt;</span>
00031 <span class="preprocessor">#include &lt;osg/ShapeDrawable&gt;</span>
00032 
00033 
00034 <span class="keyword">using</span> <a class="code" href="classphysics_1_1Box.html">physics::Box</a>;
00035 
00036 <span class="keyword">using</span> <a class="code" href="classbase_1_1Transform.html">base::Transform</a>;
00037 <span class="keyword">using</span> <a class="code" href="classbase_1_1Vector3.html">base::Point3</a>;
00038 <span class="keyword">using</span> base::dom::DOMNode;
00039 <span class="keyword">using</span> base::dom::DOMElement;
00040 <span class="keyword">using</span> <a class="code" href="classgfx_1_1Color3.html">gfx::Color3</a>;
00041 <span class="keyword">using</span> <a class="code" href="classgfx_1_1VisualTriangles.html">gfx::VisualTriangles</a>;
00042 <span class="keyword">using</span> <a class="code" href="classgfx_1_1Segment3.html">gfx::Segment3</a>;
00043 <span class="keyword">using</span> <a class="code" href="classgfx_1_1Triangle3.html">gfx::Triangle3</a>;
00044 <span class="keyword">using</span> <a class="code" href="classgfx_1_1Quad3.html">gfx::Quad3</a>;
00045 <span class="keyword">using</span> <a class="code" href="classphysics_1_1MassProperties.html">physics::MassProperties</a>;
00046 <span class="keyword">using</span> <a class="code" href="classphysics_1_1CollisionModel.html">physics::CollisionModel</a>;
00047 
00048 <span class="keyword">using</span> osg::Node;
00049 <span class="keyword">using</span> osg::Group;
00050 <span class="keyword">using</span> osg::Geode;
00051 
00052 
00053 Box::Box(Real width, Real height, Real depth)
00054   : dim(width,height,depth), massPropertiesCached(false)
00055 {}
00056 
00057 Box::Box(<span class="keyword">const</span> Box&amp; b) 
00058   : dim(b.dim), massPropertiesCached(false)
00059 {}
00060 
00061 Box::~Box() 
00062 {
00063 }
00064 
00065 
00066 <span class="keyword">const</span> <a class="code" href="classphysics_1_1MassProperties.html">MassProperties</a>&amp; Box::getMassProperties(ref&lt;const Material&gt; material)<span class="keyword"> const</span>
00067 <span class="keyword"></span>{
00068   <span class="keywordflow">if</span> (massPropertiesCached &amp;&amp; (density == material-&gt;density()))
00069     <span class="keywordflow">return</span> massProperties;
00070 
00071   density = material-&gt;density();
00072   
00073   <a class="code" href="namespacebase.html#a5">Real</a> dx = dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o0">x</a>;
00074   <a class="code" href="namespacebase.html#a5">Real</a> dy = dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o1">y</a>;
00075   <a class="code" href="namespacebase.html#a5">Real</a> dz = dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o2">z</a>; 
00076   
00077   <a class="code" href="namespacebase.html#a5">Real</a> volume = dx*dy*dz;
00078   massProperties.<a class="code" href="classphysics_1_1MassProperties.html#physics_1_1MassPropertieso0">mass</a> = volume*density;
00079   
00080   <a class="code" href="namespacebase.html#a5">Real</a> k = massProperties.<a class="code" href="classphysics_1_1MassProperties.html#physics_1_1MassPropertieso0">mass</a>/12.0;
00081   Matrix3 Ibody;
00082   Ibody.e(1,1) = (dy*dy + dz*dz)*k;
00083   Ibody.e(2,2) = (dx*dx + dz*dz)*k;
00084   Ibody.e(3,3) = (dx*dx + dy*dy)*k;
00085   massProperties.<a class="code" href="classphysics_1_1MassProperties.html#physics_1_1MassPropertiesa7">setIbody</a>(Ibody);
00086 
00087   massProperties.<a class="code" href="classphysics_1_1MassProperties.html#physics_1_1MassPropertieso1">centerOfMass</a> = <a class="code" href="namespacebase.html#a26">Point3</a>(0.0,0.0,0.0);
00088   
00089   massPropertiesCached = <span class="keyword">true</span>;
00090 
00091   <span class="keywordflow">return</span> massProperties;
00092 }
00093 
00094 
00095 
00096 osg::Node* Box::createOSGVisual(Visual::Attributes visualAttributes)<span class="keyword"> const</span>
00097 <span class="keyword"></span>{
00098   <span class="keywordflow">if</span> ((node!=0) &amp;&amp; (attributes==visualAttributes))
00099     <span class="keywordflow">return</span> &amp;(*node);
00100 
00101   <span class="comment">// NB: Perhaps we should construct a single Cube for the Box class and</span>
00102   <span class="comment">//  just share it for all boxes, with a scale transform above it?</span>
00103   <span class="comment">//  (slower, but less memory) !!!</span>
00104   <span class="comment">//  (same goes for other Shapes - Cylinder, etc.)</span>
00105 <span class="comment">/* </span>
00106 <span class="comment">  osg::GeoSet* cube = new osg::GeoSet();</span>
00107 <span class="comment"></span>
00108 <span class="comment">  // set up the primitives</span>
00109 <span class="comment">  cube-&gt;setPrimType( osg::GeoSet::QUADS );</span>
00110 <span class="comment">  cube-&gt;setNumPrims( 6 );      // the six square faces</span>
00111 <span class="comment">  </span>
00112 <span class="comment">  // set up the primitive indices</span>
00113 <span class="comment">  int* cubeLengthList = new int[6];</span>
00114 <span class="comment">  cubeLengthList[0] = 4; // each side of the cube has 4 vertices</span>
00115 <span class="comment">  cubeLengthList[1] = 4;</span>
00116 <span class="comment">  cubeLengthList[2] = 4;</span>
00117 <span class="comment">  cubeLengthList[3] = 4;</span>
00118 <span class="comment">  cubeLengthList[4] = 4;</span>
00119 <span class="comment">  cubeLengthList[5] = 4;</span>
00120 <span class="comment">  </span>
00121 <span class="comment">  cube-&gt;setPrimLengths( cubeLengthList );</span>
00122 <span class="comment">  </span>
00123 <span class="comment">  // set up the coordinates.</span>
00124 <span class="comment">  array&lt;Quad3&gt; quads(asQuads());</span>
00125 <span class="comment">  osg::Vec3 *cubeCoords = new osg::Vec3[4*quads.size()];</span>
00126 <span class="comment">  for(Int i=0; i&lt;quads.size(); i++) {</span>
00127 <span class="comment">    const Quad3&amp; q(quads[i]);</span>
00128 <span class="comment">    cubeCoords[4*i  ].set( q.c1.x, q.c1.y, q.c1.z );</span>
00129 <span class="comment">    cubeCoords[4*i+1].set( q.c2.x, q.c2.y, q.c2.z );</span>
00130 <span class="comment">    cubeCoords[4*i+2].set( q.c3.x, q.c3.y, q.c3.z );</span>
00131 <span class="comment">    cubeCoords[4*i+3].set( q.c4.x, q.c4.y, q.c4.z );</span>
00132 <span class="comment">    </span>
00133 <span class="comment">  }</span>
00134 <span class="comment">  */</span>
00135   <span class="comment">/*</span>
00136 <span class="comment">  cubeCoords[0].set( -1.0000f,   1.0000f,  -1.000f );</span>
00137 <span class="comment">  cubeCoords[1].set( 1.0000f,   1.0000f,  -1.0000f );</span>
00138 <span class="comment">  cubeCoords[2].set( 1.0000f,  -1.0000f,  -1.0000f );</span>
00139 <span class="comment">  cubeCoords[3].set( -1.0000f,  -1.0000f,  -1.000 );</span>
00140 <span class="comment">  </span>
00141 <span class="comment">  cubeCoords[4].set( 1.0000f,   1.0000f,  -1.0000f );</span>
00142 <span class="comment">  cubeCoords[5].set( 1.0000f,   1.0000f,   1.0000f );</span>
00143 <span class="comment">  cubeCoords[6].set( 1.0000f,  -1.0000f,   1.0000f );</span>
00144 <span class="comment">  cubeCoords[7].set( 1.0000f,  -1.0000f,  -1.0000f );</span>
00145 <span class="comment">  </span>
00146 <span class="comment">  cubeCoords[8].set( 1.0000f,   1.0000f,   1.0000f );</span>
00147 <span class="comment">  cubeCoords[9].set( -1.0000f,   1.0000f,   1.000f );</span>
00148 <span class="comment">  cubeCoords[10].set( -1.0000f,  -1.0000f,   1.000f );</span>
00149 <span class="comment">  cubeCoords[11].set( 1.0000f,  -1.0000f,   1.0000f );</span>
00150 <span class="comment">  </span>
00151 <span class="comment">  cubeCoords[12].set( -1.0000f,   1.0000f,   1.000 );</span>
00152 <span class="comment">  cubeCoords[13].set( -1.0000f,   1.0000f,  -1.000 );</span>
00153 <span class="comment">  cubeCoords[14].set( -1.0000f,  -1.0000f,  -1.000 );</span>
00154 <span class="comment">  cubeCoords[15].set( -1.0000f,  -1.0000f,   1.000 );</span>
00155 <span class="comment">  </span>
00156 <span class="comment">  cubeCoords[16].set( -1.0000f,   1.0000f,   1.000 );</span>
00157 <span class="comment">  cubeCoords[17].set( 1.0000f,   1.0000f,   1.0000f );</span>
00158 <span class="comment">  cubeCoords[18].set( 1.0000f,   1.0000f,  -1.0000f );</span>
00159 <span class="comment">  cubeCoords[19].set( -1.0000f,   1.0000f,  -1.000f );</span>
00160 <span class="comment">  </span>
00161 <span class="comment">  cubeCoords[20].set( -1.0000f,  -1.0000f,   1.000f );</span>
00162 <span class="comment">  cubeCoords[21].set( -1.0000f,  -1.0000f,  -1.000f );</span>
00163 <span class="comment">  cubeCoords[22].set( 1.0000f,  -1.0000f,  -1.0000f );</span>
00164 <span class="comment">  cubeCoords[23].set( 1.0000f,  -1.0000f,   1.0000f );</span>
00165 <span class="comment">  </span>
00166 <span class="comment"></span>
00167 <span class="comment">  // !!! need to subdivide here for better lighting</span>
00168 <span class="comment">  // maybe make some LOD nodes.</span>
00169 <span class="comment"></span>
00170 <span class="comment">  // Scale to dimensions</span>
00171 <span class="comment">  for(Int c=0; c&lt;24; c++) {</span>
00172 <span class="comment">    cubeCoords[c].x() *= dim.x/2.0;</span>
00173 <span class="comment">    cubeCoords[c].y() *= dim.y/2.0;</span>
00174 <span class="comment">    cubeCoords[c].z() *= dim.z/2.0;</span>
00175 <span class="comment">  }</span>
00176 <span class="comment">*/</span>
00177 <span class="comment">/*</span>
00178 <span class="comment">  cube-&gt;setCoords( cubeCoords );</span>
00179 <span class="comment">    </span>
00180 <span class="comment">  // set up the normals.</span>
00181 <span class="comment">  osg::Vec3 *cubeNormals = new osg::Vec3[6];</span>
00182 <span class="comment">  cubeNormals[0].set(0.0f,0.0f,-1.0f);</span>
00183 <span class="comment">  cubeNormals[1].set(1.0f,0.0f,0.0f);</span>
00184 <span class="comment">  cubeNormals[2].set(0.0f,0.0f,1.0f);</span>
00185 <span class="comment">  cubeNormals[3].set(-1.0f,0.0f,0.0f);</span>
00186 <span class="comment">  cubeNormals[4].set(0.0f,1.0f,0.0f);</span>
00187 <span class="comment">  cubeNormals[5].set(0.0f,-1.0f,0.0f);</span>
00188 <span class="comment">  cube-&gt;setNormals( cubeNormals );</span>
00189 <span class="comment">  cube-&gt;setNormalBinding( osg::GeoSet::BIND_PERPRIM );</span>
00190 <span class="comment">*/</span>
00191   <span class="comment">// Create a osg::Geode and add the GeoSet </span>
00192   <span class="comment">//  Drawables to it.</span>
00193   osg::Geode* geode = <span class="keyword">new</span> Geode();
00194   geode-&gt;setName(<span class="stringliteral">"Box"</span>);
00195   <span class="comment">//  geode-&gt;addDrawable( cube );</span>
00196   geode-&gt;addDrawable(<span class="keyword">new</span> osg::ShapeDrawable(
00197                           <span class="keyword">new</span> osg::Box(osg::Vec3(0.0f,0.0f,0.0f),dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o0">x</a>,dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o1">y</a>,dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o2">z</a>)));
00198 
00199   <span class="keywordflow">if</span> (!(visualAttributes &amp; Visual::ShowAxes)) 
00200     node = geode;
00201   <span class="keywordflow">else</span> {
00202     <span class="keywordflow">if</span> (dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o0">x</a> &gt; 0.16)  <span class="comment">//!!!</span>
00203 <span class="comment"></span>      node=geode; <span class="comment">//!!! </span>
00204 <span class="comment"></span>    <span class="keywordflow">else</span> {<span class="comment">//!!!</span>
00205 <span class="comment"></span>    <span class="comment">// create axes </span>
00206     Group* group = <span class="keyword">new</span> Group();
00207     group-&gt;addChild( geode );
00208     group-&gt;addChild( <a class="code" href="classphysics_1_1Shape.html#physics_1_1Torusf0">createOSGAxes</a>(<a class="code" href="classphysics_1_1Box.html#physics_1_1Boxa5">dimensions</a>()) );
00209     node = group;
00210     }<span class="comment">//!!!</span>
00211 <span class="comment"></span>  }
00212   attributes = visualAttributes;
00213   <span class="keywordflow">return</span> &amp;(*node);
00214 }
00215 
00216 
00217 
00218 array&lt;Quad3&gt; Box::asQuads()<span class="keyword"> const</span>
00219 <span class="keyword"></span>{
00220   array&lt;Quad3&gt; quads;
00221   quads.push_back(Quad3(<a class="code" href="namespacebase.html#a26">Point3</a>(-1, 1,-1),
00222                         <a class="code" href="namespacebase.html#a26">Point3</a>( 1, 1,-1),
00223                         <a class="code" href="namespacebase.html#a26">Point3</a>( 1,-1,-1),
00224                         <a class="code" href="namespacebase.html#a26">Point3</a>(-1,-1,-1)));
00225                         
00226   quads.push_back(Quad3(<a class="code" href="namespacebase.html#a26">Point3</a>( 1, 1,-1),
00227                         <a class="code" href="namespacebase.html#a26">Point3</a>( 1, 1, 1),
00228                         <a class="code" href="namespacebase.html#a26">Point3</a>( 1,-1, 1),
00229                         <a class="code" href="namespacebase.html#a26">Point3</a>( 1,-1,-1)));
00230                         
00231   quads.push_back(Quad3(<a class="code" href="namespacebase.html#a26">Point3</a>( 1, 1, 1),
00232                         <a class="code" href="namespacebase.html#a26">Point3</a>(-1, 1, 1),
00233                         <a class="code" href="namespacebase.html#a26">Point3</a>(-1,-1, 1),
00234                         <a class="code" href="namespacebase.html#a26">Point3</a>( 1,-1, 1)));
00235                         
00236   quads.push_back(Quad3(<a class="code" href="namespacebase.html#a26">Point3</a>(-1, 1, 1),
00237                         <a class="code" href="namespacebase.html#a26">Point3</a>(-1, 1,-1),
00238                         <a class="code" href="namespacebase.html#a26">Point3</a>(-1,-1,-1),
00239                         <a class="code" href="namespacebase.html#a26">Point3</a>(-1,-1, 1)));
00240                         
00241   quads.push_back(Quad3(<a class="code" href="namespacebase.html#a26">Point3</a>(-1, 1, 1),
00242                         <a class="code" href="namespacebase.html#a26">Point3</a>( 1, 1, 1),
00243                         <a class="code" href="namespacebase.html#a26">Point3</a>( 1, 1,-1),
00244                         <a class="code" href="namespacebase.html#a26">Point3</a>(-1, 1,-1)));
00245                         
00246   quads.push_back(Quad3(<a class="code" href="namespacebase.html#a26">Point3</a>(-1,-1, 1),
00247                         <a class="code" href="namespacebase.html#a26">Point3</a>(-1,-1,-1),
00248                         <a class="code" href="namespacebase.html#a26">Point3</a>( 1,-1,-1),
00249                         <a class="code" href="namespacebase.html#a26">Point3</a>( 1,-1, 1)));
00250 
00251   <span class="comment">// scale to dimensions</span>
00252   <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;6; i++) {
00253     Quad3&amp; q(quads[i]);
00254     <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> c=0; c&lt;4; c++) {
00255       <a class="code" href="namespacebase.html#a26">Point3</a>&amp; cc(q[c]);
00256       cc.x *= dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o0">x</a>/2.0;
00257       cc.y *= dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o1">y</a>/2.0;
00258       cc.z *= dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o2">z</a>/2.0;
00259     }
00260   }                     
00261                         
00262   <span class="keywordflow">return</span> quads;                         
00263 }
00264 
00265 
00266 Segment3 Box::shortestSegmentBetween(<span class="keyword">const</span> Transform&amp; t, <span class="keyword">const</span> Point3&amp; p)<span class="keyword"> const</span>
00267 <span class="keyword"></span>{
00268   array&lt;Quad3&gt; quads(<a class="code" href="classphysics_1_1Box.html#physics_1_1Boxb0">asQuads</a>());
00269   <a class="code" href="namespacebase.html#a5">Real</a> dist2 = consts::maxReal;
00270   <a class="code" href="namespacebase.html#a26">Point3</a> closest;
00271   <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;quads.size(); i++) {
00272     quads[i].transform(t);
00273     <a class="code" href="namespacebase.html#a26">Point3</a> cp(quads[i].pointClosestTo(p));
00274     <a class="code" href="namespacebase.html#a5">Real</a> d2 = (p-cp).norm();
00275     <span class="keywordflow">if</span> (d2 &lt; dist2) {
00276       dist2 = d2;
00277       closest = cp;
00278     }
00279   }
00280   <span class="keywordflow">return</span> Segment3(closest,p);
00281 }
00282 
00283 
00284 Segment3 Box::shortestSegmentBetween(<span class="keyword">const</span> Transform&amp; t, <span class="keyword">const</span> Segment3&amp; s)<span class="keyword"> const</span>
00285 <span class="keyword"></span>{
00286   array&lt;Quad3&gt; quads(<a class="code" href="classphysics_1_1Box.html#physics_1_1Boxb0">asQuads</a>());
00287   <a class="code" href="namespacebase.html#a5">Real</a> dist2 = consts::maxReal;
00288   Segment3 shortest;
00289   <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;quads.size(); i++) {
00290     quads[i].transform(t);
00291     Segment3 ss(quads[i].<a class="code" href="classphysics_1_1Box.html#physics_1_1Boxa9">shortestSegmentBetween</a>(s));
00292     <a class="code" href="namespacebase.html#a5">Real</a> d2 = ss.norm();
00293     <span class="keywordflow">if</span> (d2 &lt; dist2) {
00294       dist2 = d2;
00295       shortest = ss;
00296     }
00297   }
00298   <span class="keywordflow">return</span> shortest;
00299 }
00300 
00301   
00302 Segment3 Box::shortestSegmentBetween(<span class="keyword">const</span> Transform&amp; t, <span class="keyword">const</span> Triangle3&amp; tri)<span class="keyword"> const</span>
00303 <span class="keyword"></span>{
00304   array&lt;Quad3&gt; quads(<a class="code" href="classphysics_1_1Box.html#physics_1_1Boxb0">asQuads</a>());
00305   <a class="code" href="namespacebase.html#a5">Real</a> dist2 = consts::maxReal;
00306   Segment3 shortest;
00307   <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;quads.size(); i++) {
00308     quads[i].transform(t);
00309     Segment3 ss(quads[i].<a class="code" href="classphysics_1_1Box.html#physics_1_1Boxa9">shortestSegmentBetween</a>(tri));
00310     <a class="code" href="namespacebase.html#a5">Real</a> d2 = ss.norm();
00311     <span class="keywordflow">if</span> (d2 &lt; dist2) {
00312       dist2 = d2;
00313       shortest = ss;
00314     }
00315   }
00316   <span class="keywordflow">return</span> shortest;
00317 }
00318 
00319   
00320 Segment3 Box::shortestSegmentBetween(<span class="keyword">const</span> Transform&amp; t, <span class="keyword">const</span> Quad3&amp; q)<span class="keyword"> const</span>
00321 <span class="keyword"></span>{
00322   array&lt;Quad3&gt; quads(<a class="code" href="classphysics_1_1Box.html#physics_1_1Boxb0">asQuads</a>());
00323   <a class="code" href="namespacebase.html#a5">Real</a> dist2 = consts::maxReal;
00324   Segment3 shortest;
00325   <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;quads.size(); i++) {
00326     quads[i].transform(t);
00327     Segment3 ss(quads[i].<a class="code" href="classphysics_1_1Box.html#physics_1_1Boxa9">shortestSegmentBetween</a>(q));
00328     <a class="code" href="namespacebase.html#a5">Real</a> d2 = ss.norm();
00329     <span class="keywordflow">if</span> (d2 &lt; dist2) {
00330       dist2 = d2;
00331       shortest = ss;
00332     }
00333   }
00334   <span class="keywordflow">return</span> shortest;
00335 }
00336 
00337   
00338 Segment3 Box::shortestSegmentBetween(<span class="keyword">const</span> Transform&amp; t1, ref&lt;const Shape&gt; s, <span class="keyword">const</span> Transform&amp; t2)<span class="keyword"> const</span>
00339 <span class="keyword"></span>{
00340   Segment3 shortest;
00341   
00342   <span class="keywordflow">if</span> (<a class="code" href="base.html#a25">instanceof</a>(*s, <span class="keyword">const</span> Box)) {
00343     ref&lt;const Box&gt; b(narrow_ref&lt;const Box&gt;(s));
00344     
00345     array&lt;Quad3&gt; quads1(<a class="code" href="classphysics_1_1Box.html#physics_1_1Boxb0">asQuads</a>());
00346     array&lt;Quad3&gt; quads2(b-&gt;asQuads());
00347     <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;quads1.size(); i++) quads1[i].transform(t1);
00348     <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;quads2.size(); i++) quads2[i].transform(t2);
00349     
00350     <a class="code" href="namespacebase.html#a5">Real</a> dist2 = consts::maxReal;
00351     <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i1=0; i1&lt;quads1.size(); i1++) {
00352       <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i2=0; i2&lt;quads2.size(); i2++) {
00353         Segment3 ss(quads1[i1].<a class="code" href="classphysics_1_1Box.html#physics_1_1Boxa9">shortestSegmentBetween</a>(quads2[i2]));
00354         <a class="code" href="namespacebase.html#a5">Real</a> d2 = ss.norm();
00355         <span class="keywordflow">if</span> (d2 &lt; dist2) {
00356           dist2 = d2;
00357           shortest = ss;
00358         }
00359       }
00360     }
00361     
00362   } 
00363   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="base.html#a25">instanceof</a>(*s, <span class="keyword">const</span> Sphere)) {
00364     
00365     ref&lt;const Sphere&gt; sphere(narrow_ref&lt;const Sphere&gt;(s));
00366     <span class="comment">// just find the shortest segment between the box and the center, then</span>
00367     <span class="comment">//  shorten it to the sphere surface</span>
00368     <span class="comment">// (doesn't handle case where they intersect properly)</span>
00369     <a class="code" href="namespacebase.html#a26">Point3</a> sphereCenter( t2.getTranslation() );
00370     shortest = Segment3( <a class="code" href="classphysics_1_1Box.html#physics_1_1Boxa9">shortestSegmentBetween</a>( t1, sphereCenter ) );
00371 
00372     <a class="code" href="namespacebase.html#a5">Real</a> r(sphere-&gt;radius());
00373     <span class="comment">// shorten it by r on the e end</span>
00374     Vector3 dir(shortest.e-shortest.s);
00375     shortest.e = shortest.s + dir*(1-(r/dir.length()));
00376     
00377   }
00378   <span class="keywordflow">else</span> { <span class="comment">// other shapes not yet implemented;</span>
00379     <a class="code" href="debugtools.html#a12">Unimplemented</a>; 
00380   }
00381   
00382   <span class="keywordflow">return</span> shortest;
00383 }
00384  
00385 
00386 
00387 gfx::Point3 Box::support(<span class="keyword">const</span> gfx::Vector3&amp; v)<span class="keyword"> const</span>
00388 <span class="keyword"></span>{
00389   <span class="keywordflow">return</span> gfx::Point3( (v.x&lt;0)?-(dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o0">x</a>/2.0):(dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o0">x</a>/2.0),
00390                       (v.y&lt;0)?-(dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o1">y</a>/2.0):(dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o1">y</a>/2.0),
00391                       (v.z&lt;0)?-(dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o2">z</a>/2.0):(dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o2">z</a>/2.0) );
00392 }
00393 
00394 
00395 <a class="code" href="classbase_1_1ref.html">base::ref&lt;CollisionModel&gt;</a> Box::getCollisionModel(CollisionModel::CollisionModelType modelType)<span class="keyword"> const</span>
00396 <span class="keyword"></span>{
00397   <span class="keywordflow">if</span> ((collisionModel!=0) &amp;&amp; 
00398       ((this-&gt;modelType==modelType) || (modelType==CollisionModel::AnyModel)))
00399     <span class="keywordflow">return</span> collisionModel;
00400 
00401   collisionModel = Shape::getCollisionModel(modelType);
00402   this-&gt;modelType=modelType;
00403 
00404   <span class="keywordflow">return</span> collisionModel;
00405 }
00406 
00407  
00408 <span class="keywordtype">void</span> Box::serialize(<a class="code" href="classbase_1_1Serializer.html">base::Serializer</a>&amp; s)
00409 {
00410   s(dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o0">x</a>,<span class="stringliteral">"x"</span>)(dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o1">y</a>,<span class="stringliteral">"y"</span>)(dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o2">z</a>,<span class="stringliteral">"z"</span>);
00411 
00412   <span class="keywordflow">if</span> (s.<a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializera8">isInput</a>()) {
00413     massPropertiesCached = <span class="keyword">false</span>;
00414     node = 0;
00415     collisionModel = ref&lt;CollisionModel&gt;(0);
00416   }
00417 }
00418 
00419 
00420 
00421 <span class="keywordtype">bool</span> Box::formatSupported(String format, Real version, ExternalizationType type)<span class="keyword"> const</span>
00422 <span class="keyword"></span>{ 
00423   <span class="keywordflow">return</span> ( (format==<span class="stringliteral">"xml"</span>) &amp;&amp; (version==1.0) ); 
00424 }
00425 
00426 
00427 <span class="keywordtype">void</span> Box::externalize(<a class="code" href="classbase_1_1Externalizer.html">base::Externalizer</a>&amp; e, String format, Real version)
00428 {
00429   <span class="keywordflow">if</span> (format == <span class="stringliteral">""</span>) format = <span class="stringliteral">"xml"</span>;
00430                                                                                                                                                                                                     
00431   <span class="keywordflow">if</span> (!<a class="code" href="classphysics_1_1Box.html#physics_1_1Boxa19">formatSupported</a>(format,version,e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera6">ioType</a>()))
00432     <span class="keywordflow">throw</span> std::invalid_argument(<a class="code" href="base.html#a15">Exception</a>(<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"format "</span>)+format+<span class="stringliteral">" v"</span>+base::realToString(version)+<span class="stringliteral">" unsupported"</span>));
00433                                                                                                                                                                                                     
00434   <span class="keywordflow">if</span> (e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera4">isOutput</a>()) {
00435 
00436     DOMElement*  boxElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"box"</span>);
00437     e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera26">setElementAttribute</a>(boxElem,<span class="stringliteral">"width"</span>,base::realToString(dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o0">x</a>));
00438     e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera26">setElementAttribute</a>(boxElem,<span class="stringliteral">"height"</span>,base::realToString(dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o1">y</a>));
00439     e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera26">setElementAttribute</a>(boxElem,<span class="stringliteral">"depth"</span>,base::realToString(dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o2">z</a>));
00440     
00441     e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera21">appendElement</a>(boxElem);
00442   }
00443   <span class="keywordflow">else</span> {
00444 
00445     massPropertiesCached = <span class="keyword">false</span>;
00446     node = 0;
00447     collisionModel = ref&lt;CollisionModel&gt;(0);
00448 
00449     DOMNode* context = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera16">context</a>();
00450     
00451     DOMElement* boxElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera36">getFirstElement</a>(context, <span class="stringliteral">"box"</span>);
00452         
00453     dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o0">x</a> = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere12">toReal</a>( e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera42">getDefaultedElementAttribute</a>(boxElem, <span class="stringliteral">"width"</span>, <span class="stringliteral">"1"</span>) );
00454     dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o1">y</a> = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere12">toReal</a>( e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera42">getDefaultedElementAttribute</a>(boxElem, <span class="stringliteral">"height"</span>, <span class="stringliteral">"1"</span>) );
00455     dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o2">z</a> = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere12">toReal</a>( e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera42">getDefaultedElementAttribute</a>(boxElem, <span class="stringliteral">"depth"</span>, <span class="stringliteral">"1"</span>) );
00456     
00457     e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera39">removeElement</a>(boxElem);
00458     
00459   }
00460 }
00461 
00462 
00463 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Jul 29 15:56:21 2004 for OpenSim by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.6 </small></address>
</body>
</html>
