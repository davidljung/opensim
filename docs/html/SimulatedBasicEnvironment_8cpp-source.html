<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>OpenSim: robot/sim/SimulatedBasicEnvironment.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>robot/sim/SimulatedBasicEnvironment.cpp</h1><a href="SimulatedBasicEnvironment_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/****************************************************************************</span>
00002 <span class="comment">  Copyright (C)2003 David Jung &lt;opensim@pobox.com&gt;</span>
00003 <span class="comment"></span>
00004 <span class="comment">  This program/file is free software; you can redistribute it and/or modify</span>
00005 <span class="comment">  it under the terms of the GNU General Public License as published by</span>
00006 <span class="comment">  the Free Software Foundation; either version 2 of the License, or</span>
00007 <span class="comment">  (at your option) any later version.</span>
00008 <span class="comment">  </span>
00009 <span class="comment">  This program is distributed in the hope that it will be useful,</span>
00010 <span class="comment">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00011 <span class="comment">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00012 <span class="comment">  GNU General Public License for more details. (http://www.gnu.org)</span>
00013 <span class="comment">  </span>
00014 <span class="comment">  You should have received a copy of the GNU General Public License</span>
00015 <span class="comment">  along with this program; if not, write to the Free Software</span>
00016 <span class="comment">  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
00017 <span class="comment">  </span>
00018 <span class="comment">  $Id: SimulatedBasicEnvironment.cpp 1033 2004-02-11 20:47:52Z jungd $</span>
00019 <span class="comment">  $Revision: 1.14 $</span>
00020 <span class="comment">  $Date: 2004-02-11 15:47:52 -0500 (Wed, 11 Feb 2004) $</span>
00021 <span class="comment">  $Author: jungd $</span>
00022 <span class="comment"> </span>
00023 <span class="comment">****************************************************************************/</span>
00024 
00025 <span class="preprocessor">#include &lt;<a class="code" href="SimulatedBasicEnvironment.html">robot/sim/SimulatedBasicEnvironment</a>&gt;</span>
00026 
00027 <span class="comment">// OSG</span>
00028 <span class="preprocessor">#include &lt;osg/Vec4&gt;</span>
00029 <span class="preprocessor">#include &lt;osg/Group&gt;</span>
00030 <span class="preprocessor">#include &lt;osg/Notify&gt;</span>
00031 <span class="preprocessor">#include &lt;osg/Fog&gt;</span>
00032 <span class="preprocessor">#include &lt;osg/Node&gt;</span>
00033 <span class="preprocessor">#include &lt;osg/NodeVisitor&gt;</span>
00034 <span class="preprocessor">#include &lt;osg/Material&gt;</span>
00035 
00036 <span class="preprocessor">#include &lt;<a class="code" href="Externalizer.html">base/Externalizer</a>&gt;</span>
00037 <span class="preprocessor">#include &lt;<a class="code" href="externalization__error.html">base/externalization_error</a>&gt;</span>
00038 <span class="preprocessor">#include &lt;<a class="code" href="Application.html">base/Application</a>&gt;</span>
00039 <span class="preprocessor">#include &lt;<a class="code" href="VFile.html">base/VFile</a>&gt;</span>
00040 <span class="preprocessor">#include &lt;<a class="code" href="Shape.html">physics/Shape</a>&gt;</span>
00041 <span class="preprocessor">#include &lt;<a class="code" href="Box.html">physics/Box</a>&gt;</span>
00042 <span class="preprocessor">#include &lt;<a class="code" href="Sphere.html">physics/Sphere</a>&gt;</span>
00043 <span class="preprocessor">#include &lt;<a class="code" href="Material.html">physics/Material</a>&gt;</span>
00044 <span class="preprocessor">#include &lt;<a class="code" href="Solid.html">physics/Solid</a>&gt;</span>
00045 <span class="preprocessor">#include &lt;<a class="code" href="ODESolidSystem.html">physics/ODESolidSystem</a>&gt;</span>
00046 <span class="preprocessor">#include &lt;<a class="code" href="ConstraintGroup.html">physics/ConstraintGroup</a>&gt;</span>
00047 <span class="preprocessor">#include &lt;<a class="code" href="FixedConstraint.html">physics/FixedConstraint</a>&gt;</span>
00048 
00049 
00050 <span class="keyword">using</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html">robot::sim::SimulatedBasicEnvironment</a>;
00051 
00052 <span class="keyword">using</span> <a class="code" href="classbase_1_1Externalizer.html">base::Externalizer</a>;
00053 <span class="keyword">using</span> <a class="code" href="classbase_1_1externalization__error.html">base::externalization_error</a>;
00054 <span class="keyword">using</span> <a class="code" href="classbase_1_1Orient.html">base::Orient</a>;
00055 <span class="keyword">using</span> <a class="code" href="classbase_1_1Vector3.html">base::Dimension3</a>;
00056 <span class="keyword">using</span> <a class="code" href="classbase_1_1Application.html">base::Application</a>;
00057 <span class="keyword">using</span> <a class="code" href="classbase_1_1VFile.html">base::VFile</a>;
00058 <span class="keyword">using</span> <a class="code" href="classbase_1_1PathName.html">base::PathName</a>;
00059 <span class="keyword">using</span> base::dom::DOMNode;
00060 <span class="keyword">using</span> base::dom::DOMElement;
00061 <span class="keyword">using</span> <a class="code" href="classphysics_1_1Shape.html">physics::Shape</a>;
00062 <span class="keyword">using</span> <a class="code" href="classphysics_1_1Box.html">physics::Box</a>;
00063 <span class="keyword">using</span> <a class="code" href="classphysics_1_1Sphere.html">physics::Sphere</a>;
00064 <span class="keyword">using</span> <a class="code" href="classphysics_1_1Material.html">physics::Material</a>;
00065 <span class="keyword">using</span> <a class="code" href="classphysics_1_1Solid.html">physics::Solid</a>;
00066 <span class="keyword">using</span> <a class="code" href="classphysics_1_1SolidSystem.html">physics::SolidSystem</a>;
00067 <span class="keyword">using</span> <a class="code" href="classphysics_1_1ODESolidSystem.html">physics::ODESolidSystem</a>;
00068 <span class="keyword">using</span> <a class="code" href="classphysics_1_1ConstraintGroup.html">physics::ConstraintGroup</a>;
00069 <span class="keyword">using</span> <a class="code" href="classphysics_1_1FixedConstraint.html">physics::FixedConstraint</a>;
00070 <span class="keyword">using</span> <a class="code" href="classphysics_1_1Collidable.html">physics::Collidable</a>;
00071 <span class="keyword">using</span> <a class="code" href="classphysics_1_1CollisionCuller.html">physics::CollisionCuller</a>;
00072 <span class="keyword">using</span> <a class="code" href="classrobot_1_1sim_1_1BasicEnvironment.html">robot::sim::BasicEnvironment</a>;
00073 <span class="keyword">using</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedRobot.html">robot::sim::SimulatedRobot</a>;
00074 
00075 
00076 
00077 <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmenta0">SimulatedBasicEnvironment::SimulatedBasicEnvironment</a>(ref&lt;base::VFileSystem&gt; fs, ref&lt;base::Cache&gt; cache, <span class="keyword">const</span> String&amp; name, <span class="keywordtype">bool</span> dynamic)
00078   : <a class="code" href="classrobot_1_1sim_1_1BasicEnvironment.html">BasicEnvironment</a>(fs, cache, name), OSGWorld(fs, cache, name), dynamic(dynamic)
00079 {
00080   <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentb0">construct</a>();
00081 }
00082 
00083 <span class="comment"></span>
00084 <span class="comment">/// \todo clone anchored state of robot platform</span>
00085 <span class="comment"></span><a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmenta0">SimulatedBasicEnvironment::SimulatedBasicEnvironment</a>(<span class="keyword">const</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html">SimulatedBasicEnvironment</a>&amp; e)
00086   : <a class="code" href="classrobot_1_1sim_1_1BasicEnvironment.html">BasicEnvironment</a>(e), OSGWorld(e), dynamic(e.dynamic)
00087 {
00088   <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentb0">construct</a>();
00089   
00090   <span class="comment">// duplicate robots</span>
00091   RobotList::const_iterator r = e.<a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp7">robots</a>.<a class="code" href="classbase_1_1reflist.html#base_1_1reflista0">begin</a>();
00092   RobotAnchoredList::const_iterator ra = <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp10">robotsAnchored</a>.begin();
00093   RobotList::const_iterator rend = e.<a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp7">robots</a>.<a class="code" href="classbase_1_1reflist.html#base_1_1reflista3">end</a>();
00094   <span class="keywordflow">while</span> (r != rend) {
00095     ref&lt;SimulatedRobot&gt; <a class="code" href="robot_2Jamfile_8ft.html#a0">robot</a>(*r);
00096     <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmenta7">addRobot</a>(<a class="code" href="robot_2Jamfile_8ft.html#a0">robot</a>-&gt;getRobotDescription(), 
00097              <a class="code" href="robot_2Jamfile_8ft.html#a0">robot</a>-&gt;getPosition(), <a class="code" href="robot_2Jamfile_8ft.html#a0">robot</a>-&gt;getOrientation(), 
00098              *ra); 
00099     ++r;
00100     ++ra;
00101   }
00102 
00103   <span class="comment">// duplicate tools</span>
00104   ToolList::const_iterator t = e.<a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp8">tools</a>.<a class="code" href="classbase_1_1reflist.html#base_1_1reflista0">begin</a>();
00105   ToolList::const_iterator tend = e.<a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp8">tools</a>.<a class="code" href="classbase_1_1reflist.html#base_1_1reflista3">end</a>();
00106   <span class="keywordflow">while</span> (t != tend) {
00107     ref&lt;const SolidTool&gt; solidTool(narrow_ref&lt;const SolidTool&gt;(*t));
00108     <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmenta11">addTool</a>(solidTool-&gt;getToolDescription(), solidTool-&gt;getPosition(), solidTool-&gt;getOrientation());
00109     ++t;
00110   }
00111 
00112   
00113   <span class="comment">// duplicate obstacles</span>
00114   <span class="comment">//  (should be an easier way sometime...)</span>
00115   ObstacleList::const_iterator o = e.<a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp9">obstacles</a>.<a class="code" href="classbase_1_1reflist.html#base_1_1reflista0">begin</a>();
00116   ObstacleList::const_iterator oend = e.<a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp9">obstacles</a>.<a class="code" href="classbase_1_1reflist.html#base_1_1reflista3">end</a>();
00117   <span class="keywordflow">while</span> (o != oend) {
00118     ref&lt;SolidObstacle&gt; obst(*o);
00119     ref&lt;const Solid&gt; solid(obst-&gt;solid);
00120     ref&lt;const Shape&gt; shape(solid-&gt;getShape());
00121     
00122     <span class="keywordflow">if</span> (<a class="code" href="base.html#a25">instanceof</a>(*shape, <span class="keyword">const</span> Box)) {
00123       ref&lt;const Box&gt; box(narrow_ref&lt;const Box&gt;(shape));
00124       <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmenta17">addBoxObstacle</a>(box-&gt;dimensions(), solid-&gt;getPosition(), solid-&gt;getOrientation(),
00125                      solid-&gt;getMaterial(), solid-&gt;getName());
00126     }
00127     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="base.html#a25">instanceof</a>(*shape, <span class="keyword">const</span> Sphere)) {
00128       ref&lt;const Sphere&gt; sphere(narrow_ref&lt;const Sphere&gt;(shape));
00129       <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmenta18">addSphereObstacle</a>(sphere-&gt;radius(), solid-&gt;getPosition(), solid-&gt;getOrientation(),
00130                         solid-&gt;getMaterial(), solid-&gt;getName());
00131     }
00132     <span class="keywordflow">else</span>
00133       <span class="keywordflow">throw</span> std::runtime_error(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"unhandled obstacle shape"</span>));
00134     
00135     ++o;
00136   }
00137   
00138 }
00139 
00140 
00141 <span class="keywordtype">void</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmenta2">SimulatedBasicEnvironment::setDynamic</a>(<span class="keywordtype">bool</span> enabled)
00142 {
00143   <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp0">dynamic</a> = enabled;
00144   RobotList::const_iterator r = <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp7">robots</a>.<a class="code" href="classbase_1_1reflist.html#base_1_1reflista0">begin</a>();
00145   RobotList::const_iterator rend = <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp7">robots</a>.<a class="code" href="classbase_1_1reflist.html#base_1_1reflista3">end</a>();
00146   <span class="keywordflow">while</span> (r != rend) {
00147     (*r)-&gt;setDynamic(enabled);
00148     ++r;
00149   }
00150 
00151   ToolList::const_iterator t = <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp8">tools</a>.<a class="code" href="classbase_1_1reflist.html#base_1_1reflista0">begin</a>();
00152   ToolList::const_iterator tend = <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp8">tools</a>.<a class="code" href="classbase_1_1reflist.html#base_1_1reflista3">end</a>();
00153   <span class="keywordflow">while</span> (t != tend) {
00154     ref&lt;const SolidTool&gt; solidTool(narrow_ref&lt;const SolidTool&gt;(*t));
00155     solidTool-&gt;simTool-&gt;setDynamic(enabled);
00156     ++t;
00157   }
00158 
00159 }
00160 
00161 
00162 
00163 ref&lt;robot::Robot&gt; <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmenta7">SimulatedBasicEnvironment::addRobot</a>(ref&lt;const robot::RobotDescription&gt; robotDescription,
00164                                                       <span class="keyword">const</span> <a class="code" href="classbase_1_1Vector3.html">base::Point3</a>&amp; position, 
00165                                                       <span class="keyword">const</span> <a class="code" href="classbase_1_1Orient.html">base::Orient</a>&amp; orientation,
00166                                                       <span class="keywordtype">bool</span> anchored)
00167 {
00168   ref&lt;SimulatedRobot&gt; <a class="code" href="robot_2Jamfile_8ft.html#a0">robot</a>(NewObj <a class="code" href="classrobot_1_1sim_1_1SimulatedRobot.html">SimulatedRobot</a>(robotDescription,
00169                                                   position, orientation,
00170                                                   system, dynamic));
00171   <a class="code" href="base.html#a19">Assert</a>(collidables);                                               
00172   ref&lt;Collidable&gt; robotCollidable( <a class="code" href="robot_2Jamfile_8ft.html#a0">robot</a>-&gt;createCollidable() );
00173   <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp2">collidables</a>-&gt;addCollidable( robotCollidable );
00174 
00175   <span class="keywordflow">if</span> (anchored) {
00176     ref&lt;Solid&gt; platformSolid(<a class="code" href="robot_2Jamfile_8ft.html#a0">robot</a>-&gt;getPlatformSolid()); <span class="comment">// get robot's platform Solid</span>
00177     ref&lt;FixedConstraint&gt; fixed(<a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp1">system</a>-&gt;createFixedConstraint()); <span class="comment">// create a fixed constraint</span>
00178     <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp6">cgroup</a>-&gt;addConstraint(fixed); 
00179     fixed-&gt;attach(ground, platformSolid); <span class="comment">// attach platform to ground</span>
00180 
00181     <span class="comment">// tell collision detector not to collide them </span>
00182     ref&lt;Collidable&gt; platformBase( robotCollidable-&gt;findNamed(<span class="stringliteral">"body"</span>) );
00183     <span class="keywordflow">if</span> (platformBase)
00184       <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp4">collisionCuller</a>-&gt;collisionEnable(<span class="keyword">false</span>,groundCollidable,platformBase);
00185   }
00186 
00187   <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp7">robots</a>.<a class="code" href="classbase_1_1reflist.html#base_1_1reflista26">push_back</a>(robot);
00188   <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp10">robotsAnchored</a>.push_back(anchored);
00189   <span class="keywordflow">return</span> <a class="code" href="robot_2Jamfile_8ft.html#a0">robot</a>;
00190 }
00191 <span class="comment"></span>
00192 <span class="comment">/// \todo remove solid &amp; collidable</span>
00193 <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmenta8">SimulatedBasicEnvironment::removeRobot</a>(ref&lt;robot::Robot&gt; robot)
00194 {
00195   <span class="keywordflow">if</span> (<a class="code" href="base.html#a25">instanceof</a>(*robot, <a class="code" href="classrobot_1_1sim_1_1SimulatedRobot.html">SimulatedRobot</a>)) {
00196     ref&lt;SimulatedRobot&gt; simRobot( narrow_ref&lt;SimulatedRobot&gt;(robot));
00197     <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp7">robots</a>.<a class="code" href="classbase_1_1reflist.html#base_1_1reflista48">remove</a>(simRobot);
00198   }
00199   <span class="keywordflow">else</span>
00200     <span class="keywordflow">throw</span> std::invalid_argument(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"unknown robot"</span>));
00201 }
00202 
00203 
00204 ref&lt;BasicEnvironment::Tool&gt; <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmenta11">SimulatedBasicEnvironment::addTool</a>(ref&lt;const robot::ToolDescription&gt; toolDescription,
00205                                                                <span class="keyword">const</span> <a class="code" href="classbase_1_1Vector3.html">base::Point3</a>&amp; position, 
00206                                                                <span class="keyword">const</span> <a class="code" href="classbase_1_1Orient.html">base::Orient</a>&amp; orientation)
00207 {
00208   ref&lt;SimulatedTool&gt; simTool(NewObj SimulatedTool(toolDescription,
00209                                                   position, orientation,
00210                                                   system, dynamic));
00211   <a class="code" href="base.html#a19">Assert</a>(simTool);                                               
00212   <a class="code" href="base.html#a19">Assert</a>(collidables);
00213 
00214   ref&lt;Collidable&gt; toolCollidable( simTool-&gt;createCollidable() );
00215   <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp2">collidables</a>-&gt;addCollidable( toolCollidable );
00216                                                   
00217                                                   
00218   ref&lt;SolidTool&gt; tool(NewObj SolidTool(toolDescription-&gt;getName(),toolDescription,
00219                                        position, orientation, simTool));
00220   <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp8">tools</a>.<a class="code" href="classbase_1_1reflist.html#base_1_1reflista26">push_back</a>(tool);
00221   <span class="keywordflow">return</span> tool;
00222 }
00223 <span class="comment"></span>
00224 <span class="comment">/// \todo remove solid</span>
00225 <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmenta12">SimulatedBasicEnvironment::removeTool</a>(ref&lt;BasicEnvironment::Tool&gt; tool)
00226 {
00227   <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp8">tools</a>.<a class="code" href="classbase_1_1reflist.html#base_1_1reflista48">remove</a>(tool);
00228 }
00229 
00230 
00231 <span class="keywordtype">void</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmenta16">SimulatedBasicEnvironment::placeToolInProximity</a>(ref&lt;Tool&gt; tool, ref&lt;Robot&gt; robot, Int manipulatorIndex)
00232 {
00233    <span class="keywordflow">if</span> (<a class="code" href="base.html#a25">instanceof</a>(*robot, <a class="code" href="classrobot_1_1sim_1_1SimulatedRobot.html">SimulatedRobot</a>)) {
00234      <span class="keywordflow">if</span> (<a class="code" href="base.html#a25">instanceof</a>(*tool, SolidTool)) {
00235        ref&lt;SimulatedRobot&gt; simRobot( narrow_ref&lt;SimulatedRobot&gt;(robot));
00236        ref&lt;SolidTool&gt; solidTool( narrow_ref&lt;SolidTool&gt;(tool) );
00237        ref&lt;SimulatedTool&gt; simTool( solidTool-&gt;simTool );
00238 
00239        simRobot-&gt;placeToolInProximity(simTool, manipulatorIndex);
00240      }
00241      <span class="keywordflow">else</span>
00242        <span class="keywordflow">throw</span> std::invalid_argument(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"unknown tool"</span>));
00243   }
00244   <span class="keywordflow">else</span>
00245     <span class="keywordflow">throw</span> std::invalid_argument(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"unknown robot"</span>));
00246 }
00247 
00248 
00249 
00250 
00251 ref&lt;BasicEnvironment::Obstacle&gt; <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmenta17">SimulatedBasicEnvironment::addBoxObstacle</a>(<a class="code" href="classbase_1_1Vector3.html">base::Dimension3</a> dim, 
00252                                                                           <span class="keyword">const</span> <a class="code" href="classbase_1_1Vector3.html">base::Point3</a>&amp; position, 
00253                                                                           <span class="keyword">const</span> <a class="code" href="classbase_1_1Orient.html">base::Orient</a>&amp; orientation,
00254                                                                           <span class="keyword">const</span> String&amp; name)
00255 {
00256   ref&lt;Material&gt; material(NewObj <a class="code" href="classphysics_1_1Material.html">physics::Material</a>());
00257   material-&gt;setBaseColor(<a class="code" href="classgfx_1_1Color3.html">gfx::Color3</a>(0.7,0.4,0.8)); <span class="comment">// default</span>
00258   material-&gt;setDensity(1.0); <span class="comment">// default</span>
00259 
00260   <span class="keywordflow">return</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmenta17">addBoxObstacle</a>(dim,position,orientation,material,name);
00261 }
00262 
00263 
00264 ref&lt;BasicEnvironment::Obstacle&gt; <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmenta18">SimulatedBasicEnvironment::addSphereObstacle</a>(Real radius,
00265                                                                              <span class="keyword">const</span> <a class="code" href="classbase_1_1Vector3.html">base::Point3</a>&amp; position, 
00266                                                                              <span class="keyword">const</span> <a class="code" href="classbase_1_1Orient.html">base::Orient</a>&amp; orientation,
00267                                                                              <span class="keyword">const</span> String&amp; name)
00268 {
00269   ref&lt;Material&gt; material(NewObj <a class="code" href="classphysics_1_1Material.html">physics::Material</a>());
00270   material-&gt;setBaseColor(<a class="code" href="classgfx_1_1Color3.html">gfx::Color3</a>(0.7,0.4,0.8)); <span class="comment">// default</span>
00271   material-&gt;setDensity(1.0); <span class="comment">// default</span>
00272 
00273   <span class="keywordflow">return</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmenta18">addSphereObstacle</a>(radius,position,orientation,material,name);
00274 }
00275 
00276 
00277 ref&lt;BasicEnvironment::Obstacle&gt; <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmenta17">SimulatedBasicEnvironment::addBoxObstacle</a>(<a class="code" href="classbase_1_1Vector3.html">base::Dimension3</a> dim, 
00278                                                                           <span class="keyword">const</span> <a class="code" href="classbase_1_1Vector3.html">base::Point3</a>&amp; position, 
00279                                                                           <span class="keyword">const</span> <a class="code" href="classbase_1_1Orient.html">base::Orient</a>&amp; orientation,
00280                                                                           ref&lt;const physics::Material&gt; material,
00281                                                                           <span class="keyword">const</span> String&amp; name)
00282 {
00283   ref&lt;Box&gt; box(NewObj Box(dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o0">x</a>,dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o1">y</a>,dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o2">z</a>));
00284   ref&lt;Solid&gt; solid(<a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp1">system</a>-&gt;createSolid(box, material));
00285   solid-&gt;setName( (name==<span class="stringliteral">""</span>)?<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"box obstacle"</span>):name);
00286   <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp1">system</a>-&gt;addSolid(solid);
00287   solid-&gt;setEnabled(dynamic);
00288   solid-&gt;setPosition(position);
00289   solid-&gt;setOrientation(orientation.<a class="code" href="classbase_1_1Orient.html#base_1_1Orienta29">getQuat4</a>());
00290   
00291   ref&lt;Collidable&gt; obstCollidable( solid-&gt;createCollidable() );
00292   <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp2">collidables</a>-&gt;addCollidable( obstCollidable );
00293 
00294   ref&lt;SolidObstacle&gt; obstacle(NewObj SolidObstacle(dim,position,orientation,solid));
00295   <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp9">obstacles</a>.<a class="code" href="classbase_1_1reflist.html#base_1_1reflista26">push_back</a>(obstacle);
00296   <span class="keywordflow">return</span> obstacle;
00297 }
00298 
00299 
00300 ref&lt;BasicEnvironment::Obstacle&gt; <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmenta18">SimulatedBasicEnvironment::addSphereObstacle</a>(Real radius,
00301                                                                              <span class="keyword">const</span> <a class="code" href="classbase_1_1Vector3.html">base::Point3</a>&amp; position, 
00302                                                                              <span class="keyword">const</span> <a class="code" href="classbase_1_1Orient.html">base::Orient</a>&amp; orientation,
00303                                                                              ref&lt;const physics::Material&gt; material,
00304                                                                              <span class="keyword">const</span> String&amp; name)
00305 {
00306   ref&lt;Sphere&gt; sphere(NewObj Sphere(radius));
00307   ref&lt;Solid&gt; solid(<a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp1">system</a>-&gt;createSolid(sphere, material));
00308   solid-&gt;setName( (name==<span class="stringliteral">""</span>)?<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"sphere obstacle"</span>):name);
00309   <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp1">system</a>-&gt;addSolid(solid);
00310   solid-&gt;setEnabled(dynamic);
00311   solid-&gt;setPosition(position);
00312   solid-&gt;setOrientation(orientation.<a class="code" href="classbase_1_1Orient.html#base_1_1Orienta29">getQuat4</a>());
00313 
00314   ref&lt;Collidable&gt; obstCollidable( solid-&gt;createCollidable() );
00315   <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp2">collidables</a>-&gt;addCollidable( obstCollidable );
00316 
00317   ref&lt;SolidObstacle&gt; obstacle(NewObj SolidObstacle(radius,position,orientation,solid));
00318   <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp9">obstacles</a>.<a class="code" href="classbase_1_1reflist.html#base_1_1reflista26">push_back</a>(obstacle);
00319   <span class="keywordflow">return</span> obstacle;
00320 }
00321 
00322 
00323 
00324 <span class="keywordtype">void</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmenta21">SimulatedBasicEnvironment::removeObstacle</a>(ref&lt;BasicEnvironment::Obstacle&gt; obstacle)
00325 {
00326   <span class="keywordflow">if</span> (<a class="code" href="base.html#a25">instanceof</a>(*obstacle, SolidObstacle)) 
00327     <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp9">obstacles</a>.<a class="code" href="classbase_1_1reflist.html#base_1_1reflista48">remove</a>( narrow_ref&lt;SolidObstacle&gt;(obstacle) );
00328   <span class="keywordflow">else</span>
00329     <span class="keywordflow">throw</span> std::invalid_argument(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"unknown Obstacle"</span>));
00330 }
00331 <span class="comment"></span>
00332 <span class="comment">/// \TODO shouldn't this remove the old Solid from the system an </span>
00333 <span class="comment">///  add the new one (and also create a new Collidable from the new Solid)???</span>
00334 <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmenta22">SimulatedBasicEnvironment::setObstacleColor</a>(ref&lt;BasicEnvironment::Obstacle&gt; obstacle, <span class="keyword">const</span> <a class="code" href="classgfx_1_1Color3.html">gfx::Color3</a>&amp; color)
00335 {
00336   <span class="keywordflow">if</span> (<a class="code" href="base.html#a25">instanceof</a>(*obstacle, SolidObstacle)) {
00337 
00338     ref&lt;SolidObstacle&gt; solidobst( narrow_ref&lt;SolidObstacle&gt;(obstacle) );
00339     ref&lt;Solid&gt; s( solidobst-&gt;solid );
00340     <span class="comment">// create a Solid identical to the old but with a different material color</span>
00341     <span class="comment">//  and substitute one for the other</span>
00342     ref&lt;Material&gt; newmat(NewObj Material(*s-&gt;getMaterial()));
00343     newmat-&gt;setBaseColor(color);
00344     ref&lt;Solid&gt; newsolid(<a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp1">system</a>-&gt;createSolid(s-&gt;getShape(), newmat));
00345     newsolid-&gt;setName( s-&gt;getName() );
00346     solidobst-&gt;solid = newsolid;
00347   }
00348   <span class="keywordflow">else</span>
00349     <span class="keywordflow">throw</span> std::invalid_argument(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"unknown Obstacle"</span>));
00350 }
00351 
00352 
00353 <span class="keywordtype">void</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmenta23">SimulatedBasicEnvironment::setObstacleDensity</a>(ref&lt;BasicEnvironment::Obstacle&gt; obstacle, Real density)
00354 {
00355   <span class="keywordflow">if</span> (<a class="code" href="base.html#a25">instanceof</a>(*obstacle, SolidObstacle)) {
00356 
00357     ref&lt;SolidObstacle&gt; solidobst( narrow_ref&lt;SolidObstacle&gt;(obstacle) );
00358     ref&lt;Solid&gt; s( solidobst-&gt;solid );
00359     <span class="comment">// create a Solid identical to the old but with a different material density</span>
00360     <span class="comment">//  and substitute one for the other</span>
00361     ref&lt;Material&gt; newmat(NewObj Material(*s-&gt;getMaterial()));
00362     newmat-&gt;setDensity(density);
00363     ref&lt;Solid&gt; newsolid(<a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp1">system</a>-&gt;createSolid(s-&gt;getShape(), newmat));
00364     newsolid-&gt;setName( s-&gt;getName() );
00365     solidobst-&gt;solid = newsolid;
00366   }
00367   <span class="keywordflow">else</span>
00368     <span class="keywordflow">throw</span> std::invalid_argument(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"unknown Obstacle"</span>));
00369 }
00370 
00371 
00372 ref&lt;physics::Solid&gt; <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentb1">SimulatedBasicEnvironment::findObstacle</a>(ref&lt;BasicEnvironment::Obstacle&gt; obstacle)
00373 {
00374   <span class="keywordflow">if</span> (<a class="code" href="base.html#a25">instanceof</a>(*obstacle, SolidObstacle)) {
00375     ref&lt;SolidObstacle&gt; so( narrow_ref&lt;SolidObstacle&gt;(obstacle) );
00376     <span class="keywordflow">return</span> so-&gt;solid;
00377   }
00378   <span class="keywordflow">else</span>
00379     <span class="keywordflow">return</span> ref&lt;physics::Solid&gt;(0);
00380 }
00381 
00382 
00383 <span class="keywordtype">void</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentb0">SimulatedBasicEnvironment::construct</a>()
00384 {
00385   <span class="comment">// Rigid-body physics simulation system</span>
00386   <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp1">system</a> = ref&lt;SolidSystem&gt;(<a class="code" href="MemoryTracer.html#a1">NewNamedObj</a>(<span class="stringliteral">"BasicEnvironmentSolidSystem"</span>) <a class="code" href="classphysics_1_1ODESolidSystem.html">ODESolidSystem</a>());
00387   <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp1">system</a>-&gt;setGravity(<a class="code" href="classbase_1_1Vector3.html">base::Vector3</a>(0,0,-9.8));
00388   <span class="comment">//system-&gt;setGravity(base::Vector3(0,0,0));//!!!</span>
00389   <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp1">system</a>-&gt;setParameter(<span class="stringliteral">"ERP"</span>,0.2);
00390   <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp1">system</a>-&gt;setParameter(<span class="stringliteral">"CFM"</span>,1e-7);
00391 
00392   <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp4">collisionCuller</a> = <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp1">system</a>-&gt;getCollisionCuller();
00393   <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp2">collidables</a> = <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp4">collisionCuller</a>-&gt;createCollidableGroup();
00394   
00395   <span class="comment">// create a constraint group for environment wide constraints (e.g. fixed constraints for fixing robots to the ground)</span>
00396   <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp6">cgroup</a> = ref&lt;ConstraintGroup&gt;(<a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp1">system</a>-&gt;createConstraintGroup());
00397 
00398   <span class="comment">// make a big flat 'plane' for the 'ground'</span>
00399   <span class="keyword">const</span> <a class="code" href="namespacebase.html#a5">Real</a> t = 1.0; <span class="comment">// thickness</span>
00400   ref&lt;Box&gt; groundBox(NewObj Box(150,150,t));
00401   ref&lt;physics::Material&gt; groundMaterial(NewObj <a class="code" href="classphysics_1_1Material.html">physics::Material</a>());
00402   groundMaterial-&gt;setDensity(0.01); 
00403   <span class="comment">//groundMaterial-&gt;setBaseColor(gfx::Color3(244.0/256.0,164.0/256.0,96.0/256.0)); // 'brown'</span>
00404   groundMaterial-&gt;setBaseColor(<a class="code" href="classgfx_1_1Color3.html">gfx::Color3</a>(1.0,1.0,1.0)); <span class="comment">// 'white'</span><span class="comment"></span>
00405 <span class="comment">  //!!!groundMaterial-&gt;setSurfaceAppearance(PathName("images/LlanoTex.jpg"));</span>
00406 <span class="comment"></span>  <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp5">ground</a> = <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp1">system</a>-&gt;createSolid(groundBox, groundMaterial);
00407   <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp5">ground</a>-&gt;setName(<span class="stringliteral">"ground"</span>);
00408   <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp1">system</a>-&gt;setGround(ground, <a class="code" href="namespacebase.html#a26">Point3</a>(0,0,-(t/2.0))); <span class="comment">// system treats the ground Solid as special - it's anchored to the world frame.</span>
00409 
00410   <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp3">groundCollidable</a> = <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp5">ground</a>-&gt;createCollidable();
00411   <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp2">collidables</a>-&gt;addCollidable( groundCollidable );
00412   
00413   <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp1">system</a>-&gt;setCollidable(collidables);
00414 }
00415 
00416 
00417 
00418 <span class="keywordtype">void</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentb2">SimulatedBasicEnvironment::checkTools</a>()
00419 {
00420   <span class="comment">// check each tool for proximity with each robot</span>
00421   RobotList::const_iterator r = <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp7">robots</a>.<a class="code" href="classbase_1_1reflist.html#base_1_1reflista0">begin</a>();
00422   RobotList::const_iterator rend = <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp7">robots</a>.<a class="code" href="classbase_1_1reflist.html#base_1_1reflista3">end</a>();
00423   <span class="keywordflow">while</span> (r != rend) {
00424     ref&lt;SimulatedRobot&gt; <a class="code" href="robot_2Jamfile_8ft.html#a0">robot</a>(*r);
00425     
00426     ToolList::const_iterator t = <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp8">tools</a>.<a class="code" href="classbase_1_1reflist.html#base_1_1reflista0">begin</a>();
00427     ToolList::const_iterator tend = <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp8">tools</a>.<a class="code" href="classbase_1_1reflist.html#base_1_1reflista3">end</a>();
00428     <span class="keywordflow">while</span> (t != tend) {
00429       ref&lt;SimulatedTool&gt; simTool( narrow_ref&lt;SolidTool&gt;(*t)-&gt;simTool );
00430       
00431       <a class="code" href="robot_2Jamfile_8ft.html#a0">robot</a>-&gt;checkProximity(simTool);
00432       
00433       ++t;
00434     }
00435 
00436     ++r;
00437   }
00438         
00439 }
00440 
00441 
00442 
00443 <span class="keywordtype">void</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmenta28">SimulatedBasicEnvironment::preSimulate</a>()
00444 {
00445   <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp1">system</a>-&gt;preSimulate();
00446   <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentb2">checkTools</a>();
00447 }
00448 
00449 
00450 <span class="keywordtype">void</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmenta29">SimulatedBasicEnvironment::simulateForSimTime</a>(<span class="keyword">const</span> <a class="code" href="classbase_1_1Time.html">base::Time</a>&amp; dt)
00451 {
00452   <span class="keywordflow">if</span> (<a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp0">dynamic</a>) 
00453     <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp1">system</a>-&gt;simulateForSimTime(dt);
00454   <span class="keywordflow">else</span>
00455     <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp1">system</a>-&gt;simulateForSimTime(0); <span class="comment">// just do collisions and update Visual (if any)</span>
00456   <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentb2">checkTools</a>();
00457 }
00458 
00459 
00460 
00461 osg::Node* <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmenta27">SimulatedBasicEnvironment::createOSGVisual</a>(Visual::Attributes visualAttributes)<span class="keyword"> const</span>
00462 <span class="keyword"></span>{
00463   <span class="keywordflow">if</span> ((<a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp12">rootnode</a>!=0) &amp;&amp; (<a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp11">attributes</a>==visualAttributes))
00464     <span class="keywordflow">return</span> &amp;(*rootnode);
00465 
00466   <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp12">rootnode</a> = <a class="code" href="MemoryTracer.html#a0">NewObj</a> osg::Group;
00467   <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp12">rootnode</a>-&gt;setName(<span class="stringliteral">"root"</span>);
00468   
00469   <span class="comment">// create physics system graphics</span>
00470   osg::Node* g = <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp1">system</a>-&gt;createOSGVisual( visualAttributes 
00471 #ifdef DEBUG
00472 <span class="comment">//                                       | gfx::Visual::ShowAxes </span>
00473                                          <span class="comment">//| gfx::Visual::ShowCollisionModel</span>
00474                                          <span class="comment">//| gfx::Visual::ShowNormals</span>
00475 #endif
00476                                         );
00477   
00478   <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp12">rootnode</a>-&gt;addChild(g);
00479 
00480   
00481   <span class="comment">// Set state of rootnode (fog etc.)</span>
00482   osg::StateSet* pState = <a class="code" href="MemoryTracer.html#a0">NewObj</a> osg::StateSet;
00483   <span class="comment">//    pState-&gt;setMode(GL_LIGHTING,osg::StateAttribute::ON); </span>
00484   osg::Vec4 fogColor(0.65f,0.65f,0.65f,1.0f);
00485   osg::Fog* fog = <a class="code" href="MemoryTracer.html#a0">NewObj</a> osg::Fog;
00486   fog-&gt;setMode(osg::Fog::LINEAR);
00487   fog-&gt;setDensity(0.1f);
00488   fog-&gt;setStart(100.0f);
00489   fog-&gt;setEnd(10000.0f - 100.0f); <span class="comment">// (max view dist)</span>
00490   fog-&gt;setColor(fogColor);
00491   pState-&gt;setAttributeAndModes(fog,osg::StateAttribute::ON);
00492   <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp12">rootnode</a>-&gt;setStateSet(pState);
00493   
00494   <span class="keywordflow">return</span> &amp;(*rootnode);
00495 } 
00496 
00497 
00498 
00499 
00500 <span class="keywordtype">bool</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmenta30">SimulatedBasicEnvironment::formatSupported</a>(<span class="keyword">const</span> String format, Real version, ExternalizationType type)<span class="keyword"> const</span>
00501 <span class="keyword"></span>{
00502   <span class="keywordflow">return</span> ( (format==<span class="stringliteral">"xml"</span>) &amp;&amp; (version==1.0) ); 
00503 }
00504 
00505 
00506 <span class="keywordtype">void</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmenta31">SimulatedBasicEnvironment::externalize</a>(<a class="code" href="classbase_1_1Externalizer.html">base::Externalizer</a>&amp; e, String format, Real version)
00507 {
00508   <span class="keywordflow">if</span> (format==<span class="stringliteral">""</span>) format=<span class="stringliteral">"xml"</span>;
00509 
00510   <span class="keywordflow">if</span> (!<a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmenta30">formatSupported</a>(format,version,e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera6">ioType</a>()))
00511     <span class="keywordflow">throw</span> std::invalid_argument(<a class="code" href="base.html#a15">Exception</a>(<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"format "</span>)+format+<span class="stringliteral">" v"</span>+base::realToString(version)+<span class="stringliteral">" unsupported"</span>));
00512   
00513   <span class="keywordflow">if</span> (format == <span class="stringliteral">"xml"</span>) {
00514 
00515     <span class="keywordflow">if</span> (e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera4">isOutput</a>()) {
00516 
00517       DOMElement* envElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"environment"</span>);
00518       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera26">setElementAttribute</a>(envElem,<span class="stringliteral">"type"</span>,<span class="stringliteral">"basic"</span>);
00519 
00520       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera19">pushContext</a>(envElem);
00521 
00522       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera22">appendBreak</a>(envElem);
00523 
00524       <span class="comment">// externalize the robots</span>
00525       RobotList::const_iterator r = <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp7">robots</a>.<a class="code" href="classbase_1_1reflist.html#base_1_1reflista0">begin</a>();
00526       RobotAnchoredList::const_iterator ra = <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp10">robotsAnchored</a>.begin();
00527       RobotList::const_iterator rend = <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp7">robots</a>.<a class="code" href="classbase_1_1reflist.html#base_1_1reflista3">end</a>();
00528       <span class="keywordflow">if</span> (r != rend) 
00529         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera31">appendComment</a>(envElem,<span class="stringliteral">"robots   (description, position, and orientation (Quat) )"</span>);
00530         <span class="keywordflow">while</span> (r != rend) {
00531           ref&lt;SimulatedRobot&gt; <a class="code" href="robot_2Jamfile_8ft.html#a0">robot</a>(*r);
00532           
00533           <span class="keywordflow">if</span> (<a class="code" href="robot_2Jamfile_8ft.html#a0">robot</a>-&gt;isDescriptionProvided()) 
00534             <a class="code" href="robot_2Jamfile_8ft.html#a0">robot</a>-&gt;getRobotDescription()-&gt;externalize(e, format, version);
00535           <span class="keywordflow">else</span>
00536             <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"can't externalize a Robot with no description"</span>));
00537           
00538           DOMElement* robotElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera23">lastAppendedElement</a>();
00539           <a class="code" href="namespacebase.html#a26">Point3</a> position(<a class="code" href="robot_2Jamfile_8ft.html#a0">robot</a>-&gt;getPosition());
00540           DOMElement* posElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"position"</span>,<span class="keyword">false</span>);
00541           e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera29">appendText</a>(posElem, e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere5">toString</a>(position) );
00542           e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera34">appendNode</a>(robotElem, posElem);
00543           e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera22">appendBreak</a>(robotElem);
00544           
00545           Orient orientation(<a class="code" href="robot_2Jamfile_8ft.html#a0">robot</a>-&gt;getOrientation());
00546           DOMElement* orientElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"orientation"</span>,<span class="keyword">false</span>);
00547           <a class="code" href="classdemeter_1_1Vector.html">Vector</a> v( orientation.getVector(Orient::Quat) );
00548           e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera29">appendText</a>(orientElem, e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere5">toString</a>(v,<span class="keyword">true</span>));
00549           e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera34">appendNode</a>(robotElem, orientElem);
00550           e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera22">appendBreak</a>(robotElem);
00551           
00552           <span class="keywordflow">if</span> (*ra)
00553             e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera26">setElementAttribute</a>(robotElem, <span class="stringliteral">"anchored"</span>, <span class="stringliteral">"true"</span>);
00554           
00555           ++r;
00556           ++ra;
00557           e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera22">appendBreak</a>(envElem);
00558       }
00559       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera22">appendBreak</a>(envElem);
00560 
00561 
00562       <span class="comment">// externalize tools</span>
00563       ToolList::const_iterator t = <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp8">tools</a>.<a class="code" href="classbase_1_1reflist.html#base_1_1reflista0">begin</a>();
00564       ToolList::const_iterator tend = <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp8">tools</a>.<a class="code" href="classbase_1_1reflist.html#base_1_1reflista3">end</a>();
00565       <span class="keywordflow">if</span> (t != tend)
00566         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera31">appendComment</a>(envElem,<span class="stringliteral">"tools   (position, orientation (Quat) and description)"</span>);
00567         <span class="keywordflow">while</span> (t != tend) {
00568           ref&lt;Tool&gt; tool(*t);
00569           tool-&gt;getToolDescription()-&gt;externalize(e, format, version);
00570           
00571           DOMElement* toolElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera23">lastAppendedElement</a>();
00572           
00573           <a class="code" href="namespacebase.html#a26">Point3</a> position(tool-&gt;getPosition()); 
00574           DOMElement* posElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"position"</span>,<span class="keyword">false</span>);
00575           e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera29">appendText</a>(posElem, e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere5">toString</a>(position) );
00576           e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera34">appendNode</a>(toolElem, posElem);
00577           e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera22">appendBreak</a>(toolElem);
00578           
00579           Orient orientation(tool-&gt;getOrientation()); 
00580           DOMElement* orientElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"orientation"</span>,<span class="keyword">false</span>);
00581           <a class="code" href="classdemeter_1_1Vector.html">Vector</a> v( orientation.getVector(Orient::Quat) );
00582           e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera29">appendText</a>(orientElem, e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere5">toString</a>(v,<span class="keyword">true</span>));
00583           e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera34">appendNode</a>(toolElem, orientElem);
00584           e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera22">appendBreak</a>(toolElem);
00585           
00586           ++t;
00587           e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera22">appendBreak</a>(envElem);
00588       }
00589       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera22">appendBreak</a>(envElem);
00590 
00591 
00592       <span class="comment">// externalize obstacles</span>
00593       ObstacleList::const_iterator o = <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp9">obstacles</a>.<a class="code" href="classbase_1_1reflist.html#base_1_1reflista0">begin</a>();
00594       ObstacleList::const_iterator oend = <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp9">obstacles</a>.<a class="code" href="classbase_1_1reflist.html#base_1_1reflista3">end</a>();
00595       <span class="keywordflow">if</span> (o != oend)
00596         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera31">appendComment</a>(envElem,<span class="stringliteral">"obstacles (position, orientation (Quat) and description)"</span>);
00597       <span class="keywordflow">while</span> (o != oend) {
00598         ref&lt;SolidObstacle&gt; obstacle(*o);
00599         
00600         DOMElement* obstElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"obstacle"</span>);
00601         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera26">setElementAttribute</a>(obstElem,<span class="stringliteral">"name"</span>,obstacle-&gt;solid-&gt;getName());
00602         
00603         <a class="code" href="namespacebase.html#a26">Point3</a>&amp; position(obstacle-&gt;position); 
00604         DOMElement* posElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"position"</span>,<span class="keyword">false</span>);
00605         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera29">appendText</a>(posElem, e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere5">toString</a>(position) );
00606         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera34">appendNode</a>(obstElem, posElem);
00607         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera22">appendBreak</a>(obstElem);
00608         
00609         Orient&amp; orientation(obstacle-&gt;orientation); 
00610         DOMElement* orientElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"orientation"</span>,<span class="keyword">false</span>);
00611         <a class="code" href="classdemeter_1_1Vector.html">Vector</a> v( orientation.getVector(Orient::Quat) );
00612         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera29">appendText</a>(orientElem, e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere5">toString</a>(v,<span class="keyword">true</span>));
00613         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera34">appendNode</a>(obstElem, orientElem);
00614         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera22">appendBreak</a>(obstElem);
00615         
00616         <span class="keywordflow">if</span> (obstacle-&gt;type == Obstacle::BoxObstacle) {
00617           e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera26">setElementAttribute</a>(obstElem,<span class="stringliteral">"type"</span>,<span class="stringliteral">"box"</span>);
00618           DOMElement* dElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"dimensions"</span>,<span class="keyword">false</span>);
00619           e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera29">appendText</a>( dElem, e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere5">toString</a>(obstacle-&gt;dims) );
00620           e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera34">appendNode</a>(obstElem,dElem);
00621         }
00622         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (obstacle-&gt;type == Obstacle::SphereObstacle) {
00623           e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera26">setElementAttribute</a>(obstElem,<span class="stringliteral">"type"</span>,<span class="stringliteral">"sphere"</span>);
00624           DOMElement* rElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"radius"</span>,<span class="keyword">false</span>);
00625           e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera29">appendText</a>(rElem, base::realToString(obstacle-&gt;radius));
00626           e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera34">appendNode</a>(obstElem,rElem);
00627         }
00628         <span class="keywordflow">else</span>
00629           <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"unsupported obstacle type"</span>));
00630         
00631         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera19">pushContext</a>(obstElem);
00632         ref&lt;Material&gt; mat(NewObj Material(*obstacle-&gt;solid-&gt;getMaterial()));
00633         mat-&gt;externalize(e, format, version);
00634         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera20">popContext</a>();
00635         
00636         
00637         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera34">appendNode</a>(envElem, obstElem);
00638         
00639         ++o;
00640         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera22">appendBreak</a>(envElem);
00641       }
00642       
00643       
00644       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera20">popContext</a>();
00645       
00646       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera21">appendElement</a>(envElem);
00647       
00648     }
00649     <span class="keywordflow">else</span> { <span class="comment">// input</span>
00650 
00651       <span class="comment">// first clear the current environment</span>
00652       <span class="keywordflow">while</span> (!<a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp7">robots</a>.<a class="code" href="classbase_1_1reflist.html#base_1_1reflista12">empty</a>()) <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmenta8">removeRobot</a>( <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp7">robots</a>.<a class="code" href="classbase_1_1reflist.html#base_1_1reflista15">front</a>() );
00653       <span class="keywordflow">while</span> (!<a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp8">tools</a>.<a class="code" href="classbase_1_1reflist.html#base_1_1reflista12">empty</a>()) <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmenta12">removeTool</a>( <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp8">tools</a>.<a class="code" href="classbase_1_1reflist.html#base_1_1reflista15">front</a>() );
00654       <span class="keywordflow">while</span> (!<a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp9">obstacles</a>.<a class="code" href="classbase_1_1reflist.html#base_1_1reflista12">empty</a>()) <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmenta21">removeObstacle</a>( <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentp9">obstacles</a>.<a class="code" href="classbase_1_1reflist.html#base_1_1reflista15">front</a>() );
00655       <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmentb0">construct</a>();
00656 
00657       <span class="comment">// now load the new one</span>
00658       DOMNode* context = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera16">context</a>();
00659     
00660       DOMElement* envElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera36">getFirstElement</a>(context, <span class="stringliteral">"environment"</span>);
00661       <span class="comment">// handle link</span>
00662       <a class="code" href="namespacebase.html#a4">String</a> link = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera41">getElementAttribute</a>(envElem,<span class="stringliteral">"link"</span>,<span class="keyword">false</span>);
00663       <span class="keywordflow">if</span> (link != <span class="stringliteral">""</span>) {
00664         
00665         ref&lt;VFile&gt; linkFile = Application::getInstance()-&gt;universe()-&gt;cache()-&gt;findFile(link,e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera7">getArchivePath</a>());
00666         <a class="code" href="classbase_1_1Externalizable.html#gfx_1_1VisualPatha28">load</a>(linkFile,format,version);
00667       }
00668       <span class="keywordflow">else</span> {
00669         
00670         <span class="keywordflow">if</span> ( e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera41">getElementAttribute</a>(envElem, <span class="stringliteral">"type"</span>) != <span class="stringliteral">"basic"</span> )
00671           <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"unsupported environment type"</span>));
00672         
00673         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera19">pushContext</a>(envElem);
00674         
00675         <span class="comment">// read in robots</span>
00676         DOMElement* robotElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(envElem, <span class="stringliteral">"robot"</span>,<span class="keyword">false</span>);
00677         <span class="keywordflow">while</span> (robotElem) {
00678           <span class="comment">// get position &amp; orientation</span>
00679           DOMElement* posElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(robotElem,<span class="stringliteral">"position"</span>);
00680           <a class="code" href="namespacebase.html#a4">String</a> posText = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera40">getContainedText</a>(posElem);
00681           <a class="code" href="namespacebase.html#a26">Point3</a> position( e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere6">toVector3</a>(posText) );
00682           
00683           DOMElement* orientElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(robotElem, <span class="stringliteral">"orientation"</span>);
00684           <a class="code" href="namespacebase.html#a4">String</a> orientText = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera40">getContainedText</a>(orientElem);
00685           <a class="code" href="classdemeter_1_1Vector.html">Vector</a> v( e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere7">toVector</a>(orientText,<span class="keyword">true</span>) );
00686           Orient orientation;
00687           <span class="keywordflow">if</span> (v.size() == 4)
00688             orientation = Orient(v, Orient::Quat);
00689           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (v.size() == 3)
00690             orientation = Orient(v, Orient::EulerRPY);
00691           <span class="keywordflow">else</span>
00692             <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"robot orientation must have either 3(EulerRPY) or 4(Quaternion) elements)"</span>));
00693           
00694           <span class="comment">// get if robot anchored</span>
00695           <a class="code" href="namespacebase.html#a4">String</a> anchoredString = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera42">getDefaultedElementAttribute</a>(robotElem, <span class="stringliteral">"anchored"</span>, <span class="stringliteral">"false"</span>);
00696           <span class="keywordtype">bool</span> anchored = (anchoredString == <span class="stringliteral">"true"</span>);
00697           <span class="keywordflow">if</span> (!anchored &amp;&amp; (anchoredString != <span class="stringliteral">"false"</span>))
00698             <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"'anchored' attribute of element 'robot' must be either 'true' or 'false'"</span>));
00699           
00700           ref&lt;RobotDescription&gt; rd(<a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmenta5">newRobotDescription</a>());
00701           rd-&gt;externalize(e, format, version);
00702           <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmenta7">addRobot</a>(rd, position, orientation, anchored);
00703           
00704           robotElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(envElem, <span class="stringliteral">"robot"</span>,<span class="keyword">false</span>);
00705         }
00706   
00707   
00708         <span class="comment">// read in tools</span>
00709         DOMElement* toolElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(envElem, <span class="stringliteral">"tool"</span>,<span class="keyword">false</span>);
00710         <span class="keywordflow">while</span> (toolElem) {
00711           <span class="comment">// get position &amp; orientation</span>
00712           DOMElement* posElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(toolElem,<span class="stringliteral">"position"</span>);
00713           <a class="code" href="namespacebase.html#a4">String</a> posText = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera40">getContainedText</a>(posElem);
00714           <a class="code" href="namespacebase.html#a26">Point3</a> position( e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere6">toVector3</a>(posText) );
00715           
00716           DOMElement* orientElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(toolElem, <span class="stringliteral">"orientation"</span>);
00717           <a class="code" href="namespacebase.html#a4">String</a> orientText = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera40">getContainedText</a>(orientElem);
00718           <a class="code" href="classdemeter_1_1Vector.html">Vector</a> v( e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere7">toVector</a>(orientText,<span class="keyword">true</span>) );
00719           Orient orientation;
00720           <span class="keywordflow">if</span> (v.size() == 4)
00721             orientation = Orient(v, Orient::Quat);
00722           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (v.size() == 3)
00723             orientation = Orient(v, Orient::EulerRPY);
00724           <span class="keywordflow">else</span>
00725             <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"tool orientation must have either 3(EulerRPY) or 4(Quaternion) elements)"</span>));
00726           
00727           ref&lt;ToolDescription&gt; td(NewObj ToolDescription());
00728           td-&gt;externalize(e, format, version);
00729           
00730           <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmenta11">addTool</a>(td, position, orientation);
00731           
00732           toolElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(envElem, <span class="stringliteral">"tool"</span>,<span class="keyword">false</span>);
00733         }
00734 
00735         
00736         <span class="comment">// read in obstacles</span>
00737         DOMElement* obstElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(envElem, <span class="stringliteral">"obstacle"</span>,<span class="keyword">false</span>);
00738         <span class="keywordflow">while</span> (obstElem) {
00739           <a class="code" href="namespacebase.html#a4">String</a> name( e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera42">getDefaultedElementAttribute</a>(obstElem, <span class="stringliteral">"name"</span>, <span class="stringliteral">"obstacle"</span>) );
00740           
00741           <span class="comment">// read in position &amp; orientation</span>
00742           DOMElement* posElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(obstElem, <span class="stringliteral">"position"</span>);
00743           <a class="code" href="namespacebase.html#a4">String</a> posText = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera40">getContainedText</a>(posElem);
00744           <a class="code" href="namespacebase.html#a26">Point3</a> position( e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere6">toVector3</a>(posText) );
00745           
00746           DOMElement* orientElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(obstElem, <span class="stringliteral">"orientation"</span>);
00747           <a class="code" href="namespacebase.html#a4">String</a> orientText = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera40">getContainedText</a>(orientElem);
00748           <a class="code" href="classdemeter_1_1Vector.html">Vector</a> v( e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere7">toVector</a>(orientText,<span class="keyword">true</span>) );
00749           Orient orientation;
00750           <span class="keywordflow">if</span> (v.size() == 4)
00751             orientation = Orient(v, Orient::Quat);
00752           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (v.size() == 3)
00753             orientation = Orient(v, Orient::EulerRPY);
00754           <span class="keywordflow">else</span>
00755             <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"obstacle orientation must have either 3(EulerRPY) or 4(Quaternion) elements)"</span>));
00756           
00757           <span class="comment">// optional material</span>
00758           DOMElement* matElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(obstElem, <span class="stringliteral">"material"</span>,<span class="keyword">false</span>);
00759           ref&lt;Material&gt; mat(NewObj Material());
00760           <span class="keywordflow">if</span> (matElem) {
00761             e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera19">pushContext</a>(obstElem); 
00762             mat-&gt;externalize(e, format, version);
00763             e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera20">popContext</a>();
00764           }
00765           
00766           <span class="comment">// get obstacle parameters &amp; construct obstacles</span>
00767           ref&lt;SolidObstacle&gt; obstacle;
00768           Obstacle::ObstacleType type;
00769           <span class="keywordflow">if</span> ( e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera41">getElementAttribute</a>(obstElem, <span class="stringliteral">"type"</span>) == <span class="stringliteral">"box"</span> ) {
00770             type = Obstacle::BoxObstacle;
00771             
00772             DOMElement* dElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(obstElem, <span class="stringliteral">"dimensions"</span>);
00773             <a class="code" href="namespacebase.html#a4">String</a> dimText = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera40">getContainedText</a>(dElem);
00774             <a class="code" href="classbase_1_1Vector3.html">Dimension3</a> dims( e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere6">toVector3</a>( dimText ) );
00775             
00776             <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmenta17">addBoxObstacle</a>(dims,position,orientation,mat,name);
00777           }
00778           <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera41">getElementAttribute</a>(obstElem, <span class="stringliteral">"type"</span>) == <span class="stringliteral">"sphere"</span> ) {
00779             type = Obstacle::SphereObstacle;
00780             
00781             DOMElement* rElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(obstElem, <span class="stringliteral">"radius"</span>,<span class="keyword">false</span>);
00782             <a class="code" href="namespacebase.html#a5">Real</a> radius=1.0;
00783             <span class="keywordflow">if</span> (rElem) 
00784               radius = <a class="code" href="namespacebase.html#a53">base::stringToReal</a>( e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera40">getContainedText</a>(rElem) );
00785             
00786             <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html#robot_1_1sim_1_1SimulatedBasicEnvironmenta18">addSphereObstacle</a>(radius, position,orientation,mat,name);
00787           }
00788           <span class="keywordflow">else</span>
00789             <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"unsupported obstacle type"</span>));
00790           
00791           e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera39">removeElement</a>(obstElem);
00792           
00793           obstElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(envElem, <span class="stringliteral">"obstacle"</span>,<span class="keyword">false</span>);
00794         }
00795         
00796         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera20">popContext</a>();
00797       }
00798 
00799       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera39">removeElement</a>(envElem);
00800 
00801     }
00802 
00803   }
00804 
00805 }
00806 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Jul 29 15:56:40 2004 for OpenSim by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.6 </small></address>
</body>
</html>
