<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>OpenSim: robot/ManipulatorJointTrajectory.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>robot/ManipulatorJointTrajectory.cpp</h1><a href="ManipulatorJointTrajectory_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/****************************************************************************</span>
00002 <span class="comment">  Copyright (C)2003 David Jung &lt;opensim@pobox.com&gt;</span>
00003 <span class="comment"></span>
00004 <span class="comment">  This program/file is free software; you can redistribute it and/or modify</span>
00005 <span class="comment">  it under the terms of the GNU General Public License as published by</span>
00006 <span class="comment">  the Free Software Foundation; either version 2 of the License, or</span>
00007 <span class="comment">  (at your option) any later version.</span>
00008 <span class="comment">  </span>
00009 <span class="comment">  This program is distributed in the hope that it will be useful,</span>
00010 <span class="comment">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00011 <span class="comment">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00012 <span class="comment">  GNU General Public License for more details. (http://www.gnu.org)</span>
00013 <span class="comment">  </span>
00014 <span class="comment">  You should have received a copy of the GNU General Public License</span>
00015 <span class="comment">  along with this program; if not, write to the Free Software</span>
00016 <span class="comment">  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
00017 <span class="comment">  </span>
00018 <span class="comment">  $Id: ManipulatorJointTrajectory.cpp 1039 2004-02-11 20:50:52Z jungd $</span>
00019 <span class="comment">  $Revision: 1.4 $</span>
00020 <span class="comment">  $Date: 2004-02-11 15:50:52 -0500 (Wed, 11 Feb 2004) $</span>
00021 <span class="comment">  $Author: jungd $</span>
00022 <span class="comment"> </span>
00023 <span class="comment">****************************************************************************/</span>
00024 
00025 <span class="preprocessor">#include &lt;<a class="code" href="ManipulatorJointTrajectory.html">robot/ManipulatorJointTrajectory</a>&gt;</span>
00026 
00027 <span class="preprocessor">#include &lt;sstream&gt;</span>
00028 
00029 <span class="preprocessor">#include &lt;<a class="code" href="Math.html">base/Math</a>&gt;</span>
00030 <span class="preprocessor">#include &lt;<a class="code" href="Externalizer.html">base/Externalizer</a>&gt;</span>
00031 <span class="preprocessor">#include &lt;<a class="code" href="Serializer.html">base/Serializer</a>&gt;</span>
00032 <span class="preprocessor">#include &lt;<a class="code" href="externalization__error.html">base/externalization_error</a>&gt;</span>
00033 
00034 
00035 <span class="keyword">using</span> <a class="code" href="classrobot_1_1ManipulatorJointTrajectory.html">robot::ManipulatorJointTrajectory</a>;
00036 
00037 <span class="keyword">using</span> <a class="code" href="classbase_1_1vector.html">base::Vector</a>;
00038 <span class="keyword">using</span> base::vectorRange;
00039 <span class="keyword">using</span> <a class="code" href="classbase_1_1range.html">base::Range</a>;
00040 <span class="keyword">using</span> <a class="code" href="classbase_1_1Time.html">base::Time</a>;
00041 <span class="keyword">using</span> <a class="code" href="classbase_1_1Serializer.html">base::Serializer</a>;
00042 <span class="keyword">using</span> <a class="code" href="classbase_1_1Externalizer.html">base::Externalizer</a>;
00043 <span class="keyword">using</span> <a class="code" href="classbase_1_1externalization__error.html">base::externalization_error</a>;
00044 <span class="keyword">using</span> <a class="code" href="classbase_1_1XS.html">base::XS</a>;
00045 <span class="keyword">using</span> base::dom::DOMNode;
00046 <span class="keyword">using</span> base::dom::DOMElement;
00047 
00048 
00049 ManipulatorJointTrajectory::ManipulatorJointTrajectory(Int numJoints, AngularUnits units)
00050   : angUnits(units)
00051 {
00052   <span class="keyword">const</span> <a class="code" href="namespacebase.html#a2">Int</a> dof = numJoints;
00053   qs.resize(2);
00054   qs[0].reset( <a class="code" href="namespacebase.html#a201">zeroVector</a>(dof) );
00055   qs[1].reset( <a class="code" href="namespacebase.html#a201">zeroVector</a>(dof) );
00056   
00057   times.resize(2);
00058   times[0] = 0;
00059   times[1] = 1;
00060 
00061   computeSis(dof);
00062 }
00063 
00064 
00065 ManipulatorJointTrajectory::ManipulatorJointTrajectory(<span class="keyword">const</span> ManipulatorJointTrajectory&amp; t)
00066   : qs(t.qs), times(t.times), si(t.si), angUnits(t.angUnits)
00067 {
00068 }
00069 
00070 
00071 ManipulatorJointTrajectory::ManipulatorJointTrajectory(<span class="keyword">const</span> <a class="code" href="classdemeter_1_1Vector.html">Vector</a>&amp; sq, <span class="keyword">const</span> Time&amp; st, 
00072                                                        <span class="keyword">const</span> <a class="code" href="classdemeter_1_1Vector.html">Vector</a>&amp; eq, <span class="keyword">const</span> Time&amp; et,
00073                                                        AngularUnits units)
00074   : angUnits(units)
00075 {
00076   <a class="code" href="namespacebase.html#a2">Int</a> dof = sq.size();
00077   <a class="code" href="base.html#a19">Assert</a>( dof &gt; 0 );
00078 
00079   qs.resize(2);
00080   qs[0].reset(sq);
00081   qs[1].reset(eq);
00082 
00083   times.resize(2);
00084   times[0] = st;
00085   times[1] = et;
00086 
00087   computeSis(dof);
00088 }
00089 
00090 
00091 ManipulatorJointTrajectory::ManipulatorJointTrajectory(<span class="keyword">const</span> array&lt;Vector&gt;&amp; qs, 
00092                                                        <span class="keyword">const</span> array&lt;Time&gt;&amp; times, 
00093                                                        <span class="keywordtype">bool</span> deltas, AngularUnits units)
00094   : angUnits(units)
00095 {
00096   init(qs, times, deltas);
00097 }
00098 
00099 
00100 <span class="keywordtype">void</span> ManipulatorJointTrajectory::convertComponentUnits(array&lt;Int&gt; components, AngularUnits units)
00101 {
00102   <span class="keywordflow">if</span> (getAngularUnits() == units) <span class="keywordflow">return</span>; <span class="comment">// nothing to do</span>
00103 
00104   <span class="keyword">const</span> <a class="code" href="namespacebase.html#a2">Int</a> dof = qs[0].size();
00105   <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;qs.size(); i++) {
00106     <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> ci=0; ci&lt;components.size(); ci++) {
00107       <a class="code" href="namespacebase.html#a2">Int</a> c(components[ci]);
00108       <span class="keywordflow">if</span> (c&lt;dof) {
00109         qs[i][c] = (units==Radians)?Math::degToRad(qs[i][c]):Math::<a class="code" href="namespacegfx.html#a9">radToDeg</a>(qs[i][c]);
00110       }
00111       <span class="keywordflow">else</span>
00112         <span class="keywordflow">throw</span> std::invalid_argument(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"component index out of range"</span>));
00113     }
00114   }
00115 }
00116 
00117 
00118 <span class="keywordtype">void</span> ManipulatorJointTrajectory::setNumJoints(Int numJoints, <span class="keywordtype">bool</span> truncateInitial)
00119 {
00120   <a class="code" href="namespacebase.html#a2">Int</a> currsize = qs[0].size();
00121   
00122   <span class="keywordflow">if</span> (numJoints &lt; currsize) { <span class="comment">// discard elements from end (or start if truncateInitial is true)</span>
00123     <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;qs.size(); i++) {
00124       <a class="code" href="classdemeter_1_1Vector.html">Vector</a> nq( numJoints );
00125       <span class="keywordflow">if</span> (!truncateInitial)
00126         nq = <a class="code" href="namespacebase.html#a205">vectorRange</a>(qs[i], <a class="code" href="namespacebase.html#a30">Range</a>(0, numJoints) );
00127       <span class="keywordflow">else</span>
00128         nq = <a class="code" href="namespacebase.html#a205">vectorRange</a>(qs[i], <a class="code" href="namespacebase.html#a30">Range</a>(currsize-numJoints, currsize));
00129       qs[i].reset(nq);
00130     }
00131   }
00132   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (numJoints &gt; currsize) { <span class="comment">// add zero elements on end</span>
00133     <span class="keyword">const</span> <a class="code" href="namespacebase.html#a2">Int</a> currentNum = qs[0].size();
00134     <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;qs.size(); i++) {
00135       <a class="code" href="classdemeter_1_1Vector.html">Vector</a> nq( <a class="code" href="namespacebase.html#a201">zeroVector</a>(numJoints) );
00136       <a class="code" href="namespacebase.html#a205">vectorRange</a>(nq, <a class="code" href="namespacebase.html#a30">Range</a>(0, currentNum)) = qs[i];
00137       qs[i].reset(nq);
00138     }
00139   }
00140 
00141 }
00142 
00143 
00144 
00145 <a class="code" href="classdemeter_1_1Vector.html">Vector</a> ManipulatorJointTrajectory::q(<span class="keyword">const</span> Time&amp; t)<span class="keyword"> const </span>
00146 <span class="keyword"></span>{
00147   <a class="code" href="namespacebase.html#a5">Real</a> s = gets(t);
00148   <a class="code" href="namespacebase.html#a2">Int</a> i = findIndex(s);
00149   <span class="keywordflow">if</span> (Math::equals(s,si[i])) <span class="comment">// fast path if s corresponds to a waypoint</span>
00150     <span class="keywordflow">return</span> qs[i];
00151 
00152   <a class="code" href="classdemeter_1_1Vector.html">Vector</a> v( qs[i+1] - qs[i] );
00153   <a class="code" href="namespacebase.html#a5">Real</a> ts( si[i+1] - si[i] ); <span class="comment">// change in s between qs[i] to qs[i+1]</span>
00154   
00155   <a class="code" href="namespacebase.html#a5">Real</a> ds = s-si[i];
00156   <a class="code" href="classdemeter_1_1Vector.html">Vector</a> dv( (ds/ts)*v );
00157 
00158   <span class="keywordflow">return</span> qs[i] + dv;
00159 }
00160 
00161 
00162 Time ManipulatorJointTrajectory::time(Real s)<span class="keyword"> const</span>
00163 <span class="keyword"></span>{
00164   Math::bound&lt;Real&gt;(s,0,1);
00165   <span class="keywordflow">return</span> Time( times[0].seconds() +  ( (times[times.size()-1] - times[0]).seconds() * s ) );
00166 }
00167 
00168 
00169 <span class="keywordtype">void</span> ManipulatorJointTrajectory::shiftTime(<span class="keyword">const</span> Time&amp; dt)
00170 {
00171   <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;times.size(); i++)
00172     times[i] += dt;
00173 }
00174 
00175 
00176 <span class="keywordtype">void</span> ManipulatorJointTrajectory::scaleTime(Real s)
00177 {
00178   <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;times.size(); i++)
00179     times[i] *= s;
00180 }
00181 
00182 
00183 <a class="code" href="namespacebase.html#a5">Real</a> ManipulatorJointTrajectory::gets(<span class="keyword">const</span> Time&amp; t)<span class="keyword"> const</span>
00184 <span class="keyword"></span>{
00185   <span class="keyword">const</span> Time&amp; st(times[0]);
00186   <span class="keyword">const</span> Time&amp; et(times[times.size()-1]);
00187   Time bt(t);
00188   Math::bound&lt;Time&gt;(bt,st,et);
00189   <span class="keywordflow">return</span> (bt-st).seconds() / (et-st).seconds();
00190 }
00191 
00192 <span class="keywordtype">void</span> ManipulatorJointTrajectory::serialize(<a class="code" href="classbase_1_1Serializer.html">Serializer</a>&amp; s)
00193 {
00194   s(qs,<span class="stringliteral">"qs"</span>);
00195   s(times,<span class="stringliteral">"times"</span>);
00196   s(si,<span class="stringliteral">"si"</span>);
00197 }
00198 
00199 
00200 <span class="keywordtype">bool</span> ManipulatorJointTrajectory::formatSupported(String format, Real version, ExternalizationType type)<span class="keyword"> const</span>
00201 <span class="keyword"></span>{
00202   <span class="keywordflow">return</span>    (format == <span class="stringliteral">"txt"</span>) &amp;&amp; (version==1.0) 
00203          || (format == <span class="stringliteral">"xml"</span>) &amp;&amp; (version==1.0);
00204 }
00205 
00206 
00207 <span class="keywordtype">void</span> ManipulatorJointTrajectory::externalize(<a class="code" href="classbase_1_1Externalizer.html">Externalizer</a>&amp; e, String format, Real version)
00208 {
00209   <span class="keywordflow">if</span> (format==<span class="stringliteral">""</span>) format = <a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"xml"</span>);
00210 
00211   <span class="keywordflow">if</span> (!formatSupported(format,version,e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera6">ioType</a>()))
00212     <span class="keywordflow">throw</span> std::invalid_argument(<a class="code" href="base.html#a15">Exception</a>(<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"format "</span>)+format+<span class="stringliteral">" "</span>+base::realToString(version)+<span class="stringliteral">" unsupported"</span>));
00213 
00214   <span class="keywordflow">if</span> (format == <span class="stringliteral">"txt"</span>) {
00215 
00216     <span class="keywordflow">if</span> (e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera5">isInput</a>()) {
00217       array&lt;Vector&gt; qs;
00218       array&lt;Time&gt; times;
00219       <span class="keywordtype">bool</span> first = <span class="keyword">true</span>;
00220       <span class="keywordtype">bool</span> deltas = <span class="keyword">false</span>;
00221       
00222       <span class="keywordflow">while</span> (e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera9">moreInput</a>()) {
00223         
00224         <a class="code" href="namespacebase.html#a4">String</a> line(e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera10">readLine</a>());
00225         <span class="keywordflow">if</span> (line.empty()) <span class="keywordflow">break</span>; <span class="comment">// empty line or eof indicates end of list</span>
00226         <span class="keywordflow">while</span> (line[0] == <span class="charliteral">'#'</span>) line = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera10">readLine</a>(); <span class="comment">// skip comment lines</span>
00227         
00228         <span class="keywordflow">if</span> (first) {
00229           <span class="keywordflow">if</span> (!( (line.substr(0,8) == <span class="stringliteral">"absolute"</span>) || (line.substr(0,8) == <span class="stringliteral">"relative"</span>)))
00230             <span class="keywordflow">throw</span> std::invalid_argument(<a class="code" href="base.html#a15">Exception</a>(<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"joint waypoint text file must indicate 'absolute' or 'relative'"</span>)));
00231           
00232           deltas = (line.substr(0,8) == <a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"relative"</span>));
00233           first = <span class="keyword">false</span>;
00234         }
00235         <span class="keywordflow">else</span> {
00236           <span class="comment">// count separating spaces to determine dof</span>
00237           <a class="code" href="namespacebase.html#a2">Int</a> spaces=0;
00238           <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;line.size(); i++) 
00239             <span class="keywordflow">if</span> (line[i]==<span class="charliteral">' '</span>) { 
00240               spaces++;
00241               <span class="keywordflow">while</span> ( (i&lt;line.size()-1) &amp;&amp; (line[i]==<span class="charliteral">' '</span>)) i++;
00242             }
00243           <span class="keywordflow">if</span> (line[0]==<span class="charliteral">' '</span>) spaces--; <span class="comment">// don't count leading space(s)</span>
00244           
00245           std::istringstream iss(line);
00246           iss.setf(std::ios_base::skipws | std::ios_base::dec);
00247           
00248           <span class="keyword">const</span> <a class="code" href="namespacebase.html#a2">Int</a> dof = spaces + 1 - 1; <span class="comment">// don't count time at end as a dof</span>
00249           
00250           <a class="code" href="classdemeter_1_1Vector.html">Vector</a> q(dof);
00251           
00252           <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;dof; i++)
00253             iss &gt;&gt; q[i];
00254           
00255           <a class="code" href="namespacebase.html#a5">Real</a> t;
00256           iss &gt;&gt; t;
00257           
00258           qs.push_back(q);
00259           
00260           times.push_back(Time(t));
00261         }
00262       }
00263       
00264       <span class="keywordflow">if</span> (first)
00265         <span class="keywordflow">throw</span> std::invalid_argument(<a class="code" href="base.html#a15">Exception</a>(<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"joint waypoint text file contains no data."</span>)));
00266       
00267       <span class="keywordflow">if</span> (qs.size() &lt; 2)
00268         <span class="keywordflow">throw</span> std::invalid_argument(<a class="code" href="base.html#a15">Exception</a>(<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"joint waypoint text file must contain at least 2 'waypoint' vectors"</span>)));
00269       
00270       init(qs,times,deltas);
00271       
00272     }
00273     <span class="keywordflow">else</span> { <span class="comment">// output</span>
00274       std::ostringstream out;
00275       
00276       <span class="comment">// comment header</span>
00277       out &lt;&lt; <span class="stringliteral">"# Joint waypoint trajectory [joint positions &amp; times (at-end)]"</span> &lt;&lt; std::endl;
00278       out &lt;&lt; <span class="stringliteral">"# the following line should be 'absolute' for absolute qi's &amp; t values or 'relative' if the vectors represent inter-waypoint deltas dqi's &amp; dt"</span> &lt;&lt; std::endl;
00279       out &lt;&lt; <span class="stringliteral">"absolute"</span> &lt;&lt; std::endl; <span class="comment">// not "relative"</span>
00280       out &lt;&lt; <span class="stringliteral">"# q0 q1 ... qn t"</span> &lt;&lt; std::endl;
00281       std::ostream::fmtflags savedFlags = out.setf(std::ios_base::dec | std::ios_base::right);
00282       <a class="code" href="namespacebase.html#a2">Int</a> savedPrec = out.precision(10);
00283       <a class="code" href="namespacebase.html#a2">Int</a> savedWidth = out.width(13);
00284       <span class="keyword">const</span> <a class="code" href="namespacebase.html#a2">Int</a> dof=qs[0].size();
00285 
00286 <span class="comment">// this is a hack, as under gcc the flags don't appear to stay set after an output op (!?)</span>
00287 <span class="preprocessor">#define setflags \</span>
00288 <span class="preprocessor">      out.setf(std::ios_base::dec | std::ios_base::right); \</span>
00289 <span class="preprocessor">      out.precision(10); \</span>
00290 <span class="preprocessor">      out.width(13); </span>
00291 <span class="preprocessor"></span>
00292       <a class="code" href="Path_8cpp.html#a0">setflags</a>;
00293       <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;qs.size(); i++) {
00294         <a class="code" href="classdemeter_1_1Vector.html">Vector</a> q(qs[i]);
00295         Time t(times[i]);
00296         
00297         <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> e=0; e&lt;dof; e++)
00298           out &lt;&lt; q[e] &lt;&lt; <span class="stringliteral">" "</span>; <a class="code" href="Path_8cpp.html#a0">setflags</a>;
00299         
00300         out &lt;&lt; t.seconds(); <a class="code" href="Path_8cpp.html#a0">setflags</a>;
00301         out &lt;&lt; std::endl;
00302         
00303       }
00304       
00305       out.setf(savedFlags);
00306       out.precision(savedPrec);
00307       out.width(savedWidth);
00308       
00309       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera13">writeString</a>(out.str());
00310     }
00311     
00312   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (format == <span class="stringliteral">"xml"</span>) {
00313 
00314     <span class="keywordflow">if</span> (e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera4">isOutput</a>()) {
00315 
00316       DOMElement* trajElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"jointtrajectory"</span>);
00317 
00318       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera26">setElementAttribute</a>(trajElem,<span class="stringliteral">"pointtype"</span>,<span class="stringliteral">"absolute"</span>);
00319       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera26">setElementAttribute</a>(trajElem,<span class="stringliteral">"angunit"</span>, (angUnits==Radians)?<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"rad"</span>):<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"deg"</span>));
00320 
00321       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera31">appendComment</a>(trajElem, <span class="stringliteral">"space separated joint parameter values and time (secs) at end"</span>);
00322 
00323       <span class="keyword">const</span> <a class="code" href="namespacebase.html#a2">Int</a> dof=qs[0].size();
00324       
00325       <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;qs.size(); i++) {
00326         <a class="code" href="classdemeter_1_1Vector.html">Vector</a> v(dof + 1);
00327         <a class="code" href="namespacebase.html#a205">vectorRange</a>(v, <a class="code" href="namespacebase.html#a30">Range</a>(0,dof)) = qs[i];
00328         v[dof] = times[i].seconds();
00329 
00330         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera29">appendText</a>( trajElem, e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere5">toString</a>(v) );
00331         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera22">appendBreak</a>( trajElem );
00332       }
00333 
00334       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera21">appendElement</a>(trajElem);
00335 
00336     }
00337     <span class="keywordflow">else</span> { <span class="comment">// input</span>
00338       
00339       DOMNode* context = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera16">context</a>();
00340       
00341       DOMElement* trajElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera36">getFirstElement</a>(context, <span class="stringliteral">"jointtrajectory"</span>);
00342 
00343       <span class="keywordtype">bool</span> absolute = ( e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera42">getDefaultedElementAttribute</a>(trajElem, <span class="stringliteral">"pointtype"</span>, <span class="stringliteral">"absolute"</span>) == <span class="stringliteral">"absolute"</span> );
00344       angUnits = ( e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera42">getDefaultedElementAttribute</a>(trajElem, <span class="stringliteral">"angunit"</span>, <span class="stringliteral">"rad"</span>) == <span class="stringliteral">"deg"</span> )?Degrees:Radians;
00345 
00346       array&lt;Vector&gt; qs;
00347       array&lt;Time&gt; times;
00348 
00349       <a class="code" href="namespacebase.html#a4">String</a> trajText = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera40">getContainedText</a>(trajElem,<span class="keyword">true</span>);
00350       array&lt;String&gt; trajLines = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere1">splitIntoLines</a>(trajText);
00351 
00352       <span class="keywordflow">if</span> (trajLines.size() &lt; 2)
00353         <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"trajectory must contain at least two points"</span>));
00354 
00355       <a class="code" href="namespacebase.html#a2">Int</a> dof;
00356       <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;trajLines.size(); i++) {
00357 
00358         array&lt;String&gt; elts = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere2">splitAtDelimiter</a>(trajLines[i], <span class="charliteral">' '</span>);
00359         <span class="keywordflow">if</span> (elts.size() &lt; 2)
00360           <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"trajectory point with no joints encountered"</span>));
00361         <span class="keywordflow">else</span> {
00362           <span class="keywordflow">if</span> (i==0)
00363             dof=elts.size()-1;
00364           <span class="keywordflow">else</span>
00365             <span class="keywordflow">if</span> (elts.size()-1 != dof)
00366               <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"trajectory point of incorrect dimension encountered"</span>));
00367         }
00368 
00369         <a class="code" href="classdemeter_1_1Vector.html">Vector</a> v( e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere3">stringsToReals</a>(elts) );
00370 
00371         qs.push_back( <a class="code" href="classdemeter_1_1Vector.html">Vector</a>( <a class="code" href="namespacebase.html#a205">vectorRange</a>(v, <a class="code" href="namespacebase.html#a30">Range</a>(0, v.size()-1)) ) );
00372         times.push_back( Time(v[v.size()-1]) );
00373       }
00374 
00375       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera39">removeElement</a>(trajElem);
00376 
00377       init(qs,times,!absolute);
00378       
00379     }
00380     
00381     
00382   } <span class="comment">// format xml</span>
00383   
00384 }
00385 
00386 
00387 
00388 <span class="keywordtype">void</span> ManipulatorJointTrajectory::init(<span class="keyword">const</span> array&lt;base::Vector&gt;&amp; qs, <span class="keyword">const</span> array&lt;base::Time&gt;&amp; times, <span class="keywordtype">bool</span> deltas)
00389 {
00390   <a class="code" href="base.html#a19">Assert</a>(qs.size() &gt; 0);
00391   <a class="code" href="base.html#a19">Assert</a>(qs.size() == times.size());
00392   <a class="code" href="namespacebase.html#a2">Int</a> dof=qs[0].size();
00393 
00394   <span class="keywordflow">if</span> (!deltas) {
00395     this-&gt;qs=qs;
00396     this-&gt;times = times;
00397 <span class="preprocessor">#ifdef DEBUG</span>
00398 <span class="preprocessor"></span>  <span class="comment">// make sure all the Vectors are the same size</span>
00399   <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;qs.size(); i++) {
00400     <a class="code" href="base.html#a19">Assert</a>(qs[i].size() == dof);
00401   }    
00402 <span class="preprocessor">#endif</span>
00403 <span class="preprocessor"></span>  }
00404   <span class="keywordflow">else</span> {
00405     <span class="comment">// convert sequence of deltas into absolute joint-configurations and times</span>
00406     array&lt;Vector&gt; aqs(qs.size()+1);
00407     aqs[0].reset( <a class="code" href="namespacebase.html#a201">zeroVector</a>(dof) );
00408     <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;qs.size(); i++) {
00409       <a class="code" href="base.html#a19">Assert</a>(qs[i].size() == dof);
00410       aqs[i+1].reset( aqs[i]+qs[i] );
00411     }
00412 
00413     array&lt;Time&gt; atimes(times.size()+1);
00414     atimes[0] = 0;
00415     <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;times.size(); i++)
00416       atimes[i+1] = atimes[i]+times[i];
00417 
00418     this-&gt;qs = aqs;
00419     this-&gt;times = atimes;
00420   }
00421 
00422   computeSis(dof);
00423 }
00424 
00425 
00426 <span class="keywordtype">void</span> ManipulatorJointTrajectory::computeSis(Int dof)
00427 {
00428   <span class="comment">// ensure at least two points</span>
00429   <span class="keywordflow">if</span> (qs.size() == 0) { qs.at(0) = qs.at(1) = <a class="code" href="classdemeter_1_1Vector.html">Vector</a>(dof); }
00430   <span class="keywordflow">if</span> (times.size() == 0) { times.at(0) = 0; times.at(1) = 1; }
00431 
00432   <span class="comment">// s's map [0..1] to the range [start-time..end-time]</span>
00433   <a class="code" href="namespacebase.html#a5">Real</a> T = (times[times.size()-1] - times[0]).seconds();
00434   <a class="code" href="namespacebase.html#a2">Int</a> i = 1;
00435   si.resize(qs.size());
00436   si[0] = 0;
00437   <span class="keywordflow">while</span> (i&lt;qs.size()) {
00438     <span class="keywordflow">if</span> (times[i-1] &gt; times[i])
00439       <span class="keywordflow">throw</span> std::invalid_argument(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"times must be monotonically increasing"</span>));
00440     si[i] = (times[i] - times[0]).seconds() / T;
00441     i++;
00442   }
00443 }
00444 
00445 
00446 <a class="code" href="namespacebase.html#a2">Int</a> ManipulatorJointTrajectory::findIndex(Real s)<span class="keyword"> const</span>
00447 <span class="keyword"></span>{
00448   <a class="code" href="namespacebase.html#a2">Int</a> i;
00449   <span class="keywordflow">for</span>(i=0; i&lt;si.size(); i++)
00450     <span class="keywordflow">if</span> (si[i] &gt; s) <span class="keywordflow">break</span>;
00451   <span class="keywordflow">return</span> i-1;
00452 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Jul 29 15:56:37 2004 for OpenSim by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.6 </small></address>
</body>
</html>
