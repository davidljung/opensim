<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>OpenSim: robot/sim/IKORTest.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>robot/sim/IKORTest.cpp</h1><a href="IKORTest_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/****************************************************************************</span>
00002 <span class="comment">  Copyright (C)2003 David Jung &lt;opensim@pobox.com&gt;</span>
00003 <span class="comment"></span>
00004 <span class="comment">  This program/file is free software; you can redistribute it and/or modify</span>
00005 <span class="comment">  it under the terms of the GNU General Public License as published by</span>
00006 <span class="comment">  the Free Software Foundation; either version 2 of the License, or</span>
00007 <span class="comment">  (at your option) any later version.</span>
00008 <span class="comment">  </span>
00009 <span class="comment">  This program is distributed in the hope that it will be useful,</span>
00010 <span class="comment">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00011 <span class="comment">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00012 <span class="comment">  GNU General Public License for more details. (http://www.gnu.org)</span>
00013 <span class="comment">  </span>
00014 <span class="comment">  You should have received a copy of the GNU General Public License</span>
00015 <span class="comment">  along with this program; if not, write to the Free Software</span>
00016 <span class="comment">  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
00017 <span class="comment">  </span>
00018 <span class="comment">  $Id: IKORTest.cpp 1033 2004-02-11 20:47:52Z jungd $</span>
00019 <span class="comment">  $Revision: 1.6 $</span>
00020 <span class="comment">  $Date: 2004-02-11 15:47:52 -0500 (Wed, 11 Feb 2004) $</span>
00021 <span class="comment">  $Author: jungd $</span>
00022 <span class="comment"> </span>
00023 <span class="comment">****************************************************************************/</span>
00024 
00025 <span class="preprocessor">#include &lt;<a class="code" href="IKORTest.html">robot/sim/IKORTest</a>&gt;</span>
00026 
00027 <span class="preprocessor">#include &lt;<a class="code" href="Externalizer.html">base/Externalizer</a>&gt;</span>
00028 <span class="preprocessor">#include &lt;<a class="code" href="externalization__error.html">base/externalization_error</a>&gt;</span>
00029 <span class="preprocessor">#include &lt;<a class="code" href="Expression.html">base/Expression</a>&gt;</span>
00030 <span class="preprocessor">#include &lt;<a class="code" href="Matrix.html">base/Matrix</a>&gt;</span>
00031 <span class="preprocessor">#include &lt;<a class="code" href="VDirectory.html">base/VDirectory</a>&gt;</span>
00032 <span class="preprocessor">#include &lt;<a class="code" href="VFile.html">base/VFile</a>&gt;</span>
00033 
00034 <span class="preprocessor">#include &lt;<a class="code" href="BasicEnvironment.html">robot/sim/BasicEnvironment</a>&gt;</span>
00035 <span class="preprocessor">#include &lt;<a class="code" href="FullSpaceSolver.html">robot/control/kinematics/FullSpaceSolver</a>&gt;</span>
00036 <span class="preprocessor">#include &lt;<a class="code" href="IKOR.html">robot/control/kinematics/IKOR</a>&gt;</span>
00037 
00038 
00039 <span class="keyword">using</span> <a class="code" href="classrobot_1_1sim_1_1IKORTest.html">robot::sim::IKORTest</a>;
00040 
00041 <span class="keyword">using</span> <a class="code" href="classbase_1_1vector.html">base::Vector</a>;
00042 <span class="keyword">using</span> <a class="code" href="classbase_1_1Orient.html">base::Orient</a>;
00043 <span class="keyword">using</span> <a class="code" href="classbase_1_1Time.html">base::Time</a>;
00044 <span class="keyword">using</span> <a class="code" href="classbase_1_1PathName.html">base::PathName</a>;
00045 <span class="keyword">using</span> <a class="code" href="classbase_1_1VFile.html">base::VFile</a>;
00046 <span class="keyword">using</span> <a class="code" href="classbase_1_1VDirectory.html">base::VDirectory</a>;
00047 <span class="keyword">using</span> <a class="code" href="classbase_1_1externalization__error.html">base::externalization_error</a>;
00048 <span class="keyword">using</span> <a class="code" href="classbase_1_1Path.html">base::Path</a>;
00049 <span class="keyword">using</span> <a class="code" href="classbase_1_1Trajectory.html">base::Trajectory</a>;
00050 <span class="keyword">using</span> base::dom::DOMNode;
00051 <span class="keyword">using</span> base::dom::DOMElement;
00052 <span class="keyword">using</span> <a class="code" href="classrobot_1_1sim_1_1BasicEnvironment.html">robot::sim::BasicEnvironment</a>;
00053 <span class="keyword">using</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html">robot::sim::SimulatedBasicEnvironment</a>;
00054 <span class="keyword">using</span> <a class="code" href="classrobot_1_1control_1_1kinematics_1_1FullSpaceSolver.html">robot::control::kinematics::FullSpaceSolver</a>;
00055 <span class="keyword">using</span> <a class="code" href="classrobot_1_1control_1_1kinematics_1_1InverseKinematicsSolver.html">robot::control::kinematics::InverseKinematicsSolver</a>;
00056 <span class="keyword">using</span> <a class="code" href="classrobot_1_1control_1_1kinematics_1_1FullSpaceSolver.html">robot::control::kinematics::FullSpaceSolver</a>;
00057 <span class="keyword">using</span> <a class="code" href="classrobot_1_1control_1_1kinematics_1_1IKOR.html">robot::control::kinematics::IKOR</a>;
00058 
00059 
00060 
00061 
00062 
00063 IKORTest::IKORTest(ref&lt;base::VFile&gt; testSpecification,
00064                    ref&lt;base::VFileSystem&gt; fs, ref&lt;base::Cache&gt; cache)
00065   : filesystem(fs), cache(cache)
00066 {
00067 <span class="comment">//  env = ref&lt;TestBasicEnvironment&gt;(NewObj TestBasicEnvironment(filesystem, cache, "IKORTest"));</span>
00068   <a class="code" href="classrobot_1_1sim_1_1IKORTest.html#robot_1_1sim_1_1VisualIKORTestp7">env</a> = ref&lt;SimulatedBasicEnvironment&gt;(<a class="code" href="MemoryTracer.html#a0">NewObj</a> <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html">SimulatedBasicEnvironment</a>(filesystem, cache, <span class="stringliteral">"IKORTest"</span>));
00069 
00070   <a class="code" href="classbase_1_1Externalizable.html#gfx_1_1VisualPatha28">load</a>(testSpecification, testSpecification-&gt;extension(),1.0);
00071 }
00072 
00073 
00074 <span class="keywordtype">void</span> IKORTest::setEnvironment(ref&lt;BasicEnvironment&gt; env)
00075 {
00076   <span class="keywordflow">if</span> (<a class="code" href="base.html#a25">instanceof</a>(*env, <a class="code" href="classrobot_1_1sim_1_1SimulatedBasicEnvironment.html">SimulatedBasicEnvironment</a>))
00077     this-&gt;env = narrow_ref&lt;SimulatedBasicEnvironment&gt;(env);
00078   <span class="keywordflow">else</span>
00079     <span class="keywordflow">throw</span> std::invalid_argument(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"BasicEnvironment env didn't come from IKORTest (i.e. isn't a SimulatedBasicEnvironment)"</span>));
00080 }
00081 
00082 
00083 <span class="keywordtype">void</span> IKORTest::saveResults(<span class="keywordtype">bool</span> saveTrajFiles, <a class="code" href="classbase_1_1PathName.html">PathName</a> alternateOutputFileName)
00084 {
00085   <span class="keywordflow">if</span> (saveTrajFiles) {
00086     <span class="comment">// ask each test to output its result to a seperate file</span>
00087     <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;<a class="code" href="classrobot_1_1sim_1_1IKORTest.html#robot_1_1sim_1_1VisualIKORTestp10">tests</a>.size();i++)
00088       <a class="code" href="classrobot_1_1sim_1_1IKORTest.html#robot_1_1sim_1_1VisualIKORTestp10">tests</a>[i].saveResult(filesystem);
00089   }
00090 
00091   <span class="comment">// output the results of the all tests</span>
00092   <a class="code" href="classbase_1_1PathName.html">PathName</a> outputName( alternateOutputFileName );
00093   <span class="keywordflow">if</span> (outputName.<a class="code" href="classbase_1_1PathName.html#base_1_1PathNamea16">empty</a>())  <span class="comment">//  (use name of ikortest with _result appended) </span>
00094     outputName = <a class="code" href="classbase_1_1PathName.html">PathName</a>(inputPath + PathName(<a class="code" href="classbase_1_1Named.html#base_1_1Worlda14">getName</a>()+<span class="stringliteral">"_results.xml"</span>));
00095   <a class="code" href="base.html#a3">Logln</a>(<span class="stringliteral">"Saving complete test specification and results to file '"</span> &lt;&lt; outputName.<a class="code" href="classbase_1_1PathName.html#base_1_1PathNamea7">str</a>() &lt;&lt; <span class="stringliteral">"'."</span>);
00096   
00097   ref&lt;VDirectory&gt; outDir( <a class="code" href="classrobot_1_1sim_1_1IKORTest.html#robot_1_1sim_1_1VisualIKORTestp5">filesystem</a>-&gt;getDirectory(outputName.<a class="code" href="classbase_1_1PathName.html#base_1_1PathNamea8">path</a>()) );
00098   ref&lt;VFile&gt; outputFile( outDir-&gt;createFile(outputName.<a class="code" href="classbase_1_1PathName.html#base_1_1PathNamea9">name</a>()) );
00099   <a class="code" href="classbase_1_1Externalizable.html#gfx_1_1VisualPatha29">save</a>(outputFile, outputFile-&gt;extension(),1.0);
00100   outputFile-&gt;close();
00101 }
00102   
00103 
00104 <span class="keywordtype">void</span> IKORTest::externalize(<a class="code" href="classbase_1_1Externalizer.html">base::Externalizer</a>&amp; e, String format, Real version)
00105 {
00106   <span class="keywordflow">if</span> (format == <span class="stringliteral">""</span>) format = <span class="stringliteral">"xml"</span>;
00107   
00108   <span class="keywordflow">if</span> (!<a class="code" href="classrobot_1_1sim_1_1IKORTest.html#robot_1_1sim_1_1IKORTesta12">formatSupported</a>(format,version,e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera6">ioType</a>()))
00109     <span class="keywordflow">throw</span> std::invalid_argument(<a class="code" href="base.html#a15">Exception</a>(<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"format "</span>)+format+<span class="stringliteral">" v"</span>+base::realToString(version)+<span class="stringliteral">" unsupported"</span>));
00110   
00111   <span class="keywordflow">if</span> (format == <span class="stringliteral">"xml"</span>) {
00112     
00113     <span class="keywordflow">if</span> (e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera5">isInput</a>()) {
00114 
00115       <a class="code" href="classrobot_1_1sim_1_1IKORTest.html#robot_1_1sim_1_1VisualIKORTestp11">inputPath</a> = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera7">getArchivePath</a>();
00116       
00117       DOMNode* context = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera16">context</a>();
00118       
00119       DOMElement* ikortestElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera36">getFirstElement</a>(context, <span class="stringliteral">"ikortest"</span>);
00120 
00121       <a class="code" href="classbase_1_1Named.html#base_1_1Worldb0">setName</a>( e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera42">getDefaultedElementAttribute</a>(ikortestElem, <span class="stringliteral">"name"</span>, <span class="stringliteral">"ikortest"</span>) );
00122 
00123       <span class="comment">// get environment</span>
00124       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera19">pushContext</a>(ikortestElem);
00125       env-&gt;externalize(e, format, version);
00126 
00127       <span class="keywordflow">if</span> (env-&gt;numRobots() == 0)
00128         <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"the test environment must contain at least one robot (for testing)"</span>));
00129 
00130       env-&gt;setDynamic(<span class="keyword">false</span>); <span class="comment">// we only do static tests</span>
00131       
00132       <span class="comment">// which robot (and which of its manipulators) should be used for the test</span>
00133       <a class="code" href="classrobot_1_1sim_1_1IKORTest.html#robot_1_1sim_1_1VisualIKORTestp8">testRobotIndex</a> = <a class="code" href="classrobot_1_1sim_1_1IKORTest.html#robot_1_1sim_1_1VisualIKORTestp9">testManipulatorIndex</a> = 0; <span class="comment">// default to first robot &amp; first manipulator</span>
00134       DOMElement* robotElem =  e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(ikortestElem, <span class="stringliteral">"testrobot"</span>,<span class="keyword">false</span>);
00135       <span class="keywordflow">if</span> (robotElem) {
00136         array&lt;String&gt; robotElemStrings = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere2">splitAtDelimiter</a>( e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera40">getContainedText</a>(robotElem), <span class="charliteral">','</span>);
00137         <span class="keywordflow">if</span> (robotElemStrings.size()&gt;2)
00138           <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"expected '[&lt;robotname&gt;|&lt;robot_env_index&gt;],[&lt;manipulator_name&gt;|&lt;manipulator_index&gt;]' text within element 'testrobot'"</span>));
00139         
00140         <span class="comment">// find robot</span>
00141         <a class="code" href="namespacebase.html#a4">String</a> robotName(e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere14">removeChar</a>(robotElemStrings[0],<span class="charliteral">' '</span>));
00142         <span class="keywordtype">bool</span> found=<span class="keyword">false</span>;
00143         <a class="code" href="namespacebase.html#a2">Int</a> index=0;
00144         <span class="keywordflow">while</span> ((index &lt; env-&gt;numRobots()) &amp;&amp; !found) {
00145           found = (env-&gt;getRobot(index)-&gt;getRobotDescription()-&gt;getName() == robotName); 
00146           <span class="keywordflow">if</span> (!found) index++;
00147         }
00148         <span class="keywordflow">if</span> (!found) { <span class="comment">// assume numerical index, not name</span>
00149           <span class="keywordflow">if</span> (e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere15">isNumeric</a>(robotName))
00150             <a class="code" href="classrobot_1_1sim_1_1IKORTest.html#robot_1_1sim_1_1VisualIKORTestp8">testRobotIndex</a> = <a class="code" href="namespacebase.html#a52">base::stringToInt</a>(robotName);
00151           <span class="keywordflow">else</span>
00152             <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"robot name specified in element 'testrobot' ('"</span>)+robotName+<span class="stringliteral">"'), not found in environment."</span>));
00153           <span class="keywordflow">if</span> (<a class="code" href="classrobot_1_1sim_1_1IKORTest.html#robot_1_1sim_1_1VisualIKORTestp8">testRobotIndex</a> &gt;= env-&gt;numRobots())
00154             <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"robot index specified in element 'testrobot' is out-of-range - should be [0.."</span>)+base::intToString(env-&gt;numRobots()-1)+<span class="stringliteral">"]."</span>));
00155         }
00156         <span class="keywordflow">else</span>
00157           <a class="code" href="classrobot_1_1sim_1_1IKORTest.html#robot_1_1sim_1_1VisualIKORTestp8">testRobotIndex</a> = index;
00158 
00159         
00160         <span class="comment">// now we have the robot, get its manipulator to be tested</span>
00161         ref&lt;const RobotDescription&gt; rd(env-&gt;getRobot(testRobotIndex)-&gt;getRobotDescription());
00162         <span class="keywordflow">if</span> (rd-&gt;manipulators().size() == 0)
00163           <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"robot specified in element 'testrobot' ('"</span>)+rd-&gt;getName()+<span class="stringliteral">"'), must have a manipulator (for testing)."</span>));
00164         
00165         <span class="keywordflow">if</span> (robotElemStrings.size()==2) {
00166           <a class="code" href="namespacebase.html#a4">String</a> manipName(e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere14">removeChar</a>(robotElemStrings[1],<span class="charliteral">' '</span>));
00167           <span class="keywordtype">bool</span> found=<span class="keyword">false</span>;
00168           <a class="code" href="namespacebase.html#a2">Int</a> index=0;
00169           <span class="keywordflow">while</span> ((index &lt; rd-&gt;manipulators().size()) &amp;&amp; !found) {
00170             found = (rd-&gt;manipulators()[index]-&gt;getName() == manipName); 
00171             <span class="keywordflow">if</span> (!found) index++;
00172           }
00173           <span class="keywordflow">if</span> (!found) {
00174             <span class="keywordflow">if</span> (e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere15">isNumeric</a>(manipName))
00175               testManipulatorIndex = <a class="code" href="namespacebase.html#a52">base::stringToInt</a>(manipName);
00176             <span class="keywordflow">else</span>
00177               <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"robot manipulator name specified in element 'testrobot' ('"</span>)+manipName+<span class="stringliteral">"'), isn't on robot '"</span>+rd-&gt;getName()+<span class="stringliteral">"'."</span>));
00178             <span class="keywordflow">if</span> (testManipulatorIndex &gt;= rd-&gt;manipulators().size())
00179               <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"manipulator index specified in element 'testrobot' for robot '"</span>)+rd-&gt;getName()+<span class="stringliteral">"' is out-of-range - should be [0.."</span>+<a class="code" href="namespacebase.html#a50">base::intToString</a>(rd-&gt;manipulators().size()-1)+<span class="stringliteral">"]."</span>));
00180           }
00181           <span class="keywordflow">else</span>
00182             testManipulatorIndex = index;
00183         }
00184         
00185       }
00186 
00187       
00188       <span class="comment">// read each test</span>
00189       DOMElement* testElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(ikortestElem, <span class="stringliteral">"test"</span>);
00190       <span class="keywordflow">while</span> (testElem) {
00191 
00192         Test test;
00193         test.externalize(e, format, version);
00194 
00195         <a class="code" href="classrobot_1_1sim_1_1IKORTest.html#robot_1_1sim_1_1VisualIKORTestp10">tests</a>.push_back(test);
00196 
00197         testElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(ikortestElem, <span class="stringliteral">"test"</span>, <span class="keyword">false</span>);
00198       }
00199       
00200 
00201       <span class="comment">// get display related info</span>
00202       <a class="code" href="classrobot_1_1sim_1_1IKORTest.html#robot_1_1sim_1_1VisualIKORTesto0">displayObstacles</a> = <span class="keyword">true</span>; <span class="comment">// defaults</span>
00203       <a class="code" href="classrobot_1_1sim_1_1IKORTest.html#robot_1_1sim_1_1VisualIKORTesto1">displayAxes</a> = <span class="keyword">true</span>;
00204       <a class="code" href="classrobot_1_1sim_1_1IKORTest.html#robot_1_1sim_1_1VisualIKORTesto3">displayEEPath</a> = <span class="keyword">false</span>;
00205       <a class="code" href="classrobot_1_1sim_1_1IKORTest.html#robot_1_1sim_1_1VisualIKORTesto2">displayPlatform</a> = <span class="keyword">true</span>;
00206       <a class="code" href="classrobot_1_1sim_1_1IKORTest.html#robot_1_1sim_1_1VisualIKORTesto4">displayStepMod</a> = 1;
00207       <a class="code" href="classrobot_1_1sim_1_1IKORTest.html#robot_1_1sim_1_1VisualIKORTesto5">lookAtTarget</a> = Vector3(0,0,0);
00208       <a class="code" href="classrobot_1_1sim_1_1IKORTest.html#robot_1_1sim_1_1VisualIKORTesto6">alpha</a> = -250.0;
00209       <a class="code" href="classrobot_1_1sim_1_1IKORTest.html#robot_1_1sim_1_1VisualIKORTesto7">theta</a> = 14.0;
00210       <a class="code" href="classrobot_1_1sim_1_1IKORTest.html#robot_1_1sim_1_1VisualIKORTesto8">d</a> = 9.0;
00211       DOMElement* displayElem =  e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(ikortestElem, <span class="stringliteral">"display"</span>,<span class="keyword">false</span>);
00212       <span class="keywordflow">if</span> (displayElem) {
00213 
00214         <span class="comment">// flags</span>
00215         <a class="code" href="classrobot_1_1sim_1_1IKORTest.html#robot_1_1sim_1_1VisualIKORTesto0">displayObstacles</a> = (e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(displayElem, <span class="stringliteral">"obstacles"</span>,<span class="keyword">false</span>) != 0);
00216         <a class="code" href="classrobot_1_1sim_1_1IKORTest.html#robot_1_1sim_1_1VisualIKORTesto1">displayAxes</a> = (e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(displayElem, <span class="stringliteral">"axes"</span>,<span class="keyword">false</span>) != 0);
00217         <a class="code" href="classrobot_1_1sim_1_1IKORTest.html#robot_1_1sim_1_1VisualIKORTesto2">displayPlatform</a> = (e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(displayElem, <span class="stringliteral">"platform"</span>,<span class="keyword">false</span>) != 0);
00218         <a class="code" href="classrobot_1_1sim_1_1IKORTest.html#robot_1_1sim_1_1VisualIKORTesto3">displayEEPath</a> = (e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(displayElem, <span class="stringliteral">"eepath"</span>,<span class="keyword">false</span>) != 0);
00219         DOMElement* displayStepModElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(displayElem, <span class="stringliteral">"stepmod"</span>,<span class="keyword">false</span>);
00220         <span class="keywordflow">if</span> (displayStepModElem != 0) {
00221           <a class="code" href="classrobot_1_1sim_1_1IKORTest.html#robot_1_1sim_1_1VisualIKORTesto4">displayStepMod</a> = <a class="code" href="namespacebase.html#a2">Int</a>(base::stringToInt( e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera40">getContainedText</a>(displayStepModElem,<span class="keyword">true</span>) ));
00222           <span class="keywordflow">if</span> (<a class="code" href="classrobot_1_1sim_1_1IKORTest.html#robot_1_1sim_1_1VisualIKORTesto4">displayStepMod</a> == 0) <a class="code" href="classrobot_1_1sim_1_1IKORTest.html#robot_1_1sim_1_1VisualIKORTesto4">displayStepMod</a>=1;
00223         }
00224         
00225         <span class="comment">// camera</span>
00226         DOMElement* cameraElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(displayElem, <span class="stringliteral">"camera"</span>,<span class="keyword">false</span>);
00227         <span class="keywordflow">if</span> (cameraElem) {
00228           <a class="code" href="classrobot_1_1sim_1_1IKORTest.html#robot_1_1sim_1_1VisualIKORTesto5">lookAtTarget</a> = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere6">toVector3</a>(e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera41">getElementAttribute</a>(cameraElem, <span class="stringliteral">"target"</span>,<span class="keyword">true</span>));
00229           <a class="code" href="classrobot_1_1sim_1_1IKORTest.html#robot_1_1sim_1_1VisualIKORTesto6">alpha</a> = <a class="code" href="namespacebase.html#a53">base::stringToReal</a>(e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera41">getElementAttribute</a>(cameraElem, <span class="stringliteral">"alpha"</span>,<span class="keyword">true</span>));
00230           <a class="code" href="classrobot_1_1sim_1_1IKORTest.html#robot_1_1sim_1_1VisualIKORTesto7">theta</a> = <a class="code" href="namespacebase.html#a53">base::stringToReal</a>(e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera41">getElementAttribute</a>(cameraElem, <span class="stringliteral">"theta"</span>,<span class="keyword">true</span>));
00231           <a class="code" href="classrobot_1_1sim_1_1IKORTest.html#robot_1_1sim_1_1VisualIKORTesto8">d</a> = <a class="code" href="namespacebase.html#a53">base::stringToReal</a>(e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera41">getElementAttribute</a>(cameraElem, <span class="stringliteral">"d"</span>,<span class="keyword">true</span>));
00232         }
00233       }
00234 
00235 
00236       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera20">popContext</a>();
00237 
00238       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera39">removeElement</a>(ikortestElem);
00239     }
00240     <span class="keywordflow">else</span> { <span class="comment">// output</span>
00241 
00242       DOMElement* ikortestElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"ikortest"</span>);
00243       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera26">setElementAttribute</a>(ikortestElem,<span class="stringliteral">"name"</span>,<a class="code" href="classbase_1_1Named.html#base_1_1Worlda14">getName</a>());
00244 
00245       <span class="comment">// output which robot &amp; manipulator to test</span>
00246       DOMElement* robotElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"testrobot"</span>,<span class="keyword">false</span>);
00247       <a class="code" href="namespacebase.html#a4">String</a> testRobotString(  env-&gt;getRobot(testRobotIndex)-&gt;getRobotDescription()-&gt;getName() );
00248       <span class="keywordflow">if</span> (testManipulatorIndex != 0)
00249         testRobotString += <a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">","</span>)+env-&gt;getRobot(testRobotIndex)-&gt;getRobotDescription()-&gt;manipulators()[testManipulatorIndex]-&gt;getName();
00250       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera29">appendText</a>(robotElem, testRobotString);
00251       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera34">appendNode</a>(ikortestElem, robotElem);
00252       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera22">appendBreak</a>(ikortestElem);
00253       
00254       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera19">pushContext</a>(ikortestElem);
00255       
00256       <span class="comment">// output environment</span><span class="comment"></span>
00257 <span class="comment">//!!! BUG - this is outputting the env state after the test, we want to reproduce the initial</span>
00258 <span class="comment"></span><span class="comment">// env state for output! (somehow)</span>
00259       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera22">appendBreak</a>(ikortestElem);
00260       env-&gt;externalize(e, format, version);
00261       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera22">appendBreak</a>(ikortestElem);
00262 
00263       <span class="comment">// output each test</span>
00264       <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;<a class="code" href="classrobot_1_1sim_1_1IKORTest.html#robot_1_1sim_1_1VisualIKORTestp10">tests</a>.size();i++) {
00265         <a class="code" href="classrobot_1_1sim_1_1IKORTest.html#robot_1_1sim_1_1VisualIKORTestp10">tests</a>[i].externalize(e, format, version);
00266         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera22">appendBreak</a>(ikortestElem);
00267       }
00268       
00269       
00270       <span class="comment">// output display related info</span>
00271       DOMElement* displayElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"display"</span>);
00272       
00273       <span class="comment">// flags</span>
00274       <span class="keywordflow">if</span> (<a class="code" href="classrobot_1_1sim_1_1IKORTest.html#robot_1_1sim_1_1VisualIKORTesto0">displayObstacles</a>) e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera34">appendNode</a>(displayElem, e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"obstacles"</span>));
00275       <span class="keywordflow">if</span> (<a class="code" href="classrobot_1_1sim_1_1IKORTest.html#robot_1_1sim_1_1VisualIKORTesto1">displayAxes</a>) e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera34">appendNode</a>(displayElem, e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"axes"</span>));
00276       <span class="keywordflow">if</span> (<a class="code" href="classrobot_1_1sim_1_1IKORTest.html#robot_1_1sim_1_1VisualIKORTesto2">displayPlatform</a>) e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera34">appendNode</a>(displayElem, e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"platform"</span>));
00277       <span class="keywordflow">if</span> (<a class="code" href="classrobot_1_1sim_1_1IKORTest.html#robot_1_1sim_1_1VisualIKORTesto3">displayEEPath</a>) e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera34">appendNode</a>(displayElem, e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"eepath"</span>));
00278       <span class="keywordflow">if</span> (<a class="code" href="classrobot_1_1sim_1_1IKORTest.html#robot_1_1sim_1_1VisualIKORTesto4">displayStepMod</a>&gt;1) {
00279         DOMElement* displayStepModElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"stepmod"</span>,<span class="keyword">false</span>);
00280         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera29">appendText</a>(displayStepModElem, base::intToString(displayStepMod));
00281         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera22">appendBreak</a>(displayElem);
00282         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera34">appendNode</a>(displayElem, displayStepModElem);
00283       }
00284       
00285       <span class="comment">// camera manipulator parameters</span>
00286       DOMElement* cameraElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"camera"</span>);
00287       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera26">setElementAttribute</a>(cameraElem,<span class="stringliteral">"target"</span>, e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere5">toString</a>(lookAtTarget));
00288       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera26">setElementAttribute</a>(cameraElem, <span class="stringliteral">"alpha"</span>, base::realToString(alpha));
00289       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera26">setElementAttribute</a>(cameraElem, <span class="stringliteral">"theta"</span>, base::realToString(theta));
00290       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera26">setElementAttribute</a>(cameraElem, <span class="stringliteral">"d"</span>, base::realToString(d));
00291       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera34">appendNode</a>(displayElem,cameraElem);
00292       
00293       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera34">appendNode</a>(ikortestElem, displayElem);
00294       
00295       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera20">popContext</a>();
00296 
00297       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera21">appendElement</a>(ikortestElem);
00298       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera22">appendBreak</a>(ikortestElem);
00299 
00300     }
00301     
00302   }
00303 }
00304 
00305 
00306 
00307 
00308 
00309 
00310 
00311 IKORTest::Test::Test(<span class="keyword">const</span> String&amp; name)
00312   : Named(name), initialConfigSpecified(false), toolAttached(false),
00313     timeIntervalSpecified(false), orientationControl(false), jointWeightsSpecified(false),
00314     resultsPresent(false), testCompleted(false), displayRangeSpecified(false)
00315 {
00316 }
00317 
00318 
00319 
00320 <span class="keywordtype">void</span> IKORTest::Test::saveResult(ref&lt;base::VFileSystem&gt; filesystem, PathName alternateOutputFileName)
00321 {
00322   <span class="comment">// write individual joint trajectory output</span>
00323   PathName outputPathName( alternateOutputFileName );
00324   <span class="keywordflow">if</span> (alternateOutputFileName.<a class="code" href="classbase_1_1PathName.html#base_1_1PathNamea16">empty</a>()) <span class="comment">// none specified via arg </span>
00325     outputPathName = outputFileName; <span class="comment">// so use filename specified in testspec file</span>
00326   
00327   PathName outputPath( outputPathName.<a class="code" href="classbase_1_1PathName.html#base_1_1PathNamea8">path</a>() );
00328   <span class="keywordflow">if</span> (!outputPathName.<a class="code" href="classbase_1_1PathName.html#base_1_1PathNamea12">isAbsolute</a>())
00329     outputPath = inputFilePath;<span class="comment">// output filename is relative, place it in the testspec file's dir</span>
00330   PathName outputName(outputPathName.<a class="code" href="classbase_1_1PathName.html#base_1_1PathNamea9">name</a>());
00331 
00332   <span class="comment">// replace any occurance of the text '$test' with the test name</span>
00333   <a class="code" href="namespacebase.html#a4">String</a> nameString( outputName.<a class="code" href="classbase_1_1PathName.html#base_1_1PathNamea7">str</a>() );
00334   <a class="code" href="namespacebase.html#a2">Int</a> pos = nameString.find(<span class="stringliteral">"$test"</span>, 0);
00335   <span class="keywordflow">if</span> (pos != String::npos ) {
00336     nameString.replace( pos, 5, <a class="code" href="classbase_1_1Named.html#base_1_1Worlda14">getName</a>() );
00337     outputName = PathName(nameString);
00338   }
00339   
00340   ref&lt;VDirectory&gt; outDir( filesystem-&gt;getDirectory(outputPath) );
00341 
00342   ref&lt;VFile&gt; jtrajFile( outDir-&gt;createFile(outputName) );
00343   jtraj = ManipulatorJointTrajectory(qs,times);
00344   <a class="code" href="namespacebase.html#a4">String</a> p(testCompleted?<span class="stringliteral">" "</span>:<span class="stringliteral">" *partial* "</span>);
00345   <a class="code" href="base.html#a3">Logln</a>(<span class="stringliteral">"Saving"</span> &lt;&lt; p &lt;&lt; <span class="stringliteral">"joint trajectory file '"</span> &lt;&lt; jtrajFile-&gt;pathName().str() &lt;&lt; <span class="stringliteral">"'."</span>);
00346   jtraj.save(jtrajFile);
00347   jtrajFile-&gt;close();
00348 }
00349  
00350 
00351 
00352 
00353 
00354 <span class="keywordtype">void</span> IKORTest::Test::externalize(<a class="code" href="classbase_1_1Externalizer.html">base::Externalizer</a>&amp; e, String format, Real version)
00355 {
00356   <span class="keywordflow">if</span> (format == <span class="stringliteral">""</span>) format = <span class="stringliteral">"xml"</span>;
00357   
00358   <span class="keywordflow">if</span> (!<a class="code" href="classrobot_1_1sim_1_1IKORTest.html#robot_1_1sim_1_1IKORTesta12">formatSupported</a>(format,version,e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera6">ioType</a>()))
00359     <span class="keywordflow">throw</span> std::invalid_argument(<a class="code" href="base.html#a15">Exception</a>(<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"format "</span>)+format+<span class="stringliteral">" v"</span>+base::realToString(version)+<span class="stringliteral">" unsupported"</span>));
00360   
00361   <span class="keywordflow">if</span> (format == <span class="stringliteral">"xml"</span>) {
00362     
00363     <span class="keywordflow">if</span> (e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera5">isInput</a>()) {
00364 
00365       DOMNode* context = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera16">context</a>();
00366       
00367       DOMElement* testElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(context, <span class="stringliteral">"test"</span>);
00368       <a class="code" href="classbase_1_1Named.html#base_1_1Worldb0">setName</a>( e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera42">getDefaultedElementAttribute</a>(testElem, <span class="stringliteral">"name"</span>, <span class="stringliteral">"test"</span>) );
00369 
00370       DOMElement* toolElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(testElem, <span class="stringliteral">"attachedtool"</span>,<span class="keyword">false</span>);
00371       <span class="keywordflow">if</span> (toolElem) {
00372         toolAttached = <span class="keyword">true</span>;
00373         toolName = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera40">getContainedText</a>(toolElem);
00374       }
00375       <span class="keywordflow">else</span>
00376         toolAttached = <span class="keyword">false</span>;
00377 
00378       DOMElement* configElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(testElem, <span class="stringliteral">"initialconfig"</span>,<span class="keyword">false</span>);
00379       <span class="keywordflow">if</span> (configElem) {
00380         initialConfigSpecified = <span class="keyword">true</span>;
00381         <a class="code" href="namespacebase.html#a4">String</a> configText = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera40">getContainedText</a>(configElem);
00382         initq = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere7">toVector</a>(configText);
00383       }
00384       <span class="keywordflow">else</span> 
00385         initialConfigSpecified = <span class="keyword">false</span>;
00386       
00387       
00388       DOMElement* weightElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(testElem, <span class="stringliteral">"jointweights"</span>,<span class="keyword">false</span>);
00389       <span class="keywordflow">if</span> (weightElem) {
00390         jointWeightsSpecified = <span class="keyword">true</span>;
00391         <a class="code" href="namespacebase.html#a4">String</a> weightText = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera40">getContainedText</a>(weightElem);
00392         jointWeights = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere7">toVector</a>(weightText);
00393       }
00394       <span class="keywordflow">else</span> {
00395         jointWeightsSpecified = <span class="keyword">false</span>;
00396         jointWeights = <a class="code" href="classdemeter_1_1Vector.html">Vector</a>();
00397       }
00398       
00399       
00400       <span class="comment">// get trajectory (accept either &lt;trajectory&gt; or &lt;path&gt;)</span>
00401       <span class="comment">//  also accept extra attributes for specifying the frame and possibly the time interval</span>
00402       DOMElement* trajElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(testElem, <span class="stringliteral">"trajectory"</span>,<span class="keyword">false</span>);
00403       <span class="keywordflow">if</span> (!trajElem) {
00404         trajElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(testElem, <span class="stringliteral">"path"</span>,<span class="keyword">false</span>);
00405         <span class="keywordflow">if</span> (!trajElem)
00406           <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"either &lt;trajectory&gt; or &lt;path&gt; expected in 'test' element"</span>));
00407       }
00408       
00409       <a class="code" href="namespacebase.html#a4">String</a> frameString = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera42">getDefaultedElementAttribute</a>(trajElem, <span class="stringliteral">"frame"</span>, <span class="stringliteral">""</span>);
00410       <span class="keywordtype">bool</span> frameSpecified = (frameString != <span class="stringliteral">""</span>);
00411       
00412       <a class="code" href="namespacebase.html#a4">String</a> maxdxString = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera42">getDefaultedElementAttribute</a>(trajElem, <span class="stringliteral">"maxdx"</span>, <span class="stringliteral">"default"</span>);
00413       <span class="keywordflow">if</span> (maxdxString != <span class="stringliteral">"default"</span>) {
00414         maxdx = <a class="code" href="namespacebase.html#a53">base::stringToReal</a>(maxdxString);
00415         maxdxSpecified = <span class="keyword">true</span>;
00416       }
00417       <span class="keywordflow">else</span>
00418         maxdxSpecified = <span class="keyword">false</span>;
00419       
00420 
00421       <a class="code" href="namespacebase.html#a4">String</a> timeString = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera42">getDefaultedElementAttribute</a>(trajElem, <span class="stringliteral">"timeinterval"</span>, <span class="stringliteral">"default"</span>);
00422       <span class="keywordflow">if</span> (timeString != <span class="stringliteral">"default"</span>) {
00423         timeString = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere14">removeChar</a>(timeString,<span class="charliteral">' '</span>);
00424         array&lt;String&gt; timeElts = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere2">splitAtDelimiter</a>(timeString,<span class="charliteral">':'</span>);
00425         <span class="keywordflow">if</span> (timeElts.size() == 1) { <span class="comment">// T - time period only </span>
00426           timeInterval.resize(3); <span class="comment">// time period</span>
00427           timeInterval[0] = 0;
00428           timeInterval[1] = <a class="code" href="namespacebase.html#a53">base::stringToReal</a>(timeElts[0]);
00429           timeInterval[2] = -1; <span class="comment">// unspecified</span>
00430         }
00431         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (timeElts.size() == 2) {
00432           timeInterval.resize(3); <span class="comment">// S:E - time-start : end-time only</span>
00433           timeInterval[0] = <a class="code" href="namespacebase.html#a53">base::stringToReal</a>(timeElts[0]);
00434           timeInterval[1] = <a class="code" href="namespacebase.html#a53">base::stringToReal</a>(timeElts[1]);
00435           timeInterval[2] = -1; <span class="comment">// unspecified</span>
00436         }
00437         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (timeElts.size() == 3) {
00438           <span class="keywordflow">if</span> (maxdxSpecified)
00439             <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"can't specify both the delta component of the 'timeinterval' attribute and a 'maxdx' attribute of the '&lt;path&gt;' or '&lt;trajectory&gt;' element - one or the other."</span>)));
00440 
00441           timeInterval.resize(3); <span class="comment">// S:E:d - time-start : end-time : delta (stepsize)</span>
00442           timeInterval[0] = <a class="code" href="namespacebase.html#a53">base::stringToReal</a>(timeElts[0]);
00443           timeInterval[1] = <a class="code" href="namespacebase.html#a53">base::stringToReal</a>(timeElts[1]);
00444           timeInterval[2] = <a class="code" href="namespacebase.html#a53">base::stringToReal</a>(timeElts[2]);
00445         }
00446         <span class="keywordflow">else</span>
00447           <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"invalid value for 'timeinterval' attribute for element '"</span>) 
00448                                                 + e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera24">elementTagName</a>(trajElem) + <span class="stringliteral">"' - must be '&lt;starttime&gt;:&lt;endtime&gt;' or '&lt;duration&gt;' or '&lt;starttime&gt;:&lt;endtime&gt;:&lt;stepsize&gt;'"</span>));
00449         timeIntervalSpecified = <span class="keyword">true</span>;
00450       }
00451       <span class="keywordflow">else</span>
00452         timeIntervalSpecified = <span class="keyword">false</span>;
00453 
00454 
00455       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera19">pushContext</a>(testElem);
00456       traj.externalize(e, format, version);
00457       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera20">popContext</a>();
00458 
00459       <span class="comment">// if frame wasn't specified in test, use frame specified by the trajectory/path (if available)</span>
00460       <span class="comment">//  otherwise default to "world"</span>
00461       <span class="keywordflow">if</span> (!frameSpecified) {
00462         <span class="keywordflow">if</span> (traj.getCoordFrame() != <span class="stringliteral">""</span>) 
00463           frameString = traj.getCoordFrame();
00464         <span class="keywordflow">else</span>
00465           frameString = <span class="stringliteral">"world"</span>;
00466       }
00467 
00468       frame = Robot::coordFrame(frameString);
00469       <span class="keywordflow">if</span> (frame == Robot::UnknownFrame)
00470         <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"invalid value for 'frame' attribute "</span>) 
00471                                               + <span class="stringliteral">" - must be 'ee', 'eebase', 'base', 'mount', 'platform' or 'world'."</span>));
00472 
00473 
00474       <span class="comment">// get solution parameters</span>
00475       DOMElement* solnElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(testElem, <span class="stringliteral">"solution"</span>);
00476 
00477       orientationControl = (e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera42">getDefaultedElementAttribute</a>(solnElem, <span class="stringliteral">"orientationcontrol"</span>, <span class="stringliteral">"true"</span>) == <span class="stringliteral">"true"</span>);
00478 
00479       <a class="code" href="namespacebase.html#a4">String</a> method = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera42">getDefaultedElementAttribute</a>(solnElem, <span class="stringliteral">"solnmethod"</span>, <span class="stringliteral">"pseudoinv"</span>);
00480       <span class="keywordflow">if</span> (method == <span class="stringliteral">"pseudoinv"</span>)
00481         solutionMethod = PseudoInverse;
00482       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (method== <span class="stringliteral">"fullspace"</span>)
00483         solutionMethod = FullSpace;
00484       <span class="keywordflow">else</span>
00485         <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"the 'solnmethod' attribute of the 'solution' element must be either: 'pseudoinv' or 'fullspace'"</span>));
00486 
00487       <a class="code" href="namespacebase.html#a4">String</a> optmethod = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera42">getDefaultedElementAttribute</a>(solnElem, <span class="stringliteral">"optmethod"</span>, 
00488                              <a class="code" href="namespacebase.html#a4">String</a>((solutionMethod==PseudoInverse)?<span class="stringliteral">"pseudoinv"</span>:<span class="stringliteral">"lagrangian"</span>));
00489       <span class="keywordflow">if</span> (optmethod == <span class="stringliteral">"pseudoinv"</span>) {
00490         <span class="keywordflow">if</span> (solutionMethod == FullSpace)
00491           <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"the solution method is full space parameterizaton; which is incompatible with apseudo inverse optimization method (as that is implicit via the pseudo inverse solution method)"</span>));
00492         optMethod = InverseKinematicsSolver::PseudoInv;
00493       }
00494       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (optmethod == <span class="stringliteral">"lagrangian"</span>) {
00495         <span class="keywordflow">if</span> (solutionMethod == PseudoInverse)
00496           <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"the pseudo inverse solution method is incompatible with explicit Lagrangian optimization (it implicitly performs optimization using least-norm criteria))"</span>));
00497         optMethod = IKOR::Lagrangian;
00498       }
00499       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (optmethod == <span class="stringliteral">"bangbang"</span>) {
00500         <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"Bang-bang optimization method not currently supported"</span>));
00501       }
00502       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (optmethod == <span class="stringliteral">"simplex"</span>) {
00503         <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"Simplex optimization method not currently supported"</span>));
00504       }
00505       <span class="keywordflow">else</span>
00506         <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"the 'optmethod' attribute of the 'solution' element must have a value from: 'pseudoinv', 'lagrangian', 'bangbang' or 'simplex'."</span>));
00507 
00508       
00509       <a class="code" href="namespacebase.html#a4">String</a> criteria = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera42">getDefaultedElementAttribute</a>(solnElem, <span class="stringliteral">"criteria"</span>, <span class="stringliteral">"leastnorm"</span>);
00510       <span class="keywordflow">if</span> (criteria == <span class="stringliteral">"leastnorm"</span>) {
00511         optCriteria = IKOR::LeastNorm;
00512       }
00513       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (criteria == <span class="stringliteral">"leastflow"</span>) {
00514         <span class="keywordflow">if</span> (solutionMethod == PseudoInverse)
00515           <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"the pseudo inverse solution method implicitly provides a 'leastnorm' optimization criteria - hence is incompatible with 'leastflow'"</span>));
00516         <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"least flow optimization criteria currently unsupported"</span>));
00517       }
00518       <span class="keywordflow">else</span>
00519         <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"the 'criteria' attribute of the 'solution' element must be either 'leastnorm' or 'leastflow'"</span>));
00520 
00521 
00522       <span class="comment">// constraints</span>
00523       DOMElement* constElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(testElem, <span class="stringliteral">"constraints"</span>,<span class="keyword">false</span>);
00524       <span class="keywordflow">if</span> (constElem) {
00525         DOMElement* jointElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(constElem, <span class="stringliteral">"jointlimit"</span>,<span class="keyword">false</span>);
00526         <span class="keywordflow">if</span> (jointElem) optConstraints.set(IKOR::JointLimits);
00527 
00528         DOMElement* obstElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(constElem, <span class="stringliteral">"obstacle"</span>,<span class="keyword">false</span>);
00529         <span class="keywordflow">if</span> (obstElem) optConstraints.set(IKOR::ObstacleAvoidance);
00530 
00531         DOMElement* accElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(constElem, <span class="stringliteral">"acceleration"</span>,<span class="keyword">false</span>);
00532         <span class="keywordflow">if</span> (accElem) optConstraints.set(IKOR::Acceleration);
00533 
00534         DOMElement* eeimpactElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(constElem, <span class="stringliteral">"eeimpact"</span>,<span class="keyword">false</span>);
00535         <span class="keywordflow">if</span> (eeimpactElem) optConstraints.set(IKOR::EndEffectorImpact);
00536       }
00537 
00538       <span class="keywordflow">if</span> ((solutionMethod == PseudoInverse) &amp;&amp; optConstraints.any())
00539         <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"constraints are incompatible with the pseudo inverse solution method"</span>));
00540 
00541       
00542       <span class="comment">// get output file</span>
00543       DOMElement* outputElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(testElem, <span class="stringliteral">"output"</span>,<span class="keyword">false</span>);
00544       <a class="code" href="namespacebase.html#a4">String</a> output(<a class="code" href="classbase_1_1Named.html#base_1_1Worlda14">getName</a>()+<span class="stringliteral">"_jtraj.xml"</span>); <span class="comment">// default</span>
00545       <span class="keywordflow">if</span> (outputElem) 
00546         output = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera40">getContainedText</a>(outputElem);
00547       outputFileName = PathName(output);
00548 
00549       
00550       <span class="comment">// read in any results recorded from a previous execution</span>
00551       DOMElement* resultElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(testElem, <span class="stringliteral">"result"</span>,<span class="keyword">false</span>);
00552       resultsPresent = (resultElem!=0);
00553       <span class="keywordflow">if</span> (resultsPresent) {
00554         testCompleted = (e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera42">getDefaultedElementAttribute</a>(resultElem, <span class="stringliteral">"completed"</span>, <span class="stringliteral">"true"</span>) == <span class="stringliteral">"true"</span>);
00555         <span class="keywordflow">if</span> (!testCompleted)
00556           failureString = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera42">getDefaultedElementAttribute</a>(resultElem, <span class="stringliteral">"failure"</span>, <span class="stringliteral">"unknown"</span>);
00557         
00558         <span class="comment">// first trajectory info</span>
00559         DOMElement* trajinfoElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(resultElem, <span class="stringliteral">"trajectoryinfo"</span>);
00560         
00561         <a class="code" href="namespacebase.html#a4">String</a> dataString = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera40">getContainedText</a>(trajinfoElem,<span class="keyword">true</span>);
00562         array&lt;String&gt; dataLines( e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere1">splitIntoLines</a>(dataString) );
00563         dataString = <span class="stringliteral">""</span>;
00564         
00565         times.clear(); qs.clear(); xs.clear(); dxs.clear(); dqs.clear();
00566         
00567         <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;dataLines.size(); i++) {
00568           array&lt;String&gt; vectorStrings( e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere2">splitAtDelimiter</a>(dataLines[i],<span class="charliteral">','</span>) );
00569          
00570           <span class="keywordflow">if</span> (!( ((i&lt;dataLines.size()-1) &amp;&amp; (vectorStrings.size()==5)) || ((i==dataLines.size()-1) &amp;&amp; (vectorStrings.size()==3)) ))
00571             <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"a line of 'trajectoryinfo' element doesn't contain the correct number of comma seperated vectors"</span>));
00572 
00573           times.push_back( Time(base::stringToReal(vectorStrings[0])) );
00574           qs.push_back( e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere7">toVector</a>(vectorStrings[1]) );
00575           xs.push_back( e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere7">toVector</a>(vectorStrings[2]) );
00576           <span class="keywordflow">if</span> (i!=dataLines.size()-1) {
00577             dxs.push_back( e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere7">toVector</a>(vectorStrings[3]) );
00578             dqs.push_back( e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere7">toVector</a>(vectorStrings[4]) );
00579           }
00580           
00581         }
00582         
00583         
00584         <span class="comment">// next jacobians</span>
00585         DOMElement* jacobElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(resultElem, <span class="stringliteral">"jacobians"</span>);
00586         
00587         dataString = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera40">getContainedText</a>(jacobElem,<span class="keyword">true</span>);
00588         dataLines = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere1">splitIntoLines</a>(dataString);
00589         dataString = <span class="stringliteral">""</span>;
00590         
00591         Js.clear();
00592         
00593         <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;dataLines.size(); i++) {
00594           <span class="comment">// each line consists of a time , J matrix</span>
00595           array&lt;String&gt; lineCompStrings( e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere2">splitAtDelimiter</a>(dataLines[i],<span class="charliteral">','</span>) );
00596           Time time( base::stringToReal(lineCompStrings[0]) );
00597           <span class="keywordflow">if</span> (!time.equals(times[i])) 
00598             <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"time "</span> + base::realToString(time.seconds()) + <span class="stringliteral">" of Jacobian in element 'jacobians' doesn't match corresponding time in 'trajectoryinfo' element."</span>));
00599           
00600           Js.push_back( e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere13">toMatrix</a>( lineCompStrings[1] ) );
00601         }
00602         
00603         <span class="keywordflow">if</span> (qs.size() != Js.size())
00604           <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"mismatching number step in elements 'trajectoryinfo' and 'jacobians'"</span>));
00605         
00606       }
00607 
00608       
00609       <span class="comment">// read any display specific info</span>
00610       DOMElement* displayElem =  e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(testElem, <span class="stringliteral">"display"</span>,<span class="keyword">false</span>);
00611       displayRangeSpecified = (displayElem!=0);
00612       <span class="keywordflow">if</span> (displayRangeSpecified) {
00613         displayStartIndex = <a class="code" href="namespacebase.html#a52">base::stringToInt</a>(e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera42">getDefaultedElementAttribute</a>(displayElem, <span class="stringliteral">"startIndex"</span>, <span class="stringliteral">"0"</span>));
00614         displayEndIndex = <a class="code" href="namespacebase.html#a52">base::stringToInt</a>(e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera42">getDefaultedElementAttribute</a>(displayElem, <span class="stringliteral">"endIndex"</span>, base::intToString(times.size()-1)));
00615       }
00616       
00617 
00618       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera39">removeElement</a>(testElem);
00619     }
00620     <span class="keywordflow">else</span> { <span class="comment">// output</span>
00621 
00622       DOMElement* testElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"test"</span>);
00623       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera26">setElementAttribute</a>(testElem, <span class="stringliteral">"name"</span>, <a class="code" href="classbase_1_1Named.html#base_1_1Worlda14">getName</a>());
00624       
00625       <span class="keywordflow">if</span> (toolAttached) {
00626         DOMElement* toolElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"attachedtool"</span>,<span class="keyword">false</span>);
00627         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera29">appendText</a>(toolElem, toolName);
00628         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera34">appendNode</a>(testElem, toolElem);
00629         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera22">appendBreak</a>(testElem);
00630       }
00631       
00632       <span class="keywordflow">if</span> (initialConfigSpecified) {
00633         DOMElement* configElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"initialconfig"</span>,<span class="keyword">false</span>);
00634         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera29">appendText</a>(configElem, e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere5">toString</a>(initq));
00635         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera34">appendNode</a>(testElem, configElem);
00636         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera22">appendBreak</a>(testElem);
00637       }
00638 
00639       
00640       <span class="keywordflow">if</span> (jointWeightsSpecified) {
00641         DOMElement* weightElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"jointweights"</span>,<span class="keyword">false</span>);
00642         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera29">appendText</a>(weightElem, e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere5">toString</a>(jointWeights));
00643         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera34">appendNode</a>(testElem, weightElem);
00644         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera22">appendBreak</a>(testElem);
00645       }
00646       
00647       
00648       <span class="comment">// the solution element</span>
00649       DOMElement* solnElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"solution"</span>);
00650       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera26">setElementAttribute</a>(solnElem, <span class="stringliteral">"solnmethod"</span>, <a class="code" href="namespacebase.html#a4">String</a>((solutionMethod==FullSpace)?<span class="stringliteral">"fullspace"</span>:<span class="stringliteral">"pseudoinv"</span>));
00651       <span class="keywordflow">if</span> (solutionMethod!=PseudoInverse) { <span class="comment">// method, criteria implicit for PseudoInverse</span>
00652         <a class="code" href="namespacebase.html#a4">String</a> optMethodString;
00653         <span class="keywordflow">switch</span> (optMethod) {
00654           <span class="keywordflow">case</span> InverseKinematicsSolver::PseudoInv: optMethodString=<span class="stringliteral">"pseudoinv"</span>; <span class="keywordflow">break</span>;
00655           <span class="keywordflow">case</span> IKOR::Lagrangian: optMethodString=<span class="stringliteral">"lagrangian"</span>; <span class="keywordflow">break</span>;
00656           <span class="keywordflow">default</span>: <a class="code" href="base.html#a21">Assertm</a>(<span class="keyword">false</span>,<span class="stringliteral">"unsupported optimization method"</span>);
00657         }
00658         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera26">setElementAttribute</a>(solnElem, <span class="stringliteral">"optmethod"</span>, optMethodString);
00659         <a class="code" href="namespacebase.html#a4">String</a> optCriteriaString;
00660         <span class="keywordflow">switch</span> (optCriteria) {
00661           <span class="keywordflow">case</span> IKOR::LeastNorm: optCriteriaString=<span class="stringliteral">"leastnorm"</span>; <span class="keywordflow">break</span>;
00662           <span class="keywordflow">default</span>: <a class="code" href="base.html#a21">Assertm</a>(<span class="keyword">false</span>,<span class="stringliteral">"unsupported optimization criteria"</span>);
00663         }
00664         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera26">setElementAttribute</a>(solnElem, <span class="stringliteral">"criteria"</span>, optCriteriaString);
00665       }
00666       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera26">setElementAttribute</a>(solnElem, <span class="stringliteral">"orientationcontrol"</span>, <a class="code" href="namespacebase.html#a4">String</a>(orientationControl?<span class="stringliteral">"true"</span>:<span class="stringliteral">"false"</span>));
00667               
00668       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera34">appendNode</a>(testElem, solnElem);
00669       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera22">appendBreak</a>(testElem);
00670 
00671 
00672       <span class="comment">// constraints</span>
00673       <span class="keywordflow">if</span> (solutionMethod!=PseudoInverse) { <span class="comment">// can't have constraints for PseudoInverse</span>
00674         DOMElement* constElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"constraints"</span>);
00675         <span class="keywordtype">bool</span> empty = <span class="keyword">true</span>;
00676         <span class="keywordflow">if</span> (optConstraints.test(IKOR::JointLimits)) {
00677           e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera34">appendNode</a>(constElem, e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"jointlimit"</span>,<span class="keyword">false</span>) );
00678           empty = <span class="keyword">false</span>;
00679         }
00680         <span class="keywordflow">if</span> (optConstraints.test(IKOR::ObstacleAvoidance)) {
00681           e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera34">appendNode</a>(constElem, e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"obstacle"</span>,<span class="keyword">false</span>) );
00682           empty = <span class="keyword">false</span>;
00683         }
00684         <span class="keywordflow">if</span> (optConstraints.test(IKOR::Acceleration)) {
00685           e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera34">appendNode</a>(constElem, e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"acceleration"</span>,<span class="keyword">false</span>) );
00686           empty = <span class="keyword">false</span>;
00687         }
00688         <span class="keywordflow">if</span> (optConstraints.test(IKOR::EndEffectorImpact)) {
00689           e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera34">appendNode</a>(constElem, e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"eeimpact"</span>,<span class="keyword">false</span>) );
00690           empty = <span class="keyword">false</span>;
00691         }
00692         
00693         <span class="keywordflow">if</span> (!empty) 
00694           e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera34">appendNode</a>(testElem,constElem);
00695       }
00696       
00697       
00698       <span class="comment">// output file</span>
00699       DOMElement* outputElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"output"</span>,<span class="keyword">false</span>);
00700       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera29">appendText</a>(outputElem, outputFileName.str());
00701       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera34">appendNode</a>(testElem, outputElem);
00702       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera22">appendBreak</a>(testElem);
00703        
00704        
00705       <span class="comment">// output trajectory (with extra attributes)</span>
00706       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera22">appendBreak</a>(testElem);
00707       
00708       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera19">pushContext</a>(testElem);
00709       traj.externalize(e, format, version);
00710       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera20">popContext</a>();
00711       
00712       DOMElement* trajElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(testElem, <span class="stringliteral">"trajectory"</span>); <span class="comment">// get element so we can add custom attributes</span>
00713 
00714       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera26">setElementAttribute</a>(trajElem, <span class="stringliteral">"frame"</span>, Robot::coordFrame(frame)); <span class="comment">// frame that was either in the traj or a specified override</span>
00715       
00716       <span class="keywordflow">if</span> (maxdxSpecified) 
00717         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera26">setElementAttribute</a>(trajElem, <span class="stringliteral">"maxdx"</span>, base::realToString(maxdx));
00718 
00719       <span class="keywordflow">if</span> (timeIntervalSpecified) {
00720         <a class="code" href="namespacebase.html#a4">String</a> timeString( base::realToString(timeInterval[0]) ); <span class="comment">// period or start-time</span>
00721         <span class="keywordflow">if</span> (timeInterval.size() &gt;= 2) {
00722           timeString += <a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">":"</span>)+<a class="code" href="namespacebase.html#a51">base::realToString</a>(timeInterval[1]); <span class="comment">// start-time:end-time</span>
00723           <span class="keywordflow">if</span> ((timeInterval.size() &gt;= 3) &amp;&amp; (!maxdxSpecified) &amp;&amp; (timeInterval[2]&gt;0)) 
00724             timeString += <a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">":"</span>)+<a class="code" href="namespacebase.html#a51">base::realToString</a>(timeInterval[2]); <span class="comment">// start-time:end-time:delta (stepsize)</span>
00725         }
00726         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera26">setElementAttribute</a>(trajElem, <span class="stringliteral">"timeinterval"</span>, timeString);
00727       }
00728       
00729 
00730       <span class="comment">// output test results      </span>
00731       <span class="keywordflow">if</span> (resultsPresent) {
00732         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera22">appendBreak</a>(testElem);
00733         DOMElement* resultElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"result"</span>);
00734         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera26">setElementAttribute</a>(resultElem, <span class="stringliteral">"completed"</span>, testCompleted?<span class="stringliteral">"true"</span>:<span class="stringliteral">"false"</span>);
00735         <span class="keywordflow">if</span> (!testCompleted)
00736           e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera26">setElementAttribute</a>(resultElem, <span class="stringliteral">"failure"</span>, failureString);
00737         
00738         <span class="comment">// first trajectory info (sequence of time, q, x, dx, dq)</span>
00739         DOMElement* trajinfoElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"trajectoryinfo"</span>);
00740         
00741         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera31">appendComment</a>(trajinfoElem,<span class="stringliteral">"time, q, x, dx, dq"</span>);
00742         
00743         <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;qs.size(); i++) {
00744           <a class="code" href="namespacebase.html#a4">String</a> line;
00745           line += <a class="code" href="namespacebase.html#a51">base::realToString</a>(times[i].seconds())+<span class="stringliteral">", "</span>;
00746           line += e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere5">toString</a>(qs[i])+<span class="stringliteral">", "</span>;
00747           line += e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere5">toString</a>(xs[i]);
00748           <span class="keywordflow">if</span> (i&lt;qs.size()-1) {
00749             line += <a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">", "</span>)+e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere5">toString</a>(dxs[i])+<span class="stringliteral">", "</span>;
00750             line += e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere5">toString</a>(dqs[i]);
00751           }
00752           e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera29">appendText</a>(trajinfoElem,line);
00753           e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera22">appendBreak</a>(trajinfoElem);
00754         }
00755         
00756         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera34">appendNode</a>(resultElem, trajinfoElem);
00757         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera22">appendBreak</a>(resultElem);
00758         
00759         <span class="comment">// and the Jacobian at each step</span>
00760         DOMElement* jacobElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"jacobians"</span>);
00761         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera31">appendComment</a>(jacobElem,<span class="stringliteral">"time, J(q)"</span>);
00762 
00763         <a class="code" href="base.html#a19">Assert</a>(qs.size() == Js.size());
00764         <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;Js.size(); i++) {
00765           <a class="code" href="namespacebase.html#a4">String</a> line;
00766           line += <a class="code" href="namespacebase.html#a51">base::realToString</a>(times[i].seconds())+<span class="stringliteral">", "</span>;
00767           line += e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere5">toString</a>(Js[i]);
00768           e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera29">appendText</a>(jacobElem, line);
00769           e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera22">appendBreak</a>(jacobElem);
00770         }
00771         
00772         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera34">appendNode</a>(resultElem, jacobElem);
00773         
00774         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera34">appendNode</a>(testElem, resultElem);
00775         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera22">appendBreak</a>(testElem);
00776         
00777       }
00778       
00779       <span class="comment">// output display related info</span>
00780       <span class="keywordflow">if</span> (displayRangeSpecified) {
00781         DOMElement* displayElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"display"</span>);
00782         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera26">setElementAttribute</a>(displayElem, <span class="stringliteral">"startIndex"</span>, base::intToString(displayStartIndex));
00783         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera26">setElementAttribute</a>(displayElem, <span class="stringliteral">"endIndex"</span>, base::intToString(displayEndIndex));
00784         
00785         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera34">appendNode</a>(testElem, displayElem);
00786         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera22">appendBreak</a>(testElem);
00787       }
00788 
00789 
00790       
00791       
00792       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera21">appendElement</a>(testElem);
00793       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera22">appendBreak</a>(testElem);      
00794 
00795     }
00796   }
00797 
00798 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Jul 29 15:56:38 2004 for OpenSim by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.6 </small></address>
</body>
</html>
