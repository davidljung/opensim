<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>OpenSim: robot/control/kinematics/IKORFullSpaceSolver.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>robot/control/kinematics/IKORFullSpaceSolver.cpp</h1><a href="IKORFullSpaceSolver_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/****************************************************************************</span>
00002 <span class="comment">  Copyright (C)2002 David Jung &lt;opensim@pobox.com&gt;</span>
00003 <span class="comment"></span>
00004 <span class="comment">  This program/file is free software; you can redistribute it and/or modify</span>
00005 <span class="comment">  it under the terms of the GNU General Public License as published by</span>
00006 <span class="comment">  the Free Software Foundation; either version 2 of the License, or</span>
00007 <span class="comment">  (at your option) any later version.</span>
00008 <span class="comment"></span>
00009 <span class="comment">  This program is distributed in the hope that it will be useful,</span>
00010 <span class="comment">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00011 <span class="comment">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00012 <span class="comment">  GNU General Public License for more details. (http://www.gnu.org)</span>
00013 <span class="comment"></span>
00014 <span class="comment">  You should have received a copy of the GNU General Public License</span>
00015 <span class="comment">  along with this program; if not, write to the Free Software</span>
00016 <span class="comment">  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
00017 <span class="comment"></span>
00018 <span class="comment">  $Id: IKORFullSpaceSolver.cpp 1080 2004-07-28 19:51:26Z jungd $</span>
00019 <span class="comment">  $Revision: 1.20 $</span>
00020 <span class="comment">  $Date: 2004-07-28 15:51:26 -0400 (Wed, 28 Jul 2004) $</span>
00021 <span class="comment">  $Author: jungd $</span>
00022 <span class="comment"></span>
00023 <span class="comment">****************************************************************************/</span>
00024 
00025 <span class="preprocessor">#include &lt;<a class="code" href="IKORFullSpaceSolver.html">robot/control/kinematics/IKORFullSpaceSolver</a>&gt;</span>
00026 
00027 <span class="keyword">using</span> <a class="code" href="classrobot_1_1control_1_1kinematics_1_1IKORFullSpaceSolver.html">robot::control::kinematics::IKORFullSpaceSolver</a>;
00028 
00029 <span class="comment">//</span>
00030 <span class="comment">// This file started as a 'transliteration' of the Full-Space-Parameterization</span>
00031 <span class="comment">//  (FSP) solution code from the IKORv2.0 FSP.c file</span>
00032 <span class="comment">//</span>
00033 <span class="comment">//</span>
00034 <span class="comment">// WARNING: This implementation isn't fully debugged and may not work</span>
00035 <span class="comment">//  correctly.  Use FullSpaceSolver2.</span>
00036 <span class="comment">//</span>
00037 
00038 <span class="keyword">using</span> <a class="code" href="classbase_1_1vector.html">base::IVector</a>;
00039 <span class="keyword">using</span> base::zeroIVector;
00040 <span class="keyword">using</span> base::equals;
00041 
<a name="l00042"></a><a class="code" href="IKORFullSpaceSolver_8cpp.html#a3">00042</a> <span class="keyword">const</span> Real <a class="code" href="IKOR_8cpp.html#a0">small</a> = 5.0e-05; <span class="comment">// (=def.SMALL)</span>
00043 
00044 
00045 IKORFullSpaceSolver::IKORFullSpaceSolver()
00046   : status(Unknown)
00047 {
00048   <a class="code" href="base.html#a3">Logln</a>(<span class="stringliteral">"Warning: This implementation doesn't work correctly, consider using FullSpaceSolver2 instead."</span>);
00049 }
00050 
00051 
00052 <span class="comment">// debugging convenience</span>
<a name="l00053"></a><a class="code" href="IKORFullSpaceSolver_8cpp.html#a0">00053</a> <span class="preprocessor">#define dump_A() { \</span>
00054 <span class="preprocessor">                printf("A=\n"); \</span>
00055 <span class="preprocessor">                for(Int r=0; r&lt;Nred; r++) { \</span>
00056 <span class="preprocessor">                  for(Int c=0; c&lt;Mred; c++) { \</span>
00057 <span class="preprocessor">                    printf("%9.6f ",A(slRow[r], slCol[c])); \</span>
00058 <span class="preprocessor">                  } \</span>
00059 <span class="preprocessor">                  printf("\n"); \</span>
00060 <span class="preprocessor">                } \</span>
00061 <span class="preprocessor">                printf("\n"); \</span>
00062 <span class="preprocessor">              }</span>
00063 <span class="preprocessor"></span>
<a name="l00064"></a><a class="code" href="IKORFullSpaceSolver_8cpp.html#a1">00064</a> <span class="preprocessor">#define dump_Acol(c) { \</span>
00065 <span class="preprocessor">                printf("A[:,%d(%d)]=",(c),slCol[c]); \</span>
00066 <span class="preprocessor">                for(Int r=0; r&lt;Nred; r++) { \</span>
00067 <span class="preprocessor">                  printf("%9.6f ",A(slRow[r], slCol[c])); \</span>
00068 <span class="preprocessor">                } \</span>
00069 <span class="preprocessor">                printf("\n"); \</span>
00070 <span class="preprocessor">              }</span>
00071 <span class="preprocessor"></span>
<a name="l00072"></a><a class="code" href="IKORFullSpaceSolver_8cpp.html#a2">00072</a> <span class="preprocessor">#define dump_btemp() { \</span>
00073 <span class="preprocessor">                       printf("btemp=["); \</span>
00074 <span class="preprocessor">                       for(Int r=0; r&lt;Nred; r++) { \</span>
00075 <span class="preprocessor">                         printf("%9.6f",btemp[slRow[r]]); \</span>
00076 <span class="preprocessor">                         if (r!=Nred-1) printf(","); \</span>
00077 <span class="preprocessor">                       } \</span>
00078 <span class="preprocessor">                       printf("]\n"); \</span>
00079 <span class="preprocessor">                     }</span>
00080 <span class="preprocessor"></span>
00081 
00082 <a class="code" href="classbase_1_1matrix.html">base::Matrix</a> IKORFullSpaceSolver::solve(<span class="keyword">const</span> <a class="code" href="classbase_1_1matrix.html">Matrix</a>&amp; A_in, <span class="keyword">const</span> <a class="code" href="classdemeter_1_1Vector.html">Vector</a>&amp; b_in,
00083                                         array&lt;Int&gt;&amp; dependentRowsEliminated)
00084 {
00085   <span class="comment">// Note:</span>
00086   <span class="comment">//  Variables that correspond to variables from the original IKORv2.0</span>
00087   <span class="comment">//  code are marked with (=&lt;correspinding-name&gt;); (=id) if the</span>
00088   <span class="comment">//  names are identical.</span>
00089 
00090   <span class="comment">//</span>
00091   <span class="comment">// Initialization/Setup</span>
00092   <span class="comment">//</span>
00093 
00094   <span class="comment">// make a local copy so we can modify</span>
00095   <a class="code" href="classbase_1_1matrix.html">Matrix</a> A(A_in); <span class="comment">// (=Aorig)</span>
00096   <a class="code" href="classdemeter_1_1Vector.html">Vector</a> b(b_in); <span class="comment">// (=borig)</span>
00097 <a class="code" href="debugtools.html#a7">Debugln</a>(Tmp,<span class="stringliteral">"\nSOLVE: A=\n"</span> &lt;&lt; A &lt;&lt; <span class="stringliteral">"b="</span> &lt;&lt; b);
00098   <span class="keyword">const</span> Int N = A.<a class="code" href="classbase_1_1matrix.html#base_1_1matrixa8">size1</a>(); <span class="comment">// (=global N)</span>
00099   <span class="keyword">const</span> Int M = A.<a class="code" href="classbase_1_1matrix.html#base_1_1matrixa9">size2</a>(); <span class="comment">// (=global M)</span>
00100 
00101   <a class="code" href="base.html#a19">Assert</a>(b.size()==N);
00102 
00103   <a class="code" href="classbase_1_1matrix.html">Matrix</a> Ared(N,M); <span class="comment">// reduced A (=id)</span>
00104   <a class="code" href="classdemeter_1_1Vector.html">Vector</a> bred(N);   <span class="comment">// reduced b (=id)</span>
00105 
00106   <span class="comment">// array that corresponds to the values in the first soln:</span>
00107   <span class="comment">//  !0 ==&gt; non-zero value, 0 ==&gt; zero value</span>
00108   <a class="code" href="classbase_1_1vector.html">IVector</a> firstOK(N); <span class="comment">// (=id)</span>
00109   firstOK = zeroIVector(N);
00110 
00111   <a class="code" href="classbase_1_1vector.html">IVector</a> rowElim(N); <span class="comment">// indicates if a row of A has been eliminated (and why - see consts) (=RowElim)</span>
00112   <a class="code" href="classbase_1_1vector.html">IVector</a> colElim(M); <span class="comment">// indicated if a column of A has been eliminated (and why - see consts) (=ColElim)</span>
00113   rowElim = zeroIVector(N); <span class="comment">// init to NotEleminated==0</span>
00114   colElim = zeroIVector(M);
00115 
00116   systemComplete = <span class="keyword">false</span>;
00117 
00118   <span class="comment">//</span>
00119   <span class="comment">// Solve</span>
00120   <span class="comment">//</span>
00121 
00122   <span class="keywordtype">bool</span> bIsZero = equals(b,zeroVector(N),<a class="code" href="IKOR_8cpp.html#a0">small</a>); <span class="comment">// is b completely zero? (=bcheck)</span>
00123 
00124 
00125 
00126   <span class="comment">//</span>
00127   <span class="comment">// Reduce A</span>
00128   Int Nred = N; <span class="comment">// reduced N (=FSP_data.Nred)</span>
00129   Int Mred = M; <span class="comment">// reduced M (=FSP_data.Mred)</span>
00130   <a class="code" href="classbase_1_1matrix.html">Matrix</a> specialg(M-1,M); <span class="comment">// null vectors created by specialCase1 (=Specialg)</span>
00131   Int numSpecialgs; <span class="comment">// number of g vectors created by specialCase1 (=NumSpg)</span>
00132 
00133   <span class="comment">// Eliminate all the nonredundancies from the A and B</span>
00134   reduceA(A, Ared, b, bred, M, N, Mred, Nred, colElim, rowElim, specialg, numSpecialgs);
00135 
00136   <a class="code" href="classbase_1_1matrix.html">Matrix</a> g(Mred-Nred+1+numSpecialgs, M); <span class="comment">// array of gi solution vectors (=id)</span>
00137   g = zeroMatrix(g.<a class="code" href="classbase_1_1matrix.html#base_1_1matrixa8">size1</a>(), g.<a class="code" href="classbase_1_1matrix.html#base_1_1matrixa9">size2</a>()); <span class="comment">// init to all 0s</span>
00138 
00139   <span class="comment">// Debugging output</span>
00140   <a class="code" href="debugtools.html#a7">Debugln</a>(<a class="code" href="headers_8h.html#a2">FSP</a>,<span class="stringliteral">"\n\n-------------- FSP ---------------"</span>);
00141   <a class="code" href="debugtools.html#a11">Debugcln</a>(<a class="code" href="headers_8h.html#a2">FSP</a>,<span class="stringliteral">" Ared:\n"</span> &lt;&lt; Ared);
00142   <a class="code" href="debugtools.html#a11">Debugcln</a>(<a class="code" href="headers_8h.html#a2">FSP</a>,<span class="stringliteral">" bred: "</span> &lt;&lt; bred);
00143   <a class="code" href="debugtools.html#a11">Debugcln</a>(<a class="code" href="headers_8h.html#a2">FSP</a>,<span class="stringliteral">"M:"</span> &lt;&lt; M &lt;&lt; <span class="stringliteral">" Mred:"</span> &lt;&lt; Mred &lt;&lt; <span class="stringliteral">" N:"</span> &lt;&lt; N &lt;&lt; <span class="stringliteral">" Nred:"</span> &lt;&lt; Nred);
00144   <a class="code" href="debugtools.html#a11">Debugcln</a>(<a class="code" href="headers_8h.html#a2">FSP</a>,<span class="stringliteral">"rowElim:"</span> &lt;&lt; rowElim);
00145   <a class="code" href="debugtools.html#a11">Debugcln</a>(<a class="code" href="headers_8h.html#a2">FSP</a>,<span class="stringliteral">"colElim:"</span> &lt;&lt; colElim);
00146   <span class="comment">//Debugcln(FSP,"xElim");</span>
00147 
00148 
00149   Int nullity;  <span class="comment">// dim of null-space  (=id)</span>
00150   Real K2;      <span class="comment">// condition number   (=id)</span>
00151 
00152   bIsZero = equals(<a class="code" href="classdemeter_1_1Vector.html">Vector</a>(vectorRange(bred,Range(0,Nred))),zeroVector(Nred),<a class="code" href="IKOR_8cpp.html#a0">small</a>); <span class="comment">// is bred completely zero? (=bcheck)</span>
00153   <span class="keywordflow">if</span> (bIsZero) {
00154     <a class="code" href="debugtools.html#a11">Debugcln</a>(<a class="code" href="headers_8h.html#a2">FSP</a>,<span class="stringliteral">"A is completely restricted"</span>);
00155     <a class="code" href="classbase_1_1matrix.html">Matrix</a> Asub(Nred, Mred); <span class="comment">// submatrix of Ared (=id)</span>
00156     Asub = matrixRange(Ared,Range(0,Nred), Range(0,Mred) );
00157 <a class="code" href="debugtools.html#a11">Debugcln</a>(Tmp,<span class="stringliteral">"Nred="</span> &lt;&lt; Nred &lt;&lt; <span class="stringliteral">" Mred="</span> &lt;&lt; Mred &lt;&lt; <span class="stringliteral">" Asub=\n"</span> &lt;&lt; Asub);
00158 
00159     <a class="code" href="classbase_1_1matrix.html">Matrix</a> n( Math::nullSpace(Asub, nullity, K2) ); <span class="comment">// null-space vectors (=id)</span>
00160 
00161     <span class="comment">// set solution vectors for a completely restricted system (cols of g from rows of n)</span>
00162     <span class="keyword">const</span> Int Span2 = g.<a class="code" href="classbase_1_1matrix.html#base_1_1matrixa8">size1</a>()-numSpecialgs; <span class="comment">// (=SPAN2)</span>
00163     <span class="keywordflow">for</span>(Int gc=0; gc &lt; Mred; gc++) {
00164       <span class="keywordflow">for</span>(Int gr=0; gr &lt; Span2-1; gr++)
00165         g(gr,gc) = n(gc,gr);
00166       g(Nred,gc) = 0;
00167     }
00168 
00169     systemComplete=<span class="keyword">true</span>;
00170     status = Restricted;
00171 
00172   }
00173   <span class="keywordflow">else</span> { <span class="comment">// !bIsZero</span>
00174 
00175     <span class="keywordflow">if</span> (Nred != N) {
00176       <a class="code" href="debugtools.html#a11">Debugcln</a>(<a class="code" href="headers_8h.html#a2">FSP</a>,<span class="stringliteral">"A is restricted for "</span> &lt;&lt; Nred &lt;&lt; <span class="stringliteral">" out of "</span> &lt;&lt; N &lt;&lt; <span class="stringliteral">" vector components"</span>);
00177     }
00178 
00179     <span class="keyword">const</span> Int Span2 = g.<a class="code" href="classbase_1_1matrix.html#base_1_1matrixa8">size1</a>()-numSpecialgs; <span class="comment">// (=SPAN2)</span>
00180     <a class="code" href="classbase_1_1matrix.html">Matrix</a> block(Span2, Nred); <span class="comment">// location of blocked columns for each soln (=id)</span>
00181     block = zeroMatrix(Span2,Nred);
00182     <a class="code" href="classbase_1_1matrix.html">Matrix</a> Asqr(Nred, Nred); <span class="comment">// (=id)</span>
00183 
00184     Int nextToFind = 0; <span class="comment">// vector being searched for (=NextToFind)</span>
00185 
00186     <span class="comment">//</span>
00187     <span class="comment">// find first block pattern</span>
00188     <span class="comment">//</span>
00189 
00190     <span class="comment">// initialize the blocking positions for the first solution vector</span>
00191     <span class="keywordflow">for</span>(Int c=0; c&lt;Nred; c++) block(0,c) = c;
00192 <a class="code" href="debugtools.html#a11">Debugcln</a>(DJ,<span class="stringliteral">"initialized block="</span> &lt;&lt; matrixRow(block,0) &lt;&lt; <span class="stringliteral">" Mred="</span> &lt;&lt; Mred &lt;&lt; <span class="stringliteral">" Nred="</span> &lt;&lt; Nred);
00193     <span class="comment">// The IKORv2.0 code didn't test for k&lt;Nred here, which caused tests for block(0,k) with k out of range</span>
00194     <span class="comment">//  - which probably (by luck) didn't == i, hence didn't cause any further writing into Asqr</span>
00195     <span class="keywordflow">for</span>(Int k=0, i=0; (i&lt;Mred) &amp;&amp; (k&lt;Nred); i++) {
00196       <span class="keywordflow">if</span> (block(0,k) == i) {
00197         <span class="keywordflow">for</span>(Int r=0; r&lt;Nred; r++)
00198           Asqr(r,k) = Ared(r,i);
00199         k++;
00200       }
00201     }
00202     <a class="code" href="classbase_1_1matrix.html">Matrix</a> n( Math::nullSpace(Asqr, nullity, K2) ); <span class="comment">// null-space vectors (=id)</span>
00203 
00204     <span class="comment">//Debugcln(FSP,"block:\n" &lt;&lt; block &lt;&lt; "Asqr:\n" &lt;&lt; Asqr);</span>
00205     <span class="comment">//Debugcln(FSP,"n:\n" &lt;&lt; n);</span>
00206     <span class="comment">//Debugcln(FSP,"nullity=" &lt;&lt; nullity &lt;&lt; " K2=" &lt;&lt; K2);</span>
00207 
00208 
00209     <span class="comment">//Debugcln(FSP,"block:\n" &lt;&lt; block &lt;&lt; "Asqr:\n" &lt;&lt; Asqr);</span>
00210     <span class="comment">//Debugcln(FSP,"n:\n" &lt;&lt; n);</span>
00211     <span class="comment">// loop until an acceptable well-conditioned first solution found</span>
00212     <span class="keywordflow">while</span> ( (nullity!=0) &amp;&amp; (block(0,0) &lt; N) ) {
00213 
00214       SInt pos = SInt(Nred)-1;
00215       <a class="code" href="base.html#a19">Assert</a>(pos &lt; SInt(block.<a class="code" href="classbase_1_1matrix.html#base_1_1matrixa9">size2</a>()) );
00216       <span class="keywordflow">while</span> (block(0,pos) == Span2-1+pos) { pos--; <a class="code" href="base.html#a19">Assert</a>(pos&gt;0); }
00217       block(0,pos)++;
00218       Int move=pos+1;
00219       <span class="keywordflow">while</span> (move &lt; Nred) {
00220         block(0,move) = block(0,move-1)+1;
00221         move++;
00222       }
00223 
00224       <span class="comment">// The IKORv2.0 code didn't test for k&lt;Nred here, which caused tests for block(0,k) with k out of range</span>
00225       <span class="comment">//  - which probably (by luck) didn't == i, hence didn't cause any further writing into Asqr</span>
00226       <span class="keywordflow">for</span>(Int k=0, i=0; (i&lt;Mred) &amp;&amp; (k&lt;Nred); i++) {
00227         <span class="keywordflow">if</span> (block(0,k) == i) {
00228           <span class="keywordflow">for</span>(Int r=0; r&lt;Nred; r++)
00229             Asqr(r,k) = Ared(r,i);
00230           k++;
00231         }
00232       }
00233 <a class="code" href="debugtools.html#a11">Debugcln</a>(<a class="code" href="headers_8h.html#a2">FSP</a>,<span class="stringliteral">"trying initial block="</span> &lt;&lt; matrixRow(block,0) );
00234       <span class="keywordflow">if</span> (block(0,0) &lt;= Nred)
00235         n.<a class="code" href="classbase_1_1matrix.html#base_1_1matrixa17">reset</a>( Math::nullSpace(Asqr, nullity, K2) ); <span class="comment">// calc n, nullity, K2</span>
00236 
00237       <span class="comment">//Debugcln(FSP,"block:\n" &lt;&lt; block &lt;&lt; "Asqr:\n" &lt;&lt; Asqr);</span>
00238       <span class="comment">//Debugcln(FSP,"nullity=" &lt;&lt; nullity &lt;&lt; " K2=" &lt;&lt; K2);</span>
00239     }
00240 <a class="code" href="debugtools.html#a11">Debugcln</a>(DJ,<span class="stringliteral">"found suitable first block="</span> &lt;&lt; matrixRow(block,0) );
00241 
00242 
00243 
00244 
00245     <a class="code" href="classbase_1_1vector.html">IVector</a> tackon = zeroIVector(Mred-Nred); <span class="comment">// columns are indexed for effic, soln finding (=Tackon)  //!!! changed tackon[] to Mred-Nred from M-N</span>
00246     <span class="keywordflow">for</span>(Int k=0, I=0, i=0; i&lt;Mred; i++) {
00247       <span class="keywordtype">bool</span> colIncluded = <span class="keyword">false</span>;
00248       <span class="keywordflow">if</span> (k&lt;Nred)
00249         <span class="keywordflow">if</span> (block(0,k)==i)
00250           colIncluded=<span class="keyword">true</span>;
00251       <span class="keywordflow">if</span> (!colIncluded) { <span class="comment">// not in block, add it to tackon</span>
00252         tackon[I]=i;
00253         I++;
00254       }
00255       <span class="keywordflow">else</span>
00256         k++; <span class="comment">// otherwise skip to next</span>
00257     }
00258 <a class="code" href="debugtools.html#a11">Debugcln</a>(DJ,<span class="stringliteral">"tackon="</span> &lt;&lt; tackon);
00259 
00260     <span class="comment">// calculate a new g vector for a given square blocking pattern</span>
00261     <a class="code" href="classdemeter_1_1Vector.html">Vector</a> gRow(matrixRow(g,nextToFind)); <span class="comment">// select out rows[nextToFind]</span>
00262     <a class="code" href="classdemeter_1_1Vector.html">Vector</a> blockRow(matrixRow(block,nextToFind));
00263     blockColFindX(gRow, tackon, blockRow, bred, Ared, Mred, Nred);
00264     matrixRow(g,nextToFind) = gRow;       <span class="comment">// copy them back</span>
00265     matrixRow(block,nextToFind) = blockRow;
00266 
00267 
00268     <a class="code" href="debugtools.html#a11">Debugcln</a>(<a class="code" href="headers_8h.html#a2">FSP</a>,<span class="stringliteral">"first solution\nblock:\n"</span> &lt;&lt; matrixRow(block,0) &lt;&lt; <span class="stringliteral">"\nAsqr:\n"</span> &lt;&lt; Asqr);
00269     <span class="keywordflow">if</span> (Nred==Mred)
00270       systemComplete=<span class="keyword">true</span>;
00271     <span class="keywordflow">else</span>
00272       restOfSoln(M, N, Mred, Nred, nextToFind, block, g, bred, Ared, tackon, firstOK);
00273 
00274     <a class="code" href="debugtools.html#a11">Debugcln</a>(<a class="code" href="headers_8h.html#a2">FSP</a>,<span class="stringliteral">"block:\n"</span> &lt;&lt; block &lt;&lt; <span class="stringliteral">"solutions:\n"</span> &lt;&lt; g);
00275 
00276   } <span class="comment">// end else !bIsZero</span>
00277 
00278 
00279   <span class="comment">// check if the eliminated b elements in bred can be</span>
00280   <span class="comment">//  produced from the g vectors and the reduced A matrix</span>
00281   <span class="comment">//   i.e. check that b is in the range of A</span>
00282   <span class="keywordtype">bool</span> binRange=<span class="keyword">false</span>; <span class="comment">// is b in range of A? (=binrange)</span>
00283   <span class="keywordflow">if</span> (!systemComplete) {
00284     <a class="code" href="debugtools.html#a7">Debugln</a>(<a class="code" href="headers_8h.html#a2">FSP</a>,<span class="stringliteral">"System did not complete.  Non-fatal; continuing."</span>);
00285   }
00286   <span class="keywordflow">else</span>
00287     binRange = checkRange(A,b,g,rowElim);
00288 
00289 
00290   <span class="comment">// check that the original b was not all zeros (special case)</span>
00291   String reason;
00292   <a class="code" href="base.html#a19">Assert</a>(b.size()==N);
00293   bIsZero = equals(b,zeroVector(N),<a class="code" href="IKOR_8cpp.html#a0">small</a>);
00294 
00295   <span class="keywordflow">if</span> (binRange &amp;&amp; (!bIsZero) &amp;&amp; (status != Restricted)) {
00296 
00297     rebuildgs(g, M, N, Mred, Nred, colElim, rowElim, specialg, numSpecialgs); <span class="comment">// modifies g</span>
00298     status = Complete;
00299 
00300     <span class="comment">// the original IKOR2.0 code generated the beta constraints for rows eleminated due</span>
00301     <span class="comment">//  to dependency here.  That has been seperated out into the InverseKinematicsSolver</span>
00302     <span class="comment">//  (e.g. IKOR)</span>
00303   }
00304   <span class="keywordflow">else</span> {
00305     <span class="keywordflow">if</span> (status != Restricted) {
00306       status = NotComplete;
00307       <span class="keywordflow">if</span> (!bIsZero)
00308         reason += <span class="stringliteral">": b is not in the range of A"</span>;
00309       <span class="keywordflow">else</span>
00310         reason += <span class="stringliteral">": special case - b is the zero vector; constrained optimization must be used"</span>;
00311     }
00312   }
00313 
00314 
00315   <span class="keywordflow">if</span> (status == NotComplete)
00316     <span class="keywordflow">throw</span> std::invalid_argument(<a class="code" href="base.html#a15">Exception</a>(String(<span class="stringliteral">"FSP method unable to complete solution"</span>)+reason));
00317 
00318   <span class="comment">// return the indices of rows that were eliminated due to dependency</span>
00319   dependentRowsEliminated.clear();
00320   <span class="keywordflow">for</span>(Int r=0; r&lt;N; r++)
00321     <span class="keywordflow">if</span> (rowElim[r] == RowEliminated_Dependent)
00322       dependentRowsEliminated.push_back(r);
00323 
00324   <span class="comment">// return a M x span matrix of column vectors. (transpose it)</span>
00325   <a class="code" href="classbase_1_1matrix.html">Matrix</a> gs(M,Mred-Nred+1+numSpecialgs);
00326   <span class="keywordflow">for</span>(Int r=0; r&lt;gs.<a class="code" href="classbase_1_1matrix.html#base_1_1matrixa8">size1</a>(); r++)
00327     <span class="keywordflow">for</span>(Int c=0; c&lt;gs.<a class="code" href="classbase_1_1matrix.html#base_1_1matrixa9">size2</a>(); c++)
00328       gs(r,c) = g(c,r);
00329 
00330   <span class="keywordflow">return</span> gs;
00331 }
00332 
00333 
00334 
00335 
00336 <span class="keywordtype">bool</span> IKORFullSpaceSolver::dependency(<span class="keyword">const</span> <a class="code" href="classbase_1_1matrix.html">Matrix</a>&amp; A, <span class="keyword">const</span> <a class="code" href="classbase_1_1vector.html">base::IVector</a>&amp; slRow, Int Nred, Int first, Int second)<span class="keyword"> const</span>
00337 <span class="keyword"></span>{
00338   <span class="keywordtype">bool</span> stop=<span class="keyword">false</span>;
00339   Real devidor = 0;
00340   Int i=0;
00341   <span class="keywordflow">while</span> ((i&lt;Nred) &amp;&amp; !stop) {
00342     <span class="keywordflow">if</span> ( isSmall(A(slRow[i], first)) &amp;&amp; isSmall(A(slRow[i], second)) )
00343       i++;
00344     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (!isSmall(A(slRow[i], first))) &amp;&amp; (!isSmall(A(slRow[i], second))) ) {
00345       <span class="keywordflow">if</span> (devidor==0) {
00346         devidor = ( A(slRow[i],first) / A(slRow[i],second) );
00347         i++;
00348       }
00349       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isSmall(A(slRow[i], first) - (A(slRow[i],second)*devidor)))
00350         i++;
00351       <span class="keywordflow">else</span>
00352         stop = <span class="keyword">true</span>;
00353     }
00354     <span class="keywordflow">else</span>
00355       stop = <span class="keyword">true</span>;
00356 
00357   } <span class="comment">// end while</span>
00358 
00359   <span class="keywordflow">return</span> !stop;
00360 }
00361 
00362 
00363 
00364 <span class="keywordtype">bool</span> IKORFullSpaceSolver::checkRange(<span class="keyword">const</span> <a class="code" href="classbase_1_1matrix.html">Matrix</a>&amp; A, <span class="keyword">const</span> <a class="code" href="classdemeter_1_1Vector.html">Vector</a>&amp; b, <span class="keyword">const</span> <a class="code" href="classbase_1_1matrix.html">Matrix</a>&amp; g, <span class="keyword">const</span> <a class="code" href="classbase_1_1vector.html">base::IVector</a>&amp; rowElim)
00365 {
00366   <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;A.<a class="code" href="classbase_1_1matrix.html#base_1_1matrixa8">size1</a>(); i++) {
00367     <span class="keywordflow">if</span> (rowElim[i] == RowEliminated_Dependent) {
00368       <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> j=0; j&lt;g.<a class="code" href="classbase_1_1matrix.html#base_1_1matrixa8">size1</a>();j++) {
00369         <a class="code" href="namespacebase.html#a5">Real</a> checkValue = 0.0;
00370         <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> k=0; k&lt;A.<a class="code" href="classbase_1_1matrix.html#base_1_1matrixa9">size2</a>();k++) checkValue += A(i,k) * g(j,k);
00371         <span class="keywordflow">if</span> ( Math::abs(b[i] - checkValue) &gt; 0.01) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00372       }
00373     }
00374   }
00375   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00376 }
00377 
00378 
00379 
00380 
00381 
00382 
00383 <span class="keywordtype">void</span> IKORFullSpaceSolver::reduceA(<span class="keyword">const</span> <a class="code" href="classbase_1_1matrix.html">Matrix</a>&amp; A, <a class="code" href="classbase_1_1matrix.html">Matrix</a>&amp; Ared,
00384                                   <span class="keyword">const</span> <a class="code" href="classdemeter_1_1Vector.html">Vector</a>&amp; b, <a class="code" href="classdemeter_1_1Vector.html">Vector</a>&amp; bred,
00385                                   <span class="keyword">const</span> Int M, <span class="keyword">const</span> Int N,
00386                                   Int&amp; Mred, Int&amp; Nred,
00387                                   <a class="code" href="classbase_1_1vector.html">IVector</a>&amp; colElim, <a class="code" href="classbase_1_1vector.html">IVector</a>&amp; rowElim,
00388                                   <a class="code" href="classbase_1_1matrix.html">Matrix</a>&amp; specialg, Int&amp; numSpecialgs)
00389 {
00390   <span class="comment">// initialize</span>
00391   Nred = <a class="code" href="general_8h.html#a53">N</a>; <span class="comment">// number of rows in the reduced A</span>
00392   Mred = <a class="code" href="general_8h.html#a54">M</a>; <span class="comment">// number of columns in the reduced A</span>
00393   numSpecialgs = 0;
00394   rowElim = <a class="code" href="namespacebase.html#a202">zeroIVector</a>(N);
00395   colElim = <a class="code" href="namespacebase.html#a202">zeroIVector</a>(M);
00396 
00397   <a class="code" href="classbase_1_1vector.html">IVector</a> slRow(N); <span class="comment">// Still-Left-Row    - stores remaining non eliminated rows in sequence (=SLRow)</span>
00398   <a class="code" href="classbase_1_1vector.html">IVector</a> slCol(M); <span class="comment">// Still-Left-Column - stores remaining non eliminated columns in sequence (=SLCol)</span>
00399   <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;<a class="code" href="general_8h.html#a53">N</a>; i++) slRow[i]=i;
00400   <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;<a class="code" href="general_8h.html#a54">M</a>; i++) slCol[i]=i;
00401 
00402   <a class="code" href="classdemeter_1_1Vector.html">Vector</a> xElim(M); <span class="comment">// Contains strict values for reduced dq's (=Xelim)</span>
00403   xElim = <a class="code" href="namespacebase.html#a201">zeroVector</a>(M);
00404 
00405   <a class="code" href="classdemeter_1_1Vector.html">Vector</a> btemp(b);
00406 
00407   <span class="keywordtype">bool</span> doneRed = <span class="keyword">false</span>; <span class="comment">// Keeps track if reduction is done, loop has executed without any reduction (=DoneRed)</span>
00408 
00409   <span class="comment">// start reduction</span>
00410   <span class="keywordflow">while</span> (!doneRed) {
00411 
00412     doneRed = <span class="keyword">true</span>;
00413     <span class="keywordtype">bool</span> stillChecking = <span class="keyword">true</span>; <span class="comment">// flag to mark when all nonredundancies are gone (=StillChecking)</span>
00414 
00415     <span class="comment">// Check each row for the number of nonzero elements.  If only one</span>
00416     <span class="comment">// element is nonzero, solve for the joint space motion, and</span>
00417     <span class="comment">// modify the b vector so that the appropriate row and column</span>
00418     <span class="comment">// can be eliminated from the A.  After a row is eliminated</span>
00419     <span class="comment">// the remaining A must be rechecked for any new restrictions</span>
00420 
00421     <span class="keywordflow">while</span> (stillChecking) {
00422 
00423       <a class="code" href="namespacebase.html#a2">Int</a> lastNred = Nred;
00424       <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;Nred; i++) {
00425         <a class="code" href="namespacebase.html#a1">SInt</a> j=-1;
00426         <a class="code" href="namespacebase.html#a2">Int</a> restriction = 0; <span class="comment">// num of joints which contrib to a work space d.o.f.!!! (=Restriction)</span>
00427 
00428         <span class="comment">// check for non-zero row elements</span>
00429         <a class="code" href="namespacebase.html#a2">Int</a> nonZeroCol=0; <span class="comment">// Column which has nonzero element for given row (=NonZeroCol)</span>
00430         <span class="keywordflow">while</span> ( (j &lt; <a class="code" href="namespacebase.html#a1">SInt</a>(Mred-1)) &amp;&amp; (restriction &lt; 2) ) {
00431           j++;
00432           <span class="keywordflow">if</span> (!isSmall(A(slRow[i],slCol[j])) ) {
00433             restriction++;
00434             nonZeroCol = j;
00435           }
00436         }
00437 
00438         <span class="comment">// if a row only has one nonzero element, eliminate it from the A</span>
00439         <span class="keywordflow">if</span> ( (restriction==1) &amp;&amp; (rowElim[slRow[i]] != Eliminated_ZeroOrRestriction) ) {
00440 
00441           xElim[slCol[nonZeroCol]] = btemp[slRow[i]]/A(slRow[i],slCol[nonZeroCol]);
00442 
00443           <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> k=0; k&lt;Nred; k++)
00444             btemp[slRow[k]] -= A(slRow[k],slCol[nonZeroCol]) * xElim[slCol[nonZeroCol]];
00445 
00446 
00447           colElim[slCol[nonZeroCol]] = Eliminated_ZeroOrRestriction;
00448 <a class="code" href="debugtools.html#a7">Debugln</a>(DJ,<span class="stringliteral">"Eliminating column "</span> &lt;&lt;  slCol[nonZeroCol] &lt;&lt; <span class="stringliteral">" due to restriction"</span>);
00449 <span class="comment">//Debugln(DJ,"1: reducing Mred from " &lt;&lt; Mred+1 &lt;&lt; " to " &lt;&lt; Mred &lt;&lt; " (zero or restriction)");</span>
00450           <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> j=nonZeroCol; j&lt;(Mred-1); j++) slCol[j] = slCol[j+1];
00451           Mred--;
00452 
00453           rowElim[slRow[i]] = Eliminated_ZeroOrRestriction;
00454 <a class="code" href="debugtools.html#a7">Debugln</a>(DJ,<span class="stringliteral">"eliminated row "</span> &lt;&lt; slRow[i] &lt;&lt; <span class="stringliteral">" due to restriction"</span>);
00455           <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> j=i; j&lt;(Nred-1); j++) slRow[j] = slRow[j+1];
00456           Nred--;
00457 <span class="comment">//Debugln(DJ,"2: reducing Nred from " &lt;&lt; Nred+1 &lt;&lt; " to " &lt;&lt; Nred &lt;&lt; " (zero or restriction)");</span>
00458 
00459         }
00460         <span class="keywordflow">else</span>
00461           <span class="keywordflow">if</span> ( (restriction==0) &amp;&amp; (rowElim[slRow[i]] != Eliminated_ZeroOrRestriction) ) {
00462             <span class="comment">// row of all zeros also eliminated</span>
00463             rowElim[slRow[i]] = Eliminated_ZeroOrRestriction;
00464 <a class="code" href="debugtools.html#a7">Debugln</a>(DJ,<span class="stringliteral">"row "</span> &lt;&lt; slRow[i] &lt;&lt; <span class="stringliteral">" eliminated (all zeros)"</span>);
00465             <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> j=i; j&lt;(Nred-1); j++) slRow[j] = slRow[j+1];
00466             Nred--;
00467 <span class="comment">//Debugln(DJ,"3: reducing Nred from " &lt;&lt; Nred+1 &lt;&lt; " to " &lt;&lt; Nred &lt;&lt; " (row of all zeros)");</span>
00468           }
00469 
00470       } <span class="comment">// for</span>
00471 
00472       <span class="keywordflow">if</span> (Nred == lastNred)
00473         stillChecking = <span class="keyword">false</span>;
00474 
00475     } <span class="comment">// end while (stillChecking)</span>
00476 
00477 
00478     <span class="comment">// check for columns of zeros</span>
00479     <span class="keywordflow">for</span> (<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;Mred; i++) {
00480       <a class="code" href="namespacebase.html#a2">Int</a> j=0;
00481       <span class="keywordflow">while</span> ( (j&lt;Nred) &amp;&amp; isSmall(A(slRow[j],slCol[i])) ) j++;
00482 
00483       <span class="keywordflow">if</span> (j == Nred) {
00484         colElim[slCol[i]] = Eliminated_ZeroOrRestriction;
00485 <a class="code" href="debugtools.html#a7">Debugln</a>(DJ,<span class="stringliteral">"4: reducing Mred from "</span> &lt;&lt; Mred+1 &lt;&lt; <span class="stringliteral">" to "</span> &lt;&lt; Mred &lt;&lt; <span class="stringliteral">" (column "</span> &lt;&lt; slCol[i] &lt;&lt; <span class="stringliteral">" of all zeros)"</span>);
00486         <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> j=i; j&lt;(Mred-1); j++) slCol[j] = slCol[j+1];
00487         Mred--;
00488         i--;
00489       }
00490     } <span class="comment">// end for</span>
00491 
00492 
00493     <span class="comment">// check for dependent rows</span>
00494     <span class="keywordflow">if</span> (Mred != 0) {
00495 
00496       <a class="code" href="classbase_1_1matrix.html">Matrix</a> n;
00497       <a class="code" href="classbase_1_1matrix.html">Matrix</a> Atrans(Mred,Mred);
00498 
00499       <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;Nred; i++)
00500         <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> j=0; j&lt;Mred; j++)
00501           Atrans(j,i) = A(slRow[i], slCol[j]);
00502       <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=Nred; i&lt;Mred; i++)
00503         <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> j=0; j&lt;Mred; j++)
00504           Atrans(j,i) = 0;
00505 <span class="comment">//Debugln(FSP,"Atrans:" &lt;&lt; Atrans.size1() &lt;&lt; "x" &lt;&lt; Atrans.size2());</span>
00506       <a class="code" href="namespacebase.html#a2">Int</a> nullity;
00507       <a class="code" href="namespacebase.html#a5">Real</a> K2;
00508       n.<a class="code" href="classbase_1_1matrix.html#base_1_1matrixa17">reset</a>( Math::nullSpace(Atrans, nullity, K2) );
00509       nullity += Nred-Mred;
00510 <span class="comment">//Debugln(FSP,"nullity=" &lt;&lt; nullity);</span>
00511       <span class="comment">// !!! IKORv2.0 says:</span>
00512       <span class="comment">// This is where the b's should be checked and determined if they</span>
00513       <span class="comment">// are dependent as well.  If they are not, an error message</span>
00514       <span class="comment">// should be displayed and the system should stop.</span>
00515       <span class="comment">// This is probably the best place to do this, instead of at the</span>
00516       <span class="comment">// bottom of solution_generator(), since it has the information.</span>
00517 
00518 <span class="comment">//Debugln(FSP,"slRow.size()=" &lt;&lt; slRow.size());//!!!</span>
00519       <a class="code" href="namespacebase.html#a2">Int</a> nullCount=0; <span class="comment">// (=nul_count)</span>
00520       <span class="keywordflow">while</span> (nullCount &lt; nullity) {
00521         <a class="code" href="namespacebase.html#a2">Int</a> i=Mred-Nred + nullCount;
00522         <a class="code" href="namespacebase.html#a2">Int</a> j=0;
00523         <span class="keywordflow">while</span> ( (j!=n.<a class="code" href="classbase_1_1matrix.html#base_1_1matrixa8">size1</a>()) &amp;&amp; isSmall(n(j,i)) ) j++;
00524 
00525         <span class="keywordflow">if</span> ( (rowElim[slRow[j]] != Eliminated_ZeroOrRestriction) &amp;&amp; (j != n.<a class="code" href="classbase_1_1matrix.html#base_1_1matrixa8">size1</a>()) ) {
00526           rowElim[slRow[j]] = RowEliminated_Dependent;
00527           <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> k=j; j&lt;(Nred-1); k++) {
00528 <span class="comment">//Debugcln(FSP,"k=" &lt;&lt; k);</span>
00529             slRow[k] = slRow[k+1]; <span class="comment">//!!! potential index oob here</span>
00530 <span class="comment"></span>          }
00531           Nred--;
00532 <a class="code" href="debugtools.html#a7">Debugln</a>(DJ,<span class="stringliteral">"5: reducing Nred from "</span> &lt;&lt; Nred+1 &lt;&lt; <span class="stringliteral">" to "</span> &lt;&lt; Nred &lt;&lt; <span class="stringliteral">" (dependent row)"</span>);
00533         }
00534 
00535         nullCount++;
00536 
00537       } <span class="comment">// end while</span>
00538 
00539     } <span class="comment">//  end if (Mred!=0) // check for dependent rows</span>
00540 
00541 
00542 
00543     <span class="comment">// check for Special Case 1</span>
00544     <span class="keywordtype">bool</span> stop;
00545     {
00546       <a class="code" href="classbase_1_1vector.html">IVector</a> nonZero(M); <span class="comment">// stores values of nonzero col (=Nonzero)</span>
00547       nonZero = <a class="code" href="namespacebase.html#a202">zeroIVector</a>(M);
00548       <a class="code" href="namespacebase.html#a2">Int</a> nonZeroCol;
00549 
00550       stop=<span class="keyword">false</span>;
00551       <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a1">SInt</a> i=0; i&lt; <a class="code" href="namespacebase.html#a1">SInt</a>(Nred); i++) { <span class="comment">// for each row (&amp; corresponding elt of btemp)</span>
00552 
00553         <span class="keywordflow">if</span> (isSmall(btemp[slRow[i]])) {
00554           nonZeroCol = 0;
00555           <a class="code" href="namespacebase.html#a1">SInt</a> j=0;
00556           stop = <span class="keyword">false</span>;
00557 
00558           <span class="keywordflow">while</span> ( (j &lt; (<a class="code" href="namespacebase.html#a1">SInt</a>(Mred)-1)) &amp;&amp; !stop) {
00559             <span class="keywordflow">if</span> (!isSmall(A(slRow[i], slCol[j]))) {
00560               <a class="code" href="namespacebase.html#a2">Int</a> k=j+1;
00561               <span class="keywordflow">while</span> (!stop &amp;&amp; (k&lt;Mred)) {
00562                 <span class="keywordflow">if</span> (!isSmall(A(slRow[i], slCol[k]))) {
00563                   <span class="keywordflow">if</span> (dependency(A, slRow, Nred, slCol[j], slCol[k]))
00564                     k++;
00565                   <span class="keywordflow">else</span>
00566                     stop=<span class="keyword">true</span>;
00567                 }
00568                 <span class="keywordflow">else</span>
00569                   k++;
00570 
00571               } <span class="comment">// end while (!stop...)</span>
00572               nonZero[nonZeroCol] = slCol[j];
00573               nonZeroCol++;
00574               j++;
00575             } <span class="comment">// end if (!isSmall.. )</span>
00576             <span class="keywordflow">else</span>
00577               j++;
00578 
00579           } <span class="comment">// end while ( j &lt; ...)</span>
00580 
00581           <span class="keywordflow">if</span> (!isSmall(A(slRow[i], slCol[Mred-1]))) {
00582             nonZero[nonZeroCol] = slCol[Mred-1];
00583             nonZeroCol++;
00584           }
00585 
00586           <span class="keywordflow">if</span> (nonZeroCol==1)
00587             stop = <span class="keyword">true</span>;
00588 
00589           <span class="keywordflow">if</span> (!stop) { <span class="comment">// discovered a special-case 1</span>
00590             doneRed = <span class="keyword">false</span>;
00591 <a class="code" href="debugtools.html#a6">Debug</a>(DJ,<span class="stringliteral">"Discovered specialCase 1 in row "</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">" eliminating cols:"</span>);
00592             <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> r=0; r&lt;nonZeroCol; r++) {
00593               colElim[nonZero[r]] = ColEliminated_SpecialCase1;
00594 <a class="code" href="debugtools.html#a10">Debugc</a>(DJ,<span class="stringliteral">" "</span> &lt;&lt; nonZero[r]);
00595             }
00596 <a class="code" href="debugtools.html#a11">Debugcln</a>(DJ,<span class="stringliteral">""</span>);
00597 
00598             <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> count=0, count2=0, position=0; position&lt;Mred; position++) {
00599               <span class="keywordflow">if</span> (slCol[position] != nonZero[count2]) {
00600                 slCol[count] = slCol[position];
00601                 count++;
00602               }
00603               <span class="keywordflow">else</span>
00604                 count2++;
00605             }
00606 
00607 
00608             <span class="comment">// Construct new g Matrix</span>
00609             <a class="code" href="base.html#a19">Assert</a>(nonZeroCol &gt; 0);
00610             <a class="code" href="classbase_1_1matrix.html">Matrix</a> Aelim(1,nonZeroCol);
00611             <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> r=0; r&lt;nonZeroCol; r++)
00612               Aelim(0,r) = A(slRow[i], nonZero[r]);
00613             <a class="code" href="namespacebase.html#a2">Int</a> nullity;
00614             <a class="code" href="namespacebase.html#a5">Real</a> K2;
00615 <span class="comment">//          Matrix n; //(nonZeroCol, nonZeroCol-1/*?*/);</span>
00616 
00617 
00618 
00619 <span class="comment">//Debugln(FSP,"b n dim " &lt;&lt; n.size1() &lt;&lt; "x" &lt;&lt; n.size2());//!!!</span>
00620             <a class="code" href="classbase_1_1matrix.html">Matrix</a> n = Math::nullSpace(Aelim, nullity, K2);
00621 <span class="comment">/* added by DJ (perhaps should be nonZeroCol, not nzc-1)</span>
00622 <span class="comment">            // pad n with 0s in case it is smaller than expected</span>
00623 <span class="comment">            Matrix newn(nonZeroCol,nonZeroCol-1);</span>
00624 <span class="comment">            newn = zeroMatrix(nonZeroCol,nonZeroCol-1);</span>
00625 <span class="comment">            matrixRange(newn,Range(0,n.size1()),Range(0,n.size2())) = n;</span>
00626 <span class="comment">            n.reset(newn);</span>
00627 <span class="comment">*/</span>
00628             Mred -= nonZeroCol;
00629 <a class="code" href="debugtools.html#a7">Debugln</a>(DJ,<span class="stringliteral">"6: SC1: reducing Mred from "</span> &lt;&lt; Mred+nonZeroCol &lt;&lt; <span class="stringliteral">" to "</span> &lt;&lt; Mred);
00630 <span class="comment"></span>
00631 <span class="comment">            //!!! appropriate</span>
00632 <span class="comment"></span>            <span class="keywordflow">if</span> (Mred == 0)
00633               <span class="keywordflow">throw</span> std::invalid_argument(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"FSP method unable to complete solution: A reduced to 0 columns (Mred==0)"</span>));
00634 
00635 
00636             rowElim[slRow[i]] = RowEliminated_Special;
00637             <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> r=i; r&lt;(Nred-1); r++) slRow[r] = slRow[r+1];
00638             Nred--;
00639 <a class="code" href="debugtools.html#a7">Debugln</a>(DJ,<span class="stringliteral">"7: SC1: reducing Nred from "</span> &lt;&lt; Nred+1 &lt;&lt; <span class="stringliteral">" to "</span> &lt;&lt; Nred);
00640 <span class="comment"></span>
00641 <span class="comment">            //!!! appropriate?</span>
00642 <span class="comment"></span>            <span class="keywordflow">if</span> (Nred == 0)
00643               <span class="keywordflow">throw</span> std::invalid_argument(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"FSP method unable to complete solution: A reduced to 0 rows (Nred==0)"</span>));
00644 
00645 <span class="comment">//Debugln(FSP,"specialg dim " &lt;&lt; specialg.size1() &lt;&lt; "x" &lt;&lt; specialg.size2());//!!!</span>
00646 <span class="comment">//Debugcln(FSP,"numSpecialgs=" &lt;&lt; numSpecialgs &lt;&lt; " M=" &lt;&lt; M &lt;&lt; " nonZeroCol=" &lt;&lt; nonZeroCol);</span>
00647 <span class="comment">//Debugcln(FSP,"nonZero.size()=" &lt;&lt; nonZero.size());</span>
00648 <span class="comment">//Debugln(FSP,"n dim " &lt;&lt; n.size1() &lt;&lt; "x" &lt;&lt; n.size2());//!!!</span>
00649             <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> m=0; m&lt;(nonZeroCol-1); m++) {
00650 
00651               <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> r=0; r&lt;<a class="code" href="general_8h.html#a54">M</a>; r++)
00652                 specialg(numSpecialgs, r) = 0;
00653 
00654               <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> r=0; r&lt;nonZeroCol; r++) {
00655 <span class="comment">//Debugcln(FSP,"numSpecialgs=" &lt;&lt; numSpecialgs &lt;&lt; " nonZero[r]=" &lt;&lt; nonZero[r]); //!!!</span>
00656                 specialg(numSpecialgs, nonZero[r]) = n(r,m);
00657               }
00658               numSpecialgs++;
00659             }
00660 
00661           }
00662 
00663         } <span class="comment">// end if (.. &lt; small)</span>
00664 
00665       } <span class="comment">// end for each row</span>
00666 <a class="code" href="IKORFullSpaceSolver_8cpp.html#a0">dump_A</a>();
00667 <a class="code" href="IKORFullSpaceSolver_8cpp.html#a2">dump_btemp</a>();
00668     } <span class="comment">// end Special Case 1</span>
00669 
00670 
00671 
00672     <span class="comment">// check for Special Case 2</span>
00673     {
00674       <span class="keywordtype">bool</span> stop2=<span class="keyword">false</span>;
00675       <a class="code" href="classdemeter_1_1Vector.html">Vector</a> constant(N);
00676       constant = <a class="code" href="namespacebase.html#a201">zeroVector</a>(N);
00677       <a class="code" href="namespacebase.html#a2">Int</a> reference=0; <span class="comment">// reference position for row</span>
00678       <a class="code" href="classbase_1_1vector.html">IVector</a> classA(M); <span class="comment">// classificationA columns</span>
00679       classA = <a class="code" href="namespacebase.html#a202">zeroIVector</a>(M);
00680       <a class="code" href="namespacebase.html#a2">Int</a> classANum=0; <span class="comment">// number of ClassificationA columns (=ClassANum)</span>
00681 
00682       <a class="code" href="namespacebase.html#a1">SInt</a> i=0;
00683       <span class="keywordflow">while</span> ( (i&lt;<a class="code" href="namespacebase.html#a1">SInt</a>(Nred)-1) &amp;&amp; !stop2 ) {
00684 
00685         <a class="code" href="namespacebase.html#a1">SInt</a> j=i+1;
00686         <span class="keywordflow">while</span> ( (j &lt; <a class="code" href="namespacebase.html#a1">SInt</a>(Nred)) &amp;&amp; !stop2) {
00687 
00688           stop=<span class="keyword">false</span>;
00689           <span class="keywordtype">bool</span> flag=<span class="keyword">false</span>; <span class="comment">// beta undefined flag (=Flag)</span>
00690           <a class="code" href="namespacebase.html#a5">Real</a> beta=0; <span class="comment">// (=beta)</span>
00691 
00692           <span class="keywordflow">if</span> (!isSmall(btemp[slRow[i]]))
00693             beta = btemp[slRow[j]] / btemp[slRow[i]];
00694           <span class="keywordflow">else</span>
00695             flag = <span class="keyword">true</span>;
00696 
00697           classANum=0;
00698           <a class="code" href="namespacebase.html#a2">Int</a> k=0;
00699           reference=i;
00700 
00701           <span class="keywordflow">while</span> ( !stop &amp;&amp; (k&lt;Mred) ) {
00702             <span class="keywordtype">bool</span> goIn = <span class="keyword">false</span>; <span class="comment">// "Go in" for entance into ClassA (=Goin)</span>
00703 
00704             <span class="keywordflow">if</span> (isSmall(A(slRow[i], slCol[k]))) {
00705               <span class="keywordflow">if</span> (!flag) goIn = <span class="keyword">true</span>;
00706             }
00707             <span class="keywordflow">else</span> {
00708               <span class="keywordflow">if</span> (!isSmall( A(slRow[j],slCol[k]) / A(slRow[i],slCol[k]) - beta ) )
00709                 goIn=<span class="keyword">true</span>;
00710               <span class="keywordflow">if</span> (flag) goIn=<span class="keyword">true</span>;
00711             }
00712 
00713             <span class="keywordflow">if</span> (goIn) {
00714 
00715               classA[classANum] = slCol[k];
00716               <span class="keywordflow">if</span> (classANum==0) {
00717 
00718                 <span class="keywordflow">if</span> (isSmall(A(slRow[reference],classA[0]))) {
00719                   reference=j;
00720                   <span class="keywordflow">if</span> (isSmall(A(slRow[reference],classA[0]))) <span class="comment">//!!! redundant test?</span>
00721 <span class="comment"></span>                    stop = <span class="keyword">true</span>;
00722                 }
00723 
00724                 <span class="keywordflow">if</span> (!stop)
00725                   <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> r=0; r&lt;Nred; r++)
00726                     constant[r] = A(slRow[r],classA[0]) / A(slRow[reference],classA[0]);
00727 
00728               } <span class="comment">// end if (classANum==0)</span>
00729               <span class="keywordflow">else</span> { <span class="comment">// i.e. classANum != 0</span>
00730                 <span class="keywordflow">if</span> (isSmall(A(slRow[reference],classA[classANum])))
00731                   stop = <span class="keyword">true</span>;
00732                 <span class="keywordflow">else</span> {
00733                   <a class="code" href="namespacebase.html#a2">Int</a> r=0;
00734                   <span class="keywordflow">while</span> ( (r&lt;Nred) &amp;&amp; !stop) {
00735                     <span class="keywordflow">if</span> (!isSmall( (A(slRow[r],classA[classANum]) / A(slRow[reference],classA[classANum]) ) - constant[r]))
00736                       stop=<span class="keyword">true</span>;
00737                     r++;
00738                   } <span class="comment">// end while</span>
00739                 }
00740               } <span class="comment">// end else (classANum != 0)</span>
00741 
00742               classANum++;
00743 
00744             } <span class="comment">// end if (goIn)</span>
00745             k++;
00746 
00747           } <span class="comment">// end while (!stop &amp;&amp; (k&lt;Mred)</span>
00748           <span class="keywordflow">if</span> (!stop) stop2=<span class="keyword">true</span>;
00749           j++;
00750 
00751         } <span class="comment">// end while (j &lt; Nred) &amp;&amp; !stop2</span>
00752         i++;
00753 
00754       } <span class="comment">// end while (i &lt; Nred-1) &amp;&amp; !stop2</span>
00755 
00756 
00757       <span class="keywordflow">if</span> (stop2) {
00758 <a class="code" href="debugtools.html#a7">Debugln</a>(DJ,<span class="stringliteral">"Discovered specialCase 2"</span>);
00759 
00760         doneRed=<span class="keyword">false</span>;
00761 
00762         <span class="comment">// construct new g matrix</span>
00763         <a class="code" href="classbase_1_1matrix.html">Matrix</a> Aelim(1,classANum);
00764         <a class="code" href="classbase_1_1matrix.html">Matrix</a> n(classANum, classANum-1);
00765         <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> p=0; p&lt;classANum; p++)
00766           Aelim(0,p) = A(slRow[reference], classA[p]);
00767         <a class="code" href="namespacebase.html#a2">Int</a> nullity;
00768         <a class="code" href="namespacebase.html#a5">Real</a> K2;
00769         n = Math::nullSpace(Aelim, nullity, K2);
00770 
00771         <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> p=0; p&lt;(classANum-1); p++) {
00772           <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> r=0; r&lt;<a class="code" href="general_8h.html#a54">M</a>; r++)
00773             specialg(numSpecialgs,r)=0;
00774           <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> r=0; r&lt;classANum; r++)
00775             specialg(numSpecialgs, classA[r]) = n(r,p);
00776           numSpecialgs++;
00777 <a class="code" href="debugtools.html#a11">Debugcln</a>(DJ,<span class="stringliteral">"new soln: "</span> &lt;&lt; <a class="code" href="classdemeter_1_1Vector.html">Vector</a>(<a class="code" href="namespacebase.html#a82">matrixRow</a>(specialg, numSpecialgs-1)) );
00778         } <span class="comment">// end for p</span>
00779 
00780         Nred--;
00781 <span class="comment">//Debugcln(DJ,"8: SC2: reducing Nred from " &lt;&lt; Nred+1 &lt;&lt; " to " &lt;&lt; Nred);</span><span class="comment"></span>
00782 <span class="comment">        //!!! appropriate?</span>
00783 <span class="comment"></span>        <span class="keywordflow">if</span> (Nred == 0)
00784           <span class="keywordflow">throw</span> std::invalid_argument(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"FSP method unable to complete solution: A reduced to 0 rows (Nred==0)"</span>));
00785 
00786         rowElim[slRow[reference]] =  RowEliminated_Special;
00787 <a class="code" href="debugtools.html#a10">Debugc</a>(DJ,<span class="stringliteral">"eliminated row "</span> &lt;&lt; slRow[reference] &lt;&lt; <span class="stringliteral">" and cols:"</span>);
00788         <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> r=0; r&lt;classANum; r++) {
00789           colElim[classA[r]] = ColEliminated_SpecialCase2;
00790 <a class="code" href="debugtools.html#a10">Debugc</a>(DJ,<span class="stringliteral">" "</span> &lt;&lt; classA[r]);
00791         }
00792 <a class="code" href="debugtools.html#a11">Debugcln</a>(DJ,<span class="stringliteral">""</span>);
00793         <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> r=reference; r&lt;Nred; r++) slRow[r] = slRow[r+1];
00794 
00795         <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> count=0, count2=0, position=0; position&lt;Mred; position++)
00796           <span class="keywordflow">if</span> (slCol[position] != classA[count2]) {
00797             slCol[count] = slCol[position];
00798             count++;
00799           }
00800           <span class="keywordflow">else</span>
00801             count2++;
00802 <span class="comment"></span>
00803 <span class="comment">        //!!! appropriate?</span>
00804 <span class="comment"></span>        <span class="keywordflow">if</span> ((<a class="code" href="namespacebase.html#a1">SInt</a>(Mred) - <a class="code" href="namespacebase.html#a1">SInt</a>(classANum)) &lt;= 0)
00805           <span class="keywordflow">throw</span> std::invalid_argument(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"FSP method unable to complete solution: A reduced to 0 columns (Mred==0)"</span>));
00806 
00807         Mred -= classANum;
00808 <span class="comment">//Debugln(DJ,"9: SC2: reducing Mred from " &lt;&lt; Mred+classANum &lt;&lt; " to " &lt;&lt; Mred);</span>
00809       } <span class="comment">// end if (stop2)</span>
00810 
00811     } <span class="comment">// end Special Case 2</span>
00812 
00813 
00814   } <span class="comment">// end while (!doneRed)</span>
00815 
00816 
00817 
00818 
00819   <span class="comment">// store the reduced A in the variable Ared, and the modified b in bred</span>
00820   <span class="keywordflow">if</span> ((Nred &gt; 0) &amp;&amp; (Mred &gt; 0)) {
00821     Ared.<a class="code" href="classbase_1_1matrix.html#base_1_1matrixa15">resize</a>(Nred, Mred);
00822     bred.resize(Nred);
00823     <a class="code" href="namespacebase.html#a1">SInt</a> j=-1;
00824     <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;<a class="code" href="general_8h.html#a53">N</a>; i++)
00825       <span class="keywordflow">if</span> (rowElim[i] == NotEleminated) {
00826         j++;
00827         bred[j] = btemp[i];
00828         <a class="code" href="namespacebase.html#a1">SInt</a> m=-1;
00829         <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> k=0; k&lt;<a class="code" href="general_8h.html#a54">M</a>; k++)
00830           <span class="keywordflow">if</span> (colElim[k] == NotEleminated) {
00831             m++;
00832             Ared(j,m) = A(i,k);
00833           }
00834       }
00835   }
00836   <span class="keywordflow">else</span>
00837     <span class="keywordflow">throw</span> std::runtime_error(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"FSP method error: The A matrix has been reduced to nothing"</span>));
00838 
00839 }
00840 
00841 
00842 <span class="comment"></span>
00843 <span class="comment">///  calculates a g vector for a given square blocking pattern.</span>
00844 <span class="comment"></span><span class="keywordtype">void</span> IKORFullSpaceSolver::blockColFindX(<a class="code" href="classdemeter_1_1Vector.html">Vector</a>&amp; g,
00845                                         <span class="keyword">const</span> <a class="code" href="classbase_1_1vector.html">IVector</a>&amp; tackon, <span class="keyword">const</span> <a class="code" href="classdemeter_1_1Vector.html">Vector</a>&amp; block,
00846                                         <span class="keyword">const</span> <a class="code" href="classdemeter_1_1Vector.html">Vector</a>&amp; b, <span class="keyword">const</span> <a class="code" href="classbase_1_1matrix.html">Matrix</a>&amp; A,
00847                                         <span class="keyword">const</span> Int Mred, <span class="keyword">const</span> Int Nred)
00848 {
00849   <a class="code" href="classbase_1_1matrix.html">Matrix</a> Atemp(Nred, Nred);
00850   <a class="code" href="classdemeter_1_1Vector.html">Vector</a> btemp(Nred);
00851   <a class="code" href="classdemeter_1_1Vector.html">Vector</a> blocktemp(Nred);
00852 
00853   <span class="comment">// the columns blocked need to be listed from smallest to largest</span>
00854   btemp=b;
00855   blocktemp=block;
00856 
00857   <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=(Nred-1); i&gt;0; i--)
00858     <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a1">SInt</a> j=i-1; j&gt;=0; j--)
00859       <span class="keywordflow">if</span> (blocktemp[i] &lt; blocktemp[j])
00860         <a class="code" href="namespacebase.html#a46">base::swap</a>(blocktemp[i], blocktemp[j]);
00861 <a class="code" href="debugtools.html#a7">Debugln</a>(DJ,<span class="stringliteral">"blocktemp="</span> &lt;&lt; blocktemp);
00862   <span class="comment">// !!! IKORv2 has an I var in this loop, it doesn't appear to be used (??)</span>
00863   <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> k=0, i=0; (i&lt;Mred) &amp;&amp; (k&lt;Nred); i++) { <span class="comment">//!!! added k&lt;Nred</span>
00864 <span class="comment"></span>    <span class="keywordflow">if</span> (blocktemp[k] == i) {
00865       <a class="code" href="namespacebase.html#a84">matrixColumn</a>(Atemp,k) = <a class="code" href="namespacebase.html#a84">matrixColumn</a>(A,i);
00866       k++;
00867     }
00868   }
00869 <a class="code" href="debugtools.html#a7">Debugln</a>(DJ,<span class="stringliteral">"Atemp=\n"</span> &lt;&lt; Atemp);
00870   <span class="comment">//Debugcln(FSP,"asqr=\n" &lt;&lt; Atemp);</span>
00871 
00872   <a class="code" href="classdemeter_1_1Vector.html">Vector</a> gtemp( Math::inverse(Atemp)*btemp );
00873 
00874   <a class="code" href="debugtools.html#a11">Debugcln</a>(FSP,<span class="stringliteral">"gvector=\n"</span> &lt;&lt; gtemp);
00875 
00876   <span class="comment">// Now add a zero to where column was blocked</span>
00877   <span class="keywordflow">for</span> (<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;Nred; i++)
00878     g[<a class="code" href="namespacebase.html#a2">Int</a>(blocktemp[i])] = gtemp[i];
00879 
00880   <a class="code" href="base.html#a19">Assert</a>(Mred-Nred &lt;= tackon.<a class="code" href="classbase_1_1vector.html#base_1_1vectora12">size</a>());
00881   <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> j=0; j&lt;Mred-Nred; j++) {
00882     <span class="keywordflow">if</span> (tackon[j] &lt; g.size()) g[tackon[j]]=0; <span class="comment">//!!! added if (..&lt;..)</span>
00883 <span class="comment"></span>  }
00884 
00885 }
00886 
00887 
00888 
00889 
00890 
00891 
00892 <span class="keywordtype">void</span> IKORFullSpaceSolver::restOfSoln(<span class="keyword">const</span> Int M, <span class="keyword">const</span> Int N, <span class="keyword">const</span> Int Mred, <span class="keyword">const</span> Int Nred,
00893                                      Int nextToFind,
00894                                      <a class="code" href="classbase_1_1matrix.html">Matrix</a>&amp; block, <a class="code" href="classbase_1_1matrix.html">Matrix</a>&amp; g,
00895                                      <span class="keyword">const</span> <a class="code" href="classdemeter_1_1Vector.html">Vector</a>&amp; bred, <span class="keyword">const</span> <a class="code" href="classbase_1_1matrix.html">Matrix</a>&amp; Ared,
00896                                      <span class="keyword">const</span> <a class="code" href="classbase_1_1vector.html">base::IVector</a>&amp; tackon, <a class="code" href="classbase_1_1vector.html">base::IVector</a>&amp; firstOK)
00897 {
00898   <a class="code" href="debugtools.html#a7">Debugln</a>(FSP,<span class="stringliteral">"Entering RestOfSoln()"</span>);
00899   nextToFind++; <span class="comment">// looking for next soln</span>
00900 
00901   <a class="code" href="namespacebase.html#a2">Int</a> <a class="code" href="Globals_8h.html#a16">X</a>, Y; <span class="comment">// Position markers, keeping track of the current column to be subbed in for and which one to sub in (=id)</span>
00902 
00903   <a class="code" href="Globals_8h.html#a16">X</a> = nextToFind-1;
00904 <a class="code" href="debugtools.html#a11">Debugcln</a>(FSP,<span class="stringliteral">"g=\n"</span> &lt;&lt; g);
00905 
00906   <span class="comment">// Change firstOK if a previously 0 value of g for a column in first</span>
00907   <span class="comment">// blocking pattern has become nonzero</span>
00908   <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;Nred; i++)
00909     <span class="keywordflow">if</span> ( (!firstOK[i]) &amp;&amp; (!isSmall(g(nextToFind-1, <a class="code" href="namespacebase.html#a2">Int</a>(block(nextToFind-1,i))))) )
00910       firstOK[i] = <a class="code" href="namespacebase.html#a2">Int</a>(<span class="keyword">true</span>);
00911 
00912   <a class="code" href="classbase_1_1vector.html">IVector</a> changed(Nred); <span class="comment">// temp vector for firstOK, passed to recursive call (=Changed)</span>
00913   changed = <a class="code" href="namespacebase.html#a205">vectorRange</a>(firstOK,<a class="code" href="namespacebase.html#a30">Range</a>(0,Nred));
00914   <a class="code" href="debugtools.html#a11">Debugcln</a>(FSP,<span class="stringliteral">"changed="</span> &lt;&lt; changed);
00915 
00916   <span class="keywordflow">while</span> ( (<a class="code" href="Globals_8h.html#a16">X</a> &lt; Mred-Nred) &amp;&amp; (!systemComplete) ) {
00917 
00918     <a class="code" href="debugtools.html#a11">Debugcln</a>(FSP,<span class="stringliteral">"X="</span> &lt;&lt; X &lt;&lt; <span class="stringliteral">" next soln to find is "</span> &lt;&lt; nextToFind);
00919 
00920     <span class="comment">// Set up next Asub comparing the next remaining column to be subbed</span>
00921     <span class="comment">// in with the blocking pattern for that level of recursion</span>
00922     <a class="code" href="classbase_1_1matrix.html">Matrix</a> Asub(Nred,Nred+1);
00923     <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;Nred; i++)
00924       <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> r=0; r&lt;Nred; r++)
00925         Asub(r,i) = Ared(r, <a class="code" href="namespacebase.html#a2">Int</a>(block(nextToFind-1,i)) );
00926     <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> r=0; r&lt;Nred; r++)
00927       Asub(r,Nred) = Ared(r,tackon[X]);
00928 
00929     <a class="code" href="namespacebase.html#a2">Int</a> nullity; <span class="comment">// dim of null-space  (=id)</span>
00930     <a class="code" href="namespacebase.html#a5">Real</a> K2;     <span class="comment">// condition number   (=id)</span>
00931     <a class="code" href="classbase_1_1matrix.html">Matrix</a> n( Math::nullSpace(Asub, nullity, K2) ); <span class="comment">// null-space vectors (=id)</span>
00932 
00933     Y=0;
00934     <span class="comment">// Loop which compares column to be subbed in with current blocking</span>
00935     <span class="comment">// pattern for dependency, if dependent it completes swap and valid</span>
00936     <span class="keywordflow">while</span> ( (Y &lt; Nred) &amp;&amp; (!systemComplete) ) {
00937 
00938       <a class="code" href="debugtools.html#a11">Debugcln</a>(FSP,<span class="stringliteral">"Y="</span> &lt;&lt; Y &lt;&lt; <span class="stringliteral">" X="</span> &lt;&lt; X);
00939       <a class="code" href="debugtools.html#a11">Debugcln</a>(FSP, <span class="stringliteral">"compare column "</span> &lt;&lt; tackon[X] &lt;&lt; <span class="stringliteral">" with "</span> &lt;&lt; <a class="code" href="namespacebase.html#a2">Int</a>(block(nextToFind-1,Y)) );
00940       <a class="code" href="debugtools.html#a11">Debugcln</a>(FSP, <span class="stringliteral">" it is "</span> &lt;&lt; Math::abs(n(Y,0)) &lt;&lt; <span class="stringliteral">" and firstOK[Y]="</span> &lt;&lt; firstOK[Y]);
00941 
00942       <span class="keywordflow">if</span> ( (!isSmall(n(Y,0))) &amp;&amp; (firstOK[Y]) ) {
00943 
00944         <a class="code" href="debugtools.html#a11">Debugcln</a>(FSP,<span class="stringliteral">"*************** "</span> &lt;&lt; nextToFind &lt;&lt; <span class="stringliteral">" ****************"</span>);
00945 
00946         <a class="code" href="debugtools.html#a11">Debugcln</a>(FSP,<span class="stringliteral">"** block=\n"</span> &lt;&lt; block);
00947         <a class="code" href="debugtools.html#a11">Debugcln</a>(FSP,<span class="stringliteral">"** tackon="</span> &lt;&lt; tackon);
00948         <a class="code" href="debugtools.html#a11">Debugcln</a>(DJ, <span class="stringliteral">"** X="</span> &lt;&lt; X &lt;&lt; <span class="stringliteral">" Y="</span> &lt;&lt; Y);
00949 
00950         <a class="code" href="classbase_1_1vector.html">IVector</a> newTack(M-N); <span class="comment">// temp vector for tackon, passed in recursive call</span>
00951         <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;Nred; i++) block(nextToFind,i) = block(nextToFind-1,i);
00952         newTack[0] = <a class="code" href="namespacebase.html#a2">Int</a>(block(nextToFind,Y));
00953         block(nextToFind,Y) = tackon[<a class="code" href="Globals_8h.html#a16">X</a>];
00954         <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;<a class="code" href="Globals_8h.html#a16">X</a>; i++) newTack[i+1] = tackon[i];
00955         <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> j=<a class="code" href="Globals_8h.html#a16">X</a>+1; j&lt;Mred-Nred; j++)
00956           newTack[j] = tackon[j];
00957 
00958         <a class="code" href="debugtools.html#a11">Debugcln</a>(FSP,<span class="stringliteral">"** newTack="</span> &lt;&lt; newTack);
00959         <a class="code" href="debugtools.html#a11">Debugcln</a>(FSP,<span class="stringliteral">"** block=\n"</span> &lt;&lt; block);
00960         <a class="code" href="debugtools.html#a11">Debugcln</a>(FSP,<span class="stringliteral">"** g=\n"</span> &lt;&lt; g);
00961 
00962         <a class="code" href="classdemeter_1_1Vector.html">Vector</a> gRow(<a class="code" href="namespacebase.html#a82">matrixRow</a>(g,nextToFind)); <span class="comment">// select out rows[nextToFind]</span>
00963         <a class="code" href="classdemeter_1_1Vector.html">Vector</a> blockRow(<a class="code" href="namespacebase.html#a82">matrixRow</a>(block,nextToFind));
00964         blockColFindX(gRow, newTack, blockRow, bred, Ared, Mred, Nred);
00965         <a class="code" href="namespacebase.html#a82">matrixRow</a>(g,nextToFind) = gRow;       <span class="comment">// copy them back</span>
00966         <a class="code" href="namespacebase.html#a82">matrixRow</a>(block,nextToFind) = blockRow;
00967 
00968         <a class="code" href="debugtools.html#a7">Debugln</a>(FSP,<span class="stringliteral">"** block=\n"</span> &lt;&lt; block);
00969         <a class="code" href="debugtools.html#a11">Debugcln</a>(FSP,<span class="stringliteral">"** g=\n"</span> &lt;&lt; g);
00970 
00971         <a class="code" href="debugtools.html#a11">Debugcln</a>(FSP,<span class="stringliteral">" it will be g(nextToFind,block(nextToFind,Y)="</span> &lt;&lt; Math::abs(g(nextToFind,<a class="code" href="namespacebase.html#a2">Int</a>(block(nextToFind,Y)))));
00972 
00973 
00974         <span class="comment">// Check to ensure the newly created g vector is independent</span>
00975         <span class="comment">// of previously created ones in branch</span>
00976         <span class="keywordflow">if</span> ( !isSmall(g(nextToFind,<a class="code" href="namespacebase.html#a2">Int</a>(block(nextToFind,Y)))) ) {
00977           <span class="keywordflow">if</span> (nextToFind &lt; (Mred-Nred)) {
00978             <span class="comment">//Debugcln(FSP,"block:\n" &lt;&lt; block);</span>
00979             <a class="code" href="debugtools.html#a11">Debugcln</a>(FSP,<span class="stringliteral">"solutions:\n"</span> &lt;&lt; g);
00980 
00981             <span class="comment">// recursive call</span>
00982             restOfSoln(M, N, Mred, Nred, nextToFind, block, g, bred, Ared, newTack, changed);
00983           }
00984           <span class="keywordflow">else</span> {
00985             systemComplete=<span class="keyword">true</span>;
00986           }
00987         } <span class="comment">// endif abs(g...) &gt; small</span>
00988 
00989 
00990         <span class="keywordflow">if</span> (!systemComplete)
00991           block(nextToFind,Y) = newTack[0];
00992 
00993       } <span class="comment">// endif Y &gt; small &amp;&amp; ...</span>
00994 
00995       Y++;
00996 
00997     } <span class="comment">// while</span>
00998 
00999     <a class="code" href="Globals_8h.html#a16">X</a>++;
01000 
01001   } <span class="comment">// while</span>
01002 
01003 
01004 }
01005 
01006 
01007 
01008 
01009 <span class="keywordtype">void</span> IKORFullSpaceSolver::rebuildgs(<a class="code" href="classbase_1_1matrix.html">Matrix</a>&amp; g,
01010                                     <span class="keyword">const</span> Int M, <span class="keyword">const</span> Int N, <span class="keyword">const</span> Int Mred, <span class="keyword">const</span> Int Nred,
01011                                     <span class="keyword">const</span> <a class="code" href="classbase_1_1vector.html">IVector</a>&amp; colElim, <span class="keyword">const</span> <a class="code" href="classbase_1_1vector.html">IVector</a>&amp; rowElim,
01012                                     <span class="keyword">const</span> <a class="code" href="classbase_1_1matrix.html">Matrix</a>&amp; specialg, <span class="keyword">const</span> Int numSpecialgs)
01013 {
01014   <a class="code" href="classbase_1_1matrix.html">Matrix</a> gtemp(g);
01015 
01016   <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> k=0, j=0; j&lt;<a class="code" href="general_8h.html#a54">M</a>; j++) {
01017 
01018     <span class="keywordflow">if</span> (colElim[j] != NotEleminated) {
01019       <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;g.<a class="code" href="classbase_1_1matrix.html#base_1_1matrixa8">size1</a>(); i++) g(i,j) = 0;
01020     }
01021     <span class="keywordflow">else</span> {
01022       <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;g.<a class="code" href="classbase_1_1matrix.html#base_1_1matrixa8">size1</a>(); i++) g(i,j) = gtemp(i,k);
01023       k++;
01024     }
01025   }
01026 
01027   <span class="comment">// Addition of null vectors created by SpecialCase1</span>
01028   <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=(Mred-Nred+1); i&lt;(Mred-Nred+1+numSpecialgs); i++)
01029     <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> j=0; j&lt;<a class="code" href="general_8h.html#a54">M</a>; j++) {
01030       <span class="keywordflow">if</span> (colElim[j] != NotEleminated)
01031         g(i,j) = specialg(i-Mred+Nred-1,j);
01032       <span class="keywordflow">else</span>
01033         g(i,j) = g(0,j);
01034     }
01035 
01036 }
01037 
01038 
01039 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Jul 29 15:56:33 2004 for OpenSim by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.6 </small></address>
</body>
</html>
