<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>OpenSim: robot/sim/VisualIKORTest.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>robot/sim/VisualIKORTest.cpp</h1><a href="VisualIKORTest_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/****************************************************************************</span>
00002 <span class="comment">  Copyright (C)2003 David Jung &lt;opensim@pobox.com&gt;</span>
00003 <span class="comment"></span>
00004 <span class="comment">  This program/file is free software; you can redistribute it and/or modify</span>
00005 <span class="comment">  it under the terms of the GNU General Public License as published by</span>
00006 <span class="comment">  the Free Software Foundation; either version 2 of the License, or</span>
00007 <span class="comment">  (at your option) any later version.</span>
00008 <span class="comment">  </span>
00009 <span class="comment">  This program is distributed in the hope that it will be useful,</span>
00010 <span class="comment">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00011 <span class="comment">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00012 <span class="comment">  GNU General Public License for more details. (http://www.gnu.org)</span>
00013 <span class="comment">  </span>
00014 <span class="comment">  You should have received a copy of the GNU General Public License</span>
00015 <span class="comment">  along with this program; if not, write to the Free Software</span>
00016 <span class="comment">  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
00017 <span class="comment">  </span>
00018 <span class="comment">  $Id: VisualIKORTest.cpp 1033 2004-02-11 20:47:52Z jungd $</span>
00019 <span class="comment">  $Revision: 1.7 $</span>
00020 <span class="comment">  $Date: 2004-02-11 15:47:52 -0500 (Wed, 11 Feb 2004) $</span>
00021 <span class="comment">  $Author: jungd $</span>
00022 <span class="comment"> </span>
00023 <span class="comment">****************************************************************************/</span>
00024 
00025 <span class="preprocessor">#include &lt;<a class="code" href="VisualIKORTest.html">robot/sim/VisualIKORTest</a>&gt;</span>
00026 
00027 <span class="preprocessor">#include &lt;<a class="code" href="Externalizer.html">base/Externalizer</a>&gt;</span>
00028 <span class="preprocessor">#include &lt;<a class="code" href="externalization__error.html">base/externalization_error</a>&gt;</span>
00029 <span class="preprocessor">#include &lt;<a class="code" href="Expression.html">base/Expression</a>&gt;</span>
00030 <span class="preprocessor">#include &lt;<a class="code" href="Matrix.html">base/Matrix</a>&gt;</span>
00031 <span class="preprocessor">#include &lt;<a class="code" href="VDirectory.html">base/VDirectory</a>&gt;</span>
00032 <span class="preprocessor">#include &lt;<a class="code" href="VFile.html">base/VFile</a>&gt;</span>
00033 
00034 <span class="preprocessor">#include &lt;osg/Group&gt;</span>
00035 <span class="preprocessor">#include &lt;osg/Switch&gt;</span>
00036 <span class="preprocessor">#include &lt;osg/Geode&gt;</span>
00037 <span class="preprocessor">#include &lt;osg/Geometry&gt;</span>
00038 <span class="preprocessor">#include &lt;osgText/Font&gt;</span>
00039 <span class="preprocessor">#include &lt;osgText/Text&gt;</span>
00040 
00041 
00042 <span class="keyword">using</span> <a class="code" href="classrobot_1_1sim_1_1VisualIKORTest.html">robot::sim::VisualIKORTest</a>;
00043 
00044 <span class="keyword">using</span> <a class="code" href="classbase_1_1vector.html">base::Vector</a>;
00045 <span class="keyword">using</span> <a class="code" href="classbase_1_1Orient.html">base::Orient</a>;
00046 <span class="keyword">using</span> <a class="code" href="classbase_1_1Time.html">base::Time</a>;
00047 <span class="keyword">using</span> <a class="code" href="classbase_1_1PathName.html">base::PathName</a>;
00048 <span class="keyword">using</span> <a class="code" href="classbase_1_1VFile.html">base::VFile</a>;
00049 <span class="keyword">using</span> <a class="code" href="classbase_1_1VDirectory.html">base::VDirectory</a>;
00050 <span class="keyword">using</span> <a class="code" href="classbase_1_1externalization__error.html">base::externalization_error</a>;
00051 <span class="keyword">using</span> <a class="code" href="classbase_1_1Path.html">base::Path</a>;
00052 <span class="keyword">using</span> <a class="code" href="classbase_1_1Trajectory.html">base::Trajectory</a>;
00053 <span class="keyword">using</span> base::dom::DOMNode;
00054 <span class="keyword">using</span> base::dom::DOMElement;
00055 <span class="keyword">using</span> <a class="code" href="classgfx_1_1Segment3.html">gfx::Segment3</a>;
00056 <span class="keyword">using</span> <a class="code" href="classgfx_1_1Color4.html">gfx::Color4</a>;
00057 <span class="keyword">using</span> <a class="code" href="classrobot_1_1sim_1_1IKORTest.html">robot::sim::IKORTest</a>;
00058 <span class="keyword">using</span> <a class="code" href="classrobot_1_1sim_1_1BasicEnvironment.html">robot::sim::BasicEnvironment</a>;
00059 <span class="keyword">using</span> <a class="code" href="classrobot_1_1control_1_1kinematics_1_1FullSpaceSolver.html">robot::control::kinematics::FullSpaceSolver</a>;
00060 <span class="keyword">using</span> <a class="code" href="classrobot_1_1control_1_1kinematics_1_1InverseKinematicsSolver.html">robot::control::kinematics::InverseKinematicsSolver</a>;
00061 <span class="keyword">using</span> <a class="code" href="classrobot_1_1control_1_1kinematics_1_1FullSpaceSolver.html">robot::control::kinematics::FullSpaceSolver</a>;
00062 <span class="keyword">using</span> <a class="code" href="classrobot_1_1control_1_1kinematics_1_1IKOR.html">robot::control::kinematics::IKOR</a>;
00063 
00064 
00065 
00066 
00067 
00068 VisualIKORTest::VisualIKORTest(ref&lt;base::VFile&gt; testSpecification,
00069                                ref&lt;base::VFileSystem&gt; fs, ref&lt;base::Cache&gt; cache)
00070   : IKORTest(testSpecification, fs, cache)
00071 {
00072 }
00073 
00074 
00075 
00076 osg::Vec3Array* VisualIKORTest::newVertexArrayFromLines(<span class="keyword">const</span> VisualIKORTest::LineSegArray&amp; lines)
00077 {
00078   osg::Vec3Array&amp; v(*NewObj osg::Vec3Array(lines.size()*2));
00079   <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;lines.size(); i++) {
00080     <span class="keyword">const</span> <a class="code" href="namespacebase.html#a26">Point3</a>&amp; s(lines[i].s);
00081     <span class="keyword">const</span> <a class="code" href="namespacebase.html#a26">Point3</a>&amp; e(lines[i].e);
00082     v[2*i].set(s.x,s.y,s.z);
00083     v[2*i+1].set(e.x,e.y,e.z);
00084   }
00085   <span class="keywordflow">return</span> &amp;v;
00086 }
00087 
00088 
00089 osg::Geometry* VisualIKORTest::newGeometryFromLines(<span class="keyword">const</span> VisualIKORTest::LineSegArray&amp; lines, <span class="keyword">const</span> <a class="code" href="classgfx_1_1Color4.html">gfx::Color4</a>&amp; color)
00090 {
00091   osg::Geometry* linesGeom = <span class="keyword">new</span> osg::Geometry();
00092   osg::Vec3Array* verts(<a class="code" href="classrobot_1_1sim_1_1VisualIKORTest.html#robot_1_1sim_1_1VisualIKORTestf4">newVertexArrayFromLines</a>(lines));
00093   linesGeom-&gt;setVertexArray(verts);
00094   osg::Vec4Array&amp; colora(*<span class="keyword">new</span> osg::Vec4Array(1));
00095   colora[0].set(color.<a class="code" href="classgfx_1_1Color4.html#gfx_1_1Color4o0">r</a>, color.<a class="code" href="classgfx_1_1Color4.html#gfx_1_1Color4o1">g</a>, color.<a class="code" href="classgfx_1_1Color4.html#gfx_1_1Color4o2">b</a>, color.<a class="code" href="classgfx_1_1Color4.html#gfx_1_1Color4o3">a</a>);
00096   linesGeom-&gt;setColorArray(&amp;colora);
00097   linesGeom-&gt;setColorBinding(osg::Geometry::BIND_OVERALL);
00098   linesGeom-&gt;addPrimitiveSet(<span class="keyword">new</span> osg::DrawArrays(osg::PrimitiveSet::LINES,0,lines.size()*2));
00099   <span class="keywordflow">return</span> linesGeom;
00100 }
00101 
00102 
00103 
00104 VisualIKORTest::LineSegArray VisualIKORTest::manipToolAsLines(<span class="keyword">const</span> KinematicChain&amp; chain, <span class="keyword">const</span> <a class="code" href="classdemeter_1_1Vector.html">Vector</a>&amp; q, Int numPlatformLinks)
00105 {
00106   <span class="comment">// create lines between each pair of link origins, except those for the platform</span>
00107   <a class="code" href="classrobot_1_1sim_1_1VisualIKORTest.html#robot_1_1sim_1_1VisualIKORTestx0">LineSegArray</a> lines;
00108 <span class="comment">//Debugcln(DJ,"q=" &lt;&lt; q &lt;&lt; "(chain size=" &lt;&lt; chain.size() &lt;&lt; ")" &lt;&lt; std::flush);</span>
00109 
00110   array&lt;Vector&gt; links( chain.getLinkOrigins(q) );
00111   <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> l=numPlatformLinks+1; l&lt;links.size(); l++) {
00112     <span class="keyword">const</span> <a class="code" href="classdemeter_1_1Vector.html">Vector</a>&amp; plink(links[l-1]);
00113     <span class="keyword">const</span> <a class="code" href="classdemeter_1_1Vector.html">Vector</a>&amp; link( links[l]);
00114     lines.push_back(<a class="code" href="classgfx_1_1Segment3.html">Segment3</a>(<a class="code" href="namespacebase.html#a26">Point3</a>(plink[0],plink[1],plink[2]), <a class="code" href="namespacebase.html#a26">Point3</a>(link[0],link[1],link[2])));
00115     <span class="comment">// debug!!!!</span>
00116     lines.push_back(<a class="code" href="classgfx_1_1Segment3.html">Segment3</a>(<a class="code" href="namespacebase.html#a26">Point3</a>(link[0],link[1],link[2]), <a class="code" href="namespacebase.html#a26">Point3</a>(link[0],link[1],link[2]+0.05)));
00117   }
00118   
00119   <span class="keywordflow">return</span> lines;
00120 }
00121 
00122 
00123 VisualIKORTest::LineSegArray VisualIKORTest::platformAsLines(ref&lt;const PlatformDescription&gt; platfDescr, 
00124                                                              <span class="keyword">const</span> KinematicChain&amp; platfChain, 
00125                                                              <span class="keyword">const</span> <a class="code" href="classdemeter_1_1Vector.html">Vector</a>&amp; q, Real steerAngle)
00126 {
00127   <span class="comment">// draw the platform as a square with line-seg wheels </span>
00128   <a class="code" href="classrobot_1_1sim_1_1VisualIKORTest.html#robot_1_1sim_1_1VisualIKORTestx0">LineSegArray</a> lines;
00129 
00130   <span class="keyword">const</span> <a class="code" href="classbase_1_1Vector3.html">base::Dimension3</a> dim(platfDescr-&gt;dimensions());
00131   Vector3 offset(platfDescr-&gt;originOffset());
00132   
00133   Vector3 c1(-dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o0">x</a>/2.0, -dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o1">y</a>/2.0, 0), c2(-dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o0">x</a>/2.0, dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o1">y</a>/2.0, 0),  <span class="comment">// corners</span>
00134           c3(dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o0">x</a>/2.0, dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o1">y</a>/2.0, 0), c4(dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o0">x</a>/2.0, -dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o1">y</a>/2.0, 0);
00135   c1-=offset; c2-=offset; c3-=offset; c4-=offset;
00136 
00137   <a class="code" href="classdemeter_1_1Vector.html">Vector</a> pf_q;
00138   <span class="keywordflow">if</span> (platfChain.dof() &gt; 0) pf_q = <a class="code" href="namespacebase.html#a205">vectorRange</a>(q,<a class="code" href="namespacebase.html#a30">Range</a>(0,platfChain.dof()));
00139   Matrix4 pT(base::toMatrix4(platfChain.getForwardKinematics(pf_q)));
00140   c1 = pT*c1; c2 = pT*c2; c3 = pT*c3; c4 = pT*c4; <span class="comment">// transform to world frame</span>
00141   
00142   lines.push_back(<a class="code" href="classgfx_1_1Segment3.html">Segment3</a>(c1,c2));
00143   lines.push_back(<a class="code" href="classgfx_1_1Segment3.html">Segment3</a>(c2,c3));
00144   lines.push_back(<a class="code" href="classgfx_1_1Segment3.html">Segment3</a>(c3,c4));
00145   lines.push_back(<a class="code" href="classgfx_1_1Segment3.html">Segment3</a>(c4,c1));
00146 <span class="comment">/*</span>
00147 <span class="comment">  // the wheels</span>
00148 <span class="comment">  const Real d = 0.4; // wheel diameter (length of 2D proj)</span>
00149 <span class="comment">  const Real L = platfDescr.L();</span>
00150 <span class="comment">  const Real W = platfDescr.W();</span>
00151 <span class="comment">  </span>
00152 <span class="comment">  // back</span>
00153 <span class="comment">  Vector3 bwlb(-L-d/2.0, 0.8*(dim.y/2.0), -offset.z);  // back wheel left back point</span>
00154 <span class="comment">  Vector3 bwlf(-L+d/2.0, 0.8*(dim.y/2.0), -offset.z);</span>
00155 <span class="comment">  Vector3 bwrb(-L-d/2.0, 0.8*(-dim.y/2.0), -offset.z);</span>
00156 <span class="comment">  Vector3 bwrf(-L+d/2.0, 0.8*(-dim.y/2.0), -offset.z);</span>
00157 <span class="comment">  </span>
00158 <span class="comment">  bwlb = pT*bwlb; bwlf = pT*bwlf; bwrb = pT*bwrb; bwrf = pT*bwrf; // to world</span>
00159 <span class="comment">  lines.push_back(Segment3(bwlb,bwlf));</span>
00160 <span class="comment">  lines.push_back(Segment3(bwrb,bwrf));</span>
00161 <span class="comment"></span>
00162 <span class="comment"></span>
00163 <span class="comment">  // front</span>
00164 <span class="comment">  Real dx = (d/2.0)*cos(steerAngle);</span>
00165 <span class="comment">  Real dy = (d/2.0)*sin(steerAngle);</span>
00166 <span class="comment">  Vector3 fwlb(-L+W-dx, 0.8*(dim.y/2.0)+dy, -offset.z); // front wheel left back point</span>
00167 <span class="comment">  Vector3 fwlf(-L+W+dx, 0.8*(dim.y/2.0)-dy, -offset.z);</span>
00168 <span class="comment">  Vector3 fwrb(-L+W-dx, 0.8*(-dim.y/2.0)+dy, -offset.z);</span>
00169 <span class="comment">  Vector3 fwrf(-L+W+dx, 0.8*(-dim.y/2.0)-dy, -offset.z);</span>
00170 <span class="comment"></span>
00171 <span class="comment">  fwlb = pT*fwlb; fwlf = pT*fwlf; fwrb = pT*fwrb; fwrf = pT*fwrf; // to world</span>
00172 <span class="comment">  lines.push_back(Segment3(fwlb,fwlf));</span>
00173 <span class="comment">  lines.push_back(Segment3(fwrb,fwrf));</span>
00174 <span class="comment">*/</span>
00175   
00176   <span class="keywordflow">return</span> lines;
00177 }
00178 
00179 <span class="comment"></span>
00180 <span class="comment">/// helper to translate a segment</span>
00181 <span class="comment"></span><span class="keyword">static</span> <span class="keyword">inline</span> <a class="code" href="classgfx_1_1Segment3.html">gfx::Segment3</a> translate(<span class="keyword">const</span> <a class="code" href="classgfx_1_1Segment3.html">gfx::Segment3</a>&amp; s, <span class="keyword">const</span> <a class="code" href="classbase_1_1Vector3.html">base::Vector3</a>&amp; t) 
00182 {
00183   <a class="code" href="classgfx_1_1Segment3.html">gfx::Segment3</a> ts(s); ts.<a class="code" href="classgfx_1_1Segment3.html#gfx_1_1Segment3o0">s</a> += t; ts.<a class="code" href="classgfx_1_1Segment3.html#gfx_1_1Segment3o1">e</a> += t;
00184   <span class="keywordflow">return</span> ts;
00185 }
00186 
00187 
00188 VisualIKORTest::LineSegArray VisualIKORTest::obstaclesAsLines(ref&lt;const BasicEnvironment&gt; env)
00189 {
00190   <a class="code" href="classrobot_1_1sim_1_1VisualIKORTest.html#robot_1_1sim_1_1VisualIKORTestx0">LineSegArray</a> lines;
00191 
00192   <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;env-&gt;numObstacles(); i++) {
00193     ref&lt;const BasicEnvironment::Obstacle&gt; obst(env-&gt;getObstacle(i));
00194     
00195     <span class="keywordflow">switch</span> (obst-&gt;type) {
00196 
00197     <span class="keywordflow">case</span> BasicEnvironment::Obstacle::BoxObstacle: {
00198       <span class="keyword">const</span> <a class="code" href="classbase_1_1Vector3.html">base::Dimension3</a>&amp; dim(obst-&gt;dims);
00199       Vector3 c1(-dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o0">x</a>/2.0, -dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o1">y</a>/2.0, -dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o2">z</a>/2.0), c2(-dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o0">x</a>/2.0, dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o1">y</a>/2.0, -dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o2">z</a>/2.0),  <span class="comment">// corners</span>
00200               c3(dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o0">x</a>/2.0, dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o1">y</a>/2.0, -dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o2">z</a>/2.0), c4(dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o0">x</a>/2.0, -dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o1">y</a>/2.0, -dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o2">z</a>/2.0);
00201       Vector3 c5(-dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o0">x</a>/2.0, -dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o1">y</a>/2.0, dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o2">z</a>/2.0), c6(-dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o0">x</a>/2.0, dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o1">y</a>/2.0, dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o2">z</a>/2.0),  
00202               c7(dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o0">x</a>/2.0, dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o1">y</a>/2.0, dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o2">z</a>/2.0), c8(dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o0">x</a>/2.0, -dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o1">y</a>/2.0, dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o2">z</a>/2.0);
00203               
00204       <span class="comment">// transform</span>
00205       Matrix4 T( obst-&gt;orientation.getRotationMatrix3() );
00206       T.setTranslationComponent( obst-&gt;position );
00207       c1 = T*c1; c2 = T*c2; c3 = T*c3; c4 = T*c4;
00208       c5 = T*c5; c6 = T*c6; c7 = T*c7; c8 = T*c8;
00209               
00210       <span class="comment">// bottom</span>
00211       lines.push_back(<a class="code" href="classgfx_1_1Segment3.html">Segment3</a>(c1,c2));
00212       lines.push_back(<a class="code" href="classgfx_1_1Segment3.html">Segment3</a>(c2,c3));
00213       lines.push_back(<a class="code" href="classgfx_1_1Segment3.html">Segment3</a>(c3,c4));
00214       lines.push_back(<a class="code" href="classgfx_1_1Segment3.html">Segment3</a>(c4,c1));
00215       
00216       <span class="comment">// top</span>
00217       lines.push_back(<a class="code" href="classgfx_1_1Segment3.html">Segment3</a>(c5,c6));
00218       lines.push_back(<a class="code" href="classgfx_1_1Segment3.html">Segment3</a>(c6,c7));
00219       lines.push_back(<a class="code" href="classgfx_1_1Segment3.html">Segment3</a>(c7,c8));
00220       lines.push_back(<a class="code" href="classgfx_1_1Segment3.html">Segment3</a>(c8,c5));
00221       
00222       <span class="comment">// sides</span>
00223       lines.push_back(<a class="code" href="classgfx_1_1Segment3.html">Segment3</a>(c1,c5));
00224       lines.push_back(<a class="code" href="classgfx_1_1Segment3.html">Segment3</a>(c2,c6));
00225       lines.push_back(<a class="code" href="classgfx_1_1Segment3.html">Segment3</a>(c3,c7));
00226       lines.push_back(<a class="code" href="classgfx_1_1Segment3.html">Segment3</a>(c4,c8));
00227     } <span class="keywordflow">break</span>;
00228     
00229     <span class="keywordflow">case</span> BasicEnvironment::Obstacle::SphereObstacle: {
00230       <span class="comment">// compute segments for 6 circles; 3 in each of the xy, yz and xz planes &amp; 3 rotated</span>
00231       Transform rot(Orient(consts::Pi/4.0, consts::Pi/4.0, 0)); <span class="comment">// roll 45, pitch 45</span>
00232       
00233       <a class="code" href="namespacebase.html#a5">Real</a> r = obst-&gt;radius;
00234       <a class="code" href="namespacebase.html#a26">Point3</a> c = obst-&gt;position;
00235       <a class="code" href="namespacebase.html#a5">Real</a> inc = consts::Pi/32.0;
00236       <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a5">Real</a> a=inc; a&lt;=2*consts::Pi; a+=inc) {
00237         <a class="code" href="namespacebase.html#a5">Real</a> c1 = r*<a class="code" href="namespacebase.html#a65">cos</a>(a-inc);
00238         <a class="code" href="namespacebase.html#a5">Real</a> s1 = r*<a class="code" href="namespacebase.html#a64">sin</a>(a-inc);
00239         <a class="code" href="namespacebase.html#a5">Real</a> c2 = r*<a class="code" href="namespacebase.html#a65">cos</a>(a);
00240         <a class="code" href="namespacebase.html#a5">Real</a> s2 = r*<a class="code" href="namespacebase.html#a64">sin</a>(a);
00241         
00242         <a class="code" href="namespacebase.html#a26">Point3</a> xy1( c1, s1, 0); 
00243         <a class="code" href="namespacebase.html#a26">Point3</a> xy2( c2, s2, 0); 
00244         <a class="code" href="classgfx_1_1Segment3.html">Segment3</a> xy(xy1, xy2);
00245         lines.push_back(translate(xy,c));
00246         xy.<a class="code" href="classgfx_1_1Segment3.html#gfx_1_1Segment3a13">transform</a>(rot);
00247         lines.push_back(translate(xy,c));
00248         <a class="code" href="namespacebase.html#a26">Point3</a> yz1( 0, c1, s1); 
00249         <a class="code" href="namespacebase.html#a26">Point3</a> yz2( 0, c2, s2); 
00250         <a class="code" href="classgfx_1_1Segment3.html">Segment3</a> yz(yz1, yz2);
00251         lines.push_back(translate(yz,c));
00252         yz.<a class="code" href="classgfx_1_1Segment3.html#gfx_1_1Segment3a13">transform</a>(rot);
00253         lines.push_back(translate(yz,c));
00254         <a class="code" href="namespacebase.html#a26">Point3</a> xz1( c1, 0, s1); 
00255         <a class="code" href="namespacebase.html#a26">Point3</a> xz2( c2, 0, s2); 
00256         <a class="code" href="classgfx_1_1Segment3.html">Segment3</a> xz(xz1,xz2);
00257         lines.push_back(translate(xz,c));
00258         xz.<a class="code" href="classgfx_1_1Segment3.html#gfx_1_1Segment3a13">transform</a>(rot);
00259         lines.push_back(translate(xz,c));
00260          
00261       }
00262             
00263     } <span class="keywordflow">break</span>;
00264     
00265     <span class="keywordflow">default</span>:
00266       <a class="code" href="base.html#a7">Logfln</a>(<span class="stringliteral">"warning: unknown obstacle type ("</span> &lt;&lt; obst-&gt;type &lt;&lt; <span class="stringliteral">") not displayed"</span>);
00267     }
00268     
00269   }
00270   
00271   <span class="keywordflow">return</span> lines;
00272 }
00273 
00274   
00275   
00276 VisualIKORTest::LineSegArray VisualIKORTest::trajectoryAsLines(<span class="keyword">const</span> array&lt;base::Vector&gt;&amp; xs)
00277 {
00278   <a class="code" href="classrobot_1_1sim_1_1VisualIKORTest.html#robot_1_1sim_1_1VisualIKORTestx0">LineSegArray</a> lines;
00279 
00280   <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;xs.size()-1; i++) {
00281     <span class="keyword">const</span> <a class="code" href="classdemeter_1_1Vector.html">Vector</a>&amp; xi(xs[i]);
00282     <span class="keyword">const</span> <a class="code" href="classdemeter_1_1Vector.html">Vector</a>&amp; xip1(xs[i+1]);
00283     lines.push_back(<a class="code" href="classgfx_1_1Segment3.html">Segment3</a>(<a class="code" href="namespacebase.html#a26">Point3</a>(xi[0],xi[1],xi[2]), <a class="code" href="namespacebase.html#a26">Point3</a>(xip1[0],xip1[1],xip1[2])));
00284   }
00285   
00286   <span class="keywordflow">return</span> lines;
00287 }
00288 
00289   
00290   
00291   
00292 osg::Node* VisualIKORTest::createOSGVisual(Attributes visualAttributes)<span class="keyword"> const</span>
00293 <span class="keyword"></span>{
00294   <span class="keywordflow">if</span> ((<a class="code" href="classrobot_1_1sim_1_1VisualIKORTest.html#robot_1_1sim_1_1VisualIKORTestp1">node</a>!=0) &amp;&amp; (<a class="code" href="classrobot_1_1sim_1_1VisualIKORTest.html#robot_1_1sim_1_1VisualIKORTestp0">attributes</a>==visualAttributes))
00295     <span class="keywordflow">return</span> &amp;(*node);
00296   
00297   osg::Switch* worldNode = <span class="keyword">new</span> osg::Switch();
00298   worldNode-&gt;addChild( <a class="code" href="classrobot_1_1sim_1_1VisualIKORTest.html#robot_1_1sim_1_1VisualIKORTestb1">osgCreateObstacles</a>() );
00299   worldNode-&gt;addChild( <a class="code" href="classrobot_1_1sim_1_1VisualIKORTest.html#robot_1_1sim_1_1VisualIKORTestb0">osgCreateAxes</a>() );
00300   worldNode-&gt;addChild( <a class="code" href="classrobot_1_1sim_1_1VisualIKORTest.html#robot_1_1sim_1_1VisualIKORTestb3">osgCreateTrajectory</a>() );
00301 
00302   worldNode-&gt;addChild( <a class="code" href="classrobot_1_1sim_1_1VisualIKORTest.html#robot_1_1sim_1_1VisualIKORTestb2">osgCreateManipulator</a>() );
00303   
00304   worldNode-&gt;setAllChildrenOn();
00305   worldNode-&gt;setValue(0,displayObstacles);
00306   worldNode-&gt;setValue(1,displayAxes);
00307   worldNode-&gt;setValue(2,displayEEPath);
00308   
00309   worldNode-&gt;getOrCreateStateSet()-&gt;setMode(GL_LIGHTING,osg::StateAttribute::OFF);
00310 
00311   <a class="code" href="classrobot_1_1sim_1_1VisualIKORTest.html#robot_1_1sim_1_1VisualIKORTestp1">node</a> = worldNode;
00312   <span class="keywordflow">return</span> &amp;(*node);
00313 }
00314 
00315 
00316 
00317 osg::Node*  VisualIKORTest::osgCreateAxes()<span class="keyword"> const</span>
00318 <span class="keyword"></span>{
00319   <span class="keyword">const</span> <a class="code" href="namespacebase.html#a5">Real</a> l = 1.0; <span class="comment">// axis length</span>
00320   <span class="keyword">const</span> <a class="code" href="namespacebase.html#a5">Real</a> charSize = 0.2;
00321   osg::Vec4 labelCol(0,0,0,1);
00322   
00323   osg::Geode* geode = <span class="keyword">new</span> osg::Geode();
00324 
00325   <a class="code" href="classrobot_1_1sim_1_1VisualIKORTest.html#robot_1_1sim_1_1VisualIKORTestx0">LineSegArray</a> axes;
00326   axes.push_back(Vector3(l,0,0));
00327   axes.push_back(Vector3(0,l,0));
00328   axes.push_back(Vector3(0,0,l));
00329   osg::Geometry* linesGeom = <a class="code" href="classrobot_1_1sim_1_1VisualIKORTest.html#robot_1_1sim_1_1VisualIKORTestf5">newGeometryFromLines</a>(axes, <a class="code" href="classgfx_1_1Color4.html">Color4</a>(0.5,0.5,0.5));
00330   geode-&gt;addDrawable(linesGeom);
00331 
00332   <span class="comment">// labels</span>
00333   <a class="code" href="namespacebase.html#a4">String</a> font(<span class="stringliteral">"fonts/times.ttf"</span>);
00334 
00335   osgText::Text* xtext = <span class="keyword">new</span> osgText::Text;
00336   xtext-&gt;setFont(font);
00337   xtext-&gt;setCharacterSize(charSize);
00338   xtext-&gt;setFontSize(20,20);
00339   xtext-&gt;setColor(labelCol);
00340   xtext-&gt;setPosition(osg::Vec3(1.05,0,0));
00341   xtext-&gt;setAxisAlignment(osgText::Text::SCREEN);
00342   xtext-&gt;setText(<span class="stringliteral">"X"</span>);
00343   geode-&gt;addDrawable(xtext);
00344 
00345   osgText::Text* ytext = <span class="keyword">new</span> osgText::Text;
00346   ytext-&gt;setFont(font);
00347   ytext-&gt;setCharacterSize(charSize);
00348   ytext-&gt;setFontSize(20,20);
00349   ytext-&gt;setColor(labelCol);
00350   ytext-&gt;setPosition(osg::Vec3(0,1.05,0));
00351   ytext-&gt;setAxisAlignment(osgText::Text::SCREEN);
00352   ytext-&gt;setText(<span class="stringliteral">"Y"</span>);
00353   geode-&gt;addDrawable(ytext);
00354 
00355   osgText::Text* ztext = <span class="keyword">new</span> osgText::Text;
00356   ztext-&gt;setFont(font);
00357   ztext-&gt;setCharacterSize(charSize);
00358   ztext-&gt;setFontSize(20,20);
00359   ztext-&gt;setColor(labelCol);
00360   ztext-&gt;setPosition(osg::Vec3(0,0,1.05));
00361   ztext-&gt;setAxisAlignment(osgText::Text::SCREEN);
00362   ztext-&gt;setText(<span class="stringliteral">"Z"</span>);
00363   geode-&gt;addDrawable(ztext);
00364   
00365   <span class="keywordflow">return</span> geode;
00366 }
00367 
00368 
00369 osg::Node* VisualIKORTest::osgCreateObstacles()<span class="keyword"> const</span>
00370 <span class="keyword"></span>{
00371   osg::Geode* geode = <span class="keyword">new</span> osg::Geode();
00372   geode-&gt;addDrawable( <a class="code" href="classrobot_1_1sim_1_1VisualIKORTest.html#robot_1_1sim_1_1VisualIKORTestf5">newGeometryFromLines</a>(<a class="code" href="classrobot_1_1sim_1_1VisualIKORTest.html#robot_1_1sim_1_1VisualIKORTestf2">obstaclesAsLines</a>(env),<a class="code" href="classgfx_1_1Color4.html">Color4</a>(0.3,0.3,0.9)) );
00373   <span class="keywordflow">return</span> geode;
00374 }     
00375       
00376 
00377 osg::Node* VisualIKORTest::osgCreateManipulator()<span class="keyword"> const</span>
00378 <span class="keyword"></span>{
00379   ref&lt;const BasicEnvironment&gt; <a class="code" href="classrobot_1_1sim_1_1IKORTest.html#robot_1_1sim_1_1VisualIKORTestp7">env</a>(<a class="code" href="classrobot_1_1sim_1_1IKORTest.html#robot_1_1sim_1_1VisualIKORTesta7">getEnvironment</a>());
00380   ref&lt;const SimulatedRobot&gt; <a class="code" href="robot_2Jamfile_8ft.html#a0">robot</a>( narrow_ref&lt;const SimulatedRobot&gt;(<a class="code" href="classrobot_1_1sim_1_1IKORTest.html#robot_1_1sim_1_1VisualIKORTesta10">getRobot</a>()) );
00381   <a class="code" href="namespacebase.html#a2">Int</a> <a class="code" href="classrobot_1_1sim_1_1IKORTest.html#robot_1_1sim_1_1VisualIKORTestp9">testManipulatorIndex</a> = <a class="code" href="classrobot_1_1sim_1_1IKORTest.html#robot_1_1sim_1_1VisualIKORTesta12">getManipulatorIndex</a>();
00382   
00383   ref&lt;const RobotDescription&gt; robotDescr(<a class="code" href="robot_2Jamfile_8ft.html#a0">robot</a>-&gt;getRobotDescription());
00384   ref&lt;const PlatformDescription&gt; platfDescr(robotDescr-&gt;platform() );
00385 
00386   Matrix4 platformTransform( <a class="code" href="robot_2Jamfile_8ft.html#a0">robot</a>-&gt;getOrientation().getRotationMatrix3() );
00387   platformTransform.setTranslationComponent( <a class="code" href="robot_2Jamfile_8ft.html#a0">robot</a>-&gt;getPosition() );
00388 
00389   KinematicChain robotChain(robotDescr-&gt;getKinematicChain(3,platformTransform,testManipulatorIndex,0));
00390   KinematicChain platfChain(platfDescr-&gt;getKinematicChain(3,platformTransform));
00391   <a class="code" href="namespacebase.html#a2">Int</a> numPlatfLinks = platfChain.size();
00392 
00393   <span class="comment">// make each test a seperate child in a Group</span>
00394   osg::Group* testsGroup = <span class="keyword">new</span> osg::Group();
00395 
00396   <a class="code" href="namespacebase.html#a2">Int</a> stepCount=0;  
00397   <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> t=0; t&lt;<a class="code" href="classrobot_1_1sim_1_1IKORTest.html#robot_1_1sim_1_1VisualIKORTestp10">tests</a>.size(); t++) { <span class="comment">// for each test</span>
00398     <span class="keyword">const</span> Test&amp; test(tests[t]);
00399     
00400     KinematicChain chain(robotChain); <span class="comment">// kinematic chain from world frame to manip/tool end-effector</span>
00401 
00402     <span class="comment">// locate tool</span>
00403     <span class="keywordtype">bool</span> toolAttached = <span class="keyword">false</span>;
00404     <span class="keywordflow">if</span> (test.toolAttached) {
00405       <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; (i&lt;env-&gt;numTools()) &amp;&amp; !toolAttached; i++) {
00406         ref&lt;const ToolDescription&gt; td( env-&gt;getTool(i)-&gt;getToolDescription() );
00407         
00408         <span class="keywordflow">if</span> (td-&gt;getName() == test.toolName) {
00409           toolAttached = <span class="keyword">true</span>;
00410           KinematicChain toolChain( td-&gt;getKinematicChain() );
00411           chain += toolChain;
00412         }
00413       }
00414     }
00415     
00416     <span class="comment">// create a Switch with each test joint space state of the manipulator represented as a child</span>
00417     <span class="comment">//  and platform (independently)</span>
00418     osg::Switch* testPlatfSwitch = <span class="keyword">new</span> osg::Switch();
00419     osg::Switch* testManipSwitch = <span class="keyword">new</span> osg::Switch();
00420     
00421     <a class="code" href="classdemeter_1_1Vector.html">Vector</a> pf_prevq(platfChain.dof());
00422     <a class="code" href="classdemeter_1_1Vector.html">Vector</a> pf_q(platfChain.dof());
00423     
00424     <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;test.qs.size(); i++) {
00425       <span class="keyword">const</span> <a class="code" href="classdemeter_1_1Vector.html">Vector</a>&amp; q( test.qs[i] );
00426       
00427       osg::Geode* platfGeode = <span class="keyword">new</span> osg::Geode();
00428       osg::Geode* manipGeode = <span class="keyword">new</span> osg::Geode();
00429 
00430       pf_prevq = pf_q;
00431       pf_q = <a class="code" href="namespacebase.html#a205">vectorRange</a>(q, <a class="code" href="namespacebase.html#a30">Range</a>(0, platfChain.dof()) );
00432       <span class="keywordflow">if</span>(i==0) pf_prevq = pf_q;
00433       
00434       <a class="code" href="namespacebase.html#a5">Real</a> steerAngle = platfDescr-&gt;requiredSteeringAngle(pf_prevq, pf_q);
00435       
00436       platfGeode-&gt;addDrawable( <a class="code" href="classrobot_1_1sim_1_1VisualIKORTest.html#robot_1_1sim_1_1VisualIKORTestf5">newGeometryFromLines</a>(<a class="code" href="classrobot_1_1sim_1_1VisualIKORTest.html#robot_1_1sim_1_1VisualIKORTestf1">platformAsLines</a>(platfDescr,platfChain,pf_q,steerAngle ),
00437                             <a class="code" href="classgfx_1_1Color4.html">Color4</a>(0.4,0.4,0.4)) );
00438 
00439       manipGeode-&gt;addDrawable( <a class="code" href="classrobot_1_1sim_1_1VisualIKORTest.html#robot_1_1sim_1_1VisualIKORTestf5">newGeometryFromLines</a>(<a class="code" href="classrobot_1_1sim_1_1VisualIKORTest.html#robot_1_1sim_1_1VisualIKORTestf0">manipToolAsLines</a>(chain,q,numPlatfLinks),<a class="code" href="classgfx_1_1Color4.html">Color4</a>(0.3,0.3,0.3)) );
00440 
00441       stepCount++;
00442       
00443       testPlatfSwitch-&gt;addChild(platfGeode);
00444       testManipSwitch-&gt;addChild(manipGeode);
00445       <span class="keywordflow">if</span> (test.displayRangeSpecified) {
00446         testPlatfSwitch-&gt;setValue(i, ((i &gt;= test.displayStartIndex) &amp;&amp; (i &lt; test.displayEndIndex) &amp;&amp; ((stepCount%displayStepMod) == 0) &amp;&amp; displayPlatform ) );
00447         testManipSwitch-&gt;setValue(i, ((i &gt;= test.displayStartIndex) &amp;&amp; (i &lt; test.displayEndIndex) &amp;&amp; ((stepCount%displayStepMod) == 0)  ) );
00448       }
00449       <span class="keywordflow">else</span> {
00450         testPlatfSwitch-&gt;setValue(i, ((stepCount%displayStepMod) == 0) &amp;&amp; displayPlatform );
00451         testManipSwitch-&gt;setValue(i, (stepCount%displayStepMod) == 0);
00452       }
00453     }
00454     
00455     <a class="code" href="classrobot_1_1sim_1_1VisualIKORTest.html#robot_1_1sim_1_1VisualIKORTestp2">testPlatfSwitches</a>.push_back( testPlatfSwitch );
00456     <a class="code" href="classrobot_1_1sim_1_1VisualIKORTest.html#robot_1_1sim_1_1VisualIKORTestp3">testManipSwitches</a>.push_back( testManipSwitch );
00457     testsGroup-&gt;addChild( testPlatfSwitch );
00458     testsGroup-&gt;addChild( testManipSwitch );
00459   }
00460 
00461   <span class="keywordflow">return</span> testsGroup;
00462 }
00463 
00464 
00465 osg::Node* VisualIKORTest::osgCreateTrajectory()<span class="keyword"> const</span>
00466 <span class="keyword"></span>{
00467   osg::Geode* geode = <span class="keyword">new</span> osg::Geode();
00468   
00469   <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> t=0; t&lt;<a class="code" href="classrobot_1_1sim_1_1IKORTest.html#robot_1_1sim_1_1VisualIKORTestp10">tests</a>.size(); t++) { <span class="comment">// for each test</span>
00470     <span class="keyword">const</span> Test&amp; test(tests[t]);
00471     geode-&gt;addDrawable( <a class="code" href="classrobot_1_1sim_1_1VisualIKORTest.html#robot_1_1sim_1_1VisualIKORTestf5">newGeometryFromLines</a>(<a class="code" href="classrobot_1_1sim_1_1VisualIKORTest.html#robot_1_1sim_1_1VisualIKORTestf3">trajectoryAsLines</a>(test.xs),<a class="code" href="classgfx_1_1Color4.html">Color4</a>(0.9,0.3,0.3)) );
00472   }
00473   <span class="keywordflow">return</span> geode;
00474 }     
00475 
00476   
00477 <span class="keywordtype">void</span> VisualIKORTest::updateVisuals()<span class="keyword"> const</span>
00478 <span class="keyword"></span>{
00479   <span class="keywordflow">if</span> ((<a class="code" href="classrobot_1_1sim_1_1VisualIKORTest.html#robot_1_1sim_1_1VisualIKORTestp1">node</a> == 0)  || (<a class="code" href="classrobot_1_1sim_1_1VisualIKORTest.html#robot_1_1sim_1_1VisualIKORTestp2">testPlatfSwitches</a>.size()==0)) <span class="keywordflow">return</span>;
00480   
00481   <a class="code" href="classrobot_1_1sim_1_1VisualIKORTest.html#robot_1_1sim_1_1VisualIKORTestp1">node</a>-&gt;setValue(0, displayObstacles);
00482   <a class="code" href="classrobot_1_1sim_1_1VisualIKORTest.html#robot_1_1sim_1_1VisualIKORTestp1">node</a>-&gt;setValue(1, displayAxes);
00483   <a class="code" href="classrobot_1_1sim_1_1VisualIKORTest.html#robot_1_1sim_1_1VisualIKORTestp1">node</a>-&gt;setValue(2, displayEEPath);
00484 
00485   <a class="code" href="namespacebase.html#a2">Int</a> stepCount=0;  
00486   <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> t=0; t&lt;<a class="code" href="classrobot_1_1sim_1_1IKORTest.html#robot_1_1sim_1_1VisualIKORTestp10">tests</a>.size(); t++) { <span class="comment">// for each test</span>
00487     <span class="keyword">const</span> Test&amp; test(tests[t]); 
00488   
00489     osg::Switch* testPlatfSwitch = &amp;(*<a class="code" href="classrobot_1_1sim_1_1VisualIKORTest.html#robot_1_1sim_1_1VisualIKORTestp2">testPlatfSwitches</a>[t]);
00490     osg::Switch* testManipSwitch = &amp;(*<a class="code" href="classrobot_1_1sim_1_1VisualIKORTest.html#robot_1_1sim_1_1VisualIKORTestp3">testManipSwitches</a>[t]);
00491     <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;test.times.size(); i++) {
00492       testPlatfSwitch-&gt;setValue(i, ((i &gt;= test.displayStartIndex) &amp;&amp; (i &lt; test.displayEndIndex) &amp;&amp; ((stepCount%displayStepMod)==0) &amp;&amp; displayPlatform ));
00493       testManipSwitch-&gt;setValue(i, ((i &gt;= test.displayStartIndex) &amp;&amp; (i &lt; test.displayEndIndex) &amp;&amp; ((stepCount%displayStepMod)==0) ));
00494       stepCount++;
00495     }
00496 
00497   }
00498   
00499 }
00500 
00501   
00502   
00503 <span class="keywordtype">void</span> VisualIKORTest::svgLine(<a class="code" href="classbase_1_1Externalizer.html">base::Externalizer</a>&amp; e, base::dom::DOMElement* svgElem, <span class="keyword">const</span> <a class="code" href="classgfx_1_1Segment3.html">gfx::Segment3</a>&amp; line)<span class="keyword"> const</span>
00504 <span class="keyword"></span>{
00505   <a class="code" href="namespacebase.html#a26">Point3</a> start(line.<a class="code" href="classgfx_1_1Segment3.html#gfx_1_1Segment3o0">s</a>);
00506   <a class="code" href="namespacebase.html#a26">Point3</a> end(line.<a class="code" href="classgfx_1_1Segment3.html#gfx_1_1Segment3o1">e</a>);
00507   start = <a class="code" href="classrobot_1_1sim_1_1VisualIKORTest.html#robot_1_1sim_1_1VisualIKORTestp4">svgTransform</a>*start;
00508   end = <a class="code" href="classrobot_1_1sim_1_1VisualIKORTest.html#robot_1_1sim_1_1VisualIKORTestp4">svgTransform</a>*end;
00509   
00510   DOMElement* lineElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"line"</span>);
00511   e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera26">setElementAttribute</a>(lineElem, <span class="stringliteral">"x1"</span>, base::realToString(start.x));
00512   e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera26">setElementAttribute</a>(lineElem, <span class="stringliteral">"y1"</span>, base::realToString(start.y));
00513   e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera26">setElementAttribute</a>(lineElem, <span class="stringliteral">"x2"</span>, base::realToString(end.x));
00514   e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera26">setElementAttribute</a>(lineElem, <span class="stringliteral">"y2"</span>, base::realToString(end.y));
00515   <span class="comment">//e.setElementAttribute(lineElem, "stroke", "stroke-width:0.5");</span>
00516   e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera34">appendNode</a>(svgElem, lineElem);
00517   
00518 }
00519 
00520 
00521 <span class="keywordtype">void</span> VisualIKORTest::svgLines(<a class="code" href="classbase_1_1Externalizer.html">base::Externalizer</a>&amp; e, base::dom::DOMElement* svgElem, <span class="keyword">const</span> LineSegArray&amp; lines)<span class="keyword"> const</span>
00522 <span class="keyword"></span>{
00523   <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> l=0; l&lt;lines.size(); l++)
00524     <a class="code" href="classrobot_1_1sim_1_1VisualIKORTest.html#robot_1_1sim_1_1VisualIKORTestb4">svgLine</a>(e, svgElem, lines[l]);
00525 }
00526 
00527 
00528 <span class="keywordtype">void</span> VisualIKORTest::svgText(<a class="code" href="classbase_1_1Externalizer.html">base::Externalizer</a>&amp; e, base::dom::DOMElement* svgElem, <span class="keyword">const</span> Point3&amp; pos, <span class="keyword">const</span> String&amp; text, Real size)<span class="keyword"> const</span>
00529 <span class="keyword"></span>{
00530   DOMElement* textElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"text"</span>);
00531   e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera26">setElementAttribute</a>(textElem, <span class="stringliteral">"x"</span>, base::realToString(pos.x));
00532   e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera26">setElementAttribute</a>(textElem, <span class="stringliteral">"y"</span>, base::realToString(pos.y));
00533   e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera26">setElementAttribute</a>(textElem, <span class="stringliteral">"style"</span>, <span class="stringliteral">"font-size:"</span>+base::realToString(size)
00534                                            +<span class="stringliteral">"; font-family:Arial, sans-serif"</span>);
00535   e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera29">appendText</a>(textElem, text);
00536   e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera34">appendNode</a>(svgElem, textElem);
00537 }
00538 
00539   
00540 
00541 <span class="keywordtype">void</span> VisualIKORTest::svgOutputAxes(<a class="code" href="classbase_1_1Externalizer.html">base::Externalizer</a>&amp; e, base::dom::DOMElement* svgElem)<span class="keyword"> const</span>
00542 <span class="keyword"></span>{
00543   <span class="keyword">const</span> <a class="code" href="namespacebase.html#a5">Real</a> l = 1.0; <span class="comment">// axis length</span>
00544   
00545   <a class="code" href="classrobot_1_1sim_1_1VisualIKORTest.html#robot_1_1sim_1_1VisualIKORTestx0">LineSegArray</a> axes;
00546   axes.push_back(Vector3(l,0,0));
00547   axes.push_back(Vector3(0,l,0));
00548   axes.push_back(Vector3(0,0,l));
00549 
00550   <a class="code" href="classrobot_1_1sim_1_1VisualIKORTest.html#robot_1_1sim_1_1VisualIKORTestb5">svgLines</a>(e, svgElem, axes);  
00551   
00552   <a class="code" href="classrobot_1_1sim_1_1VisualIKORTest.html#robot_1_1sim_1_1VisualIKORTestb6">svgText</a>(e, svgElem, <a class="code" href="namespacebase.html#a26">Point3</a>(1,0,0), <span class="stringliteral">"X"</span>);
00553   <a class="code" href="classrobot_1_1sim_1_1VisualIKORTest.html#robot_1_1sim_1_1VisualIKORTestb6">svgText</a>(e, svgElem, <a class="code" href="namespacebase.html#a26">Point3</a>(0,1,0), <span class="stringliteral">"Y"</span>);
00554   <a class="code" href="classrobot_1_1sim_1_1VisualIKORTest.html#robot_1_1sim_1_1VisualIKORTestb6">svgText</a>(e, svgElem, <a class="code" href="namespacebase.html#a26">Point3</a>(0,0,1), <span class="stringliteral">"Z"</span>);
00555 }
00556 
00557   
00558   
00559 
00560 <span class="keywordtype">void</span> VisualIKORTest::externalize(<a class="code" href="classbase_1_1Externalizer.html">base::Externalizer</a>&amp; e, String format, Real version)
00561 {
00562   <span class="keywordflow">if</span> (format == <span class="stringliteral">""</span>) format = <span class="stringliteral">"xml"</span>;
00563   
00564   <span class="keywordflow">if</span> (!<a class="code" href="classrobot_1_1sim_1_1VisualIKORTest.html#robot_1_1sim_1_1VisualIKORTesta5">formatSupported</a>(format,version,e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera6">ioType</a>()))
00565     <span class="keywordflow">throw</span> std::invalid_argument(<a class="code" href="base.html#a15">Exception</a>(<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"format "</span>)+format+<span class="stringliteral">" v"</span>+base::realToString(version)+<span class="stringliteral">" unsupported"</span>));
00566 
00567   <span class="keywordflow">if</span> (format == <span class="stringliteral">"xml"</span>) 
00568     IKORTest::externalize(e,format,version);
00569   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (format == <span class="stringliteral">"svg"</span>) {
00570 
00571     <span class="keywordflow">if</span> (e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera5">isInput</a>()) {
00572       <a class="code" href="debugtools.html#a12">Unimplemented</a>;
00573     }
00574     <span class="keywordflow">else</span> { <span class="comment">// output</span>
00575         
00576         <a class="code" href="classrobot_1_1sim_1_1VisualIKORTest.html#robot_1_1sim_1_1VisualIKORTestp4">svgTransform</a>.<a class="code" href="classbase_1_1Matrix4.html#base_1_1Matrix4a8">setIdentity</a>();
00577         
00578         <span class="comment">// must set type before first element is created (ignored if e is not a new output Externalizer)</span>
00579         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera17">setDocumentType</a>(<span class="stringliteral">"svg"</span>,<span class="stringliteral">"-//W3C//DTD SVG 20010904//EN"</span>,
00580                           <span class="stringliteral">"http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd"</span>);
00581 
00582         <span class="comment">// createElement must be called first, as it will create to document root element if e is a new output Externalizer</span>
00583         DOMElement* svgElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"svg"</span>);
00584         
00585         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera26">setElementAttribute</a>(svgElem, <span class="stringliteral">"xmlns"</span>, <span class="stringliteral">"http://www.w3.org/2000/svg"</span>);
00586         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera26">setElementAttribute</a>(svgElem, <span class="stringliteral">"width"</span>, <span class="stringliteral">"100%"</span>);
00587         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera26">setElementAttribute</a>(svgElem, <span class="stringliteral">"height"</span>, <span class="stringliteral">"100%"</span>);
00588         
00589         
00590         <a class="code" href="classrobot_1_1sim_1_1VisualIKORTest.html#robot_1_1sim_1_1VisualIKORTestb7">svgOutputAxes</a>(e, svgElem);
00591         
00592         
00593         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera21">appendElement</a>(svgElem);
00594         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera22">appendBreak</a>(svgElem);      
00595     
00596         
00597     }
00598     
00599   }
00600 
00601 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Jul 29 15:56:44 2004 for OpenSim by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.6 </small></address>
</body>
</html>
