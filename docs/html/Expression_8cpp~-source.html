<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>opensim/base/Expression.cpp~ Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.8.1 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>opensim/base/Expression.cpp~</h1><a href="Expression_8cpp~.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/****************************************************************************</font>
00002 <font class="comment">  Copyright (C)2002 David Jung &lt;djung@pobox.com&gt;</font>
00003 <font class="comment"></font>
00004 <font class="comment">  This program/file is free software; you can redistribute it and/or modify</font>
00005 <font class="comment">  it under the terms of the GNU General Public License as published by</font>
00006 <font class="comment">  the Free Software Foundation; either version 2 of the License, or</font>
00007 <font class="comment">  (at your option) any later version.</font>
00008 <font class="comment"></font>
00009 <font class="comment">  This program is distributed in the hope that it will be useful,</font>
00010 <font class="comment">  but WITHOUT ANY WARRANTY; without even the implied warranty of</font>
00011 <font class="comment">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</font>
00012 <font class="comment">  GNU General Public License for more details. (http://www.gnu.org)</font>
00013 <font class="comment"></font>
00014 <font class="comment">  You should have received a copy of the GNU General Public License</font>
00015 <font class="comment">  along with this program; if not, write to the Free Software</font>
00016 <font class="comment">  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</font>
00017 <font class="comment"></font>
00018 <font class="comment">  $Id: Expression.cpp,v 1.6 2002/07/26 23:00:39 knf Exp $</font>
00019 <font class="comment">  $Revision: 1.6 $</font>
00020 <font class="comment">  $Date: 2002/07/26 23:00:39 $</font>
00021 <font class="comment">  $Author: knf $</font>
00022 <font class="comment"></font>
00023 <font class="comment">****************************************************************************/</font>
00024 
00025 <font class="preprocessor">#include &lt;<a class="code" href="Expression.html">base/Expression</a>&gt;</font>
00026 
00027 <font class="preprocessor">#include &lt;<a class="code" href="ConstantExpression.html">base/ConstantExpression</a>&gt;</font>
00028 <font class="preprocessor">#include &lt;<a class="code" href="VariableExpression.html">base/VariableExpression</a>&gt;</font>
00029 <font class="preprocessor">#include &lt;<a class="code" href="SumExpression.html">base/SumExpression</a>&gt;</font>
00030 <font class="preprocessor">#include &lt;<a class="code" href="DifferenceExpression.html">base/DifferenceExpression</a>&gt;</font>
00031 <font class="preprocessor">#include &lt;<a class="code" href="NegateExpression.html">base/NegateExpression</a>&gt;</font>
00032 <font class="preprocessor">#include &lt;<a class="code" href="ProductExpression.html">base/ProductExpression</a>&gt;</font>
00033 <font class="preprocessor">#include &lt;<a class="code" href="QuotientExpression.html">base/QuotientExpression</a>&gt;</font>
00034 <font class="preprocessor">#include &lt;<a class="code" href="SinExpression.html">base/SinExpression</a>&gt;</font>
00035 <font class="preprocessor">#include &lt;<a class="code" href="CosExpression.html">base/CosExpression</a>&gt;</font>
00036 
00037 <font class="keyword">using</font> <a class="code" href="classbase_1_1Expression.html">base::Expression</a>;
00038 <font class="keyword">using</font> <a class="code" href="classbase_1_1ExpressionNode.html">base::ExpressionNode</a>;
00039 <font class="keyword">using</font> <a class="code" href="classbase_1_1ConstantExpression.html">base::ConstantExpression</a>;
00040 <font class="keyword">using</font> <a class="code" href="classbase_1_1VariableExpression.html">base::VariableExpression</a>;
00041 <font class="keyword">using</font> <a class="code" href="classbase_1_1SumExpression.html">base::SumExpression</a>;
00042 <font class="keyword">using</font> <a class="code" href="classbase_1_1DifferenceExpression.html">base::DifferenceExpression</a>;
00043 <font class="keyword">using</font> <a class="code" href="classbase_1_1NegateExpression.html">base::NegateExpression</a>;
00044 <font class="keyword">using</font> <a class="code" href="classbase_1_1ProductExpression.html">base::ProductExpression</a>;
00045 <font class="keyword">using</font> <a class="code" href="classbase_1_1QuotientExpression.html">base::QuotientExpression</a>;
00046 <font class="keyword">using</font> <a class="code" href="classbase_1_1SinExpression.html">base::SinExpression</a>;
00047 <font class="keyword">using</font> <a class="code" href="classbase_1_1CosExpression.html">base::CosExpression</a>;
00048 
00049 Expression::Expression()<font class="keyword"></font>
00050 <font class="keyword"></font>{
00051   expr = ref&lt;ExpressionNode&gt;(NewObj ConstantExpression(0));
00052 }
00053 
00054 Expression::Expression(Real constant)<font class="keyword"></font>
00055 <font class="keyword"></font>{
00056   expr = ref&lt;ExpressionNode&gt;(NewObj ConstantExpression(constant));
00057 }
00058 
00059 Expression::Expression(<font class="keyword">const</font> Expression&amp; e)<font class="keyword"></font>
00060 <font class="keyword"></font>{
00061   expr = e.expr;
00062 }
00063 
00064 base::Real Expression::evaluate(<font class="keyword">const</font> Vector&amp; params)<font class="keyword"> const</font>
00065 <font class="keyword"></font>{
00066   expr-&gt;resetCache();
00067   <font class="keywordflow">return</font> expr-&gt;evaluate(params);
00068 }
00069 
00070 Expression Expression::differentiate( Expression withRespectTo )<font class="keyword"> const</font>
00071 <font class="keyword"></font>{
00072   <font class="keywordflow">if</font> ( withRespectTo.expr-&gt;opType() != ExpressionNode::Variable ) 
00073     <font class="keywordflow">throw</font> std::invalid_argument(<a class="code" href="base.html#a12">Exception</a>(<font class="stringliteral">"Must pass a simple variable expression, such as Expression::p[2]"</font>));
00074 
00075   ref&lt;VariableExpression&gt; vexpr( narrow_ref&lt;VariableExpression&gt;(withRespectTo.expr) );
00076   <font class="keywordflow">return</font> <a class="code" href="classbase_1_1Expression.html#a0">Expression</a>(expr-&gt;differentiate(vexpr-&gt;index));
00077 }
00078 
00079 <font class="keywordtype">void</font> Expression::simplify()<font class="keyword"></font>
00080 <font class="keyword"></font>{
00081   expr = <a class="code" href="classbase_1_1Expression.html#b1">simplifyConstantExpressions</a>(expr);
00082 }
00083 
00084 <font class="keywordtype">void</font> Expression::operationCounts(Int&amp; addsub, Int&amp; multdiv, Int&amp; trig)<font class="keyword"> const</font>
00085 <font class="keyword"></font>{
00086   expr-&gt;operationCounts(addsub,multdiv,trig);
00087 }
00088 
00089 
00090 base::String Expression::toString()<font class="keyword"> const</font>
00091 <font class="keyword"></font>{
00092   <font class="keywordflow">return</font> expr-&gt;toString();
00093 }
00094 
00095 Expression Expression::VariableIndexer::operator[](Int i)<font class="keyword"> const</font>
00096 <font class="keyword"></font>{
00097   ref&lt;ExpressionNode&gt; <a class="code" href="classbase_1_1Expression.html#n0">expr</a>(NewObj VariableExpression(i));
00098   <font class="keywordflow">return</font> <a class="code" href="classbase_1_1Expression.html#a0">Expression</a>(expr);
00099 }
00100 
00101 
00102 Expression::VariableIndexer Expression::p;
00103 
00104 
00105 <font class="comment">// Member Operators/Operations</font>
00106 Expression&amp; Expression::operator+=(<font class="keyword">const</font> Expression&amp; e)<font class="keyword"></font>
00107 <font class="keyword"></font>{
00108   expr = ref&lt;ExpressionNode&gt;(NewObj SumExpression(expr,e.expr));
00109   <font class="keywordflow">return</font> *<font class="keyword">this</font>;
00110 }
00111 
00112 Expression&amp; Expression::operator-=(<font class="keyword">const</font> Expression&amp; e)<font class="keyword"></font>
00113 <font class="keyword"></font>{
00114   expr = ref&lt;ExpressionNode&gt;(NewObj DifferenceExpression(expr,e.expr));
00115   <font class="keywordflow">return</font> *<font class="keyword">this</font>;
00116 }
00117 
00118 Expression&amp; Expression::operator*=(<font class="keyword">const</font> Expression&amp; e)<font class="keyword"></font>
00119 <font class="keyword"></font>{
00120   expr = ref&lt;ExpressionNode&gt;(NewObj ProductExpression(expr,e.expr));
00121   <font class="keywordflow">return</font> *<font class="keyword">this</font>;
00122 }
00123 
00124 Expression&amp; Expression::operator/=(<font class="keyword">const</font> Expression&amp; e)<font class="keyword"></font>
00125 <font class="keyword"></font>{
00126   expr = ref&lt;ExpressionNode&gt;(NewObj QuotientExpression(expr,e.expr));
00127   <font class="keywordflow">return</font> *<font class="keyword">this</font>;
00128 }
00129 
00130 Expression&amp; Expression::negate()<font class="keyword"></font>
00131 <font class="keyword"></font>{
00132   expr = ref&lt;ExpressionNode&gt;(NewObj NegateExpression(expr));
00133   <font class="keywordflow">return</font> *<font class="keyword">this</font>;
00134 }
00135 
00136 Expression&amp; Expression::sin()<font class="keyword"></font>
00137 <font class="keyword"></font>{
00138   expr = ref&lt;ExpressionNode&gt;(NewObj SinExpression(expr));
00139   <font class="keywordflow">return</font> *<font class="keyword">this</font>;
00140 }
00141 
00142 Expression&amp; Expression::cos()<font class="keyword"></font>
00143 <font class="keyword"></font>{
00144   expr = ref&lt;ExpressionNode&gt;(NewObj CosExpression(expr));
00145   <font class="keywordflow">return</font> *<font class="keyword">this</font>;
00146 }
00147 
00148 
00149 <font class="comment">// Simplification helper methods</font>
00150 ref&lt;ExpressionNode&gt; Expression::simplifyConstantExpressions(ref&lt;ExpressionNode&gt; expr)<font class="keyword"></font>
00151 <font class="keyword"></font>{
00152   <a class="code" href="base.html#a16">Assert</a>(expr!=0);
00153 
00154   ref&lt;ExpressionNode&gt; sexpr(expr); <font class="comment">// (potentially) simpler expression</font>
00155 
00156   <font class="keywordflow">if</font> (sexpr-&gt;isBinaryOp()) { 
00157     ref&lt;BinaryOpExpression&gt; binExpr(narrow_ref&lt;BinaryOpExpression&gt;(sexpr));
00158 
00159     <font class="comment">// recursively simplify subtree first</font>
00160     binExpr-&gt;leftArg  = <a class="code" href="classbase_1_1Expression.html#b1">simplifyConstantExpressions</a>(binExpr-&gt;leftArg);
00161     binExpr-&gt;rightArg = <a class="code" href="classbase_1_1Expression.html#b1">simplifyConstantExpressions</a>(binExpr-&gt;rightArg);
00162 
00163     <font class="comment">// Test for constness and zero (&lt; base::epsilon)</font>
00164     <font class="keywordtype">bool</font> leftIsConst  = binExpr-&gt;leftArg-&gt;opType()  == ExpressionNode::Constant;
00165     <font class="keywordtype">bool</font> rightIsConst = binExpr-&gt;rightArg-&gt;opType() == ExpressionNode::Constant;
00166     ref&lt;ConstantExpression&gt; leftConst;
00167     <font class="keywordflow">if</font> (leftIsConst) leftConst = narrow_ref&lt;ConstantExpression&gt;(binExpr-&gt;leftArg);
00168     <font class="keywordtype">bool</font> leftIsZero = leftIsConst?(<a class="code" href="namespace__base.html#a65">equals</a>(leftConst-&gt;constValue,0)):<font class="keyword">false</font>;
00169     ref&lt;ConstantExpression&gt; rightConst;
00170     <font class="keywordflow">if</font> (rightIsConst) rightConst = narrow_ref&lt;ConstantExpression&gt;(binExpr-&gt;rightArg);
00171     <font class="keywordtype">bool</font> rightIsZero = rightIsConst?(<a class="code" href="namespace__base.html#a65">equals</a>(rightConst-&gt;constValue,0)):<font class="keyword">false</font>;
00172 
00173     <font class="comment">// if both left &amp; right are constants, replace with evaluated constant</font>
00174     <font class="comment">//  or if only one is a constant and == 0, eliminate it (Sum/Diff) or replace</font>
00175     <font class="comment">//  whole expression with 0 (Prod/Div)</font>
00176 
00177     <font class="keywordflow">if</font> (binExpr-&gt;opType() == ExpressionNode::Sum) {
00178 
00179       <font class="keywordflow">if</font> (leftIsConst) {
00180         <font class="keywordflow">if</font> (rightIsConst)
00181           sexpr = ref&lt;ExpressionNode&gt;(NewObj ConstantExpression(leftConst-&gt;constValue + rightConst-&gt;constValue));
00182         <font class="keywordflow">else</font>
00183           <font class="keywordflow">if</font> (leftIsZero)
00184             sexpr = binExpr-&gt;rightArg; <font class="comment">// 0+x = x</font>
00185       }
00186       <font class="keywordflow">else</font>
00187         <font class="keywordflow">if</font> (rightIsConst &amp;&amp; rightIsZero)
00188           sexpr = binExpr-&gt;leftArg; <font class="comment">// x+0 = x</font>
00189 
00190     }
00191     <font class="keywordflow">else</font> <font class="keywordflow">if</font> (binExpr-&gt;opType() == ExpressionNode::Difference) {
00192 
00193       <font class="keywordflow">if</font> (leftIsConst) {
00194         <font class="keywordflow">if</font> (rightIsConst)
00195           sexpr = ref&lt;ExpressionNode&gt;(NewObj ConstantExpression(leftConst-&gt;constValue - rightConst-&gt;constValue));
00196         <font class="keywordflow">else</font>
00197           <font class="keywordflow">if</font> (leftIsZero)
00198             sexpr = ref&lt;ExpressionNode&gt;(NewObj NegateExpression(binExpr-&gt;rightArg)); <font class="comment">// 0-x = -x</font>
00199       }
00200       <font class="keywordflow">else</font>
00201         <font class="keywordflow">if</font> (rightIsConst &amp;&amp; rightIsZero)
00202           sexpr = binExpr-&gt;leftArg; <font class="comment">// x-0 = x</font>
00203 
00204     }
00205     <font class="keywordflow">else</font> <font class="keywordflow">if</font> (binExpr-&gt;opType() == ExpressionNode::Product) {
00206 
00207       <font class="keywordtype">bool</font> leftIsOne  = leftIsConst?(<a class="code" href="namespace__base.html#a65">equals</a>(leftConst-&gt;constValue,1)):<font class="keyword">false</font>;
00208       <font class="keywordtype">bool</font> rightIsOne = rightIsConst?(<a class="code" href="namespace__base.html#a65">equals</a>(rightConst-&gt;constValue,1)):<font class="keyword">false</font>;
00209 
00210       <font class="keywordflow">if</font> (leftIsConst) {
00211         <font class="keywordflow">if</font> (rightIsConst)
00212           sexpr = ref&lt;ExpressionNode&gt;(NewObj ConstantExpression(leftConst-&gt;constValue * rightConst-&gt;constValue));
00213         <font class="keywordflow">else</font> {
00214           <font class="keywordflow">if</font> (leftIsZero)
00215             sexpr = ref&lt;ExpressionNode&gt;(NewObj ConstantExpression(0)); <font class="comment">// 0*x = 0</font>
00216           <font class="keywordflow">else</font>
00217             <font class="keywordflow">if</font> (leftIsOne)
00218               sexpr = binExpr-&gt;rightArg; <font class="comment">// 1*x = x</font>
00219         }
00220         
00221       }
00222       <font class="keywordflow">else</font>
00223         <font class="keywordflow">if</font> (rightIsConst) {
00224           <font class="keywordflow">if</font> (rightIsZero)
00225             sexpr = ref&lt;ExpressionNode&gt;(NewObj ConstantExpression(0)); <font class="comment">// x*0 = 0</font>
00226           <font class="keywordflow">else</font>
00227             <font class="keywordflow">if</font> (rightIsOne)
00228               sexpr = binExpr-&gt;leftArg; <font class="comment">// x*1 = x</font>
00229         }
00230 
00231     }
00232     <font class="keywordflow">else</font> <font class="keywordflow">if</font> (binExpr-&gt;opType() == ExpressionNode::Quotient) {
00233 
00234       <font class="keywordtype">bool</font> rightIsOne = rightIsConst?(<a class="code" href="namespace__base.html#a65">equals</a>(rightConst-&gt;constValue,1)):<font class="keyword">false</font>;
00235 
00236       <font class="keywordflow">if</font> (leftIsConst) {
00237         <font class="keywordflow">if</font> (rightIsConst)
00238           sexpr = ref&lt;ExpressionNode&gt;(NewObj ConstantExpression(leftConst-&gt;constValue / rightConst-&gt;constValue));
00239         <font class="keywordflow">else</font> {
00240           <font class="keywordflow">if</font> (leftIsZero)
00241             sexpr = ref&lt;ExpressionNode&gt;(NewObj ConstantExpression(0)); <font class="comment">// 0/x = 0</font>
00242         }
00243         
00244       }
00245       <font class="keywordflow">else</font>
00246         <font class="keywordflow">if</font> (rightIsConst) {
00247           <font class="keywordflow">if</font> (rightIsZero) {
00248             <font class="keywordflow">throw</font> std::out_of_range(<a class="code" href="base.html#a12">Exception</a>(<font class="stringliteral">"cannot divide by constant 0"</font>)); <font class="comment">// x/0 = error</font>
00249           }
00250           <font class="keywordflow">else</font>
00251             <font class="keywordflow">if</font> (rightIsOne)
00252               sexpr = binExpr-&gt;leftArg; <font class="comment">// x/1 = x</font>
00253         }
00254 
00255    }
00256 
00257   }
00258   <font class="keywordflow">else</font> <font class="keywordflow">if</font> (sexpr-&gt;isUnaryOp()) {
00259     ref&lt;UnaryOpExpression&gt; unaryExpr(narrow_ref&lt;UnaryOpExpression&gt;(sexpr));
00260 
00261     <font class="comment">// recursively simplify subtree first</font>
00262     unaryExpr-&gt;arg = <a class="code" href="classbase_1_1Expression.html#b1">simplifyConstantExpressions</a>(unaryExpr-&gt;arg);
00263 
00264     <font class="comment">// Test for constness </font>
00265     <font class="keywordtype">bool</font> isConst  = unaryExpr-&gt;arg-&gt;opType() == ExpressionNode::Constant;
00266     ref&lt;ConstantExpression&gt; argConst;
00267     <font class="keywordflow">if</font> (isConst) argConst = narrow_ref&lt;ConstantExpression&gt;(unaryExpr-&gt;arg);
00268 
00269     <font class="keywordflow">if</font> (unaryExpr-&gt;opType() == ExpressionNode::Sine) {
00270       <font class="keywordflow">if</font> (isConst)
00271         sexpr = ref&lt;ExpressionNode&gt;(NewObj ConstantExpression(::<a class="code" href="classbase_1_1Expression.html#a15">sin</a>(argConst-&gt;constValue)));
00272     }
00273     <font class="keywordflow">else</font> <font class="keywordflow">if</font> (unaryExpr-&gt;opType() == ExpressionNode::Cosine) {
00274       <font class="keywordflow">if</font> (isConst)
00275         sexpr = ref&lt;ExpressionNode&gt;(NewObj ConstantExpression(::<a class="code" href="classbase_1_1Expression.html#a16">cos</a>(argConst-&gt;constValue)));
00276     }
00277     <font class="keywordflow">else</font> <font class="keywordflow">if</font> (unaryExpr-&gt;opType() == ExpressionNode::Negative) {
00278       ref&lt;NegateExpression&gt; nexpr( narrow_ref&lt;NegateExpression&gt;(unaryExpr) );
00279       <font class="keywordflow">if</font> (nexpr-&gt;arg-&gt;opType() == ExpressionNode::Constant) {
00280         <font class="keywordtype">bool</font> isZero = <a class="code" href="namespace__base.html#a65">base::equals</a>(ref&lt;ConstantExpression&gt;(narrow_ref&lt;ConstantExpression&gt;(nexpr-&gt;arg))-&gt;constValue,0);
00281         <font class="keywordflow">if</font> (isZero)
00282           sexpr = nexpr-&gt;arg;
00283       }
00284       <font class="keywordflow">else</font> <font class="keywordflow">if</font> (nexpr-&gt;arg-&gt;opType() == ExpressionNode::Negative) {
00285         sexpr = narrow_ref&lt;NegateExpression&gt;(nexpr-&gt;arg)-&gt;arg;
00286       }
00287     }
00288 
00289   }
00290 
00291   <font class="keywordflow">return</font> sexpr;
00292 }
00293 
</pre></div><hr><address><small>Generated at Wed Aug 7 10:30:27 2002 for OpenSim by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.8.1 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2001</small></address>
</body>
</html>
