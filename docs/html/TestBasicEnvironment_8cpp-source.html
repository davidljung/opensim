<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>OpenSim: robot/sim/TestBasicEnvironment.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>robot/sim/TestBasicEnvironment.cpp</h1><a href="TestBasicEnvironment_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/****************************************************************************</span>
00002 <span class="comment">  Copyright (C)2003 David Jung &lt;opensim@pobox.com&gt;</span>
00003 <span class="comment"></span>
00004 <span class="comment">  This program/file is free software; you can redistribute it and/or modify</span>
00005 <span class="comment">  it under the terms of the GNU General Public License as published by</span>
00006 <span class="comment">  the Free Software Foundation; either version 2 of the License, or</span>
00007 <span class="comment">  (at your option) any later version.</span>
00008 <span class="comment">  </span>
00009 <span class="comment">  This program is distributed in the hope that it will be useful,</span>
00010 <span class="comment">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00011 <span class="comment">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00012 <span class="comment">  GNU General Public License for more details. (http://www.gnu.org)</span>
00013 <span class="comment">  </span>
00014 <span class="comment">  You should have received a copy of the GNU General Public License</span>
00015 <span class="comment">  along with this program; if not, write to the Free Software</span>
00016 <span class="comment">  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
00017 <span class="comment">  </span>
00018 <span class="comment">  $Id: TestBasicEnvironment.cpp 1033 2004-02-11 20:47:52Z jungd $</span>
00019 <span class="comment">  $Revision: 1.6 $</span>
00020 <span class="comment">  $Date: 2004-02-11 15:47:52 -0500 (Wed, 11 Feb 2004) $</span>
00021 <span class="comment">  $Author: jungd $</span>
00022 <span class="comment"> </span>
00023 <span class="comment">****************************************************************************/</span>
00024 
00025 <span class="preprocessor">#include &lt;<a class="code" href="TestBasicEnvironment.html">robot/sim/TestBasicEnvironment</a>&gt;</span>
00026 
00027 <span class="preprocessor">#include &lt;<a class="code" href="Externalizer.html">base/Externalizer</a>&gt;</span>
00028 <span class="preprocessor">#include &lt;<a class="code" href="externalization__error.html">base/externalization_error</a>&gt;</span>
00029 <span class="preprocessor">#include &lt;<a class="code" href="Application.html">base/Application</a>&gt;</span>
00030 <span class="preprocessor">#include &lt;<a class="code" href="VFile.html">base/VFile</a>&gt;</span>
00031 
00032 <span class="keyword">using</span> <a class="code" href="classrobot_1_1sim_1_1TestBasicEnvironment.html">robot::sim::TestBasicEnvironment</a>;
00033 
00034 <span class="keyword">using</span> <a class="code" href="classbase_1_1Externalizer.html">base::Externalizer</a>;
00035 <span class="keyword">using</span> <a class="code" href="classbase_1_1externalization__error.html">base::externalization_error</a>;
00036 <span class="keyword">using</span> <a class="code" href="classbase_1_1Orient.html">base::Orient</a>;
00037 <span class="keyword">using</span> <a class="code" href="classbase_1_1Vector3.html">base::Dimension3</a>;
00038 <span class="keyword">using</span> <a class="code" href="classbase_1_1Application.html">base::Application</a>;
00039 <span class="keyword">using</span> <a class="code" href="classbase_1_1VFile.html">base::VFile</a>;
00040 <span class="keyword">using</span> <a class="code" href="classbase_1_1PathName.html">base::PathName</a>;
00041 <span class="keyword">using</span> base::dom::DOMNode;
00042 <span class="keyword">using</span> base::dom::DOMElement;
00043 <span class="keyword">using</span> <a class="code" href="classrobot_1_1TestRobot.html">robot::TestRobot</a>;
00044 <span class="keyword">using</span> <a class="code" href="classrobot_1_1sim_1_1BasicEnvironment.html">robot::sim::BasicEnvironment</a>;
00045 
00046 
00047 
00048 TestBasicEnvironment::TestBasicEnvironment(ref&lt;base::VFileSystem&gt; fs, ref&lt;base::Cache&gt; cache, <span class="keyword">const</span> String&amp; name)
00049   : <a class="code" href="classrobot_1_1sim_1_1BasicEnvironment.html">BasicEnvironment</a>(fs, cache, name)
00050 {
00051   <a class="code" href="base.html#a3">Logln</a>(<span class="stringliteral">"Warning: class TestBasicEnvironment will be deprecated in favour of SimulatedBasicEnvironment in future"</span>);
00052 }
00053 
00054 <span class="comment">/*</span>
00055 <span class="comment">ref&lt;robot::Robot&gt; TestBasicEnvironment::addRobot(ref&lt;base::VFile&gt; robotSpecification,</span>
00056 <span class="comment">                                                 const base::Point3&amp; position, </span>
00057 <span class="comment">                                                 const base::Orient&amp; orientation,</span>
00058 <span class="comment">                                                 bool anchored)</span>
00059 <span class="comment">{</span>
00060 <span class="comment">  ref&lt;TestRobot&gt; robot(NewObj TestRobot(robotSpecification,</span>
00061 <span class="comment">                                        position, orientation));</span>
00062 <span class="comment">  robots.push_back(robot);</span>
00063 <span class="comment">  return robot;</span>
00064 <span class="comment">}</span>
00065 <span class="comment">*/</span>
00066 
00067 ref&lt;robot::Robot&gt; TestBasicEnvironment::addRobot(ref&lt;const robot::RobotDescription&gt; robotDescription,
00068                                                  <span class="keyword">const</span> <a class="code" href="classbase_1_1Vector3.html">base::Point3</a>&amp; position, 
00069                                                  <span class="keyword">const</span> <a class="code" href="classbase_1_1Orient.html">base::Orient</a>&amp; orientation,
00070                                                  <span class="keywordtype">bool</span> anchored)
00071 {
00072   ref&lt;TestRobot&gt; <a class="code" href="robot_2Jamfile_8ft.html#a0">robot</a>(NewObj <a class="code" href="classrobot_1_1TestRobot.html">TestRobot</a>(robotDescription,
00073                        position, orientation));
00074   <a class="code" href="classrobot_1_1sim_1_1TestBasicEnvironment.html#robot_1_1sim_1_1TestBasicEnvironmentp0">robots</a>.push_back(robot);
00075   <span class="keywordflow">return</span> <a class="code" href="robot_2Jamfile_8ft.html#a0">robot</a>;
00076 }
00077 
00078 
00079 <span class="keywordtype">void</span> TestBasicEnvironment::removeRobot(ref&lt;robot::Robot&gt; robot)
00080 {
00081   <span class="keywordflow">if</span> (<a class="code" href="base.html#a25">instanceof</a>(*robot, <a class="code" href="classrobot_1_1TestRobot.html">TestRobot</a>)) {
00082     ref&lt;TestRobot&gt; testRobot( narrow_ref&lt;TestRobot&gt;(robot));
00083     <a class="code" href="classrobot_1_1sim_1_1TestBasicEnvironment.html#robot_1_1sim_1_1TestBasicEnvironmentp0">robots</a>.remove(testRobot);
00084   }
00085   <span class="keywordflow">else</span>
00086     <span class="keywordflow">throw</span> std::invalid_argument(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"unknown robot"</span>));
00087 }
00088 
00089 
00090 ref&lt;BasicEnvironment::Tool&gt; TestBasicEnvironment::addTool(ref&lt;const robot::ToolDescription&gt; toolDescription,
00091                                                           <span class="keyword">const</span> <a class="code" href="classbase_1_1Vector3.html">base::Point3</a>&amp; position, 
00092                                                           <span class="keyword">const</span> <a class="code" href="classbase_1_1Orient.html">base::Orient</a>&amp; orientation)
00093 {
00094   ref&lt;Tool&gt; tool(NewObj Tool(toolDescription-&gt;getName(),toolDescription,
00095                              position, orientation));
00096   <a class="code" href="classrobot_1_1sim_1_1TestBasicEnvironment.html#robot_1_1sim_1_1TestBasicEnvironmentp1">tools</a>.push_back(tool);
00097   <span class="keywordflow">return</span> tool;
00098 }
00099 
00100 
00101 <span class="keywordtype">void</span> TestBasicEnvironment::removeTool(ref&lt;BasicEnvironment::Tool&gt; tool)
00102 {
00103   <a class="code" href="classrobot_1_1sim_1_1TestBasicEnvironment.html#robot_1_1sim_1_1TestBasicEnvironmentp1">tools</a>.remove(tool);
00104 }
00105 
00106 
00107 <span class="keywordtype">void</span> TestBasicEnvironment::placeToolInProximity(ref&lt;Tool&gt; tool, ref&lt;Robot&gt; robot, Int manipulatorIndex)
00108 {
00109    <span class="keywordflow">if</span> (<a class="code" href="base.html#a25">instanceof</a>(*robot, <a class="code" href="classrobot_1_1TestRobot.html">TestRobot</a>)) {
00110      ref&lt;const ToolDescription&gt; toolDescription(tool-&gt;getToolDescription());
00111 
00112     ref&lt;TestRobot&gt; testRobot( narrow_ref&lt;TestRobot&gt;(robot));
00113     testRobot-&gt;placeToolInProximity(toolDescription, manipulatorIndex);
00114   }
00115   <span class="keywordflow">else</span>
00116     <span class="keywordflow">throw</span> std::invalid_argument(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"unknown robot"</span>));
00117 }
00118 
00119 
00120 
00121 ref&lt;BasicEnvironment::Obstacle&gt; TestBasicEnvironment::addBoxObstacle(<a class="code" href="classbase_1_1Vector3.html">base::Dimension3</a> dim, 
00122                                                                      <span class="keyword">const</span> <a class="code" href="classbase_1_1Vector3.html">base::Point3</a>&amp; position, 
00123                                                                      <span class="keyword">const</span> <a class="code" href="classbase_1_1Orient.html">base::Orient</a>&amp; orientation,
00124                                                                      <span class="keyword">const</span> String&amp; name)
00125 {
00126   ref&lt;Obstacle&gt; obstacle(NewObj Obstacle(dim,position,orientation));
00127   <a class="code" href="classrobot_1_1sim_1_1TestBasicEnvironment.html#robot_1_1sim_1_1TestBasicEnvironmentp2">obstacles</a>.push_back(obstacle);
00128   <span class="keywordflow">return</span> obstacle;
00129 }
00130 
00131 
00132 ref&lt;BasicEnvironment::Obstacle&gt; TestBasicEnvironment::addSphereObstacle(Real radius,
00133                                                                         <span class="keyword">const</span> <a class="code" href="classbase_1_1Vector3.html">base::Point3</a>&amp; position, 
00134                                                                         <span class="keyword">const</span> <a class="code" href="classbase_1_1Orient.html">base::Orient</a>&amp; orientation,
00135                                                                         <span class="keyword">const</span> String&amp; name)
00136 {
00137   ref&lt;Obstacle&gt; obstacle(NewObj Obstacle(radius,position,orientation));
00138   <a class="code" href="classrobot_1_1sim_1_1TestBasicEnvironment.html#robot_1_1sim_1_1TestBasicEnvironmentp2">obstacles</a>.push_back(obstacle);
00139   <span class="keywordflow">return</span> obstacle;
00140 }
00141 
00142 
00143 <span class="keywordtype">void</span> TestBasicEnvironment::removeObstacle(ref&lt;BasicEnvironment::Obstacle&gt; obstacle)
00144 {
00145   <a class="code" href="classrobot_1_1sim_1_1TestBasicEnvironment.html#robot_1_1sim_1_1TestBasicEnvironmentp2">obstacles</a>.remove(obstacle);
00146 }
00147 
00148 
00149 
00150 <span class="keywordtype">void</span> TestBasicEnvironment::preSimulate()
00151 {
00152 }
00153 
00154 
00155 <span class="keywordtype">void</span> TestBasicEnvironment::simulateForSimTime(<span class="keyword">const</span> <a class="code" href="classbase_1_1Time.html">base::Time</a>&amp; dt)
00156 {
00157 }
00158 
00159 
00160 <span class="keywordtype">bool</span> TestBasicEnvironment::formatSupported(<span class="keyword">const</span> String format, Real version, ExternalizationType type)<span class="keyword"> const</span>
00161 <span class="keyword"></span>{
00162   <span class="keywordflow">return</span> ( (format==<span class="stringliteral">"xml"</span>) &amp;&amp; (version==1.0) ); 
00163 }
00164 
00165 
00166 <span class="keywordtype">void</span> TestBasicEnvironment::externalize(<a class="code" href="classbase_1_1Externalizer.html">base::Externalizer</a>&amp; e, <span class="keyword">const</span> String format, Real version)
00167 {
00168   <span class="keywordflow">if</span> (!<a class="code" href="classrobot_1_1sim_1_1TestBasicEnvironment.html#robot_1_1sim_1_1TestBasicEnvironmenta21">formatSupported</a>(format,version,e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera6">ioType</a>()))
00169     <span class="keywordflow">throw</span> std::invalid_argument(<a class="code" href="base.html#a15">Exception</a>(<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"format "</span>)+format+<span class="stringliteral">" v"</span>+base::realToString(version)+<span class="stringliteral">" unsupported"</span>));
00170   
00171   <span class="keywordflow">if</span> (format == <span class="stringliteral">"xml"</span>) {
00172 
00173     <span class="keywordflow">if</span> (e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera4">isOutput</a>()) {
00174 
00175       DOMElement* envElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"environment"</span>);
00176       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera26">setElementAttribute</a>(envElem,<span class="stringliteral">"type"</span>,<span class="stringliteral">"basic"</span>);
00177 
00178       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera19">pushContext</a>(envElem);
00179 
00180       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera22">appendBreak</a>(envElem);
00181 
00182       <span class="comment">// externalize the robots</span>
00183       RobotList::const_iterator r = <a class="code" href="classrobot_1_1sim_1_1TestBasicEnvironment.html#robot_1_1sim_1_1TestBasicEnvironmentp0">robots</a>.begin();
00184       RobotList::const_iterator rend = <a class="code" href="classrobot_1_1sim_1_1TestBasicEnvironment.html#robot_1_1sim_1_1TestBasicEnvironmentp0">robots</a>.end();
00185      <span class="keywordflow">if</span> (r != rend)
00186        e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera31">appendComment</a>(envElem,<span class="stringliteral">"robots   (description, position, and orientation (Quat) )"</span>);
00187       <span class="keywordflow">while</span> (r != rend) {
00188         ref&lt;TestRobot&gt; <a class="code" href="robot_2Jamfile_8ft.html#a0">robot</a>(*r);
00189         
00190         <span class="keywordflow">if</span> (<a class="code" href="robot_2Jamfile_8ft.html#a0">robot</a>-&gt;isDescriptionProvided()) 
00191           <a class="code" href="robot_2Jamfile_8ft.html#a0">robot</a>-&gt;getRobotDescription()-&gt;externalize(e, format, version);
00192         <span class="keywordflow">else</span>
00193           <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"can't externalize a Robot with no description"</span>));
00194         
00195         DOMElement* robotElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera23">lastAppendedElement</a>();
00196         <a class="code" href="namespacebase.html#a26">Point3</a> position(<a class="code" href="robot_2Jamfile_8ft.html#a0">robot</a>-&gt;getPosition());
00197         DOMElement* posElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"position"</span>,<span class="keyword">false</span>);
00198         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera29">appendText</a>(posElem, e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere5">toString</a>(position) );
00199         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera34">appendNode</a>(robotElem, posElem);
00200         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera22">appendBreak</a>(robotElem);
00201         
00202         Orient orientation(<a class="code" href="robot_2Jamfile_8ft.html#a0">robot</a>-&gt;getOrientation());
00203         DOMElement* orientElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"orientation"</span>,<span class="keyword">false</span>);
00204         <a class="code" href="classdemeter_1_1Vector.html">Vector</a> v( orientation.getVector(Orient::Quat) );
00205         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera29">appendText</a>(orientElem, e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere5">toString</a>(v,<span class="keyword">true</span>));
00206         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera34">appendNode</a>(robotElem, orientElem);
00207         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera22">appendBreak</a>(robotElem);
00208         
00209         ++r;
00210         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera22">appendBreak</a>(envElem);
00211       }
00212       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera22">appendBreak</a>(envElem);
00213 
00214 
00215       <span class="comment">// externalize tools</span>
00216       ToolList::const_iterator t = <a class="code" href="classrobot_1_1sim_1_1TestBasicEnvironment.html#robot_1_1sim_1_1TestBasicEnvironmentp1">tools</a>.begin();
00217       ToolList::const_iterator tend = <a class="code" href="classrobot_1_1sim_1_1TestBasicEnvironment.html#robot_1_1sim_1_1TestBasicEnvironmentp1">tools</a>.end();
00218       <span class="keywordflow">if</span> (t != tend)
00219         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera31">appendComment</a>(envElem,<span class="stringliteral">"tools   (position, orientation (Quat) and description)"</span>);
00220         <span class="keywordflow">while</span> (t != tend) {
00221           ref&lt;Tool&gt; tool(*t);
00222           tool-&gt;getToolDescription()-&gt;externalize(e, format, version);
00223           
00224           DOMElement* toolElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera23">lastAppendedElement</a>();
00225           
00226           <a class="code" href="namespacebase.html#a26">Point3</a>&amp; position(tool-&gt;getPosition()); 
00227           DOMElement* posElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"position"</span>,<span class="keyword">false</span>);
00228           e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera29">appendText</a>(posElem, e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere5">toString</a>(position) );
00229           e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera34">appendNode</a>(toolElem, posElem);
00230           e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera22">appendBreak</a>(toolElem);
00231           
00232           Orient&amp; orientation(tool-&gt;getOrientation()); 
00233           DOMElement* orientElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"orientation"</span>,<span class="keyword">false</span>);
00234           <a class="code" href="classdemeter_1_1Vector.html">Vector</a> v( orientation.getVector(Orient::Quat) );
00235           e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera29">appendText</a>(orientElem, e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere5">toString</a>(v,<span class="keyword">true</span>));
00236           e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera34">appendNode</a>(toolElem, orientElem);
00237           e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera22">appendBreak</a>(toolElem);
00238           
00239           ++t;
00240           e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera22">appendBreak</a>(envElem);
00241       }
00242       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera22">appendBreak</a>(envElem);
00243 
00244 
00245       <span class="comment">// externalize obstacles</span>
00246       ObstacleList::const_iterator o = <a class="code" href="classrobot_1_1sim_1_1TestBasicEnvironment.html#robot_1_1sim_1_1TestBasicEnvironmentp2">obstacles</a>.begin();
00247       ObstacleList::const_iterator oend = <a class="code" href="classrobot_1_1sim_1_1TestBasicEnvironment.html#robot_1_1sim_1_1TestBasicEnvironmentp2">obstacles</a>.end();
00248       <span class="keywordflow">if</span> (o != oend)
00249         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera31">appendComment</a>(envElem,<span class="stringliteral">"obstacles (position, orientation (Quat) and description)"</span>);
00250       <span class="keywordflow">while</span> (o != oend) {
00251         ref&lt;Obstacle&gt; obstacle(*o);
00252         
00253         DOMElement* obstElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"obstacle"</span>);
00254         
00255         <a class="code" href="namespacebase.html#a26">Point3</a>&amp; position(obstacle-&gt;position); 
00256         DOMElement* posElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"position"</span>,<span class="keyword">false</span>);
00257         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera29">appendText</a>(posElem, e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere5">toString</a>(position) );
00258         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera34">appendNode</a>(obstElem, posElem);
00259         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera22">appendBreak</a>(obstElem);
00260         
00261         Orient&amp; orientation(obstacle-&gt;orientation); 
00262         DOMElement* orientElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"orientation"</span>,<span class="keyword">false</span>);
00263         <a class="code" href="classdemeter_1_1Vector.html">Vector</a> v( orientation.getVector(Orient::Quat) );
00264         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera29">appendText</a>(orientElem, e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere5">toString</a>(v,<span class="keyword">true</span>));
00265         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera34">appendNode</a>(obstElem, orientElem);
00266         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera22">appendBreak</a>(obstElem);
00267         
00268         <span class="keywordflow">if</span> (obstacle-&gt;type == Obstacle::BoxObstacle) {
00269           e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera26">setElementAttribute</a>(obstElem,<span class="stringliteral">"type"</span>,<span class="stringliteral">"box"</span>);
00270           DOMElement* dElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"dimensions"</span>,<span class="keyword">false</span>);
00271           e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera29">appendText</a>( dElem, e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere5">toString</a>(obstacle-&gt;dims) );
00272           e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera34">appendNode</a>(obstElem,dElem);
00273           e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera22">appendBreak</a>(obstElem);
00274         }
00275         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (obstacle-&gt;type == Obstacle::SphereObstacle) {
00276           e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera26">setElementAttribute</a>(obstElem,<span class="stringliteral">"type"</span>,<span class="stringliteral">"sphere"</span>);
00277           DOMElement* rElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"radius"</span>,<span class="keyword">false</span>);
00278           e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera29">appendText</a>(rElem, base::realToString(obstacle-&gt;radius));
00279           e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera22">appendBreak</a>(obstElem);
00280           e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera34">appendNode</a>(obstElem,rElem);
00281         }
00282         <span class="keywordflow">else</span>
00283           <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"unsupported obstacle type"</span>));
00284         
00285         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera34">appendNode</a>(envElem, obstElem);
00286         
00287         ++o;
00288         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera22">appendBreak</a>(envElem);
00289       }
00290 
00291       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera20">popContext</a>();
00292 
00293       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera21">appendElement</a>(envElem);
00294 
00295     }
00296     <span class="keywordflow">else</span> { <span class="comment">// input</span>
00297       <span class="comment">// first clear the current environment</span>
00298       <span class="keywordflow">while</span> (!<a class="code" href="classrobot_1_1sim_1_1TestBasicEnvironment.html#robot_1_1sim_1_1TestBasicEnvironmentp0">robots</a>.empty()) <a class="code" href="classrobot_1_1sim_1_1TestBasicEnvironment.html#robot_1_1sim_1_1TestBasicEnvironmenta4">removeRobot</a>( <a class="code" href="classrobot_1_1sim_1_1TestBasicEnvironment.html#robot_1_1sim_1_1TestBasicEnvironmentp0">robots</a>.front() );
00299       <span class="keywordflow">while</span> (!<a class="code" href="classrobot_1_1sim_1_1TestBasicEnvironment.html#robot_1_1sim_1_1TestBasicEnvironmentp1">tools</a>.empty()) <a class="code" href="classrobot_1_1sim_1_1TestBasicEnvironment.html#robot_1_1sim_1_1TestBasicEnvironmenta8">removeTool</a>( <a class="code" href="classrobot_1_1sim_1_1TestBasicEnvironment.html#robot_1_1sim_1_1TestBasicEnvironmentp1">tools</a>.front() );
00300       <span class="keywordflow">while</span> (!<a class="code" href="classrobot_1_1sim_1_1TestBasicEnvironment.html#robot_1_1sim_1_1TestBasicEnvironmentp2">obstacles</a>.empty()) <a class="code" href="classrobot_1_1sim_1_1TestBasicEnvironment.html#robot_1_1sim_1_1TestBasicEnvironmenta15">removeObstacle</a>( <a class="code" href="classrobot_1_1sim_1_1TestBasicEnvironment.html#robot_1_1sim_1_1TestBasicEnvironmentp2">obstacles</a>.front() );
00301 
00302       <span class="comment">// now load the new one</span>
00303       DOMNode* context = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera16">context</a>();
00304     
00305       DOMElement* envElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera36">getFirstElement</a>(context, <span class="stringliteral">"environment"</span>);
00306 
00307       <span class="comment">// handle link</span>
00308       <a class="code" href="namespacebase.html#a4">String</a> link = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera41">getElementAttribute</a>(envElem,<span class="stringliteral">"link"</span>,<span class="keyword">false</span>);
00309       <span class="keywordflow">if</span> (link != <span class="stringliteral">""</span>) {
00310         
00311         ref&lt;VFile&gt; linkFile = Application::getInstance()-&gt;universe()-&gt;cache()-&gt;findFile(link,e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera7">getArchivePath</a>());
00312         <a class="code" href="classbase_1_1Externalizable.html#gfx_1_1VisualPatha28">load</a>(linkFile,format,version);
00313       }
00314       <span class="keywordflow">else</span> {
00315         
00316         <span class="keywordflow">if</span> ( e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera41">getElementAttribute</a>(envElem, <span class="stringliteral">"type"</span>) != <span class="stringliteral">"basic"</span> )
00317           <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"unsupported environment type"</span>));
00318         
00319         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera19">pushContext</a>(envElem);
00320         
00321         <span class="comment">// read in robots</span>
00322         DOMElement* robotElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(envElem, <span class="stringliteral">"robot"</span>,<span class="keyword">false</span>);
00323         <span class="keywordflow">while</span> (robotElem) {
00324           <span class="comment">// get position &amp; orientation</span>
00325           DOMElement* posElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(robotElem,<span class="stringliteral">"position"</span>);
00326           <a class="code" href="namespacebase.html#a4">String</a> posText = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera40">getContainedText</a>(posElem);
00327           <a class="code" href="namespacebase.html#a26">Point3</a> position( e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere6">toVector3</a>(posText) );
00328           
00329           DOMElement* orientElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(robotElem, <span class="stringliteral">"orientation"</span>);
00330           <a class="code" href="namespacebase.html#a4">String</a> orientText = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera40">getContainedText</a>(orientElem);
00331           <a class="code" href="classdemeter_1_1Vector.html">Vector</a> v( e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere7">toVector</a>(orientText,<span class="keyword">true</span>) );
00332           <span class="keywordflow">if</span> (v.size() != 4)
00333             <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"orientation must be a Quat (4 elements)"</span>));
00334           Orient orientation(v, Orient::Quat);
00335           
00336           ref&lt;RobotDescription&gt; rd(NewObj RobotDescription());
00337           rd-&gt;externalize(e, format, version);
00338           
00339           <a class="code" href="classrobot_1_1sim_1_1TestBasicEnvironment.html#robot_1_1sim_1_1TestBasicEnvironmenta3">addRobot</a>(rd, position, orientation);
00340           
00341           robotElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(envElem, <span class="stringliteral">"robot"</span>,<span class="keyword">false</span>);
00342         }
00343         
00344         
00345         <span class="comment">// read in tools</span>
00346         DOMElement* toolElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(envElem, <span class="stringliteral">"tool"</span>,<span class="keyword">false</span>);
00347         <span class="keywordflow">while</span> (toolElem) {
00348           <span class="comment">// get position &amp; orientation</span>
00349           DOMElement* posElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(toolElem,<span class="stringliteral">"position"</span>);
00350           <a class="code" href="namespacebase.html#a4">String</a> posText = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera40">getContainedText</a>(posElem);
00351           <a class="code" href="namespacebase.html#a26">Point3</a> position( e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere6">toVector3</a>(posText) );
00352           
00353           DOMElement* orientElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(toolElem, <span class="stringliteral">"orientation"</span>);
00354           <a class="code" href="namespacebase.html#a4">String</a> orientText = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera40">getContainedText</a>(orientElem);
00355           <a class="code" href="classdemeter_1_1Vector.html">Vector</a> v( e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere7">toVector</a>(orientText,<span class="keyword">true</span>) );
00356           <span class="keywordflow">if</span> (v.size() != 4)
00357             <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"orientation must be a Quat (4 elements)"</span>));
00358           Orient orientation(v, Orient::Quat);
00359           
00360           ref&lt;ToolDescription&gt; td(NewObj ToolDescription());
00361           td-&gt;externalize(e, format, version);
00362           
00363           <a class="code" href="classrobot_1_1sim_1_1TestBasicEnvironment.html#robot_1_1sim_1_1TestBasicEnvironmenta7">addTool</a>(td, position, orientation);
00364           
00365           toolElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(envElem, <span class="stringliteral">"tool"</span>,<span class="keyword">false</span>);
00366         }
00367         
00368         
00369         <span class="comment">// read in obstacles</span>
00370         DOMElement* obstElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(envElem, <span class="stringliteral">"obstacle"</span>,<span class="keyword">false</span>);
00371         <span class="keywordflow">while</span> (obstElem) {
00372           <a class="code" href="namespacebase.html#a4">String</a> name( e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera42">getDefaultedElementAttribute</a>(envElem, <span class="stringliteral">"name"</span>, <span class="stringliteral">"obstacle"</span>) );
00373           
00374           <span class="comment">// read in position &amp; orientation</span>
00375           DOMElement* posElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(obstElem, <span class="stringliteral">"position"</span>);
00376           <a class="code" href="namespacebase.html#a4">String</a> posText = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera40">getContainedText</a>(posElem);
00377           <a class="code" href="namespacebase.html#a26">Point3</a> position( e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere6">toVector3</a>(posText) );
00378           
00379           DOMElement* orientElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(obstElem, <span class="stringliteral">"orientation"</span>);
00380           <a class="code" href="namespacebase.html#a4">String</a> orientText = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera40">getContainedText</a>(orientElem);
00381           <a class="code" href="classdemeter_1_1Vector.html">Vector</a> v( e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere7">toVector</a>(orientText,<span class="keyword">true</span>) );
00382           <span class="keywordflow">if</span> (v.size() != 4)
00383             <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"orientation must be a Quat (4 elements)"</span>));
00384           Orient orientation(v, Orient::Quat);  
00385           
00386           <span class="comment">// get obstacle parameters &amp; construct obstacles</span>
00387           ref&lt;Obstacle&gt; obstacle;
00388           Obstacle::ObstacleType type;
00389           <span class="keywordflow">if</span> ( e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera41">getElementAttribute</a>(obstElem, <span class="stringliteral">"type"</span>) == <span class="stringliteral">"box"</span> ) {
00390             type = Obstacle::BoxObstacle;
00391             
00392             DOMElement* dElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(obstElem, <span class="stringliteral">"dimensions"</span>);
00393             <a class="code" href="namespacebase.html#a4">String</a> dimText = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera40">getContainedText</a>(dElem);
00394             <a class="code" href="classbase_1_1Vector3.html">Dimension3</a> dims( e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere6">toVector3</a>( dimText ) );
00395             
00396             <a class="code" href="classrobot_1_1sim_1_1TestBasicEnvironment.html#robot_1_1sim_1_1TestBasicEnvironmenta13">addBoxObstacle</a>(dims,position,orientation,name);
00397           }
00398           <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera41">getElementAttribute</a>(obstElem, <span class="stringliteral">"type"</span>) == <span class="stringliteral">"sphere"</span> ) {
00399             type = Obstacle::SphereObstacle;
00400             
00401             DOMElement* rElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(obstElem, <span class="stringliteral">"radius"</span>,<span class="keyword">false</span>);
00402             <a class="code" href="namespacebase.html#a5">Real</a> radius=1.0;
00403             <span class="keywordflow">if</span> (rElem) 
00404               radius = <a class="code" href="namespacebase.html#a53">base::stringToReal</a>( e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera40">getContainedText</a>(rElem) );
00405             
00406             <a class="code" href="classrobot_1_1sim_1_1TestBasicEnvironment.html#robot_1_1sim_1_1TestBasicEnvironmenta14">addSphereObstacle</a>(radius, position,orientation,name);
00407           }
00408           <span class="keywordflow">else</span>
00409             <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"unsupported obstacle type"</span>));
00410           
00411           e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera39">removeElement</a>(obstElem);
00412           
00413           obstElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(envElem, <span class="stringliteral">"obstacle"</span>,<span class="keyword">false</span>);
00414         }
00415         
00416         
00417         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera20">popContext</a>();
00418       }
00419 
00420       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera39">removeElement</a>(envElem);
00421     }
00422 
00423   }
00424 
00425 }
00426 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Jul 29 15:56:43 2004 for OpenSim by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.6 </small></address>
</body>
</html>
