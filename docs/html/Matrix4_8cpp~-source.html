<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>opensim/base/Matrix4.cpp~ Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.8.1 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>opensim/base/Matrix4.cpp~</h1><a href="Matrix4_8cpp~.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/****************************************************************************</font>
00002 <font class="comment">  Copyright (C)1996 David Jung &lt;djung@pobox.com&gt;</font>
00003 <font class="comment"></font>
00004 <font class="comment">  This program/file is free software; you can redistribute it and/or modify</font>
00005 <font class="comment">  it under the terms of the GNU General Public License as published by</font>
00006 <font class="comment">  the Free Software Foundation; either version 2 of the License, or</font>
00007 <font class="comment">  (at your option) any later version.</font>
00008 <font class="comment">  </font>
00009 <font class="comment">  This program is distributed in the hope that it will be useful,</font>
00010 <font class="comment">  but WITHOUT ANY WARRANTY; without even the implied warranty of</font>
00011 <font class="comment">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</font>
00012 <font class="comment">  GNU General Public License for more details. (http://www.gnu.org)</font>
00013 <font class="comment">  </font>
00014 <font class="comment">  You should have received a copy of the GNU General Public License</font>
00015 <font class="comment">  along with this program; if not, write to the Free Software</font>
00016 <font class="comment">  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</font>
00017 <font class="comment">  </font>
00018 <font class="comment">  $Id: Matrix4.cpp,v 1.2 2002/06/25 18:33:09 jungd Exp $</font>
00019 <font class="comment">  $Revision: 1.2 $</font>
00020 <font class="comment">  $Date: 2002/06/25 18:33:09 $</font>
00021 <font class="comment">  $Author: jungd $</font>
00022 <font class="comment"> </font>
00023 <font class="comment">****************************************************************************/</font>
00024 
00025 <font class="preprocessor">#include &lt;<a class="code" href="Matrix4.html">base/Matrix4</a>&gt;</font>
00026 
00027 <font class="keyword">using</font> <a class="code" href="classbase_1_1Matrix4.html">base::Matrix4</a>;
00028 <font class="keyword">using</font> <a class="code" href="classbase_1_1Vector4.html">base::Vector4</a>;
00029 <font class="keyword">using</font> <a class="code" href="classbase_1_1Matrix3.html">base::Matrix3</a>;
00030 
00031 <font class="keyword">using</font> std::ostream;
00032 
00033 
00034 <font class="keyword">inline</font> <font class="keyword">static</font> <font class="keywordtype">void</font> exchange(Real&amp; a, Real&amp; b)<font class="keyword"></font>
00035 <font class="keyword"></font>{
00036   Real t(a);
00037   a = b;
00038   b = t;
00039 }
00040 
00041 <font class="comment">// row, col element exchange</font>
00042 <font class="keyword">inline</font> <font class="keyword">static</font> <font class="keywordtype">void</font> rcswap4(Real m[], Int r, Int c)<font class="keyword"> </font>
00043 <font class="keyword"></font>{
00044         Real* rcp = &amp;m[<a class="code" href="Matrix4.html#a0">MATRIX4_ACCESS</a>(r,c)];
00045         Real* crp = &amp;m[<a class="code" href="Matrix4.html#a0">MATRIX4_ACCESS</a>(c,r)];
00046         exchange(*rcp, *crp);
00047 }
00048 
00049 
00050 <font class="keywordtype">void</font> Matrix4::setToTranslation(<font class="keyword">const</font> Vector3&amp; trans)<font class="keyword"></font>
00051 <font class="keyword"></font>{
00052   setDiag(<a class="code" href="namespace__base.html#a5">Real</a>(1));
00053   e(1,4) = trans.x;
00054   e(2,4) = trans.y;
00055   e(3,4) = trans.z;
00056 }
00057 
00058 <font class="keywordtype">void</font> Matrix4::setTranslationComponent(<font class="keyword">const</font> Vector3&amp; trans)<font class="keyword"></font>
00059 <font class="keyword"></font>{
00060   e(1,4) = trans.x;
00061   e(2,4) = trans.y;
00062   e(3,4) = trans.z;
00063 }
00064 
00065 <font class="keywordtype">void</font> Matrix4::setRotationAboutZ(Real angle)<font class="keyword"></font>
00066 <font class="keyword"></font>{
00067   Real cosa = <a class="code" href="namespace__base.html#a96">cos</a>(angle);
00068   Real sina = <a class="code" href="namespace__base.html#a95">sin</a>(angle);
00069   setDiag(<a class="code" href="namespace__base.html#a5">Real</a>(1));
00070   e(1,1)=cosa; e(1,2)=-sina;
00071   e(2,1)=sina; e(2,2)=cosa;
00072 }
00073 
00074 
00075 Matrix4&amp; Matrix4::transpose()<font class="keyword"></font>
00076 <font class="keyword"></font>{
00077   rcswap4(m,1,2); rcswap4(m,1,3); rcswap4(m,1,4);
00078   rcswap4(m,2,3); rcswap4(m,2,4);
00079   rcswap4(m,3,4);
00080 
00081   <font class="keywordflow">return</font> *<font class="keyword">this</font>;
00082 }
00083 
00084 
00085 Matrix4&amp; Matrix4::invert()<font class="keyword"></font>
00086 <font class="keyword"></font>{
00087   <font class="comment">// Solve AX = I by solving 4 eqns: Ax = e (for each e a col of I)</font>
00088   Matrix4 I; <font class="comment">// identity</font>
00089   Matrix4 X, A(*<font class="keyword">this</font>);
00090   Vector4 x;
00091   
00092   Matrix4 L,U;
00093   Vector4 Pi;
00094   
00095   A.decomposeLUP(L,U,Pi);
00096   
00097   <font class="keywordflow">for</font>(<font class="keywordtype">int</font> c=1; c&lt;=4; c++) {
00098     x = solveLUP(L,U,Pi,I.column(c));
00099     <font class="keywordflow">for</font>(<font class="keywordtype">int</font> r=1; r&lt;=4; r++) X.e(r,c) = x[r];
00100   }
00101   
00102   <font class="keywordflow">return</font> (*<font class="keyword">this</font> = X);
00103 
00104 }
00105 
00106 
00107 <font class="keywordtype">void</font> Matrix4::decomposeLUP(Matrix4&amp; L, Matrix4&amp; U, Vector4&amp; Pi)<font class="keyword"> const</font>
00108 <font class="keyword"></font>{
00109   Real p,a;
00110   <font class="keywordtype">int</font> kp,i,j,k;
00111   Matrix4 AA(*<font class="keyword">this</font>);
00112 
00113   <font class="keywordflow">for</font>(i=1; i&lt;=4; i++) Pi[i] = i;
00114   <font class="keywordflow">for</font>(k=1; k&lt;=4-1; k++) {
00115     p = <a class="code" href="namespace__base.html#a5">Real</a>(0); kp = 1;
00116     <font class="keywordflow">for</font>(i=k; i&lt;=4; i++) {
00117       a = <a class="code" href="namespace__base.html#a5">Real</a>(base::abs(AA.e(i,k)));
00118       <font class="keywordflow">if</font> ( a &gt; p ) {
00119                                 p = a;
00120                                 kp = i;
00121       }
00122     }
00123     <font class="keywordflow">if</font> (p == <a class="code" href="namespace__base.html#a5">Real</a>(0))
00124       <font class="keywordflow">throw</font> std::invalid_argument(<a class="code" href="base.html#a12">Exception</a>(<font class="stringliteral">"matrix is singular"</font>));
00125     
00126     exchange(Pi[k],Pi[kp]);
00127     <font class="keywordflow">for</font>(i=1; i&lt;=4;i++) exchange(AA.e(k,i),AA.e(kp,i));
00128     
00129     <font class="keywordflow">for</font>(i=k+1; i&lt;=4;i++) {
00130       AA.e(i,k) /= AA.e(k,k);
00131       <font class="keywordflow">for</font>(j=k+1; j&lt;=4; j++)
00132         AA.e(i,j) -= AA.e(i,k)*AA.e(k,j);
00133     }
00134   }
00135   
00136   <font class="keywordflow">for</font>(i=1;i&lt;=4;i++) {
00137     <font class="keywordflow">for</font>(j=1;j&lt;=4;j++)
00138       <font class="keywordflow">if</font> (i&gt;j) {
00139         L.e(i,j) = AA.e(i,j); U.e(i,j) = <a class="code" href="namespace__base.html#a5">Real</a>(0);
00140       }
00141       <font class="keywordflow">else</font> {
00142         U.e(i,j) = AA.e(i,j); L.e(i,j) = <a class="code" href="namespace__base.html#a5">Real</a>(0);
00143       }
00144     L.e(i,i) = <a class="code" href="namespace__base.html#a5">Real</a>(1);
00145     
00146   }
00147 
00148 }
00149 
00150 
00151 Vector4 Matrix4::solve(<font class="keyword">const</font> Vector4&amp; b)<font class="keyword"> const</font>
00152 <font class="keyword"></font>{
00153   Matrix4 L,U;
00154   Vector4 Pi;
00155 
00156   decomposeLUP(L,U,Pi);
00157   <font class="keywordflow">return</font> solveLUP(L,U,Pi,b);
00158 }
00159 
00160 
00161 Matrix4&amp; Matrix4::negate() <font class="keywordflow">throw</font>()
00162 {
00163   <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i=0; i&lt;16; i++)
00164     m[i]=-m[i];
00165   <font class="keywordflow">return</font> *<font class="keyword">this</font>;
00166 }
00167 
00168 
00169 <font class="comment">// Operators</font>
00170 
00171 <font class="comment">// multiplication</font>
00172 Matrix4&amp; Matrix4::operator*=(<font class="keyword">const</font> Matrix4&amp; m2)<font class="keyword"></font>
00173 <font class="keyword"></font>{
00174   <font class="comment">// !!! optimize (unroll loops)</font>
00175   Matrix4 tmp;
00176 
00177   <font class="keywordflow">for</font>(<font class="keywordtype">int</font> row=1; row&lt;=4; row++)
00178     <font class="keywordflow">for</font>(<font class="keywordtype">int</font> col=1; col&lt;=4; col++)
00179       tmp.e(row,col) =  (e(row,1) * m2.e(1,col)) + (e(row,2) * m2.e(2,col))
00180                       + (e(row,3) * m2.e(3,col)) + (e(row,4) * m2.e(4,col));
00181  
00182   <font class="keywordflow">return</font> (*<font class="keyword">this</font> = tmp);
00183 }
00184 
00185 <font class="comment">// addition</font>
00186 Matrix4&amp; Matrix4::operator+=(<font class="keyword">const</font> Matrix4&amp; m2)<font class="keyword"></font>
00187 <font class="keyword"></font>{
00188   <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i=0; i&lt;16; i++)
00189     m[i] += m2.m[i];
00190   <font class="keywordflow">return</font> (*this);
00191 }
00192 
00193 <font class="comment">// subtration</font>
00194 Matrix4&amp; Matrix4::operator-=(<font class="keyword">const</font> Matrix4&amp; m2)<font class="keyword"></font>
00195 <font class="keyword"></font>{
00196   <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i=0; i&lt;16; i++)
00197     m[i] -= m2.m[i];
00198   <font class="keywordflow">return</font> (*this);
00199 }
00200 
00201 <font class="comment">// Scalar multiplication</font>
00202 Matrix4&amp; Matrix4::operator*=(<font class="keyword">const</font> Real&amp; s)<font class="keyword"></font>
00203 <font class="keyword"></font>{
00204   <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i=0; i&lt;16; i++)
00205     m[i] *= s;
00206   <font class="keywordflow">return</font> *<font class="keyword">this</font>;
00207 }
00208 
00209 <font class="comment">// Scalar division</font>
00210 Matrix4&amp; Matrix4::operator/=(<font class="keyword">const</font> Real&amp; s)<font class="keyword"></font>
00211 <font class="keyword"></font>{
00212   <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i=0; i&lt;16; i++)
00213     m[i] /= s;
00214   <font class="keywordflow">return</font> *<font class="keyword">this</font>;
00215 }
00216 
00217 
00218 Matrix4::operator Matrix3()<font class="keyword"> const</font>
00219 <font class="keyword"></font>{
00220   Matrix3 r;
00221   r.e(1,1) = e(1,1); r.e(1,2)=e(1,2); r.e(1,3)=e(1,3);
00222   r.e(2,1) = e(2,1); r.e(2,2)=e(2,2); r.e(2,3)=e(2,3);
00223   r.e(3,1) = e(3,1); r.e(3,2)=e(3,2); r.e(3,3)=e(3,3);
00224   <font class="keywordflow">return</font> r;
00225 }
00226 
00227 
00228 <font class="preprocessor">#ifdef USE_OSG</font>
00229 <font class="preprocessor"></font>Matrix4::operator osg::Matrix()<font class="keyword"> const</font>
00230 <font class="keyword"></font>{
00231   <font class="comment">// NB: This relies on the two types having the same</font>
00232   <font class="comment">//  layout (except that Real doesn't have to be a float)</font>
00233   osg::Matrix mat;
00234   <font class="keywordtype">float</font>* _mat = mat.ptr();
00235   <font class="keywordflow">for</font>(Int e=0; e&lt;16; e++)
00236     _mat[e] = m[e];
00237   <font class="keywordflow">return</font> mat;
00238 }
00239 <font class="preprocessor">#endif</font>
00240 <font class="preprocessor"></font>
00241 
00242 Vector4 Matrix4::matrixMulVector(<font class="keyword">const</font> Matrix4&amp; m, <font class="keyword">const</font> Vector4&amp; v)<font class="keyword"> </font>
00243 <font class="keyword"></font>{ <font class="keywordflow">return</font> Vector4(m.m[0]*v.x+m.m[4]*v.y+m.m[8]*v.z+m.m[12]*v.w,
00244                  m.m[1]*v.x+m.m[5]*v.y+m.m[9]*v.z+m.m[13]*v.w,
00245                  m.m[2]*v.x+m.m[6]*v.y+m.m[10]*v.z+m.m[14]*v.w,
00246                  m.m[3]*v.x+m.m[7]*v.y+m.m[11]*v.z+m.m[15]*v.w);
00247 }
00248 
00249 <font class="comment">/* above is equivelent to: (which is slower but easier to read)</font>
00250 <font class="comment">Vector4 Matrix4::matrixMulVector(const Matrix4&amp; m, const Vector4&amp; v) </font>
00251 <font class="comment">{ return Vector4(m.e(1,1)*v.x+m.e(1,2)*v.y+m.e(1,3)*v.z+m.e(1,4)*v.w,</font>
00252 <font class="comment">                 m.e(2,1)*v.x+m.e(2,2)*v.y+m.e(2,3)*v.z+m.e(2,4)*v.w,</font>
00253 <font class="comment">                 m.e(3,1)*v.x+m.e(3,2)*v.y+m.e(3,3)*v.z+m.e(3,4)*v.w,</font>
00254 <font class="comment">                 m.e(4,1)*v.x+m.e(4,2)*v.y+m.e(4,3)*v.z+m.e(4,4)*v.w);</font>
00255 <font class="comment">}</font>
00256 <font class="comment">*/</font>
00257 
00258 Vector4 Matrix4::matrixMulVector(<font class="keyword">const</font> Matrix4&amp; m, <font class="keyword">const</font> Vector3&amp; v)<font class="keyword"> </font>
00259 <font class="keyword"></font>{ <font class="keywordflow">return</font> Vector4(m.m[0]*v.x+m.m[4]*v.y+m.m[8]*v.z+m.m[12],
00260                  m.m[1]*v.x+m.m[5]*v.y+m.m[9]*v.z+m.m[13],
00261                  m.m[2]*v.x+m.m[6]*v.y+m.m[10]*v.z+m.m[14],
00262                  m.m[3]*v.x+m.m[7]*v.y+m.m[11]*v.z+m.m[15]);
00263 }
00264 
00265 Vector4 Matrix4::matrixMulVectorAddVector(<font class="keyword">const</font> Matrix4&amp; m, <font class="keyword">const</font> Vector4&amp; v, <font class="keyword">const</font> Vector4&amp; v2)<font class="keyword"> </font>
00266 <font class="keyword"></font>{ <font class="keywordflow">return</font> Vector4(m.m[0]*v.x+m.m[4]*v.y+m.m[8]*v.z+m.m[12]*v.w+v2.x,
00267                  m.m[1]*v.x+m.m[5]*v.y+m.m[9]*v.z+m.m[13]*v.w+v2.y,
00268                  m.m[2]*v.x+m.m[6]*v.y+m.m[10]*v.z+m.m[14]*v.w+v2.z,
00269                  m.m[3]*v.x+m.m[7]*v.y+m.m[11]*v.z+m.m[15]*v.w+v2.w);
00270 }
00271 
00272 
00273 <font class="comment">// Solve for Ax = b, given LUP decomposition of A as L, U and Pi, and given b, returns x</font>
00274 Vector4 Matrix4::solveLUP(<font class="keyword">const</font> Matrix4&amp; L, <font class="keyword">const</font> Matrix4&amp; U, <font class="keyword">const</font> Vector4&amp; Pi, <font class="keyword">const</font> Vector4&amp; b)<font class="keyword"></font>
00275 <font class="keyword"></font>{
00276   <font class="keywordtype">int</font> i,j;
00277   Vector4 y, x;
00278   Real s;
00279   <font class="comment">// forward subst.</font>
00280   <font class="keywordflow">for</font>(i=1;i&lt;=4;i++) {
00281     s = <a class="code" href="namespace__base.html#a5">Real</a>(0);
00282     <font class="keywordflow">for</font>(j=1;j&lt;=i-1;j++) s += L.e(i,j)*y[j];
00283     y[i] = b[int(Pi[i])] - s;
00284   }
00285   <font class="comment">// backward subst.</font>
00286   <font class="keywordflow">for</font>(i=4;i&gt;=1;i--) {
00287     s = <a class="code" href="namespace__base.html#a5">Real</a>(0);
00288     <font class="keywordflow">for</font>(j=i+1;j&lt;=4;j++) s += U.e(i,j)*x[j];
00289     x[i] = (y[i] - s)/(U.e(i,i));
00290   }
00291   <font class="keywordflow">return</font> x;
00292 }
00293 
00294 <font class="comment">// output</font>
00295 ostream&amp; <a class="code" href="namespace__base.html#a47">base::operator&lt;&lt;</a>(ostream&amp; out, <font class="keyword">const</font> Matrix4&amp; m)<font class="keyword"></font>
00296 <font class="keyword"></font>{
00297   <font class="keywordflow">return</font> out &lt;&lt; m.e(1,1) &lt;&lt; <font class="stringliteral">" "</font> &lt;&lt; m.e(1,2) &lt;&lt; <font class="stringliteral">" "</font> &lt;&lt; m.e(1,3) &lt;&lt; <font class="stringliteral">" "</font> &lt;&lt; m.e(1,4) &lt;&lt; std::endl
00298              &lt;&lt; m.e(2,1) &lt;&lt; <font class="stringliteral">" "</font> &lt;&lt; m.e(2,2) &lt;&lt; <font class="stringliteral">" "</font> &lt;&lt; m.e(2,3) &lt;&lt; <font class="stringliteral">" "</font> &lt;&lt; m.e(2,4) &lt;&lt; std::endl
00299              &lt;&lt; m.e(3,1) &lt;&lt; <font class="stringliteral">" "</font> &lt;&lt; m.e(3,2) &lt;&lt; <font class="stringliteral">" "</font> &lt;&lt; m.e(3,3) &lt;&lt; <font class="stringliteral">" "</font> &lt;&lt; m.e(3,4) &lt;&lt; std::endl
00300              &lt;&lt; m.e(4,1) &lt;&lt; <font class="stringliteral">" "</font> &lt;&lt; m.e(4,2) &lt;&lt; <font class="stringliteral">" "</font> &lt;&lt; m.e(4,3) &lt;&lt; <font class="stringliteral">" "</font> &lt;&lt; m.e(4,4) &lt;&lt; std::endl;
00301 }
00302 
00303 
00304 
00305 
00306 
00307 
00308 
</pre></div><hr><address><small>Generated at Wed Aug 7 10:30:28 2002 for OpenSim by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.8.1 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2001</small></address>
</body>
</html>
