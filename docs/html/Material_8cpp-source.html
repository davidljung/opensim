<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>OpenSim: physics/Material.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>physics/Material.cpp</h1><a href="Material_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/****************************************************************************</span>
00002 <span class="comment">  Copyright (C)1996 David Jung &lt;opensim@pobox.com&gt;</span>
00003 <span class="comment"></span>
00004 <span class="comment">  This program/file is free software; you can redistribute it and/or modify</span>
00005 <span class="comment">  it under the terms of the GNU General Public License as published by</span>
00006 <span class="comment">  the Free Software Foundation; either version 2 of the License, or</span>
00007 <span class="comment">  (at your option) any later version.</span>
00008 <span class="comment">  </span>
00009 <span class="comment">  This program is distributed in the hope that it will be useful,</span>
00010 <span class="comment">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00011 <span class="comment">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00012 <span class="comment">  GNU General Public License for more details. (http://www.gnu.org)</span>
00013 <span class="comment">  </span>
00014 <span class="comment">  You should have received a copy of the GNU General Public License</span>
00015 <span class="comment">  along with this program; if not, write to the Free Software</span>
00016 <span class="comment">  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
00017 <span class="comment"></span>
00018 <span class="comment">  $Id: Material.cpp 1031 2004-02-11 20:46:36Z jungd $</span>
00019 <span class="comment">  $Revision: 1.6 $</span>
00020 <span class="comment">  $Date: 2004-02-11 15:46:36 -0500 (Wed, 11 Feb 2004) $</span>
00021 <span class="comment">  $Author: jungd $</span>
00022 <span class="comment">  </span>
00023 <span class="comment">****************************************************************************/</span>
00024 
00025 <span class="preprocessor">#include &lt;<a class="code" href="Material.html">physics/Material</a>&gt;</span>
00026 
00027 <span class="preprocessor">#include &lt;<a class="code" href="Application.html">base/Application</a>&gt;</span>
00028 <span class="preprocessor">#include &lt;<a class="code" href="VFile.html">base/VFile</a>&gt;</span>
00029 <span class="preprocessor">#include &lt;<a class="code" href="Externalizer.html">base/Externalizer</a>&gt;</span>
00030 <span class="preprocessor">#include &lt;<a class="code" href="externalization__error.html">base/externalization_error</a>&gt;</span>
00031 <span class="preprocessor">#include &lt;<a class="code" href="Vector.html">base/Vector</a>&gt;</span>
00032 <span class="preprocessor">#include &lt;<a class="code" href="Color3.html">gfx/Color3</a>&gt;</span>
00033 <span class="preprocessor">#include &lt;<a class="code" href="Color4.html">gfx/Color4</a>&gt;</span>
00034 
00035 <span class="preprocessor">#include &lt;osg/Material&gt;</span>
00036 <span class="preprocessor">#include &lt;osg/Texture2D&gt;</span>
00037 <span class="preprocessor">#include &lt;osg/Vec4&gt;</span>
00038 <span class="preprocessor">#include &lt;osgDB/ReadFile&gt;</span>
00039 
00040 
00041 <span class="keyword">using</span> <a class="code" href="classbase_1_1Application.html">base::Application</a>;
00042 <span class="keyword">using</span> <a class="code" href="classbase_1_1VFile.html">base::VFile</a>;
00043 <span class="keyword">using</span> <a class="code" href="classbase_1_1vector.html">base::Vector</a>;
00044 <span class="keyword">using</span> <a class="code" href="classbase_1_1externalization__error.html">base::externalization_error</a>;
00045 
00046 <span class="keyword">using</span> base::dom::DOMNode;
00047 <span class="keyword">using</span> base::dom::DOMElement;
00048 
00049 <span class="keyword">using</span> <a class="code" href="classphysics_1_1Material.html">physics::Material</a>;
00050 <span class="keyword">using</span> <a class="code" href="classgfx_1_1Color3.html">gfx::Color3</a>;
00051 <span class="keyword">using</span> <a class="code" href="classgfx_1_1Color4.html">gfx::Color4</a>;
00052 
00053 <span class="keyword">using</span> osg::Vec4;
00054 <span class="keyword">using</span> osg::StateSet;
00055 
00056 
00057 Material::Material(<span class="keyword">const</span> String&amp; label, <span class="keyword">const</span> <a class="code" href="classgfx_1_1Color4.html">gfx::Color4</a>&amp; color)
00058         : label(label), mDensity(1.0), 
00059           surfaceAppearanceType(BaseColor),
00060           mBaseColor(color),
00061           stateSetCached(false)
00062 {
00063 }
00064 
00065 
00066 Material::Material(<span class="keyword">const</span> Material&amp; m)
00067   : label(m.label), mDensity(m.mDensity), 
00068     surfaceAppearanceType(m.surfaceAppearanceType),
00069     mBaseColor(m.mBaseColor),
00070     surfaceTextureImage(m.surfaceTextureImage),
00071     stateSetCached(m.stateSetCached),
00072     stateSet(m.stateSet)
00073 {
00074 }
00075 
00076 
00077 Material::~Material()
00078 {
00079 }
00080 
00081 
00082 <span class="keywordtype">void</span> Material::setSurfaceAppearance(<span class="keyword">const</span> <a class="code" href="classbase_1_1PathName.html">base::PathName</a>&amp; image)
00083 {
00084   <a class="code" href="classphysics_1_1Material.html#physics_1_1Materialp2">surfaceAppearanceType</a> = <a class="code" href="classphysics_1_1Material.html#physics_1_1Materialx2physics_1_1Materialx1">TextureImage</a>;
00085   <a class="code" href="classphysics_1_1Material.html#physics_1_1Materialp4">surfaceTextureImage</a> = image;
00086   <a class="code" href="classphysics_1_1Material.html#physics_1_1Materialp5">stateSetCached</a> = <span class="keyword">false</span>;
00087 }
00088 
00089 
00090 osg::ref_ptr&lt;osg::StateSet&gt; Material::createState()<span class="keyword"> const</span>
00091 <span class="keyword"></span>{
00092   <span class="keywordflow">if</span> (<a class="code" href="classphysics_1_1Material.html#physics_1_1Materialp5">stateSetCached</a>) <span class="keywordflow">return</span> <a class="code" href="classphysics_1_1Material.html#physics_1_1Materialp6">stateSet</a>;
00093 
00094   osg::ref_ptr&lt;StateSet&gt; state = <span class="keyword">new</span> osg::StateSet();
00095   osg::ref_ptr&lt;osg::Material&gt; mat = <span class="keyword">new</span> osg::Material();
00096   Vec4 col( (<span class="keywordtype">float</span>)<a class="code" href="classphysics_1_1Material.html#physics_1_1Materiala7">baseColor</a>().r, 
00097             (<span class="keywordtype">float</span>)<a class="code" href="classphysics_1_1Material.html#physics_1_1Materiala7">baseColor</a>().g, 
00098             (<span class="keywordtype">float</span>)<a class="code" href="classphysics_1_1Material.html#physics_1_1Materiala7">baseColor</a>().b, 
00099             (<span class="keywordtype">float</span>)<a class="code" href="classphysics_1_1Material.html#physics_1_1Materiala7">baseColor</a>().a );
00100   mat-&gt;setEmission( osg::Material::FRONT_AND_BACK, Vec4(0,0,0,0) );
00101   mat-&gt;setAmbient( osg::Material::FRONT_AND_BACK, col );
00102   mat-&gt;setDiffuse( osg::Material::FRONT_AND_BACK, col );
00103   mat-&gt;setSpecular( osg::Material::FRONT_AND_BACK, Vec4(1,1,1,0) );
00104   mat-&gt;setShininess( osg::Material::FRONT_AND_BACK, 128);
00105   mat-&gt;setAlpha( osg::Material::FRONT_AND_BACK, (<span class="keywordtype">float</span>)<a class="code" href="classphysics_1_1Material.html#physics_1_1Materiala7">baseColor</a>().a );
00106   state-&gt;setAttribute( &amp;(*mat) );
00107   <span class="keywordflow">if</span> (!Math::equals(<a class="code" href="classphysics_1_1Material.html#physics_1_1Materiala7">baseColor</a>().a, 1.0)) {
00108     state-&gt;setMode(GL_BLEND, osg::StateAttribute::ON);
00109     state-&gt;setRenderingHint( osg::StateSet::TRANSPARENT_BIN );
00110   }
00111 
00112   <span class="keywordflow">if</span> (<a class="code" href="classphysics_1_1Material.html#physics_1_1Materialp2">surfaceAppearanceType</a> == <a class="code" href="classphysics_1_1Material.html#physics_1_1Materialx2physics_1_1Materialx1">TextureImage</a>) {
00113 
00114     ref&lt;VFile&gt; imageFile(Application::getInstance()-&gt;universe()-&gt;cache()-&gt;findFile(surfaceTextureImage));
00115 
00116     <span class="comment">// load image</span><span class="comment"></span>
00117 <span class="comment">    ///!!! unfortunately, the osgDB only reads from filesystem files, not</span>
00118 <span class="comment">    ///    streams, so we only support files here for now</span>
00119 <span class="comment"></span>    <a class="code" href="namespacebase.html#a4">String</a> filename( imageFile-&gt;pathName().str() );
00120 
00121     osg::ref_ptr&lt;osg::Image&gt; image = osgDB::readImageFile(filename);
00122     <span class="keywordflow">if</span> (image == (osg::Image*)0)
00123       <span class="keywordflow">throw</span> std::runtime_error(<a class="code" href="base.html#a15">Exception</a>(<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"unable to read texture image file:"</span>)+filename));
00124 
00125     osg::ref_ptr&lt;osg::Texture2D&gt; texture = <span class="keyword">new</span> osg::Texture2D();
00126     texture-&gt;setImage(&amp;(*image));
00127     texture-&gt;setFilter(osg::Texture2D::MIN_FILTER,osg::Texture2D::LINEAR_MIPMAP_NEAREST);
00128     texture-&gt;setFilter(osg::Texture2D::MAG_FILTER,osg::Texture2D::LINEAR);
00129     texture-&gt;setInternalFormatMode(osg::Texture2D::USE_ARB_COMPRESSION);
00130     texture-&gt;setWrap(osg::Texture2D::WRAP_S,osg::Texture2D::REPEAT);
00131     texture-&gt;setWrap(osg::Texture2D::WRAP_T,osg::Texture2D::REPEAT);
00132 
00133     state-&gt;setTextureAttributeAndModes(0,&amp;(*texture),osg::StateAttribute::ON);
00134   }
00135 
00136   <a class="code" href="classphysics_1_1Material.html#physics_1_1Materialp5">stateSetCached</a> = <span class="keyword">true</span>;
00137   <a class="code" href="classphysics_1_1Material.html#physics_1_1Materialp6">stateSet</a> = state;
00138 
00139   <span class="keywordflow">return</span> <a class="code" href="classphysics_1_1Material.html#physics_1_1Materialp6">stateSet</a>;
00140 }
00141 
00142 
00143 <span class="keywordtype">void</span> Material::externalize(<a class="code" href="classbase_1_1Externalizer.html">base::Externalizer</a>&amp; e, String format, Real version)
00144 {
00145   <span class="keywordflow">if</span> (format==<span class="stringliteral">""</span>) format=<span class="stringliteral">"xml"</span>;
00146 
00147   <span class="keywordflow">if</span> (!<a class="code" href="classphysics_1_1Material.html#physics_1_1Materiala12">formatSupported</a>(format,version,e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera6">ioType</a>()))
00148     <span class="keywordflow">throw</span> std::invalid_argument(<a class="code" href="base.html#a15">Exception</a>(<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"format "</span>)+format+<span class="stringliteral">" v"</span>+base::realToString(version)+<span class="stringliteral">" unsupported"</span>));
00149   
00150   <span class="keywordflow">if</span> (format == <span class="stringliteral">"xml"</span>) {
00151 
00152     <span class="keywordflow">if</span> (e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera4">isOutput</a>()) {
00153 
00154       DOMElement* matElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"material"</span>);
00155       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera26">setElementAttribute</a>(matElem,<span class="stringliteral">"name"</span>,label);
00156       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera26">setElementAttribute</a>(matElem,<span class="stringliteral">"type"</span>,<span class="stringliteral">"simple"</span>);
00157       
00158       DOMElement* dElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"density"</span>,<span class="keyword">false</span>);
00159       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera29">appendText</a>(dElem, base::realToString(mDensity));
00160       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera34">appendNode</a>(matElem,dElem);
00161       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera22">appendBreak</a>(matElem);
00162 
00163       DOMElement* cElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"basecolor"</span>,<span class="keyword">false</span>);
00164       <a class="code" href="classdemeter_1_1Vector.html">Vector</a> c(3);
00165       c[0]=<a class="code" href="classphysics_1_1Material.html#physics_1_1Materialp3">mBaseColor</a>.<a class="code" href="classgfx_1_1Color4.html#gfx_1_1Color4o0">r</a>; c[1]=<a class="code" href="classphysics_1_1Material.html#physics_1_1Materialp3">mBaseColor</a>.<a class="code" href="classgfx_1_1Color4.html#gfx_1_1Color4o1">g</a>; c[2]=<a class="code" href="classphysics_1_1Material.html#physics_1_1Materialp3">mBaseColor</a>.<a class="code" href="classgfx_1_1Color4.html#gfx_1_1Color4o2">b</a>;
00166       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera29">appendText</a>(cElem, e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere5">toString</a>(c,<span class="keyword">true</span>));
00167       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera34">appendNode</a>(matElem,cElem);
00168       
00169       <span class="keywordflow">if</span> (<a class="code" href="classphysics_1_1Material.html#physics_1_1Materialp2">surfaceAppearanceType</a> == <a class="code" href="classphysics_1_1Material.html#physics_1_1Materialx2physics_1_1Materialx1">TextureImage</a>) {
00170         DOMElement* saElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(<span class="stringliteral">"surfaceappearance"</span>,<span class="keyword">false</span>);
00171         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera26">setElementAttribute</a>(saElem,<span class="stringliteral">"type"</span>,<span class="stringliteral">"image"</span>);
00172         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera29">appendText</a>(saElem, <a class="code" href="classphysics_1_1Material.html#physics_1_1Materialp4">surfaceTextureImage</a>.<a class="code" href="classbase_1_1PathName.html#base_1_1PathNamea7">str</a>() );
00173         e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera34">appendNode</a>(matElem,saElem);
00174       }
00175 
00176       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera21">appendElement</a>(matElem);
00177 
00178     }
00179     <span class="keywordflow">else</span> { <span class="comment">// input</span>
00180 
00181       DOMNode* context = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera16">context</a>();
00182     
00183       DOMElement* matElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(context, <span class="stringliteral">"material"</span>);
00184 
00185       <span class="keywordflow">if</span> ( e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera41">getElementAttribute</a>(matElem, <span class="stringliteral">"type"</span>) != <span class="stringliteral">"simple"</span> )
00186         <span class="keywordflow">throw</span> externalization_error(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"unsupported material type"</span>));
00187 
00188       <a class="code" href="classphysics_1_1Material.html#physics_1_1Materialp0">label</a> = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera42">getDefaultedElementAttribute</a>(matElem, <span class="stringliteral">"name"</span>, <span class="stringliteral">"untitled"</span>);
00189 
00190       DOMElement* dElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(matElem, <span class="stringliteral">"density"</span>, <span class="keyword">false</span>);
00191       <span class="keywordflow">if</span> (dElem) {
00192         <a class="code" href="namespacebase.html#a4">String</a> densityText = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera40">getContainedText</a>(dElem);
00193         <a class="code" href="classphysics_1_1Material.html#physics_1_1Materialp1">mDensity</a> = <a class="code" href="namespacebase.html#a53">base::stringToReal</a>(densityText);
00194       }
00195       <span class="keywordflow">else</span>
00196         <a class="code" href="classphysics_1_1Material.html#physics_1_1Materialp1">mDensity</a>=1.0;
00197 
00198       <a class="code" href="classphysics_1_1Material.html#physics_1_1Materialp2">surfaceAppearanceType</a> = <a class="code" href="classphysics_1_1Material.html#physics_1_1Materialx2physics_1_1Materialx0">BaseColor</a>;
00199       DOMElement* cElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(matElem, <span class="stringliteral">"basecolor"</span>,<span class="keyword">false</span>);
00200       <span class="keywordflow">if</span> (cElem) {
00201         <a class="code" href="namespacebase.html#a4">String</a> colorText = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera40">getContainedText</a>(cElem);
00202         Vector3 cv( e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere6">toVector3</a>(colorText) );
00203         <a class="code" href="classphysics_1_1Material.html#physics_1_1Materialp3">mBaseColor</a> = Color3(cv.x,cv.y,cv.z);
00204       }
00205       <span class="keywordflow">else</span>
00206         <a class="code" href="classphysics_1_1Material.html#physics_1_1Materialp3">mBaseColor</a> = Color3(0,1,0);
00207 
00208 
00209       DOMElement* saElem = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(matElem, <span class="stringliteral">"surfaceappearance"</span>,<span class="keyword">false</span>);
00210       <span class="keywordflow">if</span> (saElem) {
00211         <a class="code" href="namespacebase.html#a4">String</a> type = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera42">getDefaultedElementAttribute</a>(saElem,<span class="stringliteral">"type"</span>,<span class="stringliteral">"image"</span>);
00212         <span class="keywordflow">if</span> (type == <span class="stringliteral">"image"</span>) {
00213           <a class="code" href="classphysics_1_1Material.html#physics_1_1Materialp2">surfaceAppearanceType</a> = <a class="code" href="classphysics_1_1Material.html#physics_1_1Materialx2physics_1_1Materialx1">TextureImage</a>;
00214           <a class="code" href="classphysics_1_1Material.html#physics_1_1Materialp4">surfaceTextureImage</a> = e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera40">getContainedText</a>(saElem);
00215         }
00216         <span class="keywordflow">else</span>
00217           <span class="keywordflow">throw</span> externalization_error(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"unsupported value of 'type' attribute of element 'surfaceappearance'"</span>));
00218       }
00219 
00220 
00221 
00222       e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera39">removeElement</a>(matElem);
00223 
00224     }
00225 
00226   }
00227 
00228 }
00229 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Jul 29 15:56:24 2004 for OpenSim by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.6 </small></address>
</body>
</html>
