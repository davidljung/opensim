<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>OpenSim: base/Externalizer.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>base/Externalizer.cpp</h1><a href="Externalizer_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/****************************************************************************</span>
00002 <span class="comment">  Copyright (C)2002 David Jung &lt;opensim@pobox.com&gt;</span>
00003 <span class="comment"></span>
00004 <span class="comment">  This program/file is free software; you can redistribute it and/or modify</span>
00005 <span class="comment">  it under the terms of the GNU General Public License as published by</span>
00006 <span class="comment">  the Free Software Foundation; either version 2 of the License, or</span>
00007 <span class="comment">  (at your option) any later version.</span>
00008 <span class="comment">  </span>
00009 <span class="comment">  This program is distributed in the hope that it will be useful,</span>
00010 <span class="comment">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00011 <span class="comment">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00012 <span class="comment">  GNU General Public License for more details. (http://www.gnu.org)</span>
00013 <span class="comment">  </span>
00014 <span class="comment">  You should have received a copy of the GNU General Public License</span>
00015 <span class="comment">  along with this program; if not, write to the Free Software</span>
00016 <span class="comment">  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
00017 <span class="comment">  </span>
00018 <span class="comment">  $Id: Externalizer.cpp 1067 2004-02-27 21:09:46Z jungd $</span>
00019 <span class="comment">  $Revision: 1.5 $</span>
00020 <span class="comment">  $Date: 2004-02-27 16:09:46 -0500 (Fri, 27 Feb 2004) $</span>
00021 <span class="comment">  $Author: jungd $</span>
00022 <span class="comment"> </span>
00023 <span class="comment">****************************************************************************/</span>
00024 
00025 <span class="preprocessor">#include &lt;<a class="code" href="Externalizer.html">base/Externalizer</a>&gt;</span>
00026 
00027 <span class="preprocessor">#include &lt;<a class="code" href="Application.html">base/Application</a>&gt;</span>
00028 <span class="preprocessor">#include &lt;<a class="code" href="Math.html">base/Math</a>&gt;</span>
00029 <span class="preprocessor">#include &lt;<a class="code" href="Externalizable.html">base/Externalizable</a>&gt;</span>
00030 <span class="preprocessor">#include &lt;<a class="code" href="externalization__error.html">base/externalization_error</a>&gt;</span>
00031 <span class="preprocessor">#include &lt;<a class="code" href="io__error.html">base/io_error</a>&gt;</span>
00032 
00033 <span class="preprocessor">#include &lt;cstdio&gt;</span>
00034 
00035 <span class="keyword">using</span> <a class="code" href="classbase_1_1Externalizer.html">base::Externalizer</a>;
00036 <span class="keyword">using</span> <a class="code" href="classbase_1_1Externalizable.html">base::Externalizable</a>;
00037 <span class="keyword">using</span> <a class="code" href="classbase_1_1VFile.html">base::VFile</a>;
00038 <span class="keyword">using</span> <a class="code" href="classbase_1_1Math.html">base::Math</a>;
00039 
00040 <span class="keyword">using</span> base::dom;
00041 
00042 <span class="keyword">using</span> std::iostream;
00043 <span class="keyword">using</span> std::istream;
00044 <span class="keyword">using</span> std::ostream;
00045 
00046 <span class="keywordtype">bool</span> Externalizer::xmlInitialized = <span class="keyword">false</span>;
00047 
00048 
00049 
00050 <span class="keyword">const</span> <a class="code" href="namespacebase.html#a4">String</a> Externalizer::newline = <a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"\n"</span>);
00051 
00052 
00053 Externalizer::Externalizer(Externalizable::ExternalizationType type, ref&lt;VFile&gt; archive) 
00054   : xmlMode(false), impl(0), doctype(0), isoutput(type &amp; Externalizable::Output), aborted(false),
00055     istream(isoutput?0:&amp;archive-&gt;iostream(iostream::in)),
00056     ostream(isoutput?&amp;archive-&gt;iostream(iostream::out):0),
00057     path(archive-&gt;path())
00058 {
00059 }
00060 
00061 Externalizer::Externalizer(Externalizable::ExternalizationType type, std::ios&amp; stream) 
00062   : xmlMode(false), impl(0), doctype(0), isoutput(type &amp; Externalizable::Output), aborted(false),
00063     path(<a class="code" href="namespacebase.html#a4">String</a>())
00064 {
00065   <a class="code" href="base.html#a19">Assert</a>(isoutput?<a class="code" href="base.html#a25">instanceof</a>(stream, std::ostream)
00066                  :<a class="code" href="base.html#a25">instanceof</a>(stream, std::istream));
00067   <span class="keywordflow">if</span> (<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp7">isoutput</a>) 
00068     <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp10">ostream</a> = dynamic_cast&lt;std::ostream*&gt;(&amp;stream);
00069   <span class="keywordflow">else</span> 
00070     <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp9">istream</a> = dynamic_cast&lt;std::istream*&gt;(&amp;stream);
00071 }
00072 
00073 
00074 Externalizer::~Externalizer()
00075 {
00076   <span class="keywordflow">if</span> (<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp0">xmlMode</a>) {
00077     <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerb5">xmlWriteDocument</a>(xmldoc);
00078     <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerb6">xmlReleaseDocument</a>();
00079   }
00080 }
00081 
00082 
00083 <span class="keyword">const</span> <a class="code" href="namespacebase.html#a4">String</a> Externalizer::inputToConstErrorString(<span class="stringliteral">"cannot input to a const variable"</span>);
00084 <span class="keyword">const</span> <a class="code" href="namespacebase.html#a4">String</a> Externalizer::inputDuringOutputErrorString(<span class="stringliteral">"cannot input from an output Externalizer"</span>);
00085 
00086 
00087 <span class="keywordtype">void</span> Externalizer::flush()
00088 {
00089   <span class="keywordflow">if</span> (!<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp0">xmlMode</a>)
00090     <span class="keywordflow">if</span> (<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp7">isoutput</a>) 
00091       (*ostream) &lt;&lt; std::flush;
00092 }
00093 
00094 
00095 <a class="code" href="namespacebase.html#a4">String</a> Externalizer::readLine()
00096 {
00097   <span class="keywordflow">if</span> (<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera4">isOutput</a>()) <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerb12">abort</a>(inputDuringOutputErrorString);
00098     
00099   <span class="keywordflow">if</span> (!<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp0">xmlMode</a>) {
00100     <span class="keywordtype">char</span> linebuf[1024];
00101     <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp9">istream</a>-&gt;getline(linebuf,1024);
00102     linebuf[1023]=char(0);
00103     <span class="keywordflow">return</span> <a class="code" href="namespacebase.html#a4">String</a>(linebuf);
00104   }
00105   <span class="keywordflow">else</span> {
00106     <a class="code" href="debugtools.html#a12">Unimplemented</a>;
00107   }
00108 }
00109 
00110 
00111 <a class="code" href="namespacebase.html#a4">String</a> Externalizer::readString(SInt maxLength)
00112 {
00113   <span class="keywordflow">if</span> (<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera4">isOutput</a>()) <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerb12">abort</a>(inputDuringOutputErrorString);
00114   
00115   <span class="keywordflow">if</span> (!<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp0">xmlMode</a>) {
00116     <span class="keywordtype">char</span>* buf = <span class="keyword">new</span> <span class="keywordtype">char</span>[maxLength+1];
00117     
00118     <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerb1">input</a>().readsome(buf, maxLength);
00119     buf[maxLength] = 0;
00120     
00121     <a class="code" href="namespacebase.html#a4">String</a> str(buf);
00122     <span class="keyword">delete</span>[] buf;
00123     
00124     <span class="keywordflow">return</span> str;
00125   }
00126   <span class="keywordflow">else</span> {
00127     <a class="code" href="debugtools.html#a12">Unimplemented</a>;
00128   }
00129 }
00130 
00131 
00132 <span class="keywordtype">void</span> Externalizer::writeLine(<span class="keyword">const</span> String&amp; line)
00133 {
00134   <span class="keywordflow">if</span> (!<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera4">isOutput</a>()) <span class="keywordflow">return</span>;
00135 
00136   <span class="keywordflow">if</span> (!<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp0">xmlMode</a>) {
00137     <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerb2">output</a>() &lt;&lt; line &lt;&lt; std::endl;
00138   }
00139   <span class="keywordflow">else</span> {
00140     <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera29">appendText</a>(<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp5">xmlcontext</a>.top(), line);
00141   }
00142 }
00143 
00144 
00145 <span class="keywordtype">void</span> Externalizer::writeString(<span class="keyword">const</span> String&amp; str)
00146 {
00147   <span class="keywordflow">if</span> (!<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera4">isOutput</a>()) <span class="keywordflow">return</span>;
00148 
00149   <span class="keywordflow">if</span> (!<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp0">xmlMode</a>) {
00150     <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerb2">output</a>() &lt;&lt; str;
00151   }
00152   <span class="keywordflow">else</span> {
00153   }
00154 }
00155 
00156 <span class="keywordtype">void</span> Externalizer::writeComment(<span class="keyword">const</span> String&amp; comment)
00157 {
00158   <span class="keywordflow">if</span> (!<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera4">isOutput</a>()) <span class="keywordflow">return</span>;
00159 
00160   <span class="keywordflow">if</span> (!<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp0">xmlMode</a>)
00161     <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera12">writeLine</a>(<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"# "</span>)+comment);
00162   <span class="keywordflow">else</span> {
00163     <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera31">appendComment</a>(<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp5">xmlcontext</a>.top(), comment);
00164   }
00165     
00166 }
00167 
00168 
00169 
00170 <span class="comment">// XML stuff</span>
00171 
00172 <span class="keywordtype">void</span> Externalizer::initXMLDoc(<span class="keyword">const</span> String&amp; rootElementName)
00173 {
00174   <span class="keywordflow">if</span> (<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp0">xmlMode</a>) <span class="keywordflow">return</span>;
00175 
00176   <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerf0">xmlInitialize</a>();
00177 
00178   <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp1">parser</a> = 0; <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp4">xmldoc</a> = 0; 
00179   <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp2">impl</a> = dom::DOMImplementationRegistry::getDOMImplementation(XS(<span class="stringliteral">"LS"</span>));
00180   <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp0">xmlMode</a> = <span class="keyword">true</span>;
00181 
00182   <span class="keywordflow">if</span> (<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera5">isInput</a>()) {
00183     <span class="comment">// parse the whole document</span>
00184     <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp4">xmldoc</a> = <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerb4">xmlParseDocument</a>();
00185     <a class="code" href="base.html#a19">Assert</a>(xmldoc);
00186     dom::DOMElement* docElem = <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp4">xmldoc</a>-&gt;getDocumentElement();
00187     <span class="keywordflow">if</span> (!docElem)
00188       <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">base::externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"failed to obtain XML document element - invalid XML document."</span>));
00189 
00190     <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp5">xmlcontext</a>.push( docElem );
00191    }
00192   <span class="keywordflow">else</span> { <span class="comment">// output</span>
00193     <span class="comment">// create a new document</span>
00194     <span class="keywordflow">try</span> {
00195       <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp4">xmldoc</a> = <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp2">impl</a>-&gt;createDocument(
00196                                   XS(<span class="stringliteral">"http://www.w3.org/XML/1998/namespace"</span>),                    <span class="comment">// root element namespace URI</span>
00197                                   XS(rootElementName),  <span class="comment">// root element name</span>
00198                                   doctype);             <span class="comment">// document type </span>
00199     } <span class="keywordflow">catch</span> (dom::DOMException&amp; e) {
00200       <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerb12">abort</a>(<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"error creating document:"</span>)+<a class="code" href="namespacebase.html#a4">String</a>(XS(e.msg)) );
00201     }
00202     <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp5">xmlcontext</a>.push( <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp4">xmldoc</a>-&gt;getDocumentElement() );
00203     <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp5">xmlcontext</a>.top()-&gt;appendChild(<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp4">xmldoc</a>-&gt;createTextNode(XS(newline)));
00204   }
00205   
00206 }
00207 
00208 
00209 dom::DOMElement* Externalizer::createElement(<span class="keyword">const</span> String&amp; tagname, <span class="keywordtype">bool</span> indenting)
00210 {
00211   dom::DOMElement* elem;
00212   
00213   <span class="keywordflow">if</span> (!<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp0">xmlMode</a>) { <span class="comment">// first element for document?</span>
00214     <a class="code" href="namespacebase.html#a4">String</a> name(tagname);
00215     <span class="keywordflow">if</span> (name == <span class="stringliteral">""</span>) name = <a class="code" href="classbase_1_1Application.html#base_1_1Applicatione1">base::Application::getShortName</a>();
00216     <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerb3">initXMLDoc</a>(tagname);
00217     elem = <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp4">xmldoc</a>-&gt;getDocumentElement();
00218   }
00219   <span class="keywordflow">else</span>
00220     elem = <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp4">xmldoc</a>-&gt;createElement(XS(tagname));
00221   
00222   <span class="comment">// add a newline as the first child of the element so</span>
00223   <span class="comment">//  that the formatter knows to indent</span>
00224   <span class="keywordflow">if</span> (indenting)
00225     elem-&gt;appendChild(<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp4">xmldoc</a>-&gt;createTextNode(XS(newline)));
00226 
00227   <span class="keywordflow">return</span> elem;
00228 }
00229 
00230 
00231 <span class="keywordtype">void</span> Externalizer::appendElement(dom::DOMNode* n, <span class="keyword">const</span> String&amp; tagname, <span class="keywordtype">bool</span> indenting)
00232 {
00233   n-&gt;appendChild( <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera18">createElement</a>(tagname, indenting) );
00234 }
00235 
00236 
00237 <span class="keywordtype">void</span> Externalizer::appendProcessingInstruction(dom::DOMNode* n, <span class="keyword">const</span> String&amp; target, <span class="keyword">const</span> String&amp; data)
00238 {
00239   <a class="code" href="base.html#a19">Assert</a>(xmlMode);
00240   dom::DOMProcessingInstruction* pi = <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp4">xmldoc</a>-&gt;createProcessingInstruction(XS(target), XS(data));
00241   n-&gt;appendChild(pi);
00242 }
00243 
00244 
00245 <span class="keywordtype">void</span> Externalizer::setDocumentType(<span class="keyword">const</span> String&amp; name, <span class="keyword">const</span> String&amp; publicid, <span class="keyword">const</span> String&amp; sysid)
00246 {
00247   <span class="keywordflow">if</span> (<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp3">doctype</a>) <span class="keywordflow">return</span>; <span class="comment">// already set</span>
00248   
00249   <span class="keywordflow">if</span> (!<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp2">impl</a>)
00250     <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp2">impl</a> = dom::DOMImplementationRegistry::getDOMImplementation(XS(<span class="stringliteral">"LS"</span>));
00251   
00252   <span class="keywordflow">try</span> {
00253     <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp3">doctype</a> = <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp2">impl</a>-&gt;createDocumentType(XS(name),XS(publicid), XS(sysid));
00254   } <span class="keywordflow">catch</span> (dom::DOMException&amp; e) {
00255     <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerb12">abort</a>(<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"error setting document type:"</span>)+<a class="code" href="namespacebase.html#a4">String</a>(XS(e.msg)) );
00256   }
00257 
00258 }
00259 
00260   
00261 
00262 dom::DOMText* Externalizer::createText(<span class="keyword">const</span> String&amp; text)
00263 {
00264   <a class="code" href="base.html#a19">Assert</a>(xmlMode);
00265   <span class="keywordflow">return</span> <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp4">xmldoc</a>-&gt;createTextNode(XS(text));
00266 }
00267 
00268 
00269 <span class="keywordtype">void</span> Externalizer::appendText(dom::DOMNode* n, <span class="keyword">const</span> String&amp; text)
00270 {
00271   n-&gt;appendChild( <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera28">createText</a>(text) );
00272 }
00273 
00274 
00275 dom::DOMComment* Externalizer::createComment(<span class="keyword">const</span> String&amp; comment)
00276 {   
00277   <a class="code" href="base.html#a19">Assert</a>(xmlMode);
00278   <span class="keywordflow">return</span> <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp4">xmldoc</a>-&gt;createComment(XS(comment));
00279 }
00280 
00281 
00282 <span class="keywordtype">void</span> Externalizer::appendComment(dom::DOMNode* n, <span class="keyword">const</span> String&amp; comment)
00283 {
00284   n-&gt;appendChild( <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera30">createComment</a>(comment) );
00285 }
00286 
00287 
00288 dom::DOMCDATASection* Externalizer::createCDATA(<span class="keyword">const</span> String&amp; text)
00289 {
00290   <a class="code" href="base.html#a19">Assert</a>(xmlMode);
00291   <span class="keywordflow">return</span> <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp4">xmldoc</a>-&gt;createCDATASection(XS(text));
00292 }
00293 
00294 
00295 <span class="keywordtype">void</span> Externalizer::appendCDATA(dom::DOMNode* n, <span class="keyword">const</span> String&amp; text)
00296 {
00297   <a class="code" href="base.html#a19">Assert</a>(xmlMode);
00298   n-&gt;appendChild( <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera32">createCDATA</a>(text) );
00299 }
00300 <span class="comment"></span>
00301 <span class="comment">/// get first element with name tagname, either n or its immediate children</span>
00302 <span class="comment"></span>dom::DOMElement* Externalizer::getFirstElement(dom::DOMNode* n, <span class="keyword">const</span> String&amp; tagname, <span class="keywordtype">bool</span> required)
00303 {
00304   <a class="code" href="base.html#a19">Assert</a>(xmlMode);
00305 
00306   <span class="keywordflow">if</span> (<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerb10">isElement</a>(n, tagname)) <span class="comment">// is n an element with name tagname?</span>
00307     <span class="keywordflow">return</span> dynamic_cast&lt;dom::DOMElement*&gt;(n);
00308   <span class="keywordflow">else</span> <span class="comment">// no, look in children</span>
00309     <span class="keywordflow">return</span> <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera37">getFirstChildElement</a>(n, tagname, required);
00310 }
00311 <span class="comment"></span>
00312 <span class="comment">/// get first immediate child element of n with name tagname</span>
00313 <span class="comment"></span>dom::DOMElement* Externalizer::getFirstChildElement(dom::DOMNode* n, <span class="keyword">const</span> String&amp; tagname, <span class="keywordtype">bool</span> required)
00314 {
00315   <a class="code" href="base.html#a19">Assert</a>(xmlMode);
00316   dom::DOMElement* e = 0;
00317 
00318   <span class="keywordflow">if</span> (n-&gt;hasChildNodes()) {
00319     dom::DOMNode* c = n-&gt;getFirstChild();
00320     <span class="keywordflow">while</span> (c &amp;&amp; (e==0) ) {
00321       <span class="keywordflow">if</span> (<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerb10">isElement</a>(c, tagname))
00322         e = dynamic_cast&lt;dom::DOMElement*&gt;(c);
00323       
00324       c = c-&gt;getNextSibling();
00325     }
00326     
00327   }
00328   
00329   <span class="keywordflow">if</span> (required &amp;&amp; (e==0)) {
00330     <a class="code" href="namespacebase.html#a4">String</a> pstr;
00331     <span class="keywordflow">if</span> (<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerb10">isElement</a>(n))
00332       pstr = <span class="stringliteral">" within element '"</span>+<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera24">elementTagName</a>(n)+<span class="stringliteral">"'"</span>;
00333     <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerb12">abort</a>(<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"expected element '"</span>)+tagname+<span class="stringliteral">"'"</span>+pstr);
00334   }
00335 
00336   <span class="keywordflow">return</span> e;
00337 }
00338 
00339 
00340 dom::DOMElement* Externalizer::getNextSiblingElement(dom::DOMNode* n, <span class="keyword">const</span> String&amp; tagname, <span class="keywordtype">bool</span> required)
00341 {
00342   <a class="code" href="base.html#a19">Assert</a>(xmlMode);
00343   dom::DOMElement* e = 0;
00344 
00345   dom::DOMNode* c = n-&gt;getNextSibling();
00346   <span class="keywordflow">while</span> (c &amp;&amp; (e == 0)) {
00347     <span class="keywordflow">if</span> (<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerb10">isElement</a>(c, tagname))
00348       e = dynamic_cast&lt;dom::DOMElement*&gt;(c);
00349     
00350     c = c-&gt;getNextSibling();
00351   }
00352 
00353   <span class="keywordflow">if</span> (required &amp;&amp; (e==0))
00354     <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerb12">abort</a>(<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"expected "</span>)+tagname+<span class="stringliteral">" element"</span>);
00355 
00356   <span class="keywordflow">return</span> e;
00357 }
00358 
00359 <span class="comment"></span>
00360 <span class="comment">/// remove element e from the tree (no-op if e is the current context or has no parent)</span>
00361 <span class="comment"></span><span class="keywordtype">void</span> Externalizer::removeElement(dom::DOMElement* e)
00362 {
00363   <a class="code" href="base.html#a19">Assert</a>(xmlMode);
00364   <span class="keywordflow">if</span> (<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera16">context</a>()-&gt;isSameNode(e)) <span class="keywordflow">return</span>;
00365 
00366   dom::DOMNode* p = e-&gt;getParentNode();
00367   <span class="keywordflow">if</span> (p)
00368     p-&gt;removeChild(e);
00369 }
00370 
00371 
00372 <a class="code" href="namespacebase.html#a4">String</a> Externalizer::getContainedText(dom::DOMNode* n, <span class="keywordtype">bool</span> removeIndentation)
00373 {
00374   <a class="code" href="base.html#a19">Assert</a>(xmlMode);
00375   <a class="code" href="namespacebase.html#a4">String</a> text;
00376 
00377   <span class="keywordflow">if</span> (n-&gt;getNodeType() == dom::DOMNode::TEXT_NODE) {
00378     dom::DOMText* t = dynamic_cast&lt;dom::DOMText*&gt;(n);
00379     text += <a class="code" href="namespacebase.html#a4">String</a>(XS(t-&gt;getData()));
00380   }
00381   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (n-&gt;getNodeType() == dom::DOMNode::CDATA_SECTION_NODE) {
00382     dom::DOMCDATASection* cd = dynamic_cast&lt;dom::DOMCDATASection*&gt;(n);
00383     text += <a class="code" href="namespacebase.html#a4">String</a>(XS(cd-&gt;getData()));
00384   }
00385   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (n-&gt;hasChildNodes()) {
00386 
00387     dom::DOMNode* c = n-&gt;getFirstChild();
00388 
00389     <span class="keywordflow">while</span> (c) {
00390       text += <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera40">getContainedText</a>(c);
00391       c = c-&gt;getNextSibling();
00392     }
00393 
00394   }
00395 
00396   <span class="keywordflow">if</span> (removeIndentation) {
00397     
00398     <span class="comment">// remove leading spaces from each line</span>
00399     <a class="code" href="namespacebase.html#a4">String</a> newtext;
00400     <a class="code" href="namespacebase.html#a1">SInt</a> pos=0;
00401     <span class="keywordflow">while</span> (pos &lt; <a class="code" href="namespacebase.html#a1">SInt</a>(text.size())) {
00402 
00403       <span class="comment">// skip over spaces</span>
00404       <span class="keywordflow">while</span> (((text[pos] == <span class="charliteral">' '</span>) || (text[pos] == <span class="charliteral">'\t'</span>)) &amp;&amp; (pos &lt; <a class="code" href="namespacebase.html#a1">SInt</a>(text.size())))
00405         pos++;
00406 
00407       <span class="keywordflow">if</span> (pos &lt; <a class="code" href="namespacebase.html#a1">SInt</a>(text.size())) {
00408         
00409         <span class="comment">// extract text upto (&amp; including) next new-line (or to end if no more newlines)</span>
00410         <a class="code" href="namespacebase.html#a2">Int</a> nlpos = text.find( newline, pos );
00411         <span class="keywordflow">if</span> (nlpos != String::npos) {
00412           newtext += text.substr(pos, nlpos - pos + 1);
00413           pos = nlpos+1; <span class="comment">// pos after newline</span>
00414         }
00415         <span class="keywordflow">else</span> {
00416           newtext += text.substr(pos, text.size() - pos);
00417           pos = text.size(); <span class="comment">// pos at end (to end the loop)</span>
00418         }
00419         
00420       }
00421 
00422     }
00423     text = newtext;
00424   }
00425 
00426 
00427   <span class="keywordflow">return</span> text;
00428 }
00429 
00430 
00431 <a class="code" href="namespacebase.html#a4">String</a> Externalizer::getElementAttribute(dom::DOMElement* e, <span class="keyword">const</span> String&amp; attrname, <span class="keywordtype">bool</span> required)
00432 {
00433   <a class="code" href="base.html#a19">Assert</a>(xmlMode);
00434   dom::DOMAttr* attr = e-&gt;getAttributeNode( XS(attrname) );
00435   
00436   <span class="keywordflow">if</span> (attr == 0) {
00437     <span class="keywordflow">if</span> (required)
00438       <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerb12">abort</a>(<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"expected '"</span>)+attrname+<span class="stringliteral">"' attribute of element '"</span>+<a class="code" href="namespacebase.html#a4">String</a>(XS(e-&gt;getTagName()))+<span class="stringliteral">"'"</span> );
00439     <span class="keywordflow">else</span>
00440       <span class="keywordflow">return</span> <a class="code" href="namespacebase.html#a4">String</a>();
00441   }
00442 
00443   <span class="keywordflow">if</span> (required &amp;&amp; !attr-&gt;getSpecified())
00444       <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerb12">abort</a>(<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"expected explicit value for '"</span>)+attrname+<span class="stringliteral">"' attribute of element '"</span>+<a class="code" href="namespacebase.html#a4">String</a>(XS(e-&gt;getTagName()))+<span class="stringliteral">"'"</span> );
00445 
00446   <span class="keywordflow">return</span> XS( attr-&gt;getValue() );
00447 }
00448 
00449 
00450 <a class="code" href="namespacebase.html#a4">String</a> Externalizer::getDefaultedElementAttribute(dom::DOMElement* e, <span class="keyword">const</span> String&amp; attrname, <span class="keyword">const</span> String&amp; defaultValue)
00451 {
00452   <a class="code" href="base.html#a19">Assert</a>(xmlMode);
00453   dom::DOMAttr* attr = e-&gt;getAttributeNode( XS(attrname) );
00454   
00455   <span class="keywordflow">if</span> (attr == 0) 
00456     <span class="keywordflow">return</span> defaultValue;
00457   <span class="keywordflow">else</span> 
00458     <span class="keywordflow">if</span> (!attr-&gt;getSpecified())
00459       <span class="keywordflow">return</span> (defaultValue==<span class="stringliteral">"DTD"</span>)?<a class="code" href="namespacebase.html#a4">String</a>(XS( attr-&gt;getValue() )):defaultValue;
00460 
00461   <span class="keywordflow">return</span> XS( attr-&gt;getValue() );
00462 }
00463 
00464 
00465 
00466 array&lt;String&gt; Externalizer::splitIntoLines(<span class="keyword">const</span> String&amp; text, <span class="keywordtype">bool</span> removeBlankLines)
00467 {
00468   array&lt;String&gt; lines;
00469 
00470   <a class="code" href="namespacebase.html#a2">Int</a> pos=0;
00471   <span class="keywordflow">while</span> (pos &lt; text.size()) {
00472     <a class="code" href="namespacebase.html#a1">SInt</a> nlpos = text.find( newline, pos );
00473 
00474     <span class="keywordflow">if</span> (nlpos != -1) {
00475       <span class="keywordflow">if</span> (nlpos-pos != 0) {
00476         <a class="code" href="namespacebase.html#a4">String</a> line( text.substr(pos, nlpos - pos) );
00477         lines.push_back( line );
00478       }
00479       <span class="keywordflow">else</span>
00480         <span class="keywordflow">if</span> (!removeBlankLines)
00481           lines.push_back( <a class="code" href="namespacebase.html#a4">String</a>() );
00482       pos = nlpos+1;
00483     }
00484     <span class="keywordflow">else</span> {
00485       lines.push_back( text.substr(pos, text.size()-pos) );
00486       pos = text.length();
00487     }
00488   }
00489 
00490   <span class="keywordflow">return</span> lines;
00491 }
00492 
00493 
00494 array&lt;String&gt; Externalizer::splitAtDelimiter(<span class="keyword">const</span> String&amp; line, <span class="keywordtype">char</span> delimiter)
00495 {
00496   array&lt;String&gt; fields;
00497 
00498   <span class="keywordflow">if</span> (line.size() == 0) <span class="keywordflow">return</span> fields;
00499   <span class="keywordflow">if</span> (line.size() == 1) {
00500     fields.push_back( line );
00501     <span class="keywordflow">return</span> fields;
00502   }
00503 
00504   <a class="code" href="namespacebase.html#a2">Int</a> pos=0;
00505   <span class="keywordflow">while</span> (pos &lt; line.size()) {
00506     <a class="code" href="namespacebase.html#a1">SInt</a> nlpos = line.find( delimiter, pos );
00507     <span class="keywordflow">if</span> (nlpos != -1) {
00508       <span class="keywordflow">if</span> (nlpos-pos != 0) {
00509         <a class="code" href="namespacebase.html#a4">String</a> field( line.substr(pos, nlpos - pos) );
00510         fields.push_back( field );
00511       }
00512       pos = nlpos+1;
00513     }
00514     <span class="keywordflow">else</span> {
00515       fields.push_back( line.substr(pos, line.size()-pos) );
00516       pos = line.length();
00517     }
00518   }
00519 
00520   <span class="keywordflow">return</span> fields;
00521 }
00522 
00523 
00524 <a class="code" href="classbase_1_1vector.html">base::Vector</a> Externalizer::stringsToReals(<span class="keyword">const</span> array&lt;String&gt;&amp; strings, <span class="keywordtype">bool</span> acceptUnits)
00525 {
00526   <a class="code" href="classdemeter_1_1Vector.html">Vector</a> v( <a class="code" href="namespacebase.html#a201">zeroVector</a>(strings.size()) );
00527 
00528   <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;strings.size(); i++) {
00529     <span class="keyword">const</span> <a class="code" href="namespacebase.html#a4">String</a>&amp; s(strings[i]);
00530     v[i] = <a class="code" href="namespacebase.html#a53">base::stringToReal</a>(s);
00531     <span class="keywordflow">if</span> (s.length() &gt; 2) {
00532       <span class="keywordflow">if</span> (s.substr(s.length()-2,s.length()-1) == <span class="stringliteral">"in"</span>)
00533         v[i] *= 0.0254; <span class="comment">// inches to meters</span>
00534       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s.substr(s.length()-3,s.length()-1) == <span class="stringliteral">"deg"</span>)
00535         v[i] = Math::degToRad(v[i]); <span class="comment">// degrees to radians</span>
00536     }
00537   }
00538 
00539   <span class="keywordflow">return</span> v;
00540 }
00541 
00542 
00543 <a class="code" href="classbase_1_1Matrix4.html">base::Matrix4</a> Externalizer::toMatrix4(<span class="keyword">const</span> String&amp; text)
00544 {
00545   array&lt;String&gt; lines = <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere1">splitIntoLines</a>(text, <span class="keyword">true</span>);
00546   <span class="keywordflow">if</span> (lines.size() != 4)
00547     <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">base::externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"expected 4x4 matrix"</span>));
00548 
00549   Matrix4 m;
00550   <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> r=0; r&lt;4; r++) {
00551     array&lt;String&gt; rowEltStrings = <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere2">splitAtDelimiter</a>(lines[r],<span class="charliteral">' '</span>);
00552     <a class="code" href="classdemeter_1_1Vector.html">Vector</a> row( <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere3">stringsToReals</a>(rowEltStrings) );
00553     <span class="keywordflow">if</span> (row.size() != 4)
00554       <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">base::externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"expected 4x4 matrix"</span>));
00555     m(r+1,1) = row[0];
00556     m(r+1,2) = row[1];
00557     m(r+1,3) = row[2];
00558     m(r+1,4) = row[3];
00559   }
00560   <span class="keywordflow">return</span> m;
00561 }
00562 
00563 <a class="code" href="namespacebase.html#a4">String</a> Externalizer::toString(<span class="keyword">const</span> <a class="code" href="classbase_1_1Matrix4.html">base::Matrix4</a>&amp; m)
00564 {
00565   <span class="keywordtype">char</span> buf[256];
00566   sprintf(buf,<span class="stringliteral">"%8.4f %8.4f %8.4f %8.4f\n%8.4f %8.4f %8.4f %8.4f\n%8.4f %8.4f %8.4f %8.4f\n%8.4f %8.4f %8.4f %8.4f\n"</span>,
00567           m(1,1),m(1,2),m(1,3),m(1,4),
00568           m(2,1),m(2,2),m(2,3),m(2,4),
00569           m(3,1),m(3,2),m(3,3),m(3,4),
00570           m(4,1),m(4,2),m(4,3),m(4,4) );
00571   <span class="keywordflow">return</span> <a class="code" href="namespacebase.html#a4">String</a>(buf);
00572 }
00573 
00574 
00575 <a class="code" href="classbase_1_1Vector3.html">base::Vector3</a> Externalizer::toVector3(<span class="keyword">const</span> String&amp; text, <span class="keywordtype">bool</span> acceptUnits)
00576 {
00577   <a class="code" href="namespacebase.html#a4">String</a> s1( <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere14">removeChar</a>(text, <span class="charliteral">'('</span>) );
00578   <a class="code" href="namespacebase.html#a4">String</a> s2( <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere14">removeChar</a>(s1, <span class="charliteral">')'</span>) );
00579   array&lt;String&gt; eltStrings = <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere2">splitAtDelimiter</a>(s2,<span class="charliteral">','</span>);
00580   <a class="code" href="classdemeter_1_1Vector.html">Vector</a> v( <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere3">stringsToReals</a>(eltStrings, acceptUnits) );
00581   <span class="keywordflow">if</span> (v.size() != 3)
00582     <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">base::externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"expected 3 dim vector"</span>));
00583   <span class="keywordflow">return</span> Vector3(v[0], v[1], v[2]);
00584 }
00585 
00586 <a class="code" href="classbase_1_1vector.html">base::Vector</a> Externalizer::toVector(<span class="keyword">const</span> String&amp; text, <span class="keywordtype">bool</span> commasep, <span class="keywordtype">bool</span> acceptUnits)
00587 {
00588   <a class="code" href="namespacebase.html#a4">String</a> s1( <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere14">removeChar</a>(text, <span class="charliteral">'('</span>) );
00589   <a class="code" href="namespacebase.html#a4">String</a> s2( <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere14">removeChar</a>(s1, <span class="charliteral">')'</span>) );
00590   array&lt;String&gt; eltStrings = <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere2">splitAtDelimiter</a>(s2,commasep?<span class="charliteral">','</span>:<span class="charliteral">' '</span>);
00591   <span class="keywordflow">return</span> <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere3">stringsToReals</a>(eltStrings, acceptUnits);
00592 }
00593 
00594 
00595 
00596 <a class="code" href="namespacebase.html#a4">String</a> Externalizer::toString(<span class="keyword">const</span> <a class="code" href="classbase_1_1Vector3.html">base::Vector3</a>&amp; v)
00597 {
00598   <span class="keywordtype">char</span> buf[48];
00599   sprintf(buf,<span class="stringliteral">"(%8.4f, %8.4f, %8.4f)"</span>,v.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o0">x</a>,v.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o1">y</a>,v.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o2">z</a>);
00600   <span class="keywordflow">return</span> <a class="code" href="namespacebase.html#a4">String</a>(buf);
00601 }
00602 
00603 
00604 <a class="code" href="namespacebase.html#a4">String</a> Externalizer::toString(<span class="keyword">const</span> <a class="code" href="classbase_1_1vector.html">base::Vector</a>&amp; v, <span class="keywordtype">bool</span> commasep)
00605 {
00606   <a class="code" href="namespacebase.html#a4">String</a> str;
00607   <span class="keywordtype">char</span> buf[20];
00608   <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;v.<a class="code" href="classbase_1_1vector.html#base_1_1vectora12">size</a>(); i++) {
00609     sprintf(buf,<span class="stringliteral">"%8.4f"</span>,v[i]);
00610     str += <a class="code" href="namespacebase.html#a4">String</a>(buf);
00611     <span class="keywordflow">if</span> (commasep &amp;&amp; (i !=v.<a class="code" href="classbase_1_1vector.html#base_1_1vectora12">size</a>()-1) )
00612       str += <span class="stringliteral">","</span>;
00613     <span class="keywordflow">else</span>
00614       str += <span class="stringliteral">" "</span>;
00615   }
00616 
00617   <span class="keywordflow">if</span> (commasep)
00618     str = <a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"("</span>)+str+<span class="stringliteral">")"</span>;
00619     
00620   <span class="keywordflow">return</span> str;
00621 }
00622 
00623 
00624 <a class="code" href="namespacebase.html#a4">String</a> Externalizer::toString(<span class="keyword">const</span> <a class="code" href="classbase_1_1matrix.html">base::Matrix</a>&amp; m)
00625 {
00626   <span class="keywordflow">if</span> ((m.<a class="code" href="classbase_1_1matrix.html#base_1_1matrixa8">size1</a>() == 0) || (m.<a class="code" href="classbase_1_1matrix.html#base_1_1matrixa9">size2</a>() == 0)) <span class="keywordflow">return</span> <a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"[]"</span>);
00627   
00628   <a class="code" href="namespacebase.html#a4">String</a> line(<span class="stringliteral">"["</span>);
00629   <span class="keywordtype">char</span> buf[16];
00630   
00631   <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> r=0; r&lt;m.<a class="code" href="classbase_1_1matrix.html#base_1_1matrixa8">size1</a>(); r++) {
00632     <a class="code" href="namespacebase.html#a4">String</a> row;
00633     <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> c=0; c&lt;m.<a class="code" href="classbase_1_1matrix.html#base_1_1matrixa9">size2</a>(); c++) {
00634       <span class="keywordflow">if</span> (c!=m.<a class="code" href="classbase_1_1matrix.html#base_1_1matrixa9">size2</a>())
00635         sprintf(buf,<span class="stringliteral">"%8.4f "</span>,m(r,c)); 
00636       <span class="keywordflow">else</span>
00637         sprintf(buf,<span class="stringliteral">"%8.4f"</span>,m(r,c));
00638       row+=<a class="code" href="namespacebase.html#a4">String</a>(buf);
00639     }
00640     <span class="keywordflow">if</span> (r &lt; m.<a class="code" href="classbase_1_1matrix.html#base_1_1matrixa8">size1</a>()-1) row += <span class="stringliteral">"; "</span>;
00641     line += row;
00642   }
00643   line += <span class="stringliteral">"]"</span>;
00644   
00645   <span class="keywordflow">return</span> line;
00646 }
00647 
00648 
00649 <a class="code" href="classbase_1_1matrix.html">base::Matrix</a> Externalizer::toMatrix(<span class="keyword">const</span> String&amp; text)
00650 {
00651   <a class="code" href="namespacebase.html#a4">String</a> s1( <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere14">removeChar</a>(text, <span class="charliteral">'['</span>) );
00652   <a class="code" href="namespacebase.html#a4">String</a> s2( <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere14">removeChar</a>(s1, <span class="charliteral">']'</span>) );
00653   array&lt;String&gt; rowStrings = <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere2">splitAtDelimiter</a>(s2,<span class="charliteral">';'</span>); <span class="comment">// split rows</span>
00654   <a class="code" href="namespacebase.html#a2">Int</a> rows = rowStrings.size();
00655   <a class="code" href="namespacebase.html#a2">Int</a> cols = <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere2">splitAtDelimiter</a>(rowStrings[0],<span class="charliteral">' '</span>).size(); <span class="comment">// count cols</span>
00656   <a class="code" href="classbase_1_1matrix.html">Matrix</a> m(rows,cols);
00657   
00658   <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> r=0; r&lt;rows; r++) {
00659     array&lt;String&gt; eltStrings = <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere2">splitAtDelimiter</a>(rowStrings[r],<span class="charliteral">' '</span>);
00660     <a class="code" href="namespacebase.html#a82">matrixRow</a>(m,r) = <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizere3">stringsToReals</a>(eltStrings);
00661   }
00662 
00663   <span class="keywordflow">return</span> m;
00664 }
00665 
00666 
00667 <a class="code" href="namespacebase.html#a4">String</a> Externalizer::toString(Real v, <span class="keyword">const</span> String&amp; units)
00668 {
00669   <span class="keywordflow">if</span> (units==<span class="stringliteral">"m"</span>)
00670     <span class="keywordflow">return</span> <a class="code" href="namespacebase.html#a51">base::realToString</a>(v);
00671   <span class="keywordflow">else</span>
00672     <span class="keywordflow">return</span> <a class="code" href="namespacebase.html#a51">base::realToString</a>(v)+units;
00673 }
00674 
00675 <a class="code" href="namespacebase.html#a5">Real</a> Externalizer::toReal(<span class="keyword">const</span> String&amp; text, <span class="keywordtype">bool</span> acceptUnits)
00676 {
00677   <a class="code" href="namespacebase.html#a5">Real</a> v = <a class="code" href="namespacebase.html#a53">base::stringToReal</a>(text);
00678   <span class="keywordflow">if</span> (acceptUnits &amp;&amp; (text.length() &gt; 2)) {
00679     <span class="keywordflow">if</span> (text.substr(text.length()-2,text.length()-1) == <span class="stringliteral">"in"</span>)
00680       v *= 0.0254; <span class="comment">// inches to meters</span>
00681     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (text.substr(text.length()-3, text.length()-1) == <span class="stringliteral">"deg"</span>)
00682       v = Math::degToRad(v); <span class="comment">// degrees to radians</span>
00683   }
00684   <span class="keywordflow">return</span> v;
00685 }
00686 
00687 
00688 
00689 
00690 <a class="code" href="namespacebase.html#a4">String</a> Externalizer::removeChar(<span class="keyword">const</span> String&amp; text, <span class="keywordtype">char</span> toRemove)
00691 {
00692   <a class="code" href="namespacebase.html#a4">String</a> newtext;
00693   <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;text.size(); i++)
00694     <span class="keywordflow">if</span> (text[i] != toRemove)
00695       newtext += text[i];
00696   <span class="keywordflow">return</span> newtext;
00697 }
00698 
00699 
00700 <span class="keywordtype">bool</span> Externalizer::isNumeric(<span class="keyword">const</span> String&amp; text)
00701 {
00702   <span class="keywordtype">bool</span> numeric=<span class="keyword">true</span>;
00703   std::locale loc;
00704   <span class="keyword">const</span> std::ctype&lt;char&gt;&amp; ct = std::use_facet&lt;std::ctype&lt;char&gt; &gt;(loc);
00705   <a class="code" href="namespacebase.html#a2">Int</a> i=0;
00706   <span class="keywordflow">while</span> (numeric &amp;&amp; (i&lt;text.size())) {
00707     <span class="keywordflow">if</span> (!ct.is(std::ctype_base::digit,text[i]))
00708       numeric=<span class="keyword">false</span>;
00709     i++;
00710   }
00711   <span class="keywordflow">return</span> numeric;
00712 }
00713 
00714 
00715 
00716 
00717 
00718 <span class="keywordtype">void</span> Externalizer::xmlInitialize()
00719 {
00720   <span class="keywordflow">if</span> (!<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizert0">xmlInitialized</a>) {
00721     <span class="keywordflow">try</span> {
00722       dom::XMLPlatformUtils::Initialize();
00723       <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizert0">xmlInitialized</a> = <span class="keyword">true</span>;
00724     }
00725     <span class="keywordflow">catch</span> (<span class="keyword">const</span> dom::XMLException&amp; toCatch) {
00726       <span class="keywordflow">throw</span> std::runtime_error(<a class="code" href="base.html#a15">Exception</a>(<a class="code" href="namespacebase.html#a4">String</a>( dom::XMLString::transcode(toCatch.getMessage()) )));
00727     }
00728   }
00729 }
00730 
00731 
00732 
00733 dom::DOMDocument* Externalizer::xmlParseDocument()
00734 {
00735   <span class="keywordflow">if</span> (<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera4">isOutput</a>()) <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerb12">abort</a>(inputDuringOutputErrorString);
00736 
00737   <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerf0">xmlInitialize</a>();
00738 
00739   <span class="keywordflow">if</span> (!<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp2">impl</a>)
00740     <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp2">impl</a> = dom::DOMImplementationRegistry::getDOMImplementation(XS(<span class="stringliteral">"LS"</span>));
00741   <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp1">parser</a> = ((dom::DOMImplementationLS*)<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp2">impl</a>)-&gt;createDOMBuilder(dom::DOMImplementationLS::MODE_SYNCHRONOUS, 0);
00742 
00743   <span class="comment">// set some features on this builder</span>
00744   <span class="keywordflow">if</span> (<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp1">parser</a>-&gt;canSetFeature(dom::XMLUni::fgDOMValidation, <span class="keyword">true</span>))
00745     <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp1">parser</a>-&gt;setFeature(dom::XMLUni::fgDOMValidation, <span class="keyword">true</span>);
00746   <span class="keywordflow">if</span> (<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp1">parser</a>-&gt;canSetFeature(dom::XMLUni::fgDOMNamespaces, <span class="keyword">true</span>))
00747     <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp1">parser</a>-&gt;setFeature(dom::XMLUni::fgDOMNamespaces, <span class="keyword">true</span>);
00748   <span class="keywordflow">if</span> (<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp1">parser</a>-&gt;canSetFeature(dom::XMLUni::fgDOMDatatypeNormalization, <span class="keyword">true</span>))
00749       <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp1">parser</a>-&gt;setFeature(dom::XMLUni::fgDOMDatatypeNormalization, <span class="keyword">true</span>);
00750   <span class="keywordflow">if</span> (<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp1">parser</a>-&gt;canSetFeature(dom::XMLUni::fgDOMComments, <span class="keyword">true</span>))
00751     <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp1">parser</a>-&gt;setFeature(dom::XMLUni::fgDOMComments, <span class="keyword">false</span>);
00752 
00753   <span class="comment">// to parse the stream, read the whole thing into a memory buffer</span>
00754   <span class="comment">//  and use a MemBufInputSource (inefficient for large files though)</span>
00755   array&lt;XByte&gt; buffer(0,4096); <span class="comment">// initial size=0, initial capacity=4096</span>
00756   <a class="code" href="namespacebase.html#a15">XByte</a> b;
00757   std::istream&amp; is( <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerb1">input</a>() );
00758   <span class="keywordflow">while</span> (is.good()) {
00759     b = is.get();
00760     buffer.push_back(b);
00761   }
00762 
00763   dom::MemBufInputSource memInputSrc(buffer.c_array(),buffer.size(),XS(<span class="stringliteral">"ID"</span>));
00764   dom::Wrapper4InputSource domInputSrc(&amp;memInputSrc, <span class="keyword">false</span>);
00765 
00766   dom::DOMDocument *<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera15">doc</a> = 0;
00767 
00768   <span class="keywordflow">try</span> {
00769     doc = <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp1">parser</a>-&gt;parse(domInputSrc);
00770   }
00771   <span class="keywordflow">catch</span> (<span class="keyword">const</span> dom::XMLException&amp; toCatch) {
00772     <span class="keywordtype">char</span>* message = dom::XMLString::transcode(toCatch.getMessage());
00773     <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">base::externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"XML Error:"</span>)+message));
00774   }
00775   <span class="keywordflow">catch</span> (<span class="keyword">const</span> dom::DOMException&amp; toCatch) {
00776     <span class="keywordtype">char</span>* message = dom::XMLString::transcode(toCatch.msg);
00777     <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">base::externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"XML DOM Error:"</span>)+message));
00778   }
00779 
00780   <a class="code" href="base.html#a19">Assert</a>(doc);
00781   <span class="keywordflow">return</span> doc;
00782 }
00783 
00784 
00785 <span class="keywordtype">void</span> Externalizer::xmlWriteDocument(dom::DOMDocument* doc)
00786 {
00787   <span class="keywordflow">if</span> (<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera5">isInput</a>()) <span class="keywordflow">return</span>;
00788 
00789   <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerf0">xmlInitialize</a>();
00790 
00791   dom::DOMNode* docElem = doc-&gt;getDocumentElement();
00792   <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerb7">xmlFormat</a>(docElem, 1);
00793 
00794   dom::DOMNode* last = docElem-&gt;getLastChild();
00795   <span class="keywordflow">if</span> (last)
00796     <span class="keywordflow">if</span> (!<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerb8">isNewline</a>(last))
00797       <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera29">appendText</a>(docElem, newline);
00798 
00799   <span class="keywordflow">if</span> (!<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp2">impl</a>)
00800     <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp2">impl</a> = dom::DOMImplementationRegistry::getDOMImplementation(XS(<span class="stringliteral">"LS"</span>));
00801   dom::DOMWriter* writer = ((dom::DOMImplementationLS*)<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp2">impl</a>)-&gt;createDOMWriter();
00802   
00803   <span class="comment">// set some features on this writer</span>
00804   <span class="keywordflow">if</span> (writer-&gt;canSetFeature(dom::XMLUni::fgDOMWRTDiscardDefaultContent, <span class="keyword">true</span>))
00805     writer-&gt;setFeature(dom::XMLUni::fgDOMWRTDiscardDefaultContent, <span class="keyword">true</span>);
00806   
00807   <span class="keywordflow">if</span> (writer-&gt;canSetFeature(dom::XMLUni::fgDOMWRTFormatPrettyPrint, <span class="keyword">true</span>))
00808     writer-&gt;setFeature(dom::XMLUni::fgDOMWRTFormatPrettyPrint, <span class="keyword">false</span>);
00809   
00810 
00811   <span class="comment">// output to a memory buffer, then serialize that to the stream</span>
00812   dom::MemBufFormatTarget memBufTarget;
00813   
00814   <span class="keywordflow">try</span> {
00815     <span class="comment">// do the serialization through DOMWriter::writeNode();</span>
00816     writer-&gt;writeNode(&amp;memBufTarget, *doc);
00817   }
00818   <span class="keywordflow">catch</span> (<span class="keyword">const</span> dom::XMLException&amp; toCatch) {
00819     <span class="keywordtype">char</span>* message = dom::XMLString::transcode(toCatch.getMessage());
00820     <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">base::externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"XML Error:"</span>)+message));
00821   }
00822   <span class="keywordflow">catch</span> (<span class="keyword">const</span> dom::DOMException&amp; toCatch) {
00823     <span class="keywordtype">char</span>* message = dom::XMLString::transcode(toCatch.msg);
00824     <span class="keywordflow">throw</span> <a class="code" href="classbase_1_1externalization__error.html">base::externalization_error</a>(<a class="code" href="base.html#a15">Exception</a>(<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"XML DOM Error:"</span>)+message));
00825   }
00826   
00827   <span class="comment">// copy to stream</span>
00828   std::ostream&amp; os( <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerb2">output</a>() );
00829   <span class="keyword">const</span> <a class="code" href="namespacebase.html#a15">XByte</a>* bytes = memBufTarget.getRawBuffer();
00830   <a class="code" href="namespacebase.html#a15">XByte</a> b = *bytes;
00831   <span class="keywordflow">while</span> (b != 0) {
00832     os.put(b);
00833     bytes++;
00834     b = *bytes;
00835   }
00836   os.flush();
00837 
00838 }
00839 
00840 
00841 <span class="keywordtype">void</span> Externalizer::xmlReleaseDocument()
00842 {
00843   <span class="keywordflow">if</span> (<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp0">xmlMode</a>) {
00844 
00845     <span class="keywordflow">if</span> (<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp1">parser</a>) {
00846       <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp1">parser</a>-&gt;release();
00847       <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp1">parser</a> = 0;
00848       <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp4">xmldoc</a> = 0;
00849     }
00850 
00851     <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp0">xmlMode</a>=0;
00852   }
00853 
00854 }
00855 
00856 
00857 <span class="keywordtype">bool</span> Externalizer::isNewline(dom::DOMNode* n)
00858 {
00859   <span class="keywordflow">if</span> (n-&gt;getNodeType() == dom::DOMNode::TEXT_NODE) {
00860     dom::DOMText* t = dynamic_cast&lt;dom::DOMText*&gt;(n);
00861     <span class="keywordflow">return</span> (dom::XMLString::compareString(t-&gt;getData(),
00862                                           XS(newline)) == 0);
00863   }
00864   <span class="keywordflow">return</span> <span class="keyword">false</span>;
00865 }
00866 
00867 
00868 <span class="keywordtype">bool</span> Externalizer::equals(<span class="keyword">const</span> XCh* str1, <span class="keyword">const</span> String&amp; str2)
00869 {
00870   <span class="keywordflow">return</span> (dom::XMLString::compareString(str1, XS(str2)) == 0);
00871 }
00872 
00873 
00874 <span class="keywordtype">bool</span> Externalizer::isElement(dom::DOMNode* n, <span class="keyword">const</span> String&amp; tagname)
00875 {
00876   <span class="keywordflow">if</span> (n-&gt;getNodeType() == dom::DOMNode::ELEMENT_NODE) {
00877     dom::DOMElement* e = dynamic_cast&lt;dom::DOMElement*&gt;(n);
00878     <span class="keywordflow">return</span> <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerb9">equals</a>(e-&gt;getTagName(), tagname);
00879   }
00880   <span class="keywordflow">return</span> <span class="keyword">false</span>;
00881 }
00882 
00883 
00884 
00885 <span class="comment">// traverse the document and insert indent spaces where appropriate</span>
00886 <span class="keywordtype">void</span> Externalizer::xmlFormat(dom::DOMNode* n, Int indent)
00887 {
00888   <span class="keywordflow">if</span> (!n-&gt;hasChildNodes()) <span class="keywordflow">return</span>;
00889 
00890   dom::DOMNode* c = n-&gt;getFirstChild();
00891   <span class="keywordflow">do</span> {
00892     <span class="comment">//Debugcln(DJ,String(indent*2,' ') </span>
00893     <span class="comment">//       &lt;&lt; dom::XMLString::transcode(c-&gt;getNodeName()) );</span>
00894     
00895     <span class="keywordflow">switch</span> (c-&gt;getNodeType()) {
00896     <span class="keywordflow">case</span> dom::DOMNode::ELEMENT_NODE: {
00897       dom::DOMElement* e = dynamic_cast&lt;dom::DOMElement*&gt;(c);
00898       <span class="keywordtype">bool</span> indenting = <span class="keyword">false</span>;
00899       dom::DOMNode* first = e-&gt;getFirstChild();
00900       <span class="keywordflow">if</span> (first) {
00901         <span class="keywordflow">if</span> (<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerb8">isNewline</a>(first)) {
00902           <span class="comment">// the first child node of this element is a newline </span>
00903           <span class="comment">//   which indicates it is indenting, not inline:</span>
00904           indenting = <span class="keyword">true</span>;
00905           
00906           <span class="comment">// - add a newline (if needed) and indent space before it</span>
00907           dom::DOMNode* p = e-&gt;getParentNode();
00908           <span class="keywordflow">if</span> (p) {
00909             dom::DOMNode* prev = e-&gt;getPreviousSibling();
00910             <span class="keywordflow">if</span> (prev)
00911               <span class="keywordflow">if</span> (!<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerb8">isNewline</a>(prev))
00912                 p-&gt;insertBefore( <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera28">createText</a>(newline), e );
00913             p-&gt;insertBefore( <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera28">createText</a>(<a class="code" href="namespacebase.html#a4">String</a>(indent*indentSpaces, <span class="charliteral">' '</span>)), e );
00914           }
00915           
00916 
00917 
00918           <span class="comment">// - add a newline (if needed) and indent space as the last nodes to</span>
00919           <span class="comment">//   indent the close tag.  If there is only one newline child,</span>
00920           <span class="comment">//   remove it</span>
00921           dom::DOMNode* last = e-&gt;getLastChild();
00922           <span class="keywordflow">if</span> (last-&gt;isSameNode(first) &amp;&amp; <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerb8">isNewline</a>(last))
00923             e-&gt;removeChild(last);
00924           <span class="keywordflow">else</span> {
00925             <span class="comment">// recursive call</span>
00926             <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerb7">xmlFormat</a>(c,indent+1);
00927 
00928             last = e-&gt;getLastChild();
00929             <span class="keywordflow">if</span> (!<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerb8">isNewline</a>(last))
00930               <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera29">appendText</a>(e, newline);
00931             <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera29">appendText</a>(e, <a class="code" href="namespacebase.html#a4">String</a>(indent*indentSpaces, <span class="charliteral">' '</span>) );
00932 
00933           
00934             <span class="comment">// - add a newline after (so it is after the closetag)</span>
00935             dom::DOMNode* p = e-&gt;getParentNode();
00936             <span class="keywordflow">if</span> (p) {
00937               dom::DOMNode* next = e-&gt;getNextSibling();
00938               <span class="keywordflow">if</span> (next)
00939                 p-&gt;insertBefore( <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera28">createText</a>(newline), next );
00940               <span class="keywordflow">else</span>
00941                 <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera29">appendText</a>(p, newline );
00942             }
00943           }
00944 
00945         }
00946       }
00947       
00948       
00949       <span class="comment">// if there is a newline before this element, indent it</span>
00950       dom::DOMNode* prev = e-&gt;getPreviousSibling();
00951       <span class="keywordflow">if</span> (prev)
00952         <span class="keywordflow">if</span> (<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerb8">isNewline</a>(prev)) {
00953           dom::DOMNode* p = e-&gt;getParentNode();
00954           <span class="keywordflow">if</span> (p)
00955             p-&gt;insertBefore( <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera28">createText</a>(<a class="code" href="namespacebase.html#a4">String</a>(indent*indentSpaces, <span class="charliteral">' '</span>)), e );
00956         }
00957           
00958 
00959 
00960       <span class="keywordflow">if</span> (!indenting)
00961         <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerb7">xmlFormat</a>(c,indent);
00962 
00963     } <span class="keywordflow">break</span>;
00964 
00965     <span class="keywordflow">case</span> dom::DOMNode::TEXT_NODE: {
00966       <span class="comment">// if there is a newline before this node, indent it (if it isn't a newline itself)</span>
00967       <span class="keywordflow">if</span> (!<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerb8">isNewline</a>(c)) {
00968         dom::DOMText* t = dynamic_cast&lt;dom::DOMText*&gt;(c);
00969         dom::DOMNode* prev = t-&gt;getPreviousSibling();
00970         <span class="keywordflow">if</span> (prev) {
00971           <span class="keywordflow">if</span> (<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerb8">isNewline</a>(prev)) {
00972             dom::DOMNode* p = t-&gt;getParentNode();
00973             <span class="keywordflow">if</span> (p) 
00974               p-&gt;insertBefore( <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera28">createText</a>(<a class="code" href="namespacebase.html#a4">String</a>(indent*indentSpaces, <span class="charliteral">' '</span>)), t );
00975           }
00976         }
00977         
00978         <span class="comment">// if the text contains a newline, split it</span>
00979         <span class="comment">// i.e. before: t='aa\nbb\ncc' after: t='aa' t2='\n' t3='bb\ncc'</span>
00980         <span class="keyword">const</span> <a class="code" href="namespacebase.html#a14">XCh</a>* text = t-&gt;getData();
00981         <a class="code" href="namespacebase.html#a1">SInt</a> newlineIndex = dom::XMLString::indexOf(text,XS(newline)[0]);
00982         <span class="keywordflow">if</span> (newlineIndex != -1) {
00983           <span class="keywordflow">if</span> (newlineIndex != <a class="code" href="namespacebase.html#a1">SInt</a>(t-&gt;getLength())-1) {
00984             t-&gt;splitText(newlineIndex);
00985             dom::DOMText* newtext = dynamic_cast&lt;dom::DOMText*&gt;(t-&gt;getNextSibling());
00986             newtext-&gt;deleteData(0,1); <span class="comment">// remove the leading newline</span>
00987             <span class="comment">// put a newline and indent spaces between them</span>
00988             dom::DOMNode* p = t-&gt;getParentNode();
00989             <span class="keywordflow">if</span> (p) 
00990               p-&gt;insertBefore(<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera28">createText</a>(newline), newtext );
00991           }
00992           <span class="keywordflow">else</span>
00993             t-&gt;deleteData(t-&gt;getLength()-1,1);
00994         }
00995       }
00996 
00997       <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerb7">xmlFormat</a>(c,indent);
00998     } <span class="keywordflow">break</span>;
00999 
01000     <span class="comment">// these nodes always occur on a new line</span>
01001     <span class="keywordflow">case</span> dom::DOMNode::CDATA_SECTION_NODE: 
01002     <span class="keywordflow">case</span> dom::DOMNode::COMMENT_NODE: {
01003 
01004       <span class="comment">// add a newline before this node (if necessary) and indent it</span>
01005       dom::DOMNode* prev = c-&gt;getPreviousSibling();
01006       dom::DOMNode* p = c-&gt;getParentNode();
01007       <span class="keywordflow">if</span> (prev) {
01008         <span class="keywordflow">if</span> (!<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerb8">isNewline</a>(prev)) {
01009           <span class="keywordflow">if</span> (p) p-&gt;insertBefore( <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera28">createText</a>(newline), c);
01010         }
01011 
01012         <span class="keywordflow">if</span> (p) 
01013           p-&gt;insertBefore( <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera28">createText</a>(<a class="code" href="namespacebase.html#a4">String</a>(indent*indentSpaces, <span class="charliteral">' '</span>)), c );
01014       }
01015 
01016       <span class="comment">// add a newline after too</span>
01017       dom::DOMNode* next = c-&gt;getNextSibling();
01018       <span class="keywordflow">if</span> (next) {
01019         <span class="keywordflow">if</span> (p) p-&gt;insertBefore( <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera28">createText</a>(newline), next );
01020       }
01021       <span class="keywordflow">else</span>
01022         p-&gt;appendChild( <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera28">createText</a>(newline) );
01023         
01024       
01025     } <span class="keywordflow">break</span>;
01026 
01027     <span class="keywordflow">default</span>: ;
01028     }
01029 
01030     c = c-&gt;getNextSibling();
01031   } <span class="keywordflow">while</span>(c);
01032 
01033 }
01034 
01035 
01036 
01037 
01038 
01039 
01040 <span class="keywordtype">void</span> Externalizer::abort(<span class="keyword">const</span> String&amp; exceptionString)
01041 { 
01042   <span class="keywordflow">if</span> (!<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp8">aborted</a>) {
01043     <a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizerp8">aborted</a>=<span class="keyword">true</span>; 
01044     <a class="code" href="base.html#a3">Logln</a>(exceptionString);
01045     <span class="keywordflow">throw</span> externalization_error(<a class="code" href="base.html#a15">Exception</a>(exceptionString)); 
01046   }
01047 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Jul 29 15:56:06 2004 for OpenSim by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.6 </small></address>
</body>
</html>
