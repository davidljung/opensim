<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>OpenSim: robot/control/oldikor/IKOR/IKOR_driver.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>robot/control/oldikor/IKOR/IKOR_driver.c</h1><a href="IKOR__driver_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/* ________________________________________________________</span>
00002 <span class="comment">  |                                                        |</span>
00003 <span class="comment">  | Program Name:   IKOR_driver.c                          |</span>
00004 <span class="comment">  |________________________________________________________|</span>
00005 <span class="comment">  |                                                        |</span>
00006 <span class="comment">  | description:  Driver for FSP, Psuedo Inverse, Manipul- |</span>
00007 <span class="comment">  |     ator porting, obstacle detection, and utilities.   |</span>
00008 <span class="comment">  |     IKOR_driver does not contain a main, instead it can|</span>
00009 <span class="comment">  |     be called by the main in short.c or CheezyIGRIP.c  |</span>
00010 <span class="comment">  |     or any other.                                      |</span>
00011 <span class="comment">  |                                                        |</span>
00012 <span class="comment">  | Procedures:                                            |</span>
00013 <span class="comment">  |     IKOR_driver    :                                   |</span>
00014 <span class="comment">  |     CALC_PSEUDO    :                                   |</span>
00015 <span class="comment">  |     FSP            :                                   |</span>
00016 <span class="comment">  |     Euler_to_Velocities :                              |</span>
00017 <span class="comment">  |     correct_euler  :                                   |</span>
00018 <span class="comment">  |     OPEN_FILES     :                                   |</span>
00019 <span class="comment">  |     Update_History :                                   |</span>
00020 <span class="comment">  |     Init_Globals   :                                   |</span>
00021 <span class="comment">  |________________________________________________________| */</span>
00022 
00023 
00024 <span class="preprocessor">#include &lt;<a class="code" href="general_8h.html">IKOR/general.h</a>&gt;</span>       <span class="comment">/* Generic Constants               */</span>
00025 <span class="preprocessor">#include &lt;<a class="code" href="Globals_8h.html">IKOR/Globals.h</a>&gt;</span>       <span class="comment">/* Global Variables used by system */</span>
00026 
<a name="l00027"></a><a class="code" href="IKOR__driver_8c.html#a0">00027</a> <span class="preprocessor">#define DEBUG_OUT 1</span>
00028 <span class="preprocessor"></span>
00029 <span class="comment">/* ________________________________________________________</span>
00030 <span class="comment">  | name:    IKOR_driver                                   |</span>
00031 <span class="comment">  | description:  Drives entire system, although main is   |</span>
00032 <span class="comment">  |     not here (see short.c or CheezyIGRIP.c for main).  |</span>
00033 <span class="comment">  |     Initializes global variables, reads in manipulator |</span>
00034 <span class="comment">  |     trajectory files, calls Jacobian, FSP, and con-    |</span>
00035 <span class="comment">  |     straint avoidance routines, if wanted. Also allows |</span>
00036 <span class="comment">  |     for Moore-Penrose Pseudo Inverse solutions, however|</span>
00037 <span class="comment">  |     the Pseudo is not equipped for constraint avoidance|</span>
00038 <span class="comment">  |                                                        |</span>
00039 <span class="comment">  | inputs:  N, M, method.  Manipulator, trajectory        |</span>
00040 <span class="comment">  | outputs: Alters two variables within FSP_data.         |</span>
00041 <span class="comment">  |     the beta vector for the joint is added to betall,  |</span>
00042 <span class="comment">  |     and cn, the number of beta vectors present, is     |</span>
00043 <span class="comment">  |     incremented.                                       |</span>
00044 <span class="comment">  |________________________________________________________|</span>
00045 <span class="comment">  | Authors:     Date:     Modifications:                  |</span>
00046 <span class="comment">  |  F Tulloch     4/94    Algorithm Creation for 2 g's    |</span>
00047 <span class="comment">  |  c hacker     10/94    Ported from 2 g's to FSP        |</span>
00048 <span class="comment">  |                2/95    Ported to Solutions struct      |</span>
00049 <span class="comment">  |                3/95    Altered FSP, Pseudo calls       |</span>
00050 <span class="comment">  |________________________________________________________| */</span>
00051 
<a name="l00052"></a><a class="code" href="IKOR__driver_8c.html#a1">00052</a> <span class="keywordtype">int</span> <a class="code" href="IKOR__driver_8c.html#a1">IKOR_driver</a>(IKCriterion, IKMethod, Optimization, N_use, M_use)
00053 <span class="keywordtype">int</span> *IKCriterion,    <span class="comment">/* Psuedo-Inverse, FSPleastnorm or leastflow  */</span>
00054     *IKMethod,       <span class="comment">/* Constraints : jointlimits, obstacles...    */</span>
00055      Optimization,   <span class="comment">/* Lagrangian, BANGBANG, SIMPLEX              */</span>
00056      M_use,          <span class="comment">/* Size of Joint Space (!&gt; num angles)        */</span>
00057      N_use;          <span class="comment">/* Size of Task Space (x,y,z,yw,ptch,rll)     */</span>
00058 {
00059   <span class="keywordtype">int</span>    i, j, k,                       <span class="comment">/* Generic counters               */</span>
00060          ns,                            <span class="comment">/* Number of Spheres              */</span>
00061          <a class="code" href="general_8h.html#a55">STEP</a>,                          <span class="comment">/* Current Step Along Trajectory  */</span>
00062          Num_Of_Pts,                    <span class="comment">/* Number of points in Trajectory */</span>
00063          quit = 0;                      <span class="comment">/* Exit_Status:  -2 File Trouble  */</span>
00064                                         <span class="comment">/*               -1 Partial Traj  */</span>
00065   <span class="keywordtype">float</span>  distance;                      <span class="comment">/* Determines distance traveled   */</span>
00066   <span class="keywordtype">double</span> XTraj[<a class="code" href="general_8h.html#a11">MAX_PTS</a>][6],             <span class="comment">/* End Effector (EE) Coordinates  */</span>
00067          spheredata[4][4];              <span class="comment">/* Holds sphere info              */</span>
00068   <a class="code" href="structMATRIX.html">MATRIX</a> *Jacob,                        <span class="comment">/* Holds Forward Kinematic Deriv. */</span>
00069          *dx,                           <span class="comment">/* Holds change in "EE"           */</span>
00070          *dq,                           <span class="comment">/* Holds change in ANGLES         */</span>
00071          *x_of_link,                    <span class="comment">/* Holds end points of each link  */</span>
00072          *Pos_error;                    <span class="comment">/* Holds the error in position    */</span>
00073   <a class="code" href="structSolutions.html">Solutions</a> *FSP_data;                  <span class="comment">/* see structure.h for explanation*/</span>
00074   <a class="code" href="structHistory.html">History</a>   Old_DQs;                    <span class="comment">/* Contains Array of History      */</span>
00075 
00076  <span class="comment">/*--------------------------------------------------------------*</span>
00077 <span class="comment">   * GLOBAL and LOCAL INITIALIZATIONS  (Order of decls important) *</span>
00078 <span class="comment">   *--------------------------------------------------------------*/</span>
00079   N=N_use;
00080   M=M_use;
00081   Old_DQs.<a class="code" href="structHistory.html#Historyo0">whereami</a> = -1;
00082   <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="structures_8h.html#a0">HIST_SIZE</a>; i++)
00083      Old_DQs.<a class="code" href="structHistory.html#Historyo1">dq</a>[i].<a class="code" href="structHistory__Element.html#History__Elemento1">DQ</a> = <a class="code" href="matrix_8h.html#a25">mat_malloc</a>( M , 1 );
00084   Pos_error = <a class="code" href="matrix_8h.html#a25">mat_malloc</a>(N, 1); <span class="comment">/* memory for error  in position  */</span>
00085   dx        = <a class="code" href="matrix_8h.html#a25">mat_malloc</a>(N, 1); <span class="comment">/* memory for change in position  */</span>
00086   Jacob     = <a class="code" href="matrix_8h.html#a25">mat_malloc</a>(N, M); <span class="comment">/* memory for Forw.Kin. derivatve */</span>
00087                                 <span class="comment">/* memory for x,y,z of each link  */</span>
00088   x_of_link=<a class="code" href="matrix_8h.html#a25">mat_malloc</a>(<a class="code" href="general_8h.html#a57">Robot</a>-&gt;<a class="code" href="structManipulator__struct.html#Manipulator__structo1">NL</a>+1,N);
00089   FSP_data =<a class="code" href="useful__UTILS_8c.html#a1">Solutions_init</a>(M,N);<span class="comment">/* memory for solutions,betas, etc*/</span>
00090                                 <span class="comment">/* initailize trajectory, data... */</span>
00091   <span class="keywordflow">if</span> (!(Num_Of_Pts=<a class="code" href="IKOR__driver_8c.html#a6">OPEN_FILES</a>(XTraj, <a class="code" href="general_8h.html#a38">PoorMansFile</a>, FSP_data-&gt;<a class="code" href="structSolutions.html#Solutionso7">Qarray</a>)))
00092          <span class="keywordflow">return</span> (-2);
00093   ns=<a class="code" href="useful__UTILS_8c.html#a4">spheres</a>(spheredata,<a class="code" href="general_8h.html#a34">datafp</a>);<span class="comment">/* initialize obstacles in system */</span> 
00094   dq = <a class="code" href="matrix_8h.html#a25">mat_malloc</a>(M,1);
00095   <a class="code" href="IKOR__driver_8c.html#a8">Update_History</a>(&amp;Old_DQs, dq);
00096   <a class="code" href="matrix_8h.html#a8">mat_free</a>(dq);
00097   <span class="comment">/* correct size of the Weight MATRIX, see structures.h,        */</span>
00098   <a class="code" href="general_8h.html#a57">Robot</a>-&gt;<a class="code" href="structManipulator__struct.html#Manipulator__structo12">Weights</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo1">rows</a> = <a class="code" href="general_8h.html#a57">Robot</a>-&gt;<a class="code" href="structManipulator__struct.html#Manipulator__structo12">Weights</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo2">cols</a> = M;
00099 
00100  
00101   <span class="comment">/*--------------------------------------------------------------*</span>
00102 <span class="comment">   * Uncomment, to trace bus errors or segmentation faults        *</span>
00103 <span class="comment">   *--------------------------------------------------------------*/</span>
00104   <span class="comment">/*datafp = stderr;            /* When in trouble, uncomment     */</span>
00105 
00106 
00107   <span class="comment">/*-------------------------------------------------------------*</span>
00108 <span class="comment">   *       HEADER INFORMATION for Standard Output                *</span>
00109 <span class="comment">   *-------------------------------------------------------------*/</span>
00110 
00111 <span class="preprocessor">  #ifdef DEBUG_OUT</span>
00112 <span class="preprocessor"></span>    fprintf (stderr, <span class="stringliteral">"\n\n\n"</span>
00113                    <span class="stringliteral">" *********************************************\n"</span>
00114                    <span class="stringliteral">"   INVERSE KINEMATIC AND REDUNDANCY RESOLVER  \n"</span>
00115                    <span class="stringliteral">"   For HERMIES CESARm, %d D.O.F, %d D.O.R.    \n"</span>
00116                    <span class="stringliteral">" *********************************************"</span>, M,M-N);
00117     fprintf (stderr, <span class="stringliteral">"\n\n\n"</span>
00118                    <span class="stringliteral">"     &lt; NUMBER OF POINTS IN TRAJECTORY &gt;  %d  \n"</span>
00119                    <span class="stringliteral">"         &lt;&lt; Time Step &gt;&gt;                     \n"</span>
00120                    <span class="stringliteral">"          ---------------------              \n"</span>
00121                    <span class="stringliteral">"\n&lt;&lt; -1&gt;&gt;"</span>, Num_Of_Pts);
00122 <span class="preprocessor">  #endif</span>
00123 <span class="preprocessor"></span>  
00124   <span class="comment">/*----------------------------------------------------------------*</span>
00125 <span class="comment">   *                          MAIN-LOOP                             *  </span>
00126 <span class="comment">   *                                                                *</span>
00127 <span class="comment">   *    Cycles through all points on trajectory until done doing    *</span>
00128 <span class="comment">   *    Least Norm  and possibly Joint and Obstacle Avoidance until *</span>
00129 <span class="comment">   *    an unavoidable problem occurs.                              *</span>
00130 <span class="comment">   *----------------------------------------------------------------*/</span>
00131 
00132   <span class="keywordflow">for</span> (<a class="code" href="general_8h.html#a55">STEP</a> = 0; <a class="code" href="general_8h.html#a55">STEP</a> &lt; Num_Of_Pts ; <a class="code" href="general_8h.html#a55">STEP</a>++)
00133   { <span class="comment">/*main_loop*/</span>
00134 
00135     <span class="comment">/*-------------------------------------------------------*</span>
00136 <span class="comment">     * Print Angles for simulation programs (IGRIP, Cheeze)  *</span>
00137 <span class="comment">     *    and print step number to the data and stderr files *</span>
00138 <span class="comment">     *-------------------------------------------------------*/</span>
00139 
00140     <span class="keywordflow">for</span> (i=0;i&lt; <a class="code" href="general_8h.html#a57">Robot</a>-&gt;<a class="code" href="structManipulator__struct.html#Manipulator__structo0">NA</a>;i++)
00141       <span class="keywordflow">if</span> (i&lt;M) fprintf (<a class="code" href="Globals_8h.html#a4">CheezyFile</a>, <span class="stringliteral">"%f  "</span>, FSP_data-&gt;<a class="code" href="structSolutions.html#Solutionso7">Qarray</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[i][0]);
00142     fprintf (<a class="code" href="Globals_8h.html#a4">CheezyFile</a>, <span class="stringliteral">"  \n"</span>);
00143     fflush  (<a class="code" href="Globals_8h.html#a4">CheezyFile</a>);
00144 
00145     <span class="keywordflow">if</span> (<a class="code" href="fsp_8c.html#a0">DEBUG</a>) 
00146       fprintf (<a class="code" href="general_8h.html#a34">datafp</a>, <span class="stringliteral">"\n*************STEP &lt;%d&gt; ****************\n"</span>, <a class="code" href="general_8h.html#a55">STEP</a>+1);
00147 <span class="preprocessor">    #ifdef DEBUG_OUT</span>
00148 <span class="preprocessor"></span>      fprintf (stderr, <span class="stringliteral">"\r&lt;&lt;%3d&gt;&gt;"</span>, <a class="code" href="general_8h.html#a55">STEP</a>+1);
00149 <span class="preprocessor">    #endif</span>
00150 <span class="preprocessor"></span>
00151     <span class="comment">/*-------------------------------------------------------*</span>
00152 <span class="comment">     * Based on Angles, Calculates Position of End Effector  *</span>
00153 <span class="comment">     *-------------------------------------------------------*/</span>
00154 <span class="preprocessor">    #ifndef FSP_DEBUG</span>
00155 <span class="preprocessor"></span>      <a class="code" href="Jacob__UTILS_8c.html#a0">GET_JACOBIAN</a>(Jacob, FSP_data-&gt;<a class="code" href="structSolutions.html#Solutionso7">Qarray</a>);
00156       <a class="code" href="headers_8h.html#a13">GET_ACTUAL_X</a>(FSP_data-&gt;<a class="code" href="structSolutions.html#Solutionso7">Qarray</a>, x_of_link);
00157 
00158       <span class="keywordflow">if</span> (<a class="code" href="fsp_8c.html#a0">DEBUG</a>) {
00159         <a class="code" href="useful__UTILS_8c.html#a5">fmat_pr</a> (<a class="code" href="general_8h.html#a34">datafp</a>, <span class="stringliteral">"Jacobian for Current Configuration"</span>, Jacob);
00160         fprintf (<a class="code" href="general_8h.html#a34">datafp</a>, <span class="stringliteral">"\nCurrent Position\n"</span>    );
00161         <span class="keywordflow">for</span> (i = 0; i &lt;  N; i++)
00162           fprintf(<a class="code" href="general_8h.html#a34">datafp</a>,<span class="stringliteral">"%s : %9f\n"</span>, <a class="code" href="general_8h.html#a40">dxLabel</a>[i], x_of_link-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[<a class="code" href="general_8h.html#a57">Robot</a>-&gt;<a class="code" href="structManipulator__struct.html#Manipulator__structo1">NL</a>][i]);
00163         fprintf (<a class="code" href="general_8h.html#a34">datafp</a>, <span class="stringliteral">"Next Point in Trajectory\n"</span>);
00164       }
00165 
00166       <span class="comment">/*----------------------GET DX'S-------------------------*</span>
00167 <span class="comment">       *  Based on actual position, Calculates Change in X nec *</span>
00168 <span class="comment">       *  This feedback loop is necessary because this system  *</span>
00169 <span class="comment">       *  is highly nonlinear.                                 *</span>
00170 <span class="comment">       *-------------------------------------------------------*/</span>
00171       <span class="keywordflow">for</span> (i = 0; i &lt;  N; i++)
00172       {
00173         <span class="keywordflow">if</span> (<a class="code" href="fsp_8c.html#a0">DEBUG</a>) fprintf(<a class="code" href="general_8h.html#a34">datafp</a>,<span class="stringliteral">"%s : %9f\n"</span>, <a class="code" href="general_8h.html#a40">dxLabel</a>[i], XTraj[<a class="code" href="general_8h.html#a55">STEP</a>][i]);    
00174         dx -&gt; p[i][0] = XTraj[<a class="code" href="general_8h.html#a55">STEP</a>][i] - x_of_link-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[<a class="code" href="general_8h.html#a57">Robot</a>-&gt;<a class="code" href="structManipulator__struct.html#Manipulator__structo1">NL</a>][i];
00175         Pos_error-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[i][0]=XTraj[<a class="code" href="general_8h.html#a55">STEP</a>?<a class="code" href="general_8h.html#a55">STEP</a>-1:0][i] - x_of_link-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[<a class="code" href="general_8h.html#a57">Robot</a>-&gt;<a class="code" href="structManipulator__struct.html#Manipulator__structo1">NL</a>][i];
00176         <span class="keywordflow">if</span> ( fabs( dx-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[i][0] ) &lt; <a class="code" href="general_8h.html#a13">SMALL</a> ) dx-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[i][0]=<a class="code" href="general_8h.html#a15">ZERO</a>;
00177         <span class="keywordflow">if</span> (( i &lt; 3) &amp;&amp; ( fabs(dx-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[i][0]) &gt; <a class="code" href="general_8h.html#a12">BIG</a>) ) <a class="code" href="useful__UTILS_8c.html#a0">IKerror</a>(26,<a class="code" href="general_8h.html#a24">OK</a>,<a class="code" href="general_8h.html#a40">dxLabel</a>[i]);
00178       }                      
00179 
00180       <span class="keywordflow">if</span> (<a class="code" href="fsp_8c.html#a0">DEBUG</a>) <a class="code" href="useful__UTILS_8c.html#a6">fmat_prf</a>(<a class="code" href="general_8h.html#a34">datafp</a>,<span class="stringliteral">"Pos Error (Cur Pos - Prev Target)"</span>,Pos_error);
00181 
00182       <span class="comment">/*--------------------------------------------------------*</span>
00183 <span class="comment">       * CONVERT INCREMENTAL EULER ANGLES INTO INCREMENTAL      *</span>
00184 <span class="comment">       * ANGLES ABOUT EACH AXIS OF BASE FRAME                   *</span>
00185 <span class="comment">       *--------------------------------------------------------*/</span>
00186 
00187       <span class="keywordflow">if</span> (<a class="code" href="general_8h.html#a57">Robot</a>-&gt;<a class="code" href="structManipulator__struct.html#Manipulator__structo4">Orient</a>)
00188       {
00189         <span class="comment">/* fix the 180 == -180 problem for yaw and roll, see correct_euler() */</span>
00190         dx-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[3][0] =
00191         <a class="code" href="IKOR__driver_8c.html#a3">correct_euler</a>( dx-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[3][0],x_of_link-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[<a class="code" href="general_8h.html#a57">Robot</a>-&gt;<a class="code" href="structManipulator__struct.html#Manipulator__structo1">NL</a>][3],XTraj[<a class="code" href="general_8h.html#a55">STEP</a>+1][3]);
00192         dx-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[5][0] =
00193         <a class="code" href="IKOR__driver_8c.html#a3">correct_euler</a>( dx-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[5][0],x_of_link-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[<a class="code" href="general_8h.html#a57">Robot</a>-&gt;<a class="code" href="structManipulator__struct.html#Manipulator__structo1">NL</a>][5],XTraj[<a class="code" href="general_8h.html#a55">STEP</a>+1][5]);
00194 
00195         <a class="code" href="IKOR__driver_8c.html#a2">Euler_to_Velocities</a> (x_of_link, dx);
00196         <span class="keywordflow">if</span> (<a class="code" href="general_8h.html#a57">Robot</a>-&gt;<a class="code" href="structManipulator__struct.html#Manipulator__structo4">Orient</a> == <a class="code" href="general_8h.html#a22">ZEROD_OMEGAS</a>) 
00197           dx-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[3][0]=dx-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[4][0]=dx-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[5][0]=<a class="code" href="general_8h.html#a15">ZERO</a>;
00198       }
00199 <span class="preprocessor">    #else</span>
00200 <span class="preprocessor"></span>      <a class="code" href="useful__UTILS_8c.html#a3">GetData</a>(Jacob, dx);
00201       <a class="code" href="general_8h.html#a55">STEP</a> = Num_Of_Pts;
00202 <span class="preprocessor">    #endif</span>
00203 <span class="preprocessor"></span>    
00204     <span class="comment">/*-------------------------------------------------------*</span>
00205 <span class="comment">     * CALCULATE dq'S USING ALGORITHM Selected by IKMethod   *</span>
00206 <span class="comment">     *-------------------------------------------------------*/</span>
00207 
00208     FSP_data-&gt;<a class="code" href="structSolutions.html#Solutionso4">cn</a> = 0;      <span class="comment">/* reintialize num of constraints for each STEP */</span>
00209     <span class="keywordflow">if</span> (IKCriterion[0] != 1) 
00210       dq = <a class="code" href="IKOR__driver_8c.html#a5">FSP</a> (FSP_data, &amp;Old_DQs, Jacob, dx, IKCriterion, IKMethod, 
00211                         Optimization, ns, spheredata, x_of_link, <a class="code" href="general_8h.html#a34">datafp</a>);
00212     <span class="keywordflow">else</span>
00213       dq = <a class="code" href="IKOR__driver_8c.html#a4">CALC_PSEUDO</a> (Jacob, dx);
00214     <span class="keywordflow">if</span> (dq== (<a class="code" href="structMATRIX.html">MATRIX</a> *) -1) <span class="keywordflow">break</span>;
00215  
00216     <span class="comment">/*-----------------------------------------------------------*</span>
00217 <span class="comment">     *  Determine Distance Traveled                              *</span>
00218 <span class="comment">     *-----------------------------------------------------------*/</span>
00219 
00220     <span class="comment">/*-----------------------------------------------------------*</span>
00221 <span class="comment">     *   Now add the necessary changes in angles to the current  *</span>
00222 <span class="comment">     *   Angles and keep values within 4 PI                      *</span>
00223 <span class="comment">     *-----------------------------------------------------------*/</span>
00224     <span class="keywordflow">for</span> (i = 0; i &lt; M; i++)
00225     {
00226       <span class="keywordflow">if</span> ((IKCriterion[0]!=1)&amp;&amp;(fabs(FSP_data-&gt;<a class="code" href="structSolutions.html#Solutionso10">Xelim</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[i][0]) &gt; <a class="code" href="general_8h.html#a13">SMALL</a>))
00227         dq-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[i][0] = FSP_data-&gt;<a class="code" href="structSolutions.html#Solutionso10">Xelim</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[i][0];
00228 
00229       FSP_data-&gt;<a class="code" href="structSolutions.html#Solutionso7">Qarray</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[i][0] += dq-&gt; p[i][0];
00230 
00231       <span class="keywordflow">if</span> (!<a class="code" href="general_8h.html#a57">Robot</a>-&gt;<a class="code" href="structManipulator__struct.html#Manipulator__structo10">Angles</a>[i].<a class="code" href="structANGLE.html#ANGLEo0">Prism</a>)
00232       {
00233         <span class="keywordflow">if</span> (FSP_data-&gt;<a class="code" href="structSolutions.html#Solutionso7">Qarray</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[i][0] &gt;  2*<a class="code" href="general_8h.html#a16">PI</a>) 
00234             FSP_data-&gt;<a class="code" href="structSolutions.html#Solutionso7">Qarray</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[i][0] -= 2*<a class="code" href="general_8h.html#a16">PI</a>;
00235         <span class="keywordflow">if</span> (FSP_data-&gt;<a class="code" href="structSolutions.html#Solutionso7">Qarray</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[i][0] &lt; -2*<a class="code" href="general_8h.html#a16">PI</a>) 
00236             FSP_data-&gt;<a class="code" href="structSolutions.html#Solutionso7">Qarray</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[i][0] += 2*<a class="code" href="general_8h.html#a16">PI</a>;
00237       }         <span class="comment">/* end if ! prism */</span>
00238     }   <span class="comment">/* end for i=1 to M */</span>
00239 
00240     <a class="code" href="matrix_8h.html#a11">mat_mul</a>(Jacob,dq,dx);
00241     distance = <a class="code" href="general_8h.html#a15">ZERO</a>;
00242     <span class="keywordflow">for</span> (i = 0; i&lt;3; i++) distance += dx-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[i][0] * dx-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[i][0];
00243       distance = sqrt (distance);
00244     <span class="keywordflow">for</span> (i = 0; i &lt; M; i++) {
00245       fprintf(<a class="code" href="general_8h.html#a36">dqfile</a>, <span class="stringliteral">"%10.7f"</span>, dq-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[i][0]);
00246       <span class="comment">/* specific calculations for hydrolic action of AIRARM joints */</span>
00247       <span class="comment">/*  calc_flow(i, FSP_data-&gt;Qarray-&gt;p[i][0], dq-&gt;p[i][0], </span>
00248 <span class="comment">            distance, (MATRIX *) 0); </span>
00249 <span class="comment">      */</span>
00250     }
00251     fprintf(<a class="code" href="general_8h.html#a36">dqfile</a>,<span class="stringliteral">"\n"</span>);
00252 
00253     <a class="code" href="IKOR__driver_8c.html#a8">Update_History</a>(&amp;Old_DQs, dq);
00254 
00255     <span class="keywordflow">if</span> (<a class="code" href="fsp_8c.html#a0">DEBUG</a>) {
00256       <a class="code" href="useful__UTILS_8c.html#a6">fmat_prf</a>(<a class="code" href="general_8h.html#a34">datafp</a>, <span class="stringliteral">"dq (radians)"</span>, dq);
00257       <a class="code" href="useful__UTILS_8c.html#a6">fmat_prf</a>(<a class="code" href="general_8h.html#a34">datafp</a>, <span class="stringliteral">"resulting dx"</span>, dx); 
00258       <a class="code" href="useful__UTILS_8c.html#a6">fmat_prf</a>(<a class="code" href="general_8h.html#a34">datafp</a>, <span class="stringliteral">"Qarray (radians)"</span>, FSP_data-&gt;<a class="code" href="structSolutions.html#Solutionso7">Qarray</a>);
00259     }
00260 
00261 <span class="preprocessor">    #ifdef DEBUG_OUT</span>
00262 <span class="preprocessor"></span>    <span class="comment">/*  if ((STEP%20)==1) /* uncomment for shorter output */</span>
00263       <a class="code" href="useful__UTILS_8c.html#a7">fprint_norm</a>( <a class="code" href="Globals_8h.html#a2">NormFile</a>, dq, <a class="code" href="general_8h.html#a34">datafp</a> );
00264     <span class="comment">/*  fprint_norm( ErrorFile, Pos_error, datafp ); */</span>
00265 <span class="preprocessor">    #endif</span>
00266 <span class="preprocessor"></span>    <a class="code" href="matrix_8h.html#a8">mat_free</a>(dq);           <span class="comment">/* free up dq for next step or end  */</span>
00267 
00268     <span class="keywordflow">if</span> (quit &lt; 0) <span class="keywordflow">break</span>;    <span class="comment">/* If unavoidable trouble quit      */</span>
00269   }  <span class="comment">/* END MAIN FOR LOOP*/</span>
00270 
00271 
00272 
00273   <span class="comment">/*-------------------------------------------------------------*</span>
00274 <span class="comment">   *                         FINAL SUMMARY                       *</span>
00275 <span class="comment">   *-------------------------------------------------------------*/</span>
00276   fprintf (<a class="code" href="general_8h.html#a34">datafp</a>, <span class="stringliteral">"\n\n ----FINAL SUMMARY------\n"</span>
00277                        <span class="stringliteral">" --- Exit Status: %d ---\n"</span>
00278                        <span class="stringliteral">" Errors in final point:  \n"</span>, quit);
00279 
00280   fprintf (<a class="code" href="general_8h.html#a34">datafp</a>, <span class="stringliteral">"\nStarting Coordinates:\n"</span>);
00281   <span class="keywordflow">for</span> (i = 0; i &lt; N; i++)
00282     fprintf (<a class="code" href="general_8h.html#a34">datafp</a>, <span class="stringliteral">"Element [%d] &gt;%f\n"</span>, i, XTraj[0][i]);
00283 
00284   fprintf (<a class="code" href="general_8h.html#a34">datafp</a>, <span class="stringliteral">"\nRequested Ending Coordinates\n"</span>);
00285   <span class="keywordflow">for</span> (i = 0; i &lt; N; i++)
00286     fprintf (<a class="code" href="general_8h.html#a34">datafp</a>, <span class="stringliteral">"Element [%d] &gt;%f\n"</span>, i, XTraj[Num_Of_Pts-1][i]);
00287 
00288   <a class="code" href="useful__UTILS_8c.html#a5">fmat_pr</a> (<a class="code" href="general_8h.html#a34">datafp</a>, <span class="stringliteral">"Actual Ending Coordinates:"</span>, x_of_link);
00289 
00290 <span class="preprocessor">  #ifdef DEBUG_OUT</span>
00291 <span class="preprocessor"></span>    fprintf (stderr,<span class="stringliteral">"\n DATA FILE %s HAS BEEN CREATED AND CONTAINS\n"</span>
00292                       <span class="stringliteral">" THE ANGLES FOR THE MANIPULATOR FOR EACH TIME  \n"</span>
00293                       <span class="stringliteral">" STEP.  EXAMINE, OR RUN IT THROUGH A SIMULATOR.\n"</span>, 
00294                         <a class="code" href="general_8h.html#a38">PoorMansFile</a>);
00295 <span class="preprocessor">  #endif</span>
00296 <span class="preprocessor"></span>
00297   <span class="comment">/*------------------------------------------------------------------*</span>
00298 <span class="comment">   * Clean up Global variables and Close Files                        *</span>
00299 <span class="comment">   *------------------------------------------------------------------*/</span>
00300   fclose(<a class="code" href="Globals_8h.html#a3">ErrorFile</a>);
00301   fclose(<a class="code" href="Globals_8h.html#a2">NormFile</a>);
00302   fclose(<a class="code" href="Globals_8h.html#a4">CheezyFile</a>);
00303   fclose(<a class="code" href="general_8h.html#a34">datafp</a>);
00304 
00305   <a class="code" href="useful__UTILS_8c.html#a2">Solutions_free</a>(FSP_data);
00306   <a class="code" href="matrix_8h.html#a8">mat_free</a>(Pos_error);
00307   <a class="code" href="matrix_8h.html#a8">mat_free</a>(x_of_link);
00308   <a class="code" href="matrix_8h.html#a8">mat_free</a>(Jacob);
00309   <a class="code" href="matrix_8h.html#a8">mat_free</a>(dx);
00310   <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="structures_8h.html#a0">HIST_SIZE</a>; i++)
00311     <a class="code" href="matrix_8h.html#a8">mat_free</a>(Old_DQs.<a class="code" href="structHistory.html#Historyo1">dq</a>[i].<a class="code" href="structHistory__Element.html#History__Elemento1">DQ</a>);
00312   free (<a class="code" href="general_8h.html#a58">LL</a>);
00313 
00314   <span class="keywordflow">return</span> (quit);
00315 }                            <span class="comment">/* END IKOR_driver */</span>
00316 
00317 
00318 <span class="comment">/* ________________________________________________________</span>
00319 <span class="comment">  | name:    Euler_to_Velocities                           |</span>
00320 <span class="comment">  | description:  Converts Euler Angle increments produced |</span>
00321 <span class="comment">  |       by the forward kinematics into angular velocites |</span>
00322 <span class="comment">  |       about each of the major axes (X, Y, and Z).  The |</span>
00323 <span class="comment">  |       conversion matrix can be found in Robotics: Con- |</span>
00324 <span class="comment">  |       trol, Sensing, Vision, and Intelligence p235.    |</span>
00325 <span class="comment">  |                                                        |</span>
00326 <span class="comment">  | inputs:  Euler Angles held in x_of_link, Requested     |</span>
00327 <span class="comment">  |       change in Euler Angles held in dx.               |</span>
00328 <span class="comment">  | outputs: Returns requested change in velocites held in |</span>
00329 <span class="comment">  |       the dx structure.                                |</span>
00330 <span class="comment">  |________________________________________________________|</span>
00331 <span class="comment">  | Authors:     Date:     Modifications:                  |</span>
00332 <span class="comment">  |  c hacker     5/95     implemented                     |</span>
00333 <span class="comment">  |________________________________________________________| */</span>
00334 
<a name="l00335"></a><a class="code" href="IKOR__driver_8c.html#a2">00335</a> <span class="keywordtype">void</span> <a class="code" href="IKOR__driver_8c.html#a2">Euler_to_Velocities</a> (<a class="code" href="structMATRIX.html">MATRIX</a> *x_of_link, <a class="code" href="structMATRIX.html">MATRIX</a> *dx)
00336 {
00337   <span class="keywordtype">float</span>  dGAMMA, gamma,                 <span class="comment">/* Euler Angles with deltas       */</span>
00338          dBETA,  beta,                  <span class="comment">/* Euler Angles with deltas       */</span>
00339          dALPHA, alpha;                 <span class="comment">/* Euler Angles with deltas       */</span>
00340          
00341 
00342   gamma    = x_of_link-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[<a class="code" href="general_8h.html#a57">Robot</a>-&gt;<a class="code" href="structManipulator__struct.html#Manipulator__structo1">NL</a>][3];      
00343   dGAMMA   = dx-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[3][0];
00344 
00345   beta     = x_of_link-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[<a class="code" href="general_8h.html#a57">Robot</a>-&gt;<a class="code" href="structManipulator__struct.html#Manipulator__structo1">NL</a>][4];
00346   dBETA    = dx-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[4][0];
00347 
00348   alpha    = x_of_link-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[<a class="code" href="general_8h.html#a57">Robot</a>-&gt;<a class="code" href="structManipulator__struct.html#Manipulator__structo1">NL</a>][5];
00349   dALPHA   = dx-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[5][0];
00350 
00351   <span class="comment">/* wx */</span>  dx-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[3][0]= dALPHA*cos(gamma)*cos(beta) - dBETA*sin(gamma); 
00352   <span class="comment">/* wy */</span>  dx-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[4][0]= dALPHA*sin(gamma)*cos(beta) + dBETA*cos(gamma);
00353   <span class="comment">/* wz */</span>  dx-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[5][0]=-dALPHA*sin(beta)            + dGAMMA;
00354 
00355   <span class="keywordflow">if</span> (<a class="code" href="fsp_8c.html#a0">DEBUG</a>) {
00356     fprintf(<a class="code" href="general_8h.html#a34">datafp</a>,<span class="stringliteral">"\nEuler Velocity Transforms and Corrections\n"</span>);
00357     fprintf(<a class="code" href="general_8h.html#a34">datafp</a>,<span class="stringliteral">"\n%s%12.8f%s%12.8f\n%s%12.8f%s%12.8f\n%s%12.8f%s%12.8f\n"</span>,
00358                    <span class="stringliteral">"YAW  :  gamma    : "</span>, gamma  , <span class="stringliteral">"   dGAMMA   : "</span>, dGAMMA,
00359                    <span class="stringliteral">"PITCH:  beta     : "</span>, beta   , <span class="stringliteral">"   dBETA    : "</span>, dBETA,
00360                    <span class="stringliteral">"ROLL :  alpha    : "</span>, alpha  , <span class="stringliteral">"   dALPHA   : "</span>, dALPHA );
00361     fprintf(<a class="code" href="general_8h.html#a34">datafp</a>,<span class="stringliteral">"dx(wx) : %12.8f\ndx(wy) : %12.8f\ndx(wz) : %12.8f\n"</span>,
00362                    (dx-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[3][0]), (dx-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[4][0]), (dx-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[5][0]) );
00363   }
00364 }
00365 
00366 <span class="comment">/* ________________________________________________________</span>
00367 <span class="comment">  | name:    correct_euler                                 |</span>
00368 <span class="comment">  | description:  Because yaw and pitch are equivalent     |</span>
00369 <span class="comment">  |       when the angle = 180 and -180 degrees, a dx      |</span>
00370 <span class="comment">  |       that is calculated at this edge can be erroneous.|</span>
00371 <span class="comment">  |       That is, -180 - 180 = -360 when the only requir- |</span>
00372 <span class="comment">  |       required change is really 0.  This code corrects |</span>
00373 <span class="comment">  |       for this orientation situation.                  |</span>
00374 <span class="comment">  |                                                        |</span>
00375 <span class="comment">  | inputs:  yaw or roll, current position, and destina-   |</span>
00376 <span class="comment">  |       tion position.                                   |</span>
00377 <span class="comment">  | outputs: Returns corrected change in velocites.        |</span>
00378 <span class="comment">  |________________________________________________________|</span>
00379 <span class="comment">  | Authors:     Date:     Modifications:                  |</span>
00380 <span class="comment">  |  c hacker     5/95     implemented                     |</span>
00381 <span class="comment">  |________________________________________________________| */</span>
00382 
<a name="l00383"></a><a class="code" href="IKOR__driver_8c.html#a3">00383</a> <span class="keywordtype">float</span> <a class="code" href="IKOR__driver_8c.html#a3">correct_euler</a> ( <span class="keywordtype">float</span> angle, <span class="keywordtype">float</span> curr, <span class="keywordtype">float</span> dest )
00384 {
00385 
00386   <span class="comment">/* check if faulty condition exists */</span>
00387   <span class="keywordflow">if</span> ( fabs( angle ) &gt; <a class="code" href="general_8h.html#a16">PI</a> )
00388   {
00389     <span class="keywordflow">if</span> (<a class="code" href="fsp_8c.html#a0">DEBUG</a>) fprintf(<a class="code" href="general_8h.html#a34">datafp</a>,<span class="stringliteral">"\nFaulty orientation velocity, old: %f"</span>, angle); 
00390 
00391     angle = <a class="code" href="general_8h.html#a16">PI</a> - fabs(dest) + <a class="code" href="general_8h.html#a16">PI</a> - fabs(curr); 
00392     <span class="comment">/* correct for sign */</span>
00393     <span class="keywordflow">if</span> (( curr &lt; 0 ) &amp;&amp; ( dest &gt; 0 ))
00394        angle = -angle;
00395 
00396     <span class="keywordflow">if</span> (<a class="code" href="fsp_8c.html#a0">DEBUG</a>) fprintf(<a class="code" href="general_8h.html#a34">datafp</a>, <span class="stringliteral">"... new: %f\n"</span>, angle);
00397   }
00398   <span class="comment">/* return corrected or non-corrected angle */</span>
00399   <span class="keywordflow">return</span> (angle);
00400 }
00401 
00402 
00403 <span class="comment">/* ________________________________________________________</span>
00404 <span class="comment">  | name:    CALC_PSEUDO                                   |</span>
00405 <span class="comment">  | description:  Calculate Change in Angles using Pseudo  |</span>
00406 <span class="comment">  |     Inverse. The procedure prepares the Jacobian and   |</span>
00407 <span class="comment">  |     calls the routine mat_pseudoinv() found in the     |</span>
00408 <span class="comment">  |     file matrix.c                                      |</span>
00409 <span class="comment">  |                                                        |</span>
00410 <span class="comment">  | inputs:  Jacobian and change in x                      |</span>
00411 <span class="comment">  | outputs: Returns dq necessary to complete motion.      |</span>
00412 <span class="comment">  |________________________________________________________|</span>
00413 <span class="comment">  | Authors:     Date:     Modifications:                  |</span>
00414 <span class="comment">  |  F Tulloch    4/94     Algorithm Creation for 2 g's    |</span>
00415 <span class="comment">  |  c hacker     3/95     rearranged calling structure    |</span>
00416 <span class="comment">  |               3/95     took struct from "struct MATRIX"|</span>
00417 <span class="comment">  |________________________________________________________| */</span>
00418 
<a name="l00419"></a><a class="code" href="IKOR__driver_8c.html#a4">00419</a> <a class="code" href="structMATRIX.html">MATRIX</a> *<a class="code" href="IKOR__driver_8c.html#a4">CALC_PSEUDO</a> (<a class="code" href="structMATRIX.html">MATRIX</a> *Jacob, <a class="code" href="structMATRIX.html">MATRIX</a> *dx)
00420 {
00421   <span class="keywordtype">int</span>    i, j;           <span class="comment">/* counter variables                */</span>
00422   <a class="code" href="structMATRIX.html">MATRIX</a> *Jacobinv,      <span class="comment">/* Holds Jacobian Psuedo-inverse    */</span>
00423          *dq;            <span class="comment">/* Holds delta angle changes needed */</span>
00424 
00425   Jacobinv = <a class="code" href="matrix_8h.html#a25">mat_malloc</a>(M,M);
00426 
00427   <a class="code" href="matrix_8h.html#a20">mat_cp</a>(Jacob, Jacobinv);
00428 
00429   <span class="keywordflow">for</span> (i=0;i&lt;M;i++)      <span class="comment">/* Must be padded with zeros        */</span>
00430     <span class="keywordflow">for</span> (j=N; j&lt; M; j++)
00431       Jacobinv-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[j][i] = 0.0;
00432 
00433   <a class="code" href="matrix_8h.html#a16">mat_pseudoinv</a>(Jacobinv); <span class="comment">/* JacobTemp holds jacob's inverse */</span>
00434 
00435   Jacobinv-&gt;<a class="code" href="structMATRIX.html#MATRIXo2">cols</a> = N;
00436   dq = <a class="code" href="matrix_8h.html#a26">mat_mul2</a>(Jacobinv, dx);
00437   Jacobinv-&gt;<a class="code" href="structMATRIX.html#MATRIXo2">cols</a> = M;
00438 
00439   <span class="keywordflow">if</span> (<a class="code" href="fsp_8c.html#a0">DEBUG</a>) {
00440      <a class="code" href="useful__UTILS_8c.html#a5">fmat_pr</a>(<a class="code" href="general_8h.html#a34">datafp</a>,<span class="stringliteral">"*** Jacobian ***"</span>,  Jacob);
00441      <a class="code" href="useful__UTILS_8c.html#a6">fmat_prf</a>(<a class="code" href="general_8h.html#a34">datafp</a>,<span class="stringliteral">"requested dx"</span>,     dx);
00442   }
00443 
00444   <a class="code" href="matrix_8h.html#a8">mat_free</a>(Jacobinv);
00445   <span class="keywordflow">return</span> (dq);  
00446 }
00447 
00448 
00449 <span class="comment">/* ________________________________________________________</span>
00450 <span class="comment">  | name:    FSP                                           |</span>
00451 <span class="comment">  | description:  This procedure calculates the changes in |</span>
00452 <span class="comment">  |     angles via the new algorithm (FSP). It also calls  |</span>
00453 <span class="comment">  |     routines to check for obstacles, limits, ect...    |</span>
00454 <span class="comment">  |     Finally, a procedure to find a particular para-    |</span>
00455 <span class="comment">  |     metric solution based on constraints, criteria.    |</span>
00456 <span class="comment">  |     The reason for several find_t functions is due to  |</span>
00457 <span class="comment">  |     speed considerations, so that, the find_t that gets|</span>
00458 <span class="comment">  |     called should be the fastest.                      |</span>
00459 <span class="comment">  |                                                        |</span>
00460 <span class="comment">  | inputs:  Jacobian, change in x, IKmethod, sphere data, |</span>
00461 <span class="comment">  |     and position.                                      |</span>
00462 <span class="comment">  | outputs: Returns dq necessary to complete motion.      |</span>
00463 <span class="comment">  |________________________________________________________|</span>
00464 <span class="comment">  | Authors:     Date:     Modifications:                  |</span>
00465 <span class="comment">  |  F Tulloch    4/94     Algorithm Creation for 2 g's    |</span>
00466 <span class="comment">  |  c hacker     3/95     rearranged calling structure    |</span>
00467 <span class="comment">  |               3/95     took struct from "struct MATRIX"|</span>
00468 <span class="comment">  |               3/95     converted to ONE STEP Method    |</span>
00469 <span class="comment">  |________________________________________________________| */</span>
00470 
<a name="l00471"></a><a class="code" href="IKOR__driver_8c.html#a5">00471</a> <a class="code" href="structMATRIX.html">MATRIX</a> *<a class="code" href="IKOR__driver_8c.html#a5">FSP</a>(FSP_data, Old_DQs, Jacob, dx, IKCriterion, IKMethod, Optimization,
00472                 ns, spheredata, x_of_link, datafp)
00473 FILE   *<a class="code" href="general_8h.html#a34">datafp</a>;            <span class="comment">/* data file declaration          */</span>
00474 <span class="keywordtype">int</span>     *IKCriterion,      <span class="comment">/* Criterion                      */</span>
00475         *IKMethod,         <span class="comment">/* 0-JL,2-OBS ... contraints      */</span>
00476          Optimization,     <span class="comment">/* LAGRANGE,BANGBANG,SIMPLEX      */</span>
00477          ns;               <span class="comment">/* sphere_data (# of spheres)     */</span>
00478 <span class="keywordtype">double</span>  spheredata[4][4];  <span class="comment">/* sphere_data (rad,x,y,z)        */</span>
00479 <a class="code" href="structMATRIX.html">MATRIX</a> *dx,                <span class="comment">/* change in EE position          */</span>
00480        *Jacob,             <span class="comment">/* derivative of Forward Kinematic*/</span>
00481        *x_of_link;         <span class="comment">/* position of all links          */</span>
00482 <a class="code" href="structSolutions.html">Solutions</a> *FSP_data;       <span class="comment">/* see structures.h               */</span>
00483 <a class="code" href="structHistory.html">History</a> *Old_DQs;
00484 {
00485   <span class="keywordtype">int</span>     i, j, k,     <span class="comment">/* counter variables                   */</span>
00486           got_gs=<a class="code" href="general_8h.html#a17">TRUE</a>, <span class="comment">/* For TWOSTEP, flag if 2nd g's made   */</span>
00487           Terminate;   <span class="comment">/* Termination Status of FSP           */</span>
00488   <a class="code" href="structMATRIX.html">MATRIX</a> *dq,          <span class="comment">/* final solution for joint space move */</span>
00489          *B,
00490          *H;
00491 
00492   Terminate = <a class="code" href="headers_8h.html#a14">Solution_generator</a>(FSP_data, Jacob, dx, <a class="code" href="general_8h.html#a34">datafp</a>); 
00493   <span class="keywordflow">if</span> (Terminate == <a class="code" href="general_8h.html#a32">NOT_COMPLETE</a>) <a class="code" href="useful__UTILS_8c.html#a0">IKerror</a>(10, <a class="code" href="general_8h.html#a23">FATAL</a>, <span class="stringliteral">""</span>);
00494   B = <a class="code" href="matrix_8h.html#a25">mat_malloc</a> (  M,    M );
00495   H = <a class="code" href="matrix_8h.html#a25">mat_malloc</a> (  <a class="code" href="general_8h.html#a1">SPAN</a>, 1 );
00496 
00497   <span class="keywordflow">switch</span> (IKCriterion[0]) {
00498      <span class="keywordflow">case</span> 0: <a class="code" href="headers_8h.html#a32">Least_Norm</a> (B, H, <a class="code" href="general_8h.html#a34">datafp</a>); <span class="keywordflow">break</span>;
00499      <span class="keywordflow">case</span> 1:  <span class="comment">/* This is Least Norm and Should Not Be Called Here */</span>
00500      <span class="keywordflow">case</span> 2:  <span class="comment">/* MinDx   ();  (implemented in IKORv2.6, not here) */</span>
00501      <span class="keywordflow">case</span> 3:  <span class="comment">/* MinDist ();  (implemented in IKORv2.6, not here) */</span>
00502      <span class="keywordflow">case</span> 4: <a class="code" href="headers_8h.html#a33">Least_Flow</a> (B, H, FSP_data-&gt;<a class="code" href="structSolutions.html#Solutionso7">Qarray</a>, <a class="code" href="general_8h.html#a34">datafp</a>);  <span class="keywordflow">break</span>;
00503      <span class="keywordflow">default</span>: fprintf(stderr, <span class="stringliteral">"Requested criterion does not exist! \n"</span>);
00504               <span class="keywordflow">break</span>;
00505   }
00506 
00507   <span class="keywordflow">if</span> (Optimization == <a class="code" href="general_8h.html#a20">BANGBANG</a>)
00508   {
00509     <span class="keywordflow">if</span> (IKCriterion[0] == 4)
00510     {
00511       dq = <a class="code" href="headers_8h.html#a43">findt_without_Betas_BANGBANG</a>(FSP_data, B, H,
00512                  Old_DQs-&gt;<a class="code" href="structHistory.html#Historyo1">dq</a>[Old_DQs-&gt;<a class="code" href="structHistory.html#Historyo0">whereami</a>].DQ, <a class="code" href="general_8h.html#a34">datafp</a>);
00513     }
00514     <span class="keywordflow">else</span> <a class="code" href="useful__UTILS_8c.html#a0">IKerror</a>(31, <a class="code" href="general_8h.html#a23">FATAL</a>, <span class="stringliteral">"BANGBANG only for Flow Currently\n"</span>);
00515   }
00516   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Optimization == <a class="code" href="general_8h.html#a19">LAGRANGIAN</a>)
00517   {
00518     <span class="keywordflow">if</span> (<a class="code" href="general_8h.html#a55">STEP</a> == <a class="code" href="general_8h.html#a25">ONE</a>)
00519     {
00520       <span class="comment">/*************************************************************</span>
00521 <span class="comment">       * CONSTRAINT TESTS BRANCH                                   *</span>
00522 <span class="comment">       *************************************************************/</span>
00523       <span class="keywordflow">if</span> (IKMethod[<a class="code" href="general_8h.html#a28">OBSTACLES</a>])
00524         <a class="code" href="headers_8h.html#a30">avoid_obstacles</a> (FSP_data, Jacob, dx, x_of_link,
00525                          ns, spheredata, &amp;got_gs, <a class="code" href="general_8h.html#a34">datafp</a>);
00526       <span class="keywordflow">if</span> (IKMethod[<a class="code" href="general_8h.html#a27">JN_LIMITS</a>])
00527         <a class="code" href="headers_8h.html#a29">avoid_limits</a>    (FSP_data, Jacob, dx, &amp;got_gs, <a class="code" href="general_8h.html#a34">datafp</a>);
00528     }
00529 
00530     <span class="keywordflow">if</span> (<a class="code" href="general_8h.html#a57">Robot</a>-&gt;<a class="code" href="structManipulator__struct.html#Manipulator__structo11">PLAT</a>.<a class="code" href="structPlatform.html#Platformo2">Holonomic</a>)
00531       <span class="keywordflow">if</span> (FSP_data-&gt;<a class="code" href="structSolutions.html#Solutionso4">cn</a>)
00532         dq = <a class="code" href="headers_8h.html#a39">findt_with_Betas_Holonomic</a>(FSP_data, B, H, <a class="code" href="general_8h.html#a34">datafp</a>); 
00533       <span class="keywordflow">else</span>
00534         dq = <a class="code" href="headers_8h.html#a40">findt_without_Betas_Holonomic</a>(FSP_data, B, H, <a class="code" href="general_8h.html#a34">datafp</a>); 
00535     <span class="keywordflow">else</span> <span class="comment">/* Non-holonomic Platform Code */</span>
00536        <span class="keywordflow">if</span> (FSP_data-&gt;<a class="code" href="structSolutions.html#Solutionso4">cn</a>)
00537          dq = <a class="code" href="headers_8h.html#a41">findt_with_Betas_Nonholonomic</a>(FSP_data, B, H, <a class="code" href="general_8h.html#a34">datafp</a>);
00538        <span class="keywordflow">else</span>
00539          dq = <a class="code" href="headers_8h.html#a42">findt_without_Betas_Nonholonomic</a>(FSP_data, B, H, <a class="code" href="general_8h.html#a34">datafp</a>); 
00540 
00541 
00542     <span class="keywordflow">if</span> (<a class="code" href="general_8h.html#a55">STEP</a> == <a class="code" href="general_8h.html#a26">TWO</a>)
00543     {
00544       <span class="comment">/*************************************************************</span>
00545 <span class="comment">       *   Now add the necessary changes in angles to the current  *</span>
00546 <span class="comment">       *   Angles and keep values withing 4 PI                     *</span>
00547 <span class="comment">       *************************************************************/</span>
00548       got_gs = <a class="code" href="general_8h.html#a18">FALSE</a>;
00549 
00550       <span class="keywordflow">for</span> (i = 0; i &lt; M; i++)
00551       {
00552         <span class="keywordflow">if</span> (fabs(FSP_data-&gt;<a class="code" href="structSolutions.html#Solutionso10">Xelim</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[i][0]) &gt; <a class="code" href="general_8h.html#a13">SMALL</a>)
00553            dq-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[i][0] = FSP_data-&gt;<a class="code" href="structSolutions.html#Solutionso10">Xelim</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[i][0];
00554 
00555         FSP_data-&gt;<a class="code" href="structSolutions.html#Solutionso7">Qarray</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[i][0] += dq-&gt; p[i][0];
00556 
00557         <span class="keywordflow">if</span> (!<a class="code" href="general_8h.html#a57">Robot</a>-&gt;<a class="code" href="structManipulator__struct.html#Manipulator__structo10">Angles</a>[i].<a class="code" href="structANGLE.html#ANGLEo0">Prism</a>)
00558         {
00559           <span class="keywordflow">if</span> (FSP_data-&gt;<a class="code" href="structSolutions.html#Solutionso7">Qarray</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[i][0] &gt;  2*<a class="code" href="general_8h.html#a16">PI</a>) 
00560               FSP_data-&gt;<a class="code" href="structSolutions.html#Solutionso7">Qarray</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[i][0] -= 2*<a class="code" href="general_8h.html#a16">PI</a>;
00561           <span class="keywordflow">if</span> (FSP_data-&gt;<a class="code" href="structSolutions.html#Solutionso7">Qarray</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[i][0] &lt; -2*<a class="code" href="general_8h.html#a16">PI</a>) 
00562               FSP_data-&gt;<a class="code" href="structSolutions.html#Solutionso7">Qarray</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[i][0] += 2*<a class="code" href="general_8h.html#a16">PI</a>;
00563         }       <span class="comment">/* end if ! prism */</span>
00564         dq -&gt; p[i][0] = <a class="code" href="general_8h.html#a15">ZERO</a>;   <span class="comment">/* Reset dq's in case of no constraints */</span>
00565       }   <span class="comment">/* end for i=1 to M */</span>
00566 
00567 
00568       <span class="comment">/*************************************************************</span>
00569 <span class="comment">       * CONSTRAINT TESTS BRANCH                                   *</span>
00570 <span class="comment">       *************************************************************/</span>
00571       <span class="keywordflow">if</span> (IKMethod[<a class="code" href="general_8h.html#a28">OBSTACLES</a>])
00572         <a class="code" href="headers_8h.html#a30">avoid_obstacles</a> (FSP_data, Jacob, dx, x_of_link, 
00573                          ns, spheredata, &amp;got_gs, <a class="code" href="general_8h.html#a34">datafp</a>);
00574       <span class="keywordflow">if</span> (IKMethod[<a class="code" href="general_8h.html#a27">JN_LIMITS</a>])
00575         <a class="code" href="headers_8h.html#a29">avoid_limits</a>    (FSP_data, Jacob, dx, &amp;got_gs, <a class="code" href="general_8h.html#a34">datafp</a>);
00576 
00577       <span class="keywordflow">if</span> (got_gs) 
00578       {
00579         <a class="code" href="IKOR__driver_8c.html#a8">Update_History</a>(Old_DQs, dq);
00580         <a class="code" href="matrix_8h.html#a8">mat_free</a>(dq);   <span class="comment">/* dq has been allocated already by findt */</span>
00581         <span class="keywordflow">if</span> (<a class="code" href="general_8h.html#a57">Robot</a>-&gt;<a class="code" href="structManipulator__struct.html#Manipulator__structo11">PLAT</a>.<a class="code" href="structPlatform.html#Platformo2">Holonomic</a>)
00582            dq = <a class="code" href="headers_8h.html#a39">findt_with_Betas_Holonomic</a>(FSP_data, B, H, <a class="code" href="general_8h.html#a34">datafp</a>);
00583         <span class="keywordflow">else</span>
00584            dq = <a class="code" href="headers_8h.html#a41">findt_with_Betas_Nonholonomic</a>(FSP_data, B, H, <a class="code" href="general_8h.html#a34">datafp</a>);
00585       }
00586     }
00587   }                                     <span class="comment">/* end else LAGRANGIAN */</span>
00588   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Optimization == <a class="code" href="general_8h.html#a21">SIMPLEX</a>)
00589   {
00590     <span class="keywordflow">if</span> (IKCriterion[0] == 4)
00591     {
00592       dq = <a class="code" href="headers_8h.html#a44">findt_without_Betas_SIMPLX</a>(FSP_data, B, H, <a class="code" href="general_8h.html#a34">datafp</a>);
00593     }
00594     <span class="keywordflow">else</span> <a class="code" href="useful__UTILS_8c.html#a0">IKerror</a>(31, <a class="code" href="general_8h.html#a23">FATAL</a>, <span class="stringliteral">"SIMPLX only for Flow Currently\n"</span>);
00595   }                                     <span class="comment">/* end SIMPLEX */</span>
00596 
00597 
00598   <a class="code" href="matrix_8h.html#a8">mat_free</a> (B);
00599   <a class="code" href="matrix_8h.html#a8">mat_free</a> (H);
00600 
00601   <span class="keywordflow">return</span>(dq);
00602 }<span class="comment">/*END ROUTINE*/</span>
00603 
00604 
00605 
00606 <span class="comment">/* ________________________________________________________</span>
00607 <span class="comment">  | name:    OPEN_FILES                                    |</span>
00608 <span class="comment">  | description:  This procedure opens most of the system  |</span>
00609 <span class="comment">  |     files (spheredata is in spheres() in useful_UTILS.c|</span>
00610 <span class="comment">  |     Also the initial condition to the differential     |</span>
00611 <span class="comment">  |     equation (notably Qarray, initial Angles) is def-  |</span>
00612 <span class="comment">  |     ined, and a trajectory file is read into XTraj.    |</span>
00613 <span class="comment">  |                                                        |</span>
00614 <span class="comment">  | inputs:  XTraj, angle output file, Qarray              |</span>
00615 <span class="comment">  | outputs: XTraj contains trajectory, Qarray has initial |</span>
00616 <span class="comment">  |     angle values.                                      |</span>
00617 <span class="comment">  |________________________________________________________|</span>
00618 <span class="comment">  | Authors:     Date:     Modifications:                  |</span>
00619 <span class="comment">  |  F Tulloch    2/92     Who knows who started this one  |</span>
00620 <span class="comment">  |  c hacker    10/94     restructured, removed globals   |</span>
00621 <span class="comment">  |________________________________________________________| */</span>
<a name="l00622"></a><a class="code" href="IKOR__driver_8c.html#a6">00622</a> <span class="keywordtype">int</span> <a class="code" href="IKOR__driver_8c.html#a6">OPEN_FILES</a>(XTraj, PoorMansFile, Qarray)
00623 <span class="keywordtype">char</span>   *<a class="code" href="general_8h.html#a38">PoorMansFile</a>;
00624 <span class="keywordtype">double</span>  XTraj[<a class="code" href="general_8h.html#a11">MAX_PTS</a>][6];
00625 <a class="code" href="structMATRIX.html">MATRIX</a> *Qarray;
00626 {                       
00627   FILE  *XYZfile, *EAfile;
00628   <span class="keywordtype">int</span>    i, Num_Of_Pts,
00629          flag = -1,
00630          fatal=  1;
00631   <span class="keywordtype">char</span>   tempname[20];
00632   <span class="keywordtype">float</span>  temp_Q;
00633 
00634   <span class="comment">/*********************FILE INITIALIZATION*************************/</span>
00635 <span class="preprocessor">  #ifdef DEBUG_OUT</span>
00636 <span class="preprocessor"></span>    fprintf (stderr, <span class="stringliteral">"\nANGLES PRINTED TO %s.\n"</span>, <a class="code" href="general_8h.html#a38">PoorMansFile</a>);
00637 <span class="preprocessor">  #endif</span>
00638 <span class="preprocessor"></span>
00639   <span class="keywordflow">if</span> (<a class="code" href="general_8h.html#a57">Robot</a>-&gt;<a class="code" href="structManipulator__struct.html#Manipulator__structo4">Orient</a>)
00640     <span class="keywordflow">if</span> ((EAfile     = fopen(<span class="stringliteral">"EulerAngles"</span>,  <span class="stringliteral">"r"</span>)) == NULL) 
00641       { <a class="code" href="useful__UTILS_8c.html#a0">IKerror</a> (11, <a class="code" href="general_8h.html#a24">OK</a>, <span class="stringliteral">"EulerAngles"</span>);   flag = 0; }
00642   <span class="keywordflow">if</span> ((XYZfile    = fopen(<span class="stringliteral">"TrajectoryPts"</span>,<span class="stringliteral">"r"</span>)) == NULL)
00643      { <a class="code" href="useful__UTILS_8c.html#a0">IKerror</a> (11, <a class="code" href="general_8h.html#a24">OK</a>, <span class="stringliteral">"TrajectoryPts"</span>); flag = 0; }
00644   <span class="keywordflow">if</span> ((<a class="code" href="Globals_8h.html#a4">CheezyFile</a> = fopen(<a class="code" href="general_8h.html#a38">PoorMansFile</a>,   <span class="stringliteral">"w"</span>)) == NULL) 
00645      { <a class="code" href="useful__UTILS_8c.html#a0">IKerror</a> (11, <a class="code" href="general_8h.html#a24">OK</a>,  <a class="code" href="general_8h.html#a38">PoorMansFile</a>);   flag = 0; }
00646   <span class="keywordflow">if</span> ((<a class="code" href="Globals_8h.html#a2">NormFile</a>   = fopen(<span class="stringliteral">"NORMFILE"</span>,     <span class="stringliteral">"w"</span>)) == NULL) 
00647      { <a class="code" href="useful__UTILS_8c.html#a0">IKerror</a> (11, <a class="code" href="general_8h.html#a24">OK</a>, <span class="stringliteral">"NORMFILE"</span>);      flag = 0; }
00648   <span class="keywordflow">if</span> ((<a class="code" href="Globals_8h.html#a3">ErrorFile</a>  = fopen(<span class="stringliteral">"ERRORFILE"</span>,    <span class="stringliteral">"w"</span>)) == NULL) 
00649      { <a class="code" href="useful__UTILS_8c.html#a0">IKerror</a> (11, <a class="code" href="general_8h.html#a24">OK</a>, <span class="stringliteral">"ERRORFILE"</span>);     flag = 0; }
00650   <span class="keywordflow">if</span> ((<a class="code" href="general_8h.html#a35">FLWfile</a>    = fopen(<span class="stringliteral">"FLOW"</span>,         <span class="stringliteral">"w"</span>)) == NULL) 
00651      { <a class="code" href="useful__UTILS_8c.html#a0">IKerror</a> (11, <a class="code" href="general_8h.html#a24">OK</a>, <span class="stringliteral">"FLOW"</span>);          flag = 0; }
00652   <span class="keywordflow">if</span> ((<a class="code" href="general_8h.html#a36">dqfile</a>     = fopen(<span class="stringliteral">"Delta-qs"</span>,     <span class="stringliteral">"w"</span>)) == NULL) 
00653      { <a class="code" href="useful__UTILS_8c.html#a0">IKerror</a> (11, <a class="code" href="general_8h.html#a24">OK</a>, <span class="stringliteral">"Delta-qs"</span>);      flag = 0; }
00654   <span class="keywordflow">if</span> ((<a class="code" href="general_8h.html#a37">distfp</a>     = fopen(<span class="stringliteral">"Distance"</span>,     <span class="stringliteral">"w"</span>)) == NULL) 
00655      { <a class="code" href="useful__UTILS_8c.html#a0">IKerror</a> (11, <a class="code" href="general_8h.html#a24">OK</a>, <span class="stringliteral">"Distance"</span>);      flag = 0; }
00656 
00657   <span class="keywordflow">if</span> (!flag) <a class="code" href="useful__UTILS_8c.html#a0">IKerror</a> (12, <a class="code" href="general_8h.html#a23">FATAL</a>, <span class="stringliteral">"OPEN_FILES"</span>);
00658 
00659   <span class="comment">/*------------------------------------------------------------------*/</span>
00660   <span class="comment">/* READ TRAJECTORY INTO ARRAY XTraj, MAX 3000 POINTS (makepts.h)    */</span>
00661   <span class="comment">/*------------------------------------------------------------------*/</span>
00662   fscanf(XYZfile, <span class="stringliteral">"%d"</span>, &amp;Num_Of_Pts);
00663   <span class="keywordflow">if</span> (Num_Of_Pts &gt; <a class="code" href="general_8h.html#a11">MAX_PTS</a>)
00664   { <a class="code" href="useful__UTILS_8c.html#a0">IKerror</a> (15, <a class="code" href="general_8h.html#a24">OK</a>, <span class="stringliteral">"MAX_PTS in general.h"</span>); Num_Of_Pts = <a class="code" href="general_8h.html#a11">MAX_PTS</a>; }
00665 
00666   <span class="comment">/*-----------------------------------------------------------*/</span>
00667   <span class="comment">/* Print first line of Q angles at t=0                       */</span>
00668   <span class="comment">/* terminated with a '\n'.                                   */</span>
00669   <span class="comment">/*-----------------------------------------------------------*/</span>
00670   <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="general_8h.html#a57">Robot</a>-&gt;<a class="code" href="structManipulator__struct.html#Manipulator__structo0">NA</a>; i++)
00671   {
00672     fscanf ( XYZfile, <span class="stringliteral">"%f"</span>, &amp;temp_Q);
00673     <span class="keywordflow">if</span> (i &lt; M) Qarray-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[i][0] = <a class="code" href="general_8h.html#a4">rad</a>(temp_Q);
00674   }
00675   <a class="code" href="useful__UTILS_8c.html#a5">fmat_pr</a> (<a class="code" href="general_8h.html#a34">datafp</a>, <span class="stringliteral">"Initial Q Array"</span>, Qarray);
00676   <span class="keywordflow">for</span> (i = 0; i &lt; Num_Of_Pts; i++)
00677   {
00678     fscanf(XYZfile, <span class="stringliteral">"%lf %lf %lf"</span>, 
00679                      &amp;XTraj[i][0], &amp;XTraj[i][1], &amp;XTraj[i][2]);
00680     <span class="keywordflow">if</span> (N&gt;3)
00681     fscanf(EAfile,  <span class="stringliteral">"%lf %lf %lf"</span>, 
00682                      &amp;XTraj[i][3], &amp;XTraj[i][4], &amp;XTraj[i][5]);
00683     <span class="comment">/*</span>
00684 <span class="comment">      if (DEBUG)</span>
00685 <span class="comment">        if (N&gt;3)</span>
00686 <span class="comment">          fprintf(datafp,"X,Y,Z: %6.4f %6.4f %6.4f EULER: %6.4f %6.4f %6.4f\n",</span>
00687 <span class="comment">                XTraj[i][0],XTraj[i][1],XTraj[i][2],</span>
00688 <span class="comment">                XTraj[i][3],XTraj[i][4],XTraj[i][5]);</span>
00689 <span class="comment">        else</span>
00690 <span class="comment">          fprintf(datafp,"X,Y,Z: %6.4f %6.4f %6.4f\n",</span>
00691 <span class="comment">                XTraj[i][0],XTraj[i][1],XTraj[i][2]);</span>
00692 <span class="comment">    */</span>
00693   }
00694   fclose(XYZfile);
00695   <span class="keywordflow">if</span> (N&gt;3) fclose(EAfile);
00696 
00697   <span class="comment">/*--------------------------------------------------------*/</span>
00698   <span class="comment">/* Print Header Line For IGRIP Simulation Angles File     */</span>
00699   <span class="comment">/* Which is in turn read in through Dave Reister's file   */</span>
00700   <span class="comment">/* which puts the points to the IGRIP model every so many */</span>
00701   <span class="comment">/* seconds to view the motion.                            */</span>
00702   <span class="comment">/*--------------------------------------------------------*/</span>
00703 
00704   fprintf (<a class="code" href="Globals_8h.html#a4">CheezyFile</a>, <span class="stringliteral">"M: %d N: %d\n"</span>, M, N);
00705 
00706   <span class="keywordflow">return</span> (Num_Of_Pts);
00707 }                            <span class="comment">/* END OPEN_FILES */</span>
00708 
00709 
00710 <span class="comment">/* ________________________________________________________</span>
00711 <span class="comment">  | name:    init_Globals                                  |</span>
00712 <span class="comment">  | description:  This, I'm not too proud of.  In order to |</span>
00713 <span class="comment">  |     CheezyIGRIP work with different manipulators I had |</span>
00714 <span class="comment">  |     to incorporate this, but unfortuneately CheezyIGRIP|</span>
00715 <span class="comment">  |     is indeed Cheezy in many ways, one being its thirst|</span>
00716 <span class="comment">  |     for global variables.  A,B,C,D,E,R,X and others    |</span>
00717 <span class="comment">  |     are needed to be global for the forward kinematic  |</span>
00718 <span class="comment">  |     which CheezyIGRIP uses.  Someone should eventually |</span>
00719 <span class="comment">  |     remove these globals into a structure before it    |</span>
00720 <span class="comment">  |     gets even more out of hand, but alas... tis not I. |</span>
00721 <span class="comment">  | inputs:  none                                          |</span>
00722 <span class="comment">  | outputs: As named, also initializes manipulator        |</span>
00723 <span class="comment">  |________________________________________________________|</span>
00724 <span class="comment">  | Authors:     Date:     Modifications:                  |</span>
00725 <span class="comment">  |  c hacker     3/95     created sadly                   |</span>
00726 <span class="comment">  |________________________________________________________| */</span>
00727 
<a name="l00728"></a><a class="code" href="IKOR__driver_8c.html#a7">00728</a> <span class="keywordtype">int</span> <a class="code" href="headers_8h.html#a6">Init_Globals</a>()
00729 {
00730   <span class="keywordtype">int</span> i,j;
00731   <span class="keywordtype">float</span> HandWidth   =0.05,
00732         HandLength  =0.05,
00733         FrontLength =<a class="code" href="general_8h.html#a15">ZERO</a>,
00734         SideLength  =<a class="code" href="general_8h.html#a15">ZERO</a>;
00735 
00736 
00737   <span class="keywordflow">if</span> ((<a class="code" href="general_8h.html#a34">datafp</a>   = fopen(<span class="stringliteral">"data"</span>, <span class="stringliteral">"w"</span>)) == NULL) <a class="code" href="useful__UTILS_8c.html#a0">IKerror</a> (11, <a class="code" href="general_8h.html#a23">FATAL</a>, <span class="stringliteral">"data"</span>); 
00738 
00739   <span class="comment">/*------------------------------------------------------------------*/</span>
00740   <span class="comment">/* READ Users Manipulator's Parameters into System (Manipulators.c) */</span>
00741   <span class="comment">/*------------------------------------------------------------------*/</span>
00742   <a class="code" href="headers_8h.html#a45">init_ARM</a>();       <span class="comment">/* Initialize User_Selected Arm     */</span>
00743 
00744   <span class="comment">/*allocate memory for array of links*/</span>
00745   <a class="code" href="general_8h.html#a42">all_links</a> = (<a class="code" href="structMATRIX.html">MATRIX</a> **) malloc ( <span class="keyword">sizeof</span>(<a class="code" href="structMATRIX.html">MATRIX</a> *) * <a class="code" href="general_8h.html#a57">Robot</a>-&gt;<a class="code" href="structManipulator__struct.html#Manipulator__structo1">NL</a> );
00746   <a class="code" href="Globals_8h.html#a14">link_location</a> = (MATRIX **) malloc ( <span class="keyword">sizeof</span>(MATRIX *) * <a class="code" href="general_8h.html#a57">Robot</a>-&gt;<a class="code" href="structManipulator__struct.html#Manipulator__structo1">NL</a> );
00747 
00748   <span class="comment">/* E1-E4 are vectors to locate the 4 points used to draw the end effector */</span>
00749 
00750   <a class="code" href="Globals_8h.html#a29">E1</a> = <a class="code" href="matrix_8h.html#a25">mat_malloc</a>(4,1);  
00751   <a class="code" href="Globals_8h.html#a30">E2</a> = <a class="code" href="matrix_8h.html#a25">mat_malloc</a>(4,1);  
00752   <a class="code" href="Globals_8h.html#a31">E3</a> = <a class="code" href="matrix_8h.html#a25">mat_malloc</a>(4,1);
00753   <a class="code" href="Globals_8h.html#a32">E4</a> = <a class="code" href="matrix_8h.html#a25">mat_malloc</a>(4,1);
00754 
00755   <span class="comment">/* EW1-EW4 are locations of the 4 points of the EE wrt world coordinates */</span>
00756   <a class="code" href="general_8h.html#a49">EW1</a> = <a class="code" href="matrix_8h.html#a25">mat_malloc</a>(4,1); 
00757   <a class="code" href="general_8h.html#a50">EW2</a> = <a class="code" href="matrix_8h.html#a25">mat_malloc</a>(4,1);   
00758   <a class="code" href="general_8h.html#a51">EW3</a> = <a class="code" href="matrix_8h.html#a25">mat_malloc</a>(4,1);
00759   <a class="code" href="general_8h.html#a52">EW4</a> = <a class="code" href="matrix_8h.html#a25">mat_malloc</a>(4,1);
00760  
00761   <span class="comment">/* P1-P4 are vectors to locate the 4 points used to draw the platform */</span>
00762   P1 = <a class="code" href="matrix_8h.html#a25">mat_malloc</a>(4,1);  
00763   <a class="code" href="Globals_8h.html#a26">P2</a> = <a class="code" href="matrix_8h.html#a25">mat_malloc</a>(4,1);   
00764   <a class="code" href="Globals_8h.html#a27">P3</a> = <a class="code" href="matrix_8h.html#a25">mat_malloc</a>(4,1);
00765   <a class="code" href="Globals_8h.html#a28">P4</a> = <a class="code" href="matrix_8h.html#a25">mat_malloc</a>(4,1);
00766 
00767   <a class="code" href="general_8h.html#a45">PW1</a> = <a class="code" href="matrix_8h.html#a25">mat_malloc</a>(4,1);  
00768   <a class="code" href="general_8h.html#a46">PW2</a> = <a class="code" href="matrix_8h.html#a25">mat_malloc</a>(4,1);   
00769   <a class="code" href="general_8h.html#a47">PW3</a> = <a class="code" href="matrix_8h.html#a25">mat_malloc</a>(4,1);
00770   <a class="code" href="general_8h.html#a48">PW4</a> = <a class="code" href="matrix_8h.html#a25">mat_malloc</a>(4,1);
00771 
00772   <span class="comment">/* Also see Jacob_ROBOT.c for the use of A... */</span>
00773 
00774   <span class="keywordflow">for</span> ( i = 0; i &lt; <a class="code" href="general_8h.html#a57">Robot</a>-&gt;<a class="code" href="structManipulator__struct.html#Manipulator__structo1">NL</a>; i++) {
00775     <span class="comment">/* location of end of links wrt world coords */</span>
00776     <a class="code" href="general_8h.html#a42">all_links</a>[i] = <a class="code" href="matrix_8h.html#a25">mat_malloc</a>(4,1);
00777     <span class="comment">/* location of ends of links */</span>
00778     <a class="code" href="Globals_8h.html#a14">link_location</a>[i] = <a class="code" href="matrix_8h.html#a25">mat_malloc</a>(4,1);
00779   }
00780 
00781   R = <a class="code" href="matrix_8h.html#a25">mat_malloc</a>(4,1);     <span class="comment">/* vector to locate base of manipulator */</span>
00782   X = <a class="code" href="matrix_8h.html#a25">mat_malloc</a>(4,1);     <span class="comment">/* vector to locate manip on platform */</span>
00783   <a class="code" href="general_8h.html#a43">RW</a> = <a class="code" href="matrix_8h.html#a25">mat_malloc</a>(4,1);    <span class="comment">/* location of manip base wrt world coords   */</span>
00784   <a class="code" href="general_8h.html#a44">XW</a> = <a class="code" href="matrix_8h.html#a25">mat_malloc</a>(4,1);    <span class="comment">/* location of manip on plat wrt world coords*/</span>
00785 
00786     <span class="comment">/* initialize all location vectors and transformation matrices */</span>
00787   <span class="keywordflow">for</span> (i=0;i&lt;=3;i++)  
00788   { 
00789     <span class="keywordflow">for</span> (j=0; j&lt;<a class="code" href="general_8h.html#a57">Robot</a>-&gt;<a class="code" href="structManipulator__struct.html#Manipulator__structo1">NL</a>; j++) {
00790       <a class="code" href="Globals_8h.html#a14">link_location</a>[j]-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[i][0]=0;
00791     }
00792     R-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[i][0]=0;  X-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[i][0]=0;
00793     P1-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[i][0]=0;<a class="code" href="Globals_8h.html#a26">P2</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[i][0]=0;<a class="code" href="Globals_8h.html#a27">P3</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[i][0]=0;<a class="code" href="Globals_8h.html#a28">P4</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[i][0]=0;
00794     <a class="code" href="Globals_8h.html#a29">E1</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[i][0]=0;<a class="code" href="Globals_8h.html#a30">E2</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[i][0]=0;<a class="code" href="Globals_8h.html#a31">E3</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[i][0]=0;<a class="code" href="Globals_8h.html#a32">E4</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[i][0]=0;
00795   }
00796 
00797   <span class="comment">/* drawing vectors for the manipulator */</span>
00798   <a class="code" href="Globals_8h.html#a29">E1</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[0][0]=<a class="code" href="general_8h.html#a57">Robot</a>-&gt;<a class="code" href="structManipulator__struct.html#Manipulator__structo14">LINKS</a>[<a class="code" href="general_8h.html#a57">Robot</a>-&gt;<a class="code" href="structManipulator__struct.html#Manipulator__structo1">NL</a>-1]+HandLength; <a class="code" href="Globals_8h.html#a29">E1</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[2][0]=-HandWidth;
00799                                           <a class="code" href="Globals_8h.html#a29">E1</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[3][0]=1.0;
00800   <a class="code" href="Globals_8h.html#a30">E2</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[0][0]=<a class="code" href="general_8h.html#a57">Robot</a>-&gt;<a class="code" href="structManipulator__struct.html#Manipulator__structo14">LINKS</a>[<a class="code" href="general_8h.html#a57">Robot</a>-&gt;<a class="code" href="structManipulator__struct.html#Manipulator__structo1">NL</a>-1]           ; <a class="code" href="Globals_8h.html#a30">E2</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[2][0]=-HandWidth; 
00801                                           <a class="code" href="Globals_8h.html#a30">E2</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[3][0]=1.0;
00802   <a class="code" href="Globals_8h.html#a31">E3</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[0][0]=<a class="code" href="general_8h.html#a57">Robot</a>-&gt;<a class="code" href="structManipulator__struct.html#Manipulator__structo14">LINKS</a>[<a class="code" href="general_8h.html#a57">Robot</a>-&gt;<a class="code" href="structManipulator__struct.html#Manipulator__structo1">NL</a>-1]           ; <a class="code" href="Globals_8h.html#a31">E3</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[2][0]= HandWidth; 
00803                                           <a class="code" href="Globals_8h.html#a31">E3</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[3][0]=1.0;
00804   <a class="code" href="Globals_8h.html#a32">E4</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[0][0]=<a class="code" href="general_8h.html#a57">Robot</a>-&gt;<a class="code" href="structManipulator__struct.html#Manipulator__structo14">LINKS</a>[<a class="code" href="general_8h.html#a57">Robot</a>-&gt;<a class="code" href="structManipulator__struct.html#Manipulator__structo1">NL</a>-1]+HandLength; <a class="code" href="Globals_8h.html#a32">E4</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[2][0]= HandWidth; 
00805                                           <a class="code" href="Globals_8h.html#a32">E4</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[3][0]=1.0;
00806 
00807   <span class="comment">/* drawing vectors for the platform */</span>
00808   <span class="keywordflow">if</span> (<a class="code" href="general_8h.html#a57">Robot</a>-&gt;<a class="code" href="structManipulator__struct.html#Manipulator__structo11">PLAT</a>.<a class="code" href="structPlatform.html#Platformo1">Exist</a>) {
00809     FrontLength = <a class="code" href="general_8h.html#a57">Robot</a>-&gt;<a class="code" href="structManipulator__struct.html#Manipulator__structo11">PLAT</a>.<a class="code" href="structPlatform.html#Platformo3">Length</a>;
00810     SideLength  = <a class="code" href="general_8h.html#a57">Robot</a>-&gt;<a class="code" href="structManipulator__struct.html#Manipulator__structo11">PLAT</a>.<a class="code" href="structPlatform.html#Platformo4">Width</a>;
00811   }
00812   P1-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[0][0]=-FrontLength/2; P1-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[1][0]=-SideLength/2; P1-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[3][0]=1.0;
00813   <a class="code" href="Globals_8h.html#a26">P2</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[0][0]=-FrontLength/2; <a class="code" href="Globals_8h.html#a26">P2</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[1][0]= SideLength/2; <a class="code" href="Globals_8h.html#a26">P2</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[3][0]=1.0; 
00814   <a class="code" href="Globals_8h.html#a27">P3</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[0][0]= FrontLength/2; <a class="code" href="Globals_8h.html#a27">P3</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[1][0]= SideLength/2; <a class="code" href="Globals_8h.html#a27">P3</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[3][0]=1.0;
00815   <a class="code" href="Globals_8h.html#a28">P4</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[0][0]= FrontLength/2; <a class="code" href="Globals_8h.html#a28">P4</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[1][0]=-SideLength/2; <a class="code" href="Globals_8h.html#a28">P4</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[3][0]=1.0;
00816 
00817   <span class="comment">/* manip base offset is drawn along a local y axis */</span>
00818   R-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[2][0]=0; R-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[3][0]=1.0;  
00819   X-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[2][0]=0; X-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[3][0]=1.0;
00820 }
00821 
00822 
00823 <span class="comment">/* ________________________________________________________</span>
00824 <span class="comment">  | name:    Update_History                                |</span>
00825 <span class="comment">  | description:  Updates the history of joint angle steps.|</span>
00826 <span class="comment">  | inputs:  none                                          |</span>
00827 <span class="comment">  | outputs:                                               |</span>
00828 <span class="comment">  |________________________________________________________|</span>
00829 <span class="comment">  | Authors:     Date:     Modifications:                  |</span>
00830 <span class="comment">  |  K Morgansen  7/95       created                       |</span>
00831 <span class="comment">  |________________________________________________________| */</span>
00832 
<a name="l00833"></a><a class="code" href="IKOR__driver_8c.html#a8">00833</a> <span class="keywordtype">void</span> <a class="code" href="IKOR__driver_8c.html#a8">Update_History</a>(<a class="code" href="structHistory.html">History</a> *Old_DQs, <a class="code" href="structMATRIX.html">MATRIX</a> *dq)
00834 {
00835 <span class="keywordtype">int</span> prev;
00836 
00837 Old_DQs-&gt;<a class="code" href="structHistory.html#Historyo0">whereami</a>++;
00838 <span class="keywordflow">if</span> (Old_DQs-&gt;<a class="code" href="structHistory.html#Historyo0">whereami</a> == <a class="code" href="structures_8h.html#a0">HIST_SIZE</a>) Old_DQs-&gt;<a class="code" href="structHistory.html#Historyo0">whereami</a> = 0;
00839 prev = Old_DQs-&gt;<a class="code" href="structHistory.html#Historyo0">whereami</a>-1;
00840 <span class="keywordflow">if</span> (prev == -1) prev = <a class="code" href="structures_8h.html#a0">HIST_SIZE</a> - 1;
00841 
00842 <a class="code" href="matrix_8h.html#a20">mat_cp</a>(dq, Old_DQs-&gt;<a class="code" href="structHistory.html#Historyo1">dq</a>[Old_DQs-&gt;<a class="code" href="structHistory.html#Historyo0">whereami</a>].DQ);
00843 Old_DQs-&gt;<a class="code" href="structHistory.html#Historyo1">dq</a>[Old_DQs-&gt;<a class="code" href="structHistory.html#Historyo0">whereami</a>].<a class="code" href="structHistory__Element.html#History__Elemento0">time</a>=Old_DQs-&gt;<a class="code" href="structHistory.html#Historyo1">dq</a>[prev].<a class="code" href="structHistory__Element.html#History__Elemento0">time</a>+0.033332;
00844          <span class="comment">/*Old_DQs-&gt;dq[Old_DQs-&gt;whereami].time=clock()/1.0e6;      */</span>
00845          <span class="comment">/* this is a hack to make sure the results are consistent */</span>
00846 
00847 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Jul 29 15:56:35 2004 for OpenSim by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.6 </small></address>
</body>
</html>
