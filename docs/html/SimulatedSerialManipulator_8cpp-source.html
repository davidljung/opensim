<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>OpenSim: robot/sim/SimulatedSerialManipulator.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>robot/sim/SimulatedSerialManipulator.cpp</h1><a href="SimulatedSerialManipulator_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/****************************************************************************</span>
00002 <span class="comment">  Copyright (C)2002 David Jung &lt;opensim@pobox.com&gt;</span>
00003 <span class="comment"></span>
00004 <span class="comment">  This program/file is free software; you can redistribute it and/or modify</span>
00005 <span class="comment">  it under the terms of the GNU General Public License as published by</span>
00006 <span class="comment">  the Free Software Foundation; either version 2 of the License, or</span>
00007 <span class="comment">  (at your option) any later version.</span>
00008 <span class="comment">  </span>
00009 <span class="comment">  This program is distributed in the hope that it will be useful,</span>
00010 <span class="comment">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00011 <span class="comment">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00012 <span class="comment">  GNU General Public License for more details. (http://www.gnu.org)</span>
00013 <span class="comment">  </span>
00014 <span class="comment">  You should have received a copy of the GNU General Public License</span>
00015 <span class="comment">  along with this program; if not, write to the Free Software</span>
00016 <span class="comment">  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
00017 <span class="comment"></span>
00018 <span class="comment">  $Id: SimulatedSerialManipulator.cpp 1032 2004-02-11 20:47:42Z jungd $</span>
00019 <span class="comment">  $Revision: 1.34 $</span>
00020 <span class="comment">  $Date: 2004-02-11 15:47:42 -0500 (Wed, 11 Feb 2004) $</span>
00021 <span class="comment">  $Author: jungd $</span>
00022 <span class="comment"> </span>
00023 <span class="comment">****************************************************************************/</span>
00024 
00025 <span class="preprocessor">#include &lt;<a class="code" href="SimulatedSerialManipulator.html">robot/sim/SimulatedSerialManipulator</a>&gt;</span>
00026 
00027 <span class="preprocessor">#include &lt;<a class="code" href="Vector3.html">base/Vector3</a>&gt;</span>
00028 <span class="preprocessor">#include &lt;<a class="code" href="Orient.html">base/Orient</a>&gt;</span>
00029 <span class="preprocessor">#include &lt;<a class="code" href="Transform.html">base/Transform</a>&gt;</span>
00030 <span class="preprocessor">#include &lt;<a class="code" href="Externalizer.html">base/Externalizer</a>&gt;</span>
00031 
00032 <span class="preprocessor">#include &lt;<a class="code" href="Color3.html">gfx/Color3</a>&gt;</span>
00033 <span class="preprocessor">#include &lt;<a class="code" href="Line3.html">gfx/Line3</a>&gt;</span>
00034 <span class="preprocessor">#include &lt;<a class="code" href="Segment3.html">gfx/Segment3</a>&gt;</span>
00035 <span class="preprocessor">#include &lt;<a class="code" href="BoundingBox.html">physics/BoundingBox</a>&gt;</span>
00036 <span class="preprocessor">#include &lt;<a class="code" href="Material.html">physics/Material</a>&gt;</span>
00037 <span class="preprocessor">#include &lt;<a class="code" href="Box.html">physics/Box</a>&gt;</span>
00038 <span class="preprocessor">#include &lt;<a class="code" href="Sphere.html">physics/Sphere</a>&gt;</span>
00039 <span class="preprocessor">#include &lt;<a class="code" href="Capsule.html">physics/Capsule</a>&gt;</span>
00040 <span class="preprocessor">#include &lt;<a class="code" href="Solid.html">physics/Solid</a>&gt;</span>
00041 <span class="preprocessor">#include &lt;<a class="code" href="ConstraintGroup.html">physics/ConstraintGroup</a>&gt;</span>
00042 <span class="preprocessor">#include &lt;<a class="code" href="Joint.html">physics/Joint</a>&gt;</span>
00043 <span class="preprocessor">#include &lt;<a class="code" href="HingeJoint.html">physics/HingeJoint</a>&gt;</span>
00044 <span class="preprocessor">#include &lt;<a class="code" href="SliderJoint.html">physics/SliderJoint</a>&gt;</span>
00045 <span class="preprocessor">#include &lt;<a class="code" href="Motor.html">physics/Motor</a>&gt;</span>
00046 <span class="preprocessor">#include &lt;<a class="code" href="CollisionCuller.html">physics/CollisionCuller</a>&gt;</span>
00047 <span class="preprocessor">#include &lt;<a class="code" href="CollisionDetector.html">physics/CollisionDetector</a>&gt;</span>
00048 <span class="preprocessor">#include &lt;<a class="code" href="CollisionState.html">physics/CollisionState</a>&gt;</span>
00049 <span class="preprocessor">#include &lt;<a class="code" href="NullCollisionResponseHandler.html">physics/NullCollisionResponseHandler</a>&gt;</span>
00050 <span class="preprocessor">#include &lt;<a class="code" href="SpatialTransform.html">physics/SpatialTransform</a>&gt;</span>
00051 
00052 <span class="preprocessor">#include &lt;<a class="code" href="VisualDebugUtil.html">physics/VisualDebugUtil</a>&gt;</span>
00053 
00054 <span class="preprocessor">#include &lt;<a class="code" href="KinematicChain.html">robot/KinematicChain</a>&gt;</span>
00055 
00056 
00057 <span class="keyword">using</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html">robot::sim::SimulatedSerialManipulator</a>;
00058 
00059 <span class="keyword">using</span> <a class="code" href="classbase_1_1Vector3.html">base::Point3</a>;
00060 <span class="keyword">using</span> <a class="code" href="classbase_1_1Orient.html">base::Orient</a>;
00061 <span class="keyword">using</span> <a class="code" href="classbase_1_1Vector3.html">base::Dimension3</a>;
00062 <span class="keyword">using</span> <a class="code" href="classbase_1_1Transform.html">base::Transform</a>;
00063 <span class="keyword">using</span> <a class="code" href="classgfx_1_1Line3.html">gfx::Line3</a>;
00064 <span class="keyword">using</span> <a class="code" href="classgfx_1_1Segment3.html">gfx::Segment3</a>;
00065 <span class="keyword">using</span> <a class="code" href="classgfx_1_1Color4.html">gfx::Color4</a>;
00066 <span class="keyword">using</span> <a class="code" href="classphysics_1_1BoundingBox.html">physics::BoundingBox</a>;
00067 <span class="keyword">using</span> <a class="code" href="classphysics_1_1Collidable.html">physics::Collidable</a>;
00068 <span class="keyword">using</span> <a class="code" href="classphysics_1_1CollidableBody.html">physics::CollidableBody</a>;
00069 <span class="keyword">using</span> <a class="code" href="classphysics_1_1CollidableGroup.html">physics::CollidableGroup</a>;
00070 <span class="keyword">using</span> <a class="code" href="classphysics_1_1CollisionState.html">physics::CollisionState</a>;
00071 <span class="keyword">using</span> <a class="code" href="classphysics_1_1CollisionCuller.html">physics::CollisionCuller</a>;
00072 <span class="keyword">using</span> <a class="code" href="classphysics_1_1CollisionDetector.html">physics::CollisionDetector</a>;
00073 <span class="keyword">using</span> <a class="code" href="classphysics_1_1CollisionResponseHandler.html">physics::CollisionResponseHandler</a>;
00074 <span class="keyword">using</span> <a class="code" href="classphysics_1_1NullCollisionResponseHandler.html">physics::NullCollisionResponseHandler</a>;
00075 <span class="keyword">using</span> <a class="code" href="classphysics_1_1Shape.html">physics::Shape</a>;
00076 <span class="keyword">using</span> <a class="code" href="classphysics_1_1Box.html">physics::Box</a>;
00077 <span class="keyword">using</span> <a class="code" href="classphysics_1_1Sphere.html">physics::Sphere</a>;
00078 <span class="keyword">using</span> <a class="code" href="classphysics_1_1Capsule.html">physics::Capsule</a>;
00079 <span class="keyword">using</span> <a class="code" href="classphysics_1_1Material.html">physics::Material</a>;
00080 <span class="keyword">using</span> <a class="code" href="classphysics_1_1Solid.html">physics::Solid</a>;
00081 <span class="keyword">using</span> <a class="code" href="classphysics_1_1SpatialGroup.html">physics::SpatialGroup</a>;
00082 <span class="keyword">using</span> <a class="code" href="classphysics_1_1SpatialTransform.html">physics::SpatialTransform</a>;
00083 <span class="keyword">using</span> <a class="code" href="classphysics_1_1ConstraintGroup.html">physics::ConstraintGroup</a>;
00084 <span class="keyword">using</span> <a class="code" href="classphysics_1_1Joint.html">physics::Joint</a>;
00085 <span class="keyword">using</span> <a class="code" href="classphysics_1_1HingeJoint.html">physics::HingeJoint</a>;
00086 <span class="keyword">using</span> <a class="code" href="classphysics_1_1SliderJoint.html">physics::SliderJoint</a>;
00087 <span class="keyword">using</span> <a class="code" href="classphysics_1_1Motor.html">physics::Motor</a>;
00088 
00089 <span class="keyword">using</span> <a class="code" href="classphysics_1_1VisualDebugUtil.html">physics::VisualDebugUtil</a>;
00090 
00091 <span class="keyword">using</span> <a class="code" href="classrobot_1_1KinematicChain.html">robot::KinematicChain</a>;
00092 <span class="keyword">using</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedManipulatorDescription.html">robot::sim::SimulatedManipulatorDescription</a>;
00093 <span class="keyword">using</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html">robot::sim::SimulatedKinematicChain</a>;
00094 <span class="keyword">using</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedTool.html">robot::sim::SimulatedTool</a>;
00095 <span class="comment"></span>
00096 <span class="comment">//!!!</span>
00097 <span class="comment"></span><span class="preprocessor">#include &lt;<a class="code" href="ODESolidConnectedCollidableBody.html">physics/ODESolidConnectedCollidableBody</a>&gt;</span>
00098 <span class="keyword">using</span> <a class="code" href="classphysics_1_1SolidConnectedCollidableBody.html">physics::SolidConnectedCollidableBody</a>;
00099 <span class="keyword">using</span> <a class="code" href="classphysics_1_1ODESolidConnectedCollidableBody.html">physics::ODESolidConnectedCollidableBody</a>;
00100 
00101 
00102 <span class="preprocessor">#include &lt;ode/ode.h&gt;</span>
00103 <span class="preprocessor">#include &lt;ode/rotation.h&gt;</span>
00104 
00105 
00106 <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatora0">SimulatedSerialManipulator::SimulatedSerialManipulator</a>(<span class="keywordtype">bool</span> dynamic)
00107   : SimulatedKinematicChain(dynamic), proximityDistance(0.05), proximityAngle(Math::<a class="code" href="namespacegfx.html#a8">degToRad</a>(3)), toolGrasped(false)
00108 {
00109 }
00110 
00111 <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatora0">SimulatedSerialManipulator::SimulatedSerialManipulator</a>(ref&lt;physics::SolidSystem&gt; solidSystem, <span class="keywordtype">bool</span> dynamic)
00112   : SimulatedKinematicChain(solidSystem, dynamic), proximityDistance(0.05), proximityAngle(Math::<a class="code" href="namespacegfx.html#a8">degToRad</a>(3)), toolGrasped(false)
00113 {   
00114 }
00115 
00116 <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatora0">SimulatedSerialManipulator::SimulatedSerialManipulator</a>(ref&lt;const robot::ManipulatorDescription&gt; manipulatorDescription, ref&lt;physics::SolidSystem&gt; solidSystem, <span class="keywordtype">bool</span> dynamic)
00117   : SimulatedKinematicChain(solidSystem,dynamic),
00118     proximityDistance(0.05), proximityAngle(Math::<a class="code" href="namespacegfx.html#a8">degToRad</a>(3)), toolGrasped(false)
00119 {
00120   <span class="keywordflow">if</span> (<a class="code" href="base.html#a25">instanceof</a>(*manipulatorDescription, <span class="keyword">const</span> SimulatedManipulatorDescription))
00121     <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp0">manipulatorDescr</a> = narrow_ref&lt;const SimulatedManipulatorDescription&gt;(manipulatorDescription);
00122   <span class="keywordflow">else</span>
00123     <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp0">manipulatorDescr</a> = ref&lt;SimulatedManipulatorDescription&gt;(<a class="code" href="MemoryTracer.html#a0">NewObj</a> SimulatedManipulatorDescription(*manipulatorDescription));
00124 
00125   <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a> = <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp0">manipulatorDescr</a>-&gt;getKinematicChain();
00126   <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp17">q</a>.<a class="code" href="classbase_1_1vector.html#base_1_1vectora16">reset</a>(<a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp0">manipulatorDescr</a>-&gt;initialConfiguration());
00127 }
00128 
00129 
00130 
00131 <span class="keywordtype">bool</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatora30">SimulatedSerialManipulator::formatSupported</a>(String format, Real version, ExternalizationType type)<span class="keyword"> const</span>
00132 <span class="keyword"></span>{
00133   <span class="keywordflow">return</span> <span class="keyword">false</span>;
00134 }
00135 
00136 <span class="keywordtype">void</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatora31">SimulatedSerialManipulator::externalize</a>(<a class="code" href="classbase_1_1Externalizer.html">base::Externalizer</a>&amp; e, String format, Real version)
00137 {
00138   <span class="keywordflow">if</span> (format == <span class="stringliteral">""</span>) format = <span class="stringliteral">"xml"</span>;
00139 
00140   <span class="keywordflow">if</span> (!<a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatora30">formatSupported</a>(format,version,e.<a class="code" href="classbase_1_1Externalizer.html#base_1_1Externalizera6">ioType</a>()))
00141     <span class="keywordflow">throw</span> std::invalid_argument(<a class="code" href="base.html#a15">Exception</a>(<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"format "</span>)+format+<span class="stringliteral">" v"</span>+base::realToString(version)+<span class="stringliteral">" unsupported"</span>));
00142 
00143   <span class="comment">// just externalize the description</span>
00144   <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp0">manipulatorDescr</a>-&gt;externalize(e,format,version);
00145 }
00146 
00147 
00148 
00149 <span class="keywordtype">void</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatora8">SimulatedSerialManipulator::setJointForce</a>(Int j, Real f)
00150 {
00151   <a class="code" href="base.html#a21">Assertm</a>((j&gt;=1)&amp;&amp;(j&lt;=<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>.dof()), <span class="stringliteral">"joint index in range"</span>);
00152   
00153   <span class="keywordflow">if</span> (!<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp10">dynamic</a>) <span class="keywordflow">return</span>;
00154   
00155   ref&lt;Motor&gt; motor(joints[j-1]-&gt;getMotor(1));
00156   motor-&gt;setTargetVel( (f&gt;0)?10:-10 ); 
00157   motor-&gt;setMaxForce(f);
00158 }
00159 
00160 <span class="keywordtype">void</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatora9">SimulatedSerialManipulator::setJointVel</a>(Int j, Real v, Real maxForce)
00161 {
00162   <a class="code" href="base.html#a21">Assertm</a>((j&gt;=1)&amp;&amp;(j&lt;=<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>.dof()), <span class="stringliteral">"joint index in range"</span>);
00163 
00164   <span class="keywordflow">if</span> (!<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp10">dynamic</a>) <span class="keywordflow">return</span>;
00165   
00166   ref&lt;Motor&gt; motor(joints[j-1]-&gt;getMotor(1));
00167   motor-&gt;setTargetVel(v); 
00168   motor-&gt;setMaxForce(maxForce);
00169 }
00170 
00171 
00172 <span class="keywordtype">void</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatora10">SimulatedSerialManipulator::setJointPos</a>(Int j, Real p)
00173 {
00174   <a class="code" href="base.html#a21">Assertm</a>((j&gt;=1)&amp;&amp;(j&lt;=<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>.dof()), <span class="stringliteral">"joint index in range"</span>);
00175 
00176   <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp17">q</a>[j-1] = p;
00177   
00178   <span class="comment">//... actually move the links</span>
00179   <span class="comment">//hack!!! (expensive - only need to update the joint in question)</span>
00180 
00181   Transform baseTransform(<a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp0">manipulatorDescr</a>-&gt;getBaseTransform());
00182   <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp1">mountConfiguration</a> = <a class="code" href="namespacebase.html#a115">inverse</a>(baseTransform)*<a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp6">linkGroups</a>[0]-&gt;getConfiguration();
00183   
00184   TransformInfo transformInfo( <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorb3">computeLinkTransforms</a>(mountConfiguration, q) );
00185   <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorb5">positionLinks</a>(transformInfo);
00186     
00187   <span class="comment">// re-position the tool at the ee-end</span>
00188   <span class="keywordflow">if</span> (<a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp10">toolGrasped</a>) {
00189     Transform eeConfig( <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatora13">getEEPosition</a>(), <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatora14">getEEOrientation</a>() );
00190     <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp9">proximityTool</a>-&gt;setConfiguration( eeConfig );
00191   }
00192   <span class="comment">//hack!!!</span>
00193 }
00194 
00195   
00196 <a class="code" href="namespacebase.html#a5">Real</a> <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatora11">SimulatedSerialManipulator::getJointPos</a>(Int j)<span class="keyword"> const</span>
00197 <span class="keyword"></span>{
00198   <a class="code" href="base.html#a21">Assertm</a>((j&gt;=1)&amp;&amp;(j&lt;=<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>.dof()), <span class="stringliteral">"joint index in range"</span>);
00199 
00200   <span class="keywordflow">if</span> (<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp10">dynamic</a>) { <span class="comment">// get joint pos from physics::Joint</span>
00201     
00202     <span class="comment">// NB: physics::Joints have their 0 pos at the position/orientation</span>
00203     <span class="comment">//  at which the two bodies were initially attached.  That was</span>
00204     <span class="comment">//  computed from the manipulator joint parameter home position.</span>
00205   
00206     <span class="keywordflow">if</span> (<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>[j-1].type() == KinematicChain::Link::Revolute) {
00207   
00208       ref&lt;HingeJoint&gt; hinge(narrow_ref&lt;HingeJoint&gt;(joints[j-1]));
00209 
00210       <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp17">q</a>[j-1] = hinge-&gt;getAngle();
00211   
00212     } <span class="keywordflow">else</span> { <span class="comment">// prismatic</span>
00213       ref&lt;SliderJoint&gt; slider(narrow_ref&lt;SliderJoint&gt;(joints[j-1]));
00214       <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp17">q</a>[j-1] = slider-&gt;getPosition();
00215     }
00216     
00217   } <span class="keywordflow">else</span> { <span class="comment">// static</span>
00218     <span class="comment">/*</span>
00219 <span class="comment">    Transform relConfig = inverse( links[j]-&gt;getConfiguration() )*links[j-1]-&gt;getConfiguration();</span>
00220 <span class="comment">    Real rotAboutZ = Math::normalizeAngle(relConfig.getRotation().getVector(Orient::EulerZYX)[0]);</span>
00221 <span class="comment">    Debugln(Tmp,"rotAboutZ=" &lt;&lt; rotAboutZ);</span>
00222 <span class="comment">    return rotAboutZ;</span>
00223 <span class="comment">    */</span>
00224   }
00225 
00226   <span class="keywordflow">return</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp17">q</a>[j-1];
00227 
00228 }
00229 
00230 
00231 <a class="code" href="namespacebase.html#a5">Real</a> <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatora12">SimulatedSerialManipulator::getJointVel</a>(Int j)<span class="keyword"> const</span>
00232 <span class="keyword"></span>{
00233   <a class="code" href="base.html#a21">Assertm</a>((j&gt;=1)&amp;&amp;(j&lt;=<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>.dof()), <span class="stringliteral">"joint index in range"</span>);
00234 
00235   <span class="keywordflow">if</span> (!<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp10">dynamic</a>) <span class="keywordflow">return</span> 0;
00236 
00237   <span class="keywordflow">if</span> (<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>[j-1].type() == KinematicChain::Link::Revolute) {
00238 
00239     ref&lt;HingeJoint&gt; hinge(narrow_ref&lt;HingeJoint&gt;(joints[j-1]));
00240     <span class="keywordflow">return</span> hinge-&gt;getAngleRate();
00241   }
00242   <span class="keywordflow">else</span> { <span class="comment">// prismatic</span>
00243 
00244     ref&lt;SliderJoint&gt; slider(narrow_ref&lt;SliderJoint&gt;(joints[j-1]));
00245     <span class="keywordflow">return</span> slider-&gt;getPositionRate();
00246   }
00247 
00248 }
00249 
00250 
00251 
00252 
00253 
00254 
00255 array&lt;base::Dimension3&gt; <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorb2">SimulatedSerialManipulator::computeLinkDimensions</a>(<span class="keyword">const</span> array&lt;Real&gt;&amp; linkRadii) 
00256 {
00257   <span class="comment">// call super and then add the dim of the base link as link 0</span>
00258   array&lt;Dimension3&gt; dim( SimulatedKinematicChain::computeLinkDimensions(linkRadii) );
00259   
00260   Matrix4 baseTransform(<a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp0">manipulatorDescr</a>-&gt;getBaseTransform());
00261   <a class="code" href="namespacebase.html#a5">Real</a> len = baseTransform.column(4).toVector3().length();
00262 
00263   <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp14">linkLengths</a>[0] = len;
00264     
00265   <a class="code" href="namespacebase.html#a5">Real</a> zl=len*0.98;
00266   <span class="keywordflow">if</span> (Math::equals(len,0)) zl=0.05; <span class="comment">// some links are zero length so make them very small instead</span>
00267   
00268   <a class="code" href="namespacebase.html#a5">Real</a> yz;
00269   <span class="keywordflow">if</span> (linkRadii.size() &gt;= 1)
00270     yz = linkRadii[0]*2.0;
00271   <span class="keywordflow">else</span>
00272     yz = Math::maximum(0.05,zl*0.14); <span class="comment">// make x&amp;y-dims smaller than length (z-dim)</span>
00273     
00274   dim[0] = <a class="code" href="classbase_1_1Vector3.html">Dimension3</a>(yz,yz,zl);
00275 
00276   <span class="keywordflow">return</span> dim; 
00277 }
00278 
00279 
00280 
00281 
00282 
00283 SimulatedSerialManipulator::TransformInfo <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorb3">SimulatedSerialManipulator::computeLinkTransforms</a>(<span class="keyword">const</span> Transform&amp; mountTransform, <span class="keyword">const</span> <a class="code" href="classbase_1_1vector.html">base::Vector</a>&amp; q)<span class="keyword"> const</span>
00284 <span class="keyword"></span>{
00285   TransformInfo transformInfo;
00286   transformInfo.mountTransform = mountTransform;
00287   transformInfo.q.reset(q);
00288   
00289   array&lt;Transform&gt;&amp; A(transformInfo.A); <span class="comment">// convenient aliases</span>
00290   array&lt;Transform&gt;&amp; T(transformInfo.T);
00291   array&lt;Transform&gt;&amp; SLT(transformInfo.SLT);
00292   A.resize(<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>.size()+1);  
00293   T.resize(A.size());
00294   SLT.resize(A.size());
00295 
00296   Transform baseTransform(<a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp0">manipulatorDescr</a>-&gt;getBaseTransform());
00297 
00298   A[0] = transformInfo.mountTransform * baseTransform; <span class="comment">// link 0</span>
00299   T[0] = A[0];
00300   <a class="code" href="namespacebase.html#a2">Int</a> j=0; <span class="comment">// joint variable index</span>
00301   
00302   <span class="comment">// handle base link (i.e. link joining mount to first joint origin) as a special case first</span>
00303   
00304   SLT[0] = Transform(Vector3(0,0,-linkLengths[0]/2.0));
00305   <span class="comment">// for the base, we want the Solid to have it's z-axis co-incident with</span>
00306   <span class="comment">//  the line joining the mount origin and the first joint's origin</span>
00307   <span class="comment">// (so we construct a rotation that rotates the z-axis of the base Solid</span>
00308   <span class="comment">//  into the joining line)</span>
00309   Vector3 localZAxis(Vector3(0,0,1)); <span class="comment">// untransformed z-axis</span>
00310   Vector3 baseOffset(baseTransform.getTranslation());
00311   <span class="keywordflow">if</span> (!Math::equals(baseOffset.norm(),0)) {
00312     <span class="comment">// mount and base origins are not co-incident, need to orient Solid</span>
00313     Vector3 baseZAxis( baseOffset.normalize()); <span class="comment">// vector we want the z-axis be coincide with</span>
00314     Vector3 rotAxis = <a class="code" href="namespacebase.html#a243">cross</a>(localZAxis, baseZAxis); <span class="comment">// rotate about this vector</span>
00315     <span class="keywordflow">if</span> (!rotAxis.equals(Vector3(0,0,0))) { <span class="comment">// not co-linear, transformation necessary</span>
00316       <a class="code" href="namespacebase.html#a5">Real</a> rotAngle = Math::acos(<a class="code" href="namespacebase.html#a209">dot</a>(localZAxis, baseZAxis)); <span class="comment">// by this amount</span><span class="comment"></span>
00317 <span class="comment">      //!!! do we need to account for when baseZAxis.y &lt; 0 (and do rotAngle=360-rotAngle)??!!!</span>
00318 <span class="comment"></span>      Transform <a class="code" href="Globals_8h.html#a15">R</a> = Quat4(rotAxis, rotAngle);
00319       SLT[0] = <a class="code" href="Globals_8h.html#a15">R</a> * SLT[0];
00320     }
00321   }
00322 
00323   transformInfo.mountToBaseSolid = <a class="code" href="namespacebase.html#a115">inverse</a>(SLT[0]);
00324   
00325   
00326   
00327   <span class="comment">// now the rest of the links</span>
00328   <span class="keywordflow">for</span> (<a class="code" href="namespacebase.html#a2">Int</a> l=1; l&lt;=<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>.size(); l++) { <span class="comment">// for each link</span>
00329     
00330     <span class="keyword">const</span> KinematicChain::Link&amp; link(chain[l-1]);
00331     
00332     <span class="comment">//</span>
00333     <span class="comment">// ask KinematicChain to compute the transform for each link</span>
00334     <a class="code" href="classdemeter_1_1Vector.html">Vector</a> lq(link.dof());
00335     <span class="keywordflow">if</span> (lq.size()&gt;0)
00336       lq[0] = transformInfo.q[j]; <span class="comment">// this currently only handles 1-dof links (!!!)</span>
00337     A[l] = <a class="code" href="namespacebase.html#a102">base::toMatrix4</a>(link.kinematicTransform(lq));
00338     
00339     <span class="comment">//</span>
00340     <span class="comment">// accumulate inter-link transforms </span>
00341     T[l] = T[l-1]*A[l]; 
00342     
00343     <span class="comment">//</span>
00344     <span class="comment">// finally compute the relative configuration of each link's Solid from its origin</span>
00345 
00346     <span class="comment">// Rotate the z-axis into the x-axis, as the link coord. frame has the x-axis along</span>
00347     <span class="comment">//  the link length, but the Solid's z-axis is the long one.</span>
00348     <span class="comment">// Also translate back 1/2 the Solid length along the long axis (z)</span>
00349     <span class="comment">//  (as the origin of the Solid is at its center of mass, but the origin of a link</span>
00350     <span class="comment">//   is at its end)</span>
00351     SLT[l] = Quat4(Vector3(0,1,0),consts::Pi/2.0) * Transform(Vector3(0,0,-linkLengths[l]/2.0));
00352 
00353     <span class="keywordflow">if</span> (link.isDHType()) {<span class="comment"></span>
00354 <span class="comment">//!!! fix comment &amp; and make analogous changes (re linkLength==0) to SimulatedTool if necessary!!!</span>
00355 <span class="comment"></span>      <span class="comment">// We also want to rotate the Solid so that the ends meet even if there</span>
00356       <span class="comment">//  is a displacement due to DH-parameter d</span>
00357       <span class="comment">//  (this will be a rotation about the y-axis of link l-1 to make the Solid's z-axis</span>
00358       <span class="comment">//   point to the previous link's origin rather than being parallel with</span>
00359       <span class="comment">//   the link x-axis.  To achieve this we bring link Solid l's y&amp;z-axes parallel to</span>
00360       <span class="comment">//   those of link l-1 by reversing the skew DH-parameter alpha, then rotate about the x-axis,</span>
00361       <span class="comment">//   and then redo the skew)</span>
00362       <a class="code" href="namespacebase.html#a5">Real</a> d = (link.type() == KinematicChain::Link::Prismatic)?lq[0]:link.getD();
00363       <a class="code" href="namespacebase.html#a5">Real</a> incline = ( !Math::equals(d,0) &amp;&amp; !Math::equals(linkLengths[l],0) )? 
00364                                                                 Math::asin(d/linkLengths[l]) : 0;
00365       <span class="keywordflow">if</span> (!Math::equals(incline,0)) {
00366         Transform rotYl    = Quat4(Vector3(0,1,0),-incline);
00367         Transform rotXl    = Quat4(Vector3(1,0,0), link.getAlpha());
00368         Transform rotXlInv = Quat4(Vector3(1,0,0),-link.getAlpha());
00369         Transform rotYlm1 = rotXlInv * rotYl * rotXl;
00370         
00371         SLT[l] = rotYlm1 * SLT[l];
00372       }
00373  
00374     }
00375 
00376     <span class="keywordflow">if</span> (l==<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>.size())
00377       transformInfo.eeToEESolid = <a class="code" href="namespacebase.html#a115">inverse</a>(SLT[l]); <span class="comment">//!!! check</span>
00378 <span class="comment"></span>    
00379     j += link.dof();
00380   } <span class="comment">// for each link</span>
00381 
00382   
00383   <span class="keywordflow">return</span> transformInfo;
00384 }
00385 
00386 
00387 
00388 
00389 
00390 <span class="keywordtype">void</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorb4">SimulatedSerialManipulator::createLinks</a>(<span class="keyword">const</span> array&lt;base::Dimension3&gt;&amp; linkDims)
00391 {
00392   <span class="comment">// We create a Solid for each link and place it in SolidSystem</span>
00393   <span class="comment">// Unless the geometry is specified, the Shape will be a Box who's dimensions</span>
00394   <span class="comment">// are specified in linkDims[]</span>
00395   <span class="comment">// The links are also chained together using SpatialGroups</span>
00396   <a class="code" href="base.html#a19">Assert</a>(<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>.size() &gt; 0);
00397 
00398   <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp12">links</a>.resize(<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>.size()+1);
00399   
00400   <span class="keywordflow">for</span> (<a class="code" href="namespacebase.html#a2">Int</a> l=0; l&lt;=<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>.size(); l++) { <span class="comment">// for each link</span>
00401     <span class="keyword">const</span> <a class="code" href="classbase_1_1Vector3.html">Dimension3</a>&amp; dim(linkDims[l]);
00402     <span class="comment">//ref&lt;Box&gt; box(NewObj Box(dim.x,dim.y,dim.z));</span>
00403     ref&lt;Capsule&gt; cap(NewObj <a class="code" href="classphysics_1_1Capsule.html">Capsule</a>(dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o2">z</a>, dim.<a class="code" href="classbase_1_1Vector3.html#base_1_1Vector3o0">x</a>/2.0));
00404     ref&lt;Material&gt; material(NewObj <a class="code" href="classphysics_1_1Material.html">physics::Material</a>());
00405     
00406     <span class="comment">// colour</span>
00407     <span class="keywordflow">switch</span> (l%10) {
00408     <span class="keywordflow">case</span> 0: material-&gt;setBaseColor(<a class="code" href="classgfx_1_1Color3.html">gfx::Color3</a>(0.6,0.6,0.6)); <span class="keywordflow">break</span>;
00409     <span class="keywordflow">case</span> 1: material-&gt;setBaseColor(gfx::Color3(0,1,0)); <span class="keywordflow">break</span>;
00410     <span class="keywordflow">case</span> 2: material-&gt;setBaseColor(<a class="code" href="classgfx_1_1Color3.html">gfx::Color3</a>(0+0.1,1-0.1,0+0.1)); <span class="keywordflow">break</span>;
00411     <span class="keywordflow">case</span> 3: material-&gt;setBaseColor(<a class="code" href="classgfx_1_1Color3.html">gfx::Color3</a>(0+0.2,1-0.2,0+0.2)); <span class="keywordflow">break</span>;
00412     <span class="keywordflow">case</span> 4: material-&gt;setBaseColor(<a class="code" href="classgfx_1_1Color3.html">gfx::Color3</a>(0+0.3,1-0.3,0+0.3)); <span class="keywordflow">break</span>;
00413     <span class="keywordflow">case</span> 5: material-&gt;setBaseColor(<a class="code" href="classgfx_1_1Color3.html">gfx::Color3</a>(0+0.4,1-0.4,0+0.4)); <span class="keywordflow">break</span>;
00414     <span class="keywordflow">case</span> 6: material-&gt;setBaseColor(<a class="code" href="classgfx_1_1Color3.html">gfx::Color3</a>(0+0.5,1-0.5,0+0.5)); <span class="keywordflow">break</span>;
00415     <span class="keywordflow">case</span> 7: material-&gt;setBaseColor(<a class="code" href="classgfx_1_1Color3.html">gfx::Color3</a>(0+0.6,1-0.6,0+0.6)); <span class="keywordflow">break</span>;
00416     <span class="keywordflow">case</span> 8: material-&gt;setBaseColor(<a class="code" href="classgfx_1_1Color3.html">gfx::Color3</a>(1,1,1)); <span class="keywordflow">break</span>;
00417     <span class="keywordflow">case</span> 9: material-&gt;setBaseColor(<a class="code" href="classgfx_1_1Color3.html">gfx::Color3</a>(1,0,0)); <span class="keywordflow">break</span>;
00418     <span class="keywordflow">default</span>:
00419       material-&gt;setBaseColor(<a class="code" href="classgfx_1_1Color3.html">gfx::Color3</a>(0,0,1));
00420     }
00421     
00422     <span class="comment">// add it to the system</span>
00423     <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp12">links</a>[l] = <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp9">solidSystem</a>-&gt;createSolid(cap,material);
00424     <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp12">links</a>[l]-&gt;setName(<a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatora6">getManipulatorDescription</a>()-&gt;<a class="code" href="classbase_1_1Named.html#base_1_1Worlda14">getName</a>()+<span class="stringliteral">" "</span>
00425                       +<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"link "</span>)+base::intToString(l));
00426     <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp9">solidSystem</a>-&gt;addSolid(links[l]);
00427 
00428     <span class="comment">// create a SpatialGroup which will hold a SpatialTransform warpping this link's Solid</span>
00429     <span class="comment">//  (as the link Solid may be transformed from the link origin), and the next link's</span>
00430     <span class="comment">//  group.</span>
00431     ref&lt;SpatialTransform&gt; linkTransform( NewObj <a class="code" href="classphysics_1_1SpatialTransform.html">SpatialTransform</a>() );
00432     linkTransform-&gt;setChild( links[l] ); <span class="comment">// wrap link in a SpatialTransform</span>
00433     ref&lt;SpatialGroup&gt; linkGroup( NewObj <a class="code" href="classphysics_1_1SpatialGroup.html">SpatialGroup</a>() );
00434     linkGroup-&gt;add(linkTransform); <span class="comment">// add it to the link group</span>
00435     linkGroup-&gt;setImplicitConfiguration(linkTransform); <span class="comment">// the configuration of the link group is synonymous with the linkTransform</span>
00436     <span class="keywordflow">if</span> (l &gt; 0) linkGroups[l-1]-&gt;add(linkGroup); <span class="comment">// add the linkGroup to the previous link's linkGroup</span>
00437     linkGroups.push_back(linkGroup); <span class="comment">// stash it into the link group array</span>
00438     
00439     <span class="keywordflow">if</span> (l == 0)
00440       <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp4">baseSolid</a> = <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp12">links</a>[l];
00441     <span class="keywordflow">else</span>
00442       <span class="keywordflow">if</span> (l == <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>.size())
00443         <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp5">endSolid</a> = links[l];
00444   }
00445 }
00446 
00447 
00448 
00449 <span class="keywordtype">void</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorb5">SimulatedSerialManipulator::positionLinks</a>(<span class="keyword">const</span> SimulatedSerialManipulator::TransformInfo&amp; transformInfo)
00450 {
00451   <a class="code" href="base.html#a19">Assert</a>(<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp12">links</a>.size() == <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>.size()+1); <span class="comment">// links must already have been created</span>
00452 
00453 <span class="comment">//  const Transform&amp; mountTransform(transformInfo.mountTransform);</span>
00454 
00455   <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp2">mountToBaseSolid</a> = transformInfo.mountToBaseSolid;
00456   <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp3">eeToEESolid</a> = transformInfo.eeToEESolid;
00457   
00458   
00459   <span class="comment">// some convenient aliases</span>
00460   <span class="keyword">const</span> array&lt;Transform&gt;&amp; SLT( transformInfo.SLT );   <span class="comment">// transforms from the link's Solid coord. frame to the link frame</span>
00461   <span class="keyword">const</span> array&lt;Transform&gt;&amp; T( transformInfo.T );
00462 
00463   <span class="comment">//Transform baseTransform(manipulatorDescr.getBaseTransform());</span>
00464     
00465   <span class="keywordflow">for</span> (<a class="code" href="namespacebase.html#a2">Int</a> l=0; l&lt;=<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>.size(); l++) { <span class="comment">// for each link</span>
00466 
00467     ref&lt;SpatialGroup&gt; linkGroup(linkGroups[l]);
00468     SpatialGroup::iterator firstChild = linkGroup-&gt;begin();
00469 
00470     <span class="comment">// set the transform from link origin to Solid origin first,</span>
00471     <span class="comment">// so that the Solid is properly configured when SpatialTransform configuration is set</span>
00472     ref&lt;SpatialTransform&gt; linkSpatialTransform( narrow_ref&lt;SpatialTransform&gt;( *firstChild ) );
00473     linkSpatialTransform-&gt;setTransform( SLT[l] );
00474     
00475     <span class="comment">// set SpatialTransform configuration (hence configuring its Solid child, and implicitly the linkGroup)</span>
00476     linkSpatialTransform-&gt;setConfiguration( T[l] ); 
00477     
00478   } <span class="comment">// for each link</span>
00479   
00480 }
00481 
00482 
00483 
00484 <span class="keywordtype">void</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorb6">SimulatedSerialManipulator::disableCollisions</a>(<span class="keyword">const</span> array&lt;ref&lt;physics::Collidable&gt; &gt;&amp; collidables, 
00485                                                    <span class="keyword">const</span> array&lt;ref&lt;physics::Collidable&gt; &gt;&amp; proximityCollidables)
00486 {
00487   <a class="code" href="base.html#a19">Assert</a>(solidSystem);
00488   <a class="code" href="base.html#a19">Assert</a>(<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp12">links</a>.size() == <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>.size()+1); <span class="comment">// links must already have been created</span>
00489   
00490   ref&lt;CollisionCuller&gt; cc(<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp9">solidSystem</a>-&gt;getCollisionCuller());
00491   <span class="keywordtype">bool</span> hasProxSensors = <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp0">manipulatorDescr</a>-&gt;hasLinkProximitySensors();
00492   
00493   <span class="keywordtype">bool</span> disableNextWithPrev = <span class="keyword">false</span>;   <span class="comment">// if true, disabled collisions between link's l &amp; l-2 (in addition to the</span>
00494                                       <span class="comment">// usual disable between l &amp; l-1.  This occurs when link l-1 has a length of 0 (coincident origins)</span>
00495   
00496   <span class="keywordflow">for</span> (<a class="code" href="namespacebase.html#a2">Int</a> l=1; l&lt;=<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>.size(); l++) { <span class="comment">// for each link</span>
00497     <span class="comment">// disable collision detection between consecutive links</span>
00498     cc-&gt;collisionEnable(<span class="keyword">false</span>,collidables[l-1],collidables[l]);
00499     
00500     <span class="comment">// and between link Solid Collidables &amp; their corresponding proximity sensor Collidable</span>
00501     <span class="keywordflow">if</span> (hasProxSensors) {
00502       cc-&gt;collisionEnable(<span class="keyword">false</span>,collidables[l], proximityCollidables[l]);
00503 
00504       cc-&gt;collisionEnable(<span class="keyword">false</span>,collidables[l-1],proximityCollidables[l]);
00505       cc-&gt;collisionEnable(<span class="keyword">false</span>,proximityCollidables[l-1],collidables[l]); 
00506     <span class="comment"></span>
00507 <span class="comment">//!!!debug reduce link-link prox hits</span>
00508 <span class="comment"></span><span class="comment">/*    if (l&gt;=2 &amp;&amp; l &lt; proximityCollidables.size()-2) {</span>
00509 <span class="comment">      cc-&gt;collisionEnable(false,collidables[l],proximityCollidables[l+1]);</span>
00510 <span class="comment">      cc-&gt;collisionEnable(false,collidables[l],proximityCollidables[l+2]);</span>
00511 <span class="comment">      cc-&gt;collisionEnable(false,collidables[l-1],proximityCollidables[l+1]);</span>
00512 <span class="comment">      cc-&gt;collisionEnable(false,collidables[l-1],proximityCollidables[l+2]);</span>
00513 <span class="comment">      cc-&gt;collisionEnable(false,collidables[l-2],proximityCollidables[l]);</span>
00514 <span class="comment">      cc-&gt;collisionEnable(false,collidables[l-2],proximityCollidables[l+1]);</span>
00515 <span class="comment">      cc-&gt;collisionEnable(false,collidables[l-2],proximityCollidables[l+2]);</span>
00516 <span class="comment">    }*/</span><span class="comment"></span>
00517 <span class="comment">//!!! </span>
00518 <span class="comment">//!!! debug - eliminate link-link prox hits</span>
00519 <span class="comment"></span>      <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> pl=0; pl&lt;proximityCollidables.size(); pl++)
00520         cc-&gt;collisionEnable(<span class="keyword">false</span>,collidables[l], proximityCollidables[pl]);<span class="comment"></span>
00521 <span class="comment">//!!!</span>
00522 <span class="comment"></span>    }
00523 
00524     <span class="keywordflow">if</span> (disableNextWithPrev) {
00525       cc-&gt;collisionEnable(<span class="keyword">false</span>,collidables[l-2],collidables[l]);
00526       <span class="keywordflow">if</span> (hasProxSensors) cc-&gt;collisionEnable(<span class="keyword">false</span>,collidables[l-2],proximityCollidables[l]);
00527       disableNextWithPrev = <span class="keyword">false</span>;
00528     }
00529 
00530     <span class="keywordflow">if</span> (<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp14">linkLengths</a>[l]&lt;=0.05)
00531        disableNextWithPrev = <span class="keyword">true</span>; <span class="comment">// don't collide link l+1 with l-1 as they will be close on account of this link l being 0 length</span>
00532     
00533   }  
00534   <span class="comment"></span>
00535 <span class="comment">//!!! eliminate base prox hits</span>
00536 <span class="comment"></span><span class="keywordflow">if</span> (hasProxSensors)
00537   <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> pl=0; pl&lt;proximityCollidables.size(); pl++)
00538     cc-&gt;collisionEnable(<span class="keyword">false</span>,collidables[0], proximityCollidables[pl]);<span class="comment"></span>
00539 <span class="comment">//!!!</span>
00540 <span class="comment"></span>}
00541 
00542 
00543 <span class="keywordtype">void</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorb7">SimulatedSerialManipulator::attachJoints</a>(<span class="keyword">const</span> SimulatedSerialManipulator::TransformInfo&amp; transformInfo)
00544 {
00545   <span class="keywordflow">if</span> (<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp12">links</a>.size() &lt; 2) <span class="keywordflow">return</span>; <span class="comment">// no joints</span>
00546 
00547   <span class="comment">// alias</span>
00548   <span class="keyword">const</span> array&lt;Transform&gt;&amp; T( transformInfo.T );     <span class="comment">// accumulated transformations for each link (transforms from frame l to base frame)</span>
00549   <span class="keyword">const</span> array&lt;Transform&gt;&amp; SLT( transformInfo.SLT ); 
00550   
00551   ref&lt;ConstraintGroup&gt; cgroup = <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp9">solidSystem</a>-&gt;createConstraintGroup();
00552   <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp9">solidSystem</a>-&gt;addConstraintGroup(cgroup);
00553   ref&lt;Motor&gt; motor;
00554   <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp13">joints</a>.resize(<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp12">links</a>.size()-1);
00555   
00556   <span class="keywordflow">for</span> (<a class="code" href="namespacebase.html#a2">Int</a> l=1; l&lt;<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp12">links</a>.size(); l++) { <span class="comment">// for each link (except the first)</span>
00557     <span class="comment">// connect it to the previous link in the chain</span>
00558   
00559     <span class="keyword">const</span> KinematicChain::Link&amp; link(chain[l-1]);
00560     ref&lt;Joint&gt; joint;
00561     
00562     <span class="comment">// Connect using a HingeJoint for revolute joints and a SliderJoint for prismatic joints</span>
00563     <span class="keywordflow">if</span> (link.isDHType()) {<span class="comment"></span>
00564 <span class="comment">//!!! check this is correct - is the link Zaxis == Solid -xaxis?? !!!      </span>
00565 <span class="comment"></span>      <span class="comment">// All DH type joints have an axis of Z - which is the Solid's -ve X-axis</span>
00566       <span class="comment">//  The axis is the z-axis of the previous link (l-1)</span>
00567       <span class="comment">// (they are specified relative to link l - hence we must transform z-axis</span>
00568       <span class="comment">//  of link l-1 into link l's coord. frame.)  </span>
00569       Vector3 axis( Vector3(-1,0,0) ); <span class="comment">// untransformed Solid -ve x-axis (link z-axis)</span>
00570       <span class="keywordflow">if</span> (l&gt;1) {
00571         axis = (T[l-1]*SLT[l-1]).rotate(axis);  <span class="comment">// -ve x-axis of link Solid l-1 </span>
00572         axis = <a class="code" href="namespacebase.html#a115">inverse</a>(T[l]*SLT[l]).rotate(axis);  <span class="comment">// -ve x-axis of link Solid l-1 in frame of link Solid l</span>
00573       } <span class="keywordflow">else</span> { <span class="comment">// connection to base is special case</span>
00574         axis = T[0].rotate(Vector3(0,0,1)); <span class="comment">// z-axis in base frame</span>
00575         axis = <a class="code" href="namespacebase.html#a115">inverse</a>(T[1]*SLT[1]).rotate(axis);  <span class="comment">// z-axis of base frame in frame of link Solid l</span>
00576       }
00577       
00578       
00579       <span class="keywordflow">if</span> (link.type() == KinematicChain::Link::Revolute) {
00580   
00581         ref&lt;HingeJoint&gt; hinge = <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp9">solidSystem</a>-&gt;createHingeJoint();
00582         joint = hinge;
00583         cgroup-&gt;addConstraint(hinge);
00584         <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp13">joints</a>[l-1] = joint;
00585         <a class="code" href="base.html#a19">Assert</a>(links[l-1]);
00586         joint-&gt;attach(links[l], links[l-1]);
00587   
00588         <span class="comment">// the anchor is at the end of the link (toward the base - not the origin end)</span>
00589         hinge-&gt;setAnchor( <a class="code" href="namespacebase.html#a26">Point3</a>(0,0,-linkLengths[l]/2) );
00590         hinge-&gt;setAxis( axis ); 
00591   
00592         <span class="comment">// set limits</span>
00593         <span class="keywordflow">if</span> (! ((link.minLimit() &lt;= -consts::Pi)&amp;&amp;(link.maxLimit() &gt;= consts::Pi)) ) {
00594           hinge-&gt;setLowStop(link.minLimit() - Math::degToRad(1) );
00595           hinge-&gt;setHighStop(link.maxLimit() + Math::degToRad(1) );
00596           hinge-&gt;setStopRestitution(0.2);
00597         }
00598   
00599         <span class="comment">// now attach a Motor to drive the joint</span>
00600         motor = <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp9">solidSystem</a>-&gt;createMotor();
00601         hinge-&gt;attachMotor(1, motor);
00602   
00603       }
00604       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (link.type() == KinematicChain::Link::Prismatic) {
00605   
00606         ref&lt;SliderJoint&gt; slider = <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp9">solidSystem</a>-&gt;createSliderJoint();
00607         joint = slider;
00608         cgroup-&gt;addConstraint(slider);
00609         <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp13">joints</a>[l-1] = joint;
00610         <a class="code" href="base.html#a19">Assert</a>(links[l-1]);
00611         joint-&gt;attach(links[l], links[l-1]);
00612   
00613         slider-&gt;setAxis( axis ); 
00614   
00615         <span class="comment">// set limits</span>
00616         slider-&gt;setLowStop(link.minLimit());
00617         slider-&gt;setHighStop(link.maxLimit());
00618         slider-&gt;setStopRestitution(0.2);
00619   
00620         <span class="comment">// now attach a Motor to drive the joint</span>
00621         motor = <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp9">solidSystem</a>-&gt;createMotor();
00622         slider-&gt;attachMotor(1, motor);
00623   
00624         <a class="code" href="base.html#a3">Logln</a>(<span class="stringliteral">"Warning: Prismatic joints not fully implemented"</span>);
00625       }
00626     }
00627     <span class="keywordflow">else</span>
00628       <span class="keywordflow">throw</span> std::invalid_argument(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"unknown/unsupported joint type: "</span> + link.type()));
00629 
00630     motor-&gt;setTargetVel(0);
00631     motor-&gt;setMaxForce(0.001); <span class="comment">// provide a little damping</span>
00632 
00633   } <span class="comment">// for each link </span>
00634 
00635 }
00636   
00637   
00638   
00639 <span class="keywordtype">void</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorb1">SimulatedSerialManipulator::construct</a>(<span class="keyword">const</span> <a class="code" href="classbase_1_1Vector3.html">base::Point3</a>&amp; initialPosition, 
00640                                            <span class="keyword">const</span> <a class="code" href="classbase_1_1Orient.html">base::Orient</a>&amp; initialOrientation)
00641 {
00642   <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp1">mountConfiguration</a> = Transform(initialPosition, initialOrientation);
00643   
00644   linkGroups.clear();
00645   <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorb4">createLinks</a>(<a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorb2">computeLinkDimensions</a>(<a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp0">manipulatorDescr</a>-&gt;getLinkRadii()));
00646   
00647   
00648   <span class="comment">// first construct the joint parameter vector q, based on the home positions of </span>
00649   <span class="comment">//  each joint represented in the chain</span>
00650   <a class="code" href="base.html#a19">Assert</a>(<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>.size() &gt; 0);
00651   <a class="code" href="classdemeter_1_1Vector.html">Vector</a> <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp17">q</a>(<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>.dof());
00652   
00653   <span class="comment">// note: this only works for links with 1-dof (!!!)</span>
00654   <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> j=0; j&lt;<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>.dof(); j++) { <span class="comment">// for each joint</span>
00655     <span class="keyword">const</span> KinematicChain::Link&amp; link(<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp8">chain</a>.linkOfVariable(j)); <span class="comment">// get link for this joint</span>
00656     q[j] = link.variable();
00657   }
00658 
00659   <span class="comment">// compute the various transform matrices we need</span>
00660   TransformInfo transformInfo( <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorb3">computeLinkTransforms</a>(mountConfiguration, q) );
00661 
00662   <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorb5">positionLinks</a>(transformInfo);
00663   
00664   <span class="keywordflow">if</span> (<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp10">dynamic</a>) 
00665     <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorb7">attachJoints</a>(transformInfo);
00666 <span class="comment"></span>
00667 <span class="comment">//!!! fix up this mess with CollisionCuller/Detector/ResponseHandler  !!!!</span>
00668 <span class="comment"></span><span class="comment">// (mostly in [ODE]SoliidSystem).  There is a need for a CollisionSystem to hold everything together</span>
00669 <span class="comment">//   (including perhaps Collidables too)</span><span class="comment"></span>
00670 <span class="comment">//!!!</span>
00671 <span class="comment"></span>  
00672   <span class="keywordflow">if</span> (!<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp10">dynamic</a>) {
00673     <span class="comment">// replace the default CollisionResponseHandler with one that</span>
00674     <span class="comment">// doesn't create contacts</span><span class="comment"></span>
00675 <span class="comment">//!!! this doesn't seem to work - comment it out for now</span>
00676 <span class="comment"></span><span class="comment">//    ref&lt;CollisionResponseHandler&gt; nullHandler(NewObj NullCollisionResponseHandler(solidSystem-&gt;getCollisionDetector()));</span>
00677 <span class="comment">//    solidSystem-&gt;setCollisionResponseHandler( nullHandler );</span>
00678   }
00679 
00680   <span class="comment">// now create a CollisionResponseHandler to handle collisions between</span>
00681   <span class="comment">//  the proximity CollidableBodies and oher objects and insert it into</span>
00682   <span class="comment">//  the collision chain before the final handler</span>
00683   ref&lt;ProximityCollisionResponseHandler&gt; proximityHandler(NewObj <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorn1">ProximityCollisionResponseHandler</a>(ref&lt;SimulatedSerialManipulator&gt;(<span class="keyword">this</span>),
00684                                                                                                    <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp9">solidSystem</a>-&gt;getCollisionDetector() ));
00685   proximityHandler-&gt;addPotentialCollisionListener( <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp9">solidSystem</a>-&gt;getCollisionResponseHandler() );
00686   <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp9">solidSystem</a>-&gt;setCollisionResponseHandler( proximityHandler );
00687   
00688 }
00689 
00690 
00691 
00692 
00693 <span class="comment">// Spatial</span>
00694 
00695 <span class="keywordtype">void</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatora23">SimulatedSerialManipulator::setPosition</a>(<span class="keyword">const</span> Point3&amp; pos)       
00696 { 
00697   Transform baseTransform(<a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp0">manipulatorDescr</a>-&gt;getBaseTransform());
00698   <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp1">mountConfiguration</a> = <a class="code" href="namespacebase.html#a115">inverse</a>(baseTransform)*linkGroups[0]-&gt;getConfiguration();
00699   <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp1">mountConfiguration</a>.setTranslationComponent(pos);
00700   linkGroups[0]-&gt;setConfiguration(mountConfiguration); 
00701   
00702   <span class="comment">// re-position the tool at the ee-end, if necessary (static simulation only)</span>
00703   <span class="keywordflow">if</span> (!<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp10">dynamic</a> &amp;&amp; <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp10">toolGrasped</a>) {
00704     Transform eeConfig( <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatora13">getEEPosition</a>(), <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatora14">getEEOrientation</a>() );
00705     <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp9">proximityTool</a>-&gt;setConfiguration( eeConfig );
00706   }
00707   
00708 }
00709 
00710 <a class="code" href="namespacebase.html#a26">Point3</a> <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatora24">SimulatedSerialManipulator::getPosition</a>()<span class="keyword"> const                  </span>
00711 <span class="keyword"></span>{
00712   Transform baseTransform(<a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp0">manipulatorDescr</a>-&gt;getBaseTransform());
00713   <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp1">mountConfiguration</a> = <a class="code" href="namespacebase.html#a115">inverse</a>(baseTransform)*linkGroups[0]-&gt;getConfiguration();
00714   
00715   <span class="keywordflow">return</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp1">mountConfiguration</a>.getTranslation(); 
00716 }
00717 
00718 <span class="keywordtype">void</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatora25">SimulatedSerialManipulator::setOrientation</a>(<span class="keyword">const</span> Orient&amp; orient) 
00719 { 
00720   Transform baseTransform(<a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp0">manipulatorDescr</a>-&gt;getBaseTransform());
00721   <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp1">mountConfiguration</a> = <a class="code" href="namespacebase.html#a115">inverse</a>(baseTransform)*linkGroups[0]-&gt;getConfiguration();
00722   <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp1">mountConfiguration</a>.setRotationComponent(orient);
00723   linkGroups[0]-&gt;setConfiguration(mountConfiguration); 
00724 
00725   <span class="comment">// re-position the tool at the ee-end, if necessary (static simulation only)</span>
00726   <span class="keywordflow">if</span> (!<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp10">dynamic</a> &amp;&amp; <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp10">toolGrasped</a>) {
00727     Transform eeConfig( <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatora13">getEEPosition</a>(), <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatora14">getEEOrientation</a>() );
00728     <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp9">proximityTool</a>-&gt;setConfiguration( eeConfig );
00729   }
00730 }
00731 
00732 Orient <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatora26">SimulatedSerialManipulator::getOrientation</a>()<span class="keyword"> const               </span>
00733 <span class="keyword"></span>{ 
00734   Transform baseTransform(<a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp0">manipulatorDescr</a>-&gt;getBaseTransform());
00735   <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp1">mountConfiguration</a> = <a class="code" href="namespacebase.html#a115">inverse</a>(baseTransform)*linkGroups[0]-&gt;getConfiguration();
00736 
00737   <span class="keywordflow">return</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp1">mountConfiguration</a>.getRotation(); 
00738 }
00739 
00740 <span class="keywordtype">void</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatora27">SimulatedSerialManipulator::setConfiguration</a>(<span class="keyword">const</span> <a class="code" href="classbase_1_1Transform.html">base::Transform</a>&amp; configuration) 
00741 { 
00742   Transform baseTransform(<a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp0">manipulatorDescr</a>-&gt;getBaseTransform());
00743   <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp1">mountConfiguration</a> = configuration;
00744   linkGroups[0]-&gt;setConfiguration(mountConfiguration*baseTransform); 
00745 
00746   <span class="comment">// re-position the tool at the ee-end, if necessary (static simulation only)</span>
00747   <span class="keywordflow">if</span> (!<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp10">dynamic</a> &amp;&amp; <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp10">toolGrasped</a>) {
00748     Transform eeConfig( <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatora13">getEEPosition</a>(), <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatora14">getEEOrientation</a>() );
00749     <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp9">proximityTool</a>-&gt;setConfiguration( eeConfig );
00750   }
00751 }
00752 
00753 <a class="code" href="classbase_1_1Transform.html">base::Transform</a> <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatora28">SimulatedSerialManipulator::getConfiguration</a>()<span class="keyword"> const    </span>
00754 <span class="keyword"></span>{ 
00755   Transform baseTransform(<a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp0">manipulatorDescr</a>-&gt;getBaseTransform());
00756   <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp1">mountConfiguration</a> = <a class="code" href="namespacebase.html#a115">inverse</a>(baseTransform)*linkGroups[0]-&gt;getConfiguration();
00757   <span class="keywordflow">return</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp1">mountConfiguration</a>;
00758 }
00759 
00760 
00761 
00762 
00763 <a class="code" href="classbase_1_1Vector3.html">base::Point3</a> <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatora13">SimulatedSerialManipulator::getEEPosition</a>()<span class="keyword"> const</span>
00764 <span class="keyword"></span>{
00765   <span class="comment">// the end-effector frame is co-incident with the end of the ee solid</span>
00766 
00767   <span class="comment">// get the vector offset from ee origin to ee solid origin</span>
00768   Vector3 eeToEESolidOffset( <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp3">eeToEESolid</a>.getTranslation() );
00769   <span class="comment">// now express it in the world frame</span>
00770   Vector3 eeToEESolidOffsetWorld( <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp5">endSolid</a>-&gt;getOrientation().rotate(eeToEESolidOffset) );
00771   <span class="comment">// add it to the end solid origin to get the ee origin</span>
00772 
00773   <span class="keywordflow">return</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp5">endSolid</a>-&gt;getPosition() + eeToEESolidOffsetWorld;
00774 }
00775 
00776 
00777 <a class="code" href="classbase_1_1Orient.html">base::Orient</a> <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatora14">SimulatedSerialManipulator::getEEOrientation</a>()<span class="keyword"> const</span>
00778 <span class="keyword"></span>{
00779   Matrix3 eeToEESolidOrient(<a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp3">eeToEESolid</a>.getRotation());
00780   <span class="keywordflow">return</span> <a class="code" href="classbase_1_1Orient.html">base::Orient</a>(  <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp5">endSolid</a>-&gt;getOrientation() * Orient(eeToEESolidOrient).getQuat4() );
00781 }
00782 
00783 
00784 
00785 <span class="keywordtype">bool</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatora15">SimulatedSerialManipulator::checkProximity</a>(ref&lt;SimulatedTool&gt; tool)
00786 {
00787   <span class="keywordflow">if</span> (<a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp10">toolGrasped</a>) 
00788     <span class="keywordflow">return</span> (tool == <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp9">proximityTool</a>);
00789     
00790   <span class="comment">// compare the end-effector position/orient with that of the tool</span>
00791   <span class="comment">//  If it is within tolerance, return true and record the tool in proximityTool</span>
00792   <a class="code" href="namespacebase.html#a26">Point3</a> eePos(<a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatora13">getEEPosition</a>());
00793   <span class="keywordflow">if</span> ( (eePos- tool-&gt;getPosition()).length() &lt; <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp7">proximityDistance</a> ) {
00794     Vector3 eeOrient(<a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatora14">getEEOrientation</a>().getVector3(Orient::EulerRPY));
00795     Vector3 toolOrient( tool-&gt;getOrientation().getVector3(Orient::EulerRPY));
00796     Vector3 eeAngDiff( Math::angleDifference(toolOrient.x,eeOrient.x),
00797                        Math::angleDifference(toolOrient.y,eeOrient.y),
00798                        Math::angleDifference(toolOrient.z,eeOrient.z) );
00799     <span class="keywordflow">if</span> (    (Math::abs(eeAngDiff.x) &lt; <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp8">proximityAngle</a>)
00800          &amp;&amp; (Math::abs(eeAngDiff.y) &lt; <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp8">proximityAngle</a>)
00801          &amp;&amp; (Math::abs(eeAngDiff.z) &lt; <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp8">proximityAngle</a>) ) {
00802       <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp9">proximityTool</a> = tool;
00803       <span class="keywordflow">return</span> <span class="keyword">true</span>;
00804     }
00805 
00806   }
00807   
00808   <span class="keywordflow">return</span> <span class="keyword">false</span>;
00809 }
00810 
00811 
00812 
00813 
00814 <span class="keywordtype">bool</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatora18">SimulatedSerialManipulator::graspTool</a>()
00815 {
00816   <span class="keywordflow">if</span> (<a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp10">toolGrasped</a>) <span class="keywordflow">return</span> <span class="keyword">true</span>; <span class="comment">// tool already in grasp</span>
00817 
00818   <span class="keywordflow">if</span> (!<a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp9">proximityTool</a>) <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">// no tool to grasp</span>
00819   
00820   <span class="comment">// recheck that the last tool indicated in proximity is still there</span>
00821   <span class="keywordflow">if</span> (!<a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatora15">checkProximity</a>(proximityTool)) <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">// no longer in proximity</span>
00822 
00823   <span class="comment">// first position the tool exactly in position/orient to be grasped</span>
00824   <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp9">proximityTool</a>-&gt;setPositionOrientation( <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatora13">getEEPosition</a>(), <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatora14">getEEOrientation</a>() );
00825   
00826   <span class="comment">// now attach it</span>
00827   <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp9">proximityTool</a>-&gt;attachTo( endSolid );
00828   
00829   linkGroups[linkGroups.size()-1]-&gt;add(proximityTool);
00830 
00831   <span class="comment">// disable collision detection between the first link of the tool and the ee</span>
00832   <span class="comment">//                                     the ee link and the tool first link sensor</span>
00833   <span class="comment">//                                     the ee link sensor and the tool first link</span>
00834   ref&lt;CollisionCuller&gt; cc(<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp9">solidSystem</a>-&gt;getCollisionCuller());
00835   ref&lt;Collidable&gt; eeCollidable( collidables[<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp15">collidables</a>.size()-1] );
00836   ref&lt;Collidable&gt; eeProxCollidable( proximityCollidables[<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp16">proximityCollidables</a>.size()-1] );
00837   ref&lt;Collidable&gt; toolLinkCollidable( <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp9">proximityTool</a>-&gt;getFirstLinkCollidable() );
00838   ref&lt;Collidable&gt; toolLinkProxCollidable( <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp9">proximityTool</a>-&gt;getFirstLinkProximitySensorCollidable() );
00839   <a class="code" href="base.html#a19">Assert</a>(eeCollidable &amp;&amp; eeProxCollidable &amp;&amp; toolLinkCollidable &amp;&amp; toolLinkProxCollidable);
00840   cc-&gt;collisionEnable(<span class="keyword">false</span>, eeCollidable, toolLinkCollidable );
00841   cc-&gt;collisionEnable(<span class="keyword">false</span>, eeProxCollidable, toolLinkCollidable );
00842   cc-&gt;collisionEnable(<span class="keyword">false</span>, eeCollidable, toolLinkProxCollidable );
00843   <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp10">toolGrasped</a> = <span class="keyword">true</span>;
00844 
00845   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00846 }
00847 
00848 
00849 <span class="keywordtype">void</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatora19">SimulatedSerialManipulator::releaseGrasp</a>()
00850 {
00851   <span class="keywordflow">if</span> (!<a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp10">toolGrasped</a>) <span class="keywordflow">return</span>;
00852 
00853   <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp9">proximityTool</a>-&gt;detatch();
00854   linkGroups[linkGroups.size()-1]-&gt;remove(proximityTool);
00855   
00856   <span class="comment">// re-enable collisions between the first link of the tool and the ee</span>
00857   <a class="code" href="base.html#a19">Assert</a>(solidSystem); <a class="code" href="base.html#a19">Assert</a>(<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp15">collidables</a>.size()&gt;0);
00858   ref&lt;CollisionCuller&gt; cc(<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp9">solidSystem</a>-&gt;getCollisionCuller());
00859   ref&lt;Collidable&gt; eeCollidable( collidables[<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp15">collidables</a>.size()-1] );
00860   cc-&gt;collisionEnable(<span class="keyword">true</span>, eeCollidable, <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp9">proximityTool</a>-&gt;getFirstLinkCollidable() );
00861   
00862   
00863   <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp10">toolGrasped</a> = <span class="keyword">false</span>;
00864 }
00865 
00866 
00867 
00868 ref&lt;physics::Collidable&gt; <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatora29">SimulatedSerialManipulator::createCollidable</a>(CollidableFlags flags)
00869 {
00870   ref&lt;CollisionCuller&gt; cc(<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp9">solidSystem</a>-&gt;getCollisionCuller());
00871   ref&lt;CollisionDetector&gt; cd(<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp9">solidSystem</a>-&gt;getCollisionDetector());
00872 
00873   <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp20">linkProximitySurfPosition</a>.resize(<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp12">links</a>.size());
00874   
00875   <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp15">collidables</a>.resize(<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp12">links</a>.size()); <span class="comment">// collidables for each link</span>
00876   <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp16">proximityCollidables</a>.resize(<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp12">links</a>.size());  <span class="comment">// proximity sensor for each link</span>
00877   ref&lt;CollidableGroup&gt; linkCollidableGroup = cc-&gt;createCollidableGroup();
00878   <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp18">proximityCollidableGroup</a> = cc-&gt;createCollidableGroup();
00879   
00880   <span class="keyword">const</span> array&lt;Real&gt;&amp; linkRadii( <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp0">manipulatorDescr</a>-&gt;getLinkRadii() );
00881   
00882   <span class="comment">// create Collidables for each link (one that is connected to the Solid</span>
00883   <span class="comment">//  and optionally one for the proximity sensor)</span>
00884   <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> l=0; l&lt;<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp12">links</a>.size(); l++) {
00885     <span class="comment">// Collidable for link Solid</span>
00886     <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp15">collidables</a>[l] = <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp12">links</a>[l]-&gt;createCollidable(flags);
00887     linkCollidableGroup-&gt;addCollidable( collidables[l] );
00888     <span class="keywordflow">if</span> (l==0) <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp15">collidables</a>[l]-&gt;setName(<span class="stringliteral">"baseLink"</span>);
00889     
00890     <span class="keywordflow">if</span> (<a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp0">manipulatorDescr</a>-&gt;hasLinkProximitySensors()) {
00891 
00892       <span class="comment">// Collidable for proximity around each link</span>
00893       
00894       <span class="comment">// get link geometry info</span>
00895       ref&lt;const Shape&gt; linkShape( links[l]-&gt;getShape() );
00896       <a class="code" href="namespacebase.html#a5">Real</a> linkHeight;
00897       <a class="code" href="namespacebase.html#a5">Real</a> linkRadius;
00898       <span class="keywordflow">if</span> (<a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp0">manipulatorDescr</a>-&gt;hasGeometry()) {
00899         linkHeight = narrow_ref&lt;const Capsule&gt;(linkShape)-&gt;height(); <span class="comment">// capsule!!!</span>
00900         linkRadius = linkRadii[l];
00901       }
00902       <span class="keywordflow">else</span> {
00903         linkHeight = narrow_ref&lt;const Capsule&gt;(linkShape)-&gt;height(); <span class="comment">// capsule!!!</span>
00904         linkRadius = narrow_ref&lt;const Capsule&gt;(linkShape)-&gt;radius(); <span class="comment">// capsule!!!</span>
00905       }
00906       
00907       <a class="code" href="namespacebase.html#a5">Real</a> proxHeight = linkHeight;<span class="comment"></span>
00908 <span class="comment">//!!!! just for video      </span>
00909 <span class="comment"></span>      <a class="code" href="namespacebase.html#a5">Real</a> proxRadius = <span class="comment">/*linkRadius +*/</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp0">manipulatorDescr</a>-&gt;linkProximitySensorRange();
00910       ref&lt;const Capsule&gt; collisionShape(NewObj <a class="code" href="classphysics_1_1Capsule.html">Capsule</a>(proxHeight, proxRadius));
00911       <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp20">linkProximitySurfPosition</a>[l] = linkRadius;
00912 
00913       ref&lt;Collidable&gt; pbody( links[l]-&gt;<a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatora29">createCollidable</a>(collisionShape, flags) );
00914       pbody-&gt;setInterpenetrationIsNormal(<span class="keyword">true</span>); <span class="comment">// the link solid is normally inside the proximity Collidable</span>
00915       pbody-&gt;setUserClass(SensorCollidableClass); <span class="comment">// cull sensor-sensor collision checks</span>
00916 
00917       <span class="keywordflow">if</span> (l!=0)
00918         pbody-&gt;setName( pbody-&gt;getName()+<span class="stringliteral">" Sensor"</span> );
00919       <span class="keywordflow">else</span>
00920         pbody-&gt;setName(<span class="stringliteral">"baseLink Sensor"</span>);
00921 
00922 <span class="comment">//VisualDebugUtil::addDebugObject(linkShape, links[l]-&gt;getName(), links[l]-&gt;getConfiguration(),Color4("yellow",0.2));//!!!</span>
00923 <span class="comment">//disable colision capsule display: VisualDebugUtil::addDebugObject(collisionShape, pbody-&gt;getName(), links[l]-&gt;getConfiguration(),Color4("lime green",0.15));//!!!</span>
00924     <span class="comment">// ref self so we can identify our Collidable quickly in ProximityCollisionResponseHandler</span>
00925       pbody-&gt;setUserData(ref&lt;SimulatedSerialManipulator&gt;(<span class="keyword">this</span>)); 
00926       <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp16">proximityCollidables</a>[l] = pbody;
00927       <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp18">proximityCollidableGroup</a>-&gt;addCollidable( proximityCollidables[l] );
00928     }
00929     
00930   }
00931 
00932   <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp18">proximityCollidableGroup</a>-&gt;setChildIntercollisionEnabled(<span class="keyword">false</span>);
00933   <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp18">proximityCollidableGroup</a>-&gt;setUserClass(SensorCollidableClass);
00934   
00935   <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorb6">disableCollisions</a>(collidables, proximityCollidables);
00936   
00937   ref&lt;CollidableGroup&gt; collidableGroup = cc-&gt;createCollidableGroup();
00938   collidableGroup-&gt;addCollidable( linkCollidableGroup );
00939   <span class="keywordflow">if</span> (<a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorp0">manipulatorDescr</a>-&gt;hasLinkProximitySensors()) 
00940     collidableGroup-&gt;addCollidable( proximityCollidableGroup );
00941   
00942   <span class="keywordflow">return</span> collidableGroup;
00943 }
00944 
00945 
00946 
00947 <a class="code" href="namespacebase.html#a5">Real</a> <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatora20">SimulatedSerialManipulator::getClosestObjectDistance</a>(Int link)<span class="keyword"> const </span>
00948 <span class="keyword"></span>{ 
00949   <span class="keywordflow">if</span> (<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp19">linkProximity</a>.size()&gt;0) {
00950     <a class="code" href="base.html#a19">Assert</a>(link &lt; <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp19">linkProximity</a>.size());
00951     <span class="keywordflow">return</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp19">linkProximity</a>[link].dist; 
00952   }
00953   <span class="keywordflow">else</span> 
00954     <span class="keywordflow">return</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedTools0">maxDist</a>+1.0; 
00955 }
00956 
00957 <a class="code" href="classbase_1_1Vector3.html">base::Vector3</a> <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatora21">SimulatedSerialManipulator::getClosestObjectDirection</a>(Int link)<span class="keyword"> const </span>
00958 <span class="keyword"></span>{
00959   <span class="keywordflow">if</span> (<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp19">linkProximity</a>.size()&gt;0) {
00960     <a class="code" href="base.html#a19">Assert</a>(link &lt; <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp19">linkProximity</a>.size());
00961     <span class="keywordflow">return</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp19">linkProximity</a>[link].dir;
00962   }
00963   <span class="keywordflow">else</span>
00964     <span class="keywordflow">return</span> Vector3();
00965 }
00966 
00967 <a class="code" href="namespacebase.html#a5">Real</a> <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatora22">SimulatedSerialManipulator::getClosestObjectSensorPosition</a>(Int link)<span class="keyword"> const </span>
00968 <span class="keyword"></span>{ 
00969   <span class="keywordflow">if</span> (<a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp19">linkProximity</a>.size()&gt;0) {
00970     <a class="code" href="base.html#a19">Assert</a>(link &lt; <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp19">linkProximity</a>.size());
00971     <span class="keywordflow">return</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp19">linkProximity</a>[link].intersect;
00972   } 
00973   <span class="keywordflow">else</span> 
00974     <span class="keywordflow">return</span> 0;
00975 }
00976 
00977 
00978 
00979 
00980 <span class="keywordtype">void</span> <a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatorb9">SimulatedSerialManipulator::handleCollision</a>(ref&lt;physics::CollisionState&gt; collisionState) 
00981 {
00982   <span class="keyword">typedef</span> SimulatedSerialManipulator::ProximityData ProximityData;
00983 
00984   <span class="comment">// figure out proximity info for ControlInterface</span>
00985 
00986   <span class="keywordtype">bool</span> firstIsSensor = (collisionState-&gt;collidable1-&gt;getUserData() == ref&lt;SimulatedSerialManipulator&gt;(<span class="keyword">this</span>));
00987   
00988   <span class="comment">// find the corresponding link</span>
00989   <a class="code" href="namespacebase.html#a2">Int</a> l=0;
00990   <span class="keywordtype">bool</span> found = <span class="keyword">false</span>;
00991   CollidableGroup::const_iterator sc( <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp18">proximityCollidableGroup</a>-&gt;begin() );
00992   CollidableGroup::const_iterator send( <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp18">proximityCollidableGroup</a>-&gt;end() );
00993   <span class="keywordflow">while</span> ((sc != send) &amp;&amp; !found) {
00994     <span class="keywordflow">if</span> (*sc == (firstIsSensor?collisionState-&gt;collidable1:collisionState-&gt;collidable2) )
00995       found = <span class="keyword">true</span>;
00996     <span class="keywordflow">else</span> {
00997       ++sc; ++l;
00998     }
00999   }
01000 <span class="comment"></span>
01001 <span class="comment">//!!! handle base problem</span>
01002 <span class="comment"></span><span class="keywordflow">if</span> (l &lt; 3) <span class="keywordflow">return</span>;  
01003   
01004   ref&lt;const CollidableBody&gt; body1( narrow_ref&lt;const CollidableBody&gt;(collisionState-&gt;collidable1) );
01005   ref&lt;const CollidableBody&gt; body2( narrow_ref&lt;const CollidableBody&gt;(collisionState-&gt;collidable2) );
01006   <span class="comment"></span>
01007 <span class="comment">  //!!!!</span>
01008 <span class="comment"></span><span class="comment">//  String name1(body1-&gt;getName());</span>
01009 <span class="comment">//  String name2(body2-&gt;getName());</span>
01010 <span class="comment">//  if ((name1.find("Multi") != String::npos) || (name2.find("Multi") != String::npos)) {</span>
01011 <span class="comment">//    Debugcln(DJ,"SimSerManip::handleCollision():" &lt;&lt; body1-&gt;getName() &lt;&lt; " and " &lt;&lt; body2-&gt;getName());  </span>
01012 <span class="comment">//  }</span><span class="comment"></span>
01013 <span class="comment">  //!!!!</span>
01014 <span class="comment"></span>
01015   <span class="comment">// now we compute the distance from the axis of the Solid (actually a segment</span>
01016   <span class="comment">//  running along the axis) and the obstacle</span>
01017   ref&lt;const Solid&gt; linkSolid( narrow_ref&lt;const Solid&gt;( links[l] ) );
01018   Transform T( linkSolid-&gt;getConfiguration() );
01019   <a class="code" href="namespacebase.html#a5">Real</a> length( linkLengths[l] );
01020   <a class="code" href="classgfx_1_1Segment3.html">Segment3</a> linkSeg( T*<a class="code" href="namespacebase.html#a26">Point3</a>(0,0,-length/2.0), T*<a class="code" href="namespacebase.html#a26">Point3</a>(0,0,length/2.0) );
01021   
01022   <span class="comment">//  now determine distance between the obstacle and the link segment</span>
01023   ref&lt;const Shape&gt; obstacleShape( (firstIsSensor?body2:body1)-&gt;getShape() );
01024   Transform obstacleT( (firstIsSensor?body2:body1)-&gt;<a class="code" href="classrobot_1_1sim_1_1SimulatedSerialManipulator.html#robot_1_1sim_1_1SimulatedSerialManipulatora28">getConfiguration</a>() );
01025   <span class="comment">// shortest degment between them</span>
01026   <a class="code" href="classgfx_1_1Segment3.html">Segment3</a> seg( obstacleShape-&gt;shortestSegmentBetween(obstacleT, linkSeg) );
01027 
01028   <a class="code" href="namespacebase.html#a5">Real</a> dist = seg.<a class="code" href="classgfx_1_1Segment3.html#gfx_1_1Segment3a14">length</a>();
01029   Vector3 direction( seg.<a class="code" href="classgfx_1_1Segment3.html#gfx_1_1Segment3o0">s</a> - seg.<a class="code" href="classgfx_1_1Segment3.html#gfx_1_1Segment3o1">e</a> ); <span class="keywordflow">if</span> (dist &gt; 0) direction.normalize();
01030   <a class="code" href="namespacebase.html#a5">Real</a> intersect = (seg.<a class="code" href="classgfx_1_1Segment3.html#gfx_1_1Segment3o1">e</a> - linkSeg.<a class="code" href="classgfx_1_1Segment3.html#gfx_1_1Segment3o0">s</a>).length();
01031   ProximityData proxData(dist, intersect,  direction); 
01032   <a class="code" href="classrobot_1_1sim_1_1SimulatedKinematicChain.html#robot_1_1sim_1_1SimulatedToolp19">linkProximity</a>[l] = proxData;
01033   
01034 
01035   <span class="keywordflow">if</span> (!firstIsSensor) <a class="code" href="namespacebase.html#a46">base::swap</a>(body1, body2);
01036   <span class="comment"></span>
01037 <span class="comment">//!!! debug  </span>
01038 <span class="comment"></span><span class="comment">//Debugln(DJ,"proximity between " &lt;&lt; body1-&gt;getName() &lt;&lt; " and " &lt;&lt; body2-&gt;getName());</span>
01039 <span class="comment">//Debugcln(DJ,"seg between " &lt;&lt; body1-&gt;getName() &lt;&lt; " and " &lt;&lt; body2-&gt;getName() &lt;&lt; " is " &lt;&lt; seg &lt;&lt; " len=" &lt;&lt; seg.length());</span>
01040 
01041   <span class="comment">// try to visualize the proximity data  </span>
01042   Transform c;
01043   c.setToTranslation( seg.<a class="code" href="classgfx_1_1Segment3.html#gfx_1_1Segment3o0">s</a> + 0.5*(seg.<a class="code" href="classgfx_1_1Segment3.html#gfx_1_1Segment3o1">e</a>-seg.<a class="code" href="classgfx_1_1Segment3.html#gfx_1_1Segment3o0">s</a>) );
01044   Matrix3 <a class="code" href="Globals_8h.html#a15">R</a>; <a class="code" href="Globals_8h.html#a15">R</a>.setIdentity();
01045   <span class="keywordflow">if</span> (!seg.<a class="code" href="classgfx_1_1Segment3.html#gfx_1_1Segment3o1">e</a>.equals(seg.<a class="code" href="classgfx_1_1Segment3.html#gfx_1_1Segment3o0">s</a>)) {
01046     Vector3 z( seg.<a class="code" href="classgfx_1_1Segment3.html#gfx_1_1Segment3o1">e</a> - seg.<a class="code" href="classgfx_1_1Segment3.html#gfx_1_1Segment3o0">s</a> ); z.normalize();
01047     Vector3 x(1,0,0);
01048     <span class="keywordflow">if</span> (x.equals(z) || x.equals(-z)) x = Vector3(0,1,0);
01049     <span class="keywordflow">if</span> (x.equals(z) || x.equals(-z)) x = Vector3(0,0,1);
01050     <span class="keywordflow">if</span> (x.equals(z) || x.equals(-z)) x = Vector3(1,1,0);
01051     Vector3 y( <a class="code" href="namespacebase.html#a243">cross</a>(x,z) ); y.normalize();
01052     x = <a class="code" href="namespacebase.html#a243">cross</a>( y,z ); x.normalize();
01053     <a class="code" href="Globals_8h.html#a15">R</a>.setColumn(1,x);
01054     <a class="code" href="Globals_8h.html#a15">R</a>.setColumn(2,y);
01055     <a class="code" href="Globals_8h.html#a15">R</a>.setColumn(3,z);
01056   }
01057   c.setRotationComponent( R );
01058   VisualDebugUtil::addDebugCylinderObject(dist, 0.005, body1-&gt;getName()+<span class="stringliteral">"proxseg"</span>, c, <a class="code" href="classgfx_1_1Color4.html">gfx::Color4</a>(<span class="stringliteral">"yellow"</span>));
01059   
01060 <span class="comment">/*  </span>
01061 <span class="comment">  // try to visualize the push-away direction</span>
01062 <span class="comment">  {</span>
01063 <span class="comment">    Real L = 0.00611899; // push away dist</span>
01064 <span class="comment">    Point3 p(0.824874,1.36352,0.540932); // push away point</span>
01065 <span class="comment">    Vector3 n(0.893771,0.448523,-0); // push away direction</span>
01066 <span class="comment">    n.normalize();</span>
01067 <span class="comment">    c = Transform();</span>
01068 <span class="comment">    c.setToTranslation( p - 0.5*L*n);</span>
01069 <span class="comment">    Matrix3 R; R.setIdentity();</span>
01070 <span class="comment">    Vector3 z( n ); z.normalize();</span>
01071 <span class="comment">    Vector3 x(1,0,0);</span>
01072 <span class="comment">    if (x.equals(z) || x.equals(-z)) x = Vector3(0,1,0);</span>
01073 <span class="comment">    if (x.equals(z) || x.equals(-z)) x = Vector3(0,0,1);</span>
01074 <span class="comment">    if (x.equals(z) || x.equals(-z)) x = Vector3(1,1,0);</span>
01075 <span class="comment">    Vector3 y( cross(x,z) ); y.normalize();</span>
01076 <span class="comment">    x = cross( y,z ); x.normalize();</span>
01077 <span class="comment">    R.setColumn(1,x);</span>
01078 <span class="comment">    R.setColumn(2,y);</span>
01079 <span class="comment">    R.setColumn(3,z);</span>
01080 <span class="comment">    c.setRotationComponent( R );</span>
01081 <span class="comment">    VisualDebugUtil::addDebugCapsuleObject(L, 0.01, "pushpoint1", c, gfx::Color4("cyan"));</span>
01082 <span class="comment">  }  </span>
01083 <span class="comment">*/</span>  
01084 <span class="comment">//disable collision capsule red display:  VisualDebugUtil::setColor(body1-&gt;getName(), Color4("red",0.15)); </span><span class="comment"></span>
01085 <span class="comment">//!!!</span>
01086 <span class="comment"></span>}
01087 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Jul 29 15:56:42 2004 for OpenSim by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.6 </small></address>
</body>
</html>
