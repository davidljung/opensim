<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>OpenSim: base/Serializer.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>base/Serializer.cpp</h1><a href="Serializer_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/****************************************************************************</span>
00002 <span class="comment">  Copyright (C)2002 David Jung &lt;opensim@pobox.com&gt;</span>
00003 <span class="comment"></span>
00004 <span class="comment">  This program/file is free software; you can redistribute it and/or modify</span>
00005 <span class="comment">  it under the terms of the GNU General Public License as published by</span>
00006 <span class="comment">  the Free Software Foundation; either version 2 of the License, or</span>
00007 <span class="comment">  (at your option) any later version.</span>
00008 <span class="comment">  </span>
00009 <span class="comment">  This program is distributed in the hope that it will be useful,</span>
00010 <span class="comment">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00011 <span class="comment">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00012 <span class="comment">  GNU General Public License for more details. (http://www.gnu.org)</span>
00013 <span class="comment">  </span>
00014 <span class="comment">  You should have received a copy of the GNU General Public License</span>
00015 <span class="comment">  along with this program; if not, write to the Free Software</span>
00016 <span class="comment">  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
00017 <span class="comment">  </span>
00018 <span class="comment">  $Id: Serializer.cpp 1029 2004-02-11 20:45:54Z jungd $</span>
00019 <span class="comment">  $Revision: 1.8 $</span>
00020 <span class="comment">  $Date: 2004-02-11 15:45:54 -0500 (Wed, 11 Feb 2004) $</span>
00021 <span class="comment">  $Author: jungd $</span>
00022 <span class="comment"> </span>
00023 <span class="comment">****************************************************************************/</span>
00024 
00025 <span class="preprocessor">#include &lt;<a class="code" href="Serializer.html">base/Serializer</a>&gt;</span>
00026 
00027 <span class="preprocessor">#include &lt;<a class="code" href="Serializable.html">base/Serializable</a>&gt;</span>
00028 
00029 <span class="keyword">using</span> <a class="code" href="classbase_1_1Serializer.html">base::Serializer</a>;
00030 <span class="keyword">using</span> <a class="code" href="classbase_1_1Serializable.html">base::Serializable</a>;
00031 
00032 
00033 <span class="preprocessor">#ifdef DEBUG</span>
00034 <span class="preprocessor"></span>
00035 <span class="comment">// comment out to inhibit serialization debugging</span>
00036 <span class="comment">//#define SDEBUG</span>
00037 
00038 <span class="preprocessor">#endif</span>
00039 <span class="preprocessor"></span>
00040 
00041 Serializer::Serializer(SerializerType type) 
00042   : output(type==Output), follow(true), aborted(false),
00043       serializePointerRecursionDepth(0)
00044 {
00045   <a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerp6">ptrs</a>.push_back(0); <span class="comment">// the null ptr is a special at index 0 (so nulls can be serialized)</span>
00046   <a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerp7">serialized</a>.push_back(<span class="keyword">true</span>);
00047 }
00048 
00049 Serializer::Serializer(SerializerType type, ref&lt;VFile&gt; archive) 
00050   : output(type==Output), follow(true), aborted(false),
00051       serializePointerRecursionDepth(0) 
00052 {
00053   <a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerp6">ptrs</a>.push_back(0); <span class="comment">// the null ptr is a special at index 0 (so nulls can be serialized)</span>
00054   <a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerp7">serialized</a>.push_back(<span class="keyword">true</span>);
00055 }
00056 
00057 Serializer::Serializer(SerializerType type, std::ios&amp; stream) 
00058   : output(type==Output), follow(true), aborted(false),
00059       serializePointerRecursionDepth(0)
00060 {
00061   <a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerp6">ptrs</a>.push_back(0); <span class="comment">// the null ptr is a special at index 0 (so nulls can be serialized)</span>
00062   <a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerp7">serialized</a>.push_back(<span class="keyword">true</span>);
00063 }
00064 
00065 Serializer::~Serializer()
00066 {
00067  <span class="keywordflow">if</span> (<a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializera7">isOutput</a>() &amp;&amp; !<a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerp5">aborted</a>) {
00068     <span class="comment">// check for objects that have been referenced during Output serialization</span>
00069     <span class="comment">//  but not serialized</span>
00070     <a class="code" href="namespacebase.html#a2">Int</a> outstandingSerializationCount = 0;
00071     <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> pi=0; pi&lt;<a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerp7">serialized</a>.size(); pi++) 
00072       <span class="keywordflow">if</span> (!<a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerp7">serialized</a>[pi]) 
00073         outstandingSerializationCount++;
00074     <span class="keywordflow">if</span> (outstandingSerializationCount&gt;0) {
00075       <a class="code" href="base.html#a3">Logln</a>(<span class="stringliteral">"Serializer destruction with outstanding object serializations (objects referenced in the Output stream, but not serialized) - "</span> &lt;&lt; outstandingSerializationCount &lt;&lt; <span class="stringliteral">" objects."</span>);
00076     }
00077   }
00078 }
00079 
00080 
00081 <span class="keywordtype">bool</span> Serializer::followReferences(<span class="keywordtype">bool</span> follow)
00082 {
00083   <span class="keywordflow">if</span> (!follow)
00084     <a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerp9">depthAtFollowDisable</a> = <a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerp8">serializePointerRecursionDepth</a>;
00085   <span class="keywordtype">bool</span> oldfollow = this-&gt;follow;
00086   this-&gt;follow = follow;
00087   <span class="keywordflow">return</span> oldfollow;
00088 }
00089 
00090 
00091 
00092 <span class="keyword">const</span> <a class="code" href="namespacebase.html#a4">String</a> Serializer::inputToConstErrorString(<span class="stringliteral">"cannot input to a const variable"</span>);
00093 
00094 
00095 Serializer&amp; Serializer::serialize(Serializable&amp; r, <span class="keyword">const</span> String&amp; memberName)
00096 {
00097   <a class="code" href="namespacebase.html#a4">String</a> typeName(<span class="keyword">typeid</span>(r).name());
00098   <a class="code" href="classbase_1_1Serializer.html#base_1_1Serializerb12">preSerializeObject</a>(typeName, ObjectType, memberName);
00099   r.serialize(*<span class="keyword">this</span>);
00100   <a class="code" href="classbase_1_1Serializer.html#base_1_1Serializerb13">postSerializeObject</a>(memberName);
00101   <span class="keywordflow">return</span> *<span class="keyword">this</span>;
00102 }
00103 
00104 
00105 
00106 Serializer&amp; Serializer::operator()(<a class="code" href="classdemeter_1_1Vector.html">Vector</a>&amp; v, <span class="keyword">const</span> String&amp; memberName)
00107 {
00108   <a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializera9">comment</a>(memberName);
00109   <span class="keywordflow">if</span>(<a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializera7">isOutput</a>()) {
00110     <a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializera10">operator()</a>(v.size(),<span class="stringliteral">"dim"</span>);
00111   }
00112   <span class="keywordflow">else</span> {
00113     <a class="code" href="namespacebase.html#a2">Int</a> dim;
00114     <a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializera10">operator()</a>(dim,<span class="stringliteral">"dim"</span>);
00115     v.resize(dim);
00116   }
00117 
00118   <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=0; i&lt;v.size(); i++)
00119     <a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializera10">operator()</a>(v[i]);
00120 
00121   <span class="keywordflow">return</span> *<span class="keyword">this</span>;
00122 }
00123 
00124 
00125 Serializer&amp; Serializer::operator()(<a class="code" href="classbase_1_1matrix.html">Matrix</a>&amp; m, <span class="keyword">const</span> String&amp; memberName)
00126 {
00127   <a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializera9">comment</a>(memberName);
00128   <span class="keywordflow">if</span>(<a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializera7">isOutput</a>()) {
00129     <a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializera10">operator()</a>(m.<a class="code" href="classbase_1_1matrix.html#base_1_1matrixa8">size1</a>(),<span class="stringliteral">"rows"</span>);
00130     <a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializera10">operator()</a>(m.<a class="code" href="classbase_1_1matrix.html#base_1_1matrixa9">size2</a>(),<span class="stringliteral">"cols"</span>);
00131   }
00132   <span class="keywordflow">else</span> {
00133     <a class="code" href="namespacebase.html#a2">Int</a> rows, cols;
00134     <a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializera10">operator()</a>(rows,<span class="stringliteral">"rows"</span>);
00135     <a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializera10">operator()</a>(cols,<span class="stringliteral">"cols"</span>);
00136     m.<a class="code" href="classbase_1_1matrix.html#base_1_1matrixa15">resize</a>(rows,cols);
00137   }
00138 
00139   <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> r=0; r&lt;m.<a class="code" href="classbase_1_1matrix.html#base_1_1matrixa8">size1</a>(); r++)
00140     <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> c=0; c&lt;m.<a class="code" href="classbase_1_1matrix.html#base_1_1matrixa9">size2</a>(); c++)
00141       <a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializera10">operator()</a>(m(r,c));
00142 
00143   <span class="keywordflow">return</span> *<span class="keyword">this</span>;
00144 }
00145 
00146 
00147 
00148 <span class="keyword">inline</span> <a class="code" href="namespacebase.html#a2">Int</a> Serializer::ptrIndex(Serializable* p)
00149 {
00150   <span class="keywordflow">for</span>(<a class="code" href="namespacebase.html#a2">Int</a> i=<a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerp6">ptrs</a>.size()-1; i&gt;0; i--)
00151     <span class="keywordflow">if</span> (<a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerp6">ptrs</a>[i] == p) <span class="keywordflow">return</span> i;
00152   <span class="keywordflow">if</span> (<a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerp6">ptrs</a>[0] == p) <span class="keywordflow">return</span> 0;
00153   <span class="keywordflow">return</span> <a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerp6">ptrs</a>.size();
00154 }
00155 
00156 
00157 
00158 <span class="keywordtype">void</span> Serializer::serializePointer(Serializable*&amp; p, Serializable::SerializableInstantiator* i, <span class="keyword">const</span> String&amp; memberName, <span class="keywordtype">bool</span> forceTypeSerialization)
00159 {
00160   <a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerp8">serializePointerRecursionDepth</a>++;
00161 
00162   <span class="keywordflow">if</span> (<a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerp3">output</a>) { <span class="comment">// Output</span>
00163 
00164     <a class="code" href="namespacebase.html#a2">Int</a> pi = <a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerb21">ptrIndex</a>(p);
00165     <span class="keywordflow">if</span> (pi == <a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerp6">ptrs</a>.size()) { 
00166       <span class="comment">// wasn't found (reference to object not previously encountered)</span>
00167 
00168       <span class="keywordflow">if</span> (<a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerp4">follow</a> || (!<a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerp4">follow</a> &amp;&amp; (<a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerp8">serializePointerRecursionDepth</a>==<a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerp9">depthAtFollowDisable</a>+1)) ) {
00169 <span class="preprocessor">#ifdef SDEBUG</span>
00170 <span class="preprocessor"></span>        <a class="code" href="debugtools.html#a7">Debugln</a>(Ser,<a class="code" href="namespacebase.html#a4">String</a>(serializePointerRecursionDepth,<span class="charliteral">' '</span>) &lt;&lt; <span class="stringliteral">"serializing(out) obj("</span> &lt;&lt; (p?<a class="code" href="namespacebase.html#a4">String</a>(<a class="code" href="base.html#a25">instanceof</a>(*p,Object)?dynamic_cast&lt;Object*&gt;(p)-&gt;<a class="code" href="classbase_1_1Object.html#base_1_1VFileSystema11">className</a>():<span class="stringliteral">"unknown"</span>):<span class="stringliteral">"null"</span>) &lt;&lt; <span class="stringliteral">") ["</span> &lt;&lt; pi &lt;&lt; <span class="stringliteral">"] first encounter"</span>);
00171 <span class="preprocessor">#endif</span>
00172 <span class="preprocessor"></span>        <span class="comment">// serialize type, index and object</span>
00173         <a class="code" href="namespacebase.html#a4">String</a> typeName(<span class="keyword">typeid</span>(*p).name());
00174         <a class="code" href="classbase_1_1Serializer.html#base_1_1Serializerb12">preSerializeObject</a>(typeName,ReferencedObjectType, memberName, forceTypeSerialization);
00175         <a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerb17">serializeReferenceIndex</a>(pi); <span class="comment">// output index</span>
00176         <a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerp6">ptrs</a>.at(pi) = p;
00177         <a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerp7">serialized</a>.at(pi) = <span class="keyword">true</span>;
00178         p-&gt;serialize(*<span class="keyword">this</span>); <span class="comment">// output object</span>
00179         <a class="code" href="classbase_1_1Serializer.html#base_1_1Serializerb13">postSerializeObject</a>(memberName);
00180       }
00181       <span class="keywordflow">else</span> {
00182 <span class="preprocessor">#ifdef SDEBUG</span>
00183 <span class="preprocessor"></span>        <a class="code" href="debugtools.html#a7">Debugln</a>(Ser,<a class="code" href="namespacebase.html#a4">String</a>(serializePointerRecursionDepth,<span class="charliteral">' '</span>) &lt;&lt; <span class="stringliteral">"serializing(out) ptr("</span> &lt;&lt; (p?<a class="code" href="namespacebase.html#a4">String</a>(<a class="code" href="base.html#a25">instanceof</a>(*p,Object)?dynamic_cast&lt;Object*&gt;(p)-&gt;<a class="code" href="classbase_1_1Object.html#base_1_1VFileSystema11">className</a>():<span class="stringliteral">"unknown"</span>):<span class="stringliteral">"null"</span>) &lt;&lt; <span class="stringliteral">") ["</span> &lt;&lt; pi &lt;&lt; <span class="stringliteral">"] first encounter"</span>);
00184 <span class="preprocessor">#endif</span>
00185 <span class="preprocessor"></span>        <span class="comment">// serialize type and index only</span>
00186         <a class="code" href="namespacebase.html#a4">String</a> typeName(<span class="keyword">typeid</span>(*p).name());
00187         <a class="code" href="classbase_1_1Serializer.html#base_1_1Serializerb12">preSerializeObject</a>(typeName,ObjectReferenceType, memberName, forceTypeSerialization);
00188         <a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerb17">serializeReferenceIndex</a>(pi); <span class="comment">// output index</span>
00189         <a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerp6">ptrs</a>.at(pi) = p;
00190         <a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerp7">serialized</a>.at(pi) = <span class="keyword">false</span>;
00191         <a class="code" href="classbase_1_1Serializer.html#base_1_1Serializerb13">postSerializeObject</a>(memberName);
00192       }
00193 
00194     }
00195     <span class="keywordflow">else</span> { <span class="comment">// already been encountered</span>
00196 
00197       <span class="keywordflow">if</span> ( (<a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerp4">follow</a> || (!<a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerp4">follow</a> &amp;&amp; (serializePointerRecursionDepth==<a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerp9">depthAtFollowDisable</a>+1))) 
00198            &amp;&amp; !<a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerp7">serialized</a>[pi]) { 
00199 <span class="preprocessor">#ifdef SDEBUG</span>
00200 <span class="preprocessor"></span>        <a class="code" href="debugtools.html#a7">Debugln</a>(Ser,<a class="code" href="namespacebase.html#a4">String</a>(serializePointerRecursionDepth,<span class="charliteral">' '</span>) &lt;&lt; <span class="stringliteral">"serializing(out) obj("</span> &lt;&lt; (p?<a class="code" href="namespacebase.html#a4">String</a>(<a class="code" href="base.html#a25">instanceof</a>(*p,Object)?dynamic_cast&lt;Object*&gt;(p)-&gt;<a class="code" href="classbase_1_1Object.html#base_1_1VFileSystema11">className</a>():<span class="stringliteral">"unknown"</span>):<span class="stringliteral">"null"</span>) &lt;&lt; <span class="stringliteral">") ["</span> &lt;&lt; pi &lt;&lt; <span class="stringliteral">"]"</span>);
00201 <span class="preprocessor">#endif</span>
00202 <span class="preprocessor"></span>        <span class="comment">// object wasn't serialized on previous encounters, must have been in</span>
00203         <span class="comment">//  non-follow mode.  Serialize it now.</span>
00204         <a class="code" href="namespacebase.html#a4">String</a> typeName(<span class="keyword">typeid</span>(*p).name());
00205         <a class="code" href="classbase_1_1Serializer.html#base_1_1Serializerb12">preSerializeObject</a>(typeName,ReferencedObjectType, memberName, forceTypeSerialization);
00206         <a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerb17">serializeReferenceIndex</a>(pi); <span class="comment">// output index</span>
00207         <a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerp7">serialized</a>[pi] = <span class="keyword">true</span>;
00208         p-&gt;serialize(*<span class="keyword">this</span>); <span class="comment">// output object</span>
00209         <a class="code" href="classbase_1_1Serializer.html#base_1_1Serializerb13">postSerializeObject</a>(memberName);
00210       }
00211       <span class="keywordflow">else</span> { 
00212 <span class="preprocessor">#ifdef SDEBUG</span>
00213 <span class="preprocessor"></span>        <a class="code" href="debugtools.html#a7">Debugln</a>(Ser,<a class="code" href="namespacebase.html#a4">String</a>(serializePointerRecursionDepth,<span class="charliteral">' '</span>) &lt;&lt; <span class="stringliteral">"serializing(out) ptr("</span> &lt;&lt; (p?<a class="code" href="namespacebase.html#a4">String</a>(<a class="code" href="base.html#a25">instanceof</a>(*p,Object)?dynamic_cast&lt;Object*&gt;(p)-&gt;<a class="code" href="classbase_1_1Object.html#base_1_1VFileSystema11">className</a>():<span class="stringliteral">"unknown"</span>):<span class="stringliteral">"null"</span>) &lt;&lt; <span class="stringliteral">") ["</span> &lt;&lt; pi &lt;&lt; <span class="stringliteral">"]"</span>);
00214 <span class="preprocessor">#endif</span>
00215 <span class="preprocessor"></span>        <span class="comment">// never serialize in non-follow mode (just output index)</span>
00216         <span class="comment">//  (or if it's already been serialized)</span>
00217         <a class="code" href="namespacebase.html#a4">String</a> typeName(<span class="keyword">typeid</span>(*p).name());
00218         <a class="code" href="classbase_1_1Serializer.html#base_1_1Serializerb12">preSerializeObject</a>(typeName,ObjectReferenceType, memberName, forceTypeSerialization);
00219         <a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerb17">serializeReferenceIndex</a>(pi); <span class="comment">// output index</span>
00220         <a class="code" href="classbase_1_1Serializer.html#base_1_1Serializerb13">postSerializeObject</a>(memberName);
00221       }
00222     }
00223   }
00224   <span class="keywordflow">else</span> { <span class="comment">// Input</span>
00225 
00226     <a class="code" href="namespacebase.html#a4">String</a> typeName;
00227     <a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerx5">TypeModifier</a> readTypeModifier = <a class="code" href="classbase_1_1Serializer.html#base_1_1Serializerb12">preSerializeObject</a>(typeName,UnknownType, memberName, forceTypeSerialization);
00228 
00229     <span class="keywordflow">if</span> (readTypeModifier == <a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerx5base_1_1SimpleXMLSerializerx2">ReferencedObjectType</a>) { <span class="comment">// a referenced object</span>
00230 
00231       <span class="comment">// deserialize</span>
00232       <a class="code" href="namespacebase.html#a2">Int</a> pi;
00233       <a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerb17">serializeReferenceIndex</a>(pi); <span class="comment">// read index</span>
00234 
00235       <span class="keywordflow">if</span> (pi &gt; <a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerp6">ptrs</a>.size())
00236         <span class="keywordflow">throw</span> serialization_error(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"serialization input stream corrupted (object out of sequence)"</span>));
00237       <span class="keywordflow">else</span> {
00238         <span class="keywordflow">if</span> (pi == <a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerp6">ptrs</a>.size()) { <span class="comment">// haven't read object before, instantiate it now</span>
00239           <span class="comment">// create an instance to hold the new object, if necessary</span>
00240           <span class="keywordflow">if</span> (p==0) {
00241             <span class="keywordflow">if</span> (i != 0)
00242               p = i-&gt;newSerializable();
00243             <span class="keywordflow">else</span> { <span class="comment">// dynamically lookup an instantiator</span>
00244               <span class="keywordflow">try</span>{
00245                 <span class="keyword">const</span> Serializable::SerializableInstantiator&amp; i(Serializable::getSerializableInstantiator(<a class="code" href="namespacebase.html#a4">String</a>(), typeName));
00246                 p = i.newSerializable();
00247               } <span class="keywordflow">catch</span> (std::exception&amp; e) { <a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerb19">abort</a>(e.what()); }
00248             }
00249           }
00250           <a class="code" href="base.html#a19">Assert</a>(p);
00251           
00252           <span class="keywordflow">if</span> (!typeName.empty()) {
00253             <span class="keywordflow">if</span> (typeName != <a class="code" href="namespacebase.html#a58">base::className</a>(<span class="keyword">typeid</span>(*p)))
00254               <span class="keywordflow">throw</span> serialization_error(<a class="code" href="base.html#a15">Exception</a>(<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"read unexpected object type: "</span>)+typeName+<span class="stringliteral">" expected "</span>+base::className(<span class="keyword">typeid</span>(*p))));
00255           }
00256 
00257 <span class="preprocessor">#ifdef SDEBUG</span>
00258 <span class="preprocessor"></span>          <a class="code" href="debugtools.html#a7">Debugln</a>(Ser,<a class="code" href="namespacebase.html#a4">String</a>(serializePointerRecursionDepth,<span class="charliteral">' '</span>) &lt;&lt; <span class="stringliteral">"serializing(in) obj("</span> &lt;&lt; (p?<a class="code" href="namespacebase.html#a4">String</a>(<a class="code" href="base.html#a25">instanceof</a>(*p,Object)?dynamic_cast&lt;Object*&gt;(p)-&gt;<a class="code" href="classbase_1_1Object.html#base_1_1VFileSystema11">className</a>():<span class="stringliteral">"unknown"</span>):<span class="stringliteral">"null"</span>) &lt;&lt; <span class="stringliteral">") ["</span> &lt;&lt; pi &lt;&lt; <span class="stringliteral">"]"</span> &lt;&lt; ((pi == <a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerp6">ptrs</a>.size())?<span class="stringliteral">" instantiated"</span>:<span class="stringliteral">""</span>) );
00259 <span class="preprocessor">#endif</span>
00260 <span class="preprocessor"></span>          <a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerp6">ptrs</a>.at(pi) = p;
00261         }
00262         <span class="keywordflow">else</span> {
00263           <span class="comment">// we've encountered the object before - which means it was instantiated</span>
00264           <span class="comment">//  but not serialized</span>
00265           p = <a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerp6">ptrs</a>[pi];
00266         }
00267         
00268         p-&gt;serialize(*<span class="keyword">this</span>); <span class="comment">// input object</span>
00269 
00270         <a class="code" href="classbase_1_1Serializer.html#base_1_1Serializerb13">postSerializeObject</a>(memberName);
00271       }
00272     }
00273     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (readTypeModifier == <a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerx5base_1_1SimpleXMLSerializerx3">ObjectReferenceType</a>) { <span class="comment">// an object reference</span>
00274 
00275       <a class="code" href="namespacebase.html#a2">Int</a> pi;
00276       <a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerb17">serializeReferenceIndex</a>(pi); <span class="comment">// read index</span>
00277 
00278       <span class="keywordflow">if</span> (pi&gt;<a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerp6">ptrs</a>.size())
00279         <span class="keywordflow">throw</span> serialization_error(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"serialization input stream corrupted (reference to object not yet encountered)"</span>));
00280       <span class="keywordflow">else</span> {
00281         <span class="keywordflow">if</span> (pi == <a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerp6">ptrs</a>.size()) { <span class="comment">// index to unread object</span>
00282           <span class="comment">// create an object of the referenced type using the default constructor</span>
00283           <span class="comment">//  (we can't initialize/serialize it until it is encoundered in the stream)</span>
00284           <span class="keywordflow">if</span> (p==0) {
00285             <span class="keywordflow">if</span> (i != 0)
00286               p = i-&gt;newSerializable();
00287             <span class="keywordflow">else</span> { <span class="comment">// dynamically lookup an instantiator</span>
00288               <span class="keywordflow">try</span> {
00289                 <span class="keyword">const</span> Serializable::SerializableInstantiator&amp; i(Serializable::getSerializableInstantiator(<a class="code" href="namespacebase.html#a4">String</a>(), typeName));
00290                 p = i.newSerializable();
00291               } <span class="keywordflow">catch</span> (std::exception&amp; e) { <a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerb19">abort</a>(e.what()); }
00292             }
00293           }
00294           <a class="code" href="base.html#a19">Assert</a>(p);
00295 
00296           <span class="keywordflow">if</span> (!typeName.empty()) {
00297             <span class="keywordflow">if</span> (typeName != <a class="code" href="namespacebase.html#a58">base::className</a>(<span class="keyword">typeid</span>(*p)))
00298               <span class="keywordflow">throw</span> serialization_error(<a class="code" href="base.html#a15">Exception</a>(<a class="code" href="namespacebase.html#a4">String</a>(<span class="stringliteral">"read unexpected object reference type: "</span>)+typeName+<span class="stringliteral">" expected "</span>+base::className(<span class="keyword">typeid</span>(*p))));
00299           }
00300 <span class="preprocessor">#ifdef SDEBUG</span>
00301 <span class="preprocessor"></span>          <a class="code" href="debugtools.html#a7">Debugln</a>(Ser,<a class="code" href="namespacebase.html#a4">String</a>(serializePointerRecursionDepth,<span class="charliteral">' '</span>) &lt;&lt; <span class="stringliteral">"serializing(in) ptr("</span> &lt;&lt; (p?<a class="code" href="namespacebase.html#a4">String</a>(<a class="code" href="base.html#a25">instanceof</a>(*p,Object)?dynamic_cast&lt;Object*&gt;(p)-&gt;<a class="code" href="classbase_1_1Object.html#base_1_1VFileSystema11">className</a>():<span class="stringliteral">"unknown"</span>):<span class="stringliteral">"null"</span>) &lt;&lt; <span class="stringliteral">") ["</span> &lt;&lt; pi &lt;&lt; <span class="stringliteral">"] instantiated"</span> );
00302 <span class="preprocessor">#endif</span>
00303 <span class="preprocessor"></span>          <a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerp6">ptrs</a>.at(pi) = p;
00304         }
00305         <span class="keywordflow">else</span> { <span class="comment">// backward reference to previously read object</span>
00306           p = <a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerp6">ptrs</a>[pi];
00307           <a class="code" href="base.html#a19">Assert</a>(p);
00308 <span class="preprocessor">#ifdef SDEBUG</span>
00309 <span class="preprocessor"></span>          <a class="code" href="debugtools.html#a7">Debugln</a>(Ser,<a class="code" href="namespacebase.html#a4">String</a>(serializePointerRecursionDepth,<span class="charliteral">' '</span>) &lt;&lt; <span class="stringliteral">"serializing(in) ptr("</span> &lt;&lt; (p?<a class="code" href="namespacebase.html#a4">String</a>(<a class="code" href="base.html#a25">instanceof</a>(*p,Object)?dynamic_cast&lt;Object*&gt;(p)-&gt;<a class="code" href="classbase_1_1Object.html#base_1_1VFileSystema11">className</a>():<span class="stringliteral">"unknown"</span>):<span class="stringliteral">"null"</span>) &lt;&lt; <span class="stringliteral">") ["</span> &lt;&lt; pi &lt;&lt; <span class="stringliteral">"]"</span> );
00310 <span class="preprocessor">#endif</span>
00311 <span class="preprocessor"></span>
00312         }
00313       }
00314 
00315       <a class="code" href="classbase_1_1Serializer.html#base_1_1Serializerb13">postSerializeObject</a>(memberName);
00316 
00317     }
00318     <span class="keywordflow">else</span> 
00319       <span class="keywordflow">throw</span> serialization_error(<a class="code" href="base.html#a15">Exception</a>(<span class="stringliteral">"serialization input stream corrupted (unknown reference type)"</span>));
00320   }
00321 
00322   serializePointerRecursionDepth--;
00323 
00324 }
00325 
00326 
00327 <span class="keywordtype">void</span> Serializer::abort(<span class="keyword">const</span> String&amp; exceptionString)
00328 { 
00329   <span class="keywordflow">if</span> (!<a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerp5">aborted</a>) {
00330     <a class="code" href="classbase_1_1Serializer.html#base_1_1SimpleXMLSerializerp5">aborted</a>=<span class="keyword">true</span>; 
00331     <a class="code" href="base.html#a3">Logln</a>(exceptionString);
00332     <span class="keywordflow">throw</span> serialization_error(<a class="code" href="base.html#a15">Exception</a>(exceptionString)); 
00333   }
00334 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Jul 29 15:56:13 2004 for OpenSim by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.6 </small></address>
</body>
</html>
