<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>OpenSim: robot/control/oldikor/IKOR/constraints.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>robot/control/oldikor/IKOR/constraints.c</h1><a href="constraints_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/* ________________________________________________________</span>
00002 <span class="comment">  |                                                        |</span>
00003 <span class="comment">  | Program Name:   constraints.c                          |</span>
00004 <span class="comment">  |________________________________________________________|</span>
00005 <span class="comment">  |                                                        |</span>
00006 <span class="comment">  | description: Determines if constraints are necessary   |</span>
00007 <span class="comment">  |    for the system and if so calculates necessary betas.|</span>
00008 <span class="comment">  |                                                        |</span>
00009 <span class="comment">  | Procedures:                                            |</span>
00010 <span class="comment">  |    avoid_limits    : finds limit breach &amp; calls beta   |</span>
00011 <span class="comment">  |    avoid_obstacles : finds obs   breach &amp; calls beta   |</span>
00012 <span class="comment">  |    find_intersection_sphere : As named                 |</span>
00013 <span class="comment">  |________________________________________________________| */</span>
00014 
00015 <span class="preprocessor">#include &lt;<a class="code" href="general_8h.html">IKOR/general.h</a>&gt;</span>      <span class="comment">/* Header File to link all others */</span>
00016 
00017 <span class="comment">/* ________________________________________________________</span>
00018 <span class="comment">  | name:    avoid_limits                                  |</span>
00019 <span class="comment">  | description:  Loops through all joint limits to find   |</span>
00020 <span class="comment">  |     out if a joint has reached either an upper or a    |</span>
00021 <span class="comment">  |     a lower limit.  If one has been reached and        |</span>
00022 <span class="comment">  |     solution vectors have yet to be found, solution    |</span>
00023 <span class="comment">  |     vectors are calculated and betas produced, other-  |</span>
00024 <span class="comment">  |     wise, if solutions have already been found, the    |</span>
00025 <span class="comment">  |     find beta function is called.                      |</span>
00026 <span class="comment">  |                                                        |</span>
00027 <span class="comment">  | inputs:  See Declarations below                        |</span>
00028 <span class="comment">  | outputs: Calls functions to calculate betas.           |</span>
00029 <span class="comment">  |________________________________________________________|</span>
00030 <span class="comment">  | Authors:     Date:     Modifications:                  |</span>
00031 <span class="comment">  |  F Tulloch     4/94    Algorithm Creation for 2 g's    |</span>
00032 <span class="comment">  |  c hacker     10/94    Ported from 2 g's to FSP        |</span>
00033 <span class="comment">  |                2/95    Ported to Solutions struct      |</span>
00034 <span class="comment">  |________________________________________________________| */</span>
00035 
<a name="l00036"></a><a class="code" href="headers_8h.html#a29">00036</a> <span class="keywordtype">int</span> <a class="code" href="headers_8h.html#a29">avoid_limits</a>(FSP_data, Jacob, dx, got_gs, datafp)
00037 FILE   *<a class="code" href="general_8h.html#a34">datafp</a>;         <span class="comment">/* data file declaration            */</span>
00038 <span class="keywordtype">int</span>    *got_gs;         <span class="comment">/* get_gs or not, used for  TWOSTEP */</span>
00039 <a class="code" href="structMATRIX.html">MATRIX</a> *Jacob,          <span class="comment">/* needed to find soln's if TWOSTEP */</span>
00040        *dx;             <span class="comment">/* needed to find soln's if TWOSTEP */</span>
00041 <a class="code" href="structSolutions.html">Solutions</a> *FSP_data;    <span class="comment">/* see structures.h                 */</span>
00042 {
00043   <span class="keywordtype">int</span>    qchk, ii,
00044          bound = <a class="code" href="general_8h.html#a18">FALSE</a>;
00045   <span class="keywordtype">double</span> distance_2_move;
00046 
00047   <span class="keywordflow">if</span> (<a class="code" href="fsp_8c.html#a0">DEBUG</a>) {
00048     fprintf(<a class="code" href="general_8h.html#a34">datafp</a>,<span class="stringliteral">"\n  ______________________________  \n"</span>);
00049     fprintf(<a class="code" href="general_8h.html#a34">datafp</a>,<span class="stringliteral">"\n      JOINT LIMIT AVOIDANCE       \n"</span>);
00050     fprintf(<a class="code" href="general_8h.html#a34">datafp</a>,  <span class="stringliteral">"  ______________________________  \n\n"</span>);
00051   }
00052   <span class="keywordflow">for</span> (qchk = 0; qchk &lt; M; qchk++)
00053   {
00054               <span class="comment">/*  limit_upper... */</span>
00055     <span class="keywordflow">if</span>  (<a class="code" href="general_8h.html#a4">rad</a>(<a class="code" href="general_8h.html#a57">Robot</a>-&gt;<a class="code" href="structManipulator__struct.html#Manipulator__structo10">Angles</a>[qchk].<a class="code" href="structANGLE.html#ANGLEo2">Min_limit</a>) &gt; FSP_data-&gt;<a class="code" href="structSolutions.html#Solutionso7">Qarray</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[qchk][0])
00056     {   
00057       bound = <a class="code" href="general_8h.html#a17">TRUE</a>;
00058       distance_2_move = 
00059         <a class="code" href="general_8h.html#a4">rad</a>(<a class="code" href="general_8h.html#a57">Robot</a>-&gt;<a class="code" href="structManipulator__struct.html#Manipulator__structo10">Angles</a>[qchk].<a class="code" href="structANGLE.html#ANGLEo2">Min_limit</a>) - FSP_data-&gt;<a class="code" href="structSolutions.html#Solutionso7">Qarray</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[qchk][0];
00060     }                        <span class="comment">/*  limit_upper... */</span>
00061 
00062     <span class="keywordflow">else</span>      <span class="comment">/*  limit_lower... */</span>
00063     <span class="keywordflow">if</span> (<a class="code" href="general_8h.html#a4">rad</a>(<a class="code" href="general_8h.html#a57">Robot</a>-&gt;<a class="code" href="structManipulator__struct.html#Manipulator__structo10">Angles</a>[qchk].<a class="code" href="structANGLE.html#ANGLEo1">Max_limit</a>) &lt; FSP_data-&gt;<a class="code" href="structSolutions.html#Solutionso7">Qarray</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[qchk][0])
00064     {
00065       bound = <a class="code" href="general_8h.html#a17">TRUE</a>;
00066       distance_2_move = 
00067         <a class="code" href="general_8h.html#a4">rad</a>(<a class="code" href="general_8h.html#a57">Robot</a>-&gt;<a class="code" href="structManipulator__struct.html#Manipulator__structo10">Angles</a>[qchk].<a class="code" href="structANGLE.html#ANGLEo1">Max_limit</a>) - FSP_data-&gt;<a class="code" href="structSolutions.html#Solutionso7">Qarray</a>-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[qchk][0];
00068     }                        <span class="comment">/*  limit_lower... */</span>
00069 
00070   <span class="keywordflow">if</span> (bound)
00071     <span class="keywordflow">if</span> ( (  <a class="code" href="general_8h.html#a57">Robot</a>-&gt;<a class="code" href="structManipulator__struct.html#Manipulator__structo10">Angles</a>[qchk].<a class="code" href="structANGLE.html#ANGLEo0">Prism</a>  ) ||
00072          ((!<a class="code" href="general_8h.html#a57">Robot</a>-&gt;<a class="code" href="structManipulator__struct.html#Manipulator__structo10">Angles</a>[qchk].<a class="code" href="structANGLE.html#ANGLEo0">Prism</a>)&amp;&amp;(fabs(distance_2_move)&gt;.00001))   )
00073     {
00074       bound = <a class="code" href="general_8h.html#a18">FALSE</a>;
00075       <span class="keywordflow">if</span> ( (<a class="code" href="general_8h.html#a55">STEP</a> == <a class="code" href="general_8h.html#a26">TWO</a>) &amp;&amp; (!(*got_gs)) ) 
00076       {
00077         <a class="code" href="Jacob__UTILS_8c.html#a0">GET_JACOBIAN</a>(Jacob, FSP_data-&gt;<a class="code" href="structSolutions.html#Solutionso7">Qarray</a>);
00078         <a class="code" href="headers_8h.html#a14">Solution_generator</a> ( FSP_data, Jacob, dx, <a class="code" href="general_8h.html#a34">datafp</a> ); 
00079         *got_gs = <a class="code" href="general_8h.html#a17">TRUE</a>;
00080       }
00081 
00082 <span class="preprocessor">      #ifdef DEBUG_OUT</span>
00083 <span class="preprocessor"></span>        fprintf(stderr, <span class="stringliteral">"   joint(1-%d) #%i limited  "</span>, M, qchk+1);
00084 <span class="preprocessor">      #endif</span>
00085 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (<a class="code" href="fsp_8c.html#a0">DEBUG</a>) {
00086         fprintf(<a class="code" href="general_8h.html#a34">datafp</a>, <span class="stringliteral">"\n\njoint # %i out of range by %lf "</span>,
00087                 qchk+1, <a class="code" href="general_8h.html#a5">deg</a>(distance_2_move));
00088       }
00089       <a class="code" href="headers_8h.html#a37">find_jl_beta</a>(FSP_data, qchk, distance_2_move, <a class="code" href="general_8h.html#a34">datafp</a>);
00090     }                           <span class="comment">/* end if(bound)        */</span>
00091   }                     <span class="comment">/* end for(qchk...)     */</span>
00092 }               <span class="comment">/* end avoid_limits()   */</span>
00093 
00094 <span class="comment">/* ________________________________________________________</span>
00095 <span class="comment">  | name:    avoid_obstacles                               |</span>
00096 <span class="comment">  | description:  Loops through all obstacles and calls    |</span>
00097 <span class="comment">  |     routines to determine intersection. If an obstacle |</span>
00098 <span class="comment">  |     has been breached and solution vectors have yet to |</span>
00099 <span class="comment">  |     be found, solution vectors are calculated and      |</span>
00100 <span class="comment">  |     betas are produced, otherwise, if solutions have   |</span>
00101 <span class="comment">  |     already been found, only the find beta function is |</span>
00102 <span class="comment">  |     called.                                            |</span>
00103 <span class="comment">  |                                                        |</span>
00104 <span class="comment">  | inputs:  See Declarations below                        |</span>
00105 <span class="comment">  | outputs: Calls Function to Calculate Betas             |</span>
00106 <span class="comment">  |________________________________________________________|</span>
00107 <span class="comment">  | Authors:     Date:     Modifications:                  |</span>
00108 <span class="comment">  |  F Tulloch     4/94    Algorithm Creation for 2 g's    |</span>
00109 <span class="comment">  |  c hacker     10/94    Ported from 2 g's to FSP        |</span>
00110 <span class="comment">  |                2/95    Ported to Solutions struct      |</span>
00111 <span class="comment">  |________________________________________________________|*/</span>
00112 
<a name="l00113"></a><a class="code" href="constraints_8c.html#a1">00113</a> <span class="keywordtype">int</span> <a class="code" href="headers_8h.html#a30">avoid_obstacles</a>(FSP_data, Jacob, dx, x_of_link, ns, spheredata, 
00114                     got_gs, datafp)
00115 <span class="keywordtype">int</span>     ns;                     <span class="comment">/* circ info (# of circles) */</span>
00116 <span class="keywordtype">double</span>  spheredata[4][4];       <span class="comment">/* circ info (rad, center)  */</span>
00117 FILE   *<a class="code" href="general_8h.html#a34">datafp</a>;         <span class="comment">/* data file declaration            */</span>
00118 <span class="keywordtype">int</span>    *got_gs;         <span class="comment">/* get_gs or not, used for  TWOSTEP */</span>
00119 <a class="code" href="structMATRIX.html">MATRIX</a> *Jacob,          <span class="comment">/* needed to find soln's if TWOSTEP */</span>
00120        *dx,             <span class="comment">/* needed to find soln's if TWOSTEP */</span>
00121        *x_of_link;      <span class="comment">/* link endpts                      */</span>
00122 <a class="code" href="structSolutions.html">Solutions</a> *FSP_data;    <span class="comment">/* see structures.h                 */</span>
00123 {
00124   <span class="keywordtype">int</span>    i, kk, is, ii, elbow_check=0;
00125   <span class="keywordtype">double</span> newl, delta,
00126          pt1[3], pt2[3], Xj[3], normal[3];
00127 
00128   <span class="keywordflow">if</span> (<a class="code" href="general_8h.html#a55">STEP</a> == <a class="code" href="general_8h.html#a26">TWO</a>) <a class="code" href="headers_8h.html#a13">GET_ACTUAL_X</a> ( FSP_data-&gt;<a class="code" href="structSolutions.html#Solutionso7">Qarray</a>, x_of_link );        
00129 
00130   <span class="keywordflow">if</span> (<a class="code" href="fsp_8c.html#a0">DEBUG</a>) {
00131     fprintf(<a class="code" href="general_8h.html#a34">datafp</a>,<span class="stringliteral">"\n  ______________________________  \n"</span>);
00132     fprintf(<a class="code" href="general_8h.html#a34">datafp</a>,<span class="stringliteral">"\n         OBSTACLE AVOIDANCE       \n"</span>);
00133     fprintf(<a class="code" href="general_8h.html#a34">datafp</a>,  <span class="stringliteral">"  ______________________________  \n\n"</span>);
00134     <a class="code" href="useful__UTILS_8c.html#a5">fmat_pr</a>(<a class="code" href="general_8h.html#a34">datafp</a>,<span class="stringliteral">" Position of Each Link "</span>, x_of_link);
00135   }
00136 
00137   <span class="keywordflow">for</span> (kk = 0; kk &lt; <a class="code" href="general_8h.html#a57">Robot</a>-&gt;<a class="code" href="structManipulator__struct.html#Manipulator__structo1">NL</a>; kk++)
00138   {
00139     <span class="keywordflow">for</span> (i=0; i&lt;3; i++)
00140     {
00141       pt1[i] = x_of_link-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[kk][i];      
00142       pt2[i] = x_of_link-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[kk+1][i];
00143     }
00144     <span class="keywordflow">if</span> (<a class="code" href="fsp_8c.html#a0">DEBUG</a>) {
00145       fprintf (<a class="code" href="general_8h.html#a34">datafp</a>,<span class="stringliteral">"\nChecking LINK(0-4) %d\n"</span>, kk);
00146       fprintf (<a class="code" href="general_8h.html#a34">datafp</a>,<span class="stringliteral">" pt1 = &lt; %f, %f, %f &gt;\n pt2 = &lt; %f, %f, %f &gt;"</span>,
00147                 pt1[0],pt1[1],pt1[2],pt2[0],pt2[1],pt2[2]);
00148     }
00149 
00150     <span class="keywordflow">for</span> (is = 0; is &lt; ns; is++)
00151     {
00152       <span class="keywordflow">if</span> (<a class="code" href="headers_8h.html#a31">find_intersection_sphere</a>(pt1, pt2, is, ns, spheredata,
00153                  &amp;elbow_check, &amp;newl, &amp;delta, normal, <a class="code" href="general_8h.html#a34">datafp</a>))
00154       {
00155         <span class="keywordflow">if</span> ( (<a class="code" href="general_8h.html#a55">STEP</a> == <a class="code" href="general_8h.html#a26">TWO</a>) &amp;&amp; (!(*got_gs)) ) 
00156         {
00157           <a class="code" href="Jacob__UTILS_8c.html#a0">GET_JACOBIAN</a>(Jacob, FSP_data-&gt;<a class="code" href="structSolutions.html#Solutionso7">Qarray</a>);
00158           <a class="code" href="headers_8h.html#a14">Solution_generator</a>( FSP_data, Jacob, dx, <a class="code" href="general_8h.html#a34">datafp</a> ); 
00159           *got_gs = <a class="code" href="general_8h.html#a17">TRUE</a>;
00160         }
00161         <span class="keywordflow">for</span> (i=0; i&lt;3; i++)
00162           Xj[i]= x_of_link-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[kk][i] + newl*x_of_link-&gt;<a class="code" href="structMATRIX.html#MATRIXo0">p</a>[kk+1][i];
00163 
00164 
00165 <span class="preprocessor">        #ifdef DEBUG_OUT</span>
00166 <span class="preprocessor"></span>          fprintf (stderr,<span class="stringliteral">"   LINK %d COLLIDED\n"</span>, kk);
00167 <span class="preprocessor">        #endif</span>
00168 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="fsp_8c.html#a0">DEBUG</a>) fprintf (<a class="code" href="general_8h.html#a34">datafp</a>,<span class="stringliteral">"\tXj  = &lt;   %4.6f,  %4.6f,  %4.6f   &gt;\n"</span>,
00169                                                 Xj[0],  Xj[1],  Xj[2]);
00170 
00171         <a class="code" href="headers_8h.html#a38">find_obs_beta</a>(FSP_data, kk, &amp;newl, delta, normal, <a class="code" href="general_8h.html#a34">datafp</a>);
00172 
00173       }                         <span class="comment">/* end if (intersection) */</span>
00174     }                   <span class="comment">/* end for(is=0 to ns)  */</span>
00175   }             <span class="comment">/* end kk loop */</span>
00176 }       <span class="comment">/* end avoid_obstacles() */</span>
00177 
00178 
00179 
00180 <span class="comment">/* ________________________________________________________</span>
00181 <span class="comment">  | name:    find_intersection_sphere                      |</span>
00182 <span class="comment">  | description:  For a given obstacle and link, determines|</span>
00183 <span class="comment">  |     if that link is within the obstacles buffer zone.  |</span>
00184 <span class="comment">  |     If so, returns closest point on the link to the    |</span>
00185 <span class="comment">  |     center of the object, the normal vector from the   |</span>
00186 <span class="comment">  |     center to that point, and the distance needed in   |</span>
00187 <span class="comment">  |     to move said point to the edge of the buffer zone. |</span>
00188 <span class="comment">  |     This information is critical to the formation of   |</span>
00189 <span class="comment">  |     of beta values.                                    |</span>
00190 <span class="comment">  |                                                        |</span>
00191 <span class="comment">  | inputs:  link (pt1,pt2), sphere                        |</span>
00192 <span class="comment">  | outputs: newl, delta, normal                           |</span>
00193 <span class="comment">  |________________________________________________________|</span>
00194 <span class="comment">  | Authors:     Date:     Modifications:                  |</span>
00195 <span class="comment">  |  F Tulloch     4/94    Algorithm Creation for 2 g's    |</span>
00196 <span class="comment">  |  c hacker      2/95    Ported to Solutions struct      |</span>
00197 <span class="comment">  |________________________________________________________|*/</span>
00198  
<a name="l00199"></a><a class="code" href="constraints_8c.html#a2">00199</a> <span class="keywordtype">int</span> <a class="code" href="headers_8h.html#a31">find_intersection_sphere</a>(pt1, pt2, ws, ns, spheredata,
00200          elbow_check, newl, delta, normal, datafp)
00201 FILE   *<a class="code" href="general_8h.html#a34">datafp</a>;          <span class="comment">/* data file declaration         */</span>
00202 <span class="keywordtype">int</span>     ws;              <span class="comment">/* which sphere                  */</span>
00203 <span class="keywordtype">int</span>    *elbow_check;     <span class="comment">/* check if elbow of link inside */</span>
00204 <span class="keywordtype">double</span>  normal[3],       <span class="comment">/* normal from center of sphere  */</span>
00205        *newl,            <span class="comment">/* closest pnt j to cntr of obs  */</span>
00206        *delta,           <span class="comment">/* distance pnt j is in boundary */</span>
00207         pt1[3], pt2[3];  <span class="comment">/* endpoints of link             */</span>
00208 <span class="keywordtype">int</span>     ns;                    <span class="comment">/* sphere info (# spheres) */</span>
00209 <span class="keywordtype">double</span>  spheredata[4][4];      <span class="comment">/* sphere info (rad, cntr) */</span>
00210 {
00211   <span class="keywordtype">int</span>    i, j;
00212    
00213   <span class="keywordtype">double</span> x_temp,  y_temp,  z_temp,
00214          x_mid,   y_mid,   z_mid,
00215          xcenter, ycenter, zcenter, radius, 
00216          deltax,  deltay,  deltaz,
00217          b_check1, b_check2, root_chk,
00218          coeff_t_sq, coeff_t_f,
00219          t_sol_init, t_sol1, t_sol2,
00220          xsol1, xsol2,  ysol1, ysol2,  zsol1, zsol2,
00221          constant1, constant2, constant3, constantf1, constantf;
00222 
00223   xsol1 =ysol1 =zsol1 =x_temp =y_temp =z_temp =0.0;
00224 
00225   xcenter = spheredata[ws][0];
00226   ycenter = spheredata[ws][1];
00227   zcenter = spheredata[ws][2];
00228   radius  = spheredata[ws][3];
00229 
00230   <span class="comment">/* defining constants needed in forming equations */</span>
00231   deltax  = pt2[0] - pt1[0];
00232   deltay  = pt2[1] - pt1[1];
00233   deltaz  = pt2[2] - pt1[2];
00234 
00235   coeff_t_sq = (deltax * deltax) + (deltay * deltay) + (deltaz * deltaz);
00236 
00237 
00238   coeff_t_f = 2 * ( deltax * (pt1[0] - xcenter) +
00239                     deltay * (pt1[1] - ycenter) +
00240                     deltaz * (pt1[2] - zcenter) );
00241 
00242   constant1  = pt1[0] - xcenter;
00243   constant2  = pt1[1] - ycenter;
00244   constant3  = pt1[2] - zcenter;
00245   constantf1 =  (constant1 * constant1) + 
00246                 (constant2 * constant2) + 
00247                 (constant3 * constant3);
00248 
00249   constantf = constantf1 - <a class="code" href="general_8h.html#a3">SQUARE</a>(radius);
00250 
00251 
00252   <span class="comment">/* now that coefficients of the quadratric are defined, we solve it */</span>
00253 
00254   b_check1 = <a class="code" href="general_8h.html#a3">SQUARE</a>(coeff_t_f);
00255   b_check2 = coeff_t_sq * constantf * 4;
00256   root_chk = b_check1 - b_check2;
00257 
00258          <span class="comment">/* now to ascertain what situation we have */</span>
00259   <span class="keywordflow">if</span> (root_chk &lt;  0.0) <span class="keywordflow">return</span> <a class="code" href="general_8h.html#a18">FALSE</a>;         <span class="comment">/* no intersection */</span>
00260   <span class="keywordflow">if</span> (root_chk == 0.0) <span class="keywordflow">return</span> <a class="code" href="general_8h.html#a18">FALSE</a>;         <span class="comment">/* graze */</span>
00261 
00262 
00263          <span class="comment">/* root_chk &gt; 0.0 intersection occurs */</span>
00264   t_sol_init = sqrt(root_chk);
00265   t_sol1 = (-(coeff_t_f) + t_sol_init) / (2 * coeff_t_sq);
00266   t_sol2 = (-(coeff_t_f) - t_sol_init) / (2 * coeff_t_sq);
00267 
00268   <span class="keywordflow">if</span> (<a class="code" href="fsp_8c.html#a0">DEBUG</a>) fprintf(<a class="code" href="general_8h.html#a34">datafp</a>,<span class="stringliteral">"\tt_sol1: %4.2f t_sol2: %4.2f \n"</span>, t_sol1, t_sol2);
00269 
00270   <span class="comment">/************      now check t's for validity      ************/</span>
00271 
00272              <span class="comment">/* Does pt of inters. lie on link? */</span>
00273   <span class="keywordflow">if</span> (((0.0 &gt; t_sol1) || (t_sol1 &gt; 1.0)) &amp;&amp; 
00274       ((0.0 &gt; t_sol2) || (t_sol2 &gt; 1.0))) 
00275   {  
00276     <span class="keywordflow">if</span> (<a class="code" href="fsp_8c.html#a0">DEBUG</a>) fprintf(<a class="code" href="general_8h.html#a34">datafp</a>,<span class="stringliteral">"\tIntersection not on link \n"</span>);
00277     <span class="keywordflow">return</span> <a class="code" href="general_8h.html#a18">FALSE</a>;
00278   }
00279 
00280              <span class="comment">/* Does pt of inters. elbow sit. */</span>
00281   <span class="keywordflow">if</span> (((0.0 &gt; t_sol1) || (t_sol1 &gt; 1.0)) || 
00282       ((0.0 &gt; t_sol2) || (t_sol2 &gt; 1.0)))
00283   {
00284     <span class="keywordflow">if</span> (<a class="code" href="fsp_8c.html#a0">DEBUG</a>) fprintf(<a class="code" href="general_8h.html#a34">datafp</a>, <span class="stringliteral">"\tElbow Intersection!\n"</span>);
00285    *elbow_check = *elbow_check + 1;
00286 
00287     <span class="keywordflow">if</span> (0.0 &lt;= t_sol1 &lt;= 1.0)
00288     {
00289       xsol1 = pt1[0] + (deltax * t_sol1);
00290       ysol1 = pt1[1] + (deltay * t_sol1);
00291       zsol1 = pt1[2] + (deltaz * t_sol1);
00292     }
00293 
00294     <span class="keywordflow">if</span> (0.0 &lt;= t_sol2 &lt;= 1.0)
00295     {
00296       xsol1 = pt1[0] + (deltax * t_sol2);
00297       ysol1 = pt1[1] + (deltay * t_sol2);
00298       zsol1 = pt1[2] + (deltaz * t_sol2);
00299     }
00300 
00301     <span class="keywordflow">if</span> (*elbow_check == 1)
00302     {
00303       x_temp = xsol1;        <span class="comment">/* end of link becomes point j */</span>
00304       y_temp = ysol1;
00305       z_temp = zsol1;
00306       <span class="keywordflow">return</span> <a class="code" href="general_8h.html#a18">FALSE</a>;
00307     }
00308     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*elbow_check % 2 == 0)
00309     {
00310       x_mid = (xsol1 + x_temp) / 2;
00311       y_mid = (ysol1 + y_temp) / 2;
00312       z_mid = (zsol1 + z_temp) / 2;
00313 
00314       *delta = radius - sqrt(((zcenter - z_mid) * (zcenter - z_mid)) 
00315                            + ((ycenter - y_mid) * (ycenter - y_mid)) 
00316                            + ((xcenter - x_mid) * (xcenter - x_mid)));
00317 
00318       normal[0] = x_mid - xcenter;
00319       normal[1] = y_mid - ycenter;
00320       normal[2] = z_mid - zcenter;
00321 
00322       *newl = 0.0;
00323     }<span class="comment">/* end if 2nd inter.    */</span>
00324   }  <span class="comment">/* end elbow sit.       */</span>
00325   <span class="keywordflow">else</span>                       <span class="comment">/* there are two inter. */</span>
00326   {
00327     xsol1 = pt1[0] + (deltax * t_sol1);
00328     ysol1 = pt1[1] + (deltay * t_sol1);
00329     zsol1 = pt1[2] + (deltaz * t_sol1);
00330 
00331     xsol2 = pt1[0] + (deltax * t_sol2);
00332     ysol2 = pt1[1] + (deltay * t_sol2);
00333     zsol2 = pt1[2] + (deltaz * t_sol2);
00334 
00335     x_mid = (xsol1 + xsol2) / 2;
00336     y_mid = (ysol1 + ysol2) / 2;
00337     z_mid = (zsol1 + zsol2) / 2;
00338 
00339     *delta = radius - sqrt(((zcenter - z_mid) * (zcenter - z_mid)) 
00340                          + ((ycenter - y_mid) * (ycenter - y_mid)) 
00341                          + ((xcenter - x_mid) * (xcenter - x_mid)));
00342 
00343     normal[0] = x_mid - xcenter;
00344     normal[1] = y_mid - ycenter;
00345     normal[2] = z_mid - zcenter;
00346 
00347     *newl = sqrt((z_mid - pt1[2]) * (z_mid - pt1[2]) 
00348                + (y_mid - pt1[1]) * (y_mid - pt1[1]) 
00349                + (x_mid - pt1[0]) * (x_mid - pt1[0]));
00350   } <span class="comment">/* end 2 inter. */</span>
00351 
00352   <span class="keywordflow">if</span> (<a class="code" href="fsp_8c.html#a0">DEBUG</a>) {
00353     fprintf (<a class="code" href="general_8h.html#a34">datafp</a>, <span class="stringliteral">"\n\tCollision with #%d circle has occured!"</span>, ws);
00354     fprintf (<a class="code" href="general_8h.html#a34">datafp</a>, <span class="stringliteral">"\n\tnormal = &lt;%lf,%lf,%lf&gt;"</span>, normal[0], 
00355                                                    normal[1], 
00356                                                    normal[2]);
00357     fprintf (<a class="code" href="general_8h.html#a34">datafp</a>, <span class="stringliteral">"\n\tCircle Delta = %lf\n"</span>, *delta);
00358   }
00359 
00360   <span class="keywordflow">return</span>  <a class="code" href="general_8h.html#a17">TRUE</a>;
00361 }                            <span class="comment">/* end find inter sphere */</span>
00362 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Jul 29 15:56:34 2004 for OpenSim by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.6 </small></address>
</body>
</html>
